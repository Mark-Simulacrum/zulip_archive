<html>
<head><meta charset="utf-8"><title>#57431 · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html">#57431</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="161377137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161377137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161377137">(Mar 21 2019 at 19:10)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> let's use this thread to discuss</p>



<a name="161394665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394665">(Mar 21 2019 at 20:53)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="214307">@Saleem Jaffer</span></p>



<a name="161394679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394679" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394679">(Mar 21 2019 at 20:53)</a>:</h4>
<p>sure</p>



<a name="161394699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394699" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394699">(Mar 21 2019 at 20:53)</a>:</h4>
<p>as I told you, I've practically no time until march 31st</p>



<a name="161394724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394724" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394724">(Mar 21 2019 at 20:53)</a>:</h4>
<p>anyway ...</p>



<a name="161394735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394735" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394735">(Mar 21 2019 at 20:53)</a>:</h4>
<p>have you read the issue and understood it properly?</p>



<a name="161394746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394746" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394746">(Mar 21 2019 at 20:54)</a>:</h4>
<p>do you have a test case?</p>



<a name="161394786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394786" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394786">(Mar 21 2019 at 20:54)</a>:</h4>
<p>I think I had even some code on a branch here</p>



<a name="161394787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394787">(Mar 21 2019 at 20:54)</a>:</h4>
<p>and a test too</p>



<a name="161394807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394807" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394807">(Mar 21 2019 at 20:54)</a>:</h4>
<blockquote>
<p>as I told you, I've practically no time until march 31st</p>
</blockquote>
<p>regardless of this, I'm going to try to help you solving this issue</p>



<a name="161394814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161394814" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161394814">(Mar 21 2019 at 20:54)</a>:</h4>
<p>but unfortunately I may be very unresponsive</p>



<a name="161417400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161417400" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161417400">(Mar 22 2019 at 03:39)</a>:</h4>
<blockquote>
<p>have you read the issue and understood it properly?</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/issues/57431#issuecomment-475298180" target="_blank" title="https://github.com/rust-lang/rust/issues/57431#issuecomment-475298180">https://github.com/rust-lang/rust/issues/57431#issuecomment-475298180</a> is my understanding of the issue.</p>
<blockquote>
<p>do you have a test case?</p>
</blockquote>
<p>I have used a sample case in the above mentioned link.</p>
<p>I am a rust noob, just fixed a couple of PRs  in the rust-lang repo. So I'm not really sure how to get started with this issue. But I'm willing to spend time to sort this one out. </p>
<blockquote>
<p>but unfortunately I may be very unresponsive</p>
</blockquote>
<p>We'll do our best :)</p>



<a name="161432249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/161432249" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#161432249">(Mar 22 2019 at 09:24)</a>:</h4>
<p>I think librustc_mir/borrow_check/mutability_errors.rs is where I should be looking at?</p>



<a name="162393851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162393851" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162393851">(Apr 03 2019 at 03:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> <a href="https://github.com/rust-lang/rust/issues/57431#issuecomment-477004455" target="_blank" title="https://github.com/rust-lang/rust/issues/57431#issuecomment-477004455">https://github.com/rust-lang/rust/issues/57431#issuecomment-477004455</a> This is as far as I have been able to fund. I can figure out hacky solutions to fix this for <code>&amp;mut mut</code>, but can't find a clean way. Any pointers as to what I should be doing?</p>



<a name="162544793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162544793" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162544793">(Apr 04 2019 at 16:51)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/59699" target="_blank" title="https://github.com/rust-lang/rust/pull/59699">https://github.com/rust-lang/rust/pull/59699</a></p>



<a name="162547700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162547700" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162547700">(Apr 04 2019 at 17:22)</a>:</h4>
<p><span class="user-mention" data-user-id="214307">@Saleem Jaffer</span> I'm back</p>



<a name="162547714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162547714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162547714">(Apr 04 2019 at 17:22)</a>:</h4>
<p>we need to improve the PR</p>



<a name="162547720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162547720" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162547720">(Apr 04 2019 at 17:22)</a>:</h4>
<p>let me give you some pointers ...</p>



<a name="162547728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162547728" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162547728">(Apr 04 2019 at 17:22)</a>:</h4>
<p>sorry for the long delay</p>



<a name="162547738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162547738" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162547738">(Apr 04 2019 at 17:22)</a>:</h4>
<p>I'm starting to come back again :)</p>



<a name="162558436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558436" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558436">(Apr 04 2019 at 19:12)</a>:</h4>
<p>so <span class="user-mention" data-user-id="214307">@Saleem Jaffer</span>, thanks for your work on this</p>



<a name="162558441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558441" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558441">(Apr 04 2019 at 19:12)</a>:</h4>
<p>and sorry for not being around</p>



<a name="162558483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558483" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558483">(Apr 04 2019 at 19:13)</a>:</h4>
<p>about the PR, we don't want to emit a help dialog and then search for the <code>&amp;mut</code> text to get rid of it :)</p>



<a name="162558699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558699" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558699">(Apr 04 2019 at 19:15)</a>:</h4>
<p>so from this code</p>



<a name="162558704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558704">(Apr 04 2019 at 19:15)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="nc">X</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">mutate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">c</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ref_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">term</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">X</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">ref_term</span><span class="p">.</span><span class="n">mutate</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="162558821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558821">(Apr 04 2019 at 19:16)</a>:</h4>
<p>the then part of the expression <code>&amp;mut term</code> is coercing to a <code>&amp;*</code></p>



<a name="162558970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162558970" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162558970">(Apr 04 2019 at 19:18)</a>:</h4>
<p>so it can match the type of the else part <code>&amp;X</code></p>



<a name="162559042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162559042" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162559042">(Apr 04 2019 at 19:19)</a>:</h4>
<p>so our code thinks that you're holding an immutable borrow but the code aimed to be a mutable borrow</p>



<a name="162559069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162559069" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162559069">(Apr 04 2019 at 19:19)</a>:</h4>
<p>so it suggest to add mutability to something that is already mutable and that's the useless tip that the compiler is giving</p>



<a name="162559073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162559073" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162559073">(Apr 04 2019 at 19:19)</a>:</h4>
<p>so the idea is to track those autogenerated coercions and in the code you're changing that and not emit the help</p>



<a name="162559552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162559552" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162559552">(Apr 04 2019 at 19:25)</a>:</h4>
<p>maybe we can add a flag here <a href="https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139" target="_blank" title="https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139">https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139</a></p>



<a name="162600444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162600444" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162600444">(Apr 05 2019 at 07:33)</a>:</h4>
<p>Should I change <code>rustc::mir::ExprKind::Borrow</code>  from:</p>
<div class="codehilite"><pre><span></span><span class="n">Borrow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">borrow_kind</span>: <span class="nc">BorrowKind</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">arg</span>: <span class="nc">ExprRef</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>


<p>to </p>
<div class="codehilite"><pre><span></span><span class="n">Borrow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">borrow_kind</span>: <span class="nc">BorrowKind</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">arg</span>: <span class="nc">ExprRef</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">coerced_mut_immut</span>: <span class="nc">Bool</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
</pre></div>



<a name="162627629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162627629" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162627629">(Apr 05 2019 at 14:24)</a>:</h4>
<p>yes, maybe use a <code>auto_gen: bool</code> field</p>



<a name="162628284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628284" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628284">(Apr 05 2019 at 14:31)</a>:</h4>
<p>The <code>auto-gen</code> has any special meaning? Or does it denote a coercion only?</p>



<a name="162628402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628402">(Apr 05 2019 at 14:32)</a>:</h4>
<p>no no, was suggesting a name</p>



<a name="162628409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628409" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628409">(Apr 05 2019 at 14:32)</a>:</h4>
<p>or maybe just <code>coerced</code></p>



<a name="162628585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628585" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628585">(Apr 05 2019 at 14:34)</a>:</h4>
<p>Cool, I'll have to make the change to all the places where <code>ExprKind::Borrow</code> is created. Will get back to you if I am stuck.</p>



<a name="162628817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628817" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628817">(Apr 05 2019 at 14:37)</a>:</h4>
<p>You may want to double-check whether the field belogs on <code>ExprKind::Borrow</code> itself, or if it should be attached to the <code>BorrowKind</code> variant(s). I haven't followed the conversation 100%; I just know that we have the <code>allow_two_phase</code> field on <code>BorrowKind::Mut</code>, and that is somewhat similar (in that it is meant to track where the borrow came from, in a somewhat abstract manner)</p>



<a name="162628930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628930">(Apr 05 2019 at 14:39)</a>:</h4>
<p>also: are you sure you need to add the field? Why not just stop issuing the suggestion when the <code>borrow_kind</code> is already a <code>BorrowKind::Mut</code>?</p>



<a name="162628959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162628959" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162628959">(Apr 05 2019 at 14:39)</a>:</h4>
<p>(just thinking out loud. There may be an obvious reason that doesn't work that I haven't noticed.)</p>



<a name="162630238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630238" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630238">(Apr 05 2019 at 14:55)</a>:</h4>
<p>The <code>borrow_kind</code> turns out to be a <code>BorrowKind::Shared</code> in the case of a coercion from <code>&amp;mut term</code> to <code>&amp; term</code>. Maybe that's why we can't use it?</p>



<a name="162630461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630461" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630461">(Apr 05 2019 at 14:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> exactly, the borrowkind is shared</p>



<a name="162630503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630503" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630503">(Apr 05 2019 at 14:58)</a>:</h4>
<p><span class="user-mention" data-user-id="214307">@Saleem Jaffer</span> play with that and check it out just in case because I kind of forgot about it :)</p>



<a name="162630537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630537" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630537">(Apr 05 2019 at 14:58)</a>:</h4>
<p>would be nice to be 100% sure about it</p>



<a name="162630553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630553" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630553">(Apr 05 2019 at 14:58)</a>:</h4>
<p>I was looking briefly into this ~ 2 months ago and I'm not 100% sure anymore</p>



<a name="162630763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630763" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630763">(Apr 05 2019 at 15:00)</a>:</h4>
<p>Hmm. I was assuming that the code was looking at whatever borrow corresponded to the <code>&amp;mut term</code>.</p>



<a name="162630816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630816">(Apr 05 2019 at 15:01)</a>:</h4>
<p>But obviously its not looking at that. It might be good to double-check whether the thing corresponding to <code>&amp;mut term</code> is actually available for you to inspectr.</p>



<a name="162630913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630913" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630913">(Apr 05 2019 at 15:02)</a>:</h4>
<p>(because we are clearly <em>somehow</em> tracking down <code>&amp;mut term</code>, somewhere, eventually, in order to generate the undesirable message...)</p>



<a name="162630939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162630939" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162630939">(Apr 05 2019 at 15:02)</a>:</h4>
<p>but in any case, this does answer my question about why you aren't doing "the obvious thing"</p>



<a name="162631085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631085" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631085">(Apr 05 2019 at 15:04)</a>:</h4>
<p>Isn't the problem of this that at mir level you really have an inmutable borrow?</p>



<a name="162631099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631099" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631099">(Apr 05 2019 at 15:04)</a>:</h4>
<p>because of the coercion</p>



<a name="162631109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631109" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631109">(Apr 05 2019 at 15:04)</a>:</h4>
<p>oh, maybe</p>



<a name="162631120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631120">(Apr 05 2019 at 15:05)</a>:</h4>
<p>actually it gets the <code>&amp;mut</code> part in the suggestion from the code</p>



<a name="162631161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631161">(Apr 05 2019 at 15:05)</a>:</h4>
<p>ugh I forgot</p>



<a name="162631176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631176" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631176">(Apr 05 2019 at 15:05)</a>:</h4>
<p><span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span> <span aria-label="panda" class="emoji emoji-1f43c" role="img" title="panda">:panda:</span></p>



<a name="162631191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631191">(Apr 05 2019 at 15:05)</a>:</h4>
<p>Yeah it does not know about <code>BorrowKind</code>, it just knows the span</p>



<a name="162631195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631195" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631195">(Apr 05 2019 at 15:06)</a>:</h4>
<blockquote>
<p>actually it gets the <code>&amp;mut</code> part in the suggestion from the code</p>
</blockquote>
<p>this is why if you do <code>&amp; /* something */ mut</code> you would get that into the suggestion :)</p>



<a name="162631316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162631316" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162631316">(Apr 05 2019 at 15:07)</a>:</h4>
<p>okay then. I'm still wary of plugging this into MIR, but I also do not have an immediate alternative suggestion</p>



<a name="162635100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162635100" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162635100">(Apr 05 2019 at 15:52)</a>:</h4>
<p>In order to  figure out that it is a coercion I will have to look into <code>hir_expr</code> which is a <code>hir::Expr</code> because only that structure has original type.</p>



<a name="162639733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162639733" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162639733">(Apr 05 2019 at 16:54)</a>:</h4>
<blockquote>
<p>In order to  figure out that it is a coercion I will have to look into <code>hir_expr</code> which is a <code>hir::Expr</code> because only that structure has original type.</p>
</blockquote>
<p>won't the place I told you be enough? if not why?</p>



<a name="162639749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162639749" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162639749">(Apr 05 2019 at 16:55)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139" target="_blank" title="https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139">https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139</a></p>



<a name="162639776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162639776" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162639776">(Apr 05 2019 at 16:55)</a>:</h4>
<p>there you know that is an auto borrow</p>



<a name="162656671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162656671" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162656671">(Apr 05 2019 at 20:11)</a>:</h4>
<p>Does an <code>AutoBorrow</code> always imply a coercion from <code>&amp;mut</code>  to <code>&amp;*</code>?</p>



<a name="162657326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162657326" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162657326">(Apr 05 2019 at 20:20)</a>:</h4>
<p>no, you'll have to check <code>m</code> and <code>expr.ty</code></p>



<a name="162657373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162657373" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162657373">(Apr 05 2019 at 20:20)</a>:</h4>
<p>Or check the types later when the diagnostic is emitted</p>



<a name="162657555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162657555" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162657555">(Apr 05 2019 at 20:23)</a>:</h4>
<p>In this case <code>m</code> is <code>Immutable</code> and <code>expr.ty</code> is <code>X</code> (struct name)</p>



<a name="162657666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162657666" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162657666">(Apr 05 2019 at 20:24)</a>:</h4>
<p>So, <code>m</code> seems to the coerced type.</p>



<a name="162658964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162658964" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162658964">(Apr 05 2019 at 20:40)</a>:</h4>
<p>OK, I think that you should just mark all auto borrows here and do the rest in the diagnostic. Getting the original reference type is enough hassle that I don't think that it should be in the HAIR lowering.</p>



<a name="162689552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162689552" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162689552">(Apr 06 2019 at 07:32)</a>:</h4>
<p>(deleted)</p>



<a name="162689742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162689742" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162689742">(Apr 06 2019 at 07:38)</a>:</h4>
<p><a href="https://github.com/saleemjaffer/rust/blob/3752b3d3a56bf3eabb588b7d595cd1f8accc0286/src/librustc_mir/borrow_check/mod.rs#L1775-L1783" target="_blank" title="https://github.com/saleemjaffer/rust/blob/3752b3d3a56bf3eabb588b7d595cd1f8accc0286/src/librustc_mir/borrow_check/mod.rs#L1775-L1783">https://github.com/saleemjaffer/rust/blob/3752b3d3a56bf3eabb588b7d595cd1f8accc0286/src/librustc_mir/borrow_check/mod.rs#L1775-L1783</a></p>
<p>This is the function which calls <code>report_mutability_errors</code>, which then actually emits the help diagnostic.</p>
<p>The function does not have access to <code>hair::Expr</code>which has the <code>ExprKind</code>. So I think we should be setting the <code>is_coerced</code> flag at a <code>rustc::mir::Borrowkind</code>.  <code>BorrowKind</code> can be either a <code>Shared</code>, <code>Shallow</code>, <code> Unique</code> or <code>Mut</code>.  I'm not really sure when <code>Shallow</code> and <code>Unique</code> are applicable. But for now I am changing <code>Shared</code> to a </p>
<div class="codehilite"><pre><span></span><span class="n">Shared</span><span class="w"> </span><span class="p">{</span><span class="n">is_coerced</span>: <span class="kt">bool</span><span class="p">}</span><span class="w"></span>
</pre></div>


<p>Finally in </p>
<div class="codehilite"><pre><span></span>fn check_access_permissions(
        &amp;mut self,
        (place, span): (&amp;Place&lt;&#39;tcx&gt;, Span),
        kind: ReadOrWrite,
        is_local_mutation_allowed: LocalMutationIsAllowed,
        flow_state: &amp;Flows&lt;&#39;cx, &#39;gcx, &#39;tcx&gt;,
        location: Location,
    ) -&gt; bool {
</pre></div>


<p>we can check if <code>kind</code> is a Borrow,  and check if <code>BorrowKind</code> has <code>is_coerced</code> set to true. If it is true we will not emit the help diagnostic.</p>
<p>How does this sound?</p>



<a name="162808817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162808817" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162808817">(Apr 08 2019 at 11:37)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> What do you think of the above idea?</p>



<a name="162815342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162815342" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162815342">(Apr 08 2019 at 13:11)</a>:</h4>
<p>I am actually a bit confused. </p>
<p><a href="https://github.com/rust-lang/rust/blob/3750348daff89741e3153e0e120aa70a45ff5b68/src/librustc_mir/borrow_check/mutability_errors.rs#L28-L35" target="_blank" title="https://github.com/rust-lang/rust/blob/3750348daff89741e3153e0e120aa70a45ff5b68/src/librustc_mir/borrow_check/mutability_errors.rs#L28-L35">This</a> is the function which emits the error as well as the suggestion for <code>&amp;mut mut</code>.</p>
<div class="codehilite"><pre><span></span><span class="w">            </span><span class="n">Place</span>::<span class="n">Projection</span><span class="p">(</span><span class="k">box</span><span class="w"> </span><span class="n">Projection</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">base</span>: <span class="nc">Place</span>::<span class="n">Base</span><span class="p">(</span><span class="n">PlaceBase</span>::<span class="n">Local</span><span class="p">(</span><span class="n">local</span><span class="p">)),</span><span class="w"></span>
<span class="w">                </span><span class="n">elem</span>: <span class="nc">ProjectionElem</span>::<span class="n">Deref</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">})</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mir</span><span class="p">.</span><span class="n">local_decls</span><span class="p">[</span><span class="o">*</span><span class="n">local</span><span class="p">].</span><span class="n">is_user_variable</span><span class="p">.</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">local_decl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">mir</span><span class="p">.</span><span class="n">local_decls</span><span class="p">[</span><span class="o">*</span><span class="n">local</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="n">dbg</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_decl</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">suggestion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">local_decl</span><span class="p">.</span><span class="n">is_user_variable</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">ClearCrossCrate</span>::<span class="n">Set</span><span class="p">(</span><span class="n">mir</span>::<span class="n">BindingForm</span>::<span class="n">ImplicitSelf</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nb">Some</span><span class="p">(</span><span class="n">suggest_ampmut_self</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">infcx</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">local_decl</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="n">ClearCrossCrate</span>::<span class="n">Set</span><span class="p">(</span><span class="n">mir</span>::<span class="n">BindingForm</span>::<span class="n">Var</span><span class="p">(</span><span class="n">mir</span>::<span class="n">VarBindingForm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">binding_mode</span>: <span class="nc">ty</span>::<span class="n">BindingMode</span>::<span class="n">BindByValue</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"></span>
<span class="w">                        </span><span class="n">opt_ty_info</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="p">..</span><span class="w"></span>
<span class="w">                    </span><span class="p">}))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">suggest_ampmut</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">infcx</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">mir</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">*</span><span class="n">local</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">local_decl</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">*</span><span class="n">opt_ty_info</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">)),</span><span class="w"></span>
</pre></div>


<p><code>suggest_ampmut</code> suggests the code to be changed as <code>&amp;mut mut term</code>. </p>
<p>The only way I can think of fixing this is by changing  <code>binding_mode</code> in</p>
<div class="codehilite"><pre><span></span><span class="n">ClearCrossCrate</span>::<span class="n">Set</span><span class="p">(</span><span class="n">mir</span>::<span class="n">BindingForm</span>::<span class="n">Var</span><span class="p">(</span><span class="n">mir</span>::<span class="n">VarBindingForm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">binding_mode</span>: <span class="nc">ty</span>::<span class="n">BindingMode</span>::<span class="n">BindByValue</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"></span>
<span class="w">                        </span><span class="n">opt_ty_info</span><span class="p">,</span><span class="n">x</span><span class="w"></span>
</pre></div>


<p><code>binding_mode</code> holds a <code>Mutability</code> defined in <code>hir::Mutability</code></p>
<p>We were thinking of changing the <code>BorrowKind</code> in <code>mir</code>, but looks like we have to change <code>hir::Mutability</code>. </p>
<p>Am I right?</p>



<a name="162819250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819250">(Apr 08 2019 at 13:59)</a>:</h4>
<p>I guess we would need something like ....</p>



<a name="162819323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819323" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819323">(Apr 08 2019 at 14:00)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">BindingMode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">BindByReference</span><span class="p">(</span><span class="n">Mutability</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">BindByValue</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">auto_gen</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">mutability</span>: <span class="nc">Mutability</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="162819337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819337">(Apr 08 2019 at 14:00)</a>:</h4>
<p>or something like that</p>



<a name="162819343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819343">(Apr 08 2019 at 14:00)</a>:</h4>
<p>but at the same time doesn't sound great</p>



<a name="162819348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819348" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819348">(Apr 08 2019 at 14:00)</a>:</h4>
<p>Yup</p>



<a name="162819359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819359" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819359">(Apr 08 2019 at 14:00)</a>:</h4>
<p>We would be changing hir</p>



<a name="162819366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819366">(Apr 08 2019 at 14:00)</a>:</h4>
<p>and it will make <code>BindingMode</code> size be increase the size</p>



<a name="162819375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162819375" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162819375">(Apr 08 2019 at 14:00)</a>:</h4>
<p>/cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="162820713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162820713" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162820713">(Apr 08 2019 at 14:16)</a>:</h4>
<p>Is the size increase by adding a bool an issue? Noob doubt.</p>



<a name="162821663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162821663" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162821663">(Apr 08 2019 at 14:27)</a>:</h4>
<p>yes, the size of that enum uses 1 byte for the tag (to define which variant are we talking about), then both of them use <code>Mutability</code>, so the size of that right now is the byte for the tag and the size of <code>Mutability</code> and you need to consider padding</p>



<a name="162821749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162821749" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162821749">(Apr 08 2019 at 14:28)</a>:</h4>
<p>let me check exactly what is <code>Mutability</code> to consider the padding</p>



<a name="162822934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162822934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162822934">(Apr 08 2019 at 14:42)</a>:</h4>
<p>hey back</p>



<a name="162822964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162822964" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162822964">(Apr 08 2019 at 14:42)</a>:</h4>
<p>so in the first case the size is 2 bytes and if you add that bool is 4 bytes</p>



<a name="162822985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162822985" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162822985">(Apr 08 2019 at 14:42)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/mem/fn.size_of.html" target="_blank" title="https://doc.rust-lang.org/std/mem/fn.size_of.html">https://doc.rust-lang.org/std/mem/fn.size_of.html</a></p>



<a name="162822998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162822998" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162822998">(Apr 08 2019 at 14:43)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/mem/fn.align_of.html" target="_blank" title="https://doc.rust-lang.org/std/mem/fn.align_of.html">https://doc.rust-lang.org/std/mem/fn.align_of.html</a></p>



<a name="162823049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162823049" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162823049">(Apr 08 2019 at 14:43)</a>:</h4>
<p><span class="user-mention" data-user-id="214307">@Saleem Jaffer</span> was looking for some resources for you to check :)</p>



<a name="162823128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162823128" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162823128">(Apr 08 2019 at 14:44)</a>:</h4>
<p>but is basically 1 byte for tag of the main enum and 1 byte for tag for the inner enum</p>



<a name="162823157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162823157" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162823157">(Apr 08 2019 at 14:44)</a>:</h4>
<p>and when you add a bool you have another byte and also one more as padding</p>



<a name="162823214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162823214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162823214">(Apr 08 2019 at 14:45)</a>:</h4>
<p>Thanks :)</p>



<a name="162823315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162823315" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162823315">(Apr 08 2019 at 14:46)</a>:</h4>
<p>Coming from web development background a few extra bytes in a struct don’t make a difference for web apps :D</p>



<a name="162823381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162823381" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162823381">(Apr 08 2019 at 14:47)</a>:</h4>
<p>So how do we proceed with this? Do we wait for <span class="user-mention" data-user-id="116009">@nikomatsakis</span> to suggest an approach?</p>



<a name="162828848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162828848" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162828848">(Apr 08 2019 at 15:48)</a>:</h4>
<p>I'd start by trying to add that field and make the thing work</p>



<a name="162828857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162828857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162828857">(Apr 08 2019 at 15:48)</a>:</h4>
<p>then we can discuss on the PR</p>



<a name="162828870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162828870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162828870">(Apr 08 2019 at 15:48)</a>:</h4>
<p>but based on the actual code would be better I guess</p>



<a name="162829823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162829823" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162829823">(Apr 08 2019 at 15:58)</a>:</h4>
<p>Cool! I’ll start making the changes.</p>



<a name="162836998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162836998" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162836998">(Apr 08 2019 at 17:20)</a>:</h4>
<blockquote>
<p>Coming from web development background a few extra bytes in a struct don’t make a difference for web apps :D</p>
</blockquote>
<p>yep, I'm not sure in this case if it will make a difference, would need to see where is <code>BindingMode</code> used and how impacts the size of the things that use it and then see if that ends adding a significant amount of memory to the overall process</p>



<a name="162919949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162919949" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162919949">(Apr 09 2019 at 15:13)</a>:</h4>
<p>Oh hi <span class="user-mention" data-user-id="214307">@Saleem Jaffer</span> and <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> --</p>



<a name="162919968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162919968" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162919968">(Apr 09 2019 at 15:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> is definitely right that increasing the size of <code>BindingMode</code> will increase memory usage, though it's a bit hard to say by how much</p>



<a name="162920039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920039" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920039">(Apr 09 2019 at 15:14)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="162920096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920096">(Apr 09 2019 at 15:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I wonder if we can just place that boolean field somewhere else with less undesirable effects</p>



<a name="162920205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920205" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920205">(Apr 09 2019 at 15:16)</a>:</h4>
<p>Well, I'm not really clear on that</p>



<a name="162920220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920220" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920220">(Apr 09 2019 at 15:16)</a>:</h4>
<p>What does this boolean represent exactly?</p>



<a name="162920268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920268" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920268">(Apr 09 2019 at 15:17)</a>:</h4>
<p>Anyway, maybe there is another place for it, but I guess I wouldn't stress about it too much</p>



<a name="162920592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920592">(Apr 09 2019 at 15:20)</a>:</h4>
<p>so ... it is saying that the borrow was auto generated</p>



<a name="162920614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920614" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920614">(Apr 09 2019 at 15:20)</a>:</h4>
<p>passing this <a href="https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139" target="_blank" title="https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139">https://github.com/rust-lang/rust/blob/52980d0fb39134a26f73b39b384407e010fc3af5/src/librustc_mir/hair/cx/expr.rs#L134-L139</a> info down I'd say :)</p>



<a name="162920666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920666" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920666">(Apr 09 2019 at 15:21)</a>:</h4>
<p>so for more extra context, you wrote something like <code>&amp;mut something</code></p>



<a name="162920811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/162920811" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#162920811">(Apr 09 2019 at 15:22)</a>:</h4>
<p>but you have <code>&amp;*(&amp;mut something)</code></p>



<a name="163071530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163071530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163071530">(Apr 11 2019 at 05:29)</a>:</h4>
<p>This what what I have been able to understand so far after some debugging. </p>
<p>For a match statement, we go through each of the arms and try to coerce each one. The <code>expected_type</code> is <code>_</code> for each of the arms initially. Finally we infer the right type(not sure how).  All This seems to happen in <code>typeck::check::coercion</code>. </p>
<p>What I am stuck at is: how do I revisit the arm and marked <code>coerced </code> as <code>true</code>?</p>



<a name="163075533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163075533" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163075533">(Apr 11 2019 at 07:02)</a>:</h4>
<blockquote>
<p>What I am stuck at is: how do I revisit the arm and marked coerced  as true?</p>
</blockquote>
<ul>
<li>What I am stuck at is: How do I revisit the arm and mark coerced  as true?</li>
</ul>



<a name="163079123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163079123" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163079123">(Apr 11 2019 at 08:06)</a>:</h4>
<p>(deleted)</p>



<a name="163084967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163084967" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163084967">(Apr 11 2019 at 09:39)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_typeck/check/mod.rs#L2244" target="_blank" title="https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_typeck/check/mod.rs#L2244">https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_typeck/check/mod.rs#L2244</a></p>
<p>Looks like this is where we should be setting <code>coerced</code> to <code>true</code>.</p>



<a name="163085398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163085398" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163085398">(Apr 11 2019 at 09:46)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_typeck/check/coercion.rs#L939" target="_blank" title="https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_typeck/check/coercion.rs#L939">This</a> calls the above function.</p>



<a name="163085888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163085888" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163085888">(Apr 11 2019 at 09:54)</a>:</h4>
<p>Somehow I feel I am on the right track, but am not able to figure out the last bit <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="163087167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163087167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163087167">(Apr 11 2019 at 10:15)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">apply_adjustments</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span>: <span class="kp">&amp;</span><span class="nc">hir</span>::<span class="n">Expr</span><span class="p">,</span><span class="w"> </span><span class="n">adj</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Adjustment</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;apply_adjustments(expr={:?}, adj={:?})&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">adj</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">adj</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">tables</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">adjustments_mut</span><span class="p">().</span><span class="n">entry</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Entry</span>::<span class="n">Vacant</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">adj</span><span class="p">);</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Entry</span>::<span class="n">Occupied</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot; - composing on top of {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">.</span><span class="n">get</span><span class="p">()[..],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">adj</span><span class="p">[..])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// Applying any adjustment on top of a NeverToAny</span>
<span class="w">                    </span><span class="c1">// is a valid NeverToAny adjustment, because it can&#39;t</span>
<span class="w">                    </span><span class="c1">// be reached.</span>
<span class="w">                    </span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">Adjustment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Adjust</span>::<span class="n">NeverToAny</span><span class="p">,</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="w"></span>
<span class="w">                        </span><span class="n">Adjustment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Adjust</span>::<span class="n">Deref</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">                        </span><span class="n">Adjustment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Adjust</span>::<span class="n">Borrow</span><span class="p">(</span><span class="n">AutoBorrow</span>::<span class="n">Ref</span><span class="p">(..)),</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">                    </span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="w"></span>
<span class="w">                        </span><span class="n">Adjustment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Adjust</span>::<span class="n">Deref</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">                        </span><span class="p">..</span><span class="w"> </span><span class="c1">// Any following adjustments are allowed.</span>
<span class="w">                    </span><span class="p">])</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// A reborrow has no effect before a dereference.</span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// FIXME: currently we never try to compose autoderefs</span>
<span class="w">                    </span><span class="c1">// and ReifyFnPointer/UnsafeFnPointer, but we could.</span>
<span class="w">                    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">                        </span><span class="n">bug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;while adjusting {:?}, can&#39;t compose {:?} and {:?}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">adj</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>
<span class="w">                </span><span class="o">*</span><span class="n">entry</span><span class="p">.</span><span class="n">get_mut</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adj</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>


<p>Should we change the <code>adj</code> in <code>apply_adjustments</code> to a <code>mut Vec&lt;Adjustment&lt;'tcx&gt;&gt;</code> and then change the <code>Adjustment</code>?</p>



<a name="163088930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163088930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163088930">(Apr 11 2019 at 10:46)</a>:</h4>
<p>the <code>adj</code> for <code>&amp;mut term</code> is </p>
<div class="codehilite"><pre><span></span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="n">Deref</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">X</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Borrow</span><span class="p">(</span><span class="n">Ref</span><span class="p">(</span><span class="na">&#39;_</span><span class="err">#</span><span class="mi">5</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">Immutable</span><span class="p">))</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">X</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>


<p>I think we have to change:</p>
<div class="codehilite"><pre><span></span>pub enum AutoBorrowMutability {
    Mutable { allow_two_phase_borrow: AllowTwoPhase },
    Immutable,
}
</pre></div>


<p>to </p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">AutoBorrowMutability</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Mutable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">allow_two_phase_borrow</span>: <span class="nc">AllowTwoPhase</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Immutable</span><span class="w"> </span><span class="p">{</span><span class="n">coerced</span>: <span class="kt">bool</span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="163089732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163089732" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163089732">(Apr 11 2019 at 11:01)</a>:</h4>
<p>The only problem with this is that <a href="https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_mir/borrow_check/mutability_errors.rs#L28-L35" target="_blank" title="https://github.com/rust-lang/rust/blob/d21bebe18d6851f52ddcc404e875260560599521/src/librustc_mir/borrow_check/mutability_errors.rs#L28-L35">the function</a> that actually reports the error and the help suggestion does not have access to <code>Adjustment</code>.</p>



<a name="163097570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163097570" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163097570">(Apr 11 2019 at 13:11)</a>:</h4>
<p>I'd need to investigate this, /cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> ^^^</p>



<a name="163189141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163189141" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163189141">(Apr 12 2019 at 13:29)</a>:</h4>
<p>Do let me know if you need some work from my end.</p>



<a name="163211268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163211268" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163211268">(Apr 12 2019 at 17:48)</a>:</h4>
<p>Do let me know if you need some work from my end.</p>



<a name="163381888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163381888" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163381888">(Apr 15 2019 at 14:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> can you review this when you have a couple of minutes? ^^^</p>



<a name="163394764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163394764" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163394764">(Apr 15 2019 at 16:35)</a>:</h4>
<p>OK, I'm around</p>



<a name="163395488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163395488" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163395488">(Apr 15 2019 at 16:45)</a>:</h4>
<blockquote>
<p>Looks like this is where we should be setting <code>coerced</code> to <code>true</code>.</p>
</blockquote>
<p>this is correct</p>



<a name="163397616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163397616" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163397616">(Apr 15 2019 at 17:11)</a>:</h4>
<p>OK, so I spent some time catching up with the issue</p>



<a name="163397618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163397618" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163397618">(Apr 15 2019 at 17:11)</a>:</h4>
<p>and I think I remember a bit what is happening here</p>



<a name="163397673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163397673" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163397673">(Apr 15 2019 at 17:12)</a>:</h4>
<p>but I'm still not 100% sure what approach <span class="user-mention" data-user-id="214307">@Saleem Jaffer</span> is taking here</p>



<a name="163397694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163397694" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163397694">(Apr 15 2019 at 17:12)</a>:</h4>
<p>we're trying to avoid the <code>help</code> message, I see</p>



<a name="163397903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163397903" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163397903">(Apr 15 2019 at 17:15)</a>:</h4>
<p>I'm not 100% clear on why adjustments / coercions are part of this</p>



<a name="163398011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163398011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163398011">(Apr 15 2019 at 17:16)</a>:</h4>
<p>Ah, I guess it's because we want to know whether a given <code>&amp;</code> in MIR is actually "synthetic" or corresponds to something the user actually <em>wrote</em>?</p>



<a name="163398026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163398026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163398026">(Apr 15 2019 at 17:16)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> -- where in the code is the <code>help</code> text getting generated exactly?</p>



<a name="163399158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163399158" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163399158">(Apr 15 2019 at 17:32)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> -- where in the code is the <code>help</code> text getting generated exactly?</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/blob/9217fe0e2f04d61dd29c9aaebee2c993705e1d26/src/librustc_mir/borrow_check/mutability_errors.rs#L385-L395" target="_blank" title="https://github.com/rust-lang/rust/blob/9217fe0e2f04d61dd29c9aaebee2c993705e1d26/src/librustc_mir/borrow_check/mutability_errors.rs#L385-L395">https://github.com/rust-lang/rust/blob/9217fe0e2f04d61dd29c9aaebee2c993705e1d26/src/librustc_mir/borrow_check/mutability_errors.rs#L385-L395</a></p>



<a name="163399250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163399250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163399250">(Apr 15 2019 at 17:33)</a>:</h4>
<blockquote>
<p>Ah, I guess it's because we want to know whether a given <code>&amp;</code> in MIR is actually "synthetic" or corresponds to something the user actually <em>wrote</em>?</p>
</blockquote>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  Yes, we need to know if the <code>&amp;</code> is actually a <code>&amp;</code>, or a <code>&amp;mut</code> coerced to a <code>&amp;</code>. </p>
<p>We need to know this so that we can suppress the help text.</p>
<p>If we know that we are dealing with a <code>&amp;mut</code> coerced to a <code>&amp;</code>,  we can stop emitting the help text.</p>



<a name="163472169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163472169" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Saleem Jaffer <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163472169">(Apr 16 2019 at 14:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span>  Are the details I have mentioned clear, or should I be more elaborate?</p>



<a name="163473010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/163473010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#163473010">(Apr 16 2019 at 14:17)</a>:</h4>
<p>I think what you've said is clear, <span class="user-mention" data-user-id="116009">@nikomatsakis</span> have probably not seen your message yet :)</p>



<a name="189252536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/189252536" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nell Shamrell-Harrington <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#189252536">(Feb 27 2020 at 20:18)</a>:</h4>
<p>I've picked this one up and starting working it again - I'm updating my progress as I go along in the issue <a href="https://github.com/rust-lang/rust/issues/57431" target="_blank" title="https://github.com/rust-lang/rust/issues/57431">https://github.com/rust-lang/rust/issues/57431</a></p>



<a name="189252549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/%2357431/near/189252549" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nell Shamrell-Harrington <a href="https://rust-lang.github.io/zulip_archive/stream/147480-t-compiler/wg-diagnostics/topic/.2357431.html#189252549">(Feb 27 2020 at 20:18)</a>:</h4>
<p>If anyone sees anything there that is off base or going in the wrong direction, please let me know!</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>