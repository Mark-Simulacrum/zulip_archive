<html>
<head><meta charset="utf-8"><title>Diagnostic on missed import pre-2021 edition · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html">Diagnostic on missed import pre-2021 edition</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258796124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/258796124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#258796124">(Oct 23 2021 at 01:40)</a>:</h4>
<p>It was suggested in <a href="https://github.com/rust-lang/rust/issues/90157">#90157</a> that rustc emit a note in case someone tries to use one of <code>TryFrom</code>, <code>TryInto</code>, <code>FromIterator</code> without Edition 2021 without having imported it. Is this something we want?<br>
If so, I've looked at the steps that would need to be taken to do this; it seems that the easy case is the one of a failed <code>.try_into()</code> call, since this happens during type checking and we can check if any of the suggested traits to import have the <code>TryInto</code> <code>rustc_diagnostic</code>. On the other hand, in the case of someone trying to name one of these traits, this seems slightly more difficult; the necessary information seems only to be available in <code>rustc_resolve::diagnostics::lookup_import_candidates_from_module</code>. Is attaching a <code>note: Option&lt;String&gt;</code> field to <code>diagnostics::ImportSuggestions</code> that could carry an arbitrary additional note associated with that suggestion to the point where the error is emitted the right idea?</p>



<a name="258901878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/258901878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#258901878">(Oct 24 2021 at 22:29)</a>:</h4>
<p>Adding the <code>Option&lt;String&gt;</code> sounds reasonable</p>



<a name="258927774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/258927774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#258927774">(Oct 25 2021 at 08:06)</a>:</h4>
<p>I've started working on this; essentially, I'm just calling into <code>self.cstore().item_attributes(did, self.sess)</code> in <code>lookup_import_candidates_from_module</code> for the appropriate <code>DefId</code>s (specifically those that are arriving at L866). This causes ICEs in a couple of tests, for example <code>ui/const-generics/invalid-enum.rs</code> at <code>'Failed to get crate data for crate0', compiler/rustc_metadata/src/creader.rs:148:32</code>. Now I can fix this without too much of an issue (just ignore those cases where this would ICE), but why is it possible for a path to resolve to a <code>DefId</code> for which we can't get the crate metadata?</p>



<a name="259013224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/259013224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#259013224">(Oct 25 2021 at 20:07)</a>:</h4>
<p>That ICE is occurring when you try to lookup something from the current crate in the crate  store</p>



<a name="259013596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/259013596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#259013596">(Oct 25 2021 at 20:10)</a>:</h4>
<p>If you have the HIR available, you can use the <code>attrs</code> method for same-crate DefIds: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/hir/map/struct.Map.html#method.attrs">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/hir/map/struct.Map.html#method.attrs</a></p>



<a name="259031948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/259031948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#259031948">(Oct 25 2021 at 23:01)</a>:</h4>
<p>Ahh, that makes sense. This is in <code>rustc_resolve</code>, so I don't expect to have the HIR available. That being said, it doesn't matter, I'll just ignore local <code>DefId</code>s. This will cause the note to not be reported for anyone editing <code>libcore</code>, but I assume we don't particularly care</p>



<a name="259040035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic%20on%20missed%20import%20pre-2021%20edition/near/259040035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Diagnostic.20on.20missed.20import.20pre-2021.20edition.html#259040035">(Oct 26 2021 at 01:05)</a>:</h4>
<p>yeah, that seems fine</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>