<html>
<head><meta charset="utf-8"><title>suggest-await-trait · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait.html">suggest-await-trait</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266566086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait/near/266566086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Russell Cohen <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait.html#266566086">(Jan 01 2022 at 17:12)</a>:</h4>
<p>Hello! I'm working on improving the error from this snippet: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=92c676b88097475a39e31047b237b8e5">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=92c676b88097475a39e31047b237b8e5</a></p>
<p>I found the problem, which is that the <code>StreamExt</code> trait isn't considered in scope when it's attempting to determine if adding await would be useful.</p>
<p>And then I "fixed" it by copying and pasting this random incantation I saw somewhere else.<br>
(before, call.hir_id was used directly)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                                  </span><span class="kd">let</span><span class="w"> </span><span class="n">call_expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="err">‣</span><span class="n">call_expr</span>: <span class="kp">&amp;</span><span class="nc">Expr</span><span class="w"> </span><span class="err">‣</span><span class="o">&amp;</span><span class="n">FnCtxt</span><span class="w"></span>
<span class="w">                                      </span><span class="p">.</span><span class="n">tcx</span><span class="w"> </span><span class="err">‣</span><span class="n">TyCtxt</span><span class="w"></span>
<span class="w">                                      </span><span class="p">.</span><span class="n">hir</span><span class="p">()</span><span class="w"> </span><span class="err">‣</span><span class="n">Map</span><span class="w"></span>
<span class="w">                                      </span><span class="p">.</span><span class="n">expect_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">get_parent_node</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">hir_id</span><span class="p">));</span><span class="w"></span>
<span class="w">                                  </span><span class="bp">self</span><span class="p">.</span><span class="n">suggest_await_before_method</span><span class="p">(</span><span class="w"></span>
<span class="w">                                      </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">item_name</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">call_expr</span><span class="p">,</span><span class="w"> </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>I'm trying to figure out _why_, any ideas?</p>



<a name="266566108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait/near/266566108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Russell Cohen <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait.html#266566108">(Jan 01 2022 at 17:13)</a>:</h4>
<p>with that snippet, you  get: </p>
<div class="codehilite"><pre><span></span><code>help: consider `await`ing on the `Future` and calling the method on its `Output`
   |
20 |     let data = make_a_stream().await.collect::&lt;Vec&lt;_&gt;&gt;();
   |
</code></pre></div>
<p>in addition to the pretty useless error that you see in the playground</p>



<a name="266566372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait/near/266566372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Russell Cohen <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait.html#266566372">(Jan 01 2022 at 17:20)</a>:</h4>
<p>from: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/method/suggest.rs#L435-L441">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/method/suggest.rs#L435-L441</a></p>



<a name="266619955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait/near/266619955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Russell Cohen <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait.html#266619955">(Jan 02 2022 at 15:55)</a>:</h4>
<p>searching_for_traits_in_scope is actually returning <code>None</code> and not <code>[]</code> which makes me thing that the HirId of the method invocation is bad somehow? And that only the parent id actually has the required info</p>



<a name="267081431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait/near/267081431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/suggest-await-trait.html#267081431">(Jan 06 2022 at 16:30)</a>:</h4>
<p>As I mentioned when we talked 1:1, this is because, IIUC, you needed the HirId of the enclosing scope always, not of the expr you are looking at. BTW, in the final result, ideally we would hide the <em>current</em> note, because it is kind of useless once we find that calling <code>.await</code> would be enough</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>