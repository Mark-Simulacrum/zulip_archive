<html>
<head><meta charset="utf-8"><title>Include function name or other extra data in a span? · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html">Include function name or other extra data in a span?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275747211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275747211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275747211">(Mar 18 2022 at 00:41)</a>:</h4>
<p>Since I implemented backtrace pruning for Miri, simple examples often produce a one-frame backtrace. It looks a bit silly next to the span it is a backtrace to. But it also isn't entirely fair to omit it from the diagnostic, because it includes the name of the function that the error span is in.</p>
<p>Is there a way, or could someone (me?) add a way to include the information in the span diagnostic? Currently I see</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5</span>:<span class="mi">23</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
</code></pre></div>
<p>And I would like to see something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">main</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">5</span>:<span class="mi">23</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
</code></pre></div>
<p>but I'm not too picky about the exact placement.</p>



<a name="275749026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275749026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275749026">(Mar 18 2022 at 01:10)</a>:</h4>
<p>This is not currently supported in the API, but you could modify Diagnostic to add a field for this. What I would do instead is make that message part of the main message or note that is being shown (to avoid breaking any tools consuming the json)</p>



<a name="275791007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275791007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275791007">(Mar 18 2022 at 11:43)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/84373">#84373</a> allows to annotate spans with the enclosing <code>item</code>'s <code>DefId</code>. The first objective was incremental compilation, but the same infra can be used to know which in which item the span originated.</p>



<a name="275791074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275791074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275791074">(Mar 18 2022 at 11:44)</a>:</h4>
<p>Note: this annotation is not enabled by default, since it has a perf impact and that it is currently tied to incr comp.</p>



<a name="275851586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275851586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275851586">(Mar 18 2022 at 19:28)</a>:</h4>
<p>Oh! I hadn't thought of that <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275857354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275857354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275857354">(Mar 18 2022 at 20:18)</a>:</h4>
<p>How would one turn on the annotation?</p>



<a name="275869928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Include%20function%20name%20or%20other%20extra%20data%20in%20a%20span%3F/near/275869928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Include.20function.20name.20or.20other.20extra.20data.20in.20a.20span.3F.html#275869928">(Mar 18 2022 at 22:24)</a>:</h4>
<p>The annotation is accessible using <code>Span::parent</code>.<br>
You'd need:</p>
<ul>
<li>to decouple the annotation from the incr comp feature. That means removing special handling based on <code>span.parent</code> in the <code>HashStable</code>, <code>Encodable</code> and <code>Decodable</code> impls for <code>Span</code>, and gate them on `incr-relative-spans| cmd-line flag instead;</li>
<li>to use <code>Span::parent</code> to get an <code>Option&lt;LocalDefId&gt;</code> which points to the defining item, and use <code>tcx.item_name</code> to get the containing item's name.</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>