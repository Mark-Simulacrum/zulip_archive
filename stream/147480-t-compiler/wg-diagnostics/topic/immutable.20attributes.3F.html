<html>
<head><meta charset="utf-8"><title>immutable attributes? · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html">immutable attributes?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263746308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/immutable%20attributes%3F/near/263746308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rukai <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html#263746308">(Dec 05 2021 at 03:18)</a>:</h4>
<p>I am trying to get the derive attribute of a struct in rustc_typeck by doing something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">get_attrs</span><span class="p">(</span><span class="n">adt</span><span class="p">.</span><span class="n">did</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>But if I run this on the sample code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Default, PartialEq)]</span><span class="w"></span>
<span class="cp">#[some_made_up_attribute(Foo, Bar)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SomeDerives</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Then some_made_up_attribute is returned by get_attrs but derive is not.<br>
I guess this is because the attribute has been processed and therefore removed?<br>
maybe here?: <a href="https://github.com/rust-lang/rust/blob/141c6cc78ece04fb8330b2c28a42c025500d2d0e/compiler/rustc_expand/src/expand.rs#L1008">https://github.com/rust-lang/rust/blob/141c6cc78ece04fb8330b2c28a42c025500d2d0e/compiler/rustc_expand/src/expand.rs#L1008</a></p>
<p>Is there a way to get access to all attributes without some removed?</p>



<a name="263755186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/immutable%20attributes%3F/near/263755186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html#263755186">(Dec 05 2021 at 07:38)</a>:</h4>
<p>I wouldn't expect so; for the same reason that <code>#[cfg(x)]</code> is removed when <code>x</code> is set, it's part of macro expansion</p>



<a name="263755202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/immutable%20attributes%3F/near/263755202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html#263755202">(Dec 05 2021 at 07:39)</a>:</h4>
<p>I wouldn't expect so; for the same reason that <code>#[cfg(x)]</code> is removed when <code>x</code> is set, it's part of macro expansion</p>



<a name="263755203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/immutable%20attributes%3F/near/263755203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html#263755203">(Dec 05 2021 at 07:39)</a>:</h4>
<p>(well, I think cfgs are technically preserved currently but <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> wants to stop special casing them at some point)</p>



<a name="263766265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/immutable%20attributes%3F/near/263766265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rukai <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html#263766265">(Dec 05 2021 at 12:32)</a>:</h4>
<p>Ooh I see.<br>
Is there maybe some other way I could go about getting the span of the #[derive] of an adt for the purposes of diagnostics?</p>



<a name="263774003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/immutable%20attributes%3F/near/263774003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/immutable.20attributes.3F.html#263774003">(Dec 05 2021 at 15:37)</a>:</h4>
<p>I got the same problem previously, see <a href="#narrow/stream/147480-t-compiler.2Fwg-diagnostics/topic/Getting.20derive.20information.20during.20typecheck/near/255368402">&lt;zulip disscussion&gt;</a>. I'm not aware of any solution to this, sadly</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>