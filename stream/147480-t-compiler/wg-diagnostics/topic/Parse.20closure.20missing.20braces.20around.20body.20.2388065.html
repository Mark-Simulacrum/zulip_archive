<html>
<head><meta charset="utf-8"><title>Parse closure missing braces around body #88065 · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html">Parse closure missing braces around body #88065</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249574676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574676">(Aug 16 2021 at 11:08)</a>:</h4>
<p>Follow up from <a href="#narrow/stream/122652-new-members/topic/First.20non-trivial.20contribution">https://rust-lang.zulipchat.com/#narrow/stream/122652-new-members/topic/First.20non-trivial.20contribution</a></p>
<p><span class="user-mention" data-user-id="388880">@Sasha Pourcelot (she/her)</span>  You're looking at the right method in <code>Parser::parse_closure_expr</code>. If you look at that, you can also see that we call <code>parse_expr_res</code> or <code>parse_block_expr</code>. The later only when an explicit type has been given, which means that the likelihood of braces being missing are low, so we can focus on the first one.</p>



<a name="249574718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574718">(Aug 16 2021 at 11:08)</a>:</h4>
<p>We can ignore the ruby syntax case for now</p>



<a name="249574757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574757">(Aug 16 2021 at 11:09)</a>:</h4>
<p>So given that, following the method call chain we end up in <code>parse_assoc_expr_with</code></p>



<a name="249574777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574777">(Aug 16 2021 at 11:09)</a>:</h4>
<p>an option might be to create a new <code>Restrictions</code> signal, but would like to avoid that</p>



<a name="249574840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574840">(Aug 16 2021 at 11:10)</a>:</h4>
<p>it's likely we'll have to add a new field to the parser to hold info on the inner most closure being parsed right now, something similar to what we do with <code>last_type_ascription</code></p>



<a name="249574864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574864">(Aug 16 2021 at 11:10)</a>:</h4>
<p>So that before emitting any error we look to see if it could be this case.</p>



<a name="249574878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574878">(Aug 16 2021 at 11:10)</a>:</h4>
<p>Another alternative would be to keep a <code>self.clone()</code> snapshot and try both parses...</p>



<a name="249574918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249574918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249574918">(Aug 16 2021 at 11:11)</a>:</h4>
<p>But it'd be ideal if we can avoid that to not have to pay the memory cost of that.</p>



<a name="249575040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249575040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249575040">(Aug 16 2021 at 11:12)</a>:</h4>
<p>The first thing we can do is keep a signal that we're parsing a closure body to avoid the comma recovery</p>



<a name="249575497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249575497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249575497">(Aug 16 2021 at 11:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119031">Esteban Küber</span> <a href="#narrow/stream/147480-t-compiler.2Fwg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065/near/249574777">said</a>:</p>
<blockquote>
<p>an option might be to create a new <code>Restrictions</code> signal, but would like to avoid that</p>
</blockquote>
<p>That was my initial idea, but as you pointed out it is not ideal.</p>



<a name="249575791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249575791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249575791">(Aug 16 2021 at 11:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119031">Esteban Küber</span> <a href="#narrow/stream/147480-t-compiler.2Fwg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065/near/249575040">said</a>:</p>
<blockquote>
<p>The first thing we can do is keep a signal that we're parsing a closure body to avoid the comma recovery</p>
</blockquote>
<p>Alright, i'll start with that. I'll need some time as I lack experience with this part of the codebase. I'll ping you once I get there :)</p>



<a name="249577507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249577507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249577507">(Aug 16 2021 at 11:42)</a>:</h4>
<p>Remember you can use <code>-Ztreat-err-as-bug</code> and <code>RUST_BACKTRACE=1</code> to cause <code>rustc</code> to emit a stacktrace where the error is <code>emit</code>ted</p>



<a name="249577776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249577776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249577776">(Aug 16 2021 at 11:45)</a>:</h4>
<p>Nice! Thanks for the tip</p>



<a name="249580598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249580598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249580598">(Aug 16 2021 at 12:16)</a>:</h4>
<p>The rustc dev guide also has lots of info that comes in handy<br>
<a href="https://rustc-dev-guide.rust-lang.org/">https://rustc-dev-guide.rust-lang.org/</a></p>



<a name="249595822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249595822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249595822">(Aug 16 2021 at 14:29)</a>:</h4>
<p>I made little progress (see <a href="https://github.com/scrabsha/rust/compare/master...scrabsha:scrabsha/closure-missing-braces">my local branch</a>). So far I update the state of the parser to mark it as "currently parsing a closure body".</p>



<a name="249595856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249595856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249595856">(Aug 16 2021 at 14:29)</a>:</h4>
<p>I may be wrong, but this approach disables the recovery for the whole closure body, even for what's inside (where it may be legitimate), while we want to disable it only for the end of the closure body</p>



<a name="249610599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249610599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249610599">(Aug 16 2021 at 16:20)</a>:</h4>
<p>It would. Right now you have the signal in place only, you'd be missing the disabling of the comma recovery</p>



<a name="249691599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249691599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249691599">(Aug 17 2021 at 08:38)</a>:</h4>
<p>I think i'm getting somewhere. I have successfully disabled the errors that are caused by the incorrect recovery and added a test for it (see <a href="https://github.com/scrabsha/rust/compare/master...scrabsha:scrabsha/closure-missing-braces#diff-105ab5a49804d3ccd4ddbee76f499a760f5a86c24fae7ba2e3fdb21b0f93b8ef">the test</a> and <a href="https://github.com/scrabsha/rust/compare/master...scrabsha:scrabsha/closure-missing-braces#diff-105ab5a49804d3ccd4ddbee76f499a760f5a86c24fae7ba2e3fdb21b0f93b8ef">its stderr</a>).</p>



<a name="249700995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249700995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249700995">(Aug 17 2021 at 10:38)</a>:</h4>
<p>I have found an approach that may be a bit cleaner.<br>
TLDR: we can analyze the state of the Parser after extracting the closure body. If the innermost delimiter is a parenthesis and the next token is a colon, then we can trigger the "you may be missing a pair of braces" error.<br>
IMO it is cleaner and easier to implement since it does not add any internal state to the parser. I have pushed my idea <a href="https://github.com/scrabsha/rust/compare/master...scrabsha/closure-missing-braces-2">here</a>. Do you think that would work <span class="user-mention" data-user-id="119031">@Esteban Küber</span> ?</p>



<a name="249701373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249701373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249701373">(Aug 17 2021 at 10:44)</a>:</h4>
<p>The thing with that approach is that it would be <em>too</em> targeted for the repro case we have. We also need to account for other potential misparses. Just removing the suggestion altogether wouldn't have much fallout, just make the compiler less helpful. We can do that always only when parsing a closure without braces and the loss would be small</p>



<a name="249701449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249701449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249701449">(Aug 17 2021 at 10:44)</a>:</h4>
<p>There are cases where a comma would be needed after a closure when passed as a function argument to separate the next one, but the generic error in that case should already have enough context.</p>



<a name="249701467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249701467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249701467">(Aug 17 2021 at 10:45)</a>:</h4>
<p>Adding state to the parser is not ideal, though.</p>



<a name="249701554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249701554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249701554">(Aug 17 2021 at 10:46)</a>:</h4>
<p>Yeah, I'm not sure this code you posted will trigger with the repro case.</p>



<a name="249701609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249701609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249701609">(Aug 17 2021 at 10:47)</a>:</h4>
<p>give me a minute, i'll create a test with the exact code posted in the issue</p>



<a name="249701957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249701957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249701957">(Aug 17 2021 at 10:52)</a>:</h4>
<p>I inserted an explicit panic in the condition and copy/pasted the code from the issue and it panics<br>
The thing is that this method will not work in for the other-Ruby syntax<br>
(the code has been pushed to <code>scrabsha/closure-missing-braces-2</code>)</p>



<a name="249702216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249702216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249702216">(Aug 17 2021 at 10:55)</a>:</h4>
<p>The "signal" approach scares me a bit, as i have to find the places where i have to switch the signal on and off, and any mistake can dramatically degrade the diagnostics for other errors.</p>



<a name="249702895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249702895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249702895">(Aug 17 2021 at 11:03)</a>:</h4>
<p>Your point about this fix being way too specific is entirely valid though.</p>



<a name="249719503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249719503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249719503">(Aug 17 2021 at 13:37)</a>:</h4>
<p>I implemented the signal the way you described it. It removes all the errors caused by the recovery, keeping only the "unexpected <code>;</code>" error. I think this is what you described.<br>
The code is available <a href="https://github.com/scrabsha/rust/compare/master...scrabsha:scrabsha/closure-missing-braces">here</a></p>



<a name="249872211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249872211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249872211">(Aug 18 2021 at 16:04)</a>:</h4>
<p>So, I like the straighforward nature of the proactive approach (looking if surrounded by parens and we've encountered a semi, and try to parse a body). The second (or first, based on branch names) is closer to what I envisioned and seems quite complete. The only issue I see with this last one is that the AST ends up with a closure with a single statement, which causes the typeck error you see there</p>



<a name="249872753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249872753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249872753">(Aug 18 2021 at 16:08)</a>:</h4>
<p>So what I would do in either strategy is to use (IIRC) <code>self.mk_err(span)</code> instead so that we swallow the closure's body whole and avoid <em>any</em> error coming from it.</p>



<a name="249872887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249872887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249872887">(Aug 18 2021 at 16:09)</a>:</h4>
<p>I think that the approach in <code>closure-missing-braces</code> will properly handle the <code>{ |coming| from; ruby }</code> case</p>



<a name="249872924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249872924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249872924">(Aug 18 2021 at 16:09)</a>:</h4>
<p>Could you try that out, to see what output we get with it?</p>



<a name="249889267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249889267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249889267">(Aug 18 2021 at 18:06)</a>:</h4>
<p>Thanks for your feedback! I think I will drop the strategy I developped in <code>closure-missing-braces-2</code> and focus exclusively on the approach you suggested.<br>
There are also a couple of less-technical things I need to figure out, such as the wording of the error messages, but that can be discussed later.<br>
I was wondering how to remove the typeck error. I'll apply your suggestions tomorrow and will keep you updated for what happens with the ruby syntax :)<br>
Thank you again for taking time to review my code</p>



<a name="249977566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249977566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249977566">(Aug 19 2021 at 12:18)</a>:</h4>
<p>As you suggested, <code>self.mk_expr_err(span)</code> removed the typeck error. The resulting diagnostic looks is good imho. The recently added colored suggestions make the suggestion super-friendly too</p>



<a name="249977815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249977815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249977815">(Aug 19 2021 at 12:21)</a>:</h4>
<p>I added the a test for the <code>{ |coming| from; ruby }</code> syntax too (by the way, i love that name!). The results are the same as what was emitted before. I need to investigate a bit how the typecheck algorithm operate before working on it.</p>



<a name="249980702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/249980702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#249980702">(Aug 19 2021 at 12:47)</a>:</h4>
<p>Side question: should I open a PR now, which fixes only <a href="https://github.com/rust-lang/rust/issues/88065">#88065</a> or should I open a bigger PR where <code>{ |coming| from; ruby }</code> is fixed too?</p>



<a name="251414552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/251414552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#251414552">(Aug 31 2021 at 16:29)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="119031">@Esteban Küber</span>! I'm making good progress on the initial <a href="https://github.com/rust-lang/rust/issues/88065">#88065</a> but i have no clue on how to fix <code>{ |coming| from; ruby }</code> syntax error. Can i get some pointers of where to make changes?</p>



<a name="251422188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/251422188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#251422188">(Aug 31 2021 at 17:21)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="388880">@Sasha Pourcelot (she/her)</span>!<br>
That's great to hear! Do you have a PR open now or a branch I can look at? I would open a PR with what you already have, and then we can talk about addressing the "ruby closure" case on its own, likely building on top of what you've already have.</p>



<a name="251422267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/251422267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#251422267">(Aug 31 2021 at 17:21)</a>:</h4>
<p>I feel like the "forgot braces" case is going to be more prevalent than the "transposed where the braces go" case, so it makes sense to land it as soon as it is ready.</p>



<a name="251422449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/251422449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#251422449">(Aug 31 2021 at 17:22)</a>:</h4>
<p>Given that you'll be able to detect closures without braces, we can also detect single closures marked as recovered due to lack of braces inside of a block with no statements and a tail expression (the closure)</p>



<a name="251463973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/251463973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#251463973">(Aug 31 2021 at 21:33)</a>:</h4>
<p>Thank you for guidance :)<br>
I opened the PR <a href="https://github.com/rust-lang/rust/pull/88546">#88546</a> and took the liberty to r? you. Feel free to un-assign yourself if you feel this is inappropriate.<br>
I can't wait to start working on the ruby closure case</p>



<a name="254020404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254020404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254020404">(Sep 20 2021 at 09:26)</a>:</h4>
<p><span class="user-mention" data-user-id="119031">@Esteban Küber</span> i'm trying to work on the ruby-syntax handling. I have an idea of fix but I'd like to get some feedback before actually writing it:</p>
<p>- when checking a block expression (in <a href="https://github.dev/rust-lang/rust/blob/e71925aab9e28ce35363e3fdef27ca011ac6a1dc/compiler/rustc_typeck/src/check/fn_ctxt/checks.rs#L667-L667"><code>FnCtxt::check_block_with_expected</code></a>), see if the first statement of the block is a closure,<br>
  - if it is, then modify the state of the <code>FnCtxt</code>, perhaps by setting a <code>possible_ruby_style_closure</code> to true just before checking the tail expression,<br>
  - on type error, check for the value of <code>self.possible_ruby_style_closure</code>, and suggest the Rust syntax instead.</p>
<p>This could allow us to handle simple cases  where the closure variable is not used in the closure body, such as <code>{ |_x| dbg!(); 42 }</code>.</p>
<p>If it works well, we can change the type of <code>possible_ruby_style_closure</code> so that it stores the name of the variables introduced by the closure, which we can look at when we find a variable which is not in scope, such as <code>{ |x| dbg!(x); x * 2 }</code>.</p>
<p>It makes sense in my head but I don't know if it will work correctly. Do you think that makes sense? Alternatively, do you have a better idea?</p>



<a name="254060729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254060729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254060729">(Sep 20 2021 at 14:40)</a>:</h4>
<p><span class="user-mention" data-user-id="388880">@Sasha Pourcelot (she/her)</span> that approach sounds reasonable for this specific problem, but I'm wondering if there isn't an alternative approach where we eagerly complain about closures being created and dropped immediately. That should already be taken care by <code>#[must_use]</code>, but lints don't emit if there are other errors being emitted <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="254062895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254062895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254062895">(Sep 20 2021 at 14:54)</a>:</h4>
<p>This is the warning I'm talking about: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=d7d7fc41cc7ab3cdb9b20ecadcfedc03">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=d7d7fc41cc7ab3cdb9b20ecadcfedc03</a></p>



<a name="254154375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254154375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254154375">(Sep 21 2021 at 04:35)</a>:</h4>
<blockquote>
<p>lints don't emit if there are other errors being emitted</p>
</blockquote>
<p>You mean parse errors, right? In general I don't think errors are fatal unless someone specifically uses <code>sess.fatal</code></p>



<a name="254154395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254154395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254154395">(Sep 21 2021 at 04:35)</a>:</h4>
<p>(I don't have any idea how hard it would be to make parse errors non-fatal, but it doesn't seem impossible in theory)</p>



<a name="254160907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254160907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254160907">(Sep 21 2021 at 06:25)</a>:</h4>
<blockquote>
<p>You mean parse errors, right?</p>
</blockquote>
<p>I don't think the fix will be in the parsing step, as the ruby-style closure syntax is syntactically valid in Rust.</p>



<a name="254329753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/254329753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#254329753">(Sep 22 2021 at 08:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/147480-t-compiler.2Fwg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065/near/254154375">said</a>:</p>
<blockquote>
<blockquote>
<p>lints don't emit if there are other errors being emitted</p>
</blockquote>
<p>You mean parse errors, right? In general I don't think errors are fatal unless someone specifically uses <code>sess.fatal</code></p>
</blockquote>
<p>Fatal errors stop the compiler and no other errors are emitted, but lints don't get emitted if other errors were. Think the <code>unused_binding</code> lint, you don't see them if there was a type error anywhere in your crate. The same happens for these: the <code>unused_must_use</code> lint doesn't get emitted if there are any other errors in the file (because we don't want to inundate users with warnings that might go away when the error itself is fixed).</p>



<a name="256198799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/256198799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sasha Pourcelot (she/her) <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#256198799">(Oct 05 2021 at 08:49)</a>:</h4>
<p>Can we create an additional pass of lints that are always emitted, regardless of the errors emitted later?</p>
<p>As pointed out, this could be useful to <code>unused_binding</code> and <code>unused_must_use</code> and can also be used for unused parentheses around if condition as well as a warning against potential ruby-style closure.</p>
<p>Edit: i misread your message, your point about keeping the compiler output clear and concise is valid and more important IMO.</p>



<a name="256275190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Parse%20closure%20missing%20braces%20around%20body%20%2388065/near/256275190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Parse.20closure.20missing.20braces.20around.20body.20.2388065.html#256275190">(Oct 05 2021 at 16:19)</a>:</h4>
<p>I think it might be worth it to have a way of forcing the run of some lints, but they should be few and far between</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>