<html>
<head><meta charset="utf-8"><title>valtrees · project-const-generics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/index.html">project-const-generics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html">valtrees</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268010239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010239">(Jan 14 2022 at 13:02)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> So the first question I have is in what situations do we actually get the interning invariant violations? Does this only occur with ptrs and byte strings/arrays?</p>



<a name="268010319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010319">(Jan 14 2022 at 13:03)</a>:</h4>
<p>so the basic invariant violations are afaik ptr to integer casts</p>



<a name="268010476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010476">(Jan 14 2022 at 13:04)</a>:</h4>
<p>just to clarify, what exactly is Scalar::Ptr? Is this just a reference to a constant? Or are these raw pointers?</p>



<a name="268010665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010665">(Jan 14 2022 at 13:06)</a>:</h4>
<p>yeah <code>Scalar::Ptr</code> is a pointer or a reference to some constant</p>



<a name="268010766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010766">(Jan 14 2022 at 13:07)</a>:</h4>
<p>How would we encode these in valtrees? Would we just have a branch to whatever is pointed to?</p>



<a name="268010846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010846">(Jan 14 2022 at 13:08)</a>:</h4>
<p>this encoding in valtrees is already implemented</p>



<a name="268010851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010851">(Jan 14 2022 at 13:08)</a>:</h4>
<p>and think so, yeah</p>



<a name="268010894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010894">(Jan 14 2022 at 13:08)</a>:</h4>
<p>let me get a link, it's been a while since i've looked at this</p>



<a name="268010911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268010911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268010911">(Jan 14 2022 at 13:08)</a>:</h4>
<p>yeah I saw the implementation, though this specific case is unimplemented</p>



<a name="268011041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011041">(Jan 14 2022 at 13:10)</a>:</h4>
<p>interesting, did <span class="user-mention" data-user-id="124288">@oli</span> implement that in  <a href="https://github.com/rust-lang/rust/issues/83234">#83234</a>?</p>



<a name="268011073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011073">(Jan 14 2022 at 13:10)</a>:</h4>
<p>doesn't look like it</p>



<a name="268011078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011078">(Jan 14 2022 at 13:10)</a>:</h4>
<p>No, I think that was even prior to that. Let me try to find the PR</p>



<a name="268011151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011151">(Jan 14 2022 at 13:11)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/82936">https://github.com/rust-lang/rust/pull/82936</a></p>



<a name="268011157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011157">(Jan 14 2022 at 13:11)</a>:</h4>
<p>are you also talking about the converting a mir const to a valtree for <code>ty::Ref</code>?</p>



<a name="268011286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011286">(Jan 14 2022 at 13:12)</a>:</h4>
<p>mh not sure, thats actually what I find confusing. When do we have ty::Ref(some constant) and ty::Const(Scalar::Ptr)?</p>



<a name="268011383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011383">(Jan 14 2022 at 13:13)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(adt_const_params)]</span><span class="w"></span>
<span class="cp">#[derive(PartialEq, Eq)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">ConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="nc">ConstParam</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="268011662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011662">(Jan 14 2022 at 13:16)</a>:</h4>
<p>here <code>b</code> would be ty::Const(Scalar::ptr)?</p>



<a name="268011679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011679">(Jan 14 2022 at 13:16)</a>:</h4>
<p>(slowly remembering stuff) if we have a value <code>Scalar::Ptr</code> of type <code>ty::Ref('whatever, u32, Mutability::Not)</code> afaik we use <code>global_alloc</code> on the value and skip the <code>ty::Ref</code> in the val tree representation</p>



<a name="268011695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011695">(Jan 14 2022 at 13:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011662">said</a>:</p>
<blockquote>
<p>here <code>b</code> would be ty::Const(Scalar::ptr)?</p>
</blockquote>
<p>should be, yes</p>



<a name="268011755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011755">(Jan 14 2022 at 13:17)</a>:</h4>
<p>this will mean that <code>struct Foo { value: u32 }</code> and <code>struct Bar { value: &amp;'static u32 }</code> should have the same representation as val trees</p>



<a name="268011865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011865">(Jan 14 2022 at 13:18)</a>:</h4>
<blockquote>
<p>A pointer is represented as a Node with a single child, so (42,) and &amp;42 are represented exactly the same, only the type at the ty::Const level will differ.</p>
</blockquote>



<a name="268011904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011904">(Jan 14 2022 at 13:18)</a>:</h4>
<p>ok that makes sense</p>



<a name="268011955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268011955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268011955">(Jan 14 2022 at 13:19)</a>:</h4>
<p>xd, i was wrong <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> this doesn't really matter though, <span class="user-mention" data-user-id="124288">@oli</span> do you remember why we wanted to use a <code>Node</code> for references?</p>



<a name="268012115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012115">(Jan 14 2022 at 13:20)</a>:</h4>
<p>I briefly looked into how we currently handle <code>ConstValue</code> during codegen. We currently make use of <code>Allocation</code> e.g. for <code>Scalar::ByRef</code> and probably also somehow for <code>Scalar::Ptr</code>. How would we get back a reference to the allocation information from the current form of valtree?</p>



<a name="268012224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012224">(Jan 14 2022 at 13:21)</a>:</h4>
<blockquote>
<p>How would we get back a reference to the allocation information from the current form of valtree?</p>
</blockquote>
<p>e.g. for stuff like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="nc">MyType</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">N</span><span class="p">.</span><span class="n">field</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268012312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012312">(Jan 14 2022 at 13:22)</a>:</h4>
<p>during codegen of <code>foo::&lt;SomeValue&gt;</code> we need a mir constant for the valtree representation of <code>SomeValue</code>. that's what you're asking?</p>



<a name="268012397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012397">(Jan 14 2022 at 13:23)</a>:</h4>
<p>we do need a conversion from valtree back to mir constants for that afaict</p>



<a name="268012532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012532">(Jan 14 2022 at 13:24)</a>:</h4>
<p>So e.g. in <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_codegen_ssa/mir/operand.rs.html#68-111"><code>OperandRef::from_const</code></a> for <code>Scalar::ByRef</code> we use its <code>data: Allocation</code> field. However with Valtrees we don't store any information that would allow us to get a reference to this <code>Allocation</code> value</p>



<a name="268012643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012643">(Jan 14 2022 at 13:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012397">said</a>:</p>
<blockquote>
<p>we do need a conversion from valtree back to mir constants for that afaict</p>
</blockquote>
<p>Yes and I'm not sure at this point how the valtree representation allows us to do that (though I haven't thought too much about this)</p>



<a name="268012853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268012853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268012853">(Jan 14 2022 at 13:27)</a>:</h4>
<p>we can rebuild a mir constant using a valtree</p>



<a name="268013116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013116">(Jan 14 2022 at 13:29)</a>:</h4>
<p>well yes, I mean the information of the type information and the valtree should be enough to allow us to rebuild it,  but can we re-use all the const-eval memory information (not too familiar with how const-eval works currently, sry)?</p>



<a name="268013269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013269">(Jan 14 2022 at 13:30)</a>:</h4>
<p>no need to apologize <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> i don't think we can easily do that</p>



<a name="268013367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013367">(Jan 14 2022 at 13:31)</a>:</h4>
<p>If we re-build it from scratch that would be fairly expensive performance-wise, no?</p>



<a name="268013384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013384">(Jan 14 2022 at 13:31)</a>:</h4>
<p>^^</p>



<a name="268013519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013519">(Jan 14 2022 at 13:33)</a>:</h4>
<p>i would assume it to be acceptable, at least for now (as we're only allow integers on stable anyways)</p>



<a name="268013568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013568">(Jan 14 2022 at 13:33)</a>:</h4>
<p>What if we limit valtrees to the cases where we actually get the invariant problems?</p>



<a name="268013704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013704">(Jan 14 2022 at 13:34)</a>:</h4>
<p>the issue i see with reusing a mir constant here is that this might play badly with the query system as multiple mir constants map to the same valtree. Not completely certain how to avoid nondeterministic query results there</p>



<a name="268013775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268013775">(Jan 14 2022 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013568">said</a>:</p>
<blockquote>
<p>What if we limit valtrees to the cases where we actually get the invariant problems?</p>
</blockquote>
<p>what exactly do you mean with that?</p>



<a name="268014466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268014466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268014466">(Jan 14 2022 at 13:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013775">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/268013568">said</a>:</p>
<blockquote>
<p>What if we limit valtrees to the cases where we actually get the invariant problems?</p>
</blockquote>
<p>what exactly do you mean with that?</p>
</blockquote>
<p>yeah not sure, I dont think that made much sense^^ . I was just thinking that maybe we add some additional field or replace the Scalar::Ptr field and Scalar::Slice (for byte strings) field with some valtree like representation that can prevent the invariant problem (for those cases which actually cause the problem) and for other constvalues we just use a representation more like the current. But I'm probably missing something, like some Scalar::ByRef constant recursively depending on a ptr or something.</p>



<a name="268014654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268014654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268014654">(Jan 14 2022 at 13:42)</a>:</h4>
<p>what's the  "invariant problem"</p>



<a name="268014752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268014752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268014752">(Jan 14 2022 at 13:43)</a>:</h4>
<p>that ty::Const has multiple ways of representing the same value</p>



<a name="268014893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268014893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268014893">(Jan 14 2022 at 13:44)</a>:</h4>
<p>or rather "if interned things are equal, their interned address is the same"</p>



<a name="268015128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268015128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268015128">(Jan 14 2022 at 13:45)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> i assume that we don't want to change stuff about <code>Scalar</code> for this if we can avoid it</p>



<a name="268015450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268015450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268015450">(Jan 14 2022 at 13:48)</a>:</h4>
<p>Isn't <code>Scalar</code> supposed to go away anyway? Don't we just want to use <code>ScalarInt</code>for the leafs of the valtrees and <code>ConstValue</code> is replaced with <code>Valtree</code> right?</p>



<a name="268015617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268015617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268015617">(Jan 14 2022 at 13:49)</a>:</h4>
<p>we don't want to use <code>Scalar</code> in valtrees, i don't think there are any plans to remove <code>Scalar</code> from mir constants</p>



<a name="268015854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268015854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268015854">(Jan 14 2022 at 13:51)</a>:</h4>
<p>and we can't avoid the "equality issues" in mir constants</p>



<a name="268015947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268015947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268015947">(Jan 14 2022 at 13:52)</a>:</h4>
<p>isn't <code>mir::Constant</code> just a wrapper around <code>ty::Constant</code> that allows us to distinguish between which <code>ConstValue</code>s cannot be used by the type system anymore? </p>
<p>And as far as I understood oli's proposal we do want to replace <code>ConstValue</code> with the following:</p>
<div class="codehilite"><pre><span></span><code>enum ConstValue&lt;&#39;tcx&gt; {
    Leaf(u128),
    Node {
        variant: Option&lt;VariantIdx&gt;,
        elements: &amp;&#39;tcx [ConstValue&lt;&#39;tcx&gt;],
    }
}
</code></pre></div>



<a name="268016023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268016023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268016023">(Jan 14 2022 at 13:53)</a>:</h4>
<p>yeah, but this <code>ConstValue</code> won't be used by <code>mir::Constant</code>s anymore</p>



<a name="268016092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268016092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268016092">(Jan 14 2022 at 13:53)</a>:</h4>
<p>I don't understand that, can you elaborate? What does <code>mir::Constant</code> use instead?</p>



<a name="268016361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268016361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268016361">(Jan 14 2022 at 13:56)</a>:</h4>
<p>the final goal for <code>mir::Constant</code>s will be something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// in the mir module</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Const</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">span</span>: <span class="nc">Span</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">user_ty</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">UserTypeAnnotationIndex</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ty</span>: <span class="nc">Ty</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">kind</span>: <span class="nc">mir</span>::<span class="n">ConstKind</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// A different type from the one used in `ty::Const`s</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ConstValue</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Scalar</span><span class="p">(</span><span class="n">Scalar</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Slice</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">Allocation</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">start</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">end</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">ByRef</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">alloc</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">Allocation</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">offset</span>: <span class="nc">Size</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ConstKind</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="p">(</span><span class="n">ConstValue</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Unevaluated</span><span class="p">(</span><span class="n">DefId</span><span class="p">,</span><span class="w"> </span><span class="n">Substs</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Promoted</span><span class="p">(</span><span class="n">DefId</span><span class="p">,</span><span class="w"> </span><span class="n">Substs</span><span class="p">,</span><span class="w"> </span><span class="n">Promoted</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Param</span><span class="p">(</span><span class="n">ParamConst</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268016388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268016388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268016388">(Jan 14 2022 at 13:56)</a>:</h4>
<p>so mir constants keep the current <code>ConstValue</code>, only <code>ty::Const</code>s will have a different representation</p>



<a name="268016529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268016529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268016529">(Jan 14 2022 at 13:58)</a>:</h4>
<p>ah i see, thanks. that makes more sense.</p>



<a name="268016820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268016820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268016820">(Jan 14 2022 at 14:00)</a>:</h4>
<p>ok so, I think I roughly know how to implement this. Probably makes the most sense for me to just try to implement this now and we can sync again after I stumbled on some problems, ok?</p>



<a name="268017098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268017098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268017098">(Jan 14 2022 at 14:02)</a>:</h4>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> hope my explanations were helpful even though i don't remember as much about this as i hoped '^^</p>



<a name="268017156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268017156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268017156">(Jan 14 2022 at 14:02)</a>:</h4>
<p>yes that was helpful. Clarified some things I was confused about. Thanks a lot for your time.</p>



<a name="268017229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268017229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268017229">(Jan 14 2022 at 14:03)</a>:</h4>
<p>for less complex stuff, feel free to just ask async here</p>



<a name="268017358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268017358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268017358">(Jan 14 2022 at 14:04)</a>:</h4>
<p>btw have you talked to oli about whether its ok that I continue with the implementation?</p>



<a name="268017825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268017825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268017825">(Jan 14 2022 at 14:08)</a>:</h4>
<p>:3 nope, i assume he would hate that, so let's try to do this in secret</p>



<a name="268017857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268017857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268017857">(Jan 14 2022 at 14:08)</a>:</h4>
<p>(yes i did ask him before suggesting this to you)</p>



<a name="268865803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268865803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268865803">(Jan 21 2022 at 16:21)</a>:</h4>
<p>Hey @lcnr, I'm a little confused about how pointers are handled in const-eval.</p>
<p>When we try to evaluate a constant <code>&amp;str</code>, <code>eval_body_using_ecx</code> creates a <code>ConstAlloc</code>(with an Allocation that has, say, id <code>alloc2</code>) that refers to a pointer to another Allocation (with id <code>alloc1</code>) that contains the actual string data. The id for the allocation that contains the data is contained in a relocation of <code>alloc2</code>. </p>
<p>I haven't found a function that allows one to deref a <code>MemPlace</code> (pointing to the allocation of <code>alloc2</code>) so as to get the actual byte data of the string slice. Maybe I misunderstand something, can you clarify the following, please?</p>
<p>Do all pointer allocations point to their pointee allocation through an entry in <code>relocations</code>? If that's the case I don't really understand what <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/interpret/place.rs.html#297-306"><code>deref_operand</code></a> does.  It seems as if it just uses the <code>offset</code> of the actual pointer (not the <code>alloc_id</code> in the relocation) to create a <code>MemPlace</code>. In our case this is just a pointer to 0, since that is the <code>offset</code> of the pointer for <code>alloc2</code>. Is there a function that allows one to get access to the actual data given a <code>MemPlace</code> that points to <code>alloc2</code>?</p>



<a name="268873440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268873440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268873440">(Jan 21 2022 at 17:19)</a>:</h4>
<p>won't be online this weekend, and <span class="user-mention" data-user-id="120791">@RalfJ</span> or <span class="user-mention" data-user-id="124288">@oli</span> know more about mir values, but I would assume that: </p>
<ul>
<li>Do all pointer allocations point to their pointee allocation through an entry in relocations?</li>
</ul>
<p>yes </p>
<ul>
<li>If that's the case I don't really understand what deref_operand does. It seems as if it just uses the offset of the actual pointer (not the alloc_id in the relocation) to create a MemPlace. In our case this is just a pointer to 0, since that is the offset of the pointer for alloc2. Is there a function that allows one to get access to the actual data given a MemPlace that points to alloc2?</li>
</ul>
<p>for that i would have to look at the code itself. It seems to me like your currently trying to implement the valtree conversion for references? afaik<br>
<code>fn check_const_value_eq</code> already handles stuff like str in an okayish way <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> or maybe you can look at <code>fn destructure_const</code>if you haven't already.</p>
<p>Can take some time next week to delve into this, though i would like to see the bigger picture of where you're stuck for that .</p>



<a name="268886810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268886810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268886810">(Jan 21 2022 at 18:50)</a>:</h4>
<p><code>deref_operand</code> does value-to-place conversion (turning a ptr value into a place for the same memory location), like the <code>*</code> operator in C or Rust.</p>



<a name="268886915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268886915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268886915">(Jan 21 2022 at 18:51)</a>:</h4>
<p>this does not involve any memory access -- memory accesses occur when reading from or writing to a place</p>



<a name="268886960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268886960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268886960">(Jan 21 2022 at 18:51)</a>:</h4>
<p>but e.g. <code>&amp;mut *x</code> does no memory access, which shows that clearly <code>*</code> does not do a memory access</p>



<a name="268887572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268887572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268887572">(Jan 21 2022 at 18:55)</a>:</h4>
<blockquote>
<p>Is there a function that allows one to get access to the actual data given a MemPlace that points to alloc2?</p>
</blockquote>
<p>yes, <code>read_immediate</code>. there is a <code>impl&lt;'tcx, Tag: Provenance&gt; From&lt;MPlaceTy&lt;'tcx, Tag&gt;&gt; for OpTy&lt;'tcx, Tag&gt;</code> so you can do <code>&amp;mplace.into()</code> and pass that to a <code>read_*</code> method.<br>
(but note that I dont know what you want to achieve, I dont have the high-level picture here.)</p>



<a name="268953983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/268953983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#268953983">(Jan 22 2022 at 11:55)</a>:</h4>
<p>Thanks for the answers.</p>
<p>Ah, <code>read_immediate</code> and <code>read_immediate_from_mplace</code> are what I was looking for, reading those also helped to clear up the confusion I had about how pointers are handled in const-eval.</p>



<a name="269716532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269716532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269716532">(Jan 28 2022 at 10:44)</a>:</h4>
<p>I have a question about how we should handle slices whose byte data contains uninitialised bits. Currently I'm handling slices in the following way in <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/const_eval/mod.rs.html#57-133">const_to_valtree_inner</a>:</p>
<div class="codehilite"><pre><span></span><code>        ty::Ref(..) if place_ty.is_slice() =&gt; {
            match ecx.try_read_immediate_from_mplace(&amp;place) {
                Ok(Some(imm)) =&gt; {
                    debug!(&quot;immediate: {:?}&quot;, imm);
                    let (alloc, range) = ecx.get_alloc_from_imm_scalar_pair(imm);

                    let alloc_bytes = match alloc.get_bytes(&amp;ecx.tcx, range) {
                        Ok(bytes) =&gt; bytes,
                        Err(_) =&gt; return None,
                    };
                    debug!(?alloc_bytes);

                    let bytes = ecx.tcx.arena.alloc_slice(alloc_bytes);
                    let len = bytes.len();
                    let slice = ty::ValSlice { bytes};

                    Some(ty::ValTree::SliceOrStr(slice))
                }
                _ =&gt; {
                    None
                }
            }
        }
</code></pre></div>
<p>where <code>get_alloc_from_imm_scalar_pair</code> is:</p>
<div class="codehilite"><pre><span></span><code>    pub fn get_alloc_from_imm_scalar_pair(
        &amp;self,
        imm: ImmTy&lt;&#39;tcx, M::PointerTag&gt;,
    ) -&gt; (&amp;Allocation, AllocRange) {
        match imm.imm {
            Immediate::ScalarPair(a, b) =&gt; {
                let (data, start) = match self.scalar_to_ptr(a.check_init().unwrap()).into_parts() {
                    (Some(alloc_id), offset) =&gt; {
                        (self.tcx.global_alloc(alloc_id).unwrap_memory(), offset.bytes())
                    }
                    (None, _offset) =&gt; (
                        self.tcx.intern_const_alloc(Allocation::from_bytes_byte_aligned_immutable(
                            b&quot;&quot; as &amp;[u8],
                        )),
                        0,
                    ),
                };
                let len = b.to_machine_usize(self).unwrap();
                let size = Size::from_bytes(len);
                let start = Size::from_bytes(start);

                (data, AllocRange { start, size })
            }
            _ =&gt; bug!(&quot;{:?} not a ScalarPair&quot;, imm),
        }
    }
</code></pre></div>
<p>First, is this reasonable to handle slices that way? </p>
<p>We can't get bytes for slices that contain uninitialised bytes, I would assume that the correct way to handle those is just return <code>None</code> in <code>const_to_valtree</code> or should we handle those differently?</p>



<a name="269721933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269721933">(Jan 28 2022 at 11:33)</a>:</h4>
<blockquote>
<p>I would assume that the correct way to handle those is just return None in const_to_valtree or should we handle those differently?</p>
</blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>



<a name="269722111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722111">(Jan 28 2022 at 11:35)</a>:</h4>
<p><em>note: please use "```rust" in code snippets, they are fairly hard to read for me without syntax highlighting</em></p>



<a name="269722344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722344">(Jan 28 2022 at 11:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933">said</a>:</p>
<blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>
</blockquote>
<p>imo we can even always error eagerly here, even during selection, as imo having the requirement that const arguments either evaluate to a valtree or error seems nice to me</p>



<a name="269722451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722451">(Jan 28 2022 at 11:38)</a>:</h4>
<p>though that decision will need signoff by the lang team, and by <span class="user-mention" data-user-id="120791">@RalfJ</span> :p (also think the same about non utf8 strs as const arguments, they should just error imo)</p>



<a name="269722676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722676">(Jan 28 2022 at 11:41)</a>:</h4>
<p>Well, I think we actually have no choice but to error <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="269722775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722775">(Jan 28 2022 at 11:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722344">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933">said</a>:</p>
<blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>
</blockquote>
<p>imo we can even always error eagerly here, even during selection, as imo having the requirement that const arguments either evaluate to a valtree or error seems nice to me</p>
</blockquote>
<p>We do get ICEs when building std though if we error in the uninitialised case.</p>



<a name="269722795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722795">(Jan 28 2022 at 11:42)</a>:</h4>
<p>that seems fairly correct to me, <code>get_alloc_from_imm_scalar_pair</code> should probably not ice on wrong values, but apart from that it seems fairly nice</p>



<a name="269722800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722800">(Jan 28 2022 at 11:42)</a>:</h4>
<p>Maybe I'm calling <code>const_to_valtree</code> in the wrong place though</p>



<a name="269722807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722807">(Jan 28 2022 at 11:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722775">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722344">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933">said</a>:</p>
<blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>
</blockquote>
<p>imo we can even always error eagerly here, even during selection, as imo having the requirement that const arguments either evaluate to a valtree or error seems nice to me</p>
</blockquote>
<p>We do get ICEs when building std though if we error in the uninitialised case.</p>
</blockquote>
<p>why that?</p>



<a name="269722821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722821">(Jan 28 2022 at 11:42)</a>:</h4>
<p>where does it ice, i.e. what's the backtrace</p>



<a name="269722886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269722886">(Jan 28 2022 at 11:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722676">said</a>:</p>
<blockquote>
<p>Well, I think we actually have no choice but to error <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>
</blockquote>
<p>why? inside of selection we could also silently fail and reject the relevant candidate here</p>



<a name="269723758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269723758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269723758">(Jan 28 2022 at 11:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722807">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722775">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722344">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933">said</a>:</p>
<blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>
</blockquote>
<p>imo we can even always error eagerly here, even during selection, as imo having the requirement that const arguments either evaluate to a valtree or error seems nice to me</p>
</blockquote>
<p>We do get ICEs when building std though if we error in the uninitialised case.</p>
</blockquote>
<p>why that?</p>
</blockquote>
<p><a href="/user_uploads/4715/Cczx-Zr86CRl0hHGm7tLX-nn/backtrace.txt">backtrace.txt</a></p>



<a name="269723804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269723804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269723804">(Jan 28 2022 at 11:51)</a>:</h4>
<p>I'm calling <code>const_to_valtree</code> in <code>eval_to_const_value_raw_provider</code></p>



<a name="269724063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724063">(Jan 28 2022 at 11:53)</a>:</h4>
<p>eh sorry I meant in <code>turn_into_const_value</code>, but the backtrace shows that anyway</p>



<a name="269724072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724072">(Jan 28 2022 at 11:53)</a>:</h4>
<p>you're not emitting an error in the uninitialized case here, are you? that's an internal compiler error <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="269724240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724240">(Jan 28 2022 at 11:55)</a>:</h4>
<p>well this is if I use:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">alloc_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">alloc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecx</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bug</span><span class="o">!</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"></span>
<span class="w">                    </span><span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>instead of returning None in the <code>Err</code> case</p>



<a name="269724421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724421">(Jan 28 2022 at 11:56)</a>:</h4>
<p>so, <code>charwidth_table</code> is never used as a const argument, so we shouldn't try to get a valtree for it <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="269724448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724448">(Jan 28 2022 at 11:57)</a>:</h4>
<p>but it also shouldn't error if it were used in a valtree <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="269724497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724497">(Jan 28 2022 at 11:57)</a>:</h4>
<p>ah, a slice of <code>(char, char, u8, u8)</code> contains padding bytes xx</p>



<a name="269724509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724509">(Jan 28 2022 at 11:57)</a>:</h4>
<p>that's probably what's wrong here</p>



<a name="269724636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724636">(Jan 28 2022 at 11:59)</a>:</h4>
<p>do you mind opening a draft pr or sharing your current progress?</p>



<a name="269724715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724715">(Jan 28 2022 at 12:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724240">said</a>:</p>
<blockquote>
<p>well this is if I use:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">alloc_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">alloc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecx</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">bug</span><span class="o">!</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"></span>
<span class="w">                    </span><span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>instead of returning None in the <code>Err</code> case</p>
</blockquote>
<p>emitting a compiler bug isn't right here, i would like to emit an error instead of <code>bug!</code> here, though we probably don't have a good span for that</p>



<a name="269724851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724851">(Jan 28 2022 at 12:00)</a>:</h4>
<p>probably makes sense to change <code>const_to_valtree</code> to return a <code>Result</code> instead of an option</p>



<a name="269724947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724947">(Jan 28 2022 at 12:01)</a>:</h4>
<p>I can do that, but would need to clean this up first. I'm also currently trying to incoorporate <code>Valtree</code> into <code>ty::Const</code> to implement <code>PartialEq</code> and <code>Eq</code> in terms of valtree, without getting rid of <code>ConstValue</code> completely yet. I can open the WIP after that.</p>



<a name="269724967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269724967">(Jan 28 2022 at 12:01)</a>:</h4>
<p>or wait, failing to construct a valtree can just always error eagerly, don't think that returning <code>Result</code> is necessary</p>



<a name="269725030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725030">(Jan 28 2022 at 12:02)</a>:</h4>
<blockquote>
<p>without getting rid of ConstValue completely yet</p>
</blockquote>
<p>what's blocking you from completely removing <code>ConstValue</code> from <code>ty::Const</code> rn?</p>



<a name="269725069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725069">(Jan 28 2022 at 12:02)</a>:</h4>
<p>because I don't know yet how to convert valtree back into <code>mir::ConstValue</code></p>



<a name="269725131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725131">(Jan 28 2022 at 12:03)</a>:</h4>
<p>ah <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="269725251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725251">(Jan 28 2022 at 12:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269724967">said</a>:</p>
<blockquote>
<p>or wait, failing to construct a valtree can just always error eagerly, don't think that returning <code>Result</code> is necessary</p>
</blockquote>
<p>not completely sure what you mean here now, so you do want us to ICE if this fails?</p>



<a name="269725278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725278">(Jan 28 2022 at 12:04)</a>:</h4>
<p>no, return <code>None</code> if it fails</p>



<a name="269725286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725286">(Jan 28 2022 at 12:04)</a>:</h4>
<p>ok</p>



<a name="269725322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725322">(Jan 28 2022 at 12:05)</a>:</h4>
<p>and what can i do about the padding problem?</p>



<a name="269725324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725324">(Jan 28 2022 at 12:05)</a>:</h4>
<p>but when encountering <code>None</code> from <code>const_to_valtree</code> we can always error i think</p>



<a name="269725614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725614">(Jan 28 2022 at 12:07)</a>:</h4>
<p>cry? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="269725625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725625">(Jan 28 2022 at 12:07)</a>:</h4>
<p>not sure myself</p>



<a name="269725648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725648">(Jan 28 2022 at 12:07)</a>:</h4>
<p>so you can't eagerly convert a slice into bytes</p>



<a name="269725729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725729">(Jan 28 2022 at 12:08)</a>:</h4>
<p>i think yuo can reuse <code>branches</code> for that, with the length as <code>n</code></p>



<a name="269725938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725938">(Jan 28 2022 at 12:10)</a>:</h4>
<p>can call that directly with the <code>ty::Ref</code> to a slice afaict</p>



<a name="269725976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269725976">(Jan 28 2022 at 12:10)</a>:</h4>
<p>codegen should be able to handle padding correctly though, right? I haven't looked too deeply into that, but I think <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_codegen_llvm/consts.rs.html#27"><code>const_alloc_to_llvm</code></a> should probably handle padding right?</p>



<a name="269726146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269726146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269726146">(Jan 28 2022 at 12:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269725729">said</a>:</p>
<blockquote>
<p>i think yuo can reuse <code>branches</code> for that, with the length as <code>n</code></p>
</blockquote>
<p>I think @oli suspected recursing on slice types to be the source for the large perf regression</p>



<a name="269726211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269726211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269726211">(Jan 28 2022 at 12:13)</a>:</h4>
<p>we can specialcase <code>&amp;[&lt;integer_ty&gt;]</code> to directly read bytes</p>



<a name="269726240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269726240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269726240">(Jan 28 2022 at 12:13)</a>:</h4>
<p>but imo it's fine to not care about any perf regressions for now</p>



<a name="269726327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269726327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269726327">(Jan 28 2022 at 12:14)</a>:</h4>
<p>ok, I'll try that. Thanks for the help</p>



<a name="269726347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269726347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269726347">(Jan 28 2022 at 12:14)</a>:</h4>
<p>i suggest using <code>branches</code> for now and then later adding a specialcase for <code>&amp;[u8]</code> or whatever if it gets necessary for perf</p>



<a name="269728300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728300">(Jan 28 2022 at 12:32)</a>:</h4>
<p>Padding should not affect valtree creation. We only read bytes of the fields</p>



<a name="269728495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728495">(Jan 28 2022 at 12:34)</a>:</h4>
<blockquote>
<p>why? inside of selection we could also silently fail and reject the relevant candidate here</p>
</blockquote>
<p>Right, slightly concerning, but probably ok. I'd prefer to start with hard errors</p>



<a name="269728578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728578">(Jan 28 2022 at 12:35)</a>:</h4>
<p>If padding affects valtree creation I screwed up</p>



<a name="269728600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728600">(Jan 28 2022 at 12:35)</a>:</h4>
<p>Lmk if I can help debug</p>



<a name="269728885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728885">(Jan 28 2022 at 12:37)</a>:</h4>
<p>You shouldn't convert valtree back to constvalue. Codegen can handle both... oh wait. My valtree pr isn't merged yet</p>



<a name="269728897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728897">(Jan 28 2022 at 12:37)</a>:</h4>
<p><span aria-label="sob" class="emoji emoji-1f62d" role="img" title="sob">:sob:</span></p>



<a name="269728985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269728985">(Jan 28 2022 at 12:38)</a>:</h4>
<p>I think you want to fix up the valtree PR first or at least cherry pick a few changes out of it</p>



<a name="269731633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269731633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269731633">(Jan 28 2022 at 13:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728578">said</a>:</p>
<blockquote>
<p>If padding affects valtree creation I screwed up</p>
</blockquote>
<p>it doesn't, but your pr didn't implement valtree conversions for slices and references, so <span class="user-mention silent" data-user-id="328097">BN</span> still has to do that</p>



<a name="269731855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269731855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269731855">(Jan 28 2022 at 13:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269728885">said</a>:</p>
<blockquote>
<p>You shouldn't convert valtree back to constvalue. Codegen can handle both... oh wait. My valtree pr isn't merged yet</p>
</blockquote>
<p>can you go more into depth why that isn't necessary? during codegen, we need to convert valtrees to llvm constants if const params are used inside of functions</p>



<a name="269731914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269731914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269731914">(Jan 28 2022 at 13:02)</a>:</h4>
<p>did you already implement this conversion or is there something i am missing here?</p>



<a name="269731942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269731942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269731942">(Jan 28 2022 at 13:03)</a>:</h4>
<p>I thought I did, but it's def not merged. Maybe I forgot to push?</p>



<a name="269731992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269731992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269731992">(Jan 28 2022 at 13:03)</a>:</h4>
<p>the most recent pr here is <a href="https://github.com/rust-lang/rust/issues/83234">#83234</a>  afaik</p>



<a name="269732005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269732005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269732005">(Jan 28 2022 at 13:03)</a>:</h4>
<p>Yea, so I implemented valtree to llvm conversion, but likely not exhaustively</p>



<a name="269732118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269732118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269732118">(Jan 28 2022 at 13:04)</a>:</h4>
<p>In any case, I'm not sure if converting to constvalue is the right thing or whether we should just go from valtree to backend directly</p>



<a name="269732193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269732193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269732193">(Jan 28 2022 at 13:05)</a>:</h4>
<p>Where are you encountering this anyway? Feels odd to have complex valtrees in codegen, I thought that wouldn't happen</p>



<a name="269732582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269732582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269732582">(Jan 28 2022 at 13:08)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(adt_const_params)]</span><span class="w"></span>

<span class="cp">#[derive(Debug, PartialEq, Eq)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Inner</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">u16</span><span class="p">);</span><span class="w"></span>
<span class="cp">#[derive(Debug, PartialEq, Eq)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyStruct</span><span class="p">(</span><span class="n">Inner</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VALUE</span>: <span class="nc">MyStruct</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">VALUE</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="n">MyStruct</span><span class="p">(</span><span class="n">Inner</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="269732703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269732703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269732703">(Jan 28 2022 at 13:09)</a>:</h4>
<p>we're going to end up with an instance of <code>foo::&lt;SOME_VALTREE&gt;</code> and inside of that instance we need to create an llvm value/constant for <code>SOME_VALTREE</code> when using it</p>



<a name="269734443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734443">(Jan 28 2022 at 13:23)</a>:</h4>
<p>Ooh, inside the function, right</p>



<a name="269734473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734473">(Jan 28 2022 at 13:23)</a>:</h4>
<p>Yea</p>



<a name="269734501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734501">(Jan 28 2022 at 13:23)</a>:</h4>
<p>Still unsure whether we go indirectly through constvalue or not</p>



<a name="269734507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734507">(Jan 28 2022 at 13:23)</a>:</h4>
<p>Opinions?</p>



<a name="269734605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734605">(Jan 28 2022 at 13:24)</a>:</h4>
<p><span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> not sure how we currently do the conversions</p>



<a name="269734749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734749">(Jan 28 2022 at 13:25)</a>:</h4>
<p>would have to check whether we would then have to reimplement the conversion for each backend</p>



<a name="269734813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734813">(Jan 28 2022 at 13:25)</a>:</h4>
<p>i think going valtree -&gt; const value has the advantage of being easily verifiable</p>



<a name="269734955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269734955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269734955">(Jan 28 2022 at 13:26)</a>:</h4>
<p>go valtree -&gt; const value, and add a debug assert that const value -&gt; valtree results in the same valtree again</p>



<a name="269735049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269735049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269735049">(Jan 28 2022 at 13:27)</a>:</h4>
<p>so yeah, prefer valtree to const value and then to backend const <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="269735629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269735629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269735629">(Jan 28 2022 at 13:32)</a>:</h4>
<p>Sgtm</p>



<a name="269735697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269735697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269735697">(Jan 28 2022 at 13:33)</a>:</h4>
<p>Now... the best way to do this is probably CTFE itself</p>



<a name="269735711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269735711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269735711">(Jan 28 2022 at 13:33)</a>:</h4>
<p>It is a backend, too</p>



<a name="269736445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269736445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269736445">(Jan 28 2022 at 13:38)</a>:</h4>
<p>And you need lots of CTFE features for the back-conversion anyway I'm guessing</p>



<a name="269736446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269736446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269736446">(Jan 28 2022 at 13:38)</a>:</h4>
<p>Then you can spin up an evalcx and let it do the conversion and interning for you</p>



<a name="269736447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269736447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269736447">(Jan 28 2022 at 13:38)</a>:</h4>
<p>Like... treat all aggregate valtrees like an Rvalue::Aggregate and share code</p>



<a name="269782600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269782600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269782600">(Jan 28 2022 at 18:40)</a>:</h4>
<p>There is a problem with the current valtree implementation (on master). If you use the <code>const_to_valtree</code> query, e.g. by adding </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span>::<span class="n">ParamEnvAnd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param_env</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">constant</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">valtree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">const_to_valtree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>to <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/const_eval/eval_queries.rs.html#193-213"><code>turn_into_const_value</code></a> you get lots of ICEs of the following form when building std:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;forcing query with already existing `DepNode`
- query-key: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, value: ConstAlloc { alloc_id: alloc36, ty: usize } }
- dep-node: const_to_valtree(8183515e4cdd3830-6eb438d76f2aa9d5)&#39;, /Users/bn/Documents/rust-local-fork/playground/compiler/rustc_query_system/src/dep_graph/graph.rs:300:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

error: internal compiler error: unexpected panic

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.60.0-dev running on x86_64-apple-darwin

note: compiler flags: -Z unstable-options -Z macro-backtrace -Z osx-rpath-install-name -Z crate-attr=doc(html_root_url=&quot;https://doc.rust-lang.org/nightly/&quot;) -Z binary-dep-depinfo -Z force-unstable-if-unmarked -C opt-level=3 -C embed-bitcode=no -C split-debuginfo=unpacked -C codegen-units=4 -C debuginfo=1 -C debug-assertions=on -C incremental -C symbol-mangling-version=legacy -C link-args=-Wl,-rpath,@loader_path/../lib -C split-debuginfo=unpacked -C prefer-dynamic -C llvm-args=-import-instr-limit=10 -C embed-bitcode=yes --crate-type lib

note: some of the compiler flags provided by cargo are hidden

query stack during panic:
#0 [const_to_valtree] destructure constant
#1 [eval_to_const_value_raw] simplifying constant for the type system `num::dec2flt::decimal::Decimal::digits::{constant#0}`
end of query stack
</code></pre></div>



<a name="269786116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269786116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269786116">(Jan 28 2022 at 19:04)</a>:</h4>
<p>Whoa, sounds like <code>ConstAlloc</code>'s PartialEq or StableHash impl is broken. Probably the former. It should compare equal if the content is equal, so if the memory behind the alloc ID is the same</p>



<a name="269787748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269787748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269787748">(Jan 28 2022 at 19:15)</a>:</h4>
<p>OK thanks, I'll take a look at that</p>



<a name="269793458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269793458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269793458">(Jan 28 2022 at 19:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269722344">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933">said</a>:</p>
<blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>
</blockquote>
<p>imo we can even always error eagerly here, even during selection, as imo having the requirement that const arguments either evaluate to a valtree or error seems nice to me</p>
</blockquote>
<p>yes -- the entire point of valtrees is that all const generic arguments must be representable as valtrees. that ensures that they are sufficiently well-behaved to not break everything. hopefully.^^</p>



<a name="269793741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269793741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269793741">(Jan 28 2022 at 20:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269721933">said</a>:</p>
<blockquote>
<blockquote>
<p>I would assume that the correct way to handle those is just return None in const_to_valtree or should we handle those differently?</p>
</blockquote>
<p>yeah, trying to convert uninit bytes into a valtree should fail</p>
</blockquote>
<p>I think this was already noted, but just to be sure: uninit <code>u8</code> should definitely fail, but padding should just be ignored entirely by valtree construction so it is okay for that to be uninit.</p>



<a name="269794091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269794091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269794091">(Jan 28 2022 at 20:03)</a>:</h4>
<p>I have some valtree notes at <a href="https://hackmd.io/Qvrj_eOFTkCHZrhJ7f1ItA">https://hackmd.io/Qvrj_eOFTkCHZrhJ7f1ItA</a>, but I think some of that is superseded by oli's (not yet merged) PR</p>



<a name="269796098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269796098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269796098">(Jan 28 2022 at 20:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269786116">said</a>:</p>
<blockquote>
<p>Whoa, sounds like <code>ConstAlloc</code>'s PartialEq or StableHash impl is broken. Probably the former. It should compare equal if the content is equal, so if the memory behind the alloc ID is the same</p>
</blockquote>
<p>is checking the content correct? i thought that we don't dedup allocations <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="269796576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269796576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269796576">(Jan 28 2022 at 20:18)</a>:</h4>
<p>though at this point I don't know what to do <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="269796978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269796978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269796978">(Jan 28 2022 at 20:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269793458">said</a>:</p>
<blockquote>
<p>yes -- the entire point of valtrees is that all const generic arguments must be representable as valtrees. that ensures that they are sufficiently well-behaved to not break everything. hopefully.^^</p>
</blockquote>
<p>ah, that wasn't what I was saying, my concerns were about things like the following</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_const_exprs)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">B</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">B</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="269797244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269797244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269797244">(Jan 28 2022 at 20:23)</a>:</h4>
<p>vs.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_const_exprs)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">B</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bool_or_panic</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="n">bool_or_panic</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">B</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="269797422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269797422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269797422">(Jan 28 2022 at 20:24)</a>:</h4>
<p>the second example with an explicit panic should compile imo. We check whether the first impl applies for <code>[u8: 2]</code>, see that it uses a constant that panics (failing to satisfy its const evaluatable bound), and therefore consider the two impls to not overlap</p>



<a name="269797679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269797679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269797679">(Jan 28 2022 at 20:27)</a>:</h4>
<p>we could do the same thing for the first example. Check whether the two impls overlap by looking at the first impl with <code>N == 2</code>. We are then unable to convert the final value to a valtree and therefore consider the first impl to not apply for <code>[u8; 2]</code> and consider the two impls to not overlap, causing this to compile</p>



<a name="269797747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269797747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269797747">(Jan 28 2022 at 20:27)</a>:</h4>
<p>for the first example i however want to just eagerly error because the user caused ub in some way</p>



<a name="269797864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269797864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269797864">(Jan 28 2022 at 20:28)</a>:</h4>
<p><em>note: the first example currently fails even without converting the result to a valtree, we could use some more complex type for which we only error once we make a deep valtree conversion</em></p>



<a name="269798115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269798115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269798115">(Jan 28 2022 at 20:30)</a>:</h4>
<p>does that explanation makes sense to you <span class="user-mention" data-user-id="120791">@RalfJ</span>? i don't think it is immediately obvious whether failing to construct a valtree for some constant during selection should error loudly or silently fail, which would only cause us to discard that selection candidate, not necessarily causing compilation to fail</p>



<a name="269799569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799569">(Jan 28 2022 at 20:42)</a>:</h4>
<p>the first example causes compile-time UB, which we dont guarantee to detect</p>



<a name="269799655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799655">(Jan 28 2022 at 20:43)</a>:</h4>
<p>I dont have good intuition for trait selection stuff, so I am slightly worried about using "CTFE failed" as a signal to <em>allow</em> other code</p>



<a name="269799666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799666">(Jan 28 2022 at 20:43)</a>:</h4>
<p>that sounds like a monotonicity rule broken</p>



<a name="269799752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799752">(Jan 28 2022 at 20:44)</a>:</h4>
<p>it means if we at some point make our UB checker worse (so it detects fewer bugs) -- which we should be free to do -- then suddenly that could lead to existing code <em>failing</em> to compile</p>



<a name="269799859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799859">(Jan 28 2022 at 20:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799752">said</a>:</p>
<blockquote>
<p>it means if we at some point make our UB checker worse (so it detects fewer bugs) -- which we should be free to do -- then suddenly that could lead to existing code <em>failing</em> to compile</p>
</blockquote>
<p>that is true, and a reason for us to always emit an error when encountering ub</p>



<a name="269799902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799902">(Jan 28 2022 at 20:45)</a>:</h4>
<p>I would extend that to panics, now considering lib crate authors</p>



<a name="269799970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269799970">(Jan 28 2022 at 20:46)</a>:</h4>
<p>a lib crate could make a const panic in fewer situations and then suddenly that leads to downstream code failing? that seems... very surprising at least</p>



<a name="269800034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269800034">(Jan 28 2022 at 20:46)</a>:</h4>
<p>so my personal preference -- in particular since nothing here is precisely specified, let alone formally modeled -- would be to be cautious and never use "CTFE failed" as a signal to allow <em>anything</em>. always treat it as "CTFE failed now but who knows, it might succeed in the future".</p>



<a name="269800112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269800112">(Jan 28 2022 at 20:47)</a>:</h4>
<p>(so in a "multiple worlds" view of trait selection, "CTFE failed" might be true at the current world but not in future worlds. not sure if I am making sense here, this refers to some blog posts niko wrote a long time ago.)</p>



<a name="269800237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269800237">(Jan 28 2022 at 20:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269799970">said</a>:</p>
<blockquote>
<p>a lib crate could make a const panic in fewer situations and then suddenly that leads to downstream code failing? that seems... very surprising at least</p>
</blockquote>
<p>i always (implicitly) assumed <code>panic! -&gt; returns stuff</code> to be breaking, i.e. the act of panicking being part of the stability guarantees anyways</p>



<a name="269800286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269800286">(Jan 28 2022 at 20:49)</a>:</h4>
<p>but after seeing that assumption explicitly stated makes it seem a lot less desirable to me</p>



<a name="269800372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269800372">(Jan 28 2022 at 20:49)</a>:</h4>
<p>and probably not the way large parts of the rust community think about it</p>



<a name="269800861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269800861">(Jan 28 2022 at 20:53)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> should actually write a summary for this, but suppressing ctfe errors during trait selection might not actually be needed <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="269801769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269801769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269801769">(Jan 28 2022 at 21:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800034">said</a>:</p>
<blockquote>
<p>so my personal preference -- in particular since nothing here is precisely specified, let alone formally modeled -- would be to be cautious and never use "CTFE failed" as a signal to allow <em>anything</em>. always treat it as "CTFE failed now but who knows, it might succeed in the future".</p>
</blockquote>
<p>the problem here is that CTFE silently failing is needed for the "default way of writing impls" to work as expected</p>



<a name="269801904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269801904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269801904">(Jan 28 2022 at 21:02)</a>:</h4>
<p>e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">CanShrink</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="269801965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269801965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269801965">(Jan 28 2022 at 21:03)</a>:</h4>
<p>we want to be able to check <code>[u8; 0]: CanShrink&lt;_&gt;</code> without causing loud errors</p>



<a name="269802156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802156">(Jan 28 2022 at 21:04)</a>:</h4>
<p>even by adding a bound which checks for "eval to <code>true</code>" instead of panics, e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">CanShrink</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">BoolValue</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>: <span class="nc">IsTrue</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="269802242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802242">(Jan 28 2022 at 21:05)</a>:</h4>
<p>we still have the <code>0 - 1</code> constant in the <code>TraitRef</code> for that impl, which we will try to unify with stuff before considering any where bounds, still causing a ctfe panic</p>



<a name="269802371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802371">(Jan 28 2022 at 21:06)</a>:</h4>
<p>so we either add some ingenious hack here to deal with this, or at least sometimes silence ctfe errors are a necessity</p>



<a name="269802459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802459">(Jan 28 2022 at 21:07)</a>:</h4>
<p>got to write a summary for this issue next week, even if we don't change the current plan, it's still good to explicitly write down any tradeoffs</p>



<a name="269802697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802697">(Jan 28 2022 at 21:09)</a>:</h4>
<p>yeah while thinking about your 2nd original example I did realize that "abort compilation on any error" doesnt obviously work either</p>



<a name="269802736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802736">(Jan 28 2022 at 21:09)</a>:</h4>
<p>I am not quite sure what to make of these "speculative" CTFE executions. I dont have a good mental model that would explain what intuitively should happen here.</p>



<a name="269802763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802763">(Jan 28 2022 at 21:09)</a>:</h4>
<p>but this feels related to negative impls, somehow?</p>



<a name="269802942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269802942">(Jan 28 2022 at 21:11)</a>:</h4>
<p>so in that sense maybe CTFE evalaution failure should be more like "impl not found" and less like "negative impl found"? that should make CTFE <em>not</em> failing in the future a future-compat change, similar to adding more impls.</p>



<a name="269803240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269803240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269803240">(Jan 28 2022 at 21:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269802942">said</a>:</p>
<blockquote>
<p>so in that sense maybe CTFE evalaution failure should be more like "impl not found" and less like "negative impl found"? that should make CTFE <em>not</em> failing in the future a future-compat change, similar to adding more impls.</p>
</blockquote>
<p>that is a good idea i didn't think about <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> </p>
<blockquote>
<p>so we either add some ingenious hack here to deal with this</p>
</blockquote>
<p>gj <span class="user-mention" data-user-id="120791">@RalfJ</span>  :p</p>



<a name="269804027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269804027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269804027">(Jan 28 2022 at 21:19)</a>:</h4>
<p>I dont know what I did but I am glad it is helpful :)</p>



<a name="269808076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269808076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269808076">(Jan 28 2022 at 21:54)</a>:</h4>
<blockquote>
<p>is checking the content correct? i thought that we don't dedup allocations <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>We don't proactively. But two constants with the same memory are equal, otherwise we could end up with two constants that are equal but compare different. That breaks the type system. I mean it's the very reason we do all this valtree stuff...</p>



<a name="269808113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269808113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269808113">(Jan 28 2022 at 21:54)</a>:</h4>
<p>It is hard to get the equality right, as you can see from this error</p>



<a name="269953444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269953444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269953444">(Jan 30 2022 at 20:07)</a>:</h4>
<p>this all sounds like hacking around the lack of valtrees?</p>



<a name="269953452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269953452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269953452">(Jan 30 2022 at 20:07)</a>:</h4>
<p>the type system should never even have to deal with an allocation-backed constant</p>



<a name="269953454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269953454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269953454">(Jan 30 2022 at 20:07)</a>:</h4>
<p>that is the entire point of valtrees</p>



<a name="269953513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269953513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269953513">(Jan 30 2022 at 20:08)</a>:</h4>
<p>so all talk about equality of allocations in the context of the type system misses the point, I think?</p>



<a name="269955805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269955805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269955805">(Jan 30 2022 at 20:37)</a>:</h4>
<p>We're mostly talking about equality in the query system</p>



<a name="269955888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/269955888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#269955888">(Jan 30 2022 at 20:38)</a>:</h4>
<p>We want to Deduplicate queries that take allocid arguments</p>



<a name="270005472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270005472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270005472">(Jan 31 2022 at 09:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269955888">said</a>:</p>
<blockquote>
<p>We want to Deduplicate queries that take allocid arguments</p>
</blockquote>
<p>i think we would have to either dedup allocids or canonicalize them in the query output (which seems difficult)</p>



<a name="270008691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270008691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270008691">(Jan 31 2022 at 10:24)</a>:</h4>
<p>Do we even need <code>const_to_valtree</code> to be a query? Afaict we would always have to call that function inside <code>eval_to_const_value_raw</code> anyway, which is a query, so the valtree result is cached implicitly. <code>const_to_valtree_recursive</code> isn't a query, so it's not as if we would gain any benefit of caching sub-results (not sure whether that is something that might be beneficial though).</p>



<a name="270009433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270009433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270009433">(Jan 31 2022 at 10:29)</a>:</h4>
<p>it would be advantageous in case multiple calls to <code>eval_to_const_value_raw</code> have the same result</p>



<a name="270009470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270009470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270009470">(Jan 31 2022 at 10:29)</a>:</h4>
<p>though this only matters for complex result values, at which point they currently have different alloc ids anyways, so we can't even dedup them</p>



<a name="270009573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270009573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270009573">(Jan 31 2022 at 10:30)</a>:</h4>
<p>so yeah, just not using a query for <code>const_to_valtree</code> might be best for now <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="270014727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270014727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270014727">(Jan 31 2022 at 11:12)</a>:</h4>
<p>Why isn't it possible to give out a unique <code>AllocId</code> for an <code>Allocation</code>?</p>



<a name="270016967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270016967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270016967">(Jan 31 2022 at 11:33)</a>:</h4>
<p>you mean to deduplicate <code>Allocation</code>s? it might be possible, i don't know why we are not currently doing that</p>



<a name="270017047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270017047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270017047">(Jan 31 2022 at 11:33)</a>:</h4>
<p>though, i assume that we may need different allocation ids for "equivalent" allocations during const eval</p>



<a name="270017130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270017130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270017130">(Jan 31 2022 at 11:34)</a>:</h4>
<p>so that we can check whether two ptrs point to the same location</p>



<a name="270018906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270018906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270018906">(Jan 31 2022 at 11:50)</a>:</h4>
<p>Allocations can be mutable. In that case deduplicating them would be behavior changing and probably introducing UB due to aliasing mutable references.</p>



<a name="270023285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270023285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270023285">(Jan 31 2022 at 12:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270017047">said</a>:</p>
<blockquote>
<p>though, i assume that we may need different allocation ids for "equivalent" allocations during const eval</p>
</blockquote>
<p>By equivalent you just mean that a pointer allocation (with a relocation to the actual allocation) and the actual allocation should have different <code>AllocId</code>s?</p>



<a name="270023445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270023445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270023445">(Jan 31 2022 at 12:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270018906">said</a>:</p>
<blockquote>
<p>Allocations can be mutable. In that case deduplicating them would be behavior changing and probably introducing UB due to aliasing mutable references.</p>
</blockquote>
<p>But how does giving out multiple <code>AllocId</code>s for the same <code>Allocation</code> prevent that problem, that's still a form of aliasing of mutable references, isn't it?</p>



<a name="270024367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270024367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270024367">(Jan 31 2022 at 12:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270023285">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270017047">said</a>:</p>
<blockquote>
<p>though, i assume that we may need different allocation ids for "equivalent" allocations during const eval</p>
</blockquote>
<p>By equivalent you just mean that a pointer allocation (with a relocation to the actual allocation) and the actual allocation should have different <code>AllocId</code>s?</p>
</blockquote>
<p>no, my concern is the following code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270024461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270024461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270024461">(Jan 31 2022 at 12:41)</a>:</h4>
<p>here the target of both <code>x</code> and <code>y</code> are allocations containing the value 3. If we were to dedup allocations, both x and y would point to the same allocation, meaning that the mutation through x would be visible through <code>y</code></p>



<a name="270025793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270025793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270025793">(Jan 31 2022 at 12:52)</a>:</h4>
<p>Ah thanks, I misunderstood this. I thought we wanted to deduplicate <code>AllocId</code>s for the same <code>Allocation</code>, which we <a href="https://github.com/rust-lang/rust/blob/415c9f95884caebd0be9b837ef0885d1ffde1b9b/compiler/rustc_middle/src/mir/interpret/mod.rs#L459-L476">currently don't</a> do for <code>GlobalAlloc::Memory</code>, but do for <code>GlobalAlloc::Function</code> and <code>GlobalAlloc::Static</code> (why is that problematic to do for memory?).</p>
<p>And I think I'm probably missunderstanding the problem with the query system. The problem of the existing <code>DepNode</code>s is not due to the fact that we have different <code>AllocId</code>s for the same <code>Allocation</code>? If not, what exactly is the problem here (sry don't know the query system that well)?</p>



<a name="270038449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270038449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270038449">(Jan 31 2022 at 14:23)</a>:</h4>
<p>I had a wrong assumption about how we're encoding <code>AllocId</code>s <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> we actually do encode the contents of the allocations afaict, so the query system doesn't observe the ids of allocations meaning that it's fine if we assign different ids to the same allocation in separate incremental runs</p>



<a name="270038582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270038582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270038582">(Jan 31 2022 at 14:24)</a>:</h4>
<p>i think the issue is the <code>#[derive(HashStable)]</code> for <code>Allocation</code></p>



<a name="270038617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270038617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270038617">(Jan 31 2022 at 14:24)</a>:</h4>
<p>which is used during the <code>hash_stable</code> call for <code>AllocId</code></p>



<a name="270038879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270038879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270038879">(Jan 31 2022 at 14:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269782600">said</a>:</p>
<blockquote>
<p>There is a problem with the current valtree implementation (on master). If you use the <code>const_to_valtree</code> query, e.g. by adding </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span>::<span class="n">ParamEnvAnd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param_env</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">constant</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">valtree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">const_to_valtree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>to <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/const_eval/eval_queries.rs.html#193-213"><code>turn_into_const_value</code></a> you get lots of ICEs of the following form when building std:</p>
<p><div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;forcing query with already existing `DepNode`
- query-key: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, value: ConstAlloc { alloc_id: alloc36, ty: usize } }
</code></pre></div><br>
</p>
</blockquote>
<p>do you know what's the <code>GlobalAlloc</code> for  <code>alloc36</code>?</p>



<a name="270039300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270039300">(Jan 31 2022 at 14:28)</a>:</h4>
<p>Well... the query system can observe the ids due to <code>PartialEq</code> on <code>AllocId</code> comparing the raw ids <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="270039643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270039643">(Jan 31 2022 at 14:31)</a>:</h4>
<p>damn, it looks like I lost some of my work in the valtree PR in a rebase, let's see if github can still find it</p>



<a name="270039825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270039825">(Jan 31 2022 at 14:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039300">said</a>:</p>
<blockquote>
<p>Well... the query system can observe the ids due to <code>PartialEq</code> on <code>AllocId</code> comparing the raw ids ;)</p>
</blockquote>
<p>ah, i think i've got it</p>



<a name="270039864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270039864">(Jan 31 2022 at 14:32)</a>:</h4>
<p>we're only hashing the allocation, while completely ignoring the <code>AllocId</code>s</p>



<a name="270039919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270039919">(Jan 31 2022 at 14:32)</a>:</h4>
<p>so if we have 2 different <code>AllocId</code>s pointing to 2 different allocation objects with equal values and without any relocations</p>



<a name="270039985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270039985">(Jan 31 2022 at 14:33)</a>:</h4>
<p>these 2 allocations result in the same stable hash but the alloc ids don't compare equal</p>



<a name="270040274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270040274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270040274">(Jan 31 2022 at 14:35)</a>:</h4>
<p>phew github found it <a href="https://github.com/rust-lang/rust/compare/master...oli-obk:valtree_backup?expand=1">https://github.com/rust-lang/rust/compare/master...oli-obk:valtree_backup?expand=1</a></p>



<a name="270040330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270040330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270040330">(Jan 31 2022 at 14:35)</a>:</h4>
<p>that is the original PR, I accidentally pushed a half-rebased branch in the old PR</p>



<a name="270040497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270040497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270040497">(Jan 31 2022 at 14:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270039985">said</a>:</p>
<blockquote>
<p>these 2 allocations result in the same stable hash but the alloc ids don't compare equal</p>
</blockquote>
<p>jup, which has like 5 different solutions, some more fragile than others, but performance is also a concern <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="270041730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270041730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270041730">(Jan 31 2022 at 14:44)</a>:</h4>
<p>We could use <code>Allocation&lt;TcxAllocId&gt;</code>, we already have logic for mapping allocations for miri which has more info in a relocation than just an <code>AllocId</code>. This is likely a huge perf regression, but strictly the cleanest solution to separate CTFE-local ids and ids that go into types. If we're feeling really fancy we use something like <code>type TcxAllocation&lt;'tcx&gt; = &amp;'tcx Allocation&lt;TcxAllocation&lt;'tcx&gt;&gt;;</code>, tho idk how to handle that in CTFE yet (like if a constant uses another constant).</p>



<a name="270041845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270041845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270041845">(Jan 31 2022 at 14:44)</a>:</h4>
<p>so... I think something like <a href="https://github.com/rust-lang/rust/pull/93472#issuecomment-1025775814">https://github.com/rust-lang/rust/pull/93472#issuecomment-1025775814</a> is the right way forward</p>



<a name="270053886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270053886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270053886">(Jan 31 2022 at 15:55)</a>:</h4>
<p>pretty amazing that <a href="https://github.com/rust-lang/rust/issues/93470">#93470</a> gets opened on pretty much the same day <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="270346214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270346214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270346214">(Feb 02 2022 at 07:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/269800861">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="328097">BN</span> should actually write a summary for this, but suppressing ctfe errors during trait selection might not actually be needed <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>it will be needed during selection, either to go from ok -&gt; ambig or from ok -&gt; rejected</p>



<a name="270820164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270820164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270820164">(Feb 05 2022 at 10:59)</a>:</h4>
<p>Just read <span class="user-mention" data-user-id="124288">@oli</span>'s <a href="https://github.com/rust-lang/rust/compare/master...oli-obk:valtree_backup?expand=1">previous PR</a> and noticed that <code>GlobalId</code> is used as the key for the <a href="https://github.com/oli-obk/rust/blob/fc2244ae5f602fb348a72303936c1e9b58c985f6/compiler/rustc_mir/src/const_eval/mod.rs#L43-L58">valtree query</a> and we also couple the valtree creation with the evaluation of the constant. That seems like a more reasonable approach to me, since with the current <code>const_to_valtree</code> query implementation we don't really get any benefits of caching results anyway, since the <code>AllocId</code> key goes through the <code>Allocation</code> itself, so we can't really re-use any query results (unless we would de-duplicate <code>Allocation</code>, which we don't want to). We would also not get the <code>DepNode</code> problems. Is there anything that would be against that design choice?</p>
<p>Also, would we still need to cache the results of the <code>eval_to_const_value_raw</code> query or is this redundant given that we would always call that through the valtree creation query?</p>



<a name="270830218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270830218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270830218">(Feb 05 2022 at 14:38)</a>:</h4>
<p>Ah wow, I did a smart and royally (thanks autocorrect, I wrote "totally") forgot about it. I blame defending a thesis and newborn-induced lack of sleep, but it's actually just having a sieve instead of long term memory <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span> sorry about wasting so much of your time on the ConstAlloc thing. We can evaluate the stable hash for allocation situation in parallel, as we still have queries <em>returning</em> alloc ids</p>



<a name="270958200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270958200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270958200">(Feb 07 2022 at 10:28)</a>:</h4>
<p>Have a question about the valtree -&gt; mir::ConstValue conversion. By far the most straightforward approach would be to use an <code>AllocId</code> in the representation of a constant value in the type system, so we would have something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ConstValTree</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">valtree</span>: <span class="nc">ValTree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">alloc_id</span>: <span class="nc">AllocId</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but then ignore <code>alloc_id</code> in both the <code>PartialEq</code> and <code>HashStable</code> implementation. <code>ty::Const</code> for constant values would be uniquely identifiable by definition using the type and the ValTree. I'm not sure whether ignoring <code>alloc_id</code> in the <code>HashStable</code> implementation would be valid though...</p>
<p>A couple of reasons for why we would want to do this are: We could use existing logic (roughly what is currently being done in <code>turn_into_const</code>) to turn a constant value in the type system into an <code>mir::Constant</code> during mir build. We wouldn't need to de-construct the valtree and could re-use <code>Allocation</code>, so we wouldn't have to re-allocate memory (which was <a href="https://github.com/oli-obk/rust/blob/fc2244ae5f602fb348a72303936c1e9b58c985f6/compiler/rustc_codegen_cranelift/src/constant.rs#L157-L163">previously</a> done).</p>
<p>Would there be problems with the <code>HashStable</code> implementation?</p>



<a name="270958655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270958655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270958655">(Feb 07 2022 at 10:33)</a>:</h4>
<p>ignoring the <code>alloc_id</code> in <code>HashStable</code> can once again break the trait system</p>



<a name="270958710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270958710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270958710">(Feb 07 2022 at 10:33)</a>:</h4>
<p>so that sadly doesn't work <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="270958829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270958829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270958829">(Feb 07 2022 at 10:34)</a>:</h4>
<p>yeah was thinking that would be too easy ^^</p>



<a name="270958849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270958849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270958849">(Feb 07 2022 at 10:34)</a>:</h4>
<p>can you explain why that would break the trait system?</p>



<a name="270959918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270959918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270959918">(Feb 07 2022 at 10:44)</a>:</h4>
<p>i guess the clearest issue is:</p>
<ul>
<li>compile a crate and end up encoding <code>ConstValTree</code> using <code>alloc_id_a</code> </li>
<li>when you now compile the crate again, depending on whether you first call a green query using that <code>ConstValTree</code> or actually recompute that valtree, you may end up with some <code>alloc_id_b</code> which has different padding bytes/pointer targets. as the alloc ids are ignored for hashing, we only store one in any hashmap, so it ends up being nondeterministic which <code>alloc_id</code> is used when building constants for llvm</li>
</ul>



<a name="270960906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270960906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270960906">(Feb 07 2022 at 10:54)</a>:</h4>
<p>I see, thanks for the answer.</p>



<a name="270960942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270960942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270960942">(Feb 07 2022 at 10:54)</a>:</h4>
<p>while this nondeterminism might be somewhat fine if you erase all padding bytes and maybe do stuff with pointers? i definitely don't feel comfortable approving that change, esp. cause once you start erasing padding bytes you aren't that far from having a query constructing a new allocation</p>



<a name="270961016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270961016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270961016">(Feb 07 2022 at 10:55)</a>:</h4>
<p>it just seems awfully wasteful to throw away all the <code>Allocation</code> information</p>



<a name="270961176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270961176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270961176">(Feb 07 2022 at 10:57)</a>:</h4>
<p>^^ a bit wasteful for sure <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> i don't expect this to get too bad</p>



<a name="270961597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270961597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270961597">(Feb 07 2022 at 11:01)</a>:</h4>
<p>Do we really need an <code>Allocation</code> during codegen for things such as strings? Seems that when we already have the raw byte slice for the string, we shouldn't really need to re-allocate memory just to put those bytes back into an <code>Allocation</code>. (Dont really know much about codegen though ^^).</p>



<a name="270963648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270963648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270963648">(Feb 07 2022 at 11:20)</a>:</h4>
<p><span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="270963688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270963688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270963688">(Feb 07 2022 at 11:20)</a>:</h4>
<p>so iiuc <span class="user-mention" data-user-id="124288">@oli</span> went the direct valtree -&gt; llvm value route without converting valtrees back to mir values first</p>



<a name="270963712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270963712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270963712">(Feb 07 2022 at 11:21)</a>:</h4>
<p>which allows us to avoid these unnecessary allocations</p>



<a name="270963925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270963925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270963925">(Feb 07 2022 at 11:23)</a>:</h4>
<p>imo doing that is fine and i won't mind if you believe it to be easier</p>



<a name="270963932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270963932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270963932">(Feb 07 2022 at 11:23)</a>:</h4>
<p>my concerns here were that:</p>



<a name="270964010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270964010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270964010">(Feb 07 2022 at 11:24)</a>:</h4>
<ul>
<li>i don't want to do be forced to do this conversion for each backend separately, but preferably have it shared between all of them in <code>codegen_ssa</code></li>
</ul>



<a name="270964083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270964083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270964083">(Feb 07 2022 at 11:24)</a>:</h4>
<ul>
<li>going valtree -&gt; mir value allows us to easily check for any bugs by doing <code>assert_eq!(valtree, valtree.as_mir_value().as_valtree())</code></li>
</ul>



<a name="270965282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270965282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270965282">(Feb 07 2022 at 11:38)</a>:</h4>
<p>I agree with you that we should convert valtree to an mir::ConstValue. </p>
<p>What I don't like is that the backends would still depend on <code>Allocation</code> even though we would discard those instances when we introduce ValTrees. To me it seems much more reasonable to use another representation of <code>mir::ConstValue</code> that uses some other representation than <code>Allocation</code>. I think we should be able to directly convert the information contained in the valtree and the type of the constant into a more byte-like representation directly. Currently we let codegen do that transformation. But I'm not sure whether and in what way mir-transformation and optimization depend on <code>Allocation</code>. In general this would probably be a pretty large re-write and I'm not sure whether thats worth it (and how bad the Allocation -&gt; ValTree -&gt; Allocation transformations really are performance-wise).</p>



<a name="270965470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270965470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270965470">(Feb 07 2022 at 11:40)</a>:</h4>
<p>there are also <code>Allocation</code>s which never get converted to a valtree before being used by the backends</p>



<a name="270965527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270965527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270965527">(Feb 07 2022 at 11:41)</a>:</h4>
<p>Oh. What do those correspond to?</p>



<a name="270965680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270965680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270965680">(Feb 07 2022 at 11:42)</a>:</h4>
<p>e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">ASSOC</span>: <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ASSOC</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">// promoteds</span>
<span class="w">    </span><span class="n">FOO</span><span class="p">;</span><span class="w"> </span><span class="c1">// free constants</span>
<span class="w">    </span><span class="o">&lt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Trait</span><span class="o">&gt;</span>::<span class="n">ASSOC</span><span class="p">;</span><span class="w"> </span><span class="c1">// associated constants</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270965710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270965710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270965710">(Feb 07 2022 at 11:43)</a>:</h4>
<p>every constant not used as a const parameter doesn't get converted to a valtree</p>



<a name="270965750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270965750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270965750">(Feb 07 2022 at 11:43)</a>:</h4>
<p>&lt;=&gt; the only constants which are represented using valtrees are constants used directly in the type system</p>



<a name="270966029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966029">(Feb 07 2022 at 11:46)</a>:</h4>
<p>ok thanks. I thought that every constant would go through <code>eval_to_const_value_raw</code> at some point.</p>



<a name="270966066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966066">(Feb 07 2022 at 11:46)</a>:</h4>
<p>Or just be a <code>ConstValue</code> (<code>Literal</code>) directly</p>



<a name="270966108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966108">(Feb 07 2022 at 11:46)</a>:</h4>
<p>ah, though they will all go through <code>eval_to_const_value_raw</code>, won't they?</p>



<a name="270966123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966123">(Feb 07 2022 at 11:47)</a>:</h4>
<p>they just won't be converted to a valtree afterwards</p>



<a name="270966257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966257">(Feb 07 2022 at 11:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966108">said</a>:</p>
<blockquote>
<p>ah, though they will all go through <code>eval_to_const_value_raw</code>, won't they?</p>
</blockquote>
<p>at least that's my understanding of const eval? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> evaluate all constants using <code>eval_to_const_value_raw</code> (which is why it's a "raw" query), and then, if the constant should be used as a const parameter, that call is wrapped with <code>eval_to_valtree</code> or however that query is called</p>



<a name="270966260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966260">(Feb 07 2022 at 11:48)</a>:</h4>
<p>But we would call <code>const_to_valtree</code> in <code>eval_to_const_value_raw</code> right?</p>



<a name="270966279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966279">(Feb 07 2022 at 11:48)</a>:</h4>
<p>we do :o</p>



<a name="270966295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966295">(Feb 07 2022 at 11:48)</a>:</h4>
<p>i thought it's the other way around <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="270966632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270966632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270966632">(Feb 07 2022 at 11:52)</a>:</h4>
<p>but then i don't understand why we would not convert them to valtree.</p>



<a name="270967460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270967460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270967460">(Feb 07 2022 at 12:00)</a>:</h4>
<p>because we can't always do that</p>



<a name="270967714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270967714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270967714">(Feb 07 2022 at 12:02)</a>:</h4>
<p>how would we represent the following using valtrees?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">union</span> <span class="nc">MyUnion</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ptr</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">MY_UNION</span>: <span class="nc">MyUnion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyUnion</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ptr</span>: <span class="kp">&amp;</span><span class="mi">3</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MY_UNION</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270967967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270967967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270967967">(Feb 07 2022 at 12:05)</a>:</h4>
<p>the idea behind valtrees is:</p>
<ul>
<li>the type system needs well behaved equality which we can't get when dealing with padding bytes, unions or when looking at pointers</li>
</ul>



<a name="270968014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270968014">(Feb 07 2022 at 12:05)</a>:</h4>
<ul>
<li>in general can constants contain padding bytes, unions and pointers</li>
</ul>



<a name="270968165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270968165">(Feb 07 2022 at 12:07)</a>:</h4>
<p>so to make it easier for the type system to not accidentally touch pb, unions or pointers, we introduce a new representation which cannot contain padding points and unions and completely abstract away the references in its corresponding mir constant</p>



<a name="270968314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270968314">(Feb 07 2022 at 12:08)</a>:</h4>
<p>in general, there are valid ways in which constants interact with padding bytes, unions and pointers, preventing us from using valtrees for them</p>



<a name="270968484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270968484">(Feb 07 2022 at 12:10)</a>:</h4>
<p>What representation would <code>MY_UNION</code> have in the type system?</p>



<a name="270968612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270968612">(Feb 07 2022 at 12:11)</a>:</h4>
<p>I mean what <code>ConstKind</code> variant is used for it?</p>



<a name="270968854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270968854">(Feb 07 2022 at 12:13)</a>:</h4>
<p>It must be <code>ConstKind::Value</code> right? I thought that we wanted to replace <code>ty::ConstValue</code> with some valtree kind representation. So I'm a little confused now. While the points you mentioned do make sense to me, I don't see what the way out for this is.</p>



<a name="270975828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270975828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270975828">(Feb 07 2022 at 13:15)</a>:</h4>
<p>Ok, I read the entire thing and I think I'll start from a clean slate with the explanation:</p>
<p>If a constant is evaluated for the type system, we use (the new) <code>eval_to_valtree_raw</code>, which returns a <code>ValTree</code>. This is important, as it makes sure that any constant used as a generic parameter is a valtree and can never contain <code>AllocId</code>s or <code>Allocation</code>s.</p>
<p>If the constant is evaluated for an <code>Operand::Const</code> in the MIR, we use <code>eval_to_const_value_raw</code>, which gives us a <code>ConstValue</code>, that is more fitting for optimizations and codegen backends, as it can represent integers in an easy-to-use way, and it can represent <em>all</em> types, even unions, as you'll just get a <code>ByRef</code> that points to an <code>Allocation</code> containing the data.</p>
<p>If the "constant" is evaluated for a static item's initializer, we actually need to <em>preserve</em> identity of allocations, as static items can point to each other, and the soundness of user-code can depend on the fact that no deduplication happens. So here we'd use <code>eval_to_allocation_raw</code></p>



<a name="270976027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270976027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270976027">(Feb 07 2022 at 13:17)</a>:</h4>
<p>Now, we have a weird situation when you use a const generic parameter in an expression, as we only have that value available as a <code>ValTree</code>. We could theoretically eagerly convert it to <code>ConstValue</code>, but that is wasteful and not relevant for any correctness things.</p>



<a name="270976183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270976183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270976183">(Feb 07 2022 at 13:18)</a>:</h4>
<p>we will not replace <code>ConstValue</code> with <code>ValTree</code> in general, only in <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/consts/kind/enum.ConstKind.html#variant.Value">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/consts/kind/enum.ConstKind.html#variant.Value</a></p>



<a name="270976228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270976228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270976228">(Feb 07 2022 at 13:18)</a>:</h4>
<p>this way <code>ty::Const</code> and other interned stuff will stop depending on <code>AllocId</code> (since there is no more <code>ConstValue</code>), but <code>mir::Constant</code> can still represent <code>union</code>s.</p>



<a name="270976259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270976259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270976259">(Feb 07 2022 at 13:19)</a>:</h4>
<p>we simply can't have unions in the type system <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="270982704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/270982704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#270982704">(Feb 07 2022 at 14:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270968484">said</a>:</p>
<blockquote>
<p>What representation would <code>MY_UNION</code> have in the type system?</p>
</blockquote>
<p>yeah, so my union will never be represented in the type system, because it can't. This means that we won't use <code>ty::ConstKind</code> for it but instead store it using <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/enum.ConstantKind.html#variant.Val">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/enum.ConstantKind.html#variant.Val</a></p>



<a name="271008850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271008850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271008850">(Feb 07 2022 at 17:01)</a>:</h4>
<p>Thanks for the answers, that does clear some things up for me. Hadn't worked on any issues involving unions yet, so had no idea we didn't have those in the type system.</p>
<p>But I still have some questions, mostly about <code>mir::ConstantKind</code>. </p>
<p>When do we need to treat a mir::Constant as <code>mir::ConstantKind::Ty</code>? In what situations do we still need to use mir constants in the type system? Currently we <a href="https://github.com/rust-lang/rust/blob/c5e414843ebfe25674d8e18a5369d6249fdee741/compiler/rustc_mir_build/src/build/expr/as_constant.rs#L29-L31">treat</a> e.g. static initializers as mir::ConstantKind::Ty when we construct the mir. If I understood <span class="user-mention" data-user-id="124288">@oli</span> correctly we want to construct a <code>ConstValue</code>for these directly, but this implies that we would have to treat them as <code>mir::ConstantKind::Val</code> when we introduce Valtrees, right? Would that cause any problems as far as them not being able to be treated as <code>mir::ConstantKind::Ty</code> anymore?</p>
<p>Also <a href="https://github.com/rust-lang/rust/blob/c5e414843ebfe25674d8e18a5369d6249fdee741/compiler/rustc_const_eval/src/interpret/eval_context.rs#L724-L734">here</a> during const-eval we create <code>mir::Constant</code>s with <code>ConstantKind::Ty</code>. We would want to treat those as <code>ConstantKind::Val</code> after ValTrees have been introduced right?</p>



<a name="271009646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271009646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271009646">(Feb 07 2022 at 17:07)</a>:</h4>
<blockquote>
<p>In what situations do we still need to use mir constants in the type system? </p>
</blockquote>
<p>we should never have them in the type system</p>
<blockquote>
<p>Currently we treat e.g. static initializers as mir::ConstantKind::Ty when we construct the mir. </p>
</blockquote>
<p>that references a static from runtime code, and is a constant containing the address of the static's memory</p>
<blockquote>
<p>If I understood @oli correctly we want to construct a ConstValuefor these directly, but this implies that we would have to treat them as mir::ConstantKind::Val when we introduce Valtrees, right? Would that cause any problems as far as them not being able to be treated as mir::ConstantKind::Ty anymore?</p>
</blockquote>
<p>yea, these need to move to <code>Val</code>, but that can actually happen on master without the valtree changes, making the valtree changes less invasive</p>
<blockquote>
<p>Also here during const-eval we create mir::Constants with ConstantKind::Ty. We would want to treat those as ConstantKind::Val after ValTrees have been introduced right?</p>
</blockquote>
<p>uh, we should not be creating them with <code>::Ty</code> if not necessary, this is only an artifact of the current impl and we could move ahead and start evaluating them directly to <code>ConstValue</code> and keep them in the MIR. The problem is that we use normalization for that right now, which is why my valtree PR got out of hand, as I added all the logic for having a way to manipulate mir contants during normalization differently from type constants</p>



<a name="271012226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271012226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271012226">(Feb 07 2022 at 17:26)</a>:</h4>
<blockquote>
<p>The problem is that we use normalization for that right now, which is why my valtree PR got out of hand, as I added all the logic for having a way to manipulate mir contants during normalization differently from type constants</p>
</blockquote>
<p>What alternatives are there for that problem? We do have to normalize those though right, I mean we could have assoc consts in those required consts in the body, couldn't we? Would it be better to just have functionality to turn the returned <code>ty::ConstKind::Value</code> (with a valtree) from <code>subst_from_current_frame_normalize_erasing_regions</code> into an <code>mir::ConstantKind::Val</code> at that point?</p>



<a name="271023013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271023013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271023013">(Feb 07 2022 at 18:37)</a>:</h4>
<p>Well, not in general, remember, the unevaluated constant may be of <code>union</code> type, so we need to directly evaluate to a <code>ConstValue</code> if we're a <code>mir::Constant</code> and not recurse into the <code>ty::Const</code> nested inside the <code>::Ty</code> variant. The reason I nested <code>ty::Const</code> instead of just adding Unevaluated and Param variants to <code>mir::ConstantKind</code> is that all the logic around substitutions and such now needs to handle that. Meaning we have three places of params: types, constants and mir constants. But maybe that is cleaner? Idk. Got any opinions or ideas?</p>



<a name="271084009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271084009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271084009">(Feb 08 2022 at 05:46)</a>:</h4>
<p>I try to get to the core of your misunderstanding here <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
<p><code>mir::ConstantKind::Ty</code> is not a "mir constant used in the type system" as <code>mir::ConstantKind</code> are never used in the type system. The only place we use constants in the type system is <code>ty::Const</code> which uses <code>ty::ConstKind</code>.</p>
<p><code>mir::ConstantKind::Ty</code> is called that way, not because is represents a "type system const", but because it simply reuses the current <code>ty::Const</code> this is mostly the case as that's how all constants were represented in the past, which we intend to change with valtrees.</p>
<p>So while we never use a mir constant in the type system, for now, we want to use <code>mir::ConstantKind::Ty</code> for constants which we can't evaluate directly, e.g. generic associated constants.</p>
<p>there is one way a <code>mir::ConstantKind::Ty</code> with <code>ty::ConstKind::Value</code> should exist. If that mir constant was previously <code>ty::ConstKind::Param</code> and we evaluate/codegen that function with a concrete generic argument</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 2) ^ this `N` should have been `mir::ConstantKind::Ty` with `ty::ConstKind::Param` before.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// when looking into an the instance for `foo::&lt;3&gt;`, we instantiate that param with the generic argument</span>
<span class="w">    </span><span class="c1">// `ty::ConstKind::Value(3)`. This should be the only way to get a `ty::ConstKind::Value` into a mir constant.</span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 1) here, we monomorphize `foo::&lt;3&gt;`</span>
<span class="w">    </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the way we avoid valtrees when evaluating mir constants is by changing the implementation of <code>try_normalize_mir_const_after_erasing_regions</code> for <code>mir::ConstantKind::Ty</code> with <code>ty::ConstKind::Unevaluated</code> to use <code>eval_to_allocation_raw</code> - instead of <code>eval_to_valtree</code> - and directly put the result of that into a <code>mir::ConstantKind::Value</code>, never using <code>ty::ConstKind::Value</code> in the process</p>



<a name="271084114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271084114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271084114">(Feb 08 2022 at 05:48)</a>:</h4>
<p>i think i got the query names right in the last section <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="271155350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271155350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271155350">(Feb 08 2022 at 16:43)</a>:</h4>
<p>Thanks for the clarification about <code>mir::Constant</code>. </p>
<blockquote>
<p>The reason I nested ty::Const instead of just adding Unevaluated and Param variants to mir::ConstantKind is that all the logic around substitutions and such now needs to handle that. Meaning we have three places of params: types, constants and mir constants. But maybe that is cleaner? Idk. Got any opinions or ideas?</p>
</blockquote>
<p>What <span class="user-mention" data-user-id="216206">@lcnr</span> proposed here:</p>
<blockquote>
<p>the way we avoid valtrees when evaluating mir constants is by changing the implementation of try_normalize_mir_const_after_erasing_regions for mir::ConstantKind::Ty with ty::ConstKind::Unevaluated to use eval_to_allocation_raw - instead of eval_to_valtree - and directly put the result of that into a mir::ConstantKind::Value, never using ty::ConstKind::Value in the process</p>
</blockquote>
<p>sounds like the best approach to me to handle that, but it sounds like what you <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/271009646">tried</a> before, <span class="user-mention" data-user-id="124288">@oli</span> . How exactly did your previous PR got out of hand by trying to move all that logic into normalization?</p>



<a name="271156137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271156137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271156137">(Feb 08 2022 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/271009646">said</a>:</p>
<blockquote>
<blockquote>
<p>If I understood @oli correctly we want to construct a ConstValuefor these directly, but this implies that we would have to treat them as mir::ConstantKind::Val when we introduce Valtrees, right? Would that cause any problems as far as them not being able to be treated as mir::ConstantKind::Ty anymore?</p>
</blockquote>
<p>yea, these need to move to <code>Val</code>, but that can actually happen on master without the valtree changes, making the valtree changes less invasive</p>
</blockquote>
<p>I tried that but ran into some problems, namely we now promote constants that we didn't promote before, namely <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/transform/promote_consts.rs.html#426-443">here</a> <code>check_static_ptr</code>always returns <code>None</code> for <code>mir::ConstantKind::Val</code>. What is the correct way to handle this? What criteria would we use to decide whether or not to promote a <code>ConstantKind::Val</code>?</p>



<a name="271157512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271157512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271157512">(Feb 08 2022 at 16:58)</a>:</h4>
<blockquote>
<p>How exactly did your previous PR got out of hand by trying to move all that logic into normalization?</p>
</blockquote>
<p>I don't remember, my memories from that month are fuzzy from that time. I thought I had the PR mostly working and then disappeared for 3 months</p>



<a name="271158511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271158511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271158511">(Feb 08 2022 at 17:04)</a>:</h4>
<blockquote>
<p><code>check_static_ptr</code> always returns <code>None</code> for <code>mir::ConstantKind::Val</code></p>
</blockquote>
<p>that's just wrong, isn't it?</p>



<a name="271158756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271158756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271158756">(Feb 08 2022 at 17:06)</a>:</h4>
<p>i.e. the correct fix for that is to change <code>check_static_ptr</code> to also look at <code>ConstantKind::Val</code>.</p>
<p><code>try_to_scalar</code> doesn't even make sense for type system constants afaict so it should be removed from <code>ty::ConstKind</code> once we use valtrees there</p>



<a name="271159032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271159032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271159032">(Feb 08 2022 at 17:08)</a>:</h4>
<p>i think this fix is correct</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/compiler/rustc_middle/src/mir/mod.rs b/compiler/rustc_middle/src/mir/mod.rs</span><span class="w"></span>
<span class="gh">index 33fb1e570b1..fbadbccb006 100644</span><span class="w"></span>
<span class="gd">--- a/compiler/rustc_middle/src/mir/mod.rs</span><span class="w"></span>
<span class="gi">+++ b/compiler/rustc_middle/src/mir/mod.rs</span><span class="w"></span>
<span class="gu">@@ -2516,7 +2516,7 @@ pub enum ConstantKind&lt;'tcx&gt; {</span><span class="w"></span>

<span class="w"> </span>impl&lt;'tcx&gt; Constant&lt;'tcx&gt; {<span class="w"></span>
<span class="w"> </span>    pub fn check_static_ptr(&amp;self, tcx: TyCtxt&lt;'_&gt;) -&gt; Option&lt;DefId&gt; {<span class="w"></span>
<span class="gd">-        match self.literal.const_for_ty()?.val.try_to_scalar() {</span><span class="w"></span>
<span class="gi">+        match self.literal.try_to_scalar() {</span><span class="w"></span>
<span class="w"> </span>            Some(Scalar::Ptr(ptr, _size)) =&gt; match tcx.global_alloc(ptr.provenance) {<span class="w"></span>
<span class="w"> </span>                GlobalAlloc::Static(def_id) =&gt; {<span class="w"></span>
<span class="w"> </span>                    assert!(!tcx.is_thread_local_static(def_id));<span class="w"></span>
</code></pre></div>



<a name="271322207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271322207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271322207">(Feb 09 2022 at 18:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/270975828">said</a>:</p>
<blockquote>
<p>Ok, I read the entire thing and I think I'll start from a clean slate with the explanation:</p>
<p>If a constant is evaluated for the type system, we use (the new) <code>eval_to_valtree_raw</code>, which returns a <code>ValTree</code>. This is important, as it makes sure that any constant used as a generic parameter is a valtree and can never contain <code>AllocId</code>s or <code>Allocation</code>s.</p>
<p>If the constant is evaluated for an <code>Operand::Const</code> in the MIR, we use <code>eval_to_const_value_raw</code>, which gives us a <code>ConstValue</code>, that is more fitting for optimizations and codegen backends, as it can represent integers in an easy-to-use way, and it can represent <em>all</em> types, even unions, as you'll just get a <code>ByRef</code> that points to an <code>Allocation</code> containing the data.</p>
<p>If the "constant" is evaluated for a static item's initializer, we actually need to <em>preserve</em> identity of allocations, as static items can point to each other, and the soundness of user-code can depend on the fact that no deduplication happens. So here we'd use <code>eval_to_allocation_raw</code></p>
</blockquote>
<p>oh, I was thinking the "easy to represent integers" would be just represented as a small valtree. so basically a constant in MIR is a valtree or an AllocId (or Unevaluated or a generic parameter or ...). why doesn't that work?</p>



<a name="271339555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271339555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271339555">(Feb 09 2022 at 20:04)</a>:</h4>
<p>Well... we could do that and let llvm do the heavy lifting, but that change is a lot of effort and should wait until valtrees work properly. It's not a problem to have two ways to represent the same value in MIR</p>



<a name="271405085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271405085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271405085">(Feb 10 2022 at 09:23)</a>:</h4>
<p>3 ways ;) (valtree, ConstValue, Allocation) but fair</p>



<a name="271405218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271405218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271405218">(Feb 10 2022 at 09:24)</a>:</h4>
<p>I just really want to get rid of some of that awful code in <a href="http://const_eval.rs">const_eval.rs</a> that decides whether to return an Allocation or some ConstValue thing...</p>



<a name="271409023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271409023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271409023">(Feb 10 2022 at 10:02)</a>:</h4>
<p>Yea, that thing can be simplified a lot once valtrees exist</p>



<a name="271444798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271444798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271444798">(Feb 10 2022 at 15:13)</a>:</h4>
<p>makes sense to do it in steps</p>



<a name="271444860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271444860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271444860">(Feb 10 2022 at 15:13)</a>:</h4>
<p>parts of me are worried the cleanup will just not happen because it is "boring work" but rustc actually has a pretty good track record in this rgeard</p>



<a name="271445238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271445238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271445238">(Feb 10 2022 at 15:15)</a>:</h4>
<p>the cleanups that I've noticed that aren't happening are the ones we forget about</p>



<a name="271445250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/271445250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#271445250">(Feb 10 2022 at 15:15)</a>:</h4>
<p>ppl love cleaning up</p>



<a name="272708581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272708581">(Feb 21 2022 at 16:17)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/enum.Rvalue.html#variant.Repeat"><code>mir::Rvalue::Repeat</code></a> uses a <code>ty::Const</code> and we later need to call its <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/mir/tcx.rs.html#155-210"><code>ty</code></a> method during codegen to re-create <code>Ty</code> instances. We could just keep using <code>ty::Const</code> in <code>Rvalue::Repeat</code> and use our <code>ValTree</code> -&gt; <code>ConstValue</code> method (that we have to write anyway) during codegen, but this would be somewhat inconsistent since we treat all other constants that appear in the mir as <code>mir::Constant</code>. Are there any other possibilities to get around that problem?</p>



<a name="272708799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272708799">(Feb 21 2022 at 16:19)</a>:</h4>
<p>we want to keep using <code>ty::Const</code> in <code>Rvalue::Repeat</code></p>



<a name="272708870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272708870">(Feb 21 2022 at 16:20)</a>:</h4>
<p>from my pov the length of a repeat expression is not really a value, but just part of its type</p>



<a name="272708959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272708959">(Feb 21 2022 at 16:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708581">said</a>:</p>
<blockquote>
<p>We could just keep using <code>ty::Const</code> in <code>Rvalue::Repeat</code> and use our <code>ValTree</code> -&gt; <code>ConstValue</code> method (that we have to write anyway) during codegen, but this would be somewhat inconsistent since we treat all other constants that appear in the mir as <code>mir::Constant</code>.</p>
</blockquote>
<p>when do we need to convert the length of repeat expression to <code>ConstValue</code>?</p>



<a name="272709301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272709301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272709301">(Feb 21 2022 at 16:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708959">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708581">said</a>:</p>
<blockquote>
<p>We could just keep using <code>ty::Const</code> in <code>Rvalue::Repeat</code> and use our <code>ValTree</code> -&gt; <code>ConstValue</code> method (that we have to write anyway) during codegen, but this would be somewhat inconsistent since we treat all other constants that appear in the mir as <code>mir::Constant</code>.</p>
</blockquote>
<p>when do we need to convert the length of repeat expression to <code>ConstValue</code>?</p>
</blockquote>
<p>e.g <a href="https://github.com/rust-lang/rust/blob/1103d2e914b67c18b0deb86073c26c6aefda761d/compiler/rustc_codegen_ssa/src/mir/rvalue.rs#L105-L108">here</a>, though I think we might be able to just use the value that the valtree provides directly in this case.</p>



<a name="272709836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272709836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272709836">(Feb 21 2022 at 16:29)</a>:</h4>
<p>yeah, think we can just use the <code>Valtree</code>here</p>



<a name="272709881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272709881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272709881">(Feb 21 2022 at 16:29)</a>:</h4>
<p>the <code>count</code> for <code>write_operand_repeatedly</code> probably doesn't end up as a constant in llvm</p>



<a name="272711685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272711685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272711685">(Feb 21 2022 at 16:44)</a>:</h4>
<p>Ok thanks. Another question I have is, how do we proceed with the <a href="https://github.com/rust-lang/rust/pull/93800">PR</a> that had to be reverted? That change must happen afaict for the approach we chose to use valtrees.</p>



<a name="272713084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272713084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272713084">(Feb 21 2022 at 16:57)</a>:</h4>
<p>try to land it again while figuring out why the builder suddenly gets so much slower</p>



<a name="272713108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272713108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272713108">(Feb 21 2022 at 16:57)</a>:</h4>
<p>which is pretty unfortunate xx</p>



<a name="272717608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272717608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272717608">(Feb 21 2022 at 17:40)</a>:</h4>
<p>yea... basically my suggestion is to run a parallel compiler build on master and see how long it takes for you, then make the changes from the PR, but in tiny steps, they can be split up after all, even if it makes little sense to do, other than bisecting for the change that regresses the build times for parallel compiler this much</p>



<a name="272717634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272717634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272717634">(Feb 21 2022 at 17:41)</a>:</h4>
<p>once we know what it is, we'll talk about what to do, but likely we just unrevert it and disable parallel testing on CI</p>



<a name="272717915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272717915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272717915">(Feb 21 2022 at 17:44)</a>:</h4>
<p>fwiw, I think it's likely pretty awkward to disable parallel alt builds <em>just</em> here, and if we're going to ignore problems there we might as well just drop parallel from all the alt builders entirely, IMO</p>



<a name="272717933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272717933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272717933">(Feb 21 2022 at 17:44)</a>:</h4>
<p>which probably merits an MCP.</p>



<a name="272717962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272717962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272717962">(Feb 21 2022 at 17:44)</a>:</h4>
<p>(mingw-check would still verify that parallel at least <em>compiles</em> but that's much less testing than a self-bootstrap gives you)</p>



<a name="272718313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272718313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272718313">(Feb 21 2022 at 17:48)</a>:</h4>
<p>it's just so weird that a build will get worse by a significant percentage with such a minor change</p>



<a name="272718371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272718371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272718371">(Feb 21 2022 at 17:49)</a>:</h4>
<p>It's completely unrelated to parallel builds if it's indeed just a stage0 compiler building the stage1 compiler</p>



<a name="272718414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272718414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272718414">(Feb 21 2022 at 17:49)</a>:</h4>
<p>and that means that we should probably investigate, as it may be a way to save crates out in the wild from hitting such an edge case</p>



<a name="272718484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272718484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272718484">(Feb 21 2022 at 17:50)</a>:</h4>
<p>sure, well, parallel builds add a bunch more 'interesting' logic for LLVM's optimization passes (primarily mutexes around queries which means you can't move up/down around them for some ops)</p>



<a name="272725989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/272725989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#272725989">(Feb 21 2022 at 19:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/272708581">said</a>:</p>
<blockquote>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/enum.Rvalue.html#variant.Repeat"><code>mir::Rvalue::Repeat</code></a> uses a <code>ty::Const</code> and we later need to call its <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/mir/tcx.rs.html#155-210"><code>ty</code></a> method during codegen to re-create <code>Ty</code> instances. We could just keep using <code>ty::Const</code> in <code>Rvalue::Repeat</code> and use our <code>ValTree</code> -&gt; <code>ConstValue</code> method (that we have to write anyway) during codegen, but this would be somewhat inconsistent since we treat all other constants that appear in the mir as <code>mir::Constant</code>. Are there any other possibilities to get around that problem?</p>
</blockquote>
<p>it's more like a valtree → int conversion, which should be trivial</p>



<a name="273202927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273202927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273202927">(Feb 25 2022 at 08:54)</a>:</h4>
<p>These are the results for the local compilation times (with parallel enabled) of the changes in the reverted PR:</p>
<p>master with incremental:</p>
<div class="codehilite"><pre><span></span><code>real  33m7.138s
user  100m10.722s
sys 2m52.479s
</code></pre></div>
<p>master without incremental:</p>
<div class="codehilite"><pre><span></span><code>real  34m41.919s
user  116m26.710s
sys 2m39.252s
</code></pre></div>
<p>with the following changes:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/compiler/rustc_middle/src/mir/mod.rs b/compiler/rustc_middle/src/mir/mod.rs</span><span class="w"></span>
<span class="gh">index 2126487da02..5642d01de5d 100644</span><span class="w"></span>
<span class="gd">--- a/compiler/rustc_middle/src/mir/mod.rs</span><span class="w"></span>
<span class="gi">+++ b/compiler/rustc_middle/src/mir/mod.rs</span><span class="w"></span>
<span class="gu">@@ -2533,7 +2533,7 @@ pub enum ConstantKind&lt;'tcx&gt; {</span><span class="w"></span>

<span class="w"> </span>impl&lt;'tcx&gt; Constant&lt;'tcx&gt; {<span class="w"></span>
<span class="w"> </span>    pub fn check_static_ptr(&amp;self, tcx: TyCtxt&lt;'_&gt;) -&gt; Option&lt;DefId&gt; {<span class="w"></span>
<span class="gd">-        match self.literal.const_for_ty()?.val().try_to_scalar() {</span><span class="w"></span>
<span class="gi">+        match self.literal.try_to_scalar() {</span><span class="w"></span>
<span class="w"> </span>            Some(Scalar::Ptr(ptr, _size)) =&gt; match tcx.global_alloc(ptr.provenance) {<span class="w"></span>
<span class="w"> </span>                GlobalAlloc::Static(def_id) =&gt; {<span class="w"></span>
<span class="w"> </span>                    assert!(!tcx.is_thread_local_static(def_id));<span class="w"></span>
</code></pre></div>
<p>with incremental:</p>
<div class="codehilite"><pre><span></span><code>real  30m8.408s
user  100m23.833s
sys 2m37.104s
</code></pre></div>
<p>without incremental:</p>
<div class="codehilite"><pre><span></span><code>real  33m29.902s
user  113m34.371s
sys 2m29.305s
</code></pre></div>
<p>with these changes:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/compiler/rustc_middle/src/thir.rs b/compiler/rustc_middle/src/thir.rs</span><span class="w"></span>
<span class="gh">index 40dce281c82..a4e2a7c3e91 100644</span><span class="w"></span>
<span class="gd">--- a/compiler/rustc_middle/src/thir.rs</span><span class="w"></span>
<span class="gi">+++ b/compiler/rustc_middle/src/thir.rs</span><span class="w"></span>
<span class="gu">@@ -17,6 +17,7 @@</span><span class="w"></span>
<span class="w"> </span>use rustc_index::vec::IndexVec;<span class="w"></span>
<span class="w"> </span>use rustc_middle::infer::canonical::Canonical;<span class="w"></span>
<span class="w"> </span>use rustc_middle::middle::region;<span class="w"></span>
<span class="gi">+use rustc_middle::mir::interpret::AllocId;</span><span class="w"></span>
<span class="w"> </span>use rustc_middle::mir::{<span class="w"></span>
<span class="w"> </span>    BinOp, BorrowKind, FakeReadCause, Field, Mutability, UnOp, UserTypeProjection,<span class="w"></span>
<span class="w"> </span>};<span class="w"></span>
<span class="gu">@@ -419,7 +420,8 @@ pub enum ExprKind&lt;'tcx&gt; {</span><span class="w"></span>
<span class="w"> </span>    /// This is only distinguished from `Literal` so that we can register some<span class="w"></span>
<span class="w"> </span>    /// info for diagnostics.<span class="w"></span>
<span class="w"> </span>    StaticRef {<span class="w"></span>
<span class="gd">-        literal: Const&lt;'tcx&gt;,</span><span class="w"></span>
<span class="gi">+        alloc_id: AllocId,</span><span class="w"></span>
<span class="gi">+        ty: Ty&lt;'tcx&gt;,</span><span class="w"></span>
<span class="w"> </span>        def_id: DefId,<span class="w"></span>
<span class="w"> </span>    },<span class="w"></span>
<span class="w"> </span>    /// Inline assembly, i.e. `asm!()`.<span class="w"></span>
<span class="gh">diff --git a/compiler/rustc_middle/src/thir/visit.rs b/compiler/rustc_middle/src/thir/visit.rs</span><span class="w"></span>
<span class="gh">index 95489ac3ab2..b3e2cb132a2 100644</span><span class="w"></span>
<span class="gd">--- a/compiler/rustc_middle/src/thir/visit.rs</span><span class="w"></span>
<span class="gi">+++ b/compiler/rustc_middle/src/thir/visit.rs</span><span class="w"></span>
<span class="gu">@@ -123,7 +123,7 @@ pub fn walk_expr&lt;'a, 'tcx: 'a, V: Visitor&lt;'a, 'tcx&gt;&gt;(visitor</span><span class="w"></span>
<span class="w">: &amp;mut V, expr: &amp;Exp</span>
<span class="w"> </span>        }<span class="w"></span>
<span class="w"> </span>        Closure { closure_id: _, substs: _, upvars: _, movability: _, fake_reads: _ } =&gt; {}<span class="w"></span>
<span class="w"> </span>        Literal { literal, user_ty: _, const_id: _ } =&gt; visitor.visit_const(literal),<span class="w"></span>
<span class="gd">-        StaticRef { literal, def_id: _ } =&gt; visitor.visit_const(literal),</span><span class="w"></span>
<span class="gi">+        StaticRef { .. } =&gt; {}</span><span class="w"></span>
<span class="w"> </span>        InlineAsm { ref operands, template: _, options: _, line_spans: _ } =&gt; {<span class="w"></span>
<span class="w"> </span>            for op in &amp;**operands {<span class="w"></span>
<span class="w"> </span>                use InlineAsmOperand::*;<span class="w"></span>
<span class="gh">diff --git a/compiler/rustc_mir_build/src/build/expr/as_constant.rs b/compiler/rustc_mir_build/src/build/expr/as_constant.rs</span><span class="w"></span>
<span class="gh">index 79ac09d523d..0c0b0f2bd05 100644</span><span class="w"></span>
<span class="gd">--- a/compiler/rustc_mir_build/src/build/expr/as_constant.rs</span><span class="w"></span>
<span class="gi">+++ b/compiler/rustc_mir_build/src/build/expr/as_constant.rs</span><span class="w"></span>
<span class="gu">@@ -1,6 +1,7 @@</span><span class="w"></span>
<span class="w"> </span>//! See docs in build/expr/mod.rs<span class="w"></span>

<span class="w"> </span>use crate::build::Builder;<span class="w"></span>
<span class="gi">+use rustc_middle::mir::interpret::{ConstValue, Scalar};</span><span class="w"></span>
<span class="w"> </span>use rustc_middle::mir::*;<span class="w"></span>
<span class="w"> </span>use rustc_middle::thir::*;<span class="w"></span>
<span class="w"> </span>use rustc_middle::ty::CanonicalUserTypeAnnotation;<span class="w"></span>
<span class="gu">@@ -26,8 +27,12 @@ impl&lt;'a, 'tcx&gt; Builder&lt;'a, 'tcx&gt; {</span><span class="w"></span>
<span class="w"> </span>                assert_eq!(literal.ty(), ty);<span class="w"></span>
<span class="w"> </span>                Constant { span, user_ty, literal: literal.into() }<span class="w"></span>
<span class="w"> </span>            }<span class="w"></span>
<span class="gd">-            ExprKind::StaticRef { literal, .. } =&gt; {</span><span class="w"></span>
<span class="gd">-                Constant { span, user_ty: None, literal: literal.into() }</span><span class="w"></span>
<span class="gi">+            ExprKind::StaticRef { alloc_id, ty, .. } =&gt; {</span><span class="w"></span>
<span class="gi">+                let const_val =</span><span class="w"></span>
<span class="gi">+                    ConstValue::Scalar(Scalar::from_pointer(alloc_id.into(), &amp;this.tcx));</span><span class="w"></span>
<span class="gi">+                let literal = ConstantKind::Val(const_val, ty);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+                Constant { span, user_ty: None, literal }</span><span class="w"></span>
<span class="w"> </span>            }<span class="w"></span>
<span class="w"> </span>            ExprKind::ConstBlock { value } =&gt; {<span class="w"></span>
<span class="w"> </span>                Constant { span: span, user_ty: None, literal: value.into() }<span class="w"></span>
<span class="gh">diff --git a/compiler/rustc_mir_build/src/thir/cx/expr.rs b/compiler/rustc_mir_build/src/thir/cx/expr.rs</span><span class="w"></span>
<span class="gh">index 651edc827c3..5a7e1d88dd0 100644</span><span class="w"></span>
<span class="gd">--- a/compiler/rustc_mir_build/src/thir/cx/expr.rs</span><span class="w"></span>
<span class="gi">+++ b/compiler/rustc_mir_build/src/thir/cx/expr.rs</span><span class="w"></span>
<span class="gu">@@ -8,7 +8,6 @@</span><span class="w"></span>
<span class="w"> </span>use rustc_middle::hir::place::PlaceBase as HirPlaceBase;<span class="w"></span>
<span class="w"> </span>use rustc_middle::hir::place::ProjectionKind as HirProjectionKind;<span class="w"></span>
<span class="w"> </span>use rustc_middle::middle::region;<span class="w"></span>
<span class="gd">-use rustc_middle::mir::interpret::Scalar;</span><span class="w"></span>
<span class="w"> </span>use rustc_middle::mir::{BinOp, BorrowKind, Field, UnOp};<span class="w"></span>
<span class="w"> </span>use rustc_middle::thir::*;<span class="w"></span>
<span class="w"> </span>use rustc_middle::ty::adjustment::{<span class="w"></span>
<span class="gu">@@ -941,15 +940,8 @@ fn convert_path_expr(&amp;mut self, expr: &amp;'tcx hir::Expr&lt;'tcx&gt;, res: Res) -&gt; ExprKi</span><span class="w"></span>
<span class="w"> </span>                let kind = if self.tcx.is_thread_local_static(id) {<span class="w"></span>
<span class="w"> </span>                    ExprKind::ThreadLocalRef(id)<span class="w"></span>
<span class="w"> </span>                } else {<span class="w"></span>
<span class="gd">-                    let ptr = self.tcx.create_static_alloc(id);</span><span class="w"></span>
<span class="gd">-                    ExprKind::StaticRef {</span><span class="w"></span>
<span class="gd">-                        literal: ty::Const::from_scalar(</span><span class="w"></span>
<span class="gd">-                            self.tcx,</span><span class="w"></span>
<span class="gd">-                            Scalar::from_pointer(ptr.into(), &amp;self.tcx),</span><span class="w"></span>
<span class="gd">-                            ty,</span><span class="w"></span>
<span class="gd">-                        ),</span><span class="w"></span>
<span class="gd">-                        def_id: id,</span><span class="w"></span>
<span class="gd">-                    }</span><span class="w"></span>
<span class="gi">+                    let alloc_id = self.tcx.create_static_alloc(id);</span><span class="w"></span>
<span class="gi">+                    ExprKind::StaticRef { alloc_id, ty, def_id: id }</span><span class="w"></span>
<span class="w"> </span>                };<span class="w"></span>
<span class="w"> </span>                ExprKind::Deref {<span class="w"></span>
<span class="w"> </span>                    arg: self.thir.exprs.push(Expr { ty, temp_lifetime, span: expr.span, kind }),<span class="w"></span>
</code></pre></div>
<p>with incremental:</p>
<div class="codehilite"><pre><span></span><code>real  35m50.094s
user  101m39.999s
sys 3m17.025s
</code></pre></div>
<p>without incremental:</p>
<div class="codehilite"><pre><span></span><code>real  33m48.504s
user  114m58.851s
sys 2m33.117s
</code></pre></div>
<p>Though I do find these results somewhat weird, in that incremental/non-incremental don't differ in their compilation times. I changed the following in <code>config.toml</code>: <code>parallel-compiler = true</code> to enable parallel mode and the <code>incremental</code> option for incremental mode (and didn't use the -i option when running <code>\x.py</code>). Were these supposed to be run differently?</p>



<a name="273203927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273203927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273203927">(Feb 25 2022 at 09:05)</a>:</h4>
<p>Maybe the analysis on the PR was wrong and it's not stage1 after all? Your experiments sound correct to me</p>



<a name="273225132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273225132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273225132">(Feb 25 2022 at 12:58)</a>:</h4>
<p>It may well be msvc specific, fwiw</p>



<a name="273225232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273225232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273225232">(Feb 25 2022 at 13:00)</a>:</h4>
<p>I was definitely able to reproduce with a try build</p>



<a name="273226677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273226677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273226677">(Feb 25 2022 at 13:12)</a>:</h4>
<p>So... Can we turn off that parallel rustc builder? Or should we try landing the smaller changes in their own PRs and see how it goes?</p>



<a name="273229224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273229224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273229224">(Feb 25 2022 at 13:37)</a>:</h4>
<p>I would test smaller changes via try builds before landing anything, if we take that approach. Or file an MCP to drop parallel compiler from alt builds.</p>
<p>I'm not really happy with individual builders having different configuration for this kind of thing though.</p>



<a name="273229285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273229285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273229285">(Feb 25 2022 at 13:37)</a>:</h4>
<p>There is currently an expectation that parallel compiler is buildable and somewhat tested (via bootstrapping itself) -- if we start to change that, we should probably do it across the board, not just on msvc.</p>



<a name="273230997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273230997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273230997">(Feb 25 2022 at 13:55)</a>:</h4>
<blockquote>
<p>somewhat tested</p>
</blockquote>
<p>but only at -Zthreads=1 though, right ? My tests suggest that it probably couldn’t bootstrap easily with some parallelism active</p>



<a name="273231231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273231231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273231231">(Feb 25 2022 at 13:57)</a>:</h4>
<p>Not sure, yeah, quite possible</p>



<a name="273231294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273231294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273231294">(Feb 25 2022 at 13:57)</a>:</h4>
<p>(I think that is just more motivation for dropping it; I'd have no objections to that -- I just want us to do that in a more direct manner than gradually rolling back support in bits and pieces)</p>



<a name="273232126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273232126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273232126">(Feb 25 2022 at 14:04)</a>:</h4>
<p>With all the ICEs I got, I was thinking of opening a PR to drop it and perf test the bootstrap times.</p>
<p>And then it sometimes worked and I saw -50% improvements on some crates.</p>



<a name="273232543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273232543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273232543">(Feb 25 2022 at 14:08)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> A couple things I might add to your testing strategy:</p>
<ul>
<li>Enable rust.verify-llvm-ir</li>
<li>Enable llvm asserts</li>
</ul>



<a name="273245223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273245223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273245223">(Feb 25 2022 at 15:47)</a>:</h4>
<p>Ok, will try that. Btw the CI builders don't use incremental mode, do they? So it's not necessary to compare incremental/non-incremental versions, is it?</p>



<a name="273248034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273248034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273248034">(Feb 25 2022 at 16:10)</a>:</h4>
<p>No, that axis shouldn't matter.</p>



<a name="273248060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273248060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273248060">(Feb 25 2022 at 16:11)</a>:</h4>
<p>(likely best to keep it disabled to match CI config)</p>



<a name="273278150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273278150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273278150">(Feb 25 2022 at 20:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Again no noticeable changes:</p>
<p>master:</p>
<div class="codehilite"><pre><span></span><code>real  32m56.441s
user  115m26.794s
sys 2m25.0
</code></pre></div>
<p>first commit:</p>
<div class="codehilite"><pre><span></span><code>real  33m11.964s
user  113m57.220s
sys 2m20.031s
</code></pre></div>
<p>second commit:</p>
<div class="codehilite"><pre><span></span><code>real    32m28.369s
user    113m49.062s
sys 2m17.667s
</code></pre></div>



<a name="273279997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273279997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273279997">(Feb 25 2022 at 20:23)</a>:</h4>
<p>and those are all with llvm asserts, parallel, and verification? I'm not sure what to really suggest -- it definitely reproduces in CI, so presumably something about your environment is different</p>
<p>(Or it's been fixed with other changes which de-tickled whatever code since then)</p>
<p>It might makes sense to do another try build like the one I did -- I can queue that up</p>



<a name="273280321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273280321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273280321">(Feb 25 2022 at 20:26)</a>:</h4>
<p>queued up another try build with a re-land of the PR <a href="https://github.com/rust-lang/rust/pull/94195">https://github.com/rust-lang/rust/pull/94195</a></p>



<a name="273283140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273283140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273283140">(Feb 25 2022 at 20:48)</a>:</h4>
<p>Yes I did enable parallel and verify-llvm-ir, wasn't completely sure about the llvm assertions, but I had the assertions flag in <code>config.toml</code> set and thought that was likely what you meant.</p>



<a name="273283318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273283318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273283318">(Feb 25 2022 at 20:50)</a>:</h4>
<p>yes, llvm.assertions</p>



<a name="273283336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273283336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273283336">(Feb 25 2022 at 20:50)</a>:</h4>
<p>Well, I guess we'll see what the try build says.</p>



<a name="273296511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273296511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273296511">(Feb 25 2022 at 23:00)</a>:</h4>
<p><a href="https://github.com/rust-lang-ci/rust/runs/5337821574?check_suite_focus=true">https://github.com/rust-lang-ci/rust/runs/5337821574?check_suite_focus=true</a> -- on master, 1h30m<br>
<a href="https://github.com/rust-lang-ci/rust/runs/5338994996?check_suite_focus=true">https://github.com/rust-lang-ci/rust/runs/5338994996?check_suite_focus=true</a> -- with <a href="https://github.com/rust-lang/rust/issues/93800">#93800</a> re-applied, 2h30m</p>



<a name="273296540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273296540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273296540">(Feb 25 2022 at 23:01)</a>:</h4>
<p>so it looks like regression is still there</p>



<a name="273324741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273324741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273324741">(Feb 26 2022 at 07:32)</a>:</h4>
<p>Hm that's weird. What exactly is this running, is it just <code>./x.py build library/std</code>?</p>



<a name="273324900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273324900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273324900">(Feb 26 2022 at 07:37)</a>:</h4>
<p>Also there was one other change in the PR, namely using an <code>mir::Visitor</code> instead of a <code>TypeVisitor</code> in pretty print related code, but I excluded that from the timing tests, since I didn't think that pretty print code would play a role here. I can test that change specifically again later if it makes sense that this could potentially play a role in the regression.</p>



<a name="273508014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273508014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273508014">(Feb 28 2022 at 15:41)</a>:</h4>
<p>It runs x.py dist</p>



<a name="273508035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273508035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273508035">(Feb 28 2022 at 15:41)</a>:</h4>
<p>I would not exclude anything at all from local measurements.</p>



<a name="273508137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273508137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273508137">(Feb 28 2022 at 15:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/edda7e959d0dea66ec60b064f63bf275ad1c41c5/src/ci/github-actions/ci.yml#L681-L682">https://github.com/rust-lang/rust/blob/edda7e959d0dea66ec60b064f63bf275ad1c41c5/src/ci/github-actions/ci.yml#L681-L682</a></p>



<a name="273625806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273625806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273625806">(Mar 01 2022 at 11:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/273508035">said</a>:</p>
<blockquote>
<p>I would not exclude anything at all from local measurements.</p>
</blockquote>
<p>I now measured this including the pretty print change, but got similar results again. In all the tests I performed I ran <code>x.py build</code>, would you expect <code>x.py dist</code> to differ given that the build runs all performed similarly, i.e. would it make sense to re-run the measurements with <code>x.py dist</code>?</p>



<a name="273626692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273626692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273626692">(Mar 01 2022 at 11:33)</a>:</h4>
<p>@lcnr and <span class="user-mention" data-user-id="124288">@oli</span> Have a question about exhaustiveness checks on thir patterns. I looked into the code that does this and I'm not completely sure how you expect valtrees to help with this. The exhaustiveness check algorithm works on <code>Pat</code>, but once that is created the algorithm doesn't use anything that valtrees would benefit with afaict. </p>
<p>We do currently destructure constants in <code>const_to_pat</code> when creating <code>thir::Pat</code>, valtrees would make that easier since we wouldn't need a <code>destructure_const</code> on <code>ConstValue</code> anymore, but if we evaluate to a <code>ty::Const</code> in <code>const_to_pat</code>, we later have to convert the valtree to a <code>ConstValue</code> anyway. So we have the options of either evaluating to <code>ConstValue</code> directly and then destructuring that when creating the <code>thir::Pat</code> or evaluating to a valtree, using that to destructure and then later convert that to a <code>ConstValue</code>, any idea how those options would differ in performance?</p>



<a name="273632906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273632906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273632906">(Mar 01 2022 at 12:33)</a>:</h4>
<blockquote>
<p>but if we evaluate to a ty::Const in const_to_pat, we later have to convert the valtree to a ConstValue anyway.</p>
</blockquote>
<p>don't understand what you mean here <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> when do we have to go back to <code>ConstValue</code> here? in the opaque const fallback on structural match violations?</p>



<a name="273633012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273633012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273633012">(Mar 01 2022 at 12:34)</a>:</h4>
<p>tbh, keep the <code>ConstantKind</code> in your pr and don't change the pattern stuff back to <code>ty::Const</code></p>



<a name="273633043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273633043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273633043">(Mar 01 2022 at 12:34)</a>:</h4>
<p>going to actually take the time today to just mostly remove <code>const_to_pat</code> for a crater run</p>



<a name="273633049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273633049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273633049">(Mar 01 2022 at 12:34)</a>:</h4>
<p>and then try and go from there</p>



<a name="273644254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273644254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273644254">(Mar 01 2022 at 13:59)</a>:</h4>
<p>If valtree conversion succeeds, then we will at most end up with a <code>ty::Const</code> for an integer, no complex valtrees will be in the end result, as all of them will have bee converted to patterns</p>



<a name="273654329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273654329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273654329">(Mar 01 2022 at 15:06)</a>:</h4>
<p>Ah I see, I misunderstood how we lower patterns and didn't realize that we lower all constants in patterns to just their basic constituents and won't ever have complex valtrees there. I thought that we would have to create a <code>ConstValue</code> for a constant pattern at some point for code generation. We should definitely use <code>ty::Const</code> then for patterns.</p>



<a name="273875180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273875180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273875180">(Mar 02 2022 at 20:54)</a>:</h4>
<blockquote>
<p>we lower all constants in patterns to just their basic constituents</p>
</blockquote>
<p>isnt that logic that is supposed to go away in favor of valtrees?</p>



<a name="273875254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273875254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273875254">(Mar 02 2022 at 20:55)</a>:</h4>
<p>currently patterns have to "destructure" constants, but that is rather hacky and if it would become part of valtree construction, patterns could work with that nicer representation directly</p>



<a name="273892223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273892223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273892223">(Mar 02 2022 at 23:05)</a>:</h4>
<p>You can't SwitchInt on a non-scalar, so those have to be destructured when building MIR for a pattern match.</p>



<a name="273913211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273913211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273913211">(Mar 03 2022 at 02:38)</a>:</h4>
<p>yes, sure</p>



<a name="273913254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273913254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273913254">(Mar 03 2022 at 02:39)</a>:</h4>
<p>but you dont have to destructure constants. you can just turn them into valtrees, and then "destructring" those is trivial since they are already a tree.</p>



<a name="273947827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273947827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273947827">(Mar 03 2022 at 09:49)</a>:</h4>
<p>Well you're still destructuring them, but yea, now it's a trivial op.</p>



<a name="273948099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273948099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273948099">(Mar 03 2022 at 09:51)</a>:</h4>
<p><code>const_to_pat</code> will basically stay the same, just without destructuring mir constants.</p>



<a name="273980889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273980889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273980889">(Mar 03 2022 at 14:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/273625806">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/273508035">said</a>:</p>
<blockquote>
<p>I would not exclude anything at all from local measurements.</p>
</blockquote>
<p>I now measured this including the pretty print change, but got similar results again. In all the tests I performed I ran <code>x.py build</code>, would you expect <code>x.py dist</code> to differ given that the build runs all performed similarly, i.e. would it make sense to re-run the measurements with <code>x.py dist</code>?</p>
</blockquote>
<p>I would try to match CI environment as closely as possible, ideally msvc etc --- if it helps, you can likely enable that builder on a PR and push changes and wait for it to complete to estimate how slow things are.</p>



<a name="273993551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273993551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273993551">(Mar 03 2022 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/273980889">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/273625806">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/273508035">said</a>:</p>
<blockquote>
<p>I would not exclude anything at all from local measurements.</p>
</blockquote>
<p>I now measured this including the pretty print change, but got similar results again. In all the tests I performed I ran <code>x.py build</code>, would you expect <code>x.py dist</code> to differ given that the build runs all performed similarly, i.e. would it make sense to re-run the measurements with <code>x.py dist</code>?</p>
</blockquote>
<p>if it helps, you can likely enable that builder on a PR and push changes and wait for it to complete to estimate how slow things are.</p>
</blockquote>
<p>Yeah that would help. Can you tell me how to enable that builder on a PR?</p>



<a name="273995446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/273995446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#273995446">(Mar 03 2022 at 16:10)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/94381/files#diff-b803fcb7f17ed9235f1e5cb1fcd2f5d3b2838429d4368ae4c57ce4436577f03f">https://github.com/rust-lang/rust/pull/94381/files#diff-b803fcb7f17ed9235f1e5cb1fcd2f5d3b2838429d4368ae4c57ce4436577f03f</a> is an example of enabling a different builder.</p>
<p>In broad strokes, you do this:</p>
<ul>
<li>Edit src/ci/github-actions.yml to copy the builder you're looking for (dist-x86_64-msvc-alt) to the pr: section</li>
<li>Run x.py run src/tools/expand-yaml-anchors</li>
<li>Push to your PR branch</li>
</ul>



<a name="274170888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274170888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274170888">(Mar 04 2022 at 18:36)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I got similar results on CI as to what I got locally when running these experiments:</p>
<p><a href="https://github.com/rust-lang/rust/pull/94604">https://github.com/rust-lang/rust/pull/94604</a></p>



<a name="274170950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274170950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274170950">(Mar 04 2022 at 18:36)</a>:</h4>
<p>fairly certain that I chose the correct builder</p>



<a name="274171220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274171220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274171220">(Mar 04 2022 at 18:38)</a>:</h4>
<p>hm, well, it might have been "fixed" since then by unrelated code. Can you add the equivalent of the try commit in <a href="https://github.com/rust-lang/rust/pull/94195/commits/0b541329417ebceab985df5c167e0edcfe33b35b">https://github.com/rust-lang/rust/pull/94195/commits/0b541329417ebceab985df5c167e0edcfe33b35b</a>, so that we can check against that?</p>



<a name="274171897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274171897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274171897">(Mar 04 2022 at 18:43)</a>:</h4>
<p>(I'll be happy to kick off a try build with that done)</p>



<a name="274173157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274173157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274173157">(Mar 04 2022 at 18:53)</a>:</h4>
<p>pushed the commit</p>



<a name="274188927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274188927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274188927">(Mar 04 2022 at 21:12)</a>:</h4>
<p>The regression seems to be gone</p>
<p><a href="https://github.com/rust-lang-ci/rust/runs/5426883489?check_suite_focus=true">https://github.com/rust-lang-ci/rust/runs/5426883489?check_suite_focus=true</a></p>



<a name="274189036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274189036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274189036">(Mar 04 2022 at 21:13)</a>:</h4>
<p>OK</p>



<a name="274189139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274189139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274189139">(Mar 04 2022 at 21:14)</a>:</h4>
<p>Let's confirm that on a clean PR that we could otherwise land (so one commit for the original regressing PR, plus one more commit with the try CI changes), rerun try one final time, and then I'm happy to r+ that</p>



<a name="274407887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274407887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274407887">(Mar 07 2022 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Can you start another try build <a href="https://github.com/rust-lang/rust/pull/94702">here</a>, please?</p>



<a name="274543600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274543600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274543600">(Mar 08 2022 at 13:56)</a>:</h4>
<p>can do</p>



<a name="274543663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274543663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274543663">(Mar 08 2022 at 13:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274407887">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> Can you start another try build <a href="https://github.com/rust-lang/rust/pull/94702">here</a>, please?</p>
</blockquote>
<p>do you still need one?</p>



<a name="274544257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274544257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274544257">(Mar 08 2022 at 14:01)</a>:</h4>
<p>no, it was already started</p>



<a name="274553152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274553152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274553152">(Mar 08 2022 at 15:06)</a>:</h4>
<p>What are opaque constants exactly?  In the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Bar</span><span class="p">(</span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="nc">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bar</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">match</span><span class="w"> </span><span class="n">FOO</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FOO</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"foo"</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Bar</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"not foo"</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when <code>FOO</code> occurs inside a pattern arm (match as well?), is <code>FOO</code> an opaque constant? Are there any other scenarios in which we talk of opaque constants?</p>



<a name="274554194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274554194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274554194">(Mar 08 2022 at 15:13)</a>:</h4>
<p>or is <code>FOO</code> just in general an opaque constant whenever we have a const definition like <code>const FOO: Bar = Bar(1)</code>?</p>



<a name="274555563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274555563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274555563">(Mar 08 2022 at 15:23)</a>:</h4>
<p>opaque means, that if you had a <code>Bar(1)</code> arm, you would not get an "unreachable arm" lint for it, because nothing is assumed about the constant</p>



<a name="274555607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274555607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274555607">(Mar 08 2022 at 15:24)</a>:</h4>
<p>the constant essentially does not participate in exhaustiveness if it is opaque</p>



<a name="274557291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274557291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274557291">(Mar 08 2022 at 15:36)</a>:</h4>
<p>Ok thanks, I think I understand what you mean, but just to ensure that I really do... opaque constants are only those occurring in pattern arms that were previously defined with the const keyword (const params cannot occur in patterns right?)?</p>



<a name="274558594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274558594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274558594">(Mar 08 2022 at 15:45)</a>:</h4>
<p>opaque constants currently only occur when encountering a non structural match constant behind a reference while destructuring a named constant</p>



<a name="274559131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274559131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274559131">(Mar 08 2022 at 15:49)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Bar</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">PartialEq</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Bar</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="nb">Eq</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Bar</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[derive(PartialEq, Eq)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Foo</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="p">(</span><span class="n">Bar</span><span class="p">,));</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">WITH_OPAQUE_BAR</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">Bar</span><span class="p">,));</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">Bar</span><span class="p">,))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WITH_OPAQUE_BAR</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"apparently not opaque!"</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"`Bar` is opaque and uses `PartialEq`"</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274559169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274559169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274559169">(Mar 08 2022 at 15:49)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> i forgot why the tuple was needed here again <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="274559690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274559690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274559690">(Mar 08 2022 at 15:52)</a>:</h4>
<p><a href="https://hackmd.io/@rust-const-generics/r19096qlt">https://hackmd.io/@rust-const-generics/r19096qlt</a> this is probably helpful</p>



<a name="274559733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274559733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274559733">(Mar 08 2022 at 15:53)</a>:</h4>
<p>we also use <code>opaque</code> for raw pointers</p>



<a name="274565616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274565616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274565616">(Mar 08 2022 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274559169">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="124288">oli</span> i forgot why the tuple was needed here again <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>because you need a double indirection to actually hit one of the edge cases in the checks</p>



<a name="274704114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274704114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274704114">(Mar 09 2022 at 15:31)</a>:</h4>
<p>Since we want to use <code>ty::Const</code> in <code>Node::Leaf</code>, we have a problem when encountering <code>ConstantKind::Val</code> values when constructing <code>AbstractConst</code>s. What shall we do with these? We can't error here. What kind of <code>ConstValue</code>s can we expect here? If this are scalars we could just trivially convert them to valtrees here, but could we encounter more complicated <code>ConstValue</code>s?</p>
<p>In <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_trait_selection/traits/const_evaluatable.rs.html#352"><code>recurse_build</code></a> this is what I currently have. Obviously for now we can just construct another <code>ty::Const</code> from the <code>ConstValue</code>, but what do we do later?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="o">&amp;</span><span class="n">ExprKind</span>::<span class="n">Literal</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">literal</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">literal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">mir</span>::<span class="n">ConstantKind</span>::<span class="n">Ty</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Node</span>::<span class="n">Leaf</span><span class="p">(</span><span class="n">cv</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="n">mir</span>::<span class="n">ConstantKind</span>::<span class="n">Val</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// what to do with these?</span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274706240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706240">(Mar 09 2022 at 15:45)</a>:</h4>
<p>we should try to bould a valtree for the  <code>mir::ConstantKind::Val</code> and error if that fails</p>



<a name="274706245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706245">(Mar 09 2022 at 15:46)</a>:</h4>
<p>why can't you error here? I think we should only ever be encountering <code>mir::ConstantKind::Ty</code></p>



<a name="274706303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706303">(Mar 09 2022 at 15:46)</a>:</h4>
<p>hmm</p>



<a name="274706337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706337">(Mar 09 2022 at 15:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706245">said</a>:</p>
<blockquote>
<p>why can't you error here? I think we should only ever be encountering <code>mir::ConstantKind::Ty</code></p>
</blockquote>
<p>no, <code>foo::&lt;{ N + 3 }&gt;()</code></p>



<a name="274706369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706369">(Mar 09 2022 at 15:46)</a>:</h4>
<p>building a valtree for those is not great unless they are trivial (as mentioned, plain integers)</p>



<a name="274706375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706375">(Mar 09 2022 at 15:46)</a>:</h4>
<p>here the abstract const has a <code>mir::ConstantKind::Val</code> for the <code>3</code></p>



<a name="274706387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706387">(Mar 09 2022 at 15:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706369">said</a>:</p>
<blockquote>
<p>building a valtree for those is not great unless they are trivial (as mentioned, plain integers)</p>
</blockquote>
<p>why?</p>



<a name="274706433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706433">(Mar 09 2022 at 15:47)</a>:</h4>
<p>the body of generic ty constants is part of their type (in some sense)</p>



<a name="274706455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706455">(Mar 09 2022 at 15:47)</a>:</h4>
<p>oh, literals are ok, but shouldn't we try to get rid of the logic for converting mir constants to valtrees?</p>



<a name="274706506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706506">(Mar 09 2022 at 15:47)</a>:</h4>
<p>I mean, how would you even encounter anything but a literal?</p>



<a name="274706514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706514">(Mar 09 2022 at 15:47)</a>:</h4>
<p>aren't mir constants a lot closer to the result of const eval?</p>



<a name="274706617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706617">(Mar 09 2022 at 15:48)</a>:</h4>
<p>sure, but converting them is... not great. We would need to have mir constants in query arguments, and that bit us last time we tried</p>



<a name="274706618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706618">(Mar 09 2022 at 15:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706506">said</a>:</p>
<blockquote>
<p>I mean, how would you even encounter anything but a literal?</p>
</blockquote>
<p>concrete associated constants probably <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> and inline consts if these end up getting supported</p>



<a name="274706643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706643">(Mar 09 2022 at 15:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706617">said</a>:</p>
<blockquote>
<p>sure, but converting them is... not great. We would need to have mir constants in query arguments, and that bit us last time we tried</p>
</blockquote>
<p>why?</p>



<a name="274706671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706671">(Mar 09 2022 at 15:48)</a>:</h4>
<p>sure, but either of these have def ids that we can evaluate to valtree directly</p>



<a name="274706686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706686">(Mar 09 2022 at 15:49)</a>:</h4>
<p>we build the abstract const all at once in a query which uses the <code>DefId</code> of the generic ty const</p>



<a name="274706698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706698">(Mar 09 2022 at 15:49)</a>:</h4>
<p>why not great or why query args?</p>



<a name="274706707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706707">(Mar 09 2022 at 15:49)</a>:</h4>
<p>why query args ^^</p>



<a name="274706738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706738">(Mar 09 2022 at 15:49)</a>:</h4>
<p>right... unevaluated mir constants are fine, we can eval them</p>



<a name="274706757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706757">(Mar 09 2022 at 15:49)</a>:</h4>
<p>gotta go now, should be able to reply again in a few hours <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> looked into this thread right as i had to leave</p>



<a name="274706781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706781">(Mar 09 2022 at 15:49)</a>:</h4>
<p>but from just the types we could encounter evaluated complex mir constants</p>



<a name="274706849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274706849">(Mar 09 2022 at 15:50)</a>:</h4>
<p>I don't think we'll encounter evaluated ones in practice</p>



<a name="274707211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274707211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274707211">(Mar 09 2022 at 15:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706849">said</a>:</p>
<blockquote>
<p>I don't think we'll encounter evaluated ones in practice</p>
</blockquote>
<p>A lot of tests in <code>ui/generic_const_exprs</code> were failing when I errored when encountering <code>ConstantKind::Val</code> there</p>



<a name="274707412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274707412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274707412">(Mar 09 2022 at 15:54)</a>:</h4>
<p>ah nvm think you meant something else</p>



<a name="274708425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274708425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274708425">(Mar 09 2022 at 16:00)</a>:</h4>
<p>The other option is just to keep using <code>mir::ConstantKind</code> in <code>Node::Leaf</code> and implement a <code>from_constant(mir::ConstantKind</code> associated function on <code>AbstractConst</code>. That should work afaict since we can just compare <code>ConstValue</code>s when trying to unify. But <span class="user-mention" data-user-id="216206">@lcnr</span> wasn't fond of using <code>ConstantKind</code> in <code>const_evaluatable</code> since its part of the type system.</p>



<a name="274719270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274719270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274719270">(Mar 09 2022 at 17:09)</a>:</h4>
<blockquote>
<p>But @lcnr wasn't fond of using ConstantKind in const_evaluatable since its part of the type system.</p>
</blockquote>
<p>exactly ^^ removing the current <code>ty::Const::Value</code>from the type system is the whole reason we want val trees</p>



<a name="274719739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274719739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274719739">(Mar 09 2022 at 17:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274706849">said</a>:</p>
<blockquote>
<p>I don't think we'll encounter evaluated ones in practice</p>
</blockquote>
<p>i guess that's an interesting question. If we don't evaluate associated constants and inline constants before building the thir, we always only encounter unevaluated constants - and <code>ConstantKind::Val</code> for literals - when building abstract consts</p>



<a name="274720471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274720471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274720471">(Mar 09 2022 at 17:16)</a>:</h4>
<p>we can actually make the THIR know about this by lowering from THIR to <code>ConstantKind</code> only during mir building</p>



<a name="274720507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274720507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274720507">(Mar 09 2022 at 17:16)</a>:</h4>
<p>then we can re-use the code to convert literals to valtree in const_evaluatable</p>



<a name="274721230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274721230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274721230">(Mar 09 2022 at 17:21)</a>:</h4>
<p>yes, that seems like the desirable solution</p>



<a name="274721404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274721404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274721404">(Mar 09 2022 at 17:22)</a>:</h4>
<p>so i guess <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/thir/enum.ExprKind.html#variant.ConstBlock">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/thir/enum.ExprKind.html#variant.ConstBlock</a> should be </p>
<div class="codehilite"><pre><span></span><code>ConstBlock {
    def_id: DefId,
    substs: SubstsRef&lt;&#39;tcx&gt;,
}
</code></pre></div>
<p>and only get converted to a <code>mir::ConstantKind</code> during mir building</p>



<a name="274721629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274721629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274721629">(Mar 09 2022 at 17:24)</a>:</h4>
<p>and something similar for literal, maybe we keep the literal representation used in the hir? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="274721861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274721861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274721861">(Mar 09 2022 at 17:25)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> are you following us here? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> feel like we're taking quite large logical leaps here</p>
<p>definitely do ask if anything doesn't completely make sense to you here</p>



<a name="274723479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274723479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274723479">(Mar 09 2022 at 17:35)</a>:</h4>
<p>hm not entirely sure, you want to keep treating literals and const blocks as <code>Unevaluted</code> until after thir construction?</p>



<a name="274723675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274723675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274723675">(Mar 09 2022 at 17:36)</a>:</h4>
<p>I think I still have a poor intuition about at what stages we actually have to evaluate things.</p>



<a name="274724613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274724613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274724613">(Mar 09 2022 at 17:43)</a>:</h4>
<p>can go more in depth tomorrow</p>



<a name="274724784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274724784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274724784">(Mar 09 2022 at 17:44)</a>:</h4>
<p>const blocks as <code>Unevaluated</code> (or well, <code>DefId</code> +  generic arguments) when then get converted to either a <code>ty::Const</code>(when building abstratc consts) or a <code>mir::ConstantKind</code> (when building mir)</p>



<a name="274724974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274724974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274724974">(Mar 09 2022 at 17:45)</a>:</h4>
<p>literals probably as <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/hir/type.Lit.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/hir/type.Lit.html</a></p>



<a name="274725044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274725044">(Mar 09 2022 at 17:45)</a>:</h4>
<p>for associated and named constants (which <code>thir::ExprKind</code>are these?) we also want a <code>DefId</code> + generic arguments pair</p>



<a name="274725079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274725079">(Mar 09 2022 at 17:45)</a>:</h4>
<p>so these are similar to const blocks</p>



<a name="274725157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274725157">(Mar 09 2022 at 17:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274723675">said</a>:</p>
<blockquote>
<p>I think I still have a poor intuition about at what stages we actually have to evaluate things.</p>
</blockquote>



<a name="274725358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274725358">(Mar 09 2022 at 17:47)</a>:</h4>
<p>in the type system, i.e. <code>ty::Const</code>, when typechecking the containing item, so before we build the <code>thir</code></p>



<a name="274725643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274725643">(Mar 09 2022 at 17:49)</a>:</h4>
<p>for constant values, e.g. in pattern or expressions, i.e. <code>mir::ConstantKind</code>, some time before codegen. For performance reasons, we should do that early in the mir pipeline, as it's a lot easier to optimize with evaluated constants. This can happen far after typechecking</p>



<a name="274725952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274725952">(Mar 09 2022 at 17:50)</a>:</h4>
<p>if we keep destructuring constants for patterns, then we want to use <code>ty::Const</code> (or much rather, valtrees directly) for these as well. That can still happen after typeck however</p>



<a name="274813529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813529">(Mar 10 2022 at 10:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274725358">said</a>:</p>
<blockquote>
<p>in the type system, i.e. <code>ty::Const</code>, when typechecking the containing item, so before we build the <code>thir</code></p>
</blockquote>
<p>Thanks for the explanation, but I still have some questions about that. Currently trying to work through some examples with debug to observe the execution flow. In this example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">uses_foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">FOO</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>when we typeck <code>FOO</code>,  we don't evaluate the rhs. Why is that? </p>
<p>It's not clear to me what we have to evaluate in general. Or if its easier to list, what don't we have to evaluate for typeck and only for codegen?</p>



<a name="274813679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813679">(Mar 10 2022 at 10:05)</a>:</h4>
<p>the rhs being <code>5 + 4</code> here?</p>



<a name="274813761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813761">(Mar 10 2022 at 10:06)</a>:</h4>
<p>we have to no evaluate that while typechecking <code>FOO</code> because we actually need the results to evaluate it?</p>



<a name="274813790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813790">(Mar 10 2022 at 10:06)</a>:</h4>
<p>typechecking <code>FOO</code> includes checking that <code>5 + 4</code> has the type usize, which infers <code>5</code> and <code>4</code> to have the type <code>usize</code></p>



<a name="274813856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813856">(Mar 10 2022 at 10:07)</a>:</h4>
<p>We have to pretty much evaluate stuff in 2 cases:</p>



<a name="274813870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813870">(Mar 10 2022 at 10:07)</a>:</h4>
<ul>
<li>we need the resulting value for something</li>
</ul>



<a name="274813961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274813961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274813961">(Mar 10 2022 at 10:08)</a>:</h4>
<ul>
<li>side effects e.g. evaluation failures. Consider <code>const _: () = assert!(some_condition);</code> this should cause a compilation failure but only does so when getting evaluated</li>
</ul>



<a name="274814025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814025">(Mar 10 2022 at 10:08)</a>:</h4>
<p>the second point doesn't really matter most of the time, so let's focus on where we need the resulting value</p>



<a name="274814123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814123">(Mar 10 2022 at 10:09)</a>:</h4>
<p>during codegen for constants used in expressions</p>



<a name="274814267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814267">(Mar 10 2022 at 10:11)</a>:</h4>
<p>in patterns for exhaustiveness checking (otherwise we could theoretically keep constants in patterns unevaluated until codegen)</p>



<a name="274814327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814327">(Mar 10 2022 at 10:12)</a>:</h4>
<p>constants used in expressions during optimizations (e.g. constant folding - replacing the expr <code>MY_USIZE_CONST + 3</code> with a single constant at compile time)</p>



<a name="274814526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814526">(Mar 10 2022 at 10:13)</a>:</h4>
<p>for constants used in the type system (i.e. constants used as a generic argument, or an array length/repeat expression length) these have to be evaluated during typeck of their parent.</p>



<a name="274814605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814605">(Mar 10 2022 at 10:14)</a>:</h4>
<p>the reason we have to evaluate constants used in the type system is that we need to be able to unify different constants, consider</p>



<a name="274814631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814631">(Mar 10 2022 at 10:14)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274814724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814724">(Mar 10 2022 at 10:15)</a>:</h4>
<p>during typeck of <code>foo</code>, you can think of this as</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">ANON_CONST_1</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">ANON_CONST_2</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">ANON_CONST_1</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ANON_CONST_2</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274814836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814836">(Mar 10 2022 at 10:16)</a>:</h4>
<p>note that these two constants aren't actually the same, so for this to successfully compile, we have to evaluate both constants and then compare the resulting value</p>



<a name="274814958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274814958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274814958">(Mar 10 2022 at 10:17)</a>:</h4>
<p>Thanks a lot, that was very helpful.</p>



<a name="274815137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274815137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274815137">(Mar 10 2022 at 10:19)</a>:</h4>
<p>What kind of constants correspond to <code>ty::ConstKind::Infer</code>, <code>ty::ConstKind::Placeholder</code> and <code>ty::ConstKind::Bounded</code>?</p>



<a name="274815348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274815348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274815348">(Mar 10 2022 at 10:21)</a>:</h4>
<p><code>ty::ConstKind::Infer</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">bar</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// here the parameter `N` from `bar` starts out as `ConstKind::Infer`</span>
<span class="c1">// which is then unified with the `13` through its return type.</span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bar</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="274815540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274815540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274815540">(Mar 10 2022 at 10:23)</a>:</h4>
<p><code>ty::ConstKind::Bound</code>:<br>
i think that one is pretty much only used for canonical queries to replace inference variables. not really relevant for what you're doing right now <a href="https://rustc-dev-guide.rust-lang.org/traits/canonical-queries.html?highlight=canonical#canonical-queries">https://rustc-dev-guide.rust-lang.org/traits/canonical-queries.html?highlight=canonical#canonical-queries</a></p>



<a name="274815842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274815842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274815842">(Mar 10 2022 at 10:26)</a>:</h4>
<p>also when doing stuff with gats which have a const parameter</p>



<a name="274815918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274815918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274815918">(Mar 10 2022 at 10:27)</a>:</h4>
<p>you can think of bound variables as <code>for&lt;const N: usize&gt; SomeType&lt;N&gt;</code> (which is currently only valid with lifetimes)</p>



<a name="274816870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274816870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274816870">(Mar 10 2022 at 10:35)</a>:</h4>
<p><code>ty::ConstKind::Placeholder</code> is pretty much irrelevant <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> we use placeholders when unifying stuff inside of binders, but there shouldn't be any way to get a higher ranked type with some bound constant</p>



<a name="274816941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274816941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274816941">(Mar 10 2022 at 10:36)</a>:</h4>
<p>currently checking where we actually use that variant <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span> feel like that's pretty close to never</p>



<a name="274818106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274818106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274818106">(Mar 10 2022 at 10:49)</a>:</h4>
<p>yeah, <code>ConstKind::Placeholder</code> is literally unused xd</p>



<a name="274818228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274818228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274818228">(Mar 10 2022 at 10:51)</a>:</h4>
<p>sooo, i guess that means we're waiting for <code>Type: for&lt;const N: usize&gt; Trait&lt;N&gt;</code> bounds</p>



<a name="274818244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274818244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274818244">(Mar 10 2022 at 10:51)</a>:</h4>
<p>at which point we will need that variant <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="274823696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274823696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274823696">(Mar 10 2022 at 11:48)</a>:</h4>
<p>Thanks, really appreciate the help.</p>



<a name="274823944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274823944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274823944">(Mar 10 2022 at 11:51)</a>:</h4>
<p>One question about the thir changes we want to make for <code>AbstractConst</code>: it's not clear to me what we want to do with <code>hir::Lit</code> as a representation for <code>ExprKind::Literal</code> in <code>recurse_build</code>? Can we convert those to <code>ty::Const</code>?</p>



<a name="274824099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824099">(Mar 10 2022 at 11:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274724974">said</a>:</p>
<blockquote>
<p>literals probably as <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/hir/type.Lit.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/hir/type.Lit.html</a></p>
</blockquote>
<p>referring to this</p>



<a name="274824232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824232">(Mar 10 2022 at 11:54)</a>:</h4>
<p>yeah, convert to <code>ty::Const</code> there</p>



<a name="274824243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824243">(Mar 10 2022 at 11:54)</a>:</h4>
<p>Also afaict (from running some examples) we currently create <code>ExprKind::Literal</code> (with <code>ConstKind::Unevaluated</code>) for associated consts and named constants during thir construction.</p>



<a name="274824263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824263">(Mar 10 2022 at 11:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824232">said</a>:</p>
<blockquote>
<p>yeah, convert to <code>ty::Const</code> there</p>
</blockquote>
<p>we want to be able to unify <code>N + SOME_CONST_EVALUATING_TO_3</code> with <code>N + 3</code></p>



<a name="274824296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824296">(Mar 10 2022 at 11:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824243">said</a>:</p>
<blockquote>
<p>Also afaict (from running some examples) we currently create <code>ExprKind::Literal</code> (with <code>ConstKind::Unevaluated</code>) for associated consts and named constants during thir construction.</p>
</blockquote>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> would need a new <code>thir::ExprKind</code> variant for these in that case</p>



<a name="274824323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824323">(Mar 10 2022 at 11:55)</a>:</h4>
<p>ok. any suggestions for a name?</p>



<a name="274824337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824337">(Mar 10 2022 at 11:56)</a>:</h4>
<p><code>ExprKind::NamedConst</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="274824484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824484">(Mar 10 2022 at 11:57)</a>:</h4>
<p>yeah thats not bad. Can use that for now.</p>



<a name="274824933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274824933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274824933">(Mar 10 2022 at 12:01)</a>:</h4>
<p>is that variant also used for function items?</p>



<a name="274825105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274825105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274825105">(Mar 10 2022 at 12:03)</a>:</h4>
<p>idk, i guess <code>NamedConst</code> would still be fine then <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> needs a comment anyways</p>



<a name="274825319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274825319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274825319">(Mar 10 2022 at 12:05)</a>:</h4>
<p>What are these lowered to in thir construction now?</p>



<a name="274825329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274825329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274825329">(Mar 10 2022 at 12:05)</a>:</h4>
<p>do you have an example maybe?</p>



<a name="274825460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274825460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274825460">(Mar 10 2022 at 12:06)</a>:</h4>
<p><code>const X: usize = std::mem::size_of::&lt;String&gt;();</code></p>



<a name="274825489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274825489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274825489">(Mar 10 2022 at 12:06)</a>:</h4>
<p>should get lowered to a constant for <code>std::mem::size_of::&lt;String&gt;</code> and then a call expression</p>



<a name="274826099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274826099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274826099">(Mar 10 2022 at 12:13)</a>:</h4>
<div class="codehilite"><pre><span></span><code>│ │ ├─0ms DEBUG rustc_mir_build::thir::cx::expr expr=Expr { ty: fn() -&gt; usize {std::mem::size_of::&lt;std::string::String&gt;}, temp_lifetime: Some(Node(9)), span: const-fn-test.rs:1:18: 1:45 (#0), kind: Literal { literal: Const { ty: fn() -&gt; usize {std::mem::size_of::&lt;std::string::String&gt;}, val: Value(Scalar(&lt;ZST&gt;)) }, user_ty: None, const_id: None } }
│ ├─┘
├─┘
├─18ms DEBUG rustc_mir_build::thir::cx::expr expr=Expr { ty: usize, temp_lifetime: Some(Node(9)), span: const-fn-test.rs:1:18: 1:47 (#0), kind: Call { ty: fn() -&gt; usize {std::mem::size_of::&lt;std::string::String&gt;}, fun: e1, args: [], from_hir_call: true, fn_span: const-fn-test.rs:1:18: 1:47 (#0) } }
</code></pre></div>



<a name="274826510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274826510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274826510">(Mar 10 2022 at 12:18)</a>:</h4>
<p>i think you can keep a <code>DefId</code> <code>substs</code> pair for that as well <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="274826587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274826587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274826587">(Mar 10 2022 at 12:19)</a>:</h4>
<p>so only convert that to a ZST <code>ty::Const</code> or <code>mir::ConstantKind</code> lazily, at least that's what I would try</p>



<a name="274847383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274847383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274847383">(Mar 10 2022 at 15:07)</a>:</h4>
<p>There are a couple of places where we create literals that don't correspond to anything in the hir, such as <a href="https://github.com/rust-lang/rust/blob/ba14a836c7038da21f5e102aacc7e6d5964f79a6/compiler/rustc_mir_build/src/thir/cx/expr.rs#L701-L705">here</a> or with <a href="https://github.com/rust-lang/rust/blob/ba14a836c7038da21f5e102aacc7e6d5964f79a6/compiler/rustc_mir_build/src/thir/cx/expr.rs#L553-L557">ZSTs</a>. I would be inclined to introduce another variant of <code>ExprKind</code> for those, taking a <code>ty::Const</code>, but for which we know that they correspond to trivial valtrees which we can easily convert to mir::Constant, but is there maybe a better solution?</p>



<a name="274848356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274848356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274848356">(Mar 10 2022 at 15:14)</a>:</h4>
<p>the problem is that we don't know ahead of time whether it's going to be <code>ty::Const</code> or <code>mir::Constant</code>, so either choice is wrong</p>



<a name="274848400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274848400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274848400">(Mar 10 2022 at 15:14)</a>:</h4>
<p>you could just use a <code>ScalarInt</code> or sth simple like that for your new variant though</p>



<a name="274962827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274962827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274962827">(Mar 11 2022 at 11:30)</a>:</h4>
<p>When are we supposed to be able to evaluate constants? Currently in mir building I'm calling <code>const_eval_resolve</code> for an <code>ExprKind::NamedConst</code> (an associated const in this case) and I get an ICE when compiling core, because one value isn't normalizable. Is this to be expected that not everything is normalizable at that stage or is this an indication that something is wrong with the implementation (besides calling <code>const_eval_resolve</code> here^^)?</p>



<a name="274963276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963276">(Mar 11 2022 at 11:35)</a>:</h4>
<p>you cant evaluate a generic const like say <code>&lt;T as Trait&gt;::ASSOC</code>if the const is <code>mem::size_of::&lt;T&gt;()</code></p>



<a name="274963397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963397">(Mar 11 2022 at 11:37)</a>:</h4>
<p>Ok sorry, I guess I meant whether everything is normalizable at that stage (which is necessary for the evaluation of the constant here).</p>



<a name="274963556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963556">(Mar 11 2022 at 11:39)</a>:</h4>
<p>no, there will be constants that cant be evaluated in the mir</p>



<a name="274963600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963600">(Mar 11 2022 at 11:39)</a>:</h4>
<p>ok thanks. Do you know whether we have some const evaluation function that internally uses <code>try_normalize_erasing_regions</code>?</p>



<a name="274963742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963742">(Mar 11 2022 at 11:41)</a>:</h4>
<p>no idea <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="274963860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963860">(Mar 11 2022 at 11:42)</a>:</h4>
<p>ok no problem, I'll start looking.</p>



<a name="274963870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963870">(Mar 11 2022 at 11:42)</a>:</h4>
<p>thanks for the help</p>



<a name="274963933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274963933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274963933">(Mar 11 2022 at 11:43)</a>:</h4>
<p>what place are you evaluating the generic const at?</p>



<a name="274964007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964007">(Mar 11 2022 at 11:44)</a>:</h4>
<p>In <code>as_constant</code></p>



<a name="274964028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964028">(Mar 11 2022 at 11:44)</a>:</h4>
<p>that function is in <code>mir_build/build</code></p>



<a name="274964411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964411">(Mar 11 2022 at 11:49)</a>:</h4>
<p>I think the best solution is to just not try to evaluate there at all and keep this as <code>Unevaluated</code></p>



<a name="274964545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964545">(Mar 11 2022 at 11:50)</a>:</h4>
<p>This is similar to the problem we worked on before with the 'postpone evaluation' PR, where we encountered ICEs before when calling <code>codegen_fulfill_obligation</code>, which assumes that everything is normalizable</p>



<a name="274964575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964575">(Mar 11 2022 at 11:50)</a>:</h4>
<p>that one was subtly different I think in that we were trying to evaluate a constant that wouldnt typeck <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="274964600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964600">(Mar 11 2022 at 11:51)</a>:</h4>
<p>hm I think the problem was that it wasnt normalizable, but not completely certain</p>



<a name="274964715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274964715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274964715">(Mar 11 2022 at 11:53)</a>:</h4>
<p>ah no it was that certain values contained inference variables</p>



<a name="274987475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274987475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274987475">(Mar 11 2022 at 15:08)</a>:</h4>
<p>do you have a short test case here which breaks?</p>



<a name="274991887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274991887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274991887">(Mar 11 2022 at 15:44)</a>:</h4>
<p>I settled for not evaluating in <code>as_constant</code> and that fixed the ICE when compiling core. But I'm currently having problems with another ICE in codegen. This is what I get in codegen for some ScalarInt whose size is wrong for some reason:</p>
<div class="codehilite"><pre><span></span><code>from_const(val: Scalar(0x0000000000000000), ty: u32): layout TyAndLayout { ty: u32, layout: Layout { fields: Primitive, variants: Single { index: 0 }, abi: Scalar(Scalar { value: Int(I32, false), valid_range: 0..=4294967295 }), largest_niche: None, align: AbiAndPrefAlign { abi: Align { pow2: 2 }, pref: Align { pow2: 2 } }, size: Size { raw: 4 } } }
scalar_to_backend(cv: 0x0000000000000000, layout: Scalar { value: Int(I32, false), valid_range: 0..=4294967295 }, llty: i32, layout.value.size: Size { raw: 4 })
</code></pre></div>
<p>This hits the bug call in <a href="https://github.com/rust-lang/rust/blob/f58d51b3c00b1e30acd75aead202eb2248bb33f9/compiler/rustc_middle/src/ty/consts/int.rs#L219-L223"><code>assert_bits</code></a>. It's not clear to me where this originates. Currently I create <code>ScalarInt</code>s for the new <code>ExprKind::ScalarLiteral</code> variant for the offset (which was previously done <a href="https://github.com/rust-lang/rust/blob/f58d51b3c00b1e30acd75aead202eb2248bb33f9/compiler/rustc_mir_build/src/thir/cx/expr.rs#L694-L705">here</a>) like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="n">did</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">var_ty</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">param_env_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">param_env</span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">var_ty</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">tcx</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">layout_of</span><span class="p">(</span><span class="n">param_env_ty</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"could not compute layout for {:?}: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">param_env_ty</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">})</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScalarInt</span>::<span class="n">try_from_uint</span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExprKind</span>::<span class="n">ScalarLiteral</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lit</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span>: <span class="nb">None</span> <span class="p">};</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">thir</span><span class="p">.</span><span class="n">exprs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Expr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">temp_lifetime</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">ty</span>: <span class="nc">expr_ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">span</span>: <span class="nc">expr</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">kind</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>Otherwise I only create ZST ScalarInts like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ExprKind</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">zero_sized_literal</span><span class="p">(</span><span class="n">user_ty</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Canonical</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">UserType</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ExprKind</span>::<span class="n">ScalarLiteral</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lit</span>: <span class="nc">ty</span>::<span class="n">ScalarInt</span>::<span class="n">ZST</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That might be the cause for this ICE. If this isn't the cause I'm not really sure where this could otherwise originate, but could open a WIP PR for you to look at.</p>



<a name="274992173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274992173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274992173">(Mar 11 2022 at 15:47)</a>:</h4>
<p>In <code>as_constant</code> I create <code>ConstValue</code>s for <code>ScalarLiteral</code> like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="n">ExprKind</span>::<span class="n">ScalarLiteral</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lit</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_ty</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">user_ty</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">this</span><span class="p">.</span><span class="n">canonical_user_type_annotations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">CanonicalUserTypeAnnotation</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">user_ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">inferred_ty</span>: <span class="nc">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">})</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">literal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantKind</span>::<span class="n">Val</span><span class="p">(</span><span class="n">ConstValue</span>::<span class="n">Scalar</span><span class="p">(</span><span class="n">Scalar</span>::<span class="n">Int</span><span class="p">(</span><span class="n">lit</span><span class="p">)),</span><span class="w"> </span><span class="n">ty</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="n">Constant</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span>: <span class="nc">user_ty</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274992271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274992271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274992271">(Mar 11 2022 at 15:48)</a>:</h4>
<p>where <code>ty</code> is the type of the expression.</p>



<a name="274992681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274992681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274992681">(Mar 11 2022 at 15:52)</a>:</h4>
<p>I create zero sized literals in the following places:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span> <span class="nf">method_callee</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">expr</span>: <span class="kp">&amp;</span><span class="nc">hir</span>::<span class="n">Expr</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">span</span>: <span class="nc">Span</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">overloaded_callee</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="p">(</span><span class="n">DefId</span><span class="p">,</span><span class="w"> </span><span class="n">SubstsRef</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Expr</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">temp_lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">region_scope_tree</span><span class="p">.</span><span class="n">temporary_scope</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">.</span><span class="n">local_id</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="n">substs</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">overloaded_callee</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">((</span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="n">substs</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="n">substs</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">typeck_results</span><span class="p">().</span><span class="n">type_dependent_def</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">).</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">span_bug</span><span class="o">!</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="s">"no type-dependent def for method callee"</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">user_substs_applied_to_res</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">,</span><span class="w"> </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">"method_callee: user_ty={:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">typeck_results</span><span class="p">().</span><span class="n">node_substs</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">),</span><span class="w"> </span><span class="n">user_ty</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">().</span><span class="n">mk_fn_def</span><span class="p">(</span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="n">substs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Expr</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">temp_lifetime</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">ExprKind</span>::<span class="n">zero_sized_literal</span><span class="p">(</span><span class="n">user_ty</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span> <span class="nf">convert_path_expr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">hir</span>::<span class="n">Expr</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span>: <span class="nc">Res</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ExprKind</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">substs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">typeck_results</span><span class="p">().</span><span class="n">node_substs</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// A regular function, constructor function or a constant.</span>
<span class="w">            </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">DefKind</span>::<span class="nb">Fn</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">DefKind</span>::<span class="n">AssocFn</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">DefKind</span>::<span class="n">Ctor</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">CtorKind</span>::<span class="nb">Fn</span><span class="p">),</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Res</span>::<span class="n">SelfCtor</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ExprKind</span>::<span class="n">zero_sized_literal</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                            </span><span class="n">hir</span>::<span class="n">InlineAsmOperand</span>::<span class="n">Sym</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">ref</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">hir</span>::<span class="n">ExprKind</span>::<span class="n">Path</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">qpath</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                    </span><span class="n">span_bug</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">                                        </span><span class="n">expr</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="s">"asm `sym` operand should be a path, found {:?}"</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">expr</span><span class="p">.</span><span class="n">kind</span><span class="w"></span>
<span class="w">                                    </span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="p">};</span><span class="w"></span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">temp_lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                    </span><span class="bp">self</span><span class="p">.</span><span class="n">region_scope_tree</span><span class="p">.</span><span class="n">temporary_scope</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">.</span><span class="n">local_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">typeck_results</span><span class="p">().</span><span class="n">qpath_res</span><span class="p">(</span><span class="n">qpath</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span><span class="p">;</span><span class="w"></span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">DefKind</span>::<span class="nb">Fn</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">DefKind</span>::<span class="n">AssocFn</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                        </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">typeck_results</span><span class="p">().</span><span class="n">node_type</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                                        </span><span class="kd">let</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                            </span><span class="bp">self</span><span class="p">.</span><span class="n">user_substs_applied_to_res</span><span class="p">(</span><span class="n">expr</span><span class="p">.</span><span class="n">hir_id</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">                                        </span><span class="n">InlineAsmOperand</span>::<span class="n">SymFn</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                            </span><span class="n">expr</span>: <span class="nc">self</span><span class="p">.</span><span class="n">thir</span><span class="p">.</span><span class="n">exprs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Expr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                                </span><span class="n">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="n">temp_lifetime</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="n">span</span>: <span class="nc">expr</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="n">kind</span>: <span class="nc">ExprKind</span>::<span class="n">zero_sized_literal</span><span class="p">(</span><span class="n">user_ty</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="p">}),</span><span class="w"></span>
<span class="w">                                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                                    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                                    </span><span class="n">Res</span>::<span class="n">Def</span><span class="p">(</span><span class="n">DefKind</span>::<span class="n">Static</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                        </span><span class="n">InlineAsmOperand</span>::<span class="n">SymStatic</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def_id</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">                                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                                    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                        </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">span_err</span><span class="p">(</span><span class="w"></span>
<span class="w">                                            </span><span class="n">expr</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="s">"asm `sym` operand must point to a fn or static"</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="p">);</span><span class="w"></span>

<span class="w">                                        </span><span class="c1">// Not a real fn, but we're not reaching codegen anyways...</span>
<span class="w">                                        </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">ty_error</span><span class="p">();</span><span class="w"></span>
<span class="w">                                        </span><span class="n">InlineAsmOperand</span>::<span class="n">SymFn</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                            </span><span class="n">expr</span>: <span class="nc">self</span><span class="p">.</span><span class="n">thir</span><span class="p">.</span><span class="n">exprs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Expr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                                </span><span class="n">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="n">temp_lifetime</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="n">span</span>: <span class="nc">expr</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="n">kind</span>: <span class="nc">ExprKind</span>::<span class="n">zero_sized_literal</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="p">}),</span><span class="w"></span>
<span class="w">                                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                                    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>These are all in <code>make_mirror_unadjusted</code>.</p>



<a name="274996754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274996754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274996754">(Mar 11 2022 at 16:20)</a>:</h4>
<p>What's the specific ICE message that you are getting? (The sizes may give hints as to what is wrong)</p>



<a name="274999707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/274999707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#274999707">(Mar 11 2022 at 16:45)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: /Users/bn/Documents/rust-local-fork/thir-abstract-const/compiler/rustc_middle/src/ty/consts/int.rs:221:13: expected int of size 4, but got size 8
</code></pre></div>
<p><a href="https://github.com/rust-lang/rust/blob/f58d51b3c00b1e30acd75aead202eb2248bb33f9/compiler/rustc_codegen_llvm/src/common.rs#L227">This</a> is the call that triggers the ICE.</p>
<p><code>layout</code> here is <code>layout: Scalar { value: Int(I32, true), valid_range: 0..=4294967295 }</code>, <code>layout.value.size: Size { raw: 4 } </code> and the scalar int here is <code>int: 0x0000000000000000, int.size: Size { raw: 8 }</code>.</p>
<p><code>scalar_to_backend</code> is called from <a href="https://github.com/rust-lang/rust/blob/af8604faddc44b27a59d1a719ff6ceca8bc145eb/compiler/rustc_codegen_ssa/src/mir/operand.rs#L68-L86"><code>from_const</code></a> , which takes the following arguments in the call that triggers the ICE:</p>
<div class="codehilite"><pre><span></span><code>from_const(val: Scalar(0x0000000000000000), ty: u32): layout TyAndLayout { ty: u32, layout: Layout { fields: Primitive, variants: Single { index: 0 }, abi: Scalar(Scalar { value: Int(I32, false), valid_range: 0..=4294967295 }), largest_niche: None, align: AbiAndPrefAlign { abi: Align { pow2: 2 }, pref: Align { pow2: 2 } }, size: Size { raw: 4 } } }
</code></pre></div>



<a name="275006845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275006845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275006845">(Mar 11 2022 at 17:36)</a>:</h4>
<p>where is the failing <code>from_const</code> call happening? It looks like the scalar being given is definitely of size 8, where does that size come from?</p>



<a name="275025546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275025546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275025546">(Mar 11 2022 at 19:53)</a>:</h4>
<p>This is during codegen for this statement: <code>statement.kind: Assign((_5, const 0_u64 as u32 (Misc)))</code> so the mir constant we created during mir building is <code>const 0_u64</code> with type u32. Must somehow assign the wrong type to the constant, but  I always use the type of the passed expression in <code>as_constant</code>?!</p>



<a name="275028998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275028998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275028998">(Mar 11 2022 at 20:23)</a>:</h4>
<p>This code must be wrong, I create the wrong <code>size</code> for the ScalarInts:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="n">did</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">var_ty</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">param_env_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">param_env</span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">var_ty</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">tcx</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">layout_of</span><span class="p">(</span><span class="n">param_env_ty</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"could not compute layout for {:?}: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">param_env_ty</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">})</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScalarInt</span>::<span class="n">try_from_uint</span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExprKind</span>::<span class="n">ScalarLiteral</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lit</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span>: <span class="nb">None</span> <span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>since if I use the following assertion in <code>as_constant</code> (where <code>ty</code> is the type of  the <code>thir::Expr</code>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="n">ExprKind</span>::<span class="n">ScalarLiteral</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lit</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_ty</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">user_ty</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">this</span><span class="p">.</span><span class="n">canonical_user_type_annotations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">CanonicalUserTypeAnnotation</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">user_ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">inferred_ty</span>: <span class="nc">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">})</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">layout_of</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">param_env</span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">ty</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">lit</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">layout</span><span class="p">.</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this triggers:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;assertion failed: `(left == right)`
  left: `Size { raw: 8 }`,
 right: `Size { raw: 4 }`&#39;, compiler/rustc_mir_build/src/build/expr/as_constant.rs:62:21
</code></pre></div>
<p>How can I get the correct size for the ScalarInt here?</p>



<a name="275039297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275039297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275039297">(Mar 11 2022 at 21:58)</a>:</h4>
<p>I think the <code>var_ty</code> is the wrong type to use here? What did the logic look like before?</p>



<a name="275039299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275039299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275039299">(Mar 11 2022 at 21:58)</a>:</h4>
<p>I'm slightly confused about the variable naming tho. What is <code>offset</code>? Are you sure that is the problematic <code>ExprKind::ScalarLiteral</code> creation site?</p>



<a name="275039300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275039300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275039300">(Mar 11 2022 at 21:58)</a>:</h4>
<p>I think the <code>var_ty</code> is the wrong type to use here? What did the logic look like before?</p>



<a name="275086483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275086483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275086483">(Mar 12 2022 at 09:06)</a>:</h4>
<p>It <a href="https://github.com/rust-lang/rust/blob/2c6a29af35a81e20f8af4c32bf1b55c59b89eccd/compiler/rustc_mir_build/src/thir/cx/expr.rs#L694-L706">also used <code>var_ty</code></a>, it just called <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/ty/consts.rs.html#207"><code>ty::Const::from_bits</code></a>, which internally creates the <code>ScalarInt</code> in the same way, so this is weird ^^</p>



<a name="275086746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275086746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275086746">(Mar 12 2022 at 09:13)</a>:</h4>
<p>OK that is weird</p>



<a name="275086785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275086785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275086785">(Mar 12 2022 at 09:14)</a>:</h4>
<p>Can you push your diff somewhere?</p>



<a name="275087041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275087041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275087041">(Mar 12 2022 at 09:22)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/94876">https://github.com/rust-lang/rust/pull/94876</a></p>



<a name="275087814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275087814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275087814">(Mar 12 2022 at 09:44)</a>:</h4>
<p>Left some comments</p>



<a name="275087824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275087824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275087824">(Mar 12 2022 at 09:45)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="124288">@oli</span> , that was the problem</p>



<a name="275092110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275092110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275092110">(Mar 12 2022 at 11:34)</a>:</h4>
<p>In our current design we need to resolve/evaluate in the construction of the <code>AbstractConst</code>, this requires us to pass a <code>ParamEnv</code> to the queries that do that (<code>thir_abstract_const</code> and <code>thir_abstract_const_of_const_arg</code>). We would presumably need to pass in a <code>ParamEnvAnd</code> as the key for that query (using <code>DefId</code> for the <code>value</code>). <code>DefId</code> isn't <code>TypeFoldable</code>, which is required for <code>ParamEnvAnd</code>. Since this hasn't been implemented for <code>DefId</code> before, I wonder whether this is the correct approach or whether this might lead to problems?</p>



<a name="275092261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275092261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275092261">(Mar 12 2022 at 11:38)</a>:</h4>
<p>Alternatively I guess we can just use a Tuple for the query key, but wondering why this wasn't done on the other const related queries.</p>



<a name="275092354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275092354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275092354">(Mar 12 2022 at 11:41)</a>:</h4>
<p>ok nvm looks like using the tuple is the correct approach, just have to implement <code>Key</code> for <code>(DefId, ParamEnv)</code>.</p>



<a name="275199291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275199291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275199291">(Mar 14 2022 at 06:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275092110">said</a>:</p>
<blockquote>
<p>In our current design we need to resolve/evaluate in the construction of the <code>AbstractConst</code>, this requires us to pass a <code>ParamEnv</code> to the queries that do that (<code>thir_abstract_const</code> and <code>thir_abstract_const_of_const_arg</code>). We would presumably need to pass in a <code>ParamEnvAnd</code> as the key for that query (using <code>DefId</code> for the <code>value</code>). <code>DefId</code> isn't <code>TypeFoldable</code>, which is required for <code>ParamEnvAnd</code>. Since this hasn't been implemented for <code>DefId</code> before, I wonder whether this is the correct approach or whether this might lead to problems?</p>
</blockquote>
<p>i don't think that is true, the correct param env inside of these queries is the param env of the anon const</p>



<a name="275199380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275199380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275199380">(Mar 14 2022 at 06:54)</a>:</h4>
<p>so the key should stay as <code>DefId</code> for  <code>thir_abstract_const</code>  and you can use <code>tcx.param_env(def_id)</code> to get the correct param env for anything happening inside of the query</p>



<a name="275200785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275200785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275200785">(Mar 14 2022 at 07:22)</a>:</h4>
<p>I noticed that you can do that yesterday, after already having re-written the queries ^^</p>



<a name="275200819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275200819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275200819">(Mar 14 2022 at 07:23)</a>:</h4>
<p><span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> ^^</p>



<a name="275214916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275214916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275214916">(Mar 14 2022 at 10:07)</a>:</h4>
<p>Whats the correct way to infer that an <code>Expr</code> for which we try to construct an <code>AbstractConst</code> is polymorphic with the new changes? I currently consider any occurrence of <code>ExprKind::ConstParam</code> and <code>ExprKind::NamedConst</code> to be polymorphic in addition to <code>expr.ty.has_param_types_or_consts</code>, but do get an ICE with that change...</p>



<a name="275214958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275214958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275214958">(Mar 14 2022 at 10:07)</a>:</h4>
<p>Referring to this code: <a href="https://github.com/rust-lang/rust/blob/6b9b2bd3154e866e5ba5e4110f478e5904e0936b/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L310-L338">https://github.com/rust-lang/rust/blob/6b9b2bd3154e866e5ba5e4110f478e5904e0936b/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L310-L338</a></p>



<a name="275215362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275215362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275215362">(Mar 14 2022 at 10:12)</a>:</h4>
<p>Though this might be the correct choice and the ICE is unrelated to that change.</p>



<a name="275215585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275215585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275215585">(Mar 14 2022 at 10:15)</a>:</h4>
<p>Currently getting a <code>delay_span_bug</code> to be raised, but no error encountered ICE for this test: <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-89334.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-89334.rs</a></p>



<a name="275215595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275215595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275215595">(Mar 14 2022 at 10:15)</a>:</h4>
<p>what is the ICE msg? or can you upload your current changes again?</p>



<a name="275215703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275215703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275215703">(Mar 14 2022 at 10:16)</a>:</h4>
<p>which is triggered here:  <a href="https://github.com/rust-lang/rust/blob/b7511248f9c1b00f4dd7b32f3323cd42a3d91172/compiler/rustc_trait_selection/src/traits/codegen.rs#L69">https://github.com/rust-lang/rust/blob/b7511248f9c1b00f4dd7b32f3323cd42a3d91172/compiler/rustc_trait_selection/src/traits/codegen.rs#L69</a></p>



<a name="275215949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275215949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275215949">(Mar 14 2022 at 10:18)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/94876/commits/a2ef0d420c920ce596507946bf9c961f7ca092e1">https://github.com/rust-lang/rust/pull/94876/commits/a2ef0d420c920ce596507946bf9c961f7ca092e1</a> (sorry this contains some unnecessary debug statements)</p>



<a name="275216057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216057">(Mar 14 2022 at 10:19)</a>:</h4>
<p>But I can try to investigate the ICE by myself. Just wanted to know whether the changes to <code>IsThirPolymorphic</code> are correct</p>



<a name="275216182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216182">(Mar 14 2022 at 10:21)</a>:</h4>
<p>I'm not sure why they are necessary</p>



<a name="275216271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216271">(Mar 14 2022 at 10:21)</a>:</h4>
<p>what is <code>thir::ExprKind::ConstParam</code>?</p>



<a name="275216313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216313">(Mar 14 2022 at 10:22)</a>:</h4>
<p>that one is for <code>const N: usize</code> and then <code>1 + N</code> in the constant i guess</p>



<a name="275216354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216354">(Mar 14 2022 at 10:22)</a>:</h4>
<p>so yeah, makes sense</p>



<a name="275216393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216393">(Mar 14 2022 at 10:22)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/071ac6dd14e5fd3db65b5e6cc8768c438e97d16e/compiler/rustc_middle/src/thir.rs#L426-L430">https://github.com/rust-lang/rust/blob/071ac6dd14e5fd3db65b5e6cc8768c438e97d16e/compiler/rustc_middle/src/thir.rs#L426-L430</a></p>



<a name="275216482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216482">(Mar 14 2022 at 10:23)</a>:</h4>
<p>Oh because previously it was handled by the visit_const</p>



<a name="275216505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216505">(Mar 14 2022 at 10:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216182">said</a>:</p>
<blockquote>
<p>I'm not sure why they are necessary</p>
</blockquote>
<p>Because without them we don't construct <code>AbstractConst</code>s in some cases in which we previously did.</p>



<a name="275216621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216621">(Mar 14 2022 at 10:24)</a>:</h4>
<p>Maybe it's overzealous now?</p>



<a name="275216633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216633">(Mar 14 2022 at 10:24)</a>:</h4>
<p>so  <code>NamedConst</code> is wrong in some cases</p>



<a name="275216654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216654">(Mar 14 2022 at 10:24)</a>:</h4>
<p>Like treating non-generic named constants as polymorphic?</p>



<a name="275216656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216656">(Mar 14 2022 at 10:24)</a>:</h4>
<p>currently looking through the whole wip pr for the first time</p>



<a name="275216664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216664">(Mar 14 2022 at 10:25)</a>:</h4>
<p>for <code>namedConst</code> you have to look at the substs</p>



<a name="275216672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216672">(Mar 14 2022 at 10:25)</a>:</h4>
<p>and check whether they contain a generic param</p>



<a name="275216680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216680">(Mar 14 2022 at 10:25)</a>:</h4>
<p>OK I'll shut up instead of racing with @lcnr</p>



<a name="275216803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216803">(Mar 14 2022 at 10:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216664">said</a>:</p>
<blockquote>
<p>for <code>namedConst</code> you have to look at the substs</p>
</blockquote>
<p>yeah that makes sense</p>



<a name="275216819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216819">(Mar 14 2022 at 10:26)</a>:</h4>
<p>oh thats kinda sus <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275216842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216842">(Mar 14 2022 at 10:26)</a>:</h4>
<p>spooky that we might miss generics because of it not recursing into substs automagically</p>



<a name="275216906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216906">(Mar 14 2022 at 10:27)</a>:</h4>
<p>i think it's fine cause the type information in the thir is still incomplete</p>



<a name="275216943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216943">(Mar 14 2022 at 10:27)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> i think you should remove <code>fn visit_const</code> from the <code>thir::Visitor</code> though, that method now causes more harm than good</p>



<a name="275216958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275216958">(Mar 14 2022 at 10:27)</a>:</h4>
<p>considering that the thir doesn't contain constants anymore</p>



<a name="275217762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275217762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275217762">(Mar 14 2022 at 10:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275216057">said</a>:</p>
<blockquote>
<p>But I can try to investigate the ICE by myself. Just wanted to know whether the changes to <code>IsThirPolymorphic</code> are correct</p>
</blockquote>
<p>after the <code>NamedConst</code> changes they should be. Would have to look at the resulting <code>AbstractConst</code>s and obligations myself to figure out more</p>



<a name="275222366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222366">(Mar 14 2022 at 11:20)</a>:</h4>
<p>this code <a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L407-L420">here</a> must be wrong. E.g. in <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-89334.rs">this test</a> we get the following in that code when trying to resolve the associated const.</p>
<div class="codehilite"><pre><span></span><code>│ ├─2ms DEBUG rustc_trait_selection::traits::const_evaluatable recurse_build: node=Expr { ty: usize, temp_lifetime: Some(Node(20)), span: src/test/ui/const-generics/issues/issue-89334.rs:12:10: 12:23 (#0), kind: NamedConst { def_id: DefId(0:4 ~ issue_89334[2858]::AnotherTrait::ARRAY_SIZE), substs: [T], user_ty: None } }
│ ├─2ms DEBUG rustc_trait_selection::traits::const_evaluatable param_env: ParamEnv { caller_bounds: [Binder(TraitPredicate(&lt;Self as AnotherTrait&gt;, polarity:Positive), [])], reveal: UserFacing, constness: Const }
</code></pre></div>
<p>In this case we have to sub in <code>Self</code> for <code>T</code>. But this does not seem to be the correct place to do that, should this be done earlier?</p>



<a name="275222579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222579">(Mar 14 2022 at 11:23)</a>:</h4>
<p>yes, the code here is wrong <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="275222582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222582">(Mar 14 2022 at 11:23)</a>:</h4>
<p>good catch</p>



<a name="275222593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222593">(Mar 14 2022 at 11:23)</a>:</h4>
<p>Or maybe we shouldn't try to evaluate here at all?!</p>



<a name="275222599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222599">(Mar 14 2022 at 11:23)</a>:</h4>
<p><code>self.tcx.param_env(def_id).subst(tcx, substs)</code></p>



<a name="275222611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222611">(Mar 14 2022 at 11:23)</a>:</h4>
<p>so the param env of the associated constant has the generic parameters <code>[Self]</code></p>



<a name="275222617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222617">(Mar 14 2022 at 11:23)</a>:</h4>
<p>but we want it to have <code>[T]</code> instead</p>



<a name="275222669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222669">(Mar 14 2022 at 11:24)</a>:</h4>
<p>so we have to substitute the parameters with the ones used by the named constant</p>



<a name="275222689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222689">(Mar 14 2022 at 11:24)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I think we want to evaluate here</p>



<a name="275222739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222739">(Mar 14 2022 at 11:25)</a>:</h4>
<p>we don't evaluate in <code>try_unify</code> and we have to do it somewhere</p>



<a name="275222743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275222743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275222743">(Mar 14 2022 at 11:25)</a>:</h4>
<p>so doing it while building the abstract const seems good to me</p>



<a name="275225936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275225936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275225936">(Mar 14 2022 at 12:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-71202.rs">This test</a> passes now, is that good or bad?^^</p>



<a name="275226051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226051">(Mar 14 2022 at 12:04)</a>:</h4>
<p>"passes" meaning doesnt emit the error?</p>



<a name="275226068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226068">(Mar 14 2022 at 12:04)</a>:</h4>
<p>bad <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> i think</p>



<a name="275226109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226109">(Mar 14 2022 at 12:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226051">said</a>:</p>
<blockquote>
<p>"passes" meaning doesnt emit the error?</p>
</blockquote>
<p>yes</p>



<a name="275226111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226111">(Mar 14 2022 at 12:05)</a>:</h4>
<p>i guess that <code>&lt;IsCopy&lt;T&gt;&gt;::VALUE</code> is actually not dependent on <code>T</code> but i would still like this to error</p>



<a name="275226162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226162">(Mar 14 2022 at 12:06)</a>:</h4>
<p>so we have the <code>is_polymorphic</code> flag in the mir</p>



<a name="275226268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226268">(Mar 14 2022 at 12:06)</a>:</h4>
<p>you probably also evaluate <code>ExprKind::NamedConst</code> when converting it to mir constants?</p>



<a name="275226302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226302">(Mar 14 2022 at 12:07)</a>:</h4>
<p>i guess not doing that for now is the easiest fix? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275226417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275226417">(Mar 14 2022 at 12:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275226268">said</a>:</p>
<blockquote>
<p>you probably also evaluate <code>ExprKind::NamedConst</code> when converting it to mir constants?</p>
</blockquote>
<p>No we create an <code>Unevaluated</code> for those</p>



<a name="275227237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275227237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275227237">(Mar 14 2022 at 12:17)</a>:</h4>
<p>Also still get many ICEs (something must be going wrong with the user type annotations, but also something must still be going wrong with the evaluation during the construction of the <code>AbstractConst</code>s).</p>
<p><a href="/user_uploads/4715/586vT1jkdChoDrTkqpWjipBI/test_results.txt">test_results.txt</a></p>



<a name="275227382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275227382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275227382">(Mar 14 2022 at 12:19)</a>:</h4>
<p>Some of the cycle error messages are also really long now</p>



<a name="275259399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275259399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275259399">(Mar 14 2022 at 16:13)</a>:</h4>
<p>Fixed most of the ICEs in the failing tests, but still get 23 failing tests. Didn't realize this earlier, since I just skimmed the test run output, but this PR actually introduces cycles in <code>type_of</code> instead of just changing the stderr for those tests...  That kind of sucks</p>



<a name="275259469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275259469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275259469">(Mar 14 2022 at 16:13)</a>:</h4>
<p>I find the query system really hard to debug</p>



<a name="275263038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275263038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275263038">(Mar 14 2022 at 16:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275259469">said</a>:</p>
<blockquote>
<p>I find the query system really hard to debug</p>
</blockquote>
<p>because it is :3</p>



<a name="275263462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275263462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275263462">(Mar 14 2022 at 16:39)</a>:</h4>
<p>do you need help with this? I would assume that you either:</p>
<ul>
<li>explicitly added a <code>type_of</code> call at some new place</li>
<li>use <code>WithOptConstParam::unknown</code>incorrectly somewhere, though i can't really see where that should happen as you're after typeck</li>
</ul>



<a name="275264230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275264230">(Mar 14 2022 at 16:44)</a>:</h4>
<p>I can try to figure this out on my own first. Though I currently feel that I have a bad intuition for the query flow in the compiler in general and hence with intuitively getting how query cycles might arise. Do you have any tips for how to get a better grasp of understanding the query flow?</p>



<a name="275264486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275264486">(Mar 14 2022 at 16:46)</a>:</h4>
<p>I use <code>-Ztreat-err-as-bug</code> on such tests and look at the backtrace</p>



<a name="275264581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275264581">(Mar 14 2022 at 16:46)</a>:</h4>
<p>I don't have good ways to debug cycles beyond that</p>



<a name="275264644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275264644">(Mar 14 2022 at 16:47)</a>:</h4>
<blockquote>
<p>Do you have any tips for how to get a better grasp of understanding the query flow?</p>
</blockquote>
<p>not really <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> the query flow is roughly in the order in which it is called in <code>rustc_interface</code>. It might make sense to take a quick look over <code>rustc_interface::passes::analysis</code> to get the expected order</p>



<a name="275264840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275264840">(Mar 14 2022 at 16:48)</a>:</h4>
<p>the exceptions here are <code>type_of</code>, <code>typeck</code> and const eval. Here the typeck of some body calls <code>typeck</code> and const eval for its anonymous constants</p>



<a name="275264876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275264876">(Mar 14 2022 at 16:48)</a>:</h4>
<p>and the <code>type_of</code> for some anon consts can call <code>typeck</code> of its containing body</p>



<a name="275265051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265051">(Mar 14 2022 at 16:49)</a>:</h4>
<p>this is where <code>WithOptConstParam</code> steps in to avoid the cycle <code>typeck(containing_body) -&gt; const_eval(anon_const) -&gt; typeck(anon_const) -&gt; type_of(anon_const) /* to get the expected return type of the anon const */ -&gt; typeck(containing_body)</code></p>



<a name="275265062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265062">(Mar 14 2022 at 16:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275264644">said</a>:</p>
<blockquote>
<blockquote>
<p>Do you have any tips for how to get a better grasp of understanding the query flow?</p>
</blockquote>
<p>not really <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> the query flow is roughly in the order in which it is called in <code>rustc_interface</code>. It might make sense to take a quick look over <code>rustc_interface::passes::analysis</code> to get the expected order</p>
</blockquote>
<p>yes I have already looked at rustc_interface. But <code>type_of</code> is called all over the place right?^^</p>



<a name="275265138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265138">(Mar 14 2022 at 16:50)</a>:</h4>
<p>well, <code>type_of</code> is also used to represent like 5 different things at once xd</p>



<a name="275265208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265208">(Mar 14 2022 at 16:50)</a>:</h4>
<p>What do you mean?</p>



<a name="275265275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265275">(Mar 14 2022 at 16:51)</a>:</h4>
<p>for anon const, <code>type_of</code> is called during <code>typeck</code> of that anon const, except if <code>WithOptConstParam</code> has a <code>param_def_id</code> in which case we avoid <code>type_of</code> and only call that far later (at which point cycles don't matter)</p>



<a name="275265304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265304">(Mar 14 2022 at 16:51)</a>:</h4>
<p><code>type_of</code> is used for the expected return type of constants</p>



<a name="275265328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265328">(Mar 14 2022 at 16:51)</a>:</h4>
<p>the self type of impls</p>



<a name="275265344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265344">(Mar 14 2022 at 16:51)</a>:</h4>
<p>the hidden type of <code>impl Trait</code></p>



<a name="275265453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265453">(Mar 14 2022 at 16:52)</a>:</h4>
<p>the enum type of enum variants i think</p>



<a name="275265485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265485">(Mar 14 2022 at 16:52)</a>:</h4>
<p>expanding a type alias</p>



<a name="275265553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265553">(Mar 14 2022 at 16:52)</a>:</h4>
<p>the signature of a function</p>



<a name="275265597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265597">(Mar 14 2022 at 16:53)</a>:</h4>
<p>(a lot of things with different requirements <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span>)</p>



<a name="275265604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265604">(Mar 14 2022 at 16:53)</a>:</h4>
<p>if the type-context is a god-object, then <code>type_of</code> is a god-query</p>



<a name="275265672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265672">(Mar 14 2022 at 16:53)</a>:</h4>
<p>we may want to split <code>type_of</code></p>



<a name="275265771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265771">(Mar 14 2022 at 16:54)</a>:</h4>
<p>cause rn calling it "incorrectly" can easily go unnoticed</p>



<a name="275265845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265845">(Mar 14 2022 at 16:54)</a>:</h4>
<p>which is probably why there is an auto impl for <code>[u8]</code> in rustdoc <a href="https://doc.rust-lang.org/nightly/std/marker/trait.Send.html#impl-Send-80">https://doc.rust-lang.org/nightly/std/marker/trait.Send.html#impl-Send-80</a></p>



<a name="275265853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275265853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275265853">(Mar 14 2022 at 16:54)</a>:</h4>
<p>but not for <code>[u16]</code></p>



<a name="275273425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275273425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275273425">(Mar 14 2022 at 17:49)</a>:</h4>
<p>The problem seems to be that we can end up trying to typeck an opaque type, in which we borrowck, for which we need to build the mir. If we encounter a <code>ExprKind::Literal</code> in the thir body and try to <a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_mir_build/src/build/expr/as_constant.rs#L107-L155">convert</a> that literal to a constant <a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_mir_build/src/build/expr/as_constant.rs#L38">here</a> we can end up in a cycle since the conversion of the literal requires a <a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_mir_build/src/build/expr/as_constant.rs#L114">call to <code>layout_of</code></a> for the opaque type and <code>layout_of</code> needs to normalize the opaque type, which internally calls <code>type_of</code> again.</p>



<a name="275273750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275273750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275273750">(Mar 14 2022 at 17:52)</a>:</h4>
<p>so we have an integer literal whose type is an opaque type?</p>



<a name="275273765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275273765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275273765">(Mar 14 2022 at 17:52)</a>:</h4>
<p>which test is that?</p>



<a name="275274122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274122">(Mar 14 2022 at 17:55)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/impl-trait/issue-87450.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui/impl-trait/issue-87450.rs</a></p>



<a name="275274147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274147">(Mar 14 2022 at 17:55)</a>:</h4>
<p>Not sure why we even call <code>as_constant</code> there at all</p>



<a name="275274183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274183">(Mar 14 2022 at 17:55)</a>:</h4>
<p>ah I think because of the zero literal</p>



<a name="275274211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274211">(Mar 14 2022 at 17:55)</a>:</h4>
<p>which 0 literal?</p>



<a name="275274318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274318">(Mar 14 2022 at 17:56)</a>:</h4>
<p>we use <code>ExprKind::ScalarLiteral</code> for fn pointers</p>



<a name="275274338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274338">(Mar 14 2022 at 17:56)</a>:</h4>
<p>or not sure whether they are really fn pointers</p>



<a name="275274368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274368">(Mar 14 2022 at 17:56)</a>:</h4>
<p>one second</p>



<a name="275274448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274448">(Mar 14 2022 at 17:57)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_mir_build/src/thir/cx/expr.rs">here</a> whenever we call <code>ExprKind::zero_sized_literal</code></p>



<a name="275274564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274564">(Mar 14 2022 at 17:58)</a>:</h4>
<p>have to look at this tomorrow, don't think i can get anywhere here in 5 min <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275274626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274626">(Mar 14 2022 at 17:59)</a>:</h4>
<p>these were previously created in <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/ty/consts.rs.html#218"><code>ty::Const::zero_sized</code></a></p>



<a name="275274685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274685">(Mar 14 2022 at 17:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274564">said</a>:</p>
<blockquote>
<p>have to look at this tomorrow, don't think i can get anywhere here in 5 min <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>no problem, I think I call it quits for today also</p>



<a name="275274992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275274992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275274992">(Mar 14 2022 at 18:01)</a>:</h4>
<p>I think the solution for this might be to just not try to evaluate zero sized literals though and treat them seperately in <code>ExprKind</code></p>



<a name="275281950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275281950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275281950">(Mar 14 2022 at 18:52)</a>:</h4>
<p>lol it was this assert statement that <a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_mir_build/src/build/expr/as_constant.rs#L60-L62">I inserted</a> that caused the cycle.</p>



<a name="275282461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275282461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275282461">(Mar 14 2022 at 18:55)</a>:</h4>
<p>We're down to three failing tests now:</p>
<div class="codehilite"><pre><span></span><code>failures:
    [ui] ui/const-generics/issues/issue-71202.rs
    [ui] ui/const-generics/issues/issue-72845.rs
    [ui] ui/const-generics/issues/issue-83288.rs
</code></pre></div>



<a name="275346349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275346349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275346349">(Mar 15 2022 at 09:11)</a>:</h4>
<p>I think we shouldn't try to eval/resolve <a href="https://github.com/rust-lang/rust/blob/a2ef0d420c920ce596507946bf9c961f7ca092e1/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L412">here</a>. In <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-72845.rs">this test</a> the normalization of <code>&lt;T as Type&gt;::AT</code> fails with an ICE, because <code>codegen_fulfill_obligations</code>(called from <code>resolve_associated_item</code>) expects normalization to succeed. Previously we just had the corresponding thir expr as an <code>Unevaluated</code> literal:</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ ├─0ms DEBUG rustc_trait_selection::traits::const_evaluatable recurse_build: node=Expr { ty: usize, temp_lifetime: Some(Node(15)), span: src/test/ui/const-generics/issues/issue-72845.rs:27:44: 27:52 (#0), kind: Literal { literal: Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ issue_72845[e07c]::Depth::C), const_param_did: None }, substs: [&lt;T as Type&gt;::AT], promoted: None }) }, user_ty: Some(Canonical { max_universe: U0, variables: [], value: TypeOf(DefId(0:4 ~ issue_72845[e07c]::Depth::C), UserSubsts { substs: [&lt;T as Type&gt;::AT], user_self_ty: None }) }), const_id: Some(DefId(0:4 ~ issue_72845[e07c]::Depth::C)) } }
</code></pre></div>
<p>So its not necessary to resolve and evaluate here. Not sure whether it might make sense to still try this (and have a fallible version of <code>resolve_associated_item</code>). We would need to evaluate to a valtree here, how useful would those be when trying to unify abstract consts?</p>



<a name="275347022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347022">(Mar 15 2022 at 09:17)</a>:</h4>
<p>did you add a <code>subst</code> call for the param env here?</p>



<a name="275347302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347302">(Mar 15 2022 at 09:19)</a>:</h4>
<p>yes</p>



<a name="275347435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347435">(Mar 15 2022 at 09:20)</a>:</h4>
<p>ah, sorry</p>



<a name="275347466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347466">(Mar 15 2022 at 09:20)</a>:</h4>
<p>that's actually wrong <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275347517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347517">(Mar 15 2022 at 09:21)</a>:</h4>
<p>but this is the same place where we needed one earlier to avoid the ICEs ^^</p>



<a name="275347572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347572">(Mar 15 2022 at 09:21)</a>:</h4>
<p>because the subst are in the context of the body, you need the param env of the const we're currently converting</p>



<a name="275347624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347624">(Mar 15 2022 at 09:21)</a>:</h4>
<p>which implies all caller bounds of the param env of the used named constant (as otherwise typeck would have failed)</p>



<a name="275347645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347645">(Mar 15 2022 at 09:22)</a>:</h4>
<p>but also contains the necessary bounds for <code>T: Type</code></p>



<a name="275347701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347701">(Mar 15 2022 at 09:22)</a>:</h4>
<p>so we do need to pass in a param env to the query?</p>



<a name="275347706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347706">(Mar 15 2022 at 09:22)</a>:</h4>
<p>no</p>



<a name="275347728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347728">(Mar 15 2022 at 09:22)</a>:</h4>
<p>we need the param env of the body</p>



<a name="275347743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347743">(Mar 15 2022 at 09:22)</a>:</h4>
<p>which is identified by a <code>DefId</code></p>



<a name="275347746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347746">(Mar 15 2022 at 09:22)</a>:</h4>
<p>ok</p>



<a name="275347774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347774">(Mar 15 2022 at 09:22)</a>:</h4>
<p>the same <code>DefId</code> already used as input to the query</p>



<a name="275347833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347833">(Mar 15 2022 at 09:23)</a>:</h4>
<p>so you probably want to add a <code>param_env</code> field to the <code>AbstractConstBuilder</code></p>



<a name="275347840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275347840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275347840">(Mar 15 2022 at 09:23)</a>:</h4>
<p>and initialize that with <code>tcx.param_env(def.did)</code></p>



<a name="275348542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348542">(Mar 15 2022 at 09:30)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> i just experimented a bit, and you don't have to evaluate <code>Unevaluated</code> constants during abstract const building after all</p>



<a name="275348544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348544">(Mar 15 2022 at 09:30)</a>:</h4>
<p>i think</p>



<a name="275348566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348566">(Mar 15 2022 at 09:30)</a>:</h4>
<p>the following doesn't compile rn</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_const_exprs)]</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">FREE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">FREE</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="275348636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348636">(Mar 15 2022 at 09:31)</a>:</h4>
<p>and the way this should actually be fixed is by giving a param env to <code>try_unify</code></p>



<a name="275348653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348653">(Mar 15 2022 at 09:31)</a>:</h4>
<p>and then evaluating non abstract const <code>Node::Leaf</code> before comparing them</p>



<a name="275348761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348761">(Mar 15 2022 at 09:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348636">said</a>:</p>
<blockquote>
<p>and the way this should actually be fixed is by giving a param env to <code>try_unify</code></p>
</blockquote>
<p>this can be done before, as part, or after your work with valtrees <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> not sure if you want to do that</p>



<a name="275348808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275348808">(Mar 15 2022 at 09:33)</a>:</h4>
<p>but we don't have to evaluate during building, which tbh is not wrong but will be unnecessary once <code>try_unify</code> is actually correct</p>



<a name="275349006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349006">(Mar 15 2022 at 09:35)</a>:</h4>
<p>does that make sense to you? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> and also sorry for not thinking about this earlier</p>



<a name="275349168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349168">(Mar 15 2022 at 09:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348808">said</a>:</p>
<blockquote>
<p>but we don't have to evaluate during building, which tbh is not wrong but will be unnecessary once <code>try_unify</code> is actually correct</p>
</blockquote>
<p>What do you mean by 'when try_unify is actually correct'? In what sense isn't it correct now and what will change that?</p>



<a name="275349201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349201">(Mar 15 2022 at 09:37)</a>:</h4>
<p><code>try_unify</code> currently doesn't evaluate unevaluated (non abstract const) constants</p>



<a name="275349278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349278">(Mar 15 2022 at 09:38)</a>:</h4>
<p>we need that however:</p>



<a name="275349358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349358">(Mar 15 2022 at 09:39)</a>:</h4>
<p>This isn't relevant anymore given what you just said, but I tried supplying the param_env of the body to abstractconstbuilder and this didn't work. I used:</p>
<div class="codehilite"><pre><span></span><code>        let body = tcx.thir_body(def);
        let def_id = def.def_id_for_type_of();
        let param_env = tcx.param_env(def_id);
</code></pre></div>
<p>I think this must be wrong, since the caller bounds in that param_env were empty in <code>recurse_build</code>.</p>



<a name="275349391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349391">(Mar 15 2022 at 09:39)</a>:</h4>
<p>you want <code>def.did</code></p>



<a name="275349401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349401">(Mar 15 2022 at 09:39)</a>:</h4>
<p><code>def_id_for_type_of()</code> is the wrong <code>DefId</code></p>



<a name="275349409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349409">(Mar 15 2022 at 09:39)</a>:</h4>
<p>ok</p>



<a name="275349417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349417">(Mar 15 2022 at 09:39)</a>:</h4>
<p>it's only the correct one for <code>type_of</code></p>



<a name="275349475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349475">(Mar 15 2022 at 09:40)</a>:</h4>
<p>That is a little confusing ^^</p>



<a name="275349482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349482">(Mar 15 2022 at 09:40)</a>:</h4>
<p>yes</p>



<a name="275349532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349532">(Mar 15 2022 at 09:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348761">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275348636">said</a>:</p>
<blockquote>
<p>and the way this should actually be fixed is by giving a param env to <code>try_unify</code></p>
</blockquote>
<p>this can be done before, as part, or after your work with valtrees <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> not sure if you want to do that</p>
</blockquote>
<p>I can do that. Shall I finish this PR first before implementing that?</p>



<a name="275349576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349576">(Mar 15 2022 at 09:41)</a>:</h4>
<p>so, the relevant part is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">B</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">               </span><span class="o">^^^^^^^^^^^</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">DefId</span><span class="err">`</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">type</span> <span class="nc">of</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">anon</span><span class="w"> </span><span class="k">const</span>: <span class="err">`</span><span class="n">def</span><span class="p">.</span><span class="n">def_id_for_type_of</span><span class="p">()</span><span class="err">`</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Satisfied</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Satisfied</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Predicate</span><span class="o">&lt;</span><span class="kc">true</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Spec1</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Type</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Spec1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Predicate</span><span class="o">&lt;</span><span class="p">{</span><span class="n">T</span>::<span class="n">AT</span>::<span class="n">C</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="o">&gt;</span>: <span class="nc">Satisfied</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">                                          </span><span class="o">^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">anon</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">we</span><span class="o">'</span><span class="na">re</span><span class="w"> </span><span class="n">building</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">abstract</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="275349699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349699">(Mar 15 2022 at 09:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349532">said</a>:</p>
<blockquote>
<p>I can do that. Shall I finish this PR first before implementing that?</p>
</blockquote>
<p>what you prefer, the order doesn't really matter here ^^</p>



<a name="275349801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275349801">(Mar 15 2022 at 09:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349475">said</a>:</p>
<blockquote>
<p>That is a little confusing ^^</p>
</blockquote>
<p>the docs of <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html</a> may help somewhat here <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275350264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275350264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275350264">(Mar 15 2022 at 09:48)</a>:</h4>
<p>Not evaluating there <br>
<span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275225936">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-71202.rs">This test</a> passes now, is that good or bad?^^</p>
</blockquote>
<p>Not evaluating in <code>recurse_build</code> causes this test to pass again, i.e. the unconstrained generic constant error is thrown.</p>



<a name="275350291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275350291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275350291">(Mar 15 2022 at 09:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349801">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275349475">said</a>:</p>
<blockquote>
<p>That is a little confusing ^^</p>
</blockquote>
<p>the docs of <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html</a> may help somewhat here <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>thanks I'll take a look at those later.</p>



<a name="275360499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275360499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275360499">(Mar 15 2022 at 11:34)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/94876">https://github.com/rust-lang/rust/pull/94876</a> is ready for review now</p>



<a name="275360778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275360778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275360778">(Mar 15 2022 at 11:37)</a>:</h4>
<p>are all the review comments in that pr already resolved?</p>



<a name="275361750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275361750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275361750">(Mar 15 2022 at 11:49)</a>:</h4>
<p>No, sorry, just noticed that you requested (here in zulip) to remove <code>visit_const</code> from the thir visitor.</p>



<a name="275361960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275361960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275361960">(Mar 15 2022 at 11:51)</a>:</h4>
<p>I marked those as resolved that I knew for sure</p>



<a name="275362132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275362132">(Mar 15 2022 at 11:53)</a>:</h4>
<p>hm though we do still have a <code>ty::Const</code> in <code>ExprKind::Repeat</code></p>



<a name="275362202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275362202">(Mar 15 2022 at 11:54)</a>:</h4>
<p>so still need <code>visit_const</code></p>



<a name="275362349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275362349">(Mar 15 2022 at 11:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362202">said</a>:</p>
<blockquote>
<p>so still need <code>visit_const</code></p>
</blockquote>
<p>not as part of the <code>thir</code> visitor</p>



<a name="275362458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275362458">(Mar 15 2022 at 11:57)</a>:</h4>
<p><code>fn visit_const</code> would only visit the actual <code>ty::Const</code> while there are a lot of different constants in the thir which are ignored with that function</p>



<a name="275362493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275362493">(Mar 15 2022 at 11:57)</a>:</h4>
<p>so stuff that cares about constants in the thir has to manually search for them using <code>fn visit_expr</code> anyways</p>



<a name="275362559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275362559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275362559">(Mar 15 2022 at 11:58)</a>:</h4>
<p>so remove <code>fn visit_const</code> and in the visitors which currently use it (only <code>AbstractConst</code> building iirc) add repeat expressions to the expr check</p>



<a name="275366797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275366797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275366797">(Mar 15 2022 at 12:40)</a>:</h4>
<p>just realizing that we don't lazily create constants in patterns, e.g. <a href="https://github.com/rust-lang/rust/blob/3ba1ebea122238d1a5c613deb1bf60ce24bd8fd8/compiler/rustc_mir_build/src/thir/pattern/mod.rs#L587-L592">here</a>. Need to change that too right?</p>



<a name="275368460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275368460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275368460">(Mar 15 2022 at 12:57)</a>:</h4>
<p>not necessarily <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> pattern can't end up in <code>AbstractConst</code>s, so we don't have to convert them to <code>ty::Const</code></p>



<a name="275368499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275368499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275368499">(Mar 15 2022 at 12:57)</a>:</h4>
<p>we do have the current <code>const_to_pat</code> system which I should hopefully be able to remove in the near future <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275368537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275368537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275368537">(Mar 15 2022 at 12:57)</a>:</h4>
<p>you can probably try to change <code>const_to_pat</code> to use mir constants for now?</p>



<a name="275368607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/275368607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#275368607">(Mar 15 2022 at 12:58)</a>:</h4>
<p>idk, it isn't yet clear how exactly constants in pattern should behave</p>



<a name="276163336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276163336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276163336">(Mar 22 2022 at 09:50)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> Can you take another look at <a href="https://github.com/rust-lang/rust/pull/94876">this pr</a>, please?</p>



<a name="276174795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276174795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276174795">(Mar 22 2022 at 11:37)</a>:</h4>
<p>will do so later today <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="276981140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276981140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276981140">(Mar 29 2022 at 09:52)</a>:</h4>
<p>Opened a <a href="https://github.com/rust-lang/rust/pull/95426">PR</a> that adds the logic for <code>ty::Ref</code> in <code>const_to_valtree</code>. Fairly likely that I screwed something up there, but thought that I might open a PR for this to make sure this code is correct before proceeding.</p>



<a name="276981238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276981238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276981238">(Mar 29 2022 at 09:52)</a>:</h4>
<p>Is there some way we can currently test valtree creation?</p>



<a name="276981851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276981851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276981851">(Mar 29 2022 at 09:59)</a>:</h4>
<p>i don't think we have a good way <del>except</del>(<em>edit: that's not a good solution, but the best we have</em>) by trying to build them when creating a <code>ty::Const</code>.</p>



<a name="276982208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276982208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276982208">(Mar 29 2022 at 10:02)</a>:</h4>
<p>Shall I include that call for now and remove it again before we merge?</p>



<a name="276982247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276982247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276982247">(Mar 29 2022 at 10:02)</a>:</h4>
<p><span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> the only one it would help would be you <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> so do what you think is best</p>



<a name="276982296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276982296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276982296">(Mar 29 2022 at 10:03)</a>:</h4>
<p>I included that call on my machine.</p>



<a name="276990316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276990316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276990316">(Mar 29 2022 at 11:26)</a>:</h4>
<p>These changes ( expectedly) work extremely poorly on this <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/issue-77062-large-zst-array.rs">test</a>. We call <code>const_to_valtree_inner</code> <code>usize::MAX</code> times. This test takes minutes to complete with very large memory usage.</p>



<a name="276990619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276990619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276990619">(Mar 29 2022 at 11:29)</a>:</h4>
<p>probably have to special case for zst here and in the array arm</p>



<a name="276991102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276991102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276991102">(Mar 29 2022 at 11:33)</a>:</h4>
<p>aah, yikes</p>



<a name="276991126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276991126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276991126">(Mar 29 2022 at 11:34)</a>:</h4>
<p><span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="276991177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276991177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276991177">(Mar 29 2022 at 11:34)</a>:</h4>
<p>we could completely ignore zst in valtrees <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="276991240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276991240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276991240">(Mar 29 2022 at 11:34)</a>:</h4>
<p>or we actually just fail for that</p>



<a name="276991301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/276991301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#276991301">(Mar 29 2022 at 11:35)</a>:</h4>
<p>we can't currently have such large arrays inside of types and imo it wouldn't be too bad to forbid that in the future</p>



<a name="277115198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277115198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277115198">(Mar 30 2022 at 09:12)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> Given what you said <a href="https://github.com/rust-lang/rust/pull/94255#discussion_r836481526">here</a>, I'm wondering what the best approach is in <a href="https://github.com/rust-lang/rust/blob/6fff0214d97b24e795704b1aec8100b8b5c3fb51/compiler/rustc_middle/src/mir/mod.rs#L2862-L2884"><code>from_inline_const</code></a>... if the  <code>const_eval_resolve</code> call fails, it doesn't really make sense to create an <code>Unevaluated</code> and return a <code>ConstantKind::Ty</code> with that in this function (this was taken from the <code>ty::Const</code> version where the intent was to delay and error in mir construction), does it? Shall we error here?</p>



<a name="277115515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277115515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277115515">(Mar 30 2022 at 09:16)</a>:</h4>
<p>eh actually looks like <code>ConstantKind::from_inline_const</code> is also dead code now</p>



<a name="277115633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277115633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277115633">(Mar 30 2022 at 09:16)</a>:</h4>
<p>'^^</p>



<a name="277115691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277115691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277115691">(Mar 30 2022 at 09:17)</a>:</h4>
<p>is there still a part here i should answer? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> feel like i would have to look at the code locally to give an answer here</p>



<a name="277115806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277115806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277115806">(Mar 30 2022 at 09:18)</a>:</h4>
<p>^^ No there isnt. btw sorry for not having more thoroughly reviewed the PR before the latest update.</p>



<a name="277115851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277115851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277115851">(Mar 30 2022 at 09:18)</a>:</h4>
<p>no worries ^^</p>



<a name="277117827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277117827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277117827">(Mar 30 2022 at 09:36)</a>:</h4>
<p>Sorry ^^, but basically the same question comes up in <code>ConstantKind::from_opt_const_anon_arg</code>. If we use <code>const_eval_resolve</code> <a href="https://github.com/rust-lang/rust/blob/6fff0214d97b24e795704b1aec8100b8b5c3fb51/compiler/rustc_middle/src/mir/mod.rs#L2913-L2927">here</a> instead of the <code>try_eval_lit_or_param</code> call, how should we proceed in case we encounter an error here. Also can we always assume that the anon const is resolvable/evaluatable here? I don't think we can assume during mir construction that everything is resolvable/evaluatable right and <code>const_eval_resolve</code> does report errors in case anything fails.</p>



<a name="277119066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277119066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277119066">(Mar 30 2022 at 09:48)</a>:</h4>
<blockquote>
<p>Also can we always assume that the anon const is resolvable/evaluatable here?</p>
</blockquote>
<p>what kinds of constants should be the input to that function?</p>



<a name="277119266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277119266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277119266">(Mar 30 2022 at 09:50)</a>:</h4>
<p>like, what are the possible things which can end up as a mir constant? because that should answer that question here ^^</p>



<a name="277119500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277119500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277119500">(Mar 30 2022 at 09:52)</a>:</h4>
<blockquote>
<p>how should we proceed in case we encounter an error here</p>
</blockquote>
<p>apparently you should emit a a <code>const_err</code> lint <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="277119534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277119534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277119534">(Mar 30 2022 at 09:52)</a>:</h4>
<p>you can try and look at where we currently emit that lint</p>



<a name="277119554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277119554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277119554">(Mar 30 2022 at 09:52)</a>:</h4>
<p>because that is where we currently try to evaluate unevaluated mir constants</p>



<a name="277119607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277119607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277119607">(Mar 30 2022 at 09:53)</a>:</h4>
<p>re my first question</p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Generic</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Generic</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ASSOC</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Generic</span>::<span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>::<span class="n">ASSOC</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div></div>



<a name="277120221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120221">(Mar 30 2022 at 09:59)</a>:</h4>
<p>Oh we currently only call <code>from_opt_const_arg_anon_const</code> on the constant in <code>InlineAsmOperand</code>, hardly know anything about those, but I would assume we don't need any normalization logic on them ^^, so we can call this here and always assume that call succeeds.</p>



<a name="277120432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120432">(Mar 30 2022 at 10:00)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="277120449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120449">(Mar 30 2022 at 10:00)</a>:</h4>
<p>that's weird</p>



<a name="277120478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120478">(Mar 30 2022 at 10:01)</a>:</h4>
<p>what do we do for associated constants?</p>



<a name="277120490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120490">(Mar 30 2022 at 10:01)</a>:</h4>
<p>just keep them unevaluated?</p>



<a name="277120499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120499">(Mar 30 2022 at 10:01)</a>:</h4>
<p>yes</p>



<a name="277120526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120526">(Mar 30 2022 at 10:01)</a>:</h4>
<p>then you can also do that instead of <code>from_opt_const_arg_anon_const</code></p>



<a name="277120528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120528">(Mar 30 2022 at 10:01)</a>:</h4>
<p>imo</p>



<a name="277120807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120807">(Mar 30 2022 at 10:04)</a>:</h4>
<p>Though <span class="user-mention" data-user-id="124288">@oli</span> <a href="https://github.com/rust-lang/rust/pull/94255#discussion_r815310312">said</a> that eager normalization can have perf benefits, because those constants can be handled in mir-optimization.</p>



<a name="277120852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120852">(Mar 30 2022 at 10:04)</a>:</h4>
<p>I chose to leave them as unevaluated because I was avoiding some ICEs in the test set that way</p>



<a name="277120882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277120882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277120882">(Mar 30 2022 at 10:05)</a>:</h4>
<p>but would it make sense to have a fallible version for <code>const_eval_resolve</code>?</p>



<a name="277121113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277121113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277121113">(Mar 30 2022 at 10:07)</a>:</h4>
<p>why did that ICE?</p>



<a name="277121177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277121177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277121177">(Mar 30 2022 at 10:08)</a>:</h4>
<p>cause i don't expect changing <code>const_eval_resolve</code> to be fallible is the right way to fix those <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="277121463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277121463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277121463">(Mar 30 2022 at 10:10)</a>:</h4>
<p>I don't remember exactly, but I'm reasonably certain that the <a href="https://github.com/rust-lang/rust/blob/f132bcf3bdf6d3ff9be7d02e8d0088b99007cd5e/compiler/rustc_ty_utils/src/instance.rs#L215">call</a>** to <code>codegen_fulfill_obligation</code> panicked. That function assumes full normalization I think.</p>



<a name="277121496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277121496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277121496">(Mar 30 2022 at 10:10)</a>:</h4>
<p>no, that function assumes that the input is well formed, it is fine if it's not fully normalized</p>



<a name="277121531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277121531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277121531">(Mar 30 2022 at 10:11)</a>:</h4>
<p>so normally what's happening in these cases is that we're using the wrong <code>param_env</code></p>



<a name="277121749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277121749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277121749">(Mar 30 2022 at 10:13)</a>:</h4>
<p>hm I can try to reproduce by trying to evaluate <code>ExprKind::NamedConst</code></p>



<a name="277123251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277123251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277123251">(Mar 30 2022 at 10:29)</a>:</h4>
<p><a href="/user_uploads/4715/mmUBX9iWyx0mgnGh45i9-OCY/backtrace.txt">backtrace.txt</a></p>



<a name="277123391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277123391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277123391">(Mar 30 2022 at 10:30)</a>:</h4>
<p>Using this in <code>as_constant</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="n">ExprKind</span>::<span class="n">NamedConst</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="n">substs</span><span class="p">,</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">user_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_ty</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">user_ty</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">this</span><span class="p">.</span><span class="n">canonical_user_type_annotations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">CanonicalUserTypeAnnotation</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">user_ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">inferred_ty</span>: <span class="nc">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">})</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">uneval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span>::<span class="n">Unevaluated</span>::<span class="n">new</span><span class="p">(</span><span class="n">ty</span>::<span class="n">WithOptConstParam</span>::<span class="n">unknown</span><span class="p">(</span><span class="n">def_id</span><span class="p">),</span><span class="w"> </span><span class="n">substs</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">substs</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">param_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">param_env</span><span class="p">(</span><span class="n">def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">param_env</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">evaluated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">const_eval_resolve</span><span class="p">(</span><span class="n">param_env</span><span class="p">,</span><span class="w"> </span><span class="n">uneval</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">evaluated</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="277123819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277123819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277123819">(Mar 30 2022 at 10:35)</a>:</h4>
<p>Though I realize now that I just might be missing the substs in the <code>param_env</code></p>



<a name="277123986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277123986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277123986">(Mar 30 2022 at 10:37)</a>:</h4>
<p>it's the wrong <code>param_env</code></p>



<a name="277124007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277124007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277124007">(Mar 30 2022 at 10:37)</a>:</h4>
<p>you want the param env from the same context as the generic arguments</p>



<a name="277124108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277124108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277124108">(Mar 30 2022 at 10:38)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">with_assoc</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Trait</span><span class="o">&lt;</span><span class="n">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SOME_GENERIC_CONST</span>::<span class="o">&lt;&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Trait</span><span class="o">&gt;</span>::<span class="n">Assoc</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277124131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277124131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277124131">(Mar 30 2022 at 10:38)</a>:</h4>
<p>here the <code>Unevaluated</code> would be <code>ty::Unevaluated(def_id_of_SOME_GENERIC_CONST, [&lt;T as Trait&gt;::Assoc])</code></p>



<a name="277124189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277124189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277124189">(Mar 30 2022 at 10:39)</a>:</h4>
<p>for this to work, you need the <code>T: Trait&lt;Assoc = u32&gt;</code> in the <code>param_env</code> during evaluation</p>



<a name="277124266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277124266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277124266">(Mar 30 2022 at 10:40)</a>:</h4>
<p>which is the param_env of <code>fn with_assoc</code>, i.e. the item we're currently lowering thir-&gt;mir, not the param_env of <code>SOME_GENERIC_CONST</code>, which is the one you're currently using</p>



<a name="277124518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277124518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277124518">(Mar 30 2022 at 10:42)</a>:</h4>
<p>So that is the <code>param_env</code> of the <code>Builder</code>?</p>



<a name="277125260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277125260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277125260">(Mar 30 2022 at 10:51)</a>:</h4>
<p>ok it is, thanks.</p>



<a name="277125323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277125323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277125323">(Mar 30 2022 at 10:52)</a>:</h4>
<p>Sorry, should have remembered that myself. You have explained that before.</p>



<a name="277181094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277181094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277181094">(Mar 30 2022 at 17:40)</a>:</h4>
<p>What <code>substs</code> do I need to use here? The following doesn't work and I don't know how else to get parent substs (which should contain the correct substs here afaict).</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="cp">#[instrument(skip(tcx), level = </span><span class="s">"debug"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from_opt_const_arg_anon_const</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">def</span>: <span class="nc">ty</span>::<span class="n">WithOptConstParam</span><span class="o">&lt;</span><span class="n">LocalDefId</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">param_env</span>: <span class="nc">ty</span>::<span class="n">ParamEnv</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">body_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">get_by_def_id</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">hir</span>::<span class="n">Node</span>::<span class="n">AnonConst</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ac</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">span_bug</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">tcx</span><span class="p">.</span><span class="n">def_span</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">.</span><span class="n">to_def_id</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="s">"from_anon_const can only process anonymous constants"</span><span class="w"></span>
<span class="w">            </span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">body</span><span class="p">(</span><span class="n">body_id</span><span class="p">).</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">expr</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">type_of</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">def_id_for_type_of</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">ty</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">typeck_root_def_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">typeck_root_def_id</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">.</span><span class="n">to_def_id</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">parent_substs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InternalSubsts</span>::<span class="n">identity_for_item</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">typeck_root_def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">parent_substs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">.</span><span class="n">to_def_id</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child_substs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InternalSubsts</span>::<span class="n">identity_for_item</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">did</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">substs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">mk_substs</span><span class="p">(</span><span class="n">parent_substs</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">chain</span><span class="p">(</span><span class="n">child_substs</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">substs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hir_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">local_def_id_to_hir_id</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">span</span><span class="p">(</span><span class="n">hir_id</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">span</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">uneval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span>::<span class="n">Unevaluated</span>::<span class="n">new</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">to_global</span><span class="p">(),</span><span class="w"> </span><span class="n">substs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">param_env</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">const_eval_resolve</span><span class="p">(</span><span class="n">param_env</span><span class="p">,</span><span class="w"> </span><span class="n">uneval</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">span</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Val</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Error was handled in `const_eval_resolve`. Here we just create a</span>
<span class="w">                </span><span class="c1">// new unevaluated const and error hard later in codegen</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">ty_const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">mk_const</span><span class="p">(</span><span class="n">ty</span>::<span class="n">ConstS</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">val</span>: <span class="nc">ty</span>::<span class="n">ConstKind</span>::<span class="n">Unevaluated</span><span class="p">(</span><span class="n">ty</span>::<span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">def</span>: <span class="nc">def</span><span class="p">.</span><span class="n">to_global</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="n">substs</span>: <span class="nc">InternalSubsts</span>::<span class="n">identity_for_item</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">.</span><span class="n">to_def_id</span><span class="p">()),</span><span class="w"></span>
<span class="w">                        </span><span class="n">promoted</span>: <span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">}),</span><span class="w"></span>
<span class="w">                    </span><span class="n">ty</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>

<span class="w">                </span><span class="bp">Self</span>::<span class="n">Ty</span><span class="p">(</span><span class="n">ty_const</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>e.g. in this <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/asm/x86_64/const.rs">test</a> I get: <code>error: internal compiler error: compiler/rustc_middle/src/ty/subst.rs:669:17: const parameter </code>X/#0<code> (Const { ty: usize, val: Param(X/#0) }/0) out of range when substituting substs=[]</code></p>
<p>Some log output:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">┐</span><span class="n">rustc_middle</span>::<span class="n">mir</span>::<span class="n">from_opt_const_arg_anon_const</span><span class="w"> </span><span class="n">def</span><span class="o">=</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">15</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="k">const</span><span class="p">[</span><span class="mi">6</span><span class="n">b25</span><span class="p">]</span>::<span class="n">const_generic</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">NotConst</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">mir</span><span class="w"> </span><span class="n">expr</span><span class="o">=</span><span class="n">Expr</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">hir_id</span>: <span class="nc">HirId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">owner</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">10</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="k">const</span><span class="p">[</span><span class="mi">6</span><span class="n">b25</span><span class="p">]</span>::<span class="n">const_generic</span><span class="p">),</span><span class="w"> </span><span class="n">local_id</span>: <span class="mi">10</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Path</span><span class="p">(</span><span class="n">Resolved</span><span class="p">(</span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">span</span>: <span class="nc">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">ui</span><span class="o">/</span><span class="n">asm</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="k">const</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">14</span>:<span class="mi">46</span>: <span class="mi">14</span>:<span class="mi">47</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">res</span>: <span class="nc">Def</span><span class="p">(</span><span class="n">ConstParam</span><span class="p">,</span><span class="w"> </span><span class="n">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">11</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="k">const</span><span class="p">[</span><span class="mi">6</span><span class="n">b25</span><span class="p">]</span>::<span class="n">const_generic</span>::<span class="n">X</span><span class="p">)),</span><span class="w"> </span><span class="n">segments</span>: <span class="p">[</span><span class="n">PathSegment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ident</span>: <span class="nc">X</span>#<span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">hir_id</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">HirId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">owner</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">10</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="k">const</span><span class="p">[</span><span class="mi">6</span><span class="n">b25</span><span class="p">]</span>::<span class="n">const_generic</span><span class="p">),</span><span class="w"> </span><span class="n">local_id</span>: <span class="mi">9</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">res</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Def</span><span class="p">(</span><span class="n">ConstParam</span><span class="p">,</span><span class="w"> </span><span class="n">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">11</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="k">const</span><span class="p">[</span><span class="mi">6</span><span class="n">b25</span><span class="p">]</span>::<span class="n">const_generic</span>::<span class="n">X</span><span class="p">))),</span><span class="w"> </span><span class="n">args</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">infer_args</span>: <span class="nc">true</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">})),</span><span class="w"> </span><span class="n">span</span>: <span class="nc">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">ui</span><span class="o">/</span><span class="n">asm</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="k">const</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">14</span>:<span class="mi">46</span>: <span class="mi">14</span>:<span class="mi">47</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">mir</span><span class="w"> </span><span class="n">ty</span><span class="o">=</span><span class="kt">usize</span><span class="w"></span>
<span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">mir</span><span class="w"> </span><span class="n">parent_substs</span><span class="o">=</span><span class="p">[]</span><span class="w"></span>
<span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">mir</span><span class="w"> </span><span class="n">substs</span><span class="o">=</span><span class="p">[]</span><span class="w"></span>
<span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">mir</span><span class="w"> </span><span class="n">span</span><span class="o">=</span><span class="n">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">ui</span><span class="o">/</span><span class="n">asm</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="k">const</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">14</span>:<span class="mi">46</span>: <span class="mi">14</span>:<span class="mi">47</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">mir</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">NotConst</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="err">├─┐</span><span class="n">rustc_middle</span>::<span class="n">mir</span>::<span class="n">interpret</span>::<span class="n">queries</span>::<span class="n">const_eval_resolve</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">NotConst</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">ct</span><span class="o">=</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">15</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="k">const</span><span class="p">[</span><span class="mi">6</span><span class="n">b25</span><span class="p">]</span>::<span class="n">const_generic</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[],</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">span</span><span class="o">=</span><span class="nb">Some</span><span class="p">(</span><span class="n">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">ui</span><span class="o">/</span><span class="n">asm</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="k">const</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">14</span>:<span class="mi">46</span>: <span class="mi">14</span>:<span class="mi">47</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">))</span><span class="w"></span>

<span class="o">....</span><span class="w"></span>

<span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_middle</span>::<span class="n">ty</span>::<span class="n">normalize_erasing_regions</span><span class="w"> </span><span class="n">subst_and_normalize_erasing_regions</span><span class="p">(</span><span class="n">param_substs</span><span class="o">=</span><span class="p">[],</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="n">Ty</span><span class="p">(</span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">X</span><span class="o">/</span>#<span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">Const</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
</code></pre></div>



<a name="277234567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277234567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277234567">(Mar 31 2022 at 05:22)</a>:</h4>
<p>where exactly are you using that method?</p>



<a name="277234569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277234569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277234569">(Mar 31 2022 at 05:23)</a>:</h4>
<p>there are 2 parts to this:</p>



<a name="277234597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277234597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277234597">(Mar 31 2022 at 05:23)</a>:</h4>
<ul>
<li>for mir const we never need to deal with the <code>opt_const_arg</code> part and can always use <code>DefId</code> with <code>WithOptConstParam::unknown(def_id)</code>.</li>
</ul>



<a name="277234832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277234832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277234832">(Mar 31 2022 at 05:28)</a>:</h4>
<ul>
<li>you do not want the <code>substs</code> for the <code>typeck_root_def_id</code> at any point for generic const</li>
</ul>
<p>I do not think there exists any situation where we want to use that for anything else apart from <code>type_of</code></p>



<a name="277244611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277244611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277244611">(Mar 31 2022 at 07:52)</a>:</h4>
<p>I'm calling this in <code>ConstantKind::from_anon_const</code> which is only called during thir construction for <code>InlineAsmOperand::Const</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                            </span><span class="n">hir</span>::<span class="n">InlineAsmOperand</span>::<span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">ref</span><span class="w"> </span><span class="n">anon_const</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">anon_const_def_id</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                    </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">local_def_id</span><span class="p">(</span><span class="n">anon_const</span><span class="p">.</span><span class="n">hir_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mir</span>::<span class="n">ConstantKind</span>::<span class="n">from_anon_const</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">anon_const_def_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="bp">self</span><span class="p">.</span><span class="n">param_env</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>I just tried to get the <code>substs</code> through the hir parent node, but that also returns empty substs. This is in <code>from_opt_const_arg_anon_const</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hir_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">local_def_id_to_hir_id</span><span class="p">(</span><span class="n">def</span><span class="p">.</span><span class="n">did</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">parent_substs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">parent_hir_id</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">find_parent_node</span><span class="p">(</span><span class="n">hir_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">parent_did</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">opt_local_def_id</span><span class="p">(</span><span class="n">parent_hir_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">InternalSubsts</span>::<span class="n">identity_for_item</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">parent_did</span><span class="p">.</span><span class="n">to_def_id</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">tcx</span><span class="p">.</span><span class="n">mk_substs</span><span class="p">(</span><span class="nb">Vec</span>::<span class="o">&lt;</span><span class="n">GenericArg</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;</span>::<span class="n">new</span><span class="p">().</span><span class="n">into_iter</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">tcx</span><span class="p">.</span><span class="n">mk_substs</span><span class="p">(</span><span class="nb">Vec</span>::<span class="o">&lt;</span><span class="n">GenericArg</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;</span>::<span class="n">new</span><span class="p">().</span><span class="n">into_iter</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">parent_substs</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>What alternative way is there to get the parent substs if not through the hid parent node or <code>typeck_root_def_id</code>?</p>



<a name="277246274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277246274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277246274">(Mar 31 2022 at 08:08)</a>:</h4>
<p>Also don't understand how identity substs would even allow const eval to succeed here. Even if we would be able to substitute in <code>Param(X/#0)</code>, the call to <code>eval_to_const_value_raw</code> would fail. Why can <code>const_eval_resolve</code>with identity substs replace <code>try_eval_lit_or_param</code> here?</p>



<a name="277247811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277247811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277247811">(Mar 31 2022 at 08:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/277234832">said</a>:</p>
<blockquote>
<ul>
<li>you do not want the <code>substs</code> for the <code>typeck_root_def_id</code> at any point for generic const</li>
</ul>
<p>I do not think there exists any situation where we want to use that for anything else apart from <code>type_of</code></p>
</blockquote>
<p>what, that one is wrong, you do not ever want to use <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html#method.def_id_for_type_of">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html#method.def_id_for_type_of</a> for anything apart from <code>type_of</code></p>



<a name="277247900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277247900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277247900">(Mar 31 2022 at 08:27)</a>:</h4>
<p>so constants used by asm probably do not work like inline constants, but are instead typechecked checked separately from their parent</p>



<a name="277248091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248091">(Mar 31 2022 at 08:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/277246274">said</a>:</p>
<blockquote>
<p>Also don't understand how identity substs would even allow const eval to succeed here. Even if we would be able to substitute in <code>Param(X/#0)</code>, the call to <code>eval_to_const_value_raw</code> would fail. Why can <code>const_eval_resolve</code>with identity substs replace <code>try_eval_lit_or_param</code> here?</p>
</blockquote>
<p>const eval doesn't have to succeed</p>



<a name="277248103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248103">(Mar 31 2022 at 08:29)</a>:</h4>
<p>it just shouldn't ICE</p>



<a name="277248138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248138">(Mar 31 2022 at 08:30)</a>:</h4>
<p>fixing that is fairly annoying <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="277248244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248244">(Mar 31 2022 at 08:30)</a>:</h4>
<p>we're hitting one of the <code>min_const_generics</code> hacks and to fix that I would have to look at this myself</p>



<a name="277248275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248275">(Mar 31 2022 at 08:31)</a>:</h4>
<p>i guess the easiest solution for now is:</p>



<a name="277248345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248345">(Mar 31 2022 at 08:31)</a>:</h4>
<p>keep a method <code>from_anon_const</code> which looks into <code>blocks</code> and returns <code>ConstKind::Param</code> if its a generic param</p>



<a name="277248478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277248478">(Mar 31 2022 at 08:32)</a>:</h4>
<p>and apart from that you should be able to safely evaluate it with <code>InternalSubsts::identity_for_item(tcx, did)</code> and return <code>ConstKind::Unevaluated</code> if it fails</p>



<a name="277249050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277249050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277249050">(Mar 31 2022 at 08:37)</a>:</h4>
<p>above that method we prob want the following fixme:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// FIXME(const_generics): We currently have to special case parameters because `min_const_generics`</span>
<span class="c1">// does not provide the parents generics to anonymous constants. We still allow generic const</span>
<span class="c1">// parameters by themselves however, e.g. `N`.  These constants would cause an ICE if we were to</span>
<span class="c1">// ever try to substitute the generic parameters in their bodies.</span>
<span class="c1">//</span>
<span class="c1">// While this doesn't happen as these constants are always used as `ty::ConstKind::Param`, it does</span>
<span class="c1">// cause issues if we were to remove that special-case and try to evaluate the constant instead.</span>
</code></pre></div>



<a name="277249335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277249335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277249335">(Mar 31 2022 at 08:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248244">said</a>:</p>
<blockquote>
<p>we're hitting one of the <code>min_const_generics</code> hacks and to fix that I would have to look at this myself</p>
</blockquote>
<p>i am sorry that you have to stumble from one unrelated const generics issue to the next <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> really didn't expect valtrees to interact with so many issues</p>



<a name="277251182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277251182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277251182">(Mar 31 2022 at 08:56)</a>:</h4>
<p>Thanks I'll try that.</p>



<a name="277251244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277251244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277251244">(Mar 31 2022 at 08:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/277249335">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/277248244">said</a>:</p>
<blockquote>
<p>we're hitting one of the <code>min_const_generics</code> hacks and to fix that I would have to look at this myself</p>
</blockquote>
<p>i am sorry that you have to stumble from one unrelated const generics issue to the next <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> really didn't expect valtrees to interact with so many issues</p>
</blockquote>
<p>ok good that you say that. I was actually sort of worrying I was starting to get on your nerves for having to ask you all the time ^^</p>



<a name="277888853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277888853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277888853">(Apr 05 2022 at 14:41)</a>:</h4>
<p>I've implemented the valtree -&gt; ConstValue <a href="https://github.com/b-naber/rust/blob/78b82f903d9074db248bc90e7c801a1a64ca4463/compiler/rustc_const_eval/src/const_eval/valtrees.rs#L222-L402">conversion</a>. Can you take a look at this please, <span class="user-mention" data-user-id="216206">@lcnr</span> ?</p>



<a name="277995494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277995494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277995494">(Apr 06 2022 at 09:10)</a>:</h4>
<p>is that part of a PR?</p>



<a name="277995688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277995688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277995688">(Apr 06 2022 at 09:12)</a>:</h4>
<p>you should probably open a pr and get <span class="user-mention silent" data-user-id="120791">RalfJ</span> and <span class="user-mention silent" data-user-id="124288">oli</span> to look over it, don't know too much about how to deal with mir constants</p>



<a name="277995732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277995732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277995732">(Apr 06 2022 at 09:12)</a>:</h4>
<p>though you should change the signature to return <code>ConstValue</code> without the <code>Option</code> as that conversion should be infallible</p>



<a name="277995815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277995815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277995815">(Apr 06 2022 at 09:13)</a>:</h4>
<p>also, <code>let mut ecx = mk_eval_cx(tcx, DUMMY_SP, ty::ParamEnv::reveal_all(), false);</code> looks like it is using the wrong param env? Should use the one from <code>param_env_ty</code>? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="277999371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277999371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277999371">(Apr 06 2022 at 09:45)</a>:</h4>
<p>This function touches on the <code>ValTree::SliceOrStr</code> issue though and is what I would like some input on. Using <code>&amp;[u8]</code> for <code>ty::Ref(_, Slice | Str,  _)</code> simplifies both valtree construction and valtree -&gt; constvalue conversion. It would also very likely have better performance. I don't see why we want to start with encoding those as Leafs instead of <code>SliceOrStr</code> tbh. You mentioned in the PR that using <code>SliceOrStr</code> could lead to type equality problems, but as <span class="user-mention" data-user-id="120791">@RalfJ</span> replied there, if we always use <code>SliceOrStr</code> for <code>&amp;str</code> and <code>&amp;[&lt;integer_type&gt;]</code> there won't be any problems with type equality. Can you maybe address that, because I'm in favor of using <code>SliceOrStr</code>.</p>



<a name="277999552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/277999552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#277999552">(Apr 06 2022 at 09:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/277995815">said</a>:</p>
<blockquote>
<p>also, <code>let mut ecx = mk_eval_cx(tcx, DUMMY_SP, ty::ParamEnv::reveal_all(), false);</code> looks like it is using the wrong param env? Should use the one from <code>param_env_ty</code>? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>Don't think this is a problem, we don't directly use the <code>param_env</code>. We do the same in <code>const_to_valtree</code>.</p>



<a name="278000196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278000196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278000196">(Apr 06 2022 at 09:52)</a>:</h4>
<blockquote>
<p>Don't think this is a problem, we don't directly use the <code>param_env</code></p>
</blockquote>
<p>what do you mean with that? Why do we need to provide the param env if we don't use it?</p>



<a name="278000596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278000596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278000596">(Apr 06 2022 at 09:56)</a>:</h4>
<p>The eval ctxt needs a <code>param_env</code>, but we don't evaluate in these two functions, so the param_env can be empty.</p>



<a name="278000845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278000845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278000845">(Apr 06 2022 at 09:58)</a>:</h4>
<p>eh though we do evaluate in <code>const_to_valtree</code>, then I'm not sure why we can use an empty <code>ParamEnv</code> there (didnt write that function).</p>



<a name="278001226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278001226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278001226">(Apr 06 2022 at 10:02)</a>:</h4>
<p>nvm we pass in a param_env in <code>const_to_valtree</code>. I thought I had just copied that <code>mk_eval_cx</code> call from that function.</p>



<a name="278002013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278002013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278002013">(Apr 06 2022 at 10:09)</a>:</h4>
<blockquote>
<p>This function touches on the <code>ValTree::SliceOrStr</code> issue though and is what I would like some input on. Using <code>&amp;[u8]</code> for <code>ty::Ref(_, Slice | Str,  _)</code> simplifies both valtree construction and valtree -&gt; constvalue conversion. </p>
</blockquote>
<p>how that? you still need to deal with <code>&amp;[T]</code> using <code>Valtree::Branch</code>, and that impl can be fully reused for <code>&amp;[u8]</code> and probably nearly completely reused for <code>&amp;str</code>.</p>



<a name="278002056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278002056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278002056">(Apr 06 2022 at 10:10)</a>:</h4>
<blockquote>
<p>It would also very likely have better performance.</p>
</blockquote>
<p><span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span> definitely, which is why we have to avoid doing this until we're confident that we never regret that choice. Having bad perf is ok as long as there was never a time where we had good perf.</p>
<blockquote>
<p>You mentioned in the PR that using <code>SliceOrStr</code> could lead to type equality problems, but as <span class="user-mention silent" data-user-id="120791">RalfJ</span> replied there, if we always use <code>SliceOrStr</code> for <code>&amp;str</code> and <code>&amp;[&lt;integer_type&gt;]</code> there won't be any problems with type equality.</p>
</blockquote>
<p>I feel uncomfortable with that because it makes dealing with valtrees more complex. I don't believe that this variant meaningfully simplifies the implementation. I can give a few examples of things we may want in the future and which would get quite hairy with <code>SliceOrStr</code></p>



<a name="278002420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278002420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278002420">(Apr 06 2022 at 10:13)</a>:</h4>
<p><a href="https://github.com/rust-lang/project-const-generics/issues/23">project-const-generics#23</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">WithSlice</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">SLICE</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">M</span>: <span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">WithSlice</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>for this to ever compile, the impl would have to use <code>WithSlice&lt;Branch(2, Param(N), Param(M))&gt;</code>. If we have <code>SliceOrStr</code> we would now have to complicate substitution for constants by checking branches with <code>SliceOrStr</code> types on whether all children are values</p>



<a name="278002673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278002673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278002673">(Apr 06 2022 at 10:16)</a>:</h4>
<p>similarly if we want to allow <code>WithSlice&lt;&amp;[1, _]&gt;</code> and try to unify that with <code>WithSlice&lt;&amp;[1, 2]&gt;</code>. Here we should infer <code>_</code> to <code>2</code> and for that we again have to avoid the <code>SliceOrStr</code> representation (that also relies on <a href="https://github.com/rust-lang/project-const-generics/issues/23">project-const-generics#23</a>)</p>



<a name="278002904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278002904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278002904">(Apr 06 2022 at 10:18)</a>:</h4>
<p>So <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> <a href="https://github.com/rust-lang/project-const-generics/issues/23">project-const-generics#23</a> is my main concern here, because that is the only part of cg where we have to "look inside" valtrees</p>



<a name="278003018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278003018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278003018">(Apr 06 2022 at 10:20)</a>:</h4>
<p>idk, these things aren't impossible with that variant, but they get far more annoying and I want valtrees to remain as easy to reason about as possible</p>



<a name="278003769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278003769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278003769">(Apr 06 2022 at 10:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278002420">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/project-const-generics/issues/23">project-const-generics#23</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">WithSlice</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">SLICE</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">M</span>: <span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">WithSlice</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>for this to ever compile, the impl would have to use <code>WithSlice&lt;Branch(2, Param(N), Param(M))&gt;</code>. If we have <code>SliceOrStr</code> we would now have to complicate substitution for constants by checking branches with <code>SliceOrStr</code> types on whether all children are values</p>
</blockquote>
<p>In what way could the children not be values, because of padding?</p>



<a name="278003983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278003983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278003983">(Apr 06 2022 at 10:31)</a>:</h4>
<p>no, because the children are generic parameters</p>



<a name="278004175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004175">(Apr 06 2022 at 10:33)</a>:</h4>
<p>i <del>want</del><em>believe that our current best option is</em> to merge valtrees into <code>ty::Const</code> so that we end up with something similar to <a href="https://github.com/rust-lang/project-const-generics/issues/43">https://github.com/rust-lang/project-const-generics/issues/43</a></p>



<a name="278004295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004295">(Apr 06 2022 at 10:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278000596">said</a>:</p>
<blockquote>
<p>The eval ctxt needs a <code>param_env</code>, but we don't evaluate in these two functions, so the param_env can be empty.</p>
</blockquote>
<p>should still use the correct one if its trivially available, in case we do end up evaluating stuff there in the future</p>



<a name="278004432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004432">(Apr 06 2022 at 10:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004175">said</a>:</p>
<blockquote>
<p>i <del>want</del><em>believe that our current best option is</em> to merge valtrees into <code>ty::Const</code> so that we end up with something similar to <a href="https://github.com/rust-lang/project-const-generics/issues/43">https://github.com/rust-lang/project-const-generics/issues/43</a></p>
</blockquote>
<p>so the current <code>Valtree::Branch</code>would then contain <code>ty::Const</code> instead of <code>Valtree</code></p>



<a name="278004723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004723">(Apr 06 2022 at 10:39)</a>:</h4>
<p>When do we actually substitute the generic params in the <code>WithSlice</code> example. So the anon const in <code>WithSlice</code> would have the form <code>ty::Constkind::Value(Valtree::SliceOrStr(bytes))</code> before substitution?</p>



<a name="278004733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004733">(Apr 06 2022 at 10:39)</a>:</h4>
<p>What would <code>bytes</code> be then?</p>



<a name="278004804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004804">(Apr 06 2022 at 10:40)</a>:</h4>
<p>so the idea is that we would start with <code>WithSlice&lt;&amp;[N, M]&gt;</code> and substitute <code>N = 1</code> and <code>M = 2</code>. we then get <code>WithSlice&lt;&amp;[1, 2]&gt;</code></p>



<a name="278004830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004830">(Apr 06 2022 at 10:40)</a>:</h4>
<p>the first one has use <code>ConstKind::Branch</code> because its children references generic parameters</p>



<a name="278004852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004852">(Apr 06 2022 at 10:41)</a>:</h4>
<p>the second one would have to use <code>ConstKind::SliceOrStr([1, 2])</code></p>



<a name="278004937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278004937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278004937">(Apr 06 2022 at 10:42)</a>:</h4>
<p>yes thats how I thought it would be. But in the current implementation we also use <code>SliceOrStr</code> for the first?</p>



<a name="278005012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278005012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278005012">(Apr 06 2022 at 10:43)</a>:</h4>
<p>well, the current implementation doesn't consider <code>WithSlice&lt;&amp;[N, M]&gt;</code> to constrain <code>N</code> or <code>M</code> so and just uses <code>ConstKind::Unevaluated</code>.</p>



<a name="278005353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278005353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278005353">(Apr 06 2022 at 10:46)</a>:</h4>
<p>ok then we substitute and get a <code>SliceOrStr</code>.</p>
<blockquote>
<p>If we have SliceOrStr we would now have to complicate substitution for constants by checking branches with SliceOrStr types on whether all children are values</p>
</blockquote>
<p>But I still don't see how this complicates the actual substitutions.</p>



<a name="278005703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278005703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278005703">(Apr 06 2022 at 10:49)</a>:</h4>
<p>if substitution encounters <code>ConstKind::Branch</code>for a type which can be represented using <code>SliceOrStr</code> we always have to do</p>
<ul>
<li>continue substituting all branches</li>
<li>check if the results are all concrete<br>
    - if so, convert it to <code>SliceOrStr</code></li>
</ul>



<a name="278005706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278005706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278005706">(Apr 06 2022 at 10:50)</a>:</h4>
<p>Haven't read through project <a href="https://github.com/rust-lang/rust/issues/23">#23</a> yet, so that might be why we  talk at cross purposes</p>



<a name="278006014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278006014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278006014">(Apr 06 2022 at 10:53)</a>:</h4>
<p>and during unification or <code>ConstKind::Branch</code> with <code>SliceOrStr</code> we have to convert the elements of <code>SliceOrStr</code> back to <code>ConstKind::Value</code> so that we can zip them with the <code>ConstKind::Branch</code>, again being careful to convert it back to <code>SliceOrStr</code> if the resulting value is now fully inferred</p>



<a name="278006063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278006063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278006063">(Apr 06 2022 at 10:53)</a>:</h4>
<p>none if this is impossible, but it is annoying impl work and something people learning about this have to learn and understand</p>



<a name="278007193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278007193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278007193">(Apr 06 2022 at 11:05)</a>:</h4>
<p>We would just have to use layout information to index into the raw bytes correctly in order to convert it back into <code>Constkind::Value</code> though right?</p>



<a name="278007238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278007238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278007238">(Apr 06 2022 at 11:06)</a>:</h4>
<p>For unification I do understand the problem you're describing, but I still don't understand why substitutions are a problem ^^</p>



<a name="278007917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278007917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278007917">(Apr 06 2022 at 11:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278007193">said</a>:</p>
<blockquote>
<p>We would just have to use layout information to index into the raw bytes correctly in order to convert it back into <code>Constkind::Value</code> though right?</p>
</blockquote>
<p>substitution is <code>Branch</code> to <code>SliceOrStr</code>, so its the other way around. Convert a bunch of <code>ConstKind::Value</code> to one <code>ConstKind::SliceOrStr</code></p>



<a name="278007986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278007986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278007986">(Apr 06 2022 at 11:13)</a>:</h4>
<p>and yeah, for that we go <code>ConstKind::Value</code> -&gt; <code>ScalarInt</code> -&gt; <code>[u8]</code> which isn't overly complex, it's just one maybe 20 lines long function</p>



<a name="278008136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008136">(Apr 06 2022 at 11:15)</a>:</h4>
<p>but that's still more than no function at all <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> and I don't think that ways in which the invariant "always <code>SliceOrStr</code> if possible" can be broken are immediately obvious. And that already expects people to know that this invariant exists</p>



<a name="278008207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008207">(Apr 06 2022 at 11:15)</a>:</h4>
<p>So again, none of that means that <code>SliceOrStr</code> is impossible or that we won't add it in the future. But I do want to start without it as it using it does have a cost I don't want to pay yet</p>



<a name="278008370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008370">(Apr 06 2022 at 11:17)</a>:</h4>
<p>But in the proposal you want to not use any of the CTFE functionality, so something like <code>&amp;str</code>wouldn't be represented through a <code>ScalarPair</code> for which we can get the raw bytes directly, but instead be some kind of slice of <code>ConstKind::Value</code> elements?</p>



<a name="278008442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008442">(Apr 06 2022 at 11:18)</a>:</h4>
<p>If thats the case the benefit of using <code>SliceOrStr</code> wouldn't be there in the first place anyway afaict.</p>



<a name="278008634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008634">(Apr 06 2022 at 11:20)</a>:</h4>
<p>you're talking about <a href="https://github.com/rust-lang/project-const-generics/issues/43">project-const-generics#43</a>?</p>
<blockquote>
<p>As we have to evaluate <code>ty::Const</code> without them being typechecked, we can't just use the existing CTFE for this. We would therefore have to add some special evaluation code for <code>Expr</code>, though that could share its implementation with CTFE.</p>
</blockquote>



<a name="278008720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008720">(Apr 06 2022 at 11:21)</a>:</h4>
<p>probably should elaborate on that a bit in the doc <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> we still want ctfe for as much as possible so we will still need to convert ctfe results to <code>ty::Const</code> in some places</p>



<a name="278008815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008815">(Apr 06 2022 at 11:22)</a>:</h4>
<p>and <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/ast/enum.LitKind.html#variant.ByteStr">byte string literals</a> are stored in the hir as <code>[u8]</code> so for these it would be nice to store them as <code>[u8]</code> even without interacting with ctfe</p>



<a name="278008919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008919">(Apr 06 2022 at 11:23)</a>:</h4>
<p>i am not sure how much evaluation we will need outside of ctfe but I would expect that we mostly leave slices and strings alone</p>



<a name="278008970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278008970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278008970">(Apr 06 2022 at 11:24)</a>:</h4>
<p>the moment constants call a function, we can hand it off to ctfe again</p>



<a name="278042807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278042807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278042807">(Apr 06 2022 at 15:38)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> , <span class="user-mention" data-user-id="120791">@RalfJ</span> How can you get an <code>MplaceTy</code> that corresponds to the value behind an <code>Immediate::ScalarPair</code>? Given this place:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span>::<span class="n">const_to_valtree_inner</span><span class="w"> </span><span class="n">place</span><span class="o">=</span><span class="n">MPlaceTy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mplace</span>: <span class="nc">MemPlace</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span>: <span class="nc">alloc2</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">meta</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">TyAndLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span>: <span class="nc">Arbitrary</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offsets</span>: <span class="p">[</span><span class="n">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">8</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="n">memory_index</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">variants</span>: <span class="nc">Single</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">ScalarPair</span><span class="p">(</span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Int</span><span class="p">(</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">0</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">largest_niche</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Niche</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">scalar</span>: <span class="nc">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">align</span>: <span class="nc">AbiAndPrefAlign</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">pref</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">size</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>which corresponds to the <code>Immediate</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span><span class="w"> </span><span class="n">imm_ty</span><span class="o">=</span><span class="n">ImmTy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">imm</span>: <span class="nc">ScalarPair</span><span class="p">(</span><span class="n">alloc4</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000000000000005</span><span class="p">),</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">TyAndLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span>: <span class="nc">Arbitrary</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offsets</span>: <span class="p">[</span><span class="n">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">8</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="n">memory_index</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">variants</span>: <span class="nc">Single</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">ScalarPair</span><span class="p">(</span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Int</span><span class="p">(</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">0</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">largest_niche</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Niche</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">scalar</span>: <span class="nc">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">align</span>: <span class="nc">AbiAndPrefAlign</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">pref</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">size</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>If you call <code>deref_operand</code>on this place you get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span><span class="w"> </span><span class="n">derefd_place</span><span class="o">=</span><span class="n">MPlaceTy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mplace</span>: <span class="nc">MemPlace</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span>: <span class="nc">alloc4</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">meta</span>: <span class="nc">Meta</span><span class="p">(</span><span class="mh">0x0000000000000005</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">TyAndLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span>: <span class="nc">Array</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stride</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">count</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">variants</span>: <span class="nc">Single</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Aggregate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sized</span>: <span class="nc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">largest_niche</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">AbiAndPrefAlign</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">pref</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">size</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which cannot be used in  a <code>branches</code> call in <code>const_to_valtree</code>, since you cannot call <code>mplace_field</code> on it given that <code>layout: Layout { fields: Array { stride: Size { raw: 1 }, count: 0 }</code>. I do know how to get the raw bytes behind the <code>ScalarPair</code> and could (somewhat awkwardly) iterate through that raw bytes slice to create the <code>Leaf</code>s, but I was wondering whether there exists a more reasonable approach.</p>



<a name="278043727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278043727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278043727">(Apr 06 2022 at 15:44)</a>:</h4>
<p>hm.... we do have mplace_index, does that do what you want?</p>



<a name="278048992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278048992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278048992">(Apr 06 2022 at 16:19)</a>:</h4>
<p>No, it doesn't unfortunately. </p>
<p>If I call <code>deref_operand</code> on the first MPlace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span>::<span class="n">const_to_valtree_inner</span><span class="w"> </span><span class="n">place</span><span class="o">=</span><span class="n">MPlaceTy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mplace</span>: <span class="nc">MemPlace</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span>: <span class="nc">alloc3</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">meta</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">TyAndLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span>: <span class="nc">Arbitrary</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offsets</span>: <span class="p">[</span><span class="n">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">8</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="n">memory_index</span>: <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">variants</span>: <span class="nc">Single</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">ScalarPair</span><span class="p">(</span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Int</span><span class="p">(</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">0</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">largest_niche</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Niche</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">scalar</span>: <span class="nc">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">align</span>: <span class="nc">AbiAndPrefAlign</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">pref</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">size</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">16</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and get back this dereferenced place:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span><span class="w"> </span><span class="n">derefd</span>: <span class="nc">MPlaceTy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mplace</span>: <span class="nc">MemPlace</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span>: <span class="nc">alloc2</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">meta</span>: <span class="nc">Meta</span><span class="p">(</span><span class="mh">0x0000000000000005</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">TyAndLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span>: <span class="nc">Array</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stride</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">count</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">variants</span>: <span class="nc">Single</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Aggregate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sized</span>: <span class="nc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">largest_niche</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">AbiAndPrefAlign</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">pref</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">size</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>What exactly is this new dereferenced place? Why is its layout an Array with count 0, whereas the <code>ScalarPair</code> behind the first <code>Mplace</code> has length 0x5 has its second value?</p>



<a name="278050926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278050926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278050926">(Apr 06 2022 at 16:33)</a>:</h4>
<p>because it's an unsized place</p>



<a name="278050941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278050941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278050941">(Apr 06 2022 at 16:33)</a>:</h4>
<p>but indexing uses the meta information for unsized places</p>



<a name="278050995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278050995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278050995">(Apr 06 2022 at 16:33)</a>:</h4>
<p><code>mplace_index</code> should work on the dereferenced place afaict</p>



<a name="278051823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278051823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278051823">(Apr 06 2022 at 16:39)</a>:</h4>
<p>Thanks a lot, you're right <code>mplace_index</code> does exactly what I need here. Must have called that on the wrong <code>MPlace</code>, sorry for confusion.</p>



<a name="278068796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278068796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278068796">(Apr 06 2022 at 18:46)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> is the <code>ScalarPair</code> a (wide) pointer? then you are looking for ref_to_mplace</p>



<a name="278126347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278126347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278126347">(Apr 07 2022 at 07:28)</a>:</h4>
<p>Yes the <code>ScalarPair</code> is a wide pointer. <code>ref_to_mplace</code> does what I need (though it's also basically doing the job that <code>deref_operand</code> "does", in the sense that <code>deref_operand</code> takes an <code>MPlaceTy</code>, reads the immediate from that place and then calls <code>ref_to_mplace</code>). My problem was that I didn't understand how CTFE handles unsized types and was confused that the <code>mplace_field</code> functionality doesn't work on unsized types, but <code>mplace_index</code> does offer that functionality, so that solved my problem.</p>



<a name="278126719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278126719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278126719">(Apr 07 2022 at 07:32)</a>:</h4>
<p>Think we could improve the docs for those two functions a little bit. For <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_const_eval/interpret/eval_context/struct.InterpCx.html#method.mplace_field"><code>mplace_field</code></a> what does 'the index type is restricting' mean here: 'This also works for arrays, but then the usize index type is restricting'? </p>
<p>We should probably add that <code>mplace_index</code> also works on unsized types (and maybe add how to handle slices, i.e. <code>deref_operand</code> -&gt; <code>mplace_index</code> to index into underlying array).</p>



<a name="278149108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149108">(Apr 07 2022 at 11:28)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span>  do we actually get <code>&amp;[T]</code> types during valtree construction in general?  It seems that CTFE automatically converts them to arrays. E.g. in </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="p">[</span><span class="n">Foo</span><span class="p">])</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]);</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">S</span>: <span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="p">[</span><span class="n">Foo</span><span class="p">])</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">test</span>::<span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The type for the second element is <code>&amp;[Foo; 2]</code>. The only types for which I actually get slices are <code>&amp;str</code> and byte strings.</p>



<a name="278149444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149444">(Apr 07 2022 at 11:31)</a>:</h4>
<p>what happens for</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">W</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="278149496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149496">(Apr 07 2022 at 11:31)</a>:</h4>
<blockquote>
<p>The type for the second element is <code>&amp;[Foo; 2]</code></p>
</blockquote>
<p>though that does seem weird to me</p>



<a name="278149730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149730">(Apr 07 2022 at 11:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149444">said</a>:</p>
<blockquote>
<p>what happens for</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">W</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">eval_queries</span>::<span class="n">turn_into_const_value</span><span class="w"> </span><span class="n">constant</span><span class="o">=</span><span class="n">ConstAlloc</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">alloc_id</span>: <span class="nc">alloc2</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">ParamEnvAnd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param_env</span>: <span class="nc">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">Const</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">value</span>: <span class="nc">GlobalId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance</span>: <span class="nc">Instance</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">Item</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">3</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">test</span><span class="p">[</span><span class="mi">97</span><span class="n">d8</span><span class="p">]</span>::<span class="n">W</span><span class="p">),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">}),</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">promoted</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278149798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149798">(Apr 07 2022 at 11:33)</a>:</h4>
<p>interesting, and that doesn't happen for <code>[u8]</code></p>



<a name="278149884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149884">(Apr 07 2022 at 11:34)</a>:</h4>
<p>or what about <code>const W: &amp;'static [Foo] = &amp;[Foo(1, 2), Foo(2, 3)][1..2];</code></p>



<a name="278149951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149951">(Apr 07 2022 at 11:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149884">said</a>:</p>
<blockquote>
<p>or what about <code>const W: &amp;'static [Foo] = &amp;[Foo(1, 2), Foo(2, 3)][1..2];</code></p>
</blockquote>
<p>dont think you can index with a range in constants (yet)</p>



<a name="278149966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278149966">(Apr 07 2022 at 11:35)</a>:</h4>
<p>Think I tried that out, but can try again...</p>



<a name="278150085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150085">(Apr 07 2022 at 11:36)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0015</span><span class="p">]</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="k">const</span><span class="w"> </span><span class="n">operator</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">constants</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">test</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">31</span>:<span class="mi">28</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">31</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">W</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)][</span><span class="mi">1</span><span class="o">..</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                            </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">calls</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">constants</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">limited</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="n">functions</span><span class="p">,</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="n">structs</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="n">variants</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">aborting</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="n">emitted</span><span class="w"></span>
</code></pre></div>



<a name="278150218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150218">(Apr 07 2022 at 11:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278149798">said</a>:</p>
<blockquote>
<p>interesting, and that doesn't happen for <code>[u8]</code></p>
</blockquote>
<p>If you pass in a reference to an array you don't get a slice (even if the type annotation for the constant uses a slice). The only case in which you get a <code>&amp;[u8]</code> are byte strings.</p>



<a name="278150305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150305">(Apr 07 2022 at 11:38)</a>:</h4>
<p><code>const W: &amp;'static [Foo] = match &amp;[Foo(1, 2), Foo(2, 3)] {
    [x @ .., _] =&gt; x,
};</code></p>



<a name="278150409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150409">(Apr 07 2022 at 11:39)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">to_slice</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">W</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">to_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="o">..</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="278150446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150446">(Apr 07 2022 at 11:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150305">said</a>:</p>
<blockquote>
<p><code>const W: &amp;'static [Foo] = match &amp;[Foo(1, 2), Foo(2, 3)] {
    [x @ .., _] =&gt; x,
};</code></p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">eval_queries</span>::<span class="n">turn_into_const_value</span><span class="w"> </span><span class="n">constant</span><span class="o">=</span><span class="n">ConstAlloc</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">alloc_id</span>: <span class="nc">alloc2</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">ParamEnvAnd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param_env</span>: <span class="nc">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">Const</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">value</span>: <span class="nc">GlobalId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance</span>: <span class="nc">Instance</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">Item</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">3</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">test</span><span class="p">[</span><span class="mi">97</span><span class="n">d8</span><span class="p">]</span>::<span class="n">W</span><span class="p">),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">}),</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">promoted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278150499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150499">(Apr 07 2022 at 11:40)</a>:</h4>
<p>yeah, so that's the type of the allocation, not of our constant</p>



<a name="278150513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150513">(Apr 07 2022 at 11:40)</a>:</h4>
<p>because the constant has type <code>&amp;[Foo]</code> with length 1</p>



<a name="278150936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150936">(Apr 07 2022 at 11:45)</a>:</h4>
<p>But we do match on the type of the <code>MPlaceTy</code> in <code>const_to_valtree</code></p>



<a name="278150953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278150953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278150953">(Apr 07 2022 at 11:45)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span>::<span class="n">const_to_valtree_inner</span><span class="w"> </span><span class="n">place</span><span class="o">=</span><span class="n">MPlaceTy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mplace</span>: <span class="nc">MemPlace</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span>: <span class="nc">alloc2</span><span class="p">,</span><span class="w"> </span><span class="n">align</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">meta</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">TyAndLayout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fields</span>: <span class="nc">Primitive</span><span class="p">,</span><span class="w"> </span><span class="n">variants</span>: <span class="nc">Single</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Scalar</span><span class="p">(</span><span class="n">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">largest_niche</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Niche</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">offset</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">scalar</span>: <span class="nc">Scalar</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">valid_range</span>: <span class="mi">1</span><span class="o">..=</span><span class="mi">18446744073709551615</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">align</span>: <span class="nc">AbiAndPrefAlign</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">abi</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">pref</span>: <span class="nc">Align</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pow2</span>: <span class="mi">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">size</span>: <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">raw</span>: <span class="mi">8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278151286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151286">(Apr 07 2022 at 11:48)</a>:</h4>
<p>is the <code>ty</code> for the original <code>ConstAlloc</code> already wrong?</p>



<a name="278151342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151342">(Apr 07 2022 at 11:49)</a>:</h4>
<p>i.e. does <code>const_to_valtree</code> start with a <code>ConstAlloc</code> with a slice type</p>



<a name="278151347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151347">(Apr 07 2022 at 11:49)</a>:</h4>
<p>or is that already an array there?</p>



<a name="278151361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151361">(Apr 07 2022 at 11:49)</a>:</h4>
<p>already an array</p>



<a name="278151370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151370">(Apr 07 2022 at 11:49)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> xx</p>



<a name="278151374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151374">(Apr 07 2022 at 11:49)</a>:</h4>
<p>that sucks</p>



<a name="278151444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151444">(Apr 07 2022 at 11:50)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="278151465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151465">(Apr 07 2022 at 11:50)</a>:</h4>
<p>does that mean we need to pass the "expected type" into <code>const_to_valtree</code></p>



<a name="278151490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278151490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278151490">(Apr 07 2022 at 11:50)</a>:</h4>
<p>idk how exactly that should work</p>



<a name="278152102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278152102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278152102">(Apr 07 2022 at 11:56)</a>:</h4>
<p>Why do we need the expected type in the first place?</p>



<a name="278152146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278152146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278152146">(Apr 07 2022 at 11:56)</a>:</h4>
<p>Why can't we work with arrays?</p>



<a name="278153203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278153203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278153203">(Apr 07 2022 at 12:05)</a>:</h4>
<p>the type of the allocation doesn't matter for valtrees, so if the type impacts the resulting valtrees that's a bug</p>



<a name="278153320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278153320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278153320">(Apr 07 2022 at 12:06)</a>:</h4>
<p>e.g. if you have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">W</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="o">..</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">P</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)];</span><span class="w"></span>
</code></pre></div>



<a name="278153328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278153328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278153328">(Apr 07 2022 at 12:06)</a>:</h4>
<p>the valtrees for <code>W</code> and <code>P</code> should unify</p>



<a name="278153346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278153346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278153346">(Apr 07 2022 at 12:06)</a>:</h4>
<p>even though their allocations had different types</p>



<a name="278159732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278159732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278159732">(Apr 07 2022 at 12:57)</a>:</h4>
<p>yeaaa... that is a big hack in <code>const_deref</code></p>



<a name="278159938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278159938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278159938">(Apr 07 2022 at 12:59)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/ed6c958ee4bf081deec951996ace9c508360c1d9/compiler/rustc_const_eval/src/const_eval/mod.rs#L199">https://github.com/rust-lang/rust/blob/ed6c958ee4bf081deec951996ace9c508360c1d9/compiler/rustc_const_eval/src/const_eval/mod.rs#L199</a></p>



<a name="278191413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278191413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278191413">(Apr 07 2022 at 16:33)</a>:</h4>
<p><code>deref_const</code> is never called in <span class="user-mention" data-user-id="216206">@lcnr</span> s examples and the hack there might still be a problem, but there isn't actually a problem with the types in those examples. I didn't realize that we create two valtrees in <code>const P: &amp;'static [Foo] = &amp;[Foo(1, 2)];</code> and got ICEs during the first <code>const_to_valtree</code> call. In the second call we do actually get the slice type:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">├─┐</span><span class="n">rustc_const_eval</span>::<span class="n">const_eval</span>::<span class="n">valtrees</span>::<span class="n">const_to_valtree</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">UserFacing</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">Const</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">raw</span><span class="o">=</span><span class="n">ConstAlloc</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">alloc_id</span>: <span class="nc">alloc1</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Foo</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The same holds für <code>const W</code>.</p>



<a name="278404045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278404045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278404045">(Apr 09 2022 at 11:13)</a>:</h4>
<p>We need to create a <code>VariantIdx</code> from the <code>ScalarInt</code> that is in a <code>Leaf</code> in the valtree -&gt; const value conversion. For the variant in <code>ty::Adt</code> we currently use <code>ty::ValTree::Leaf(ScalarInt::from(variant.as_u32()))</code> during valtree construction, so  a <code>try_to_machine_usize</code> call on the <code>ScalarInt</code> in that <code>Leaf</code> fails on some machines. There is no way to create a <code>ScalarInt</code> from <code>usize</code>. Is there some other way to read the integer from <code>ScalarInt</code> besides <code>try_to_machine_usize</code>?</p>



<a name="278413384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278413384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278413384">(Apr 09 2022 at 14:44)</a>:</h4>
<p>You could cast to u64 first, that'll always hold all possible values</p>



<a name="278471205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278471205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278471205">(Apr 10 2022 at 14:31)</a>:</h4>
<p>But afaict the problem is the <code>size</code> value of the <code>ScalarInt</code>, which depends on the <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/ty/consts/int.rs.html#242"><code>from</code></a> call we use to create that <code>ScalarInt</code> and which <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/ty/consts/int.rs.html#237-239"><code>try_to_machine_usize</code></a> <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/ty/consts/int.rs.html#228">requires</a> to be the same as the <code>pointer_size</code> of the machine. So I think we would need to create the <code>ScalarInt</code> from a <code>usize</code> (but there isn't a <code>from</code> implementation for that for whatever reason) and everything else would result in platform-dependent problems afaict.</p>



<a name="278472432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278472432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278472432">(Apr 10 2022 at 14:56)</a>:</h4>
<p>remember that machine_usize != <code>usize</code></p>



<a name="278472440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278472440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278472440">(Apr 10 2022 at 14:56)</a>:</h4>
<p><code>usize</code> might be 32bit and machine_usize 64bit</p>



<a name="278472444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278472444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278472444">(Apr 10 2022 at 14:57)</a>:</h4>
<p>when you are on a 32bit host cross-compiling for a 64bit target</p>



<a name="278525100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278525100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278525100">(Apr 11 2022 at 08:58)</a>:</h4>
<p>ok thanks, that explains why <code>From&lt;usize&gt;</code> isn't implemented.  I still don't know how to handle the problem though. If we use <code>from_u64</code> to create the <code>ScalarInt</code>, then use <code>try_to_machine_usize</code> when reading from the <code>ScalarInt</code> on a 32-bit machine the call will fail.</p>



<a name="278533795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278533795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278533795">(Apr 11 2022 at 10:25)</a>:</h4>
<p>You'll want to use <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.ScalarInt.html#method.try_from_uint">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.ScalarInt.html#method.try_from_uint</a> with <code>tcx.data_layout.pointer_size</code>, this will error if your usize is too large for <code>usize</code> on the target</p>



<a name="278543485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278543485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278543485">(Apr 11 2022 at 12:08)</a>:</h4>
<p>I am confused, what even is it you want to do?</p>
<blockquote>
<p>in ty::Adt we currently use ty::ValTree::Leaf(ScalarInt::from(variant.as_u32())) during valtree construction, so a try_to_machine_usize call on the ScalarInt in that Leaf fails on some machines</p>
</blockquote>
<p>Yeah, it should be <code>u32</code> then and not <code>machine_usize</code>. so that's wrong with using <code>to_u32</code> as the existing code does?</p>



<a name="278543615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278543615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278543615">(Apr 11 2022 at 12:10)</a>:</h4>
<p><code>VariantIdx</code> seems to always be 32bit, no matter the host or target</p>



<a name="278543636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278543636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278543636">(Apr 11 2022 at 12:10)</a>:</h4>
<p>so, there shouldn't me any usize involved anywhere here. what am I missing?</p>



<a name="278571863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278571863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278571863">(Apr 11 2022 at 15:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278533795">said</a>:</p>
<blockquote>
<p>You'll want to use <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.ScalarInt.html#method.try_from_uint">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.ScalarInt.html#method.try_from_uint</a> with <code>tcx.data_layout.pointer_size</code>, this will error if your usize is too large for <code>usize</code> on the target</p>
</blockquote>
<p>thanks</p>



<a name="278572187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278572187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278572187">(Apr 11 2022 at 15:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/260443-project-const-generics/topic/valtrees/near/278543636">said</a>:</p>
<blockquote>
<p>so, there shouldn't me any usize involved anywhere here. what am I missing?</p>
</blockquote>
<p>The problem was that I needed to get some uint type out of <code>ScalarInt</code> and the only way to do that is <code>try_to_machine_usize</code> afaict (or is there some other way?), which requires the target pointer size to match the size of the type with which the <code>ScalarInt</code> was created with the existing <code>From</code> implementations.  But <code>try_from_uint</code> works since you can manually supply a pointer size, so everything's good now^^</p>



<a name="278578875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278578875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278578875">(Apr 11 2022 at 16:22)</a>:</h4>
<p><code>ScalarInt</code> should just have <code>try_to_u32</code> then</p>



<a name="278578899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278578899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278578899">(Apr 11 2022 at 16:22)</a>:</h4>
<p><code>Scalar</code> has all these helper methods, we probably were just too lazy to add them to <code>ScalarInt</code></p>



<a name="278578985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278578985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278578985">(Apr 11 2022 at 16:23)</a>:</h4>
<p>so ignore which methods exist. the important part is figuring out what the size of your <code>ScalarInt</code> is. Is it a machine usize or a u32?</p>



<a name="278579004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278579004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278579004">(Apr 11 2022 at 16:23)</a>:</h4>
<p>if its a u32 you cannot use <code>to_machine_usize</code> for hopefully obvious reasons ;)</p>



<a name="278692420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/valtrees/near/278692420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/valtrees.html#278692420">(Apr 12 2022 at 13:29)</a>:</h4>
<p>I've opened a <a href="https://github.com/rust-lang/rust/pull/95976">PR</a> for the valtree -&gt; constvalue conversion functionality. Wasn't really sure about the checks we need to perform there, so there might still be quite a bit to work on here.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>