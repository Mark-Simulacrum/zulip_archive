<html>
<head><meta charset="utf-8"><title>inline consts typeck · project-const-generics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/index.html">project-const-generics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html">inline consts typeck</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="238275645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238275645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238275645">(May 11 2021 at 09:12)</a>:</h4>
<p>I would like to get inline consts to be typechecked together with their parent body in the near future.</p>
<p>Either by implementing this myself or, preferably, by mentoring someone else <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span></p>



<a name="238275686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238275686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238275686">(May 11 2021 at 09:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> are you still interested in working on this?</p>



<a name="238307241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238307241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238307241">(May 11 2021 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>, yes I am</p>



<a name="238307296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238307296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238307296">(May 11 2021 at 13:31)</a>:</h4>
<p>I was a bit absent for the last 2/3 weeks but I'm back to work on rustc, so <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="238307517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238307517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238307517">(May 11 2021 at 13:33)</a>:</h4>
<p>can you explain a bit what's the current status of things, what do we need to accomplish and ideas on how to accomplish it?</p>



<a name="238317321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238317321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238317321">(May 11 2021 at 14:30)</a>:</h4>
<p>the current status is still your original implementation, in which we typecheck inline consts separately with an inference variable as the expected return type and use the resulting type when typechecking their containing body</p>



<a name="238317826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238317826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238317826">(May 11 2021 at 14:34)</a>:</h4>
<p>what i want you to accomplish is getting the following to compile</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="238318106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238318106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238318106">(May 11 2021 at 14:35)</a>:</h4>
<p>the way to do it is to typeck inline consts together with their parent body by mostly copying what we're doing for closures (i expect)</p>



<a name="238318357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238318357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238318357">(May 11 2021 at 14:36)</a>:</h4>
<p>i haven't looked at the code too deeply so I can't tell you exactly what needs to be done, if you want we can take an hour to talk about this in sync</p>



<a name="238318614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238318614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238318614">(May 11 2021 at 14:38)</a>:</h4>
<p>if you have a rough idea where to start and want to figure this out on your own that's also fine for me, but no matter what you do, feel free to ask whenever you don't know exactly what to do ^^</p>



<a name="238319108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319108">(May 11 2021 at 14:41)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>, let me see because I'm also doing other things but will definitely ask or sync with you</p>



<a name="238319150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319150">(May 11 2021 at 14:41)</a>:</h4>
<p>btw, how urgent is this? or when are you expecting to have a working version of it?</p>



<a name="238319181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319181">(May 11 2021 at 14:41)</a>:</h4>
<p>like most things in rust</p>



<a name="238319200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319200">(May 11 2021 at 14:41)</a>:</h4>
<p>it would be good to get it done <em>soon</em></p>



<a name="238319220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319220">(May 11 2021 at 14:41)</a>:</h4>
<p>but there is no time limit here</p>



<a name="238319452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319452">(May 11 2021 at 14:43)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> if you think that you don't have any time to work on it during the next 30 days it might make sense to let someone else do it</p>



<a name="238319469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238319469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238319469">(May 11 2021 at 14:43)</a>:</h4>
<p>apart from that take your time ^^</p>



<a name="238326238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238326238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238326238">(May 11 2021 at 15:22)</a>:</h4>
<p>yeah, I think I can do it</p>



<a name="238685858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238685858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238685858">(May 13 2021 at 21:45)</a>:</h4>
<p>ah I'd be interested in this</p>



<a name="238685881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/238685881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#238685881">(May 13 2021 at 21:45)</a>:</h4>
<p>I also still want to understasnd the need for that defid-hack and not need it :)</p>



<a name="239190448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/239190448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#239190448">(May 18 2021 at 02:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/238685881">said</a>:</p>
<blockquote>
<p>I also still want to understasnd the need for that defid-hack and not need it :)</p>
</blockquote>
<p>which defid-hack?</p>



<a name="239222646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/239222646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#239222646">(May 18 2021 at 09:20)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.WithOptConstParam.html</a></p>



<a name="246884926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246884926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246884926">(Jul 22 2021 at 18:10)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span></p>



<a name="246884948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246884948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246884948">(Jul 22 2021 at 18:10)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="246884958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246884958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246884958">(Jul 22 2021 at 18:10)</a>:</h4>
<p>OK. so</p>



<a name="246884972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246884972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246884972">(Jul 22 2021 at 18:10)</a>:</h4>
<p>let me skim this thread a bit</p>



<a name="246885006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885006">(Jul 22 2021 at 18:11)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="246885049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885049">(Jul 22 2021 at 18:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/238317321">said</a>:</p>
<blockquote>
<p>the current status is still your original implementation, in which we typecheck inline consts separately with an inference variable as the expected return type and use the resulting type when typechecking their containing body</p>
</blockquote>
<p>where does this happen in the code?</p>



<a name="246885068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885068">(Jul 22 2021 at 18:11)</a>:</h4>
<p>we have also this information that was the write up for the inline consts being one of the blockers of const generics ...</p>



<a name="246885075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885075">(Jul 22 2021 at 18:11)</a>:</h4>
<div class="codehilite"><pre><span></span><code>## inline consts

Current state:

fn test() -&gt; usize {
    const { 3 }
}

The above breaks because `3` is type-checked in its own context, its type defaults to `i32`, and we get compilation errors.

**Proposal:** Inline consts getting typechecked together with their parent is really desirable.

trait Foo {}
fn foo&lt;T: Foo&gt;(_: T) {}
impl Foo for u32 {}
impl Foo for () {}
foo(const { 3 });

Inline consts should also be able to depend on generic parameters and participate in `ConstEvaluatable` checking.

This however requires the mir of inline consts. The idea is therefore to typeck them in a similar fashion to closures. Then after typeck we check their evaluatability in a separate query.

That seems surprisingly straightforward :O
</code></pre></div>



<a name="246885208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885208">(Jul 22 2021 at 18:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/246885049">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/238317321">said</a>:</p>
<blockquote>
<p>the current status is still your original implementation, in which we typecheck inline consts separately with an inference variable as the expected return type and use the resulting type when typechecking their containing body</p>
</blockquote>
<p>where does this happen in the code?</p>
</blockquote>
<p>let me see</p>



<a name="246885220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885220">(Jul 22 2021 at 18:12)</a>:</h4>
<p>checking this ... <a href="https://github.com/rust-lang/rust/pull/77124/commits/85b5ce264324c75eb4c67849bc42de5526ed9208">https://github.com/rust-lang/rust/pull/77124/commits/85b5ce264324c75eb4c67849bc42de5526ed9208</a></p>



<a name="246885496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885496">(Jul 22 2021 at 18:15)</a>:</h4>
<p>let me step back a sec</p>



<a name="246885503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885503">(Jul 22 2021 at 18:15)</a>:</h4>
<p>but yeah all it does is let's get the const using existing infrastructure and no much else</p>



<a name="246885511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885511">(Jul 22 2021 at 18:15)</a>:</h4>
<p>inline constants, how are they represented in the HIR?</p>



<a name="246885685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885685">(Jul 22 2021 at 18:16)</a>:</h4>
<p><code>ExprKind::ConstBlock(AnonConst)</code></p>



<a name="246885737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885737">(Jul 22 2021 at 18:17)</a>:</h4>
<p>ok</p>



<a name="246885826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885826">(Jul 22 2021 at 18:18)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/113bd9a349915227c880a938fa305c332cbbbcd4/compiler/rustc_typeck/src/check/expr.rs?plain=1#L290">https://github.com/rust-lang/rust/blob/113bd9a349915227c880a938fa305c332cbbbcd4/compiler/rustc_typeck/src/check/expr.rs?plain=1#L290</a></p>



<a name="246885880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885880">(Jul 22 2021 at 18:18)</a>:</h4>
<p>I wonder how in general, not related to inline consts, how do we type check this kind of things</p>



<a name="246885894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885894">(Jul 22 2021 at 18:18)</a>:</h4>
<p>oh, not that</p>



<a name="246885900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885900">(Jul 22 2021 at 18:18)</a>:</h4>
<p>like even <code>let x: u32 = expr;</code></p>



<a name="246885912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885912">(Jul 22 2021 at 18:18)</a>:</h4>
<p>how do we type check expr with the parent</p>



<a name="246885938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885938">(Jul 22 2021 at 18:18)</a>:</h4>
<p>oh,, well, yes that</p>



<a name="246885950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246885950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246885950">(Jul 22 2021 at 18:18)</a>:</h4>
<p>ok so</p>



<a name="246886050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886050">(Jul 22 2021 at 18:19)</a>:</h4>
<p>we wind up creating an "unevaluated" constant</p>



<a name="246886122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886122">(Jul 22 2021 at 18:20)</a>:</h4>
<p>with the def-id</p>



<a name="246886159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886159">(Jul 22 2021 at 18:20)</a>:</h4>
<p>yeah</p>



<a name="246886201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886201">(Jul 22 2021 at 18:20)</a>:</h4>
<p>I'm thinking</p>



<a name="246886232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886232">(Jul 22 2021 at 18:21)</a>:</h4>
<p>I feel like I need to "zoom out" a bit to bring enough stuff back in cache here...</p>



<a name="246886255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886255">(Jul 22 2021 at 18:21)</a>:</h4>
<p>what <span class="user-mention" data-user-id="216206">@lcnr</span> was saying earlier about closures feels right to me</p>



<a name="246886282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886282">(Jul 22 2021 at 18:21)</a>:</h4>
<p>in principle, closures are distinct functions, but we type check the surrounding function and all of its closures in one inference context</p>



<a name="246886398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886398">(Jul 22 2021 at 18:22)</a>:</h4>
<p>this is why you see code like this in the impl of various queries:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="c1">// Closures' typeck results come from their outermost function,</span>
<span class="w">    </span><span class="c1">// as they are part of the same "inference environment".</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">outer_def_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">closure_base_def_id</span><span class="p">(</span><span class="n">def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">outer_def_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">def_id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">has_typeck_results</span><span class="p">(</span><span class="n">outer_def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="246886438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886438">(Jul 22 2021 at 18:22)</a>:</h4>
<p>e.g., if we ask for the "typeck results" of a closure, it will redirect and instead ask for the typeck results of the closure creator</p>



<a name="246886450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886450">(Jul 22 2021 at 18:22)</a>:</h4>
<p>I see</p>



<a name="246886484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886484">(Jul 22 2021 at 18:23)</a>:</h4>
<p>makes sense</p>



<a name="246886502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886502">(Jul 22 2021 at 18:23)</a>:</h4>
<p>constants work differently</p>



<a name="246886516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886516">(Jul 22 2021 at 18:23)</a>:</h4>
<p>at least today</p>



<a name="246886669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886669">(Jul 22 2021 at 18:24)</a>:</h4>
<p>but I'm trying to put it all together in my head</p>



<a name="246886704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886704">(Jul 22 2021 at 18:24)</a>:</h4>
<p>I guess that for the purposes of typeck, the value of a const expression is irrelevant</p>



<a name="246886708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886708">(Jul 22 2021 at 18:24)</a>:</h4>
<p>we oly care about its type</p>



<a name="246886725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886725">(Jul 22 2021 at 18:25)</a>:</h4>
<p>so typeck of the const is requested and you fire a typeck of that const with it's parents, which will fire again at some point the typeck of what's inside of the const {} ?</p>



<a name="246886775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886775">(Jul 22 2021 at 18:25)</a>:</h4>
<p>that is our goal, basically</p>



<a name="246886782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886782">(Jul 22 2021 at 18:25)</a>:</h4>
<p>something like this</p>



<a name="246886835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886835">(Jul 22 2021 at 18:25)</a>:</h4>
<p>well don't remember or know that well the code to understand why this doesn't give an infinite loop :P</p>



<a name="246886895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246886895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246886895">(Jul 22 2021 at 18:26)</a>:</h4>
<p>well</p>



<a name="246887216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887216">(Jul 22 2021 at 18:28)</a>:</h4>
<p>ok, so, we didn't get too far</p>



<a name="246887224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887224">(Jul 22 2021 at 18:28)</a>:</h4>
<p>but that's ok</p>



<a name="246887237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887237">(Jul 22 2021 at 18:28)</a>:</h4>
<p>the reason that it doesn't give a cycle though is this</p>



<a name="246887339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887339">(Jul 22 2021 at 18:29)</a>:</h4>
<p>you have something like</p>
<div class="codehilite"><pre><span></span><code>Typeck(Closure) calls Typeck(Owner)
    Typeck(Owner) executes typeck_impl(owner) to create the typeck results R
    the results R contain also the results for the closure
</code></pre></div>



<a name="246887377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887377">(Jul 22 2021 at 18:29)</a>:</h4>
<p>the point is that the <code>typeck_impl</code> never calls that query</p>



<a name="246887483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887483">(Jul 22 2021 at 18:30)</a>:</h4>
<p>ok</p>



<a name="246887495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887495">(Jul 22 2021 at 18:30)</a>:</h4>
<p>we'll have to talk more about it!</p>



<a name="246887570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887570">(Jul 22 2021 at 18:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/246886398">said</a>:</p>
<blockquote>
<p>this is why you see code like this in the impl of various queries:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="c1">// Closures' typeck results come from their outermost function,</span>
<span class="w">    </span><span class="c1">// as they are part of the same "inference environment".</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">outer_def_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">closure_base_def_id</span><span class="p">(</span><span class="n">def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">outer_def_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">def_id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">has_typeck_results</span><span class="p">(</span><span class="n">outer_def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>so I guess I can create a test case and try to do this <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="246887618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/246887618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#246887618">(Jul 22 2021 at 18:31)</a>:</h4>
<p>or do you see any complication or something that I may not be seeing?</p>



<a name="249628364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/249628364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#249628364">(Aug 16 2021 at 18:32)</a>:</h4>
<p>Thanks to the pointer <span class="user-mention" data-user-id="216206">@lcnr</span>!</p>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> are you still working on this? I am interested in working on this but would like to avoid duplicating work.</p>



<a name="249659758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/249659758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#249659758">(Aug 16 2021 at 23:03)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> I didn't do stuff yet, was planning to do so soon</p>



<a name="249659853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/249659853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#249659853">(Aug 16 2021 at 23:04)</a>:</h4>
<p>maybe give me one or two more weeks and if I'm not able I may just be able to help you out or just hand the task to you</p>



<a name="249661095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/249661095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#249661095">(Aug 16 2021 at 23:22)</a>:</h4>
<p>Cool. You probably want to have <a href="https://github.com/rust-lang/rust/issues/88088">#88088</a> and <a href="https://github.com/rust-lang/rust/issues/88090">#88090</a> applied before starting you work. <a href="https://github.com/rust-lang/rust/issues/88018">#88018</a> might be worth a look but I am uncertain if it'll be helpful if inline consts typeck has to be overhauled anyway.</p>



<a name="255270963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255270963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255270963">(Sep 28 2021 at 18:12)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> I ended not having time for this and in particular focusing on some other things, please go ahead if you still want and also please mention me on PRs :)</p>



<a name="255271047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255271047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255271047">(Sep 28 2021 at 18:13)</a>:</h4>
<p>Ok, I'll have a try</p>



<a name="255660140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255660140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255660140">(Sep 30 2021 at 22:38)</a>:</h4>
<p>This is way more complex than I anticipated, but I am making some progress :)</p>



<a name="255660330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255660330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255660330">(Sep 30 2021 at 22:40)</a>:</h4>
<p>The hard part is to give a sensible result for <code>type_of</code>. Days of experiments show that we cannot simply use the type from typeck (i.e. via <code>tcx.typeck(def).node_type(hir)</code>), because this screws up lifetimes.</p>



<a name="255660737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255660737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255660737">(Sep 30 2021 at 22:44)</a>:</h4>
<p>Since node_type has lifetime erased, it couldn't be used for type_of (which expects unerased lifetimes). What should the <code>type_of</code> return for the constant if the type is <code>&amp;‘a T</code>, <code>&amp;'a &amp;'a T</code> or <code>&amp;'a &amp;'b T</code>? We could iterate through all lifetimes and convert them to fresh lifetime parameters and add them to <code>generics_of</code> of the constant, but this could easily go wrong.</p>



<a name="255660983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255660983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255660983">(Sep 30 2021 at 22:46)</a>:</h4>
<p>So I am currently prototyping an approach where the <code>generics_of</code> of the constant gives<code>&lt;'l0...'li, T0...Tj, R&gt;</code> where <code>'l0...'li, T0...Tj</code> are inherited from the scope, and <code>R</code> is the return type. This is similar to closure which is modelled as <code>&lt;'l0...'li, T0...Tj, CK, CS, U&gt;</code> where the closure return type is encoded in CS as a generic argument.</p>



<a name="255661178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255661178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255661178">(Sep 30 2021 at 22:48)</a>:</h4>
<p>This means calling <code>type_of</code> of an inline const will simply give <code>R</code>, and its up to the use site to specify what <code>R</code> actually is, just like how <code>CS</code> is specified at use-site for closures.</p>



<a name="255887758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255887758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255887758">(Oct 02 2021 at 18:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/255660330">said</a>:</p>
<blockquote>
<p>The hard part is to give a sensible result for <code>type_of</code>. Days of experiments show that we cannot simply use the type from typeck (i.e. via <code>tcx.typeck(def).node_type(hir)</code>), because this screws up lifetimes.</p>
</blockquote>
<p>when do we care about the regions returned by <code>type_of</code>? <em>edit: didn't fully think this comment through</em></p>



<a name="255887899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255887899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255887899">(Oct 02 2021 at 18:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/260443-project-const-generics/topic/inline.20consts.20typeck/near/255661178">said</a>:</p>
<blockquote>
<p>This means calling <code>type_of</code> of an inline const will simply give <code>R</code>, and its up to the use site to specify what <code>R</code> actually is, just like how <code>CS</code> is specified at use-site for closures.</p>
</blockquote>
<p>that does seem like a good solution afaict, though it is less trivial than i hoped it would be, probably makes sense to talk with <span class="user-mention" data-user-id="116009">@nikomatsakis</span> about this. i would have otherwise felt able to review all of this by myself ^^</p>



<a name="255902020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255902020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255902020">(Oct 02 2021 at 22:09)</a>:</h4>
<p><code>type_of</code> is itself being used by a lot of places in type checking, inference, trait selection, etc, and these need to know about actual regions. There are also places where it doesn't care about actual regions.</p>
<p>So strictly speaking it's not necessary to allow a call on inline const DefId, and an early prototype I have <code>bug!</code> when <code>type_of</code> is being called on inline consts,  but then I find that I have to change all code that's unrelated to implementing inline cons that calls <code>type_of</code> and doesn't expect an actual region to use <code>typeck().node_type()</code> and it's such a pain. An another alternative is to just return erased regions from <code>type_of</code> for inline consts, but I am not comfortable with the idea because it might introduce subtle errors (and it'll be very awkward that <code>type_of</code> returns actual regions for all other defs but not inline const)</p>



<a name="255902654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/inline%20consts%20typeck/near/255902654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/inline.20consts.20typeck.html#255902654">(Oct 02 2021 at 22:20)</a>:</h4>
<p>I actually went pretty far before coming up with the extra generic param idea with the <code>bug!</code> and <code>typeck().node_type()</code> approach, but then it stops working across crates (because typeck works on LocalDefIds only). I then came up with the extra generic param and ditched the old approach altogether.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>