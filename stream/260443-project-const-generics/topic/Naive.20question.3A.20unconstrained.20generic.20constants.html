<html>
<head><meta charset="utf-8"><title>Naive question: unconstrained generic constants · project-const-generics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/index.html">project-const-generics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html">Naive question: unconstrained generic constants</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258762550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258762550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Raekye <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258762550">(Oct 22 2021 at 19:35)</a>:</h4>
<p>Hi, I've been trying to use generic constants, and have been adding bounds like <code>where [(); N + 1]:</code> to get code to compile (say <code>N</code> is <code>usize</code>). As I understand, the issue is that arbitrary expressions may be invalid, e.g. if <code>N + 1</code> overflows, the containing type/function is not well-defined.</p>
<p>So say I try to define a struct:</p>
<div class="codehilite"><pre><span></span><code>struct Foo&lt;const N: usize&gt;([u32; N + 1]);
</code></pre></div>
<p>Currently, the compiler "pre-emptively" requires me to add a bound forcing the evaluation of <code>N + 1</code> to ensure it is valid. So even if I only ever use <code>Foo&lt;0&gt;</code> and <code>Foo&lt;1&gt;</code>, where <code>N + 1</code> is valid, I still need the bound. But why can't the evaluation and validation be delayed to whenever the generic type is used/"instantiated"/"referenced", e.g.:</p>
<div class="codehilite"><pre><span></span><code>let foo: Foo&lt;usize::MAX + 1&gt;;
</code></pre></div>
<p>i.e. I would get the equivalent compiler error in this previous line of code, as opposed to the definition of <code>Foo</code>.</p>
<p>I'm sure this has been brought up before - it's similar to how templates work in C++, where generics really are "templates" that don't exist until used/instantiated. I've seen the reasoning somewhere that the current approach makes implicit assumptions about the generic constants (e.g. that <code>N + 1</code> doesn't overflow) explicit. However, even writing a small amount of code with generic constants (e.g. a bitmap parameterized by the number of bits), these explicit bounds quickly seem unwieldy. Is this the only reason for requiring explicit bounds? Alternatively, is it just the case that internally the rust compiler fundamentally doesn't treat generics similar to C++'s templates (where this seems possible and valid)?</p>
<p>Thank you!</p>



<a name="258887186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258887186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258887186">(Oct 24 2021 at 16:50)</a>:</h4>
<blockquote>
<p>Is this the only reason for requiring explicit bounds?</p>
</blockquote>
<p>no.  A large issue with having these bounds be implicit is that it is quite difficult to infer these bounds recursively, i.e. whether calling <code>fn bar</code> with <code>usize::MAX</code> causes an error if <code>fn bar</code> calls <code>fn foo</code> with this generic arg where <code>foo</code> fails for some inputs.</p>



<a name="258887224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258887224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258887224">(Oct 24 2021 at 16:51)</a>:</h4>
<p>if instead of propagating these bounds upwards, we wait until we "actually need" the constant which fails evaluation, we end up with cases which don't error with <code>cargo check</code> but instead either:</p>



<a name="258887467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258887467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258887467">(Oct 24 2021 at 16:56)</a>:</h4>
<ul>
<li>cause a post monomorphization error, i.e. only error when using <code>cargo build</code> and when using the relevant function, so you can end up with potentially very unhelpful errors and it is not obvious that some methods can't be called with generic args</li>
</ul>



<a name="258887573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258887573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258887573">(Oct 24 2021 at 16:58)</a>:</h4>
<ul>
<li>or even worse, don't error at all even though you use something which depends on a const evaluatable bound (currently written <code>where [u8; my_expr]: Whatever</code>, in the future maybe <code>where evaluatable { my_expr }</code> or something like that) for soundness, which I definitely want to allow. An example here is maybe an algorithm which only works if the used generic arg is prime or sth like that</li>
</ul>



<a name="258887606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258887606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258887606">(Oct 24 2021 at 16:59)</a>:</h4>
<p>It's also easier to just start with requiring explicit bounds and then later implicitly inferring them or what not once the rest of this feature already works and we have more experience. Increasing the requirements is pretty much always more difficult then dropping them</p>



<a name="258887708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258887708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258887708">(Oct 24 2021 at 17:00)</a>:</h4>
<p>i should probably just write a document where i can point to when this question comes up cause the reasoning is currently split over a bunch of different documents and discussions <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="258889862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258889862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258889862">(Oct 24 2021 at 17:51)</a>:</h4>
<p>We already have post monomorphization errors for associated consts.</p>



<a name="258889949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258889949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258889949">(Oct 24 2021 at 17:53)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VAL</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span>::<span class="n">VAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="kt">usize</span>::<span class="n">MAX</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>::<span class="n">VAL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258907510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Raekye <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907510">(Oct 25 2021 at 00:57)</a>:</h4>
<p>I'm not sure if this is what Gary was trying to say, but in my code I also had an associated constant defined as a nontrivial expression (which hypothetically could be a problem), which is why I thought it's not completely inconsistent to have that behavior elsewhere (post monomorphization(?) errors). <span class="user-mention" data-user-id="303710">@Gary Guo</span> is that what you were suggesting?</p>



<a name="258907558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907558">(Oct 25 2021 at 00:58)</a>:</h4>
<p>yes</p>



<a name="258907724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907724">(Oct 25 2021 at 01:01)</a>:</h4>
<p>Although I have to say that even though this is a form of post-monomorphization error it currently does not flow back to the type system because we forbid usage of <code>Foo::&lt;N&gt;::VAL</code> in const contexts if <code>N</code> is a parameter.</p>



<a name="258907786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907786">(Oct 25 2021 at 01:02)</a>:</h4>
<p>yea</p>



<a name="258907804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907804">(Oct 25 2021 at 01:03)</a>:</h4>
<p>there's also I think not really a path to making assoc consts <em>not</em> have post mono errors</p>



<a name="258907812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907812">(Oct 25 2021 at 01:03)</a>:</h4>
<p>wheras there <em>is</em> a path towards making <code>foo::&lt;{ N + 1 }&gt;</code> not have post mono errors</p>



<a name="258907820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907820">(Oct 25 2021 at 01:03)</a>:</h4>
<p>or,, i guess really it would be <code>foo::&lt;N&gt;()</code> not having post mono errors</p>



<a name="258907823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907823">(Oct 25 2021 at 01:03)</a>:</h4>
<p>or i guess both</p>



<a name="258907870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907870">(Oct 25 2021 at 01:04)</a>:</h4>
<p>Well, I can have a</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>:<span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span>::<span class="n">VAL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and it would error post mono.</p>



<a name="258907875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907875">(Oct 25 2021 at 01:05)</a>:</h4>
<p>But it's IMO a good thing, I use it for static asserts.</p>



<a name="258907893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907893">(Oct 25 2021 at 01:06)</a>:</h4>
<p>O fun</p>



<a name="258907930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258907930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258907930">(Oct 25 2021 at 01:06)</a>:</h4>
<p>i guess I assumed that would be a runtime panic</p>



<a name="258908003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258908003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258908003">(Oct 25 2021 at 01:08)</a>:</h4>
<p>Well, the const needs to be mono-ed.</p>



<a name="258908009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258908009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258908009">(Oct 25 2021 at 01:08)</a>:</h4>
<p>Actually I hope one day I can just write</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>:<span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="c1">// and also</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">assert!</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258908040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/Naive%20question%3A%20unconstrained%20generic%20constants/near/258908040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/Naive.20question.3A.20unconstrained.20generic.20constants.html#258908040">(Oct 25 2021 at 01:10)</a>:</h4>
<p>It's actually okay, because inline consts don't flow back into the type system either, unless used in pattern position, nested in another anon const (but that restriction doesn't come from inline const itself).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>