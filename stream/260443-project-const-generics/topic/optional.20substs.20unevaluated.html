<html>
<head><meta charset="utf-8"><title>optional substs unevaluated · project-const-generics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/index.html">project-const-generics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html">optional substs unevaluated</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258841672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841672">(Oct 23 2021 at 20:40)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="216206">@lcnr</span></p>
<p>I'm trying to fix <a href="https://github.com/rust-lang/rust/issues/89334">#89334</a>:</p>
<div class="codehilite"><pre><span></span><code>#![feature(generic_const_exprs)]
#![allow(unused_braces, incomplete_features)]

pub trait Foo&lt;const N: usize&gt; {}
pub trait Bar: Foo&lt;{ 1 }&gt; { }
</code></pre></div>
<p>This fails as a result of the changes you've introduced in <a href="https://github.com/rust-lang/rust/pull/87280">87280</a>, specifically the problem is that we generate "duplicate" caller bounds candidates (they only differ in the substs of the the <code>Unevaluated</code> constant, one being None, the other having its default substs inserted in the elaborate call <code>[Self]</code> in this case, which match the default substs) during wfcheck, resulting in ambiguity.</p>
<p>I'm not sure I understand why you chose to wrap the substs in an Option. Will using None during the initialization of <code>Unevaluated</code> in <a href="https://github.com/rust-lang/rust/blob/91b931926fd49fc97d1e39f2b8206abf1d77ce7d/compiler/rustc_middle/src/ty/consts.rs#L100-L104"><code>from_opt_const_arg_anon_const</code></a> actually be necessary to prevent cycles or could we call <code>default_anon_consts_substs</code> here and use an enum (with variants, say, <code>DefaultSubsts(SubstsRef)</code> and <code>Initialized(Substsref)</code>) instead of an option, which would allow us to still test for equality of substs even if one is the 'default subst' version and the other is already the initialized version? If not why would postponing (through substs_: None) the call  to <code>default_anon_consts_substs</code> mitigate the cycle problem and how will the upcoming 'filtering parent substs' PR help with the cycle problem (I didn't completely understand the zulip topics related to that solution)?</p>



<a name="258841678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841678">(Oct 23 2021 at 20:41)</a>:</h4>
<p>I think yes using <code>None</code> in <code>from_opt_const_arg_anon_const</code> is required to prevent cycles, (and if it isnt now, it will be when we actualy implement filtering)</p>



<a name="258841684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841684">(Oct 23 2021 at 20:41)</a>:</h4>
<p>the idea being that we wanted to create the paramenv with <code>None</code> for substs of everything and then compute the real substs for all the consts</p>



<a name="258841727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841727">(Oct 23 2021 at 20:42)</a>:</h4>
<p>kinda oof that array repeat exprs have substs though... I forgot about that <span aria-label="frowning" class="emoji emoji-1f626" role="img" title="frowning">:frowning:</span></p>



<a name="258841873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841873">(Oct 23 2021 at 20:46)</a>:</h4>
<p>ok interesting. But I don't really understand why we can still call <code>default_opt_const_arg_anon_const</code> for an Unevaluated whose substs are None then, why would calling this later avoid cycles? I haven't read too deeply into the PR though, so I may be missing something here.</p>



<a name="258841889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841889">(Oct 23 2021 at 20:47)</a>:</h4>
<p>(not sure what <code>default_opt_const_arg_anon_const</code> is, i cant find it with ctrl-f <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>)</p>



<a name="258841901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841901">(Oct 23 2021 at 20:47)</a>:</h4>
<p>im not super familiar with <a href="https://github.com/rust-lang/rust/issues/87280">#87280</a> tbh it went over my head a bit</p>



<a name="258841952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841952">(Oct 23 2021 at 20:48)</a>:</h4>
<p>the cycles we're hoping to avoid is that when we are filtering out unused substs (i.e. inside <code>default_anon_const_substs</code>) we dont call code that tries to get the actual substs</p>



<a name="258841959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841959">(Oct 23 2021 at 20:48)</a>:</h4>
<p>I expect <code>from_opt_const_arg_anon_const</code> would be a thing we call when filtering out unused substs</p>



<a name="258841977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258841977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258841977">(Oct 23 2021 at 20:49)</a>:</h4>
<p>im not sure I'll be much help here <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="258842120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842120">(Oct 23 2021 at 20:53)</a>:</h4>
<p>from my (limited) knowledge i'd assume the solution is adding a <code>.substs(tcx)</code> call somewhere... no idea where that'd be tho</p>



<a name="258842161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842161">(Oct 23 2021 at 20:54)</a>:</h4>
<blockquote>
<p>we dont call code that tries to get the actual substs</p>
</blockquote>
<p>What do you mean by actual substs here? I assume not the default substs, but I don't understand why we would call <code>default_anon_const_substs</code> when we have the real substs.</p>



<a name="258842172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842172">(Oct 23 2021 at 20:54)</a>:</h4>
<p>Do you maybe have an example for a cycle involving substs?</p>



<a name="258842188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842188">(Oct 23 2021 at 20:55)</a>:</h4>
<p>I mean that when we're in <code>default_anon_const_substs</code> and are working with an <code>Unevaluated</code> with <code>None</code> substs we dont want to call <code>default_anon_const_substs</code></p>



<a name="258842189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842189">(Oct 23 2021 at 20:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842120">said</a>:</p>
<blockquote>
<p>from my (limited) knowledge i'd assume the solution is adding a <code>.substs(tcx)</code> call somewhere... no idea where that'd be tho</p>
</blockquote>
<p>Yes that's what I was thinking, although that seems kind of like a hack to me. But you don't think that the filtering PR will fix this issue?</p>



<a name="258842190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842190">(Oct 23 2021 at 20:55)</a>:</h4>
<p>the filtering PR would just change the returned value from <code>default_anon_const_substs</code></p>



<a name="258842233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842233">(Oct 23 2021 at 20:56)</a>:</h4>
<p>the "infrastructure" for actually adding the logic for filtering was what was added in that PR that caused this bug</p>



<a name="258842236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842236">(Oct 23 2021 at 20:56)</a>:</h4>
<p>(i.e. the None/Some substs)</p>



<a name="258842266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842266">(Oct 23 2021 at 20:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842172">said</a>:</p>
<blockquote>
<p>Do you maybe have an example for a cycle involving substs?</p>
</blockquote>
<p>basically if in <code>predicates_of</code> we call <code>default_anon_const_substs</code> of an unevaluted const then we will get a cycle</p>



<a name="258842320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842320">(Oct 23 2021 at 20:58)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">[();</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>: <span class="p">{</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258842334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842334">(Oct 23 2021 at 20:58)</a>:</h4>
<p>i.e for this fn we cant call <code>default_anon_const_substs(that_N_plus_1_const)</code> while in the <code>predicates_of(foo)</code> query</p>



<a name="258842362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842362">(Oct 23 2021 at 20:59)</a>:</h4>
<p>because <code>default_anon_const_substs(that_const)</code> gets the parent defid (which in this case is <code>foo</code>) and calls <code>predicates_of(foo)</code></p>



<a name="258842450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842450">(Oct 23 2021 at 21:00)</a>:</h4>
<p>(which im now realising is a different cycle than what I was talking about before... sorry, this is the cycle we dont want ^)</p>



<a name="258842553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842553">(Oct 23 2021 at 21:02)</a>:</h4>
<p>(have you tried calling <code>default_anon_const_substs</code> from <code>from_opt_const_arg_anon_const</code> and seeing if it cycles?)</p>



<a name="258842559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842559">(Oct 23 2021 at 21:02)</a>:</h4>
<p>(if it does it might give a nice query backtrace when run with <code>-Ztreat-err-as-bug</code>)</p>



<a name="258842586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842586">(Oct 23 2021 at 21:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842553">said</a>:</p>
<blockquote>
<p>(have you tried calling <code>default_anon_const_substs</code> from <code>from_opt_const_arg_anon_const</code> and seeing if it cycles?)</p>
</blockquote>
<p>yes I have, it fixes the issue and all tests also pass, but I feel that its not really a solution, since we basically get rid of all the <code>substs_: None</code> initializations</p>



<a name="258842590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842590">(Oct 23 2021 at 21:03)</a>:</h4>
<p>oh... fun <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="258842636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842636">(Oct 23 2021 at 21:04)</a>:</h4>
<p>ig will just have to wait for lcnr to see why we dont do that</p>



<a name="258842639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842639">(Oct 23 2021 at 21:04)</a>:</h4>
<p>i'd have thought that cycles...</p>



<a name="258842649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258842649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258842649">(Oct 23 2021 at 21:04)</a>:</h4>
<p>yes, thanks for your help and the example.</p>



<a name="258872628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258872628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258872628">(Oct 24 2021 at 10:57)</a>:</h4>
<blockquote>
<p>it fixes the issue and all tests also pas</p>
</blockquote>
<p>that doesn't seem right</p>



<a name="258872672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258872672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258872672">(Oct 24 2021 at 10:58)</a>:</h4>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code>lcnr@lcnr-pc:~/rust4$ git diff HEAD
<span class="gh">diff --git a/compiler/rustc_middle/src/ty/consts.rs b/compiler/rustc_middle/src/ty/consts.rs</span>
<span class="gh">index 869b2ab9dbc..a4e2e497f3c 100644</span>
<span class="gd">--- a/compiler/rustc_middle/src/ty/consts.rs</span>
<span class="gi">+++ b/compiler/rustc_middle/src/ty/consts.rs</span>
<span class="gu">@@ -99,7 +99,7 @@ pub fn from_opt_const_arg_anon_const(</span>
             }
             _ =&gt; ty::ConstKind::Unevaluated(ty::Unevaluated {
                 def: def.to_global(),
<span class="gd">-                substs_: None,</span>
<span class="gi">+                substs_: Some(tcx.default_anon_const_substs(def.did)),</span>
                 promoted: None,
             }),
         };
</code></pre></div>



<a name="258872685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258872685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258872685">(Oct 24 2021 at 10:58)</a>:</h4>
<p>results in 82 failed tests for me</p>



<a name="258872831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258872831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258872831">(Oct 24 2021 at 11:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842120">said</a>:</p>
<blockquote>
<p>from my (limited) knowledge i'd assume the solution is adding a <code>.substs(tcx)</code> call somewhere... no idea where that'd be tho</p>
</blockquote>
<p>yes, the "where" here would be during candidate assembly</p>



<a name="258872999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258872999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258872999">(Oct 24 2021 at 11:04)</a>:</h4>
<p>either by adding a subst call every time we call <code>impl_trait_ref</code> for an <code>ImplCandidate</code></p>



<a name="258873002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873002">(Oct 24 2021 at 11:04)</a>:</h4>
<p>or by actually doing that inside of the <code>impl_trait_ref</code> query</p>



<a name="258873028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873028">(Oct 24 2021 at 11:05)</a>:</h4>
<p>i think calling <code>subst</code> inside of <code>impl_trait_ref</code>should not cycle, but not 100% sure about that</p>



<a name="258873189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873189">(Oct 24 2021 at 11:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258872672">said</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="Diff"><pre><span></span><code>lcnr@lcnr-pc:~/rust4$ git diff HEAD
<span class="gh">diff --git a/compiler/rustc_middle/src/ty/consts.rs b/compiler/rustc_middle/src/ty/consts.rs</span>
<span class="gh">index 869b2ab9dbc..a4e2e497f3c 100644</span>
<span class="gd">--- a/compiler/rustc_middle/src/ty/consts.rs</span>
<span class="gi">+++ b/compiler/rustc_middle/src/ty/consts.rs</span>
<span class="gu">@@ -99,7 +99,7 @@ pub fn from_opt_const_arg_anon_const(</span>
             }
             _ =&gt; ty::ConstKind::Unevaluated(ty::Unevaluated {
                 def: def.to_global(),
<span class="gd">-                substs_: None,</span>
<span class="gi">+                substs_: Some(tcx.default_anon_const_substs(def.did)),</span>
                 promoted: None,
             }),
         };
</code></pre></div><br>
</p>
</blockquote>
<p>sorry, the change I made was:</p>
<div class="codehilite"><pre><span></span><code>@@ -99,7 +100,7 @@ pub fn from_opt_const_arg_anon_const(
             }
             _ =&gt; ty::ConstKind::Unevaluated(ty::Unevaluated {
                 def: def.to_global(),
-                substs_: None,
+                substs_: Some(InternalSubsts::identity_for_item(tcx, def.did.to_def_id())),
                 promoted: None,
             }),
         };
</code></pre></div>



<a name="258873194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873194">(Oct 24 2021 at 11:08)</a>:</h4>
<p>ah yes</p>



<a name="258873202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873202">(Oct 24 2021 at 11:08)</a>:</h4>
<p>that's what <code>default_anon_const_substs</code> is returning rn</p>



<a name="258873242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873242">(Oct 24 2021 at 11:09)</a>:</h4>
<p>but this will change in the future once I - or someone else - implements the filtering of anon const generics</p>



<a name="258873303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873303">(Oct 24 2021 at 11:10)</a>:</h4>
<p>i wrote <a href="https://rustc-dev-guide.rust-lang.org/constants.html">https://rustc-dev-guide.rust-lang.org/constants.html</a> but tbh, after rereading it, that explanation doesn't seem too clear to me</p>



<a name="258873331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873331">(Oct 24 2021 at 11:11)</a>:</h4>
<p>hm I'm puzzled why the test suites passes for me, but not you</p>



<a name="258873334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873334">(Oct 24 2021 at 11:11)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">generics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">generics_of</span><span class="p">(</span><span class="n">def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generics</span><span class="p">.</span><span class="n">parent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// This is the reason we bother with having optional anon const substs.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// In the future the substs of an anon const will depend on its parents predicates</span>
<span class="w">        </span><span class="c1">// at which point eagerly looking at them will cause a query cycle.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// So for now this is only an assurance that this approach won't cause cycle errors in</span>
<span class="w">        </span><span class="c1">// the future.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_cycle_check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">predicates_of</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258873335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873335">(Oct 24 2021 at 11:11)</a>:</h4>
<p>because of this in <code>default_anon_const_substs</code></p>



<a name="258873341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258873341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258873341">(Oct 24 2021 at 11:11)</a>:</h4>
<p>ah i see, thanks</p>



<a name="258886859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/optional%20substs%20unevaluated/near/258886859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated.html#258886859">(Oct 24 2021 at 16:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258873028">said</a>:</p>
<blockquote>
<p>i think calling <code>subst</code> inside of <code>impl_trait_ref</code>should not cycle, but not 100% sure about that</p>
</blockquote>
<p>ah, don't use <code>subst</code> in <code>impl_trait_ref</code>, use <code>expose_anon_const_default_substs</code> instead <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>