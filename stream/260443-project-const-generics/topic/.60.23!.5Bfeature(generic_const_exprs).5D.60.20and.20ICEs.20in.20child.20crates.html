<html>
<head><meta charset="utf-8"><title>`#![feature(generic_const_exprs)]` and ICEs in child crates · project-const-generics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/index.html">project-const-generics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html">`#![feature(generic_const_exprs)]` and ICEs in child crates</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273322382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273322382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273322382">(Feb 26 2022 at 06:34)</a>:</h4>
<p>Hiya. I'm investigating <a href="https://github.com/rust-lang/rust/issues/94287">#94287</a>, and I noticed a strange quirk with the feature flag <code>generic_const_exprs</code> and child crates depending on parent crates with this feature flag enabled.</p>



<a name="273322388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273322388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273322388">(Feb 26 2022 at 06:34)</a>:</h4>
<p>During codegen for the doc test provided in the issue, we try to normalize a function signature from the parent crate, but because that feature flag is not enabled in the child (doc-test) crate, we fail to normalize an associated type due to <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L38">feature-flag-exclusive logic</a> being disabled.</p>



<a name="273322405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273322405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273322405">(Feb 26 2022 at 06:35)</a>:</h4>
<p>Has anyone seen anything similar (ICEs, normalization failure shenanigans) with <code>#![feature(generic_const_exprs)]</code> being enabled in a parent crate and not being enabled a child crate?</p>



<a name="273322469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273322469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273322469">(Feb 26 2022 at 06:37)</a>:</h4>
<p>also, I can think of a few "quick fixes" for the issue (and I almost put one up before I tried to investigate deeper), but I wanted to know what folks thought a good solution would be...</p>



<a name="273322613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273322613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273322613">(Feb 26 2022 at 06:41)</a>:</h4>
<p>specifically, the bad normalization call is <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_middle/src/ty/layout.rs#L2594">here</a> -- we could either: </p>
<ol>
<li>fall back to using  <code>try_normalize_erasing_regions</code> and then undo the hack mentioned in the comment above, by substituting <em>then</em> normalizing, which ends up succeeding</li>
<li>save this normalized fn_sig as query to disk, so that we only load the version of <code>normalize_erasing_regions(fn_sig(def_id))</code> that was evaluated in the parent crate (and thus with <code>generic_const_exprs</code> enabled).</li>
<li>modify the logic in <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L38"><code>is_const_evaluatable</code></a> to not just look at the session's feature flags, but factor in the crate that the unevaluated constant comes from somehow?</li>
</ol>



<a name="273345829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273345829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273345829">(Feb 26 2022 at 15:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="426609">Michael Goulet (compiler-errors)</span> <a href="#narrow/stream/260443-project-const-generics/topic/.60.23!.5Bfeature.28generic_const_exprs.29.5D.60.20and.20ICEs.20in.20child.20crates/near/273322405">said</a>:</p>
<blockquote>
<p>Has anyone seen anything similar (ICEs, normalization failure shenanigans) with <code>#![feature(generic_const_exprs)]</code> being enabled in a parent crate and not being enabled a child crate?</p>
</blockquote>
<p>theres an old issue open the <code>label:F-generic_const_exprs</code> about this iirc</p>



<a name="273345856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273345856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273345856">(Feb 26 2022 at 15:07)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/79018">#79018</a></p>



<a name="273354206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354206">(Feb 26 2022 at 18:01)</a>:</h4>
<p>good to know, thanks <span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span></p>



<a name="273354226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354226">(Feb 26 2022 at 18:01)</a>:</h4>
<p>hrm, it's frustrating that it seems like there's no good solution to this issue :/</p>



<a name="273354228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354228">(Feb 26 2022 at 18:01)</a>:</h4>
<p>I guess that's part of what you get with an <code>incomplete_feature</code></p>



<a name="273354232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354232">(Feb 26 2022 at 18:02)</a>:</h4>
<p>oh yeah this entire feature is very "no good solution" to a lot of things for a while :)</p>



<a name="273354273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354273">(Feb 26 2022 at 18:02)</a>:</h4>
<p>only very very recently did we figure out a way to move forward on some of the issues lol</p>



<a name="273354278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354278">(Feb 26 2022 at 18:02)</a>:</h4>
<p>is it possible to when ICEing check if the current crate has the feature enabled but the upstream doesnt? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="273354280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354280">(Feb 26 2022 at 18:02)</a>:</h4>
<p>because at the best case we could ICE with a better message saying to enable the feature</p>



<a name="273354468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/%60%23%21%5Bfeature%28generic_const_exprs%29%5D%60%20and%20ICEs%20in%20child%20crates/near/273354468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/.60.23!.5Bfeature(generic_const_exprs).5D.60.20and.20ICEs.20in.20child.20crates.html#273354468">(Feb 26 2022 at 18:07)</a>:</h4>
<p>yeah, the ICE is somewhat separated from<code>is_const_evaluatable</code>.. I wonder if we can at least emit a warning in that function that happens before the ICE.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>