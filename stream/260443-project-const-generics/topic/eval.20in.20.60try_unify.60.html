<html>
<head><meta charset="utf-8"><title>eval in `try_unify` · project-const-generics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/index.html">project-const-generics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html">eval in `try_unify`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275351392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351392">(Mar 15 2022 at 09:59)</a>:</h4>
<p>an example where that is necessary is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_const_exprs)]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ASSOC</span>: <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ASSOC</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ASSOC</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">fn</span> <span class="nf">uses_assoc_type</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Generic</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">T</span>::<span class="n">ASSOC</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">T</span>::<span class="n">ASSOC</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">only_generic_n</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">uses_assoc_type</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275351399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351399">(Mar 15 2022 at 09:59)</a>:</h4>
<p>this should compile</p>



<a name="275351408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351408">(Mar 15 2022 at 09:59)</a>:</h4>
<p>but currently doesn't</p>



<a name="275351423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351423">(Mar 15 2022 at 09:59)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="328097">@BN</span> if you want to fix it</p>



<a name="275351506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351506">(Mar 15 2022 at 10:00)</a>:</h4>
<p>change <code>try_unify</code> to also take a <code>param_env</code></p>



<a name="275351523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351523">(Mar 15 2022 at 10:00)</a>:</h4>
<p>and evaluate <code>Node::Leaf</code> where necessary</p>



<a name="275351790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275351790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275351790">(Mar 15 2022 at 10:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275351423">said</a>:</p>
<blockquote>
<p>cc <span class="user-mention silent" data-user-id="328097">BN</span> if you want to fix it</p>
</blockquote>
<p>yes, I can try this.</p>



<a name="275544236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275544236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275544236">(Mar 16 2022 at 17:03)</a>:</h4>
<p>We can get a <code>ParamEnv</code> from the <code>Unevaluated</code> arguments in <code>try_unify_abstract_consts</code>, but how do we get the correct <code>substs</code> in that case? </p>
<p>Or do you also want <code>try_unify_abstract_consts</code> to take a <code>param_env</code>?</p>



<a name="275544867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275544867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275544867">(Mar 16 2022 at 17:06)</a>:</h4>
<p>If I use the substs of the of the <code>Unevaluated</code> I get an ICE that complains about the order of the substs not matching with those in the <code>param_env</code></p>



<a name="275544986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275544986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275544986">(Mar 16 2022 at 17:07)</a>:</h4>
<p>the <code>ParamEnv</code> from the <code>Unevaluated</code> arguments is the wrong one:</p>
<p>looking at the above example in <code>only_generic_n</code> we unify the return type <code>[u8; N + 13]</code> with the return type of <code>uses_assoc_type</code> substituted with <code>[u16, N]</code></p>



<a name="275545247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275545247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275545247">(Mar 16 2022 at 17:08)</a>:</h4>
<p>the above program is internally represented as</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">ANON_CONST_1</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Generic</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">T</span>::<span class="n">ASSOC</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">uses_assoc_type</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Generic</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">ANON_CONST_1</span>::<span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">ANON_CONST_2</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">only_generic_n</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">ANON_CONST_2</span>::<span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">uses_assoc_type</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275545389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275545389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275545389">(Mar 16 2022 at 17:09)</a>:</h4>
<p>ok thanks</p>



<a name="275545393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275545393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275545393">(Mar 16 2022 at 17:09)</a>:</h4>
<p>so when comparing these two types, the element type successfully unifies, and we then unify the <code>ty::Const</code></p>
<p><code>ANON_CONST_1::&lt;u16, M&gt;</code> with <code>ANON_CONST_2::&lt;M&gt;</code></p>



<a name="275545526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275545526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275545526">(Mar 16 2022 at 17:10)</a>:</h4>
<p><em>to make it clear i've edited one of the <code>N</code> to <code>M</code></em></p>



<a name="275545689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275545689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275545689">(Mar 16 2022 at 17:11)</a>:</h4>
<p>so, we unify these two anon constants inside of <code>only_generic_n</code> which has the <code>param_env</code> with have to use</p>



<a name="275545789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275545789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275545789">(Mar 16 2022 at 17:11)</a>:</h4>
<blockquote>
<p>Or do you also want try_unify_abstract_consts to take a param_env?</p>
</blockquote>
<p>so we want this <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="275568299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275568299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275568299">(Mar 16 2022 at 19:52)</a>:</h4>
<p>Still doesn't work unfortunately, missing the correct substs from the <code>param_env</code>. Currently using the <code>param_env</code> of the <code>obligation</code> for the call in <code>try_unify</code> in <code>process_changed_obligation</code> where we try to prove the following <code>ConstEquate</code>:</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ ├─0ms DEBUG rustc_trait_selection::traits::fulfill process_obligation pre-resolve, obligation=Obligation(predicate=Binder(ConstEquate(Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:16 ~ eval_try_unify[db7b]::only_generic_n::{constant#0}), const_param_did: None }, substs: [Const { ty: usize, val: Param(N/#0) }], promoted: None }) }, Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:12 ~ eval_try_unify[db7b]::uses_assoc_type::{constant#0}), const_param_did: None }, substs: [u16, Const { ty: usize, val: Param(N/#0) }], promoted: None }) }), []), depth=0)
</code></pre></div>
<p>where the obligation has this <code>param_env</code>:</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ │ ├─0ms DEBUG rustc_trait_selection::traits::fulfill param env of obligation: ParamEnv { caller_bounds: [Binder(ConstEvaluatable(WithOptConstParam { did: DefId(0:16 ~ eval_try_unify[db7b]::only_generic_n::{constant#0}), const_param_did: None }, [Const { ty: usize, val: Param(N/#0) }]), [])], reveal: UserFacing, constness: NotConst }
</code></pre></div>
<p>which unfortunately cannot evaluate the constant in the return type of <code>uses_assoc_type</code>:</p>
<div class="codehilite"><pre><span></span><code>│ │ ├─17ms DEBUG rustc_trait_selection::traits::fulfill select: outcome=Outcome {
│ │ │     errors: [
│ │ │         Error {
│ │ │             error: CodeConstEquateError(ExpectedFound { expected: Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:16 ~ eval_try_unify[db7b]::only_generic_n::{constant#0}), const_param_did: None }, substs: [Const { ty: usize, val: Param(N/#0) }], promoted: None }) }, found: Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:12 ~ eval_try_unify[db7b]::uses_assoc_type::{constant#0}), const_param_did: None }, substs: [u16, Const { ty: usize, val: Param(N/#0) }], promoted: None }) } }, ConstMismatch(ExpectedFound { expected: Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:16 ~ eval_try_unify[db7b]::only_generic_n::{constant#0}), const_param_did: None }, substs: [Const { ty: usize, val: Param(N/#0) }], promoted: None }) }, found: Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:12 ~ eval_try_unify[db7b]::uses_assoc_type::{constant#0}), const_param_did: None }, substs: [u16, Const { ty: usize, val: Param(N/#0) }], promoted: None }) } })),
</code></pre></div>
<p>In <code>try_unify</code> I use the following to evaluate:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[instrument(skip(tcx), level = </span><span class="s">"debug"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">try_eval_and_replace_substs_in_root</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">mut</span><span class="w"> </span><span class="n">abstr_const</span>: <span class="nc">AbstractConst</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">param_env</span>: <span class="nc">ty</span>::<span class="n">ParamEnv</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AbstractConst</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// We substitute generics repeatedly to allow AbstractConsts to unify where a</span>
<span class="w">    </span><span class="c1">// ConstKind::Unevalated could be turned into an AbstractConst that would unify e.g.</span>
<span class="w">    </span><span class="c1">// Param(N) should unify with Param(T), substs: [Unevaluated("T2", [Unevaluated("T3", [Param(N)])])]</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">abstr_const</span><span class="p">.</span><span class="n">root</span><span class="p">(</span><span class="n">tcx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Node</span>::<span class="n">Leaf</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">abstr_const</span><span class="p">.</span><span class="n">root</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">"root const: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">ct</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">evaluated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">param_env</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">evaluated</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">AbstractConst</span>::<span class="n">from_const</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">evaluated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">act</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">abstr_const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">act</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">abstr_const</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the relevant debug output for the <code>ConstEquate</code> obligation is:</p>
<div class="codehilite"><pre><span></span><code>│ │ │ ├─┐rustc_trait_selection::traits::const_evaluatable::try_eval_and_replace_substs_in_root abstr_const=AbstractConst { inner: [Leaf(Const { ty: usize, val: Param(N/#1) }), Leaf(Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ eval_try_unify[db7b]::Generic::ASSOC), const_param_did: None }, substs: [T], promoted: None }) })], substs: [T, Const { ty: usize, val: Param(N/#1) }] }, param_env=ParamEnv { caller_bounds: [Binder(ConstEvaluatable(WithOptConstParam { did: DefId(0:12 ~ eval_try_unify[db7b]::uses_assoc_type::{constant#0}), const_param_did: None }, [T, Const { ty: usize, val: Param(N/#1) }]), []), Binder(TraitPredicate(&lt;T as Generic&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;T as std::marker::Sized&gt;, polarity:Positive), [])], reveal: UserFacing, constness: NotConst }
│ │ │ │ ├─0ms DEBUG rustc_trait_selection::traits::const_evaluatable root const: Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ eval_try_unify[db7b]::Generic::ASSOC), const_param_did: None }, substs: [T], promoted: None }) }
│ │ │ │ ├─0ms DEBUG rustc_trait_selection::traits::const_evaluatable evaluated=Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ eval_try_unify[db7b]::Generic::ASSOC), const_param_did: None }, substs: [T], promoted: None }) }
</code></pre></div>



<a name="275613814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275613814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275613814">(Mar 17 2022 at 07:05)</a>:</h4>
<p>so, we need to evaluate <code>Node::Leaf</code> which can't be converted to a nested <code>AbstractConst</code></p>



<a name="275614508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275614508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275614508">(Mar 17 2022 at 07:18)</a>:</h4>
<p>so in the <code>Ok(None)</code> case we have to continue with the evaluated leaf.</p>



<a name="275614703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275614703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275614703">(Mar 17 2022 at 07:21)</a>:</h4>
<blockquote>
<p>the relevant debug output for the <code>ConstEquate</code> obligation is:</p>
</blockquote>
<p>It also looks like something goes wrong here: you should get <code>Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ eval_try_unify[db7b]::Generic::ASSOC), const_param_did: None }, substs: [u16] }) }</code> here</p>



<a name="275614709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275614709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275614709">(Mar 17 2022 at 07:21)</a>:</h4>
<p>not <code>Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ eval_try_unify[db7b]::Generic::ASSOC), const_param_did: None }, substs: [T] }) }</code></p>



<a name="275633123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275633123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275633123">(Mar 17 2022 at 10:40)</a>:</h4>
<p>Got the new test to compile, but there are some failing tests in <code>ui/const-generics</code> now:</p>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-87964.rs"><code>ui/const-generics/issues/issue-87964.rs</code></a><br>
<a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-89146.rs"><code>ui/const-generics/issues/issue-89146.rs</code></a><br>
<a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/const-generics/issues/issue-89320.rs"><code>ui/const-generics/issues/issue-89320.rs</code></a></p>
<p>these fail with:</p>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: no errors encountered even though `delay_span_bug` issued

error: internal compiler error: Encountered error `Unimplemented` selecting `Binder(&lt;^0 as Enumerable&gt;, [Ty(Anon)])` during codegen
</code></pre></div>
<p>For <code>issue-87964</code> we have the following <code>try_unify</code> call:</p>
<div class="codehilite"><pre><span></span><code>┐rustc_trait_selection::traits::const_evaluatable::try_unify a=AbstractConst { inner: [Leaf(Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ issue_87964[8bc9]::Target::LENGTH), const_param_did: None }, substs: [T], promoted: None }) })], substs: [^0] }, b=AbstractConst { inner: [Leaf(Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ issue_87964[8bc9]::Target::LENGTH), const_param_did: None }, substs: [T], promoted: None }) })], substs: [T] }, param_env=ParamEnv { caller_bounds: [Binder(ConstEvaluatable(WithOptConstParam { did: DefId(0:11 ~ issue_87964[8bc9]::{impl#0}::{constant#0}), const_param_did: None }, [T]), []), Binder(TraitPredicate(&lt;[(); _] as std::marker::Sized&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;T as Target&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;T as std::marker::Sized&gt;, polarity:Positive), [])], reveal: UserFacing, constness: NotConst }
</code></pre></div>
<p>and wind up with this <code>const_eval_resolve</code> call:</p>
<div class="codehilite"><pre><span></span><code>├─┐rustc_middle::mir::interpret::queries::const_eval_resolve param_env=ParamEnv { caller_bounds: [], reveal: All, constness: NotConst }, ct=Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ issue_87964[8bc9]::Target::LENGTH), const_param_did: None }, substs: [^0], promoted: None }, span=None
</code></pre></div>
<p>where in <code>codegen_fulfill_obligation</code> this <a href="https://github.com/rust-lang/rust/blob/461e8078010433ff7de2db2aaae8a3cfb0847215/compiler/rustc_trait_selection/src/traits/codegen.rs#L45"><code>select</code></a>  fails.</p>
<p>Should this <code>Unevaluated</code> be resolvable?</p>
<p>There are two other failing tests but haven't looked at those in detail.</p>



<a name="275633698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275633698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275633698">(Mar 17 2022 at 10:46)</a>:</h4>
<p><a href="https://github.com/b-naber/rust/blob/9408f6c08d414e915b4cd74eee904a05b5c436ee/compiler/rustc_trait_selection/src/traits/const_evaluatable.rs#L647">this</a> is the current implementation of <code>try_unify</code></p>



<a name="275635252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275635252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275635252">(Mar 17 2022 at 11:00)</a>:</h4>
<p>All of those tests that fail now were previously fixed by the <a href="https://github.com/rust-lang/rust/pull/90023">pr</a> where we postponed the evaluation of some constants.</p>



<a name="275636201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636201">(Mar 17 2022 at 11:09)</a>:</h4>
<p>when we equate two consts to i think we replace inference vars with the <code>for&lt;T&gt;</code> stuff</p>



<a name="275636240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636240">(Mar 17 2022 at 11:09)</a>:</h4>
<p>&lt;<a href="https://github.com/rust-lang/rust/pull/88166">https://github.com/rust-lang/rust/pull/88166</a>&gt;</p>



<a name="275636242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636242">(Mar 17 2022 at 11:09)</a>:</h4>
<p>yes, but that causes the param env to be incomplete</p>



<a name="275636294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636294">(Mar 17 2022 at 11:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275635252">said</a>:</p>
<blockquote>
<p>All of those tests that fail now were previously fixed by the <a href="https://github.com/rust-lang/rust/pull/90023">pr</a> where we postponed the evaluation of some constants.</p>
</blockquote>
<p>so that's the correct fix here as well</p>



<a name="275636298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636298">(Mar 17 2022 at 11:10)</a>:</h4>
<p>for now</p>



<a name="275636303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636303">(Mar 17 2022 at 11:10)</a>:</h4>
<p>the param env also looks kinda sus to me</p>



<a name="275636312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636312">(Mar 17 2022 at 11:10)</a>:</h4>
<p>idk why there isnt one in the cosnt eval resolve thing?</p>



<a name="275636334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636334">(Mar 17 2022 at 11:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275636312">said</a>:</p>
<blockquote>
<p>idk why there isnt one in the cosnt eval resolve thing?</p>
</blockquote>
<p>?</p>



<a name="275636347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636347">(Mar 17 2022 at 11:10)</a>:</h4>
<p>the param env in that const_eval_resolve call has no caller bounds</p>



<a name="275636357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636357">(Mar 17 2022 at 11:10)</a>:</h4>
<p>we also removed lazy normalization for constants from the compiler (or well, the lazy unification part, normalization is still lazy)</p>



<a name="275636401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636401">(Mar 17 2022 at 11:11)</a>:</h4>
<p>apparently, without noticing</p>



<a name="275636417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636417">(Mar 17 2022 at 11:11)</a>:</h4>
<p>so we still have <code>ConstEquate</code> predicates, but just never emit them xd</p>



<a name="275636492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636492">(Mar 17 2022 at 11:12)</a>:</h4>
<p>wait we did what now <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275636516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636516">(Mar 17 2022 at 11:12)</a>:</h4>
<p>yeah, <code>generic_const_exprs</code> always unified eagerly</p>



<a name="275636570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636570">(Mar 17 2022 at 11:13)</a>:</h4>
<p>we definitely used to make <code>ConstEquate</code> so when did we stop <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275636597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636597">(Mar 17 2022 at 11:13)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/88369">https://github.com/rust-lang/rust/pull/88369</a> i think</p>



<a name="275636608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636608">(Mar 17 2022 at 11:13)</a>:</h4>
<p>uhh</p>



<a name="275636662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636662">(Mar 17 2022 at 11:14)</a>:</h4>
<p>that PR just renames feature gates and deletes a bunch of tests iirc</p>



<a name="275636706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636706">(Mar 17 2022 at 11:14)</a>:</h4>
<p>i wouldnt expect that to have changed stuff in generic const exprs to stop making const equate obligatons <span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span></p>



<a name="275636710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636710">(Mar 17 2022 at 11:14)</a>:</h4>
<p>time for a <code>git blame</code> adventure</p>



<a name="275636753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636753">(Mar 17 2022 at 11:15)</a>:</h4>
<p>ah, I forgot how we did that</p>



<a name="275636755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636755">(Mar 17 2022 at 11:15)</a>:</h4>
<p>nm</p>



<a name="275636765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636765">(Mar 17 2022 at 11:15)</a>:</h4>
<p>aaaaaaaaaaaaaaaaaaa, yikes</p>



<a name="275636786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636786">(Mar 17 2022 at 11:15)</a>:</h4>
<p>yeah, we didn't remove the lazy unifying</p>



<a name="275636812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636812">(Mar 17 2022 at 11:15)</a>:</h4>
<p>I would assume that <code>InferCtxt::try_unify_abstract_consts</code> should have been updated alongside <code>InferCtxt::const_eval_resolve</code> when we made it stall on inference vars</p>



<a name="275636909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636909">(Mar 17 2022 at 11:16)</a>:</h4>
<p>because its probably replacing a <code>_</code> subst with <code>^0</code> which we  then try to evalaute which was what was causing those codegen fuflill obligaton ICEs</p>



<a name="275636941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636941">(Mar 17 2022 at 11:16)</a>:</h4>
<p>but I have not looked at those test failures much atall <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275636984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275636984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275636984">(Mar 17 2022 at 11:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275636812">said</a>:</p>
<blockquote>
<p>I would assume that <code>InferCtxt::try_unify_abstract_consts</code> should have been updated alongside <code>InferCtxt::const_eval_resolve</code> when we made it stall on inference vars</p>
</blockquote>
<p>yes</p>



<a name="275637035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637035">(Mar 17 2022 at 11:17)</a>:</h4>
<p>we should really fix unused substs lol</p>



<a name="275637085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637085">(Mar 17 2022 at 11:18)</a>:</h4>
<p>making consts fai lto unify if there are any inference vars in substs... not great lol</p>



<a name="275637152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637152">(Mar 17 2022 at 11:18)</a>:</h4>
<p>we however use <code>tcx.try_unify_abstract_consts</code> in <code>super_relate_consts</code> which is sus, cause i would expect us to get there with infer substs</p>



<a name="275637242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637242">(Mar 17 2022 at 11:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275636909">said</a>:</p>
<blockquote>
<p>because its probably replacing a <code>_</code> subst with <code>^0</code> which we  then try to evalaute which was what was causing those codegen fuflill obligaton ICEs</p>
</blockquote>
<p>What exactly is <code>^0</code>? The 0 is a Debruijn index I would assume. But e.g. in <code>Const { ty: usize, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:4 ~ issue_87964[8bc9]::Target::LENGTH), const_param_did: None }, substs: [T], promoted: None }) })], substs: [^0] }</code> there is not even a Binder, what does <code>^0</code> correspond to here?</p>



<a name="275637332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637332">(Mar 17 2022 at 11:20)</a>:</h4>
<blockquote>
<p>there is not even a Binder, what does ^0 correspond to here?</p>
</blockquote>
<p>to a variable bound by the imagined binder around the whole query</p>



<a name="275637373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637373">(Mar 17 2022 at 11:20)</a>:</h4>
<p>so <code>try_unify_abstract_const</code> where one consts has some infer var</p>



<a name="275637375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637375">(Mar 17 2022 at 11:20)</a>:</h4>
<p>if you add a <code>debug!(?a);</code> and <code>debug!(?b)</code> to <code>InferCtxt::try_unify_abstract_consts</code> you'll maybe see it has inference var substs</p>



<a name="275637408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637408">(Mar 17 2022 at 11:21)</a>:</h4>
<p>actually checks whether the two constants can be unified for all possible options for that infer var</p>



<a name="275637587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637587">(Mar 17 2022 at 11:23)</a>:</h4>
<p>so there is a binder here (just informally). Ordinary queries replace these bound vars with inference vars right away, but the const eval queries just don't.</p>



<a name="275637613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637613">(Mar 17 2022 at 11:23)</a>:</h4>
<p>that mostly doesn't matter, but is strictly speaking incorrect</p>



<a name="275637702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637702">(Mar 17 2022 at 11:24)</a>:</h4>
<p>and also, doing that is broken cause the caller bounds of the param env of the constant might not be satisfied for all inputs</p>



<a name="275637713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637713">(Mar 17 2022 at 11:24)</a>:</h4>
<p>which is causing these ice</p>



<a name="275637771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637771">(Mar 17 2022 at 11:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275636812">said</a>:</p>
<blockquote>
<p>I would assume that <code>InferCtxt::try_unify_abstract_consts</code> should have been updated alongside <code>InferCtxt::const_eval_resolve</code> when we made it stall on inference vars</p>
</blockquote>
<p>so for now this is probably the easiest solution</p>



<a name="275637806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275637806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275637806">(Mar 17 2022 at 11:25)</a>:</h4>
<p>but i/we really should just rework pretty much all of this from scratch xd</p>



<a name="275638561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275638561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275638561">(Mar 17 2022 at 11:33)</a>:</h4>
<p>have to say that i am really looking forward to the <code>ty::Const</code> <code>mir::ConstKind</code> split being done</p>



<a name="275638698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275638698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275638698">(Mar 17 2022 at 11:34)</a>:</h4>
<p>cause then we can work on constants in the type system without caring about mir n stuff</p>



<a name="275640255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275640255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275640255">(Mar 17 2022 at 11:50)</a>:</h4>
<p>There's still a bit I don't understand here. First I never really understood why we need to canonicalize inference variables. I just re-read <a href="https://rust-lang.github.io/chalk/book/canonical_queries/canonicalization.html">this</a>, but it doesn't really explain why we need them. Afaict canonicalization is basically replacing unbound inference variables with new inference variables, why is that necessary at all?</p>



<a name="275640301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275640301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275640301">(Mar 17 2022 at 11:51)</a>:</h4>
<p>the query system isnt great at having inference vars in arguments/return types is my understanding</p>



<a name="275640321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275640321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275640321">(Mar 17 2022 at 11:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/275636201">said</a>:</p>
<blockquote>
<p>when we equate two consts to i think we replace inference vars with the <code>for&lt;T&gt;</code> stuff</p>
</blockquote>
<p>and then specifically in the context of equating consts</p>



<a name="275640410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275640410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275640410">(Mar 17 2022 at 11:52)</a>:</h4>
<p>(all the ices in <a href="https://github.com/rust-lang/rust/issues/88166">#88166</a> are caused by inference vars in query args is my understanding)</p>



<a name="275641154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275641154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275641154">(Mar 17 2022 at 12:00)</a>:</h4>
<p>so using <code>?n</code> for some inference var and <code>^n</code> for a bound var</p>



<a name="275641319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275641319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275641319">(Mar 17 2022 at 12:00)</a>:</h4>
<p>let's say we want to check whether <code>Vec&lt;?13&gt;: Trait&lt;?4&gt;</code> holds</p>



<a name="275641354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275641354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275641354">(Mar 17 2022 at 12:01)</a>:</h4>
<p>ideally, we're able to evaluate this once and put it inside of a cache</p>



<a name="275641480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275641480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275641480">(Mar 17 2022 at 12:02)</a>:</h4>
<p>as we don't know anything about <code>?13</code> and <code>?4</code> we also want that result to apply to <code>Vec&lt;?19&gt;: Trait&lt;?7&gt;</code></p>



<a name="275641730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275641730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275641730">(Mar 17 2022 at 12:04)</a>:</h4>
<p>so, like, knowing that this holds for <code>?13</code> and <code>?4</code> is equivalent to knowing the result for all possible types instead of <code>?13</code> and <code>?4</code> (except for ambiguous results,  in that case <code>Vec&lt;u32&gt;: Trait&lt;?19&gt;</code> may have a different result). But both "this doesn't hold" and "this holds" applies to all possible inputs if it applies for <code>?13</code> and <code>?4</code></p>



<a name="275641882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275641882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275641882">(Mar 17 2022 at 12:06)</a>:</h4>
<p>so we convert <code>Vec&lt;?13&gt;: Trait&lt;?4&gt;</code> to some canonical form, which is <code>for&lt;^0, ^1&gt; Vec&lt;^0&gt;: Trait&lt;^1&gt;</code> (where the outer binder is implicit, because <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span>)</p>



<a name="275642245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275642245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275642245">(Mar 17 2022 at 12:09)</a>:</h4>
<p>ok thanks a lot. that makes sense</p>



<a name="275642273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275642273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275642273">(Mar 17 2022 at 12:10)</a>:</h4>
<p><del>inside of the query, we then replace <code>^0, ^1</code> with new inference variables. We do this so that if by searching for a result to <code>for&lt;^0, ^1&gt; Vec&lt;^0&gt;: Trait&lt;^1&gt;</code> we might figure out that <code>^1</code> HAS to be <code>u32</code></del></p>



<a name="275642455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275642455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275642455">(Mar 17 2022 at 12:11)</a>:</h4>
<p>In what way do we unify lazily now?</p>



<a name="275642974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275642974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275642974">(Mar 17 2022 at 12:17)</a>:</h4>
<p>when unifying an unevaluated const with something else, e.g. by using <code>struct Equate</code> in the compiler, we put a <code>ConstEquate</code> obligation into the current <code>FulfillmentContext</code> which we then try to prove later</p>



<a name="275642982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275642982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275642982">(Mar 17 2022 at 12:17)</a>:</h4>
<p>but we start by pretending like <code>Unevaluated</code> constants always unify successfully</p>



<a name="275643183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643183">(Mar 17 2022 at 12:19)</a>:</h4>
<p>ah yes. And why do we want to remove this now?</p>



<a name="275643647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643647">(Mar 17 2022 at 12:23)</a>:</h4>
<p>did i say in this thread that we want to remove it? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="275643749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643749">(Mar 17 2022 at 12:24)</a>:</h4>
<p>i want to remove it because it is unnecessary and adds additional complexity</p>



<a name="275643768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643768">(Mar 17 2022 at 12:24)</a>:</h4>
<p>or at least mostly unnecessary</p>



<a name="275643810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643810">(Mar 17 2022 at 12:25)</a>:</h4>
<p>so I would prefer to remove it and then add it back once we have some examples where it is needed</p>



<a name="275643839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643839">(Mar 17 2022 at 12:25)</a>:</h4>
<p>instead of keeping it around rn while being unable to deal with hrtb</p>



<a name="275643840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275643840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275643840">(Mar 17 2022 at 12:25)</a>:</h4>
<p>we wouldnt be able to do the stalling on inference vars if theres no obligation <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275644078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/275644078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#275644078">(Mar 17 2022 at 12:27)</a>:</h4>
<p>that's true, though tbf I don't want to stall on inference vars if we can avoid it <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="276029649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276029649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276029649">(Mar 21 2022 at 10:21)</a>:</h4>
<p>I think it would be nice if we could check for infer vars in the <code>const_eval_resolve</code> query and return <code>Err(TooGeneric)</code> there instead of returning <code>false</code> in <code>try_unify_abstract_consts</code> if either constant contains inference variables. Unfortunately the <code>canonicalize_query</code> call in <code>try_unify_abstract_consts</code> kind of messes this up in that <code>ct.substs: [^0]</code> does not contain infer vars according to <code>has_infer_types_or_consts</code>.  What type flags would we need to check for here instead?</p>



<a name="276043872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276043872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276043872">(Mar 21 2022 at 12:41)</a>:</h4>
<p>The following (minimized) test still fails with a cycle error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">PhantomData</span><span class="p">;</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">TensorDimension</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DIM</span><span class="w"> </span>: <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">trait</span><span class="w"> </span><span class="n">TensorSize</span><span class="w"> </span>: <span class="nc">TensorDimension</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">usize</span><span class="p">;</span><span class="bp">Self</span>::<span class="n">DIM</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="nc">TensorSize</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">OLDDIM</span><span class="w"> </span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DIM</span><span class="w"> </span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span>: <span class="p">[</span><span class="kt">usize</span><span class="p">;</span><span class="n">DIM</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="n">phantom</span>: <span class="nc">PhantomData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="nc">TensorSize</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">DIM</span><span class="w"> </span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TensorDimension</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="n">DIM</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DIM</span><span class="w"> </span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">DIM</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="nc">TensorSize</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">DIM</span><span class="w"> </span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TensorSize</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="n">DIM</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">usize</span><span class="p">;</span><span class="n">DIM</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="bp">self</span><span class="p">.</span><span class="n">size</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0391</span><span class="p">]</span>: <span class="nc">cycle</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="err">`</span><span class="o">&lt;</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorDimension</span><span class="o">&gt;</span>::<span class="n">DIM</span><span class="err">`</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">ui</span><span class="o">/</span><span class="k">const</span><span class="o">-</span><span class="n">generics</span><span class="o">/</span><span class="n">issues</span><span class="o">/</span><span class="n">issue</span><span class="o">-</span><span class="mf">83765.</span><span class="n">rs</span>:<span class="mi">7</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="n">DIM</span><span class="w"> </span>: <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="n">note</span>: <span class="o">..</span><span class="p">.</span><span class="n">which</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="err">`</span><span class="n">TensorDimension</span><span class="err">`</span><span class="w"> </span><span class="n">fulfills</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">obligations</span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">ui</span><span class="o">/</span><span class="k">const</span><span class="o">-</span><span class="n">generics</span><span class="o">/</span><span class="n">issues</span><span class="o">/</span><span class="n">issue</span><span class="o">-</span><span class="mf">83765.</span><span class="n">rs</span>:<span class="mi">6</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">TensorDimension</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">^^^^^^^^^^^^^^^^^^^^^</span><span class="w"></span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="o">..</span><span class="p">.</span><span class="n">which</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="err">`</span><span class="o">&lt;</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorDimension</span><span class="o">&gt;</span>::<span class="n">DIM</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">completing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cycle</span><span class="w"></span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">cycle</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">normalizing</span><span class="w"> </span><span class="err">`</span><span class="o">&lt;</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorDimension</span><span class="o">&gt;</span>::<span class="n">DIM</span><span class="err">`</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">aborting</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">error</span><span class="w"></span>
</code></pre></div>
<p>When we try to equate <code>DIM</code> with <code>Self::DIM</code> in the return type of <code>TensorSize::size</code>, we try to resolve <code>TensorSize::size::constant#0</code> and wind up with the following resolve attempt:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_ty_utils</span>::<span class="n">instance</span>::<span class="n">resolve_instance</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">ParamEnvAnd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param_env</span>: <span class="nc">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[</span><span class="n">Binder</span><span class="p">(</span><span class="n">ConstEvaluatable</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">10</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorSize</span>::<span class="n">size</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="p">]),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">ConstEvaluatable</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">26</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">1</span><span class="p">}</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">DIM</span><span class="o">/</span>#<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}]),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorSize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorDimension</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sized</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[])],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">All</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">NotConst</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">value</span>: <span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">7</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorDimension</span>::<span class="n">DIM</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="p">])</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but then when we try to process changed obligations during <code>resolve_associated_item</code> we try to prove:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_trait_selection</span>::<span class="n">traits</span>::<span class="n">fulfill</span><span class="w"> </span><span class="n">ConstEval</span><span class="p">(</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">21</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">0</span><span class="p">}</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">DIM</span><span class="o">/</span>#<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="n">promoted</span>: <span class="p">()</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_trait_selection</span>::<span class="n">traits</span>::<span class="n">const_evaluatable</span>::<span class="n">is_const_evaluatable</span><span class="w"> </span><span class="n">uv</span><span class="o">=</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">21</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">0</span><span class="p">}</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">DIM</span><span class="o">/</span>#<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="n">promoted</span>: <span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[</span><span class="n">Binder</span><span class="p">(</span><span class="n">ConstEvaluatable</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">10</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorSize</span>::<span class="n">size</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="p">]),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">ConstEvaluatable</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">26</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">1</span><span class="p">}</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">DIM</span><span class="o">/</span>#<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}]),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorSize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorDimension</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sized</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[])],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">All</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">NotConst</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">span</span><span class="o">=</span><span class="n">no</span><span class="o">-</span><span class="n">location</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>and try to unify the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─┐</span><span class="n">rustc_trait_selection</span>::<span class="n">traits</span>::<span class="n">const_evaluatable</span>::<span class="n">try_unify</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="n">AbstractConst</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inner</span>: <span class="p">[</span><span class="n">Leaf</span><span class="p">(</span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Unevaluated</span><span class="p">(</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">7</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorDimension</span>::<span class="n">DIM</span><span class="p">),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">None</span> <span class="p">})</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">DIM</span><span class="o">/</span>#<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="n">AbstractConst</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inner</span>: <span class="p">[</span><span class="n">Leaf</span><span class="p">(</span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Unevaluated</span><span class="p">(</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">7</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorDimension</span>::<span class="n">DIM</span><span class="p">),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="bp">Self</span><span class="p">],</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">None</span> <span class="p">})</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">param_env</span><span class="o">=</span><span class="n">ParamEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller_bounds</span>: <span class="p">[</span><span class="n">Binder</span><span class="p">(</span><span class="n">ConstEvaluatable</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">10</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorSize</span>::<span class="n">size</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="p">]),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">ConstEvaluatable</span><span class="p">(</span><span class="n">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">26</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">1</span><span class="p">}</span>::<span class="p">{</span><span class="n">constant</span>#<span class="mi">0</span><span class="p">}),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Param</span><span class="p">(</span><span class="n">DIM</span><span class="o">/</span>#<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}]),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorSize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TensorDimension</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sized</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[])],</span><span class="w"> </span><span class="n">reveal</span>: <span class="nc">All</span><span class="p">,</span><span class="w"> </span><span class="n">constness</span>: <span class="nc">NotConst</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and since we evaluate now in <code>try_unify</code> we wind up with a cycle when trying to evaluate:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">├─</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustc_trait_selection</span>::<span class="n">traits</span>::<span class="n">const_evaluatable</span><span class="w"> </span><span class="n">a_root</span><span class="o">=</span><span class="n">Leaf</span><span class="p">(</span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Unevaluated</span><span class="p">(</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">7</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorDimension</span>::<span class="n">DIM</span><span class="p">),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">None</span> <span class="p">})</span><span class="w"> </span><span class="p">}),</span><span class="w"> </span><span class="n">b_root</span><span class="o">=</span><span class="n">Leaf</span><span class="p">(</span><span class="n">Const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ty</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Unevaluated</span><span class="p">(</span><span class="n">Unevaluated</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">def</span>: <span class="nc">WithOptConstParam</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">did</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">7</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">issue_83765</span><span class="p">[</span><span class="n">c100</span><span class="p">]</span>::<span class="n">TensorDimension</span>::<span class="n">DIM</span><span class="p">),</span><span class="w"> </span><span class="n">const_param_did</span>: <span class="nb">None</span> <span class="p">},</span><span class="w"> </span><span class="n">substs</span>: <span class="p">[</span><span class="n">LazyUpdim</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">T</span>::<span class="n">DIM</span><span class="p">},</span><span class="w"> </span><span class="n">DIM</span><span class="o">&gt;</span><span class="p">],</span><span class="w"> </span><span class="n">promoted</span>: <span class="nb">None</span> <span class="p">})</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
</code></pre></div>



<a name="276050032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276050032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276050032">(Mar 21 2022 at 13:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60/near/276029649">said</a>:</p>
<blockquote>
<p>I think it would be nice if we could check for infer vars in the <code>const_eval_resolve</code> query and return <code>Err(TooGeneric)</code> there instead of returning <code>false</code> in <code>try_unify_abstract_consts</code> if either constant contains inference variables. Unfortunately the <code>canonicalize_query</code> call in <code>try_unify_abstract_consts</code> kind of messes this up in that <code>ct.substs: [^0]</code> does not contain infer vars according to <code>has_infer_types_or_consts</code>.  What type flags would we need to check for here instead?</p>
</blockquote>
<p>we cannot  check for infer vars inside of a query because calling a query with infer vars causes an ICE. Infer vars should never leak from the current <code>InferCtxt</code> even if we don't care about them (because in that case they still have a horrible impact on caching)</p>



<a name="276050117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276050117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276050117">(Mar 21 2022 at 13:28)</a>:</h4>
<p>you could add a function to <code>TyCtxt</code> which checks for infer vars and only calls the query if there aren't any</p>



<a name="276050557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276050557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276050557">(Mar 21 2022 at 13:32)</a>:</h4>
<blockquote>
<p>The following (minimized) test still fails with a cycle error:</p>
</blockquote>
<p>can you try it with <code>-Ztreat-err-as-bug</code> and then paste the ICE. tbh cycles here aren't too surprising in general, so I don't mind this breaking</p>



<a name="276051206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276051206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276051206">(Mar 21 2022 at 13:37)</a>:</h4>
<p><a href="/user_uploads/4715/59WBjh3TIaKbHPBaQ3XC-YTf/cycle_error.txt">cycle_error.txt</a></p>



<a name="276051837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276051837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276051837">(Mar 21 2022 at 13:42)</a>:</h4>
<p>yeah, didn't look into this too deeply, but that cycle is expected for now</p>



<a name="276051860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276051860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276051860">(Mar 21 2022 at 13:42)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">TensorSize</span><span class="w"> </span>: <span class="nc">TensorDimension</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">usize</span><span class="p">;</span><span class="bp">Self</span>::<span class="n">DIM</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276051960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276051960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276051960">(Mar 21 2022 at 13:43)</a>:</h4>
<p>to check that the <code>TensorSize</code> trait is well formed, we have check all its bounds, including the implicit <code>ConstEvaluatable({ Self::DIM })</code> bound</p>



<a name="276052440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276052440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276052440">(Mar 21 2022 at 13:46)</a>:</h4>
<p>so if <code>TensorDimension</code> and <code>TensorSize</code> are the same trait, that's trivial as:<br>
when checking that <code>{ Self::DIM }</code> is const evaluatable, we check that <code>Self::DIM</code> is well formed, for that we would have to check that <code>Self: TensorSize</code> is well formed. That currently also requires us to prove all bounds of <code>TensorSize</code>, meanign that we again have to check <code>ConstEvaluatable({ Self::DIM })</code>, causing a cycle</p>



<a name="276052584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276052584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276052584">(Mar 21 2022 at 13:47)</a>:</h4>
<p>it seems to me like when slippy associated consts and use into two traits, this cycle only happens for impls, e.g. when checking that <code> LazyUpdim&lt;T,{T::DIM},DIM&gt;: TensorSize</code> holds</p>



<a name="276052657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276052657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276052657">(Mar 21 2022 at 13:48)</a>:</h4>
<p>so yeah, that cycle looks expected to me and requires some bigger changes to rustc</p>



<a name="276052711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260443-project-const-generics/topic/eval%20in%20%60try_unify%60/near/276052711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/260443-project-const-generics/topic/eval.20in.20.60try_unify.60.html#276052711">(Mar 21 2022 at 13:48)</a>:</h4>
<p>if the test already exists in our suite, add a <code>FIXME</code> and accept the cycle, if not please open an issue about it to track this '^^</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>