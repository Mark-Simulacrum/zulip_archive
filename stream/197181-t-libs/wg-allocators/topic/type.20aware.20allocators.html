<html>
<head><meta charset="utf-8"><title>type aware allocators · t-libs/wg-allocators · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/index.html">t-libs/wg-allocators</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/type.20aware.20allocators.html">type aware allocators</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257727325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/type%20aware%20allocators/near/257727325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Casper <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/type.20aware.20allocators.html#257727325">(Oct 15 2021 at 16:38)</a>:</h4>
<p>Hi, I just want to advertise the issue I opened on Github here since there seems to be more traffic in this chatroom.</p>
<p>TL; DR: I think its a good idea to pass the allocated type to the allocator. It costs extra monomorphization but enables some security and performance features:</p>
<ul>
<li>The allocator can have a slower secure path to hide boxed functions or cryptographic keys to defend against heap overflow attacks and;</li>
<li>put short-lived-request-related objects in a thread local linear allocator or;</li>
<li>separate known shared global objects from thread-specific sub-allocators </li>
</ul>
<p><a href="https://github.com/rust-lang/wg-allocators/issues/91">https://github.com/rust-lang/wg-allocators/issues/91</a></p>



<a name="257794817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/type%20aware%20allocators/near/257794817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/type.20aware.20allocators.html#257794817">(Oct 16 2021 at 02:58)</a>:</h4>
<p>This would have huge implications for <code>Vec::from_raw_parts(_in)</code> and similar, I think.  Right now you can rebuild a <code>Vec</code> as a different type so long as you meet</p>
<blockquote>
<p><code>T</code> needs to have the same size and alignment as what <code>ptr</code> was allocated with.</p>
</blockquote>
<p>And you can use that to soundly go between <code>Vec&lt;Color&gt;</code> and <code>Vec&lt;[u8; 3]&gt;</code> and such, which I think is a reasonable expectation.</p>
<p>Things like putting short-lived things in a request-specific allocator sounds to me like it should be done by passing the allocator, not by specializing an allocator for particular types.  I'd want <code>String</code>s to be request-local often, but I definitely can't do that by specializing on <code>u8</code> in the allocator.</p>



<a name="257796045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/type%20aware%20allocators/near/257796045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Casper <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/type.20aware.20allocators.html#257796045">(Oct 16 2021 at 03:19)</a>:</h4>
<p>Good points. For backwards compatibility, I agree its not a good idea to enforce "allocate and deallocate with the same T", and  the request-specific-allocator for performance idea is a little bit of a reach. Local allocators are sufficient. That said, local allocators can still benefit, performance-wise, from type awareness by allocating data that is known to be moved between threads in a non-thread-specific arena. (and of course hide secrets/fn ptrs)</p>



<a name="257798512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/type%20aware%20allocators/near/257798512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/type.20aware.20allocators.html#257798512">(Oct 16 2021 at 04:00)</a>:</h4>
<p>If allocate and deallocate don't need to be the same <code>T</code>, though, I think that's pretty much fatal to the whole usefulness, though.  I could make a <code>Vec&lt;*const u32&gt;</code> -- where <code>T: !Send + !Sync</code> -- but then do the <code>from_raw_parts</code> trick to make turn it into a <code>Vec&lt;ReprTransparentAroundAPointer&gt;</code> that actually does go between threads.</p>



<a name="258453081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/type%20aware%20allocators/near/258453081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Casper <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/type.20aware.20allocators.html#258453081">(Oct 20 2021 at 22:15)</a>:</h4>
<p>Scott, what do you think of my response on github?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>