<html>
<head><meta charset="utf-8"><title>fallible allocation for containers · t-libs/wg-allocators · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/index.html">t-libs/wg-allocators</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/fallible.20allocation.20for.20containers.html">fallible allocation for containers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258765492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/fallible%20allocation%20for%20containers/near/258765492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Raekye <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/fallible.20allocation.20for.20containers.html#258765492">(Oct 22 2021 at 19:57)</a>:</h4>
<p>Hi, I'm considering giving a shot at <a href="https://github.com/rust-lang/wg-allocators/issues/39">https://github.com/rust-lang/wg-allocators/issues/39</a> (adding try_* methods for containers). That issue lists the following API:</p>
<div class="codehilite"><pre><span></span><code>// OnOomError is a variable, `try_*` is always available
fn try_push(&amp;mut self: Vec&lt;T, A: AllocRef, OnOomError&gt;, t: T) -&gt; Result&lt;(), (AllocError, T)&gt; { .. }

// NoAbort is a data type, used as a sentinel indicating the consumer is prohibited from using the aborting methods.
struct NoAbort();

// Abort is a data type, used as a sentinel indicating the consumer is allowed to use the aborting methods.
struct Abort();

fn push(&amp;mut self: Vec&lt;T, A: AllocRef, Abort&gt;, t: T) -&gt; T {
   match self.push(t) {
     OK(v) =&gt; v,
     Err(e) =&gt; handle_alloc_error(e),
  }
}
</code></pre></div>
<p>One possible concern I've noticed is that <code>BTreeMap</code> and <code>HashMap</code> already have <code>try_insert</code> functions (<a href="https://doc.rust-lang.org/std/collections/struct.BTreeMap.html#method.try_insert"><code>BTreeMap</code></a>, <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html#method.try_insert"><code>HashMap</code></a>), which handle something different from fallible allocation; they return <code>Ok</code> if the insertion happened, or <code>Err</code> if the key already existed. So <code>try_*</code> may not be a good name for fallible allocating operations?</p>
<p>At the same time, the issue also links <a href="#narrow/stream/197181-t-libs.2Fwg-allocators/topic/Design.20of.20.60AbortAlloc.60.20not.20compatible.20with.20.60try_reserve.60">this Zuplip thread</a> which is a long thread, but it seems to propose adding a <code>FallibleVec</code> which is convertible with <code>Vec</code> (and I assume similar for other containers) either through an explicit method or <code>into()</code>.</p>
<p>But given that that thread was nearly 2 years ago, what's the current status of fallible allocations for containers? Similarly, the <a href="https://github.com/rust-lang/wg-allocators/issues/48">roadmap</a> hasn't been active since the end of 2020, and the <a href="https://github.com/rust-lang/wg-allocators/issues">github issues</a> don't seem particularly active either</p>



<a name="277055945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/fallible%20allocation%20for%20containers/near/277055945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Ericson <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/fallible.20allocation.20for.20containers.html#277055945">(Mar 29 2022 at 19:45)</a>:</h4>
<p><span class="user-mention" data-user-id="437904">@Raekye</span> I think <a href="https://github.com/rust-lang/rust/pull/95051">https://github.com/rust-lang/rust/pull/95051</a> does a good job of pushing this along again.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>