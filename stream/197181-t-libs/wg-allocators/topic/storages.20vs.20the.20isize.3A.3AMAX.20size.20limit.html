<html>
<head><meta charset="utf-8"><title>storages vs the isize::MAX size limit · t-libs/wg-allocators · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/index.html">t-libs/wg-allocators</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html">storages vs the isize::MAX size limit</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278370553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370553">(Apr 08 2022 at 22:37)</a>:</h4>
<p>I've been playing with storages again, and I ran into an interesting point.</p>



<a name="278370567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370567">(Apr 08 2022 at 22:37)</a>:</h4>
<p>(why: <a href="https://dev.to/cad97/dyn-doesnt-need-to-be-special-3ldm">https://dev.to/cad97/dyn-doesnt-need-to-be-special-3ldm</a>)</p>



<a name="278370602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370602">(Apr 08 2022 at 22:37)</a>:</h4>
<p>We're looking at enforcing the isize::MAX size limit in Layout, since it's proven unreasonable to manually handle</p>



<a name="278370657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370657">(Apr 08 2022 at 22:38)</a>:</h4>
<p>See: <a href="https://github.com/rust-lang/rust/pull/95295">https://github.com/rust-lang/rust/pull/95295</a></p>



<a name="278370688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370688">(Apr 08 2022 at 22:39)</a>:</h4>
<p>But with storages, you're passing in <code>&lt;T as Pointee&gt;::Metadata</code>, not <code>Layout</code></p>



<a name="278370703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370703">(Apr 08 2022 at 22:39)</a>:</h4>
<p>So obviously the solution is to handle too-large <code>Layout</code> in storages, right?</p>



<a name="278370823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370823">(Apr 08 2022 at 22:40)</a>:</h4>
<p>But how? You need some what to get the size from the pointer metadata (which at <em>least</em> you can assume is valid, I hope), but the primitive <code>size_of_val_raw</code> requires the size to fit <code>isize::MAX</code> as an input invariant</p>



<a name="278370847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370847">(Apr 08 2022 at 22:41)</a>:</h4>
<p>(BTW, If that PR lands and <a href="https://github.com/rust-lang/rust/pull/95361">https://github.com/rust-lang/rust/pull/95361</a> does, then I'll make a similar type to make it a validity invariant to be outside the isize::MAX limit)</p>



<a name="278370867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370867">(Apr 08 2022 at 22:41)</a>:</h4>
<p>I think that it's time to make the built-in sizeof return an option (or a threestate for extern type) so it's possible to check just metadata</p>



<a name="278370955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/storages%20vs%20the%20isize%3A%3AMAX%20size%20limit/near/278370955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/storages.20vs.20the.20isize.3A.3AMAX.20size.20limit.html#278370955">(Apr 08 2022 at 22:43)</a>:</h4>
<p>IOW I think we need <code>unsafe fn Layout::for_metadata&lt;T&gt;(&lt;T as Pointee&gt;::Metadata) -&gt; Option&lt;Layout&gt;</code> which requires valid metadata but not for the described <code>T</code> to fit <code>isize::MAX</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>