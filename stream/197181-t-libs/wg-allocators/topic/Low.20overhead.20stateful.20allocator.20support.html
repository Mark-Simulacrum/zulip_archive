<html>
<head><meta charset="utf-8"><title>Low overhead stateful allocator support · t-libs/wg-allocators · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/index.html">t-libs/wg-allocators</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Low.20overhead.20stateful.20allocator.20support.html">Low overhead stateful allocator support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270317671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Low%20overhead%20stateful%20allocator%20support/near/270317671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ahmed Charles <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Low.20overhead.20stateful.20allocator.20support.html#270317671">(Feb 02 2022 at 01:14)</a>:</h4>
<p>Has there been thought given to supporting stateful allocators without storing the required state multiple times? For example, given a struct like:</p>
<div class="codehilite"><pre><span></span><code>struct Outer {
    a: Box&lt;A&gt;,
    b: Box&lt;B&gt;,
    c: Box&lt;C&gt;,
    ...
}
</code></pre></div>
<p>A stateful allocator with a usize state would take up 3 usize's in the struct rather than 1. If there were a mechanism to provide the allocator/deallocator with the state explicitly, then the state could be stored in the <code>Outer</code> struct and provided during it's destructor.</p>



<a name="270325800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Low%20overhead%20stateful%20allocator%20support/near/270325800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Low.20overhead.20stateful.20allocator.20support.html#270325800">(Feb 02 2022 at 02:52)</a>:</h4>
<p>For Larger allocators (&gt;pointer sized) , you can use <code>&amp;'a A</code> allocators. Doesn't become ZST, though.</p>



<a name="270414800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Low%20overhead%20stateful%20allocator%20support/near/270414800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Low.20overhead.20stateful.20allocator.20support.html#270414800">(Feb 02 2022 at 16:37)</a>:</h4>
<p>The hard part is figuring out how to pass the allocator to the individual boxes when they are dropped. Rust currently has no mechanism to enable this.</p>



<a name="270424639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Low%20overhead%20stateful%20allocator%20support/near/270424639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Low.20overhead.20stateful.20allocator.20support.html#270424639">(Feb 02 2022 at 17:29)</a>:</h4>
<p>You'd have to make an alternative Box type that was manually dropped and then the drop of the Outer type would pass in the usize to each manual drop. Annoying to write, but saves space and all that.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>