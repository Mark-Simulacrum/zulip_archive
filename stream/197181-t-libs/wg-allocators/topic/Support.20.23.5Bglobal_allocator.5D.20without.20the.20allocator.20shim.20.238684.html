<html>
<head><meta charset="utf-8"><title>Support #[global_allocator] without the allocator shim #8684 · t-libs/wg-allocators · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/index.html">t-libs/wg-allocators</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html">Support #[global_allocator] without the allocator shim #8684</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250857084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/250857084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#250857084">(Aug 26 2021 at 23:32)</a>:</h4>
<p>I just wanted to post and draw some attention to this PR in case anyone here has opinions about merging it.<br>
<a href="https://github.com/rust-lang/rust/pull/86844">https://github.com/rust-lang/rust/pull/86844</a></p>



<a name="277469326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277469326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277469326">(Apr 01 2022 at 19:47)</a>:</h4>
<p>I want to <em>re-raise</em> attention to this PR (<a href="https://github.com/rust-lang/rust/issues/86844">#86844</a>), and to the alternative " create -Z force-allocator-shim codegen option" PR <a href="https://github.com/rust-lang/rust/issues/94389">#94389</a> which tries to provide a narrower solution to a narrower problem (IIUC). I'm looking at both at the moment but I think I colud use more context from you all about what people need in practice.</p>



<a name="277469646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277469646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277469646">(Apr 01 2022 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> You have stated that you prefer PR <a href="https://github.com/rust-lang/rust/issues/86844">#86844</a>. I do not yet have any problem with landing <a href="https://github.com/rust-lang/rust/issues/86844">#86844</a>, apart from it just <em>being</em> a bigger change. So my immediate question is: Is there a reason to <em>not</em> land <a href="https://github.com/rust-lang/rust/issues/94389">#94389</a> anyway, while separately deciding about <a href="https://github.com/rust-lang/rust/issues/86844">#86844</a>?</p>



<a name="277469711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277469711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277469711">(Apr 01 2022 at 19:51)</a>:</h4>
<p>The option introduced in that PR would need to be removed again after my PR.</p>



<a name="277469780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277469780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277469780">(Apr 01 2022 at 19:52)</a>:</h4>
<p>Oh, I suppose that's a drawback</p>



<a name="277469782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277469782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277469782">(Apr 01 2022 at 19:52)</a>:</h4>
<p>okay</p>



<a name="277476902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277476902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277476902">(Apr 01 2022 at 20:59)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I'm overall in favor of this change, though its insta-stable nature is of course risky</p>



<a name="277477172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477172">(Apr 01 2022 at 21:01)</a>:</h4>
<p>Would you feel better if I added a dummy __rust_no_alloc_shim_unstable function to the allocator shim to force linking in the allocator shim even with #[global_allocator] for now?</p>



<a name="277477184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477184">(Apr 01 2022 at 21:01)</a>:</h4>
<p>that's an interesting idea</p>



<a name="277477322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477322">(Apr 01 2022 at 21:03)</a>:</h4>
<p>by the way, just to confirm: the <code>_rg_</code>- and <code>_rdl_</code>-prefixed symbols are hidden and cannot be linked from user code, right? I.e. there's no way that aspect of the changes here, the replacement of <code>_rg_</code> with <code>_rust_</code>, there's no way someone could have been linking to the <code>_rg_</code>- forms, right?</p>



<a name="277477361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477361">(Apr 01 2022 at 21:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/197181-t-libs.2Fwg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684/near/277477172">said</a>:</p>
<blockquote>
<p>Would you feel better if I added a dummy __rust_no_alloc_shim_is_unstable function to the allocator shim to force linking in the allocator shim even with #[global_allocator] for now?</p>
</blockquote>
<p>What would that mean for your goal of making this code work with <code>--emit obj</code> ?</p>



<a name="277477441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477441">(Apr 01 2022 at 21:04)</a>:</h4>
<p>(I assume it would mean <em>that</em> part of the goal would be delayed)</p>



<a name="277477763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477763">(Apr 01 2022 at 21:07)</a>:</h4>
<p><code>__rg_*</code> and <code>__rdl_*</code> symbols can technically be linked by user code, but we don't provide any guarantee it will remain to work afaik just like for all other internal <code>__*</code> symbols.</p>



<a name="277477865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277477865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277477865">(Apr 01 2022 at 21:08)</a>:</h4>
<p>oh, okay. I must have misunderstood some of the comments I read</p>



<a name="277478067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277478067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277478067">(Apr 01 2022 at 21:10)</a>:</h4>
<p><code>__rust_no_alloc_shim_is_unstable</code> would delay allowing stable <code>--emit obj</code> with liballoc. Users who want want to commit to using it unstable only have to define this symbol and then don't have to define the various <code>__rust_*</code> symbols of the allocator shim. For example rust-for-linux currently defines them itself and would switch to defining <code>__rust_no_alloc_shim_is_unstable</code> until we stabilize this.</p>



<a name="277478148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277478148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277478148">(Apr 01 2022 at 21:11)</a>:</h4>
<p>Hmm. that <em>does</em> sound better.</p>



<a name="277478170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277478170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277478170">(Apr 01 2022 at 21:11)</a>:</h4>
<p>Okay, yeah, if you can update the PR to look like that, then I'd r+ it pronto, I think.</p>



<a name="277478260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277478260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277478260">(Apr 01 2022 at 21:12)</a>:</h4>
<p>thanks for the clarifications!</p>



<a name="277478447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Support%20%23%5Bglobal_allocator%5D%20without%20the%20allocator%20shim%20%238684/near/277478447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Support.20.23.5Bglobal_allocator.5D.20without.20the.20allocator.20shim.20.238684.html#277478447">(Apr 01 2022 at 21:14)</a>:</h4>
<p>I will update it tomorrow.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>