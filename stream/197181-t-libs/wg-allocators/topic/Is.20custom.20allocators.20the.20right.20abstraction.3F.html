<html>
<head><meta charset="utf-8"><title>Is custom allocators the right abstraction? · t-libs/wg-allocators · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/index.html">t-libs/wg-allocators</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html">Is custom allocators the right abstraction?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="218178617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218178617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Diekmann <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218178617">(Nov 28 2020 at 19:58)</a>:</h4>
<p><strong>matthieum</strong> has started an <a href="https://internals.rust-lang.org/t/is-custom-allocators-the-right-abstraction/13460">interesting proposal at IRL.org</a> which is really worth taking a look at.</p>
<p><strong>TL;DR: </strong><br>
Use a more generic trait for collections, which abstracts over storages rather than allocators.</p>



<a name="218179020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179020">(Nov 28 2020 at 20:09)</a>:</h4>
<p>Storage instead of an Allocator as a generic makes sense for contiguous data structures (Vec, Box), but not as much for non-contiguous ones (LinkedList), I think?</p>



<a name="218179076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Ericson <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179076">(Nov 28 2020 at 20:10)</a>:</h4>
<p>Agreed</p>



<a name="218179079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Ericson <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179079">(Nov 28 2020 at 20:10)</a>:</h4>
<p>But it would be nice to do both</p>



<a name="218179083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Diekmann <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179083">(Nov 28 2020 at 20:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/197181-t-libs.2Fwg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F/near/218179020">said</a>:</p>
<blockquote>
<p>Storage instead of an Allocator as a generic makes sense for contiguous data structures (Vec, Box), but not as much for non-contiguous ones (LinkedList), I think?</p>
</blockquote>
<p>Interesting question, the OP says, it <em>could</em> be possible.</p>



<a name="218179088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Ericson <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179088">(Nov 28 2020 at 20:11)</a>:</h4>
<p>(I wrote a one off ring buffer recently and was sad)</p>



<a name="218179090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Diekmann <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179090">(Nov 28 2020 at 20:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220594">John Ericson</span> <a href="#narrow/stream/197181-t-libs.2Fwg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F/near/218179079">said</a>:</p>
<blockquote>
<p>But it would be nice to do both</p>
</blockquote>
<p>Like having <code>AllocRef</code> and <code>Storage</code>?</p>



<a name="218179093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218179093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Diekmann <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218179093">(Nov 28 2020 at 20:11)</a>:</h4>
<p>That would be simply possible with <code>AllocatorStorage</code> I think.</p>



<a name="218182695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/218182695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Ericson <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#218182695">(Nov 28 2020 at 21:47)</a>:</h4>
<p>I'll need to look at the propose, but i mean in vague terms all collections should allow some variation on this front, and the "flat" ones should allow more</p>



<a name="272299445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272299445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272299445">(Feb 17 2022 at 18:05)</a>:</h4>
<p>Is this proposal still under consideration? I've seen a few proofs of concept but I haven't seen any movement recently. It was mentioned in <a href="https://github.com/rust-lang/rust/pull/90822#issuecomment-1042578706">this PR comment</a>.</p>



<a name="272317353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272317353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272317353">(Feb 17 2022 at 20:20)</a>:</h4>
<p>speaking as a member of t-libs-api, its certainly under my consideration now</p>



<a name="272317426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272317426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272317426">(Feb 17 2022 at 20:20)</a>:</h4>
<p>I can't speak for wg-allocators tho because I've been uninvolved so far</p>



<a name="272317431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272317431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272317431">(Feb 17 2022 at 20:21)</a>:</h4>
<p>though hoping to change that</p>



<a name="272317872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272317872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272317872">(Feb 17 2022 at 20:24)</a>:</h4>
<p>and on a related note <span class="user-mention" data-user-id="447178">@David Koloski</span>, I'm having trouble understanding your comment <a href="https://github.com/rust-lang/rust/pull/90822#issuecomment-1043248588">https://github.com/rust-lang/rust/pull/90822#issuecomment-1043248588</a></p>



<a name="272317908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272317908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272317908">(Feb 17 2022 at 20:25)</a>:</h4>
<blockquote>
<p>Boxed allocators and pinned boxes (that is, Pin&lt;&amp;mut Box&lt;T, A&gt;&gt; not Pin&lt;Box&lt;T, A&gt;&gt;) don't seem like they have a use case. Everything would just end up trading Allocator for PinAllocator and nobody would use Allocator.</p>
</blockquote>



<a name="272318062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272318062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272318062">(Feb 17 2022 at 20:26)</a>:</h4>
<p>confused by what <code>Pin&lt;&amp;mut Box&lt;T, A&gt;&gt;</code> has to do with using a marker trait instead of <code>'static</code> for relaxing usage of <code>Box::pin_in</code> and I don't understand what you mean in the second bit about <code>PinAllocator</code>.</p>



<a name="272318487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272318487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272318487">(Feb 17 2022 at 20:30)</a>:</h4>
<p>I was mostly trying not to type out another mile of text <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> If we introduced some extra marker trait (<code>PinAlloc</code>) that said "you can move this allocator without invalidating its memory blocks" then the regular <code>Allocator</code> would have to stay pinned in order to keep memory blocks valid.</p>



<a name="272318537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272318537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272318537">(Feb 17 2022 at 20:30)</a>:</h4>
<p>So everyone would just use <code>PinAlloc</code> and there would be no point in having the un-pin <code>Allocator</code> trait</p>



<a name="272318594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272318594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272318594">(Feb 17 2022 at 20:31)</a>:</h4>
<p>maybe i misinterpreted what <code>PinAlloc</code> would mean</p>



<a name="272318760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272318760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272318760">(Feb 17 2022 at 20:32)</a>:</h4>
<p>I assumed <span class="user-mention" data-user-id="132829">@Christopher Durham</span> meant it would indicate that the allocator upholds <code>Pin</code>'s drop requirements and that it is safe to use that allocator with <code>Box::pin_in</code>, not that you could move the allocator</p>



<a name="272318800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272318800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272318800">(Feb 17 2022 at 20:33)</a>:</h4>
<p>so <code>PinAlloc</code> would more or less only be referenced in <code>Box::pin_in</code></p>



<a name="272319425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272319425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272319425">(Feb 17 2022 at 20:39)</a>:</h4>
<p><code>pin_in</code> should be sound for any <code>Allocator</code> with the current safety docs. I interpreted the comment as suggesting that we should move that particular safety guarantee to a new trait that augments <code>Allocator</code>. Without that guarantee, <code>Allocator</code> wouldn't be suitable for many use cases. So it wouldn't end up just gating <code>pin_in</code>, it would prevent most uses of <code>Allocator</code> without that extra trait.</p>



<a name="272319689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272319689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272319689">(Feb 17 2022 at 20:41)</a>:</h4>
<p>The <code>Storage</code> API suggestion works around this by returning some intermediary <code>Handle</code> type from <code>alloc</code> instead of a raw pointer. That way we don't need to guarantee that the pointer to the memory is stable, we just need to guarantee that the handle will continue to work. I think this brings its own set of problems, but I haven't dug into it too deeply.</p>



<a name="272319773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272319773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272319773">(Feb 17 2022 at 20:42)</a>:</h4>
<p>do you have examples of other usages that would need to introduce a <code>A: PinAlloc</code> if we made the suggested change without also swapping to <code>Storage</code>?</p>



<a name="272319980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272319980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272319980">(Feb 17 2022 at 20:44)</a>:</h4>
<p>i guess this ties back into the earlier question about whether the pin drop validity requirement and the one on Allocator are really the same requirement or if there are other reasons why Allocators would need to ensure data is valid until the allocator and all of its clones are dropped</p>



<a name="272319987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272319987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272319987">(Feb 17 2022 at 20:44)</a>:</h4>
<p>Pretty much all the containers like <code>Box</code>, <code>Vec</code>, <code>HashMap</code>, etc would have to switch to <code>A: PinAlloc</code>. Anything that acts like an owning pointer and isn't pinned. Otherwise we could move our <code>Box&lt;T, A: Allocator&gt;</code> and there's no guarantee its pointer will continue to be valid since we moved the allocator that it allocated with.</p>



<a name="272320055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320055">(Feb 17 2022 at 20:45)</a>:</h4>
<p>wait one sec</p>



<a name="272320083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320083">(Feb 17 2022 at 20:45)</a>:</h4>
<blockquote>
<p>Memory blocks returned from an allocator must point to valid memory and retain their validity until the instance and all of its clones are dropped,</p>
<p>cloning or moving the allocator must not invalidate memory blocks returned from this allocator. A cloned allocator must behave like the same allocator, and</p>
</blockquote>



<a name="272320134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320134">(Feb 17 2022 at 20:45)</a>:</h4>
<p>these are two of the safety requirements on allocator rn</p>



<a name="272320156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320156">(Feb 17 2022 at 20:46)</a>:</h4>
<p>I thought we were talking about the first one</p>



<a name="272320195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320195">(Feb 17 2022 at 20:46)</a>:</h4>
<p>but you seem to be talking about the second?</p>



<a name="272320204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320204">(Feb 17 2022 at 20:46)</a>:</h4>
<p>am I misunderstanding</p>



<a name="272320205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320205">(Feb 17 2022 at 20:46)</a>:</h4>
<p>Oh, I'm sorry! I was talking about the second, that's the one that <code>Storage</code> is keen on changing.</p>



<a name="272320234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320234">(Feb 17 2022 at 20:46)</a>:</h4>
<p>Let's actually talk about the first one</p>



<a name="272320237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320237">(Feb 17 2022 at 20:46)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="132829">@Christopher Durham</span> was suggesting only moving the first requirement onto <code>PinAlloc</code></p>



<a name="272320296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320296">(Feb 17 2022 at 20:47)</a>:</h4>
<p>and presumably the second one would only be removed by replacing <code>Allocator</code> with <code>Storage</code></p>



<a name="272320351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320351">(Feb 17 2022 at 20:48)</a>:</h4>
<p>I guess an open question is what could even replace the first safety requirement</p>



<a name="272320495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320495">(Feb 17 2022 at 20:49)</a>:</h4>
<p>im not sure replacing the first requirement should even be a goal</p>



<a name="272320498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320498">(Feb 17 2022 at 20:49)</a>:</h4>
<p>just isolating it</p>



<a name="272320728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320728">(Feb 17 2022 at 20:51)</a>:</h4>
<p><code>PinAlloc</code> almost feels like it should be called <code>PinSafe</code> or something</p>



<a name="272320750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320750">(Feb 17 2022 at 20:51)</a>:</h4>
<p>its like send / sync for whether you can pin memory from a given allocator</p>



<a name="272320757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320757">(Feb 17 2022 at 20:51)</a>:</h4>
<blockquote>
<p>Memory blocks returned from an allocator must point to valid memory</p>
</blockquote>
<p>This part is probably uncontroversial, we need valid blocks.</p>
<blockquote>
<p>and retain their validity until the instance and all of its clones are dropped,</p>
</blockquote>
<p>If we don't guarantee this, then when are those memory blocks still valid? Any container needs to know (and control?) how long its allocated memory will live for. Without that part, I again don't think that the base trait would usable without the augment.</p>



<a name="272320789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320789">(Feb 17 2022 at 20:52)</a>:</h4>
<p>and it should only prevent using exciting allocator in async land where they want to store self referential pointers to that data</p>



<a name="272320881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272320881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272320881">(Feb 17 2022 at 20:52)</a>:</h4>
<blockquote>
<p>If we don't guarantee this, then when are those memory blocks still valid? Any container needs to know (and control?) how long its allocated memory will live for. Without that part, I again don't think that the base trait would usable without the augment.</p>
</blockquote>
<p>I'm having trouble figuring out how to best describe the change in the guarantee, so maybe let me come at this backwards</p>



<a name="272321151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321151">(Feb 17 2022 at 20:55)</a>:</h4>
<p>so starting with the usecase I'm imagining we want to enable</p>



<a name="272321186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321186">(Feb 17 2022 at 20:55)</a>:</h4>
<p>and then we can poke holes in why its could become bad</p>



<a name="272321196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321196">(Feb 17 2022 at 20:55)</a>:</h4>
<p>so we have a stack local allocator</p>



<a name="272321203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321203">(Feb 17 2022 at 20:55)</a>:</h4>
<p>this allocator is not <code>'static</code></p>



<a name="272321231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321231">(Feb 17 2022 at 20:56)</a>:</h4>
<p>lets say it was created from a <code>&amp;mut [u8]</code> or something</p>



<a name="272321290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321290">(Feb 17 2022 at 20:56)</a>:</h4>
<p>pointing to some stack array</p>



<a name="272321330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321330">(Feb 17 2022 at 20:56)</a>:</h4>
<p>we want to be able to allocate boxes inside of this allocator and use them for some time, possibly forget them, and then eventually cleanup the backing storage</p>



<a name="272321375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321375">(Feb 17 2022 at 20:57)</a>:</h4>
<p>the one thing we want to disallow is pinning, taking a pointer to the storage, and then forgetting the box</p>



<a name="272321395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321395">(Feb 17 2022 at 20:57)</a>:</h4>
<p>since this stack local allocator does not impl <code>unsafe trait PinAlloc</code></p>



<a name="272321666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321666">(Feb 17 2022 at 20:59)</a>:</h4>
<p>in this case it should be fine to forget a reference to the allocator and then drop the backing storage, even tho some of the memory was leaked and not everything in the backing <code>&amp;mut [u8]</code> was freed before cleaning up, we don't have to abort in this case because we know that nobody would have saved a pointer into any of the forgotten memory because they cannot have pinned that data</p>



<a name="272321856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272321856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272321856">(Feb 17 2022 at 21:00)</a>:</h4>
<p>Right, that makes sense. I'm gonna need a moment to think about that more deeply.</p>



<a name="272322044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272322044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272322044">(Feb 17 2022 at 21:02)</a>:</h4>
<p>sounds good, hopefully poking holes in this will help us figure out what guarantees we need to add to <code>Allocator</code> as part of moving the pin drop safety requirement to a marker trait instead of using <code>'static</code> or ref-counting / aborting. Assuming this is even sound at all to start with</p>



<a name="272322727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272322727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272322727">(Feb 17 2022 at 21:08)</a>:</h4>
<p>Would something like this work?</p>
<blockquote>
<p>Memory blocks returned from an allocator must point to valid memory and retain their validity until the instance and all of its clones are <strong>unreachable</strong></p>
</blockquote>
<p>I'm not sure if we have a formal definition of "unreachable" but that would relax <code>Allocator</code> to say that we can reuse memory from forgotten allocators.</p>



<a name="272325750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272325750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272325750">(Feb 17 2022 at 21:32)</a>:</h4>
<p>I can do the legwork on getting something like this changed if that would help. I imagine we'd close that soundness hole first. Would this be something I can just PR on, or should I go through a more formal channel?</p>



<a name="272331290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272331290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272331290">(Feb 17 2022 at 22:09)</a>:</h4>
<p>it would definitely help! I think a PR is the best starting point. I'm not sure if this should also be going through some different channels, it may be that we want to do some updates to previously approved <code>Allocator</code> RFCs or note somewhere the departures from existing plans so we don't accidentally stabilize these changes as part of a larger stabilization without ppl specifically reviewing these changes. We will almost certainly want to get other members of wg-allocators to sign off on the change but that seems unlikely to be an issue given that it was originally suggested by a member of wg-allocators.</p>



<a name="272362683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272362683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272362683">(Feb 18 2022 at 05:42)</a>:</h4>
<p><span class="user-mention" data-user-id="447178">@David Koloski</span> what I was thinking was to phrase it directly paralleling the Pin guarantee. That is, talking about when <code>drop</code> is called.<br>
(And to be clear: yes, my <code>PinAlloc</code> is just about the pinned-after-forget guarantee.)<br>
Specifically having not looked at the PR yet, I was thinking it'd look like<br>
<code>PinAlloc</code>: memory blocks retain validity until all clones of the allocator are dropped (pin language)<br>
<code>Alloc</code>: memory blocks retain validity while any clone is live (mut ref language)</p>



<a name="272363090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/197181-t-libs/wg-allocators/topic/Is%20custom%20allocators%20the%20right%20abstraction%3F/near/272363090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Koloski <a href="https://zulip-archive.rust-lang.org/stream/197181-t-libs/wg-allocators/topic/Is.20custom.20allocators.20the.20right.20abstraction.3F.html#272363090">(Feb 18 2022 at 05:53)</a>:</h4>
<p>I think that’s about what I got down. I can’t find the mut ref docs you mentioned but I can update the PR with changed language (after I get some sleep)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>