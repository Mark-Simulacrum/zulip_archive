<html>
<head><meta charset="utf-8"><title>#54716 drop order · wg-async-foundations · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/index.html">wg-async-foundations</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html">#54716 drop order</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="160295723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160295723" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160295723">(Mar 08 2019 at 14:50)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> So far I've attempted to change the lowering so that:</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span>: <span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>becomes:</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">__arg0</span>: <span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span>: <span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I did it this way so that I wouldn't need to handle more complex patterns like <code>async fn foo((x, y): (T, T)) {}</code> or even just <code>async fn foo(_: T) {}</code>. I've got that mostly working - I can look at the unpretty'd HIR and see it but I run into failures in <code>rustc/middle/liveness.rs</code> as the <code>Def</code>s associated with the new ids don't quite line up. For example, if I refer to the original name of the binding in the block after my inserted statements, then it has a <code>Def::Upvar</code> rather than <code>Def::Local</code> and <code>__arg0</code> doesn't have <code>Def::Uvpar</code>. </p>
<p>I'm not sure if I'm just unaware of some helper functions that would make this easier or if I'm taking the wrong approach, I've not really looked at the HIR lowering before so it's all new.</p>



<a name="160297470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160297470" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160297470">(Mar 08 2019 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> without looking at the code, I'd guess it's because you changed the parents of those ast nodes without changing how they get seen by the def collector</p>



<a name="160297507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160297507" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160297507">(Mar 08 2019 at 15:13)</a>:</h4>
<p>I'm not aware of any useful helper functions for this desugaring</p>



<a name="160297567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160297567" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160297567">(Mar 08 2019 at 15:14)</a>:</h4>
<p>Stuff like this generally requires some id-related hackery</p>



<a name="160298057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160298057" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160298057">(Mar 08 2019 at 15:20)</a>:</h4>
<p>I see, that's about what I expected.</p>



<a name="160327241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160327241" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160327241">(Mar 08 2019 at 21:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> do you want to post your branch? It seems like you're headed in the right general direction</p>



<a name="160362704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160362704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160362704">(Mar 09 2019 at 11:05)</a>:</h4>
<p>I'll clean it up a bit and then push it to a branch.</p>



<a name="160431780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160431780" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160431780">(Mar 10 2019 at 20:47)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> Apologies for the delay here, I've pushed to <a href="https://github.com/davidtwco/rust/tree/issue-54716" target="_blank" title="https://github.com/davidtwco/rust/tree/issue-54716">this branch</a>.</p>
<p>I ended up realizing that I had to make the <code>rustc_resolve</code> logic and the def collector more aware of the arguments/new statements and that the way I was doing it made that pretty difficult. What I've done instead is introduce a new field to <code>ast::IsAsync</code> and then modify the arguments/block in a few places that it was needed. That got me further into the compiler than where I was before (after a long detour getting the new statements to have ids). It now errors in the MIR gen, but I suspect that is because of failures in type check. I've not had a chance to dig into that though.</p>
<p>I'm not that pleased with the approach it takes. I can't think of a better way, it just feels like the amount of changes it has taken is way more than it should be and there should be somewhere I can make the change to the function's lowering and that would just propagate through the compiler unchanged - I guess that place is probably the parser, but I don't think we'd want that.</p>



<a name="160431848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160431848" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160431848">(Mar 10 2019 at 20:49)</a>:</h4>
<p>I'm happy to rip out all of it and take a completely different approach if what I've got there is in fact not great. I've learned a bunch from breaking the compiler with those changes.</p>



<a name="160432085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160432085" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160432085">(Mar 10 2019 at 20:54)</a>:</h4>
<p>When I originally made this topic I’d only modified the lowering code and was making everything there.</p>



<a name="160467701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160467701" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160467701">(Mar 11 2019 at 10:44)</a>:</h4>
<p>(also, unrelated to this issue, but I'd appreciate being added to the GitHub group for this WG so I can get pings about things)</p>



<a name="160509070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509070" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509070">(Mar 11 2019 at 19:20)</a>:</h4>
<blockquote>
<p>(also, unrelated to this issue, but I'd appreciate being added to the GitHub group for this WG so I can get pings about things)</p>
</blockquote>
<p>done</p>



<a name="160509088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509088" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509088">(Mar 11 2019 at 19:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I agree that some kind of "early change" feels like all that should be needed</p>



<a name="160509105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509105" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509105">(Mar 11 2019 at 19:21)</a>:</h4>
<p>I wonder if there is some way to alter the HIR lowering here</p>



<a name="160509111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509111">(Mar 11 2019 at 19:21)</a>:</h4>
<p>or rather alter the HIR</p>



<a name="160509122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509122" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509122">(Mar 11 2019 at 19:21)</a>:</h4>
<p>let me check out your branch</p>



<a name="160509854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509854" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509854">(Mar 11 2019 at 19:29)</a>:</h4>
<p>Altering the HIR lowering is the first thing I tried, and that's still what I'm doing. I found that I also had to make changes to the def collector, collector (IIRC) and resolve to also get it to work, and that those changes weren't trivial as it was introducing whole new statements (which was affecting what got considered a <code>Def::Upvar(..)</code> for example), so I made the statements and arguments in the parser (storing them in the <code>IsAsync::Async</code> alongside the ids that were there previously) and then used those in the HIR lowering and other places.</p>



<a name="160509908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160509908" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160509908">(Mar 11 2019 at 19:29)</a>:</h4>
<p>Originally it was only the HIR lowering that I was modifying.</p>



<a name="160510310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160510310" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160510310">(Mar 11 2019 at 19:33)</a>:</h4>
<p>I see</p>



<a name="160570149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160570149" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160570149">(Mar 12 2019 at 13:36)</a>:</h4>
<p>I think I've got this working.</p>



<a name="160570182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160570182" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160570182">(Mar 12 2019 at 13:37)</a>:</h4>
<p>Right now the drop order is reversed but they're being dropped at the right time.</p>



<a name="160575998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160575998" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160575998">(Mar 12 2019 at 14:42)</a>:</h4>
<p>So, the drops are now happening at the right time - that is, when polled, not when created - but the actual order isn't the same. It works for simple cases but when I throw a <code>_</code> binding into the mix it doesn't work. You can see <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=1e6ba06ecb3b1f57be1c3613cbabc4c3" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=1e6ba06ecb3b1f57be1c3613cbabc4c3">an example here</a>.</p>



<a name="160576938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160576938" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160576938">(Mar 12 2019 at 14:53)</a>:</h4>
<p>The actual result for the test I have <a href="https://gist.github.com/davidtwco/1e9c7a56630ab616029916188f564ae6#gistcomment-2860122" target="_blank" title="https://gist.github.com/davidtwco/1e9c7a56630ab616029916188f564ae6#gistcomment-2860122">is here</a> (GitHub is being funny and sometimes that returns a 404, it does exist). You can see the drops now happen after the function call but not in the same order as a regular function.</p>



<a name="160586197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160586197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160586197">(Mar 12 2019 at 16:38)</a>:</h4>
<p>Submitted <a href="https://github.com/rust-lang/rust/issues/59135" target="_blank" title="https://github.com/rust-lang/rust/issues/59135">#59135</a>.</p>



<a name="160792119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160792119" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160792119">(Mar 14 2019 at 15:34)</a>:</h4>
<p><strong>Summary</strong> (<a href="https://github.com/rust-lang/rust/issues/59135" target="_blank" title="https://github.com/rust-lang/rust/issues/59135">#59135</a>)<br>
Since I've written a bunch above, here's a short summary of the current state of this:</p>
<p>In an attempt to fix the drop order of <code>async fn</code> when there are unused arguments, I'm attempting to introduce replace the function arguments and introduce bindings that move the arguments into the inner closure, while preserving the patterns. For example:</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span>: <span class="o">&lt;</span><span class="k">type</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="c1">// &lt;-- dropped as you &quot;exit&quot; the fn</span>

<span class="c1">// ...becomes...</span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">__arg0</span>: <span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="c1">// &lt;-- dropped as you &quot;exit&quot; the async block</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>This was working (except for some extra diagnostic output on one test, see the first bullet point below), but after a rebase it regressed and I've been unable to fix it. There are currently three issues with the PR:</p>
<ul>
<li>Currently <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/async-fn-multiple-lifetimes.rs" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/async-fn-multiple-lifetimes.rs">this test</a> (<a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/async-fn-multiple-lifetimes.stderr" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/async-fn-multiple-lifetimes.stderr">expected stderr</a>) is the only one that is still failing (at least, before I rebased and introduced the type inference error below). I've managed to fix a handful of the issues that the test originally had, but I'm left with <a href="https://gist.github.com/davidtwco/02f0fa124e193a12d6ff21f6b0d4e61e" target="_blank" title="https://gist.github.com/davidtwco/02f0fa124e193a12d6ff21f6b0d4e61e">this stderr diff</a>. I am unsure if this is correct and expected.</li>
<li>There's also a pre-existing issue that meant I couldn't exactly match the drop-order of the equivalent <code>fn</code>. I mention that at the end of the PR description.</li>
<li>When running the test, I get this error below. I've dug around for days and not really come up with much. This worked before the rebase, but might also be related to a recent change that removed the <code>&lt;ty&gt;</code> from <code>let &lt;pat&gt;: &lt;ty&gt; = __arg0;</code> because that broke when <code>&lt;ty&gt;</code> was <code>impl Trait</code>:</li>
</ul>
<div class="codehilite"><pre><span></span>error[E0282]: type annotations needed
  --&gt; ./src/test/run-pass/issue-54716.rs:36:14
   |
36 | async fn foo(x: D, _y: D) {
   | ^ cannot infer type
</pre></div>


<p>In brief, the change modifies the <code>ast::IsAsync::Async</code> variant to introduce a <code>Vec&lt;AsyncArgument&gt;</code> containing a ident (<code>__arg0</code>), a statement (<code>let &lt;pat&gt; = __arg0;</code>) and a argument (<code>__arg0: &lt;ty&gt;</code>) for each of the original arguments of the function. There are corresponding changes to the visitors so that these get given ids. There are also a few other smaller changes that let me keep track of whether an argument/statement was introduced by the <code>async fn</code> lowering or not - this can help with diagnostics as in one of the commits. </p>
<p>This is then used in the HIR lowering to, well, lower to the HIR - replacing the arguments of the function with our generated arguments above, and prepending the statements to the body of the function before it is lowered into the generator. But it is also used in the def collector and in name resolution as those need to work out what should be <code>Def::Upvar(..)</code> and other things like that. I decided to modify the AST to keep the arg and stmt so I didn't need to repeat creating them all of those places. </p>
<p>Originally I tried modifying only the HIR and keeping only ids in the AST (as was contained in <code>IsAsync</code> previously), but I was struggling to get this to work - I think it would be a preferable solution (I want to limit the amount of  AST changes), but getting the name resolution and def collection to work, given just the ids, was challenging - I found just adding the new statements before they would normally do their thing was much more straightforward.</p>



<a name="160792164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160792164" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160792164">(Mar 14 2019 at 15:34)</a>:</h4>
<p>I've deleted the messages before my summary as they're just confused ramblings of someone too deep into the type checker to make any sense.</p>



<a name="160803867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160803867" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160803867">(Mar 14 2019 at 17:39)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span>  Does your changes assume that you will always have <code>async fn foo($pat: type) { ... }</code>? What if you only had <code>async fn foo($pat)</code> e.g. <code>async fn foo([x: u8, y])</code> ?</p>



<a name="160803879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160803879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160803879">(Mar 14 2019 at 17:39)</a>:</h4>
<p>could you work with the latter?</p>



<a name="160803991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160803991" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160803991">(Mar 14 2019 at 17:40)</a>:</h4>
<p>I'm not sure about <code>async fn foo($pat)</code>.</p>



<a name="160804053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804053" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804053">(Mar 14 2019 at 17:41)</a>:</h4>
<p>I'll check when I'm next looking at this.</p>



<a name="160804373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804373" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804373">(Mar 14 2019 at 17:45)</a>:</h4>
<p>At the moment, I don't think it would work without the type being specified. But <code>async fn</code> is only available on the 2018 edition and anonymous parameters in trait methods aren't allowed 2018 as far as I know - so I don't think it could come up. There could be a case I'm not thinking of though.</p>



<a name="160804378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804378" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804378">(Mar 14 2019 at 17:45)</a>:</h4>
<p>IOW, I think you would need to infer the type of the pattern on the HIR given only the pattern and the type variables of the function (but also e.g. <code>async fn foo([x: impl Debug, y])</code>) and then lower to <code>_arg0: $inferred_type</code></p>



<a name="160804463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804463" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804463">(Mar 14 2019 at 17:46)</a>:</h4>
<blockquote>
<p>IOW, I think you would need to infer the type of the pattern on the HIR given only the pattern and the type variables of the function (but also e.g. <code>async fn foo([x: impl Debug, y])</code>) and then lower to <code>_arg0: $inferred_type</code></p>
</blockquote>
<p>I don't quite understand what you mean.</p>



<a name="160804466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804466" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804466">(Mar 14 2019 at 17:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> It's not an issue of anonymous parameters, those were of form <code>fn foo($type)</code> not <code>fn foo($pat)</code> -- it's an issue of future language design</p>



<a name="160804514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804514" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804514">(Mar 14 2019 at 17:47)</a>:</h4>
<p>I don't think there's anything in this change that would rule that out, but it wouldn't work with my implementation as it is currently, I think.</p>



<a name="160804556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804556">(Mar 14 2019 at 17:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span>  sure; I'm only asking to be sure that it is not ruled out and that the impl can be changed to handle it</p>



<a name="160804995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/160804995" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#160804995">(Mar 14 2019 at 17:52)</a>:</h4>
<blockquote>
<p>I don't quite understand what you mean.</p>
</blockquote>
<p>Consider e.g. <code>async fn foo&lt;T&gt;((x: u8, Wrapping(y: T), z: impl Debug)) { ... }</code> -- you'd need to infer that the first argument is of type <code>(u8, Wrapping&lt;T&gt;, InferredDebugType)</code> such that you could then have:</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">__arg0</span>: <span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">Wrapping</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">InferredDebugType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">x</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">Wrapping</span><span class="p">(</span><span class="n">y</span>: <span class="nc">T</span><span class="p">),</span><span class="w"> </span><span class="n">z</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Debug</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="161162698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161162698" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161162698">(Mar 19 2019 at 15:53)</a>:</h4>
<p>I think there would be many hurdles to getting that to work -- it feels like we have to rethink the HIR lowering around this point in any case. i.e., <span class="user-mention" data-user-id="116107">@davidtwco</span>'s existing PR is kind of stretching the current code to its limits in some sense.</p>



<a name="161162788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161162788" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161162788">(Mar 19 2019 at 15:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> sure; It's something I'd like to see supported eventually tho <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="161162942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161162942" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161162942">(Mar 19 2019 at 15:56)</a>:</h4>
<p>I’m still looking for some feedback on the PR and with the issue that currently plagues it.</p>



<a name="161163057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161163057" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161163057">(Mar 19 2019 at 15:58)</a>:</h4>
<p>Yeah, I was just skimming it.</p>



<a name="161163075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161163075" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161163075">(Mar 19 2019 at 15:58)</a>:</h4>
<p>I started with the tests, I'll take a look at the details</p>



<a name="161163675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161163675" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161163675">(Mar 19 2019 at 16:04)</a>:</h4>
<p>I originally had the test make a direct comparison with the equivalent non-<code>async fn</code> which surfaced that the order wouldn’t be the same.</p>



<a name="161168300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168300" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168300">(Mar 19 2019 at 16:54)</a>:</h4>
<blockquote>
<p>I originally had the test make a direct comparison with the equivalent non-<code>async fn</code> which surfaced that the order wouldn’t be the same.</p>
</blockquote>
<p>wait, <span class="user-mention" data-user-id="116107">@davidtwco</span>, say more?</p>



<a name="161168314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168314" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168314">(Mar 19 2019 at 16:54)</a>:</h4>
<p>maybe I missed something</p>



<a name="161168318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168318" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168318">(Mar 19 2019 at 16:54)</a>:</h4>
<p>where does the order differ?</p>



<a name="161168616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168616" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168616">(Mar 19 2019 at 16:57)</a>:</h4>
<p>This <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=be39af1a58e5d430be1eb3c722cb1ec3" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=be39af1a58e5d430be1eb3c722cb1ec3">playground link</a> illustrates what I noticed.</p>



<a name="161168620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168620">(Mar 19 2019 at 16:57)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="161168788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168788" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168788">(Mar 19 2019 at 16:59)</a>:</h4>
<p>The PR still <del>fixes</del> fixed the fact that the parameters got dropped before polling, but the order wasn't what I expected.</p>



<a name="161168952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161168952" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161168952">(Mar 19 2019 at 17:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> hmm that's...quite interesting</p>



<a name="161169037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/161169037" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#161169037">(Mar 19 2019 at 17:01)</a>:</h4>
<p>I figured it was out-of-scope for this PR, and that just getting the drops to happen when polling was enough.</p>



<a name="162942769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162942769" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162942769">(Apr 09 2019 at 19:32)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> I've re-opened the PR as <a href="https://github.com/rust-lang/rust/issues/59823" target="_blank" title="https://github.com/rust-lang/rust/issues/59823">#59823</a>.</p>



<a name="162942778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162942778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162942778">(Apr 09 2019 at 19:32)</a>:</h4>
<p>(apparently you can't re-open PRs that you force-push too)</p>



<a name="162942822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162942822" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162942822">(Apr 09 2019 at 19:33)</a>:</h4>
<p>There was a single outstanding comment from <span class="user-mention" data-user-id="116009">@nikomatsakis</span> on the previous version regarding naming in the test.</p>



<a name="162991728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162991728" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162991728">(Apr 10 2019 at 10:26)</a>:</h4>
<p>so, if I understand correctly, you are interested in the cause of the difference between <code>complex</code> and <code>complex2</code> ?</p>



<a name="162991748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162991748" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162991748">(Apr 10 2019 at 10:27)</a>:</h4>
<p>keep in mind that you never actually <em>run</em> the body of the closure that is capturing <code>__arg0</code>,<code>__arg1</code>, and <code>_arg2</code> in <code>complex2</code></p>



<a name="162991806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162991806" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162991806">(Apr 10 2019 at 10:28)</a>:</h4>
<p>so the destructuring that occurs within its body is irrelevant. all that <em>is</em> relevant is that it captures all three arguments</p>



<a name="162991950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162991950" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162991950">(Apr 10 2019 at 10:30)</a>:</h4>
<p>and then it subsequently drops them, when the closure is dropped, in reverse order: <code>__arg2</code> ("_y"), <code>__arg1</code> (which drops its components in-order, due to <a href="https://github.com/rust-lang/rust/issues/16493" target="_blank" title="https://github.com/rust-lang/rust/issues/16493">#16493</a>), and <code>__arg0</code> ("x")</p>



<a name="162992028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162992028" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162992028">(Apr 10 2019 at 10:31)</a>:</h4>
<p>In short, the reason you see a difference between <code>complex</code> and <code>complex2</code> is due to the combination of <a href="https://github.com/rust-lang/rust/issues/16493" target="_blank" title="https://github.com/rust-lang/rust/issues/16493">#16493</a> (see also <a href="https://github.com/rust-lang/rust/issues/16661" target="_blank" title="https://github.com/rust-lang/rust/issues/16661">#16661</a>) and the fact that <code>complex</code> is destructuring its second argument into <code>(a, _, _c)</code>.</p>



<a name="162992164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162992164" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162992164">(Apr 10 2019 at 10:33)</a>:</h4>
<p>The output for <code>complex</code> itself does remain interesting, in that we are trying to drop the arguments in reverse declaration order</p>



<a name="162992223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162992223" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162992223">(Apr 10 2019 at 10:34)</a>:</h4>
<p>but we have this weird scenario where, because we have <strong>partially</strong> destructured the second argument, we end up having that middle "_" component left over</p>



<a name="162992250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162992250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162992250">(Apr 10 2019 at 10:35)</a>:</h4>
<p>And thus you can observe where the whole (unnamed) second argument is being dropped, compared to the bindings it has been destructured into (<code>_c</code> and <code>a</code>).</p>



<a name="162992337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162992337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162992337">(Apr 10 2019 at 10:36)</a>:</h4>
<p>I freely admit that if you had shown me this code ahead of time and warned me about the interactions here, I still would not have been able to predict the order we would get. I would like to believe I might have said "it will be either [_y, _c, a, _, x] or it will be [_y, _, _c, a, x], but I do not know which one it will be."</p>



<a name="162994374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162994374" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162994374">(Apr 10 2019 at 11:11)</a>:</h4>
<p>(Hmm and I do now note that RFC 1857 explicitly says it does not attempt to specify drop order for closure captures)</p>



<a name="162996808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162996808" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162996808">(Apr 10 2019 at 11:51)</a>:</h4>
<p>The playground link with the <code>complex</code> example is just something I stumbled upon dealing with the actual issue. It just shows that after this PR, the order for an <code>async fn</code> won't match the order for an <code>fn</code>, though (with this PR) now all parameters will be dropped when polled and not before.</p>



<a name="162996923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162996923" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162996923">(Apr 10 2019 at 11:52)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/63075213fa727fc639fd3b7303f1bc2821151bf5/src/test/run-pass/issue-54716.rs" target="_blank" title="https://github.com/rust-lang/rust/blob/63075213fa727fc639fd3b7303f1bc2821151bf5/src/test/run-pass/issue-54716.rs">This test</a> is the behaviour the PR changes.</p>



<a name="162996973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162996973" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162996973">(Apr 10 2019 at 11:53)</a>:</h4>
<p>Previously, on a line like this (line 107)...</p>
<div class="codehilite"><pre><span></span>assert_eq!(*af.borrow(), &amp;[Function, Val(&quot;_y&quot;), Val(&quot;x&quot;)]);
</pre></div>


<p>...the order that the function would return would be <code>&amp;[Val("_y"), Function, Val("x")];</code>.</p>



<a name="162997224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162997224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162997224">(Apr 10 2019 at 11:54)</a>:</h4>
<p>This PR ensures that all the drops happen after the <code>Function</code> in the output of that test. Not that the order they are in after that <code>Function</code> will be the same as the equivalent <code>fn</code> (which is what the playground showed w/ the desugaring taking place manually).</p>



<a name="162997266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/162997266" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#162997266">(Apr 10 2019 at 11:55)</a>:</h4>
<p>Currently the PR fails the test due to a type inference error, but I had that working before when I desugared to <code>let &lt;pat&gt;: &lt;ty&gt; = __arg0;</code> but if <code>&lt;ty&gt;</code> was <code>impl Trait</code> then that didn't work, so I had to omit the <code>&lt;ty&gt;</code>, leading to the type inference error I've been unsuccessful in resolving.</p>



<a name="163003324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163003324" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163003324">(Apr 10 2019 at 13:20)</a>:</h4>
<blockquote>
<p>The playground link with the <code>complex</code> example is just something I stumbled upon dealing with the actual issue. It just shows that after this PR, the order for an <code>async fn</code> won't match the order for an <code>fn</code>, though (with this PR) now all parameters will be dropped when polled and not before.</p>
</blockquote>
<p>I suppose the question is then, is there a way to further revise the desugaring so that the order for an <code>async fn</code> <em>will</em> match <code>fn</code>, even in the complex case?</p>



<a name="163003363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163003363" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163003363">(Apr 10 2019 at 13:21)</a>:</h4>
<p>hmm. let me think.</p>



<a name="163003597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163003597" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163003597">(Apr 10 2019 at 13:24)</a>:</h4>
<p>There actually is another wrinkle here</p>



<a name="163003631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163003631" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163003631">(Apr 10 2019 at 13:24)</a>:</h4>
<p>I don't know about generators in particular, but for closures, RFC 1857 explicitly said that drop-order of captured variables remained unspecified</p>



<a name="163003806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163003806" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163003806">(Apr 10 2019 at 13:26)</a>:</h4>
<p>of course we control the compiler etc, so we can ensure whatever order we need to support continues to work.</p>



<a name="163004173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163004173" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163004173">(Apr 10 2019 at 13:30)</a>:</h4>
<p>I will say this: I am starting to wonder, based on the broader discussion overall, if there might be value in a <em>lint</em> that detects functions that have any (sub)patterns in their parameters of the form: <code>_</code> or <code>ref x</code> where the type of the non-moved thing has drop glue.</p>



<a name="163004196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163004196" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163004196">(Apr 10 2019 at 13:30)</a>:</h4>
<p>and just says: "this is a weird thing to do! It may not behave in the manner you expect!"</p>



<a name="163004412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163004412" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163004412">(Apr 10 2019 at 13:33)</a>:</h4>
<p>if we had such a warning lint in place, I'd probably have fewer objections to proposals such as <a href="https://github.com/rust-lang/rust/issues/54716#issuecomment-480068731" target="_blank" title="https://github.com/rust-lang/rust/issues/54716#issuecomment-480068731">dropping unused params early</a></p>



<a name="163005387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163005387" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163005387">(Apr 10 2019 at 13:43)</a>:</h4>
<blockquote>
<p>I suppose the question is then, is there a way to further revise the desugaring so that the order for an <code>async fn</code> <em>will</em> match <code>fn</code>, even in the complex case?</p>
</blockquote>
<p>I was happy to leave this for a follow-up once I got the <code>async fn</code> lowering to capture all the arguments. All that is blocking that is the type inference error that the PR runs into.</p>



<a name="163005813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163005813" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163005813">(Apr 10 2019 at 13:49)</a>:</h4>
<p>That's entirely sensible.</p>



<a name="163005843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163005843" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163005843">(Apr 10 2019 at 13:49)</a>:</h4>
<p>(The follow-up also might not even be feasible anyway, so I definitely wouldn't want to block this PR based on it.)</p>



<a name="163020494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163020494" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163020494">(Apr 10 2019 at 16:29)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I'm not sure if you saw, but <span class="user-mention" data-user-id="116009">@nikomatsakis</span> was suggesting previously that we could feature-gate unused arguments to <code>async fn</code></p>



<a name="163020510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163020510" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163020510">(Apr 10 2019 at 16:30)</a>:</h4>
<p>A warning/lint is an interesting alternative</p>



<a name="163020577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163020577" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163020577">(Apr 10 2019 at 16:30)</a>:</h4>
<p>that I think would go some ways towards avoiding the "not ready yet" perception</p>



<a name="163020681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163020681" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163020681">(Apr 10 2019 at 16:31)</a>:</h4>
<p>something like e.g. "warning: drop order of unused arguments to <code>async fn</code> is unstable. consider removing unused argument or explicitly <code>drop</code>ping it"</p>



<a name="163026700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163026700" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163026700">(Apr 10 2019 at 17:38)</a>:</h4>
<p>I'm a big fan of <span class="user-mention" data-user-id="116009">@nikomatsakis</span>'s suggestion to feature gate here</p>



<a name="163026792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163026792" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163026792">(Apr 10 2019 at 17:39)</a>:</h4>
<p>I do like taking a more empiricist approach to this</p>



<a name="163029421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163029421" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163029421">(Apr 10 2019 at 18:05)</a>:</h4>
<p>I hadn’t seen the feature gate suggestion. Any of these options sound better than trying to rush to a decision here, IMO</p>



<a name="163038643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163038643" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163038643">(Apr 10 2019 at 19:43)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> how do you feel about warn vs. error?</p>



<a name="163038731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163038731" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163038731">(Apr 10 2019 at 19:44)</a>:</h4>
<p>I think I'd prefer a warning in an effort to make <code>unimplemented!()</code> easier on folks and make the experience feel less "unfinished" by avoiding the suggestion of feature gates</p>



<a name="163041366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163041366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163041366">(Apr 10 2019 at 20:14)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> hmm; I think as long as we decide amongst ourselves that the drop order is not stable then that's fine by me</p>



<a name="163041375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163041375" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163041375">(Apr 10 2019 at 20:14)</a>:</h4>
<p>but we need to have that agreement <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="163046277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163046277" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163046277">(Apr 10 2019 at 21:10)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> sounds good-- want to raise the option on the github issue?</p>



<a name="163046303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163046303" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163046303">(Apr 10 2019 at 21:11)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> Since it was your idea, can you do it? :P</p>



<a name="163047029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163047029" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163047029">(Apr 10 2019 at 21:19)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> lol sure</p>



<a name="163230060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163230060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163230060">(Apr 12 2019 at 21:53)</a>:</h4>
<p>Spent a little bit of time looking into this type inference failure again today. I think my previous ideas about it were wrong and I was digging in the wrong place. I'm still not too sure what the issue <em>is</em> though. I've got <a href="https://gist.github.com/davidtwco/93718aa7149b452692e5b181db9b1ff7" target="_blank" title="https://gist.github.com/davidtwco/93718aa7149b452692e5b181db9b1ff7">this log output</a> from the <code>rustc::traits</code> module (which I'm not too familiar with), I think line 102 is where it starts trying to evaluate a predicate that it can't. But, I don't think that's related to the <code>let &lt;pat&gt; = __arg0;</code> statement that we insert which is what I thought was the problem before.</p>



<a name="163660110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660110" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660110">(Apr 18 2019 at 15:07)</a>:</h4>
<p>/me starts tearing hair out</p>



<a name="163660135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660135" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660135">(Apr 18 2019 at 15:07)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> do you like... want to elaborate? :P</p>



<a name="163660187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660187" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660187">(Apr 18 2019 at 15:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I think <code>async fn</code> desugaring to <code>-&gt; impl Future { async { ... } }</code> <em>may</em> have been a mistake</p>



<a name="163660255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660255" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660255">(Apr 18 2019 at 15:09)</a>:</h4>
<p>doesn't an <code>async</code> closure have the same issue as an <code>async fn</code>?</p>



<a name="163660263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660263" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660263">(Apr 18 2019 at 15:09)</a>:</h4>
<p>wrt arguments?</p>



<a name="163660286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660286" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660286">(Apr 18 2019 at 15:09)</a>:</h4>
<blockquote>
<p>doesn't an <code>async</code> closure have the same issue as an <code>async fn</code>?</p>
</blockquote>
<p>I'm not sure, I haven't tried.</p>



<a name="163660296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660296" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660296">(Apr 18 2019 at 15:09)</a>:</h4>
<p>so then I would just state-machine-transform the body of the function</p>



<a name="163660359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660359" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660359">(Apr 18 2019 at 15:10)</a>:</h4>
<p>the problem is we need the function (or closure?) to return the generator wrapper</p>



<a name="163660589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660589" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660589">(Apr 18 2019 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="116107">@davidtwco</span> I think the easiest hack in the meanwhile is to just <em>know</em> that a function was an <code>async fn</code>, and so a direct generator children of it should capture its MIR arguments</p>



<a name="163660655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660655" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660655">(Apr 18 2019 at 15:13)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span>  maybe easier, but it also feels like a deeper hack since it is closer to MIR ("the kernel")</p>



<a name="163660657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660657" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660657">(Apr 18 2019 at 15:13)</a>:</h4>
<blockquote>
<p>so a direct generator children of it</p>
</blockquote>
<p>I don't think I understand what you mean by this.</p>



<a name="163660721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660721" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660721">(Apr 18 2019 at 15:14)</a>:</h4>
<p>a generator that is a direct child</p>



<a name="163660728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660728" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660728">(Apr 18 2019 at 15:14)</a>:</h4>
<p>Change how the closure capturing for generators work if the generator was from the lowering of an async function?</p>



<a name="163660748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660748" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660748">(Apr 18 2019 at 15:14)</a>:</h4>
<p>basically, yes</p>



<a name="163660762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660762" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660762">(Apr 18 2019 at 15:14)</a>:</h4>
<p>Alright, thanks.</p>



<a name="163660784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660784">(Apr 18 2019 at 15:14)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> in the long term, I agree</p>



<a name="163660863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660863" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660863">(Apr 18 2019 at 15:15)</a>:</h4>
<p>right</p>



<a name="163660877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660877" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660877">(Apr 18 2019 at 15:15)</a>:</h4>
<p>I think the type inference issue that the current approach takes is resolvable though, it was working before. I'm just not that familiar with the type inference in the compiler.</p>



<a name="163660890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660890" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660890">(Apr 18 2019 at 15:16)</a>:</h4>
<p>I'm a bit torn tbh, on one hand desugaring is good</p>



<a name="163660944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163660944" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163660944">(Apr 18 2019 at 15:16)</a>:</h4>
<p>on the other hand, it's hard to make everything work</p>



<a name="163661026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661026">(Apr 18 2019 at 15:17)</a>:</h4>
<p>inconsistency between def parenting in AST vs HIR bothers me to no end</p>



<a name="163661054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661054">(Apr 18 2019 at 15:17)</a>:</h4>
<p>wait, locals don't have <code>DefId</code>s anymore,  do they?</p>



<a name="163661068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661068" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661068">(Apr 18 2019 at 15:17)</a>:</h4>
<p>so what's actually hard about moving the patterns to the closure?</p>



<a name="163661139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661139" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661139">(Apr 18 2019 at 15:18)</a>:</h4>
<p>and we can add an expression type to HIR to refer to arguments directly :P</p>



<a name="163661191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661191">(Apr 18 2019 at 15:18)</a>:</h4>
<p><span aria-label="pick" class="emoji emoji-26cf" role="img" title="pick">:pick:</span> <span aria-label="pick" class="emoji emoji-26cf" role="img" title="pick">:pick:</span> <span aria-label="pick" class="emoji emoji-26cf" role="img" title="pick">:pick:</span></p>



<a name="163661193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661193">(Apr 18 2019 at 15:18)</a>:</h4>
<p>It was complex because I couldn't just change the lowering, I also had to make some changes to name resolution so that things correctly got marked as <code>Def::Upvar(..)</code> - it was easiest to do that by just modifying the AST that we gave to lowering and name resolution with the replaced arguments and new statements. That and after I got it working, I started running into this type inference problem.</p>



<a name="163661221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661221" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661221">(Apr 18 2019 at 15:19)</a>:</h4>
<p>oh heh, I see</p>



<a name="163661232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661232" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661232">(Apr 18 2019 at 15:19)</a>:</h4>
<p>I also don't have a great deal of experience with making these sorts of changes to the compiler, so there may be something I'm missing.</p>



<a name="163661253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661253" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661253">(Apr 18 2019 at 15:19)</a>:</h4>
<p>upvars are indeed problematic, but you should be able to change the resolution <em>after</em> <code>rustc_resolve</code> ran</p>



<a name="163661351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661351" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661351">(Apr 18 2019 at 15:20)</a>:</h4>
<p>like, you can just create HIR that pretends it resolved to <code>Def::Upvar</code>. and modify the "freevars" map</p>



<a name="163661378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661378" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661378">(Apr 18 2019 at 15:20)</a>:</h4>
<p>(frankly, we should just compute "freevars" aka "upvars" from a HIR pass, and be done with it)</p>



<a name="163661412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661412" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661412">(Apr 18 2019 at 15:21)</a>:</h4>
<p>I don't know how I spent most of today messing around with <code>Static(Mutability)</code> -&gt; <code>Static</code> + <code>StaticMut</code> when I could've done the "resolution" thing that makes reasoning about all of this better</p>



<a name="163661570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661570" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661570">(Apr 18 2019 at 15:23)</a>:</h4>
<blockquote>
<p>upvars are indeed problematic, but you should be able to change the resolution <em>after</em> <code>rustc_resolve</code> ran</p>
</blockquote>
<p>I tried that at first, but I thought I'd need to have walked forward and updated the <code>Def</code> of anywhere that used a given variable so that it pointed to the local that I insert rather than the upvar.</p>



<a name="163661630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661630" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661630">(Apr 18 2019 at 15:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> oh, I see, I was confused at first, heh</p>



<a name="163661641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661641" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661641">(Apr 18 2019 at 15:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> okay we need to fix upvars</p>



<a name="163661685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661685" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661685">(Apr 18 2019 at 15:24)</a>:</h4>
<p>give me... a few weeks :P</p>



<a name="163661724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661724" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661724">(Apr 18 2019 at 15:24)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> okay we need to fix upvars</p>
</blockquote>
<p>I'm more than happy to help and sink some time into this, I'd just need some pointers.</p>



<a name="163661730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661730" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661730">(Apr 18 2019 at 15:24)</a>:</h4>
<p>we can make it so <code>rustc_resolve</code> just doesn't compute this anymore, and anything looking at a mention of a local needs to figure out whether it's an upvar or not</p>



<a name="163661762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661762" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661762">(Apr 18 2019 at 15:25)</a>:</h4>
<p>well, give me a few hours to do the thing I wanted to do today :P</p>



<a name="163661778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661778">(Apr 18 2019 at 15:25)</a>:</h4>
<blockquote>
<p>well, give me a few hours to do the thing I wanted to do today :P</p>
</blockquote>
<p>Sure thing, thanks.</p>



<a name="163661791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661791" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661791">(Apr 18 2019 at 15:25)</a>:</h4>
<p>then we can start thinking about simplifying name resolution results and tracking upvars post-HIR-lowering</p>



<a name="163661799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661799" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661799">(Apr 18 2019 at 15:25)</a>:</h4>
<p>I guess we can compute them <em>during</em> HIR lowering, actually</p>



<a name="163661877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163661877" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163661877">(Apr 18 2019 at 15:26)</a>:</h4>
<p>which would avoid us having to change every single place <code>Def::Upvar</code> is handled today</p>



<a name="163724738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163724738" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163724738">(Apr 19 2019 at 09:39)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> so the refactor I was doing yesterday was <a href="https://github.com/rust-lang/rust/issues/60110" target="_blank" title="https://github.com/rust-lang/rust/issues/60110">#60110</a>, now let's get to the <em>actual</em> one I wanted :P</p>



<a name="163725194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163725194" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163725194">(Apr 19 2019 at 09:50)</a>:</h4>
<p>Awesome.</p>



<a name="163725282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163725282" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163725282">(Apr 19 2019 at 09:53)</a>:</h4>
<p>What do you have in mind?</p>



<a name="163728047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163728047" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163728047">(Apr 19 2019 at 10:57)</a>:</h4>
<p>actually, I don't even need to do it this way, heh</p>



<a name="163827478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163827478" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163827478">(Apr 21 2019 at 01:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="127859">@Taylor Cramer</span> Fixed all the failures I was having with this PR, <a href="https://github.com/rust-lang/rust/issues/59823" target="_blank" title="https://github.com/rust-lang/rust/issues/59823">#59823</a>, should be good to review (assuming Travis agrees, I'll find out in the morning).</p>



<a name="163843818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163843818" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163843818">(Apr 21 2019 at 09:26)</a>:</h4>
<p>Turns out Travis didn't agree, but it was only a mir-opt test, so should be fixed now.</p>



<a name="163926746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163926746" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163926746">(Apr 22 2019 at 18:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> nice! Did you keep the overall desugaring approach, or try something different</p>



<a name="163927864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/163927864" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#163927864">(Apr 22 2019 at 18:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> it’s the same as before, I just fixed a stupid mistake I had made.</p>



<a name="164058549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164058549" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164058549">(Apr 24 2019 at 06:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="127859">@Taylor Cramer</span> with the PR for this having landed, do you think it’s worth trying to address that the drop order doesn’t match the equivalent <code>fn</code> exactly?</p>



<a name="164058563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164058563" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164058563">(Apr 24 2019 at 06:53)</a>:</h4>
<p>what's the diff?</p>



<a name="164062104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164062104" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164062104">(Apr 24 2019 at 08:08)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=bd42db518b05e7bbe797d503011acde5" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=bd42db518b05e7bbe797d503011acde5">playground</a></p>



<a name="164062183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164062183" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164062183">(Apr 24 2019 at 08:10)</a>:</h4>
<p>We fixed the "might drop before polling" issue, but it isn't exactly the same as the equivalent fn.</p>



<a name="164062223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164062223" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164062223">(Apr 24 2019 at 08:11)</a>:</h4>
<p>It's a result of desugaring into a closure body, the same <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=be39af1a58e5d430be1eb3c722cb1ec3" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=be39af1a58e5d430be1eb3c722cb1ec3">is visible when <code>fn</code> is compared with closures</a>, it just doesn't look as odd because more is different than just adding <code>async</code>.</p>



<a name="164062929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164062929" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164062929">(Apr 24 2019 at 08:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> so <code>_</code> is dropped after <code>x</code> for the <code>async</code> version in <code>bar</code> but the sync one is the reverse?</p>



<a name="164063053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164063053" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164063053">(Apr 24 2019 at 08:29)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> your second link seems to point to the wrong place</p>



<a name="164063054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164063054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164063054">(Apr 24 2019 at 08:29)</a>:</h4>
<p>Pretty much, I think it's a bit stranger with the last example:</p>
<div class="codehilite"><pre><span></span>async: `[Function, Val(&quot;_y&quot;), Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;x&quot;), Val(&quot;_&quot;), Val(&quot;_&quot;)]`
 sync: `[Function, Val(&quot;_y&quot;), Val(&quot;_&quot;), Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;_&quot;), Val(&quot;x&quot;)]`&#39;
</pre></div>


<p>I think it's only underscore bindings that differ.</p>



<a name="164063125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164063125" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164063125">(Apr 24 2019 at 08:30)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> your second link seems to point to the wrong place</p>
</blockquote>
<p>Fixed, thanks.</p>



<a name="164063438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164063438" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164063438">(Apr 24 2019 at 08:36)</a>:</h4>
<p>Thanks; neat explanations.</p>
<p>I do think this should be fixed (or otherwise feature gated);<br>
Seems like a half-measure otherwise and <code>_</code> seem just as likely as <code>_x</code></p>



<a name="164063464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164063464" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164063464">(Apr 24 2019 at 08:37)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span> who iirc thought <code>async { .. }</code> might not have been so good after all?</p>



<a name="164083150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164083150" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164083150">(Apr 24 2019 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> I think he was coming around to the idea that desugaring was having some complex impacts</p>



<a name="164083261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164083261" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164083261">(Apr 24 2019 at 14:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> yeah, we should make a new issue to discuss the remaining diff</p>



<a name="164084233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164084233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164084233">(Apr 24 2019 at 14:17)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> <a href="https://github.com/rust-lang/rust/issues/60236" target="_blank" title="https://github.com/rust-lang/rust/issues/60236">#60236</a></p>



<a name="164084288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164084288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164084288">(Apr 24 2019 at 14:18)</a>:</h4>
<p>I wasn't sure whether that would be considered blocking or deferred.</p>



<a name="164084337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164084337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164084337">(Apr 24 2019 at 14:18)</a>:</h4>
<p>I'm not sure either</p>



<a name="164084366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164084366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164084366">(Apr 24 2019 at 14:19)</a>:</h4>
<p>Seems worth discussing on-thread</p>



<a name="164084895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164084895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Lawrence <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164084895">(Apr 24 2019 at 14:25)</a>:</h4>
<p>Very new here - but just out of interest, what is the PR that introduced the drop order issue? Just want to read on it</p>



<a name="164085162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164085162" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164085162">(Apr 24 2019 at 14:28)</a>:</h4>
<p>Well, the drop order issue was a result of the way that <code>async fn</code> was desugared, not any particular PR (I guess outside of the implementation of <code>async fn</code> originally). <a href="https://github.com/rust-lang/rust/issues/54716" target="_blank" title="https://github.com/rust-lang/rust/issues/54716">#54716</a> is the original issue that reported the problem, <a href="https://github.com/rust-lang/rust/issues/59823" target="_blank" title="https://github.com/rust-lang/rust/issues/59823">#59823</a> resolved it.</p>



<a name="164085297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164085297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Lawrence <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164085297">(Apr 24 2019 at 14:29)</a>:</h4>
<p>awesome - ty</p>



<a name="164104977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164104977" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164104977">(Apr 24 2019 at 18:08)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> <span class="user-mention" data-user-id="126931">@centril</span> ugh, I still haven't gotten around to trying out upvar simplification but I basically think we shouldn't do "upvar analysis" during name resolution, but move it to HIR lowering, which should allow correct handling</p>



<a name="164105056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164105056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164105056">(Apr 24 2019 at 18:09)</a>:</h4>
<p>and if we don't do any other crazy refactors like adding <code>hir::ExprKind::Local</code> or anything like that, it should be relatively self-contained? complexity would move from <code>rustc_resolve</code> to <code>rustc::hir::lowering</code></p>



<a name="164105179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164105179" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164105179">(Apr 24 2019 at 18:10)</a>:</h4>
<p>and we can even store the "upvar (capture) list" in the <code>hir::ExprKind::Closure</code> instead of in a separate map, but that's a refactor we don't need to do now</p>



<a name="164285975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164285975" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164285975">(Apr 26 2019 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> can you elaborate a bit more on what you mean?</p>



<a name="164285986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164285986" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164285986">(Apr 26 2019 at 18:24)</a>:</h4>
<p>I don't really understand your plan</p>



<a name="164286068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286068" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286068">(Apr 26 2019 at 18:25)</a>:</h4>
<p>But I was thinking that if we <em>do</em> want to match the drop order exactly -- and I think ultimately that's <em>probably</em> what we want -- that we could maybe do it by basically baking in more information onto the closure, making things a bit more special. This may intersect the <a class="stream" data-stream-id="189812" href="/#narrow/stream/189812-t-compiler.2Fwg-rfc-2229">#t-compiler/wg-rfc-2229</a> work as well, I suppose.</p>



<a name="164286070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286070" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286070">(Apr 26 2019 at 18:25)</a>:</h4>
<p>so the difficulty here is that <code>rustc_resolve</code> is what decides the upvar sets</p>



<a name="164286086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286086" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286086">(Apr 26 2019 at 18:26)</a>:</h4>
<p>(Though I think that the drop order from the desugaring we are doing now is the drop order that regular functions <strong>should have had</strong> =) but I guess that's water under the bridge)</p>



<a name="164286150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286150" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286150">(Apr 26 2019 at 18:26)</a>:</h4>
<p>but there's not really any good reason for that other than "doing it when name resolution happens" (which isn't <em>exactly</em> a good reason)</p>



<a name="164286209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286209" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286209">(Apr 26 2019 at 18:27)</a>:</h4>
<p>if we move "<code>Def::Local</code> -&gt; <code>Def::Upvar</code> conversion" to <code>rustc::hir::lowering</code>, it'd be easier to perform the change that moves patterns into the closure</p>



<a name="164286230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286230" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286230">(Apr 26 2019 at 18:27)</a>:</h4>
<p>well</p>



<a name="164286233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286233">(Apr 26 2019 at 18:27)</a>:</h4>
<p>or, ehm</p>



<a name="164286242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286242" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286242">(Apr 26 2019 at 18:27)</a>:</h4>
<p>that's not what causes trouble, just the added <code>arg_i</code> variables?</p>



<a name="164286243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286243" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286243">(Apr 26 2019 at 18:27)</a>:</h4>
<p>so one of the things we've been doing</p>



<a name="164286247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286247" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286247">(Apr 26 2019 at 18:27)</a>:</h4>
<p>/me starts being confused</p>



<a name="164286310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286310" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286310">(Apr 26 2019 at 18:28)</a>:</h4>
<p>either way, I think <code>rustc_resolve</code> shouldn't have that upvar logic baked in</p>



<a name="164286333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286333" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286333">(Apr 26 2019 at 18:28)</a>:</h4>
<p>and having explicit capture lists in <code>hir::ExprKind::Closure</code> seems cool to me</p>



<a name="164286335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286335" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286335">(Apr 26 2019 at 18:28)</a>:</h4>
<p>perhaps so</p>



<a name="164286343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286343">(Apr 26 2019 at 18:28)</a>:</h4>
<p>(instead of a side table)</p>



<a name="164286353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286353" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286353">(Apr 26 2019 at 18:28)</a>:</h4>
<blockquote>
<p>and having explicit capture lists in <code>hir::ExprKind::Closure</code> seems cool to me</p>
</blockquote>
<p>yeah that seems fine</p>



<a name="164286362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286362" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286362">(Apr 26 2019 at 18:28)</a>:</h4>
<p>well</p>



<a name="164286364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286364" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286364">(Apr 26 2019 at 18:29)</a>:</h4>
<p>I think a key question is</p>



<a name="164286377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286377" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286377">(Apr 26 2019 at 18:29)</a>:</h4>
<p>just <em>why</em> does the fn drop order work out the way it does</p>



<a name="164286380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286380" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286380">(Apr 26 2019 at 18:29)</a>:</h4>
<p>and we could even use it to generate captures on unused variables</p>



<a name="164286388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286388" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286388">(Apr 26 2019 at 18:29)</a>:</h4>
<p>but I guess the tl;dr of the fix I imagine is that we have to have <em>some</em> kind of explicit logic around this</p>



<a name="164286391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286391" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286391">(Apr 26 2019 at 18:29)</a>:</h4>
<p>which way? I'm not aware of anything very weird</p>



<a name="164286530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286530">(Apr 26 2019 at 18:30)</a>:</h4>
<p>well, these do not behave the same, I think:</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mf">1.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">DropOrder</span>::<span class="n">Function</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">bar_sync</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mf">1.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">DropOrder</span>::<span class="n">Function</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="164286540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286540" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286540">(Apr 26 2019 at 18:31)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/60236" target="_blank" title="https://github.com/rust-lang/rust/issues/60236">https://github.com/rust-lang/rust/issues/60236</a> has more links</p>



<a name="164286564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286564" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286564">(Apr 26 2019 at 18:31)</a>:</h4>
<p>but that's <code>async fn</code>, which right now doesn't emulate the regular <code>fn</code> drop order at all?</p>



<a name="164286573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286573" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286573">(Apr 26 2019 at 18:31)</a>:</h4>
<p>is that example incomplete?</p>



<a name="164286574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286574" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286574">(Apr 26 2019 at 18:31)</a>:</h4>
<blockquote>
<p>so <code>_</code> is dropped after <code>x</code> for the <code>async</code> version in <code>bar</code> but the sync one is the reverse?</p>
</blockquote>



<a name="164286593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286593" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286593">(Apr 26 2019 at 18:31)</a>:</h4>
<p>so, async fn desugars to</p>



<a name="164286650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286650" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286650">(Apr 26 2019 at 18:32)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="164286657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286657" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286657">(Apr 26 2019 at 18:32)</a>:</h4>
<p>wait did we already do  this?</p>



<a name="164286660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286660" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286660">(Apr 26 2019 at 18:32)</a>:</h4>
<p>I sort of thought that's what functions did too</p>



<a name="164286662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286662" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286662">(Apr 26 2019 at 18:32)</a>:</h4>
<p>yes</p>



<a name="164286666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286666" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286666">(Apr 26 2019 at 18:32)</a>:</h4>
<p>OOOOH</p>



<a name="164286669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286669" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286669">(Apr 26 2019 at 18:32)</a>:</h4>
<p>the problem is that it still doesn't <em>quite</em> match</p>



<a name="164286686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286686" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286686">(Apr 26 2019 at 18:32)</a>:</h4>
<p>yeah okay so the reason is probably that hack we added?</p>



<a name="164286693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286693" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286693">(Apr 26 2019 at 18:32)</a>:</h4>
<p>actually oh I .. hmm</p>



<a name="164286695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286695">(Apr 26 2019 at 18:32)</a>:</h4>
<p>(oops)</p>



<a name="164286704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286704">(Apr 26 2019 at 18:32)</a>:</h4>
<p>I wonder if it's the hack for "single arugment patterns"</p>



<a name="164286706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286706" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286706">(Apr 26 2019 at 18:32)</a>:</h4>
<p>in fns</p>



<a name="164286709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286709" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286709">(Apr 26 2019 at 18:32)</a>:</h4>
<p>to special-case <code>let x = ...;</code> including</p>



<a name="164286710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286710" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286710">(Apr 26 2019 at 18:33)</a>:</h4>
<p>is that the hack you meant?</p>



<a name="164286714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286714">(Apr 26 2019 at 18:33)</a>:</h4>
<p>yeah</p>



<a name="164286716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286716">(Apr 26 2019 at 18:33)</a>:</h4>
<p>yeah that's what I mean</p>



<a name="164286730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286730" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286730">(Apr 26 2019 at 18:33)</a>:</h4>
<p>I .. think that was an unintentional side-effect</p>



<a name="164286734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286734" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286734">(Apr 26 2019 at 18:33)</a>:</h4>
<p>that we stupidly didn't think about</p>



<a name="164286741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286741" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286741">(Apr 26 2019 at 18:33)</a>:</h4>
<p>wow</p>



<a name="164286746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286746" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286746">(Apr 26 2019 at 18:33)</a>:</h4>
<p>"doh"</p>



<a name="164286752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286752" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286752">(Apr 26 2019 at 18:33)</a>:</h4>
<p>but it sounds like we're just not putting it into the right scope?</p>



<a name="164286754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286754" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286754">(Apr 26 2019 at 18:33)</a>:</h4>
<p>one thing I regret from the MIR work, btw</p>



<a name="164286759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286759" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286759">(Apr 26 2019 at 18:33)</a>:</h4>
<p>was not taking the time to carefully write all this stuff out</p>



<a name="164286765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286765" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286765">(Apr 26 2019 at 18:33)</a>:</h4>
<p>and make sure we were happy with it :)</p>



<a name="164286775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286775" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286775">(Apr 26 2019 at 18:33)</a>:</h4>
<blockquote>
<p>but it sounds like we're just not putting it into the right scope?</p>
</blockquote>
<p>you mean the <code>x</code> in the regular function case?</p>



<a name="164286784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286784">(Apr 26 2019 at 18:34)</a>:</h4>
<p>something something sufficiently advanced environment for writing a neat executable spec in :P</p>



<a name="164286826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286826" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286826">(Apr 26 2019 at 18:34)</a>:</h4>
<p>yeah</p>



<a name="164286829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286829">(Apr 26 2019 at 18:34)</a>:</h4>
<blockquote>
<p>was not taking the time to carefully write all this stuff out</p>
</blockquote>
<p>to be fair, some people tried to, but we never really followed it all the way through</p>



<a name="164286835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286835" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286835">(Apr 26 2019 at 18:34)</a>:</h4>
<p>it sounds like it's getting dropped in the same scope <code>_</code> is?</p>



<a name="164286842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286842" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286842">(Apr 26 2019 at 18:34)</a>:</h4>
<p>correct</p>



<a name="164286847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286847" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286847">(Apr 26 2019 at 18:34)</a>:</h4>
<p>I agree that it seems like a bug</p>



<a name="164286849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286849" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286849">(Apr 26 2019 at 18:34)</a>:</h4>
<p>but I'm not sure it's a bug we can fix =)</p>



<a name="164286850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286850" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286850">(Apr 26 2019 at 18:34)</a>:</h4>
<p>yeah that... should just not happen</p>



<a name="164286857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286857">(Apr 26 2019 at 18:34)</a>:</h4>
<p>I'm surprised it can at all</p>



<a name="164286908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286908" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286908">(Apr 26 2019 at 18:35)</a>:</h4>
<p>isn't some of this more recent? can you use <code>godbolt</code> to try versions? I guess that doesn't execute the code (so you'd have to rely on generating very simple assembly that e.g. stores to an atomic static)</p>



<a name="164286944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164286944" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164286944">(Apr 26 2019 at 18:35)</a>:</h4>
<p>I guess I could try, I'm not doing anything else atm (other than playing with those silly diagrams)</p>



<a name="164287002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164287002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164287002">(Apr 26 2019 at 18:36)</a>:</h4>
<p>I don't know</p>



<a name="164287008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164287008" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164287008">(Apr 26 2019 at 18:36)</a>:</h4>
<p>worth finding out</p>



<a name="164287011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164287011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164287011">(Apr 26 2019 at 18:36)</a>:</h4>
<p>I mean it <em>is</em> a pretty edge case</p>



<a name="164287494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164287494" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164287494">(Apr 26 2019 at 18:43)</a>:</h4>
<p>wait, I'm confused</p>



<a name="164287517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164287517" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164287517">(Apr 26 2019 at 18:43)</a>:</h4>
<p>you were saying <code>_</code> is dropped <em>before</em> the named variable?</p>



<a name="164287618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164287618" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164287618">(Apr 26 2019 at 18:44)</a>:</h4>
<p>okay so there are several things interacting here</p>



<a name="164288010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164288010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164288010">(Apr 26 2019 at 18:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> okay I've confirmed that named patterns don't matter <a href="https://godbolt.org/z/HIuWzU" target="_blank" title="https://godbolt.org/z/HIuWzU">https://godbolt.org/z/HIuWzU</a></p>



<a name="164288191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164288191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164288191">(Apr 26 2019 at 18:51)</a>:</h4>
<p>frankly I can't get any order other than <code>2,1</code> to show up</p>



<a name="164288248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164288248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164288248">(Apr 26 2019 at 18:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> so I think the problem is with closure captures!</p>



<a name="164288252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164288252" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164288252">(Apr 26 2019 at 18:52)</a>:</h4>
<p>try doing this instead:</p>



<a name="164288303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164288303" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164288303">(Apr 26 2019 at 18:53)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_N</span><span class="p">;</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">pat_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_0</span><span class="p">;</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="kd">let</span><span class="w"> </span><span class="n">pat_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_N</span><span class="p">;</span><span class="w"></span>
</pre></div>



<a name="164291187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291187" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291187">(Apr 26 2019 at 19:32)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116107">@davidtwco</span> <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="164291202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291202" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291202">(Apr 26 2019 at 19:32)</a>:</h4>
<blockquote>
<p>you were saying <code>_</code> is dropped <em>before</em> the named variable?</p>
</blockquote>
<p>honestly i'm not sure <span class="user-mention" data-user-id="119009">@eddyb</span>, I didn't dig <em>that</em> deeply</p>



<a name="164291222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291222">(Apr 26 2019 at 19:33)</a>:</h4>
<blockquote>
<p>so I think the problem is with closure captures!</p>
</blockquote>
<p>OH</p>



<a name="164291228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291228" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291228">(Apr 26 2019 at 19:33)</a>:</h4>
<p>you mean because of the order that struct fields are dropped</p>



<a name="164291234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291234" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291234">(Apr 26 2019 at 19:33)</a>:</h4>
<p>and how that is different from <code>let</code></p>



<a name="164291236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291236" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291236">(Apr 26 2019 at 19:33)</a>:</h4>
<p>wow, that'd be nifty</p>



<a name="164291306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291306">(Apr 26 2019 at 19:34)</a>:</h4>
<p>When I spoke to you last <span class="user-mention" data-user-id="119009">@eddyb</span>, the desugaring for <code>async fn</code> to statements hadn’t landed.</p>



<a name="164291389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164291389" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164291389">(Apr 26 2019 at 19:35)</a>:</h4>
<p>I’ll give that a shot.</p>



<a name="164295881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164295881" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164295881">(Apr 26 2019 at 20:37)</a>:</h4>
<div class="codehilite"><pre><span></span>                                /// Check that unused bindings are dropped after the function is polled.
                                async fn foo_async(__arg0: D, __arg1: D)
                                 -&gt;
                                      ::std::future::from_generator(move ||
                                                                        {
                                                                            let _ =
                                                                                __arg1;
                                                                            let _ =
                                                                                __arg0;
                                                                            let x =
                                                                                __arg0;
                                                                            let _y =
                                                                                __arg1;
                                                                            x.1.borrow_mut().push(DropOrder::Function);
                                                                        })
</pre></div>


<p>If this is what you meant, it doesn't seem to achieve the desired effect.</p>



<a name="164297988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164297988" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164297988">(Apr 26 2019 at 21:07)</a>:</h4>
<p>what effect is achieved? :)</p>



<a name="164298108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164298108" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164298108">(Apr 26 2019 at 21:09)</a>:</h4>
<p>It failed on the same assert as before in the test from the issue, where there are only two parameters - <code>x</code> and <code>_</code>.</p>



<a name="164298110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164298110" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164298110">(Apr 26 2019 at 21:09)</a>:</h4>
<p>They were still the wrong order, so no effect?</p>



<a name="164298291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164298291" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164298291">(Apr 26 2019 at 21:11)</a>:</h4>
<div class="codehilite"><pre><span></span> async: `[Function, Val(&quot;x&quot;), Val(&quot;_&quot;)]`
  sync: `[Function, Val(&quot;_&quot;), Val(&quot;x&quot;)]`
</pre></div>



<a name="164298994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164298994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164298994">(Apr 26 2019 at 21:22)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> that order is the order in which things get dropped?</p>



<a name="164299000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299000">(Apr 26 2019 at 21:22)</a>:</h4>
<p>Yeah.</p>



<a name="164299011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299011">(Apr 26 2019 at 21:22)</a>:</h4>
<p>It's just the assert output but I renamed left and right to async and sync respectively.</p>



<a name="164299015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299015" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299015">(Apr 26 2019 at 21:22)</a>:</h4>
<p>and the example is <code>fn bar(x: Blah, _: ...)</code>?</p>



<a name="164299022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299022" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299022">(Apr 26 2019 at 21:22)</a>:</h4>
<p>or is it <code>_, x</code></p>



<a name="164299061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299061" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299061">(Apr 26 2019 at 21:23)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mf">1.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">DropOrder</span>::<span class="n">Function</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">bar_sync</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mf">1.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">DropOrder</span>::<span class="n">Function</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Comparison of the drop order of these functions.</p>



<a name="164299143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299143">(Apr 26 2019 at 21:24)</a>:</h4>
<p>yep, ok</p>



<a name="164299258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299258" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299258">(Apr 26 2019 at 21:27)</a>:</h4>
<p>And here's the HIR for those functions (since before I posted the <code>foo</code> desugaring, though they're pretty similar):</p>
<div class="codehilite"><pre><span></span>                                /// Check that underscore patterns are dropped after the function is polled.
                                async fn bar_async(__arg0: D, __arg1: D)
                                 -&gt;
                                      ::std::future::from_generator(move ||
                                                                        {
                                                                            let _ =
                                                                                __arg1;
                                                                            let _ =
                                                                                __arg0;
                                                                            let x =
                                                                                __arg0;
                                                                            let _ =
                                                                                __arg1;
                                                                            x.1.borrow_mut().push(DropOrder::Function);
                                                                        })

                                fn bar_sync(x: D,
                                            _:
                                                D) {
                                                       x.1.borrow_mut().push(DropOrder::Function);
                                                   }
</pre></div>



<a name="164299574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299574" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299574">(Apr 26 2019 at 21:32)</a>:</h4>
<p>Interestingly, this appears to work <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=a59c6c8984cd38a94ddeb41a0d3252b6" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=a59c6c8984cd38a94ddeb41a0d3252b6">for the simple case</a> when just experimenting w/ closures.</p>



<a name="164299896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164299896" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164299896">(Apr 26 2019 at 21:37)</a>:</h4>
<p>It could be that in one or two places I'm not visiting in the right order and that's why I don't see it locally.</p>



<a name="164300081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300081" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300081">(Apr 26 2019 at 21:40)</a>:</h4>
<blockquote>
<p>Interestingly, this appears to work <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=a59c6c8984cd38a94ddeb41a0d3252b6" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=a59c6c8984cd38a94ddeb41a0d3252b6">for the simple case</a> when just experimenting w/ closures.</p>
</blockquote>
<p>Scratch that, that test had the right order before too (because it is the reverse of what we have implemented, but the implementation can't be reversed w/out breaking the order for non-<code>_</code> bindings IIRC).</p>



<a name="164300343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300343">(Apr 26 2019 at 21:44)</a>:</h4>
<p>I don't think any "simple" change to our order will work because the more complex patterns aren't affected and still come up wrong.</p>



<a name="164300732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300732" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300732">(Apr 26 2019 at 21:50)</a>:</h4>
<p>Yeah -- I think that the <em>bug</em> (in some sense) is in the order that fn drop executes</p>



<a name="164300741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300741" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300741">(Apr 26 2019 at 21:50)</a>:</h4>
<p>But I have to dig a bit to verify that hypothesis I guess</p>



<a name="164300757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300757" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300757">(Apr 26 2019 at 21:50)</a>:</h4>
<p>But by "bug" I mean that it is not equivalent to a simple desugaring</p>



<a name="164300775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300775" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300775">(Apr 26 2019 at 21:51)</a>:</h4>
<p>Though I sort of feel like it was "meant" to be</p>



<a name="164300791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164300791" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164300791">(Apr 26 2019 at 21:51)</a>:</h4>
<p>It's a grey area =)</p>



<a name="164558306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558306">(Apr 30 2019 at 17:34)</a>:</h4>
<p>so <span class="user-mention" data-user-id="116107">@davidtwco</span> I have a theory as to what the problem is</p>



<a name="164558311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558311">(Apr 30 2019 at 17:34)</a>:</h4>
<p>I'm not sure if I communicated it to you</p>



<a name="164558338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558338" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558338">(Apr 30 2019 at 17:35)</a>:</h4>
<p>basically, when we do MIR construction, we actually desugar complex fn patterns in the same way you are doing manually</p>



<a name="164558473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558473" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558473">(Apr 30 2019 at 17:36)</a>:</h4>
<p>at least I think this is true, i'm looking for the code</p>



<a name="164558487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558487" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558487">(Apr 30 2019 at 17:36)</a>:</h4>
<p>anyway, I think we have an optimization around <code>fn fo(a: u32)</code> to avoid doing this, because it was adding an extra MIR parameter</p>



<a name="164558495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558495" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558495">(Apr 30 2019 at 17:36)</a>:</h4>
<p>but I think this affects the drop order</p>



<a name="164558561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558561" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558561">(Apr 30 2019 at 17:37)</a>:</h4>
<p>ah, yes, <a href="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L929-L954" target="_blank" title="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L929-L954">right here is the code I am talking about</a></p>



<a name="164558690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558690" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558690">(Apr 30 2019 at 17:39)</a>:</h4>
<p>i.e., the problem here is that in the "simple pattern case" we wind up directly reusing the <a href="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L914" target="_blank" title="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L914">MIR local for the argument</a></p>



<a name="164558710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558710" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558710">(Apr 30 2019 at 17:39)</a>:</h4>
<p>but in the "complex pattern" case we will <a href="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L948-L951" target="_blank" title="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L948-L951">"declare bindings"</a> separately, and they will drop later</p>



<a name="164558795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558795">(Apr 30 2019 at 17:40)</a>:</h4>
<p>this <em>perhaps</em> suggests that treating "simple paths" in the desugaring would work I think?</p>



<a name="164558827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558827" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558827">(Apr 30 2019 at 17:41)</a>:</h4>
<p>Treating simple paths in what way? I'm not sure I follow.</p>



<a name="164558856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558856" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558856">(Apr 30 2019 at 17:41)</a>:</h4>
<p>i.e., right now (iiuc) we desugar</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mf">1.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">DropOrder</span>::<span class="n">Function</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>to </p>
<div class="codehilite"><pre><span></span>fn bar(__arg0: D, __arg1: D) {
  async move {
    let x = __arg0; // moves __arg0 into x
    let _ = __arg1; // no-op
  }
}
</pre></div>



<a name="164558866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558866" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558866">(Apr 30 2019 at 17:41)</a>:</h4>
<p>as a result, we will first drop the inner binding <code>x</code>, then we will drop <code>__arg1</code></p>



<a name="164558924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558924" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558924">(Apr 30 2019 at 17:42)</a>:</h4>
<p>but in the normal fn case, we don't have the equivalent <code>let x = __arg0</code> because we "optimized" that case</p>



<a name="164558933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164558933" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164558933">(Apr 30 2019 at 17:42)</a>:</h4>
<p>and instead we map <code>x</code> directly to arg0</p>



<a name="164559015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164559015" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164559015">(Apr 30 2019 at 17:43)</a>:</h4>
<p>so maybe a desugaring like this</p>
<div class="codehilite"><pre><span></span><span class="c1">// do not rename `x`, because it is a simple pattern, but rename `_` to `__arg1`</span>
<span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">__arg1</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// first add a `let _ = X` for each argument `X`:</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">  </span><span class="c1">// ensure this is captured</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg1</span><span class="p">;</span><span class="w">      </span><span class="c1">// and this</span>

<span class="w">    </span><span class="c1">// then, for each non-simple pattern, add `let PAT = ARG`:</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg1</span><span class="p">;</span><span class="w"> </span><span class="c1">// no-op</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="164559023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164559023" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164559023">(Apr 30 2019 at 17:43)</a>:</h4>
<p>I think that would have the intended drop order?</p>



<a name="164559079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164559079" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164559079">(Apr 30 2019 at 17:44)</a>:</h4>
<p>you might have to reverse the order of the first group of <code>let _ = ...</code> statements</p>



<a name="164559113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164559113" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164559113">(Apr 30 2019 at 17:44)</a>:</h4>
<p>does that make sense?</p>



<a name="164559413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164559413" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164559413">(Apr 30 2019 at 17:49)</a>:</h4>
<p>What I was noticing was that for this:</p>
<div class="codehilite"><pre><span></span>fn bar(__arg0: D, __arg1: (D, D, D), __arg2: D) -&gt; impl Future {
  future::from_generator(|| {
    let x = __arg0;
    let (a, _, _c) = __arg1;
    let _y = __arg2;
  })
}
</pre></div>


<p>We would end up with MIR that looked something like this (apologies for the rough hand-written MIR-esque representation):</p>
<div class="codehilite"><pre><span></span>fn bar::{{closure}}(_1: [generator __arg0:D __arg1:(D,D,D) __arg2:D]) -&gt; () {
_2: D &quot;x&quot;
_3: D &quot;a&quot;
_4: D &quot;_c&quot;
_5: D &quot;_y&quot;

bb0:
    _2 = _1.1
    _3 = _1.2.1
    // missing local for the `_` binding
    _4 = _1.2.3
   _5 = _1.3

...

bb7:
   drop(_2) -&gt; bb8

bb8:
   drop(_3) -&gt; bb9

// no drop for the underscore binding

bb9:
   drop(_4) -&gt; bb10

bb10:
   drop(_5) -&gt; bb11

// underscore binding dropped with the rest of the generator

bb11:
   drop(_1)
}
</pre></div>



<a name="164559449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164559449" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164559449">(Apr 30 2019 at 17:49)</a>:</h4>
<p>(I just got back home so I'm currently making dinner and putting some washing on, so slightly preoccupied)</p>



<a name="164575946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164575946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164575946">(Apr 30 2019 at 20:56)</a>:</h4>
<p>So, I've fixed one of the order differences. I'm not yet sure why it is only one of them.</p>
<p>With this signature:</p>
<div class="codehilite"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foobar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_c</span><span class="p">)</span>: <span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">),</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">_y</span>: <span class="nc">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>On nightly currently:</p>
<div class="codehilite"><pre><span></span> async: `[Function, Val(&quot;_y&quot;), Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;x&quot;), Val(&quot;_&quot;), Val(&quot;_&quot;)]`
  sync: `[Function, Val(&quot;_y&quot;), Val(&quot;_&quot;), Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;_&quot;), Val(&quot;x&quot;)]`
</pre></div>


<p>Locally, after making some changes:</p>
<div class="codehilite"><pre><span></span> async: `[Function, Val(&quot;_y&quot;), Val(&quot;_&quot;), Val(&quot;_c&quot;), Val(&quot;_&quot;), Val(&quot;a&quot;), Val(&quot;x&quot;)]`,
  sync: `[Function, Val(&quot;_y&quot;), Val(&quot;_&quot;), Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;_&quot;), Val(&quot;x&quot;)]`
</pre></div>



<a name="164576400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164576400" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164576400">(Apr 30 2019 at 21:00)</a>:</h4>
<p>(I've not ran any of the other tests, just using a reduced test case with just the <code>foobar</code> function for now).</p>



<a name="164578243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164578243" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164578243">(Apr 30 2019 at 21:24)</a>:</h4>
<p>When I look at the drop order in the MIR, then the drop terminators happen in the expected order (now, after adding drops for the <code>_</code> bindings), and that works for the <code>_</code> binding that isn't in a more complex pattern, but not the <code>_</code> in the tuple, even though drop terminator for <code>_</code> (in the same scope) is before <code>a</code>.</p>
<p>Though, the downsides with this approach are that it just changes the desugaring slightly to get closer to the <code>fn</code> order, it doesn't do anything to try unify the ordering and that it also wouldn't work if you desugared the function manually (which I think is fine?).</p>



<a name="164579900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164579900" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164579900">(Apr 30 2019 at 21:49)</a>:</h4>
<p>Interestingly, the same thing appears to happen for the <code>x</code>, <code>_</code> case even though there's no complex pattern in that. I don't have time to investigate any further tonight, but I think this is still reasonable progress.</p>



<a name="164581752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164581752" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164581752">(Apr 30 2019 at 22:20)</a>:</h4>
<p>OK -- did what I wrote make any sense to you, <span class="user-mention" data-user-id="116107">@davidtwco</span>? If I'm right (and I might not be), we ought to be able to match all cases by special-casing "simple patterns"</p>



<a name="164581754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164581754" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164581754">(Apr 30 2019 at 22:20)</a>:</h4>
<p>I should run some experiments</p>



<a name="164581897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164581897" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164581897">(Apr 30 2019 at 22:22)</a>:</h4>
<p>I haven’t tried it, but I should be able to pretty quickly tomorrow.</p>



<a name="164582412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164582412" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164582412">(Apr 30 2019 at 22:29)</a>:</h4>
<p>I wasn’t expecting <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=b5df858d93ea8551e0f77125bb26def6" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=b5df858d93ea8551e0f77125bb26def6">this case</a> to work, but given that it does, you’re probably right and your solution would do it.</p>



<a name="164582660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164582660" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164582660">(Apr 30 2019 at 22:33)</a>:</h4>
<blockquote>
<p>adding drops for the <code>_</code> bindings</p>
</blockquote>
<p>Doesn't this break something like <code>&amp;(_,): &amp;(String,)</code>?</p>



<a name="164585047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585047" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585047">(Apr 30 2019 at 23:09)</a>:</h4>
<blockquote>
<p>Doesn't this break something like <code>&amp;(_,): &amp;(String,)</code>?</p>
</blockquote>
<p>I've ditched that approach in favor of <span class="user-mention" data-user-id="116009">@nikomatsakis</span>'s suggestion.</p>
<blockquote>
<p>OK -- did what I wrote make any sense to you, <span class="user-mention silent" data-user-id="116107">davidtwco</span>? If I'm right (and I might not be), we ought to be able to match all cases by special-casing "simple patterns"</p>
</blockquote>
<p>So, I've implemented this. It fixes the simple case where you've got <code>async fn bar(x: D, _: D)</code>, but not the more complex <code>foobar</code> case which desugars to:</p>
<div class="codehilite"><pre><span></span>                                async fn foobar_async(x: D, __arg1: (D, D, D),
                                                      __arg2: D, _y: D)
                                 -&gt;
                                      ::std::future::from_generator(move ||
                                                                        {
                                                                            let _ =
                                                                                _y;
                                                                            let _ =
                                                                                __arg2;
                                                                            let _ =
                                                                                __arg1;
                                                                            let _ =
                                                                                x;
                                                                            let (a,
                                                                                 _,
                                                                                 _c) =
                                                                                __arg1;
                                                                            let _ =
                                                                                __arg2;
                                                                            x.1.borrow_mut().push(DropOrder::Function);
                                                                        })
</pre></div>


<p>and gives the result:</p>
<div class="codehilite"><pre><span></span> async: `[Function, Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;_y&quot;), Val(&quot;_&quot;), Val(&quot;_&quot;), Val(&quot;x&quot;)]`
  sync: `[Function, Val(&quot;_y&quot;), Val(&quot;_&quot;), Val(&quot;_c&quot;), Val(&quot;a&quot;), Val(&quot;_&quot;), Val(&quot;x&quot;)]`
</pre></div>



<a name="164585119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585119" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585119">(Apr 30 2019 at 23:10)</a>:</h4>
<p>what's the original again?</p>



<a name="164585137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585137">(Apr 30 2019 at 23:11)</a>:</h4>
<p>hmm</p>



<a name="164585170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585170" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585170">(Apr 30 2019 at 23:11)</a>:</h4>
<p>I guess my thesis is wrong when it comes to sync drop order</p>



<a name="164585222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585222">(Apr 30 2019 at 23:12)</a>:</h4>
<p>I'm trying now with the order of the <code>let &lt;pat&gt; = &lt;init&gt;</code> statements reversed just to see what that does.</p>



<a name="164585330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585330" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585330">(Apr 30 2019 at 23:14)</a>:</h4>
<p>No difference.</p>



<a name="164585342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585342" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585342">(Apr 30 2019 at 23:14)</a>:</h4>
<p>I assume the order is determined only by the <code>let _ = &lt;init&gt;;</code> statements.</p>



<a name="164585376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164585376" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164585376">(Apr 30 2019 at 23:15)</a>:</h4>
<p>Anyway, it's late here, I'll implement any ideas you have sometime tomorrow.</p>



<a name="164610638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610638" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610638">(May 01 2019 at 09:12)</a>:</h4>
<p>First, let me check. This function:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">foobar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>: <span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">),</span><span class="w"> </span><span class="n">_</span>: <span class="nc">D</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">D</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>drops in the order:</p>
<ul>
<li><code>y</code></li>
<li>arg2</li>
<li><code>c</code>, <code>a</code>, arg1</li>
<li><code>x</code></li>
</ul>



<a name="164610654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610654" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610654">(May 01 2019 at 09:13)</a>:</h4>
<p>this suggests that the order is the following:</p>
<ul>
<li>in reverse of the arguments:<ul>
<li>drop bindings from within the pattern (in reverse order)</li>
<li>then drop the argument (if not fully bound)</li>
</ul>
</li>
</ul>



<a name="164610731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610731" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610731">(May 01 2019 at 09:14)</a>:</h4>
<p>if so, then I guess we can desugar to match this order like so:</p>



<a name="164610870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610870">(May 01 2019 at 09:17)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="c1">// in order over arguments:</span>
<span class="kd">let</span><span class="w"> </span><span class="n">__arg_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg_i</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">pattern_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg_i</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>i.e.,</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">__arg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg0</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">__arg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg1</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">__arg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg2</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg2</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">__arg3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg3</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg3</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>we could then go further and special case "simple" patterns, which is really an optimization I think, so that we wind up with</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">__arg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg1</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">__arg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg2</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__arg2</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
</pre></div>



<a name="164610872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610872" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610872">(May 01 2019 at 09:17)</a>:</h4>
<p>we ought to be able to test this theory on play ;)</p>



<a name="164610961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610961" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610961">(May 01 2019 at 09:19)</a>:</h4>
<p>re-reading the code I cited earlier, this makes sense. The MIR lowering for arguments:</p>
<ul>
<li>first registers the internal "arugment local" (equivalent of <code>__arg_i</code>) for drop <a href="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L918-L923" target="_blank" title="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L918-L923">here</a></li>
</ul>



<a name="164610979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164610979" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164610979">(May 01 2019 at 09:19)</a>:</h4>
<ul>
<li>it then <a href="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L948-L951" target="_blank" title="https://github.com/rust-lang/rust/blob/862a8784ab6fdc799911487a30f3211b3a5c1945/src/librustc_mir/build/mod.rs#L948-L951">optionally invokes <code>declare_bindings</code></a>, which will register the internal bindings for drop</li>
</ul>



<a name="164611040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164611040" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164611040">(May 01 2019 at 09:20)</a>:</h4>
<p>when you register things for drop, they wind up being dropped in the reverse order of which they were registered</p>



<a name="164611051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164611051" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164611051">(May 01 2019 at 09:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> -- if you get a chance, see if that desugaring works better in play</p>



<a name="164611137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164611137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164611137">(May 01 2019 at 09:22)</a>:</h4>
<p>I'll give that a go in a bit, thanks.</p>



<a name="164619026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164619026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164619026">(May 01 2019 at 12:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I think that worked, I modified my PR (it was quicker than using the playground after how I'd modified it last night) and it passed the tests. Will put a PR up shortly.</p>



<a name="164619207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164619207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164619207">(May 01 2019 at 12:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> even better, that drop order (i.e., for fns) is...kind of logical.</p>



<a name="164619211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164619211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164619211">(May 01 2019 at 12:19)</a>:</h4>
<p>We should document it ;)</p>



<a name="164621053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621053" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621053">(May 01 2019 at 12:55)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <a href="https://github.com/rust-lang/rust/issues/60437" target="_blank" title="https://github.com/rust-lang/rust/issues/60437">#60437</a></p>



<a name="164621130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621130" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621130">(May 01 2019 at 12:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> btw, I've not looked closely at the desugaring bits, but these <code>__arg3</code> etc variables -- are they "visible" to users? Or are we using hygiene to hide them?</p>



<a name="164621165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621165">(May 01 2019 at 12:57)</a>:</h4>
<p>I'm not sure. I haven't done anything specific to hide them.</p>



<a name="164621222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621222">(May 01 2019 at 12:58)</a>:</h4>
<p>I figured as they were being moved into the pattern that it wouldn't be usable, but they might be visible in that the error you get when attempting to use them isn't "this doesn't exist".</p>



<a name="164621347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621347" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621347">(May 01 2019 at 13:00)</a>:</h4>
<p>I guess with <code>_</code> patterns they are still usable</p>



<a name="164621365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621365" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621365">(May 01 2019 at 13:01)</a>:</h4>
<p>Can you write a test and maybe file a bug? Seems like something we should try to fix ;)</p>



<a name="164621735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621735" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621735">(May 01 2019 at 13:07)</a>:</h4>
<p>(I can do it)</p>



<a name="164621825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621825" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621825">(May 01 2019 at 13:09)</a>:</h4>
<blockquote>
<p>__arg variables from async fn desugaring are accessible to the user <a href="https://github.com/rust-lang/rust/issues/60438" target="_blank" title="https://github.com/rust-lang/rust/issues/60438">#60438</a></p>
</blockquote>



<a name="164621827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621827" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621827">(May 01 2019 at 13:09)</a>:</h4>
<p>I <em>think</em> we should be able to use hygiene here to hide these <code>__arg</code> variables, but I'm not entirely sure how to do that.</p>



<a name="164621844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621844" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621844">(May 01 2019 at 13:09)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> -- any tips for how we can create a <code>__arg</code> variable (during parsing, I believe) that will not be nameable by the user? Is the "gensym" method the thing we want?</p>



<a name="164621850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621850" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621850">(May 01 2019 at 13:10)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> may also have thoughts</p>



<a name="164621924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621924" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621924">(May 01 2019 at 13:10)</a>:</h4>
<p>yeah, <code>gensym</code>, but ideally you wouldn't go as far back as parsing, ugh</p>



<a name="164621958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621958" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621958">(May 01 2019 at 13:11)</a>:</h4>
<p>We don't introduce it during parsing, we just construct it there otherwise we'd need to construct the same arg/stmt in a few places. It's still not ideal.</p>



<a name="164621961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164621961" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164621961">(May 01 2019 at 13:11)</a>:</h4>
<p>I'm accumulating too many refactors to do, but we should seriously consider creating <code>Def::Upvar</code> out of <code>Def::Local</code> during HIR lowering, so much less of this needs to be handled by <code>rustc_resolve</code></p>



<a name="164622047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622047" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622047">(May 01 2019 at 13:12)</a>:</h4>
<p>I definitely agree that we clearly need some refactoring here :)</p>



<a name="164622061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622061" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622061">(May 01 2019 at 13:13)</a>:</h4>
<p>That is, this feels like it was much harder than it should have been</p>



<a name="164622069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622069" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622069">(May 01 2019 at 13:13)</a>:</h4>
<p>I also need some prioritization, I started something a week ago and it blew out of control</p>



<a name="164622076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622076" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622076">(May 01 2019 at 13:13)</a>:</h4>
<blockquote>
<p>We don't introduce it during parsing, we just construct it there otherwise we'd need to construct the same arg/stmt in a few places. It's still not ideal.</p>
</blockquote>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> -- have you seen gensym?</p>



<a name="164622090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622090" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622090">(May 01 2019 at 13:13)</a>:</h4>
<p>I'm compiling a version with it now.</p>



<a name="164622096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622096">(May 01 2019 at 13:13)</a>:</h4>
<p>and it overlaps enough with this <code>Def::Upvar</code> thing that I wanted to finish that first, but maybe I should've switched gears</p>



<a name="164622162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622162" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622162">(May 01 2019 at 13:14)</a>:</h4>
<p>So, this stops users using it, but there's still a suggestion.</p>
<div class="codehilite"><pre><span></span>error[E0425]: cannot find value `__arg1` in this scope
  --&gt; /home/david/projects/rust/rust2/src/test/ui/issue-60236.rs:21:16
   |
LL |     assert_eq!(__arg1, (1, 2, 3));
   |                ^^^^^^ help: a local variable with a similar name exists: `__arg1`

error[E0425]: cannot find value `__arg2` in this scope
  --&gt; /home/david/projects/rust/rust2/src/test/ui/issue-60236.rs:22:16
   |
LL |     assert_eq!(__arg2, 4);
   |                ^^^^^^ help: a local variable with a similar name exists: `__arg2`
</pre></div>



<a name="164622172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622172" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622172">(May 01 2019 at 13:14)</a>:</h4>
<p>lol</p>



<a name="164622188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622188" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622188">(May 01 2019 at 13:15)</a>:</h4>
<p>IMO that suggestion shouldn't fire on gensyms</p>



<a name="164622192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622192" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622192">(May 01 2019 at 13:15)</a>:</h4>
<p>I'll keep it and the suggestion fix can be a follow-up.</p>



<a name="164622203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622203" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622203">(May 01 2019 at 13:15)</a>:</h4>
<p>Unless it's really quick to fix I suppose, I should look.</p>



<a name="164622218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622218" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622218">(May 01 2019 at 13:15)</a>:</h4>
<p>yeah it should just be <code>if !name.is_gensym()</code> around the "edit distance" comparison</p>



<a name="164622283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622283" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622283">(May 01 2019 at 13:16)</a>:</h4>
<p>also, this probably means it fires right now on <code>_1</code> and <code>use Foo as _;</code></p>



<a name="164622290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622290" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622290">(May 01 2019 at 13:16)</a>:</h4>
<p>if that's the closest name</p>



<a name="164622826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164622826" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164622826">(May 01 2019 at 13:26)</a>:</h4>
<p>Alright, that's fixed. Will include in the PR.</p>



<a name="164624137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164624137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164624137">(May 01 2019 at 13:46)</a>:</h4>
<p>Nice job</p>



<a name="164624246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164624246" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164624246">(May 01 2019 at 13:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Just updated it.</p>



<a name="164624254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164624254" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164624254">(May 01 2019 at 13:49)</a>:</h4>
<p>And fixed previous comments.</p>



<a name="164624946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164624946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164624946">(May 01 2019 at 13:58)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> looks good, though the test looks a bit more complex than necessary. But I guess the "arc-wake" infra might be useful for other tests.</p>



<a name="164625028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625028" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625028">(May 01 2019 at 13:58)</a>:</h4>
<p>I suppose it is. I wasn't really thinking about it, I just took the existing test and deleted parts.</p>



<a name="164625033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625033" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625033">(May 01 2019 at 13:58)</a>:</h4>
<p>I can simplify it if you want.</p>



<a name="164625056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625056">(May 01 2019 at 13:59)</a>:</h4>
<p>I assume <code>ArcWake</code> will only be useful in <code>run-pass</code> anyway.</p>



<a name="164625151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625151" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625151">(May 01 2019 at 14:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> Yeah, let's simplify. Also, I'd probably prefer for all the tests to live in <code>src/test/ui/async-await</code> (including the run-pass test!) but I don't know if we've reached a conclusion on that yet.</p>



<a name="164625168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625168" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625168">(May 01 2019 at 14:00)</a>:</h4>
<p>i.e., I think we're still separating run-pass tests sometimes? I remember we went back and forth</p>



<a name="164625201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625201" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625201">(May 01 2019 at 14:01)</a>:</h4>
<p>There are some from the first batch that got moved into ui that remain there, otherwise they are all in run-pass.</p>



<a name="164625214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625214">(May 01 2019 at 14:01)</a>:</h4>
<p>I think I moved all the RFC 2008 tests together into UI after that though.</p>



<a name="164625511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625511" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625511">(May 01 2019 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> fixed that.</p>



<a name="164625515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164625515" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164625515">(May 01 2019 at 14:05)</a>:</h4>
<p>PR updated.</p>



<a name="164630475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164630475" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164630475">(May 01 2019 at 15:10)</a>:</h4>
<p>Nice work, <span class="user-mention" data-user-id="116107">@davidtwco</span>!</p>



<a name="164630486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164630486" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164630486">(May 01 2019 at 15:10)</a>:</h4>
<p>Really great to close this one out :)</p>



<a name="164640116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164640116" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164640116">(May 01 2019 at 17:27)</a>:</h4>
<p>Yea we only use <code>.../ui</code> tests these days for new tests</p>



<a name="164667317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164667317" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164667317">(May 01 2019 at 23:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> so this is the PR I was hoping to finish much earlier: <a href="https://github.com/rust-lang/rust/pull/60462" target="_blank" title="https://github.com/rust-lang/rust/pull/60462">https://github.com/rust-lang/rust/pull/60462</a></p>



<a name="164736402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164736402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164736402">(May 02 2019 at 19:12)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> awesome! looks good.</p>



<a name="164761585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164761585" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164761585">(May 03 2019 at 02:03)</a>:</h4>
<p>yeah, I just need to get to the part where I actually help the async situation :P</p>



<a name="164843060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164843060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164843060">(May 04 2019 at 01:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> oooh I have some good news! we should be able to kill <code>Res::Upvar</code> completely!</p>



<a name="164845096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164845096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164845096">(May 04 2019 at 02:23)</a>:</h4>
<p>okay, it's a bit tricky, but it's effectively unnecessary</p>



<a name="164860960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/164860960" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#164860960">(May 04 2019 at 10:17)</a>:</h4>
<p>Apologies for all the fallout of the drop order PRs, I'll do better in future.</p>



<a name="165033434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/165033434" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#165033434">(May 07 2019 at 01:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> heh, no worries-- it's a tricky mess. They didn't occur to me either!</p>



<a name="165033439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/165033439" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#165033439">(May 07 2019 at 01:10)</a>:</h4>
<p>I guess that's good incentive to keep adding lots of good tests</p>



<a name="165270670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/165270670" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#165270670">(May 09 2019 at 17:02)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/60674" target="_blank" title="https://github.com/rust-lang/rust/issues/60674">#60674</a></p>



<a name="165270673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/165270673" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#165270673">(May 09 2019 at 17:02)</a>:</h4>
<p>Ugh.</p>



<a name="165271940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/165271940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#165271940">(May 09 2019 at 17:20)</a>:</h4>
<p>ugh indeed</p>



<a name="165276353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/165276353" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#165276353">(May 09 2019 at 18:21)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/60676" target="_blank" title="https://github.com/rust-lang/rust/issues/60676">#60676</a></p>



<a name="166772436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166772436" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166772436">(May 29 2019 at 00:13)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/61276" target="_blank" title="https://github.com/rust-lang/rust/pull/61276">https://github.com/rust-lang/rust/pull/61276</a></p>



<a name="166772501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166772501" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166772501">(May 29 2019 at 00:14)</a>:</h4>
<p>I managed to get back to this refactor and finish it, well, minus the part where async closures are lowered at HIR time</p>



<a name="166773161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166773161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166773161">(May 29 2019 at 00:26)</a>:</h4>
<p>the painful thing is that it looks like there  could've been a version that works in HIR lowering</p>



<a name="166775707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166775707" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166775707">(May 29 2019 at 01:27)</a>:</h4>
<p>I am currently working my way towards a revert of the <code>libsyntax</code> side</p>



<a name="166776541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166776541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166776541">(May 29 2019 at 01:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> okay I have a relatively clean revert of the AST changes, time to figure out (if I even can) what goes into the HIR side</p>



<a name="166777680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166777680" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166777680">(May 29 2019 at 02:19)</a>:</h4>
<p>hmmm how does all of this work for async closures? AFAICT they don't  get any extra capture-forcing shenanigans</p>



<a name="166777689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166777689" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166777689">(May 29 2019 at 02:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> is it accidental that async closures don't have the same drop order for their arguments as <code>async fn</code>s?</p>



<a name="166784852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166784852" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166784852">(May 29 2019 at 05:21)</a>:</h4>
<p>I don’t think we looked into async closures at all. </p>
<p>I think that an async closure would match the equivalent closure because the equivalent closure wouldn’t have captured the unused locals either so the drop order would be the same.</p>
<p>It was only because <code>async fn</code> looked like a function that we wanted to capture all the arguments and have the drop order match an <code>fn</code>, I don’t think the same would apply to async closures. </p>
<p>It’s early here and I’ve just started thinking, so I could be wrong.</p>



<a name="166832312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832312" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832312">(May 29 2019 at 16:31)</a>:</h4>
<p>not captures, but arguments - i.e. the <code>a</code>, <code>b</code>, <code>c</code> in <code>async |a, b, c|</code></p>



<a name="166832361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832361" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832361">(May 29 2019 at 16:31)</a>:</h4>
<p>if there are no captures, closures and functions should behave the same (cc <span class="user-mention" data-user-id="127859">@Taylor Cramer</span>)</p>



<a name="166832449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832449" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832449">(May 29 2019 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I have to finish some other stuff, but if you want to have a stab at this: <a href="https://github.com/rust-lang/rust/pull/61276/commits/029ba3b27efdf67b9968be1f27be7a2e881d491c#diff-64b696b0ef6ad44140e973801ed82b25R3016" target="_blank" title="https://github.com/rust-lang/rust/pull/61276/commits/029ba3b27efdf67b9968be1f27be7a2e881d491c#diff-64b696b0ef6ad44140e973801ed82b25R3016">https://github.com/rust-lang/rust/pull/61276/commits/029ba3b27efdf67b9968be1f27be7a2e881d491c#diff-64b696b0ef6ad44140e973801ed82b25R3016</a></p>



<a name="166832501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832501" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832501">(May 29 2019 at 16:33)</a>:</h4>
<p>I moved things around so you get to make both the arguments and expression, yourself, with <code>lower_body</code></p>



<a name="166832533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832533" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832533">(May 29 2019 at 16:33)</a>:</h4>
<p>right now I basically reverted most of the relevant changes, so the tests you added don't pass anymore</p>



<a name="166832538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832538" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832538">(May 29 2019 at 16:33)</a>:</h4>
<p>I just got the email from GitHub, I’ll take a look.</p>



<a name="166832701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832701" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832701">(May 29 2019 at 16:35)</a>:</h4>
<p><code>arguments</code> would need to become the <code>__arg0</code> etc. and then the original arguments would go into the <code>let</code>s that would be prepended to the body</p>



<a name="166832745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832745" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832745">(May 29 2019 at 16:36)</a>:</h4>
<p>Great, thanks.</p>



<a name="166832813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832813" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832813">(May 29 2019 at 16:36)</a>:</h4>
<p>everything should fit nicely into that one function</p>



<a name="166832824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832824" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832824">(May 29 2019 at 16:36)</a>:</h4>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="166832851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832851" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832851">(May 29 2019 at 16:37)</a>:</h4>
<p>also I expect that <code>ArgSource</code> would need to be drastically changed, or at least the <code>P&lt;Pat&gt;</code> be replaced with a <code>HirId</code></p>



<a name="166832879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832879">(May 29 2019 at 16:37)</a>:</h4>
<p>as it stands, you're cloning the AST, which is a big nono</p>



<a name="166832903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832903" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832903">(May 29 2019 at 16:37)</a>:</h4>
<p>patterns can contain types which can contain expressions which can contain blocks, which can contain items</p>



<a name="166832972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166832972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166832972">(May 29 2019 at 16:38)</a>:</h4>
<p>cloning items is pretty bad, even if nobody casually stashes an entire module in a pattern</p>



<a name="166833003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833003" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833003">(May 29 2019 at 16:38)</a>:</h4>
<p>Alright, I’ll make sure to do that.</p>



<a name="166833031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833031" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833031">(May 29 2019 at 16:39)</a>:</h4>
<p>(yes, macros can do it, but the compiler shouldn't)</p>



<a name="166833117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833117" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833117">(May 29 2019 at 16:39)</a>:</h4>
<p>anyway, I'm sorry it took me this long, and that I didn't finish the important part, but all of this stuff is doing my head in</p>



<a name="166833209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833209" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833209">(May 29 2019 at 16:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> do you want a rebase, btw?</p>



<a name="166833228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833228" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833228">(May 29 2019 at 16:40)</a>:</h4>
<p>before you start messing with this</p>



<a name="166833272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833272" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833272">(May 29 2019 at 16:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <span class="user-mention" data-user-id="119009">@eddyb</span> async closures aren't being considered for stabilization right now</p>



<a name="166833285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833285" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833285">(May 29 2019 at 16:41)</a>:</h4>
<p>they're really broken</p>



<a name="166833288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833288">(May 29 2019 at 16:41)</a>:</h4>
<p>ah I see</p>



<a name="166833297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833297">(May 29 2019 at 16:41)</a>:</h4>
<blockquote>
<p>anyway, I'm sorry it took me this long, and that I didn't finish the important part, but all of this stuff is doing my head in </p>
</blockquote>
<p>No, no, I appreciate you putting the time in to help tidy this up. </p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> do you want a rebase, btw?</p>
</blockquote>
<p>I can handle that if you want to get onto something else.</p>



<a name="166833310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833310" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833310">(May 29 2019 at 16:41)</a>:</h4>
<p>because you need to be able to borrow from captures in the return future</p>



<a name="166833314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833314" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833314">(May 29 2019 at 16:41)</a>:</h4>
<p>but you cannot today</p>



<a name="166833339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833339" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833339">(May 29 2019 at 16:41)</a>:</h4>
<p>I have this in a different worktree so I can just rebase it while I do other stuff</p>



<a name="166833461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833461" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833461">(May 29 2019 at 16:42)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> you mean like <code>fn call(&amp;'a self) -&gt; Something&lt;'a&gt;</code>? similar to the streaming iterator problem?</p>



<a name="166833650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833650" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833650">(May 29 2019 at 16:44)</a>:</h4>
<p>because by-ref captures don't run into that, I'm pretty sure <code>|| &amp;foo</code> works and it basically just copies the captured reference (but <code>move || &amp;foo</code> doesn't work)</p>



<a name="166833838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833838" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833838">(May 29 2019 at 16:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> oh wow the conflict was with my own small s/TraitOrImpl/Assoc PR which I made <em>because</em> I saw that while I was working on this PR</p>



<a name="166833901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166833901" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166833901">(May 29 2019 at 16:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> pushed, I'll let you know if the build fails and I have to fix anything</p>



<a name="166834306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166834306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166834306">(May 29 2019 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> that doesn't work if e.g. the argument to the closure is a reference, and you want the return type to depend on the lifetime of the reference (which is always the case with async closures that take a reference arg)</p>



<a name="166834843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166834843" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166834843">(May 29 2019 at 16:57)</a>:</h4>
<p>you mean, like, <code>|a| &amp;*a</code>?</p>



<a name="166834868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166834868" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166834868">(May 29 2019 at 16:57)</a>:</h4>
<p>this... should work just as well with references as it does with functions - only captures have it worse</p>



<a name="166834936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166834936" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166834936">(May 29 2019 at 16:58)</a>:</h4>
<p>or are you referring to the inference of the return type, because you don't have the explicit signature?</p>



<a name="166835368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166835368" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166835368">(May 29 2019 at 17:02)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> there isn't a way to write the bound for that closure return type so that it allows it to return a type implementing Future that is dependent upon the HRTB input lifetime</p>



<a name="166835518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166835518" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166835518">(May 29 2019 at 17:04)</a>:</h4>
<p>you mean like <code>for&lt;'a&gt; |x: &amp;'a T| -&gt; impl Future&lt;Output = Foo&lt;'a&gt;&gt;</code>?</p>



<a name="166835541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166835541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166835541">(May 29 2019 at 17:04)</a>:</h4>
<p>both <code>for&lt;...&gt;</code> and <code>-&gt; impl Trait</code> are missing for closures, right?</p>



<a name="166835683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166835683" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166835683">(May 29 2019 at 17:06)</a>:</h4>
<p>ooooh by bound you mean a function can't take such a closure</p>



<a name="166835762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166835762" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166835762">(May 29 2019 at 17:07)</a>:</h4>
<p>because <code>F: for&lt;'a&gt; FnOnce(&amp;'a T) -&gt; X&lt;'a&gt;</code> requires HKT</p>



<a name="166835883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166835883" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166835883">(May 29 2019 at 17:08)</a>:</h4>
<p>and while <code>F: for&lt;'a&gt; FnOnce&lt;(&amp;'a T,)&gt;, for&lt;'a&gt; &lt;F as FnOnce&lt;(&amp;'a T,)&gt;&gt;::Output: Future&lt;Output = Foo&lt;'a&gt;&gt;</code> <em>might</em> work, it's unstable</p>



<a name="166836008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166836008" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166836008">(May 29 2019 at 17:10)</a>:</h4>
<p>this problem is not limited to closures, if you wanted a function generic over an <code>async fn</code>, you'd run into  the same issue</p>



<a name="166872226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166872226" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nemo157 <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166872226">(May 30 2019 at 01:26)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> the common case is <code>for&lt;'a&gt; |x: &amp;'a T| -&gt; impl Future&lt;Output = Foo&gt; + 'a</code>, where the future borrows from the arguments but the resulting value doesn’t</p>



<a name="166872233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166872233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nemo157 <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166872233">(May 30 2019 at 01:26)</a>:</h4>
<p>But presumably your case could exist as well</p>



<a name="166872317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166872317" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166872317">(May 30 2019 at 01:28)</a>:</h4>
<p>I see, that still requires <code>-&gt; X&lt;'a&gt;</code> it's just that <code>&lt;X&lt;'a&gt; as Future&gt;::Output</code> doesn't contain <code>'a</code></p>



<a name="166872330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166872330" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166872330">(May 30 2019 at 01:29)</a>:</h4>
<p>so with the <code>Fn(...) -&gt; ...</code> sugar, it would seem to require HKT</p>



<a name="166872337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/166872337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#166872337">(May 30 2019 at 01:29)</a>:</h4>
<p>(this feels more and more offtopic, whoooops)</p>



<a name="167021273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167021273" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167021273">(May 31 2019 at 18:27)</a>:</h4>
<p>FYI <span class="user-mention" data-user-id="119009">@eddyb</span>, I started working on this today and I'm making decent progress. </p>
<p>I think it might make more sense if you backed out the async changes from your current PR and then I'll open one soon (hopefully today/tomorrow) that is based on your PR and still has your commit w/ the async reverts.</p>



<a name="167034353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167034353" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167034353">(May 31 2019 at 21:04)</a>:</h4>
<p>Submitted <a href="https://github.com/rust-lang/rust/issues/61413" target="_blank" title="https://github.com/rust-lang/rust/issues/61413">#61413</a> with what I have <span class="user-mention" data-user-id="119009">@eddyb</span>.</p>



<a name="167060971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167060971" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167060971">(Jun 01 2019 at 07:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> okay I'll do just that! :D</p>



<a name="167076270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167076270" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167076270">(Jun 01 2019 at 15:12)</a>:</h4>
<p>oops, I got side-tracked by mangling stuff and forgot</p>



<a name="167082807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082807" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082807">(Jun 01 2019 at 17:53)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I rebased my PR and r=@<strong>Vadim Petrochenkov</strong>'d it, and I'm now reviewing your PR</p>



<a name="167082808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082808" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082808">(Jun 01 2019 at 17:53)</a>:</h4>
<p>the good news is that <code>ArgSource</code> might be almost unnecessary!</p>



<a name="167082865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082865" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082865">(Jun 01 2019 at 17:54)</a>:</h4>
<p>scratch that, rustdoc does the same thing everyone else does</p>



<a name="167082872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082872" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082872">(Jun 01 2019 at 17:55)</a>:</h4>
<p>so all you need to do is use the same name as the original pattern, if it's a simple name</p>



<a name="167082885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082885" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082885">(Jun 01 2019 at 17:55)</a>:</h4>
<p>I think we already do that.</p>



<a name="167082889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082889" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082889">(Jun 01 2019 at 17:55)</a>:</h4>
<p>Unless I misunderstand what you mean.</p>



<a name="167082891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082891" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082891">(Jun 01 2019 at 17:55)</a>:</h4>
<p>I mean the __arg0 thing</p>



<a name="167082937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082937" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082937">(Jun 01 2019 at 17:56)</a>:</h4>
<p>Yeah. We don’t change it to <code>__arg0</code> if it is a simple binding (not incl ref bindings).</p>



<a name="167082946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082946">(Jun 01 2019 at 17:56)</a>:</h4>
<p>so then you don't need all of that stuff to get the original pattern</p>



<a name="167082964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082964" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082964">(Jun 01 2019 at 17:57)</a>:</h4>
<p>actually, this is HIR lowering, you don't even need <code>__arg0</code>, you could probably just leave it <code>sym::invalid</code> or w/e</p>



<a name="167082967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167082967" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167082967">(Jun 01 2019 at 17:57)</a>:</h4>
<p>actually I don't know nowadays what it is</p>



<a name="167083014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083014" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083014">(Jun 01 2019 at 17:58)</a>:</h4>
<p>I had introduced <code>ArgSource</code> before we started keeping the names the same so I’ll give that a shot.</p>



<a name="167083050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083050" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083050">(Jun 01 2019 at 17:59)</a>:</h4>
<p>do you need <a href="https://github.com/rust-lang/rust/pull/61413/commits/b91cfd9ceda9b580ccfa8a712817c3b7b3f60721#diff-64b696b0ef6ad44140e973801ed82b25R3090" target="_blank" title="https://github.com/rust-lang/rust/pull/61413/commits/b91cfd9ceda9b580ccfa8a712817c3b7b3f60721#diff-64b696b0ef6ad44140e973801ed82b25R3090">https://github.com/rust-lang/rust/pull/61413/commits/b91cfd9ceda9b580ccfa8a712817c3b7b3f60721#diff-64b696b0ef6ad44140e973801ed82b25R3090</a>?</p>



<a name="167083105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083105" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083105">(Jun 01 2019 at 18:00)</a>:</h4>
<p>seems like at least parts of that might be methods on <code>this</code></p>



<a name="167083134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083134" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083134">(Jun 01 2019 at 18:01)</a>:</h4>
<p>(maybe I should also look at how <code>LocalSource</code> is used, it could be similar)</p>



<a name="167083143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083143">(Jun 01 2019 at 18:01)</a>:</h4>
<p>If I didn’t pass it in then I’d get borrow checking errors for uses of <code>this</code> within the closure when it was captured.</p>



<a name="167083206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083206" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083206">(Jun 01 2019 at 18:02)</a>:</h4>
<p>no, I mean, creating HIR by hand like that</p>



<a name="167083220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083220" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083220">(Jun 01 2019 at 18:03)</a>:</h4>
<p>instead of <code>this.foo_bar(...)</code> of which there are dozens of helper methods :P</p>



<a name="167083228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083228" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083228">(Jun 01 2019 at 18:03)</a>:</h4>
<p>I wasn’t aware there were any. I’ll take a look in that case.</p>



<a name="167083233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083233">(Jun 01 2019 at 18:03)</a>:</h4>
<p>look at the other desugarings, like <code>for</code> loops or <code>?</code></p>



<a name="167083281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083281" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083281">(Jun 01 2019 at 18:04)</a>:</h4>
<p>you might want to also copy how they document each part</p>



<a name="167083286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083286" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083286">(Jun 01 2019 at 18:04)</a>:</h4>
<p>and generally the style (sorry I didn't mention them earlier)</p>



<a name="167083288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083288">(Jun 01 2019 at 18:05)</a>:</h4>
<p>anyway this looks great and pretty self-contained!</p>



<a name="167083303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083303" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083303">(Jun 01 2019 at 18:05)</a>:</h4>
<p>That’s fine, I should have noticed them, I’ll have almost certainly looked at those functions during this.</p>



<a name="167083310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083310" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083310">(Jun 01 2019 at 18:05)</a>:</h4>
<p>oh and you can rebase --onto the current state of my PR, if you want to</p>



<a name="167083314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167083314" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167083314">(Jun 01 2019 at 18:06)</a>:</h4>
<p>Will do, thanks.</p>



<a name="167127271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167127271" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167127271">(Jun 02 2019 at 15:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> my PR got merged btw</p>



<a name="167127282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167127282" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167127282">(Jun 02 2019 at 15:51)</a>:</h4>
<p>I saw, just rebased, then will address the feedback and update my PR.</p>



<a name="167127292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167127292" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167127292">(Jun 02 2019 at 15:51)</a>:</h4>
<p>I should not forget to clean up visit_fn in rustc_resolve</p>



<a name="167127338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167127338" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167127338">(Jun 02 2019 at 15:52)</a>:</h4>
<p>basically the caller should be pushing (Assoc)ItemRibKind</p>



<a name="167127414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167127414" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167127414">(Jun 02 2019 at 15:55)</a>:</h4>
<p>although the closure case is annoying, I think we should actually always push a NormalRibKind (i.e. a block-like scope) for the argument bindings since even for item fn's there are things between the item scope and the argument scope (generics and the signaure)</p>



<a name="167127507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167127507" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167127507">(Jun 02 2019 at 15:58)</a>:</h4>
<p><span class="user-mention" data-user-id="121053">@varkor</span>  might like this: if Foo&lt;T, N&gt; starts working (without an anon const expr in the AST), we don't want x: Foo&lt;T, x&gt; to see the name x at all</p>



<a name="167137402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167137402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167137402">(Jun 02 2019 at 20:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> are there diagnostic uses of <code>{Arg,Local}Source</code> left?</p>



<a name="167139821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167139821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167139821">(Jun 02 2019 at 21:42)</a>:</h4>
<p>Not that I’m aware of, no.</p>



<a name="167173052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173052" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173052">(Jun 03 2019 at 09:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> so can they be fully removed?</p>



<a name="167173073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173073" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173073">(Jun 03 2019 at 09:57)</a>:</h4>
<p>I thought it might make sense to keep some breadcrumbs that it was introduced by a desugaring.</p>



<a name="167173078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173078" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173078">(Jun 03 2019 at 09:57)</a>:</h4>
<p>Though I suppose the spans might do that.</p>



<a name="167173080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173080" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173080">(Jun 03 2019 at 09:57)</a>:</h4>
<p>the expansion span already records that</p>



<a name="167173081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173081" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173081">(Jun 03 2019 at 09:57)</a>:</h4>
<p>heh</p>



<a name="167173230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173230" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173230">(Jun 03 2019 at 10:00)</a>:</h4>
<p>I'll remove them in a moment.</p>



<a name="167173275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167173275" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167173275">(Jun 03 2019 at 10:00)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Should the <code>LocalSource</code> variant remain since <code>LocalSource</code> already existed?</p>



<a name="167174280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167174280" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167174280">(Jun 03 2019 at 10:16)</a>:</h4>
<p>I guess that's fine</p>



<a name="167174337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%2354716%20drop%20order/near/167174337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/187312-wg-async-foundations/topic/.2354716.20drop.20order.html#167174337">(Jun 03 2019 at 10:16)</a>:</h4>
<p>assuming things do check for <code>Normal</code> and suppress some diagnostics etc.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>