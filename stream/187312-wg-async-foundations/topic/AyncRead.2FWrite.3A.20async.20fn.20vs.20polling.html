<html>
<head><meta charset="utf-8"><title>AyncRead/Write: async fn vs polling · wg-async-foundations · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/index.html">wg-async-foundations</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html">AyncRead/Write: async fn vs polling</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268291972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268291972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268291972">(Jan 17 2022 at 16:32)</a>:</h4>
<p>I remember there being some discussion of having <code>async fn read</code> vs <code>fn poll_read</code> (for Read and likewise for Write traits), but I can't find it now. Does anyone have a link? And more generally, does anyone have thoughts on this question?</p>



<a name="268291991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268291991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268291991">(Jan 17 2022 at 16:33)</a>:</h4>
<p>Thoughts beyond <code>async fn</code> being obviously nicer, but dependent on async traits being implemented</p>



<a name="268293855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268293855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268293855">(Jan 17 2022 at 16:53)</a>:</h4>
<p>Is the idea that <code>poll_read</code> would let us have <code>AsyncRead</code>/<code>Write</code> without waiting for <code>async fn</code> in traits?</p>



<a name="268294424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268294424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268294424">(Jan 17 2022 at 16:58)</a>:</h4>
<p>Yeah, the current traits in <a href="http://futures.io">futures.io</a> and Tokio both have the polling versions</p>



<a name="268294516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268294516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268294516">(Jan 17 2022 at 16:59)</a>:</h4>
<p>I seem to remember there is a performance advantage too, though I can't remember the details. Something about multiple calls or multiple layers of delegation avoiding multiple initialisation costs?</p>



<a name="268299248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268299248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268299248">(Jan 17 2022 at 17:50)</a>:</h4>
<p>I mentioned that</p>



<a name="268299276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268299276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268299276">(Jan 17 2022 at 17:51)</a>:</h4>
<p>That only applies if read returns a boxed future</p>



<a name="268299501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268299501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268299501">(Jan 17 2022 at 17:53)</a>:</h4>
<p>It could work with 'inline' async traits</p>



<a name="268299777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268299777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268299777">(Jan 17 2022 at 17:57)</a>:</h4>
<p>There's some design notes here: <a href="https://rust-lang.github.io/wg-async-foundations/vision/roadmap/portable/read_write.html">https://rust-lang.github.io/wg-async-foundations/vision/roadmap/portable/read_write.html</a></p>



<a name="268301504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268301504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268301504">(Jan 17 2022 at 18:15)</a>:</h4>
<p>Right, so I guess that depends on the eventual design of async in dyn Trait</p>



<a name="268301690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268301690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268301690">(Jan 17 2022 at 18:18)</a>:</h4>
<p>But the downside is that if you have &amp;dyn Read, then the async fn requires boxing of the returned future but the poll_read version does not, and for vectored reads or just where you need to do multiple reads, that might add up to a lot of boxing overhead</p>



<a name="268301947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268301947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268301947">(Jan 17 2022 at 18:21)</a>:</h4>
<p>The idea of an inline async trait is that the future is stored in the trait object</p>



<a name="268301956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268301956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268301956">(Jan 17 2022 at 18:21)</a>:</h4>
<p>So no need to box</p>



<a name="268302673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268302673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268302673">(Jan 17 2022 at 18:30)</a>:</h4>
<p>Right <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="268303151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303151">(Jan 17 2022 at 18:36)</a>:</h4>
<p>To me the "Permitting simultaneous reads/writes" problem seems more important than the problems about boxing.</p>



<a name="268303353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303353">(Jan 17 2022 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> This is also an issue of usability. It's much easier to write an async function than something returning Poll. Using async fn helps work towards a world of "if you're not writing an async framework, you never need to deal with Poll directly".</p>



<a name="268303439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303439">(Jan 17 2022 at 18:39)</a>:</h4>
<p>Yeah, totally agree, that’s what I meant by nicer</p>



<a name="268303575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303575">(Jan 17 2022 at 18:41)</a>:</h4>
<p><span class="user-mention" data-user-id="218683">@Alice Ryhl</span> I thought that is mostly orthogonal to poll vs async fns? Is there a connection?</p>



<a name="268303677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303677">(Jan 17 2022 at 18:42)</a>:</h4>
<p>Well, if the async fn borrows the IO resource mutably, then stuff like <a href="https://docs.rs/tokio/latest/tokio/io/fn.split.html"><code>tokio::io::split</code></a> can't be implemented for the async fn version.</p>



<a name="268303790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303790">(Jan 17 2022 at 18:44)</a>:</h4>
<p>I would expect there to be implementations that need to borrow the resource mutably in order to function. A buffer, for instance. How would you split the read and write impls backed by a Vec?</p>



<a name="268303892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303892">(Jan 17 2022 at 18:45)</a>:</h4>
<p>Well, point is that with poll fns, such a utility is no problem even if they mutably borrow the IO resource. You can just interleave the calls to poll_read and poll_write with a mutex or similar.</p>



<a name="268303904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268303904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268303904">(Jan 17 2022 at 18:45)</a>:</h4>
<p>Ah, I see</p>



<a name="268304030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304030">(Jan 17 2022 at 18:47)</a>:</h4>
<p>(You answered my question before I could finish typing it <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>️)</p>



<a name="268304227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304227">(Jan 17 2022 at 18:49)</a>:</h4>
<blockquote>
<p>Using async fn helps work towards a world of "if you're not writing an async framework, you never need to deal with Poll directly"</p>
</blockquote>
<p>Users would interact with an <code>async fn read</code>, but runtimes would provide the <code>fn poll_ready</code>.</p>



<a name="268304260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304260">(Jan 17 2022 at 18:49)</a>:</h4>
<p>Similar to how <code>Stream</code> has <code>poll_next</code> and <code>async fn next</code> (although the latter hasn't actually been added yet).</p>



<a name="268304630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304630">(Jan 17 2022 at 18:53)</a>:</h4>
<p>Without prejudicing the poll approach, I think there is overhead for users in the methods just exisiting, even if they don’t have to be used. And I would expect many users will want to impl ReadWrite, not just the runtimes</p>



<a name="268304759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304759">(Jan 17 2022 at 18:54)</a>:</h4>
<p>Yeah, creating wrapper streams/asyncio types is a common question, and the answer usually is "just add an inherent async fn".</p>



<a name="268304795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304795">(Jan 17 2022 at 18:55)</a>:</h4>
<p>Another question is how these traits interact with io-uring.</p>



<a name="268304902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304902">(Jan 17 2022 at 18:56)</a>:</h4>
<p>Which requires that pointers to a buffer are stable.</p>



<a name="268304940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268304940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268304940">(Jan 17 2022 at 18:56)</a>:</h4>
<p>That is indeed another question! One question at a time though - I think this one and simultaneous read/write are enough to. E going on with <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="268307276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268307276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268307276">(Jan 17 2022 at 19:21)</a>:</h4>
<p>The more I see comparisons of io_uring and async, the more I wonder if io_uring would do best in an environment that doesn't look quite like our async underneath. Less poll, more notify.</p>



<a name="268307658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268307658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268307658">(Jan 17 2022 at 19:25)</a>:</h4>
<p>I feel like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">AsyncSplit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">ReadHalf</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span>: <span class="nc">AsyncRead</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">WriteHalf</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span>: <span class="nc">AsyncWrite</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">split</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="bp">Self</span>::<span class="n">ReadHalf</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">WriteHalf</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Is the best API for permitting simultaneous read/writes.</p>



<a name="268307760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268307760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268307760">(Jan 17 2022 at 19:26)</a>:</h4>
<p>Standardizing <code>&amp;T: AsyncRead</code> could be a footgun for types that only permit a single concurrent reader/writer (<code>tokio::TcpStream</code>).</p>



<a name="268307797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268307797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268307797">(Jan 17 2022 at 19:27)</a>:</h4>
<p>The readiness API doesn't work really at all for io-uring.</p>



<a name="268307877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268307877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268307877">(Jan 17 2022 at 19:28)</a>:</h4>
<p>And this way, types that don't support concurrent I/O (like <code>Vec</code>) simply don't implement the split trait.</p>



<a name="268308038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268308038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268308038">(Jan 17 2022 at 19:30)</a>:</h4>
<p>I think the main question would be how to support borrowed/owned versions of halves.</p>



<a name="268308229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268308229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268308229">(Jan 17 2022 at 19:32)</a>:</h4>
<p>Maybe the borrowed form is not useful enough to be included, or maybe it would need to look more like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">AsyncSplit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_split</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="bp">Self</span>::<span class="n">ReadHalf</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">WriteHalf</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">into_split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="bp">Self</span>::<span class="n">OwnedReadHalf</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">OwnedWriteHalf</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268311873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268311873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268311873">(Jan 17 2022 at 20:17)</a>:</h4>
<p>I'll mention that yield closures make poll functions really easy to implement. Although it would help to have some syntax sugar around Pin projection and an await macro.</p>



<a name="268314658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268314658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268314658">(Jan 17 2022 at 20:58)</a>:</h4>
<p>Here is an example I just threw together if anyone is curious: <a href="https://gitlab.com/-/snippets/2237073">https://gitlab.com/-/snippets/2237073</a></p>



<a name="268315972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268315972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268315972">(Jan 17 2022 at 21:16)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/89780"><code>.ready()?</code></a> is essentially <code>.await</code> for poll methods.</p>



<a name="268317845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268317845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268317845">(Jan 17 2022 at 21:47)</a>:</h4>
<p>I'm this context I'm using <code>$x.await!($y)</code> as a shorthand for roughly</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="cp">$x</span><span class="p">(</span><span class="cp">$y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">yield</span><span class="w"> </span><span class="n">Pending</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Ready</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which isn't quite possible with the try syntax alone.</p>



<a name="268317964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268317964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268317964">(Jan 17 2022 at 21:49)</a>:</h4>
<p>I also have an example of yield closures being used with async drop to do io-uring stuff, but I don't know if I really finished it.</p>



<a name="268318187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268318187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268318187">(Jan 17 2022 at 21:52)</a>:</h4>
<p>My base64 example is a little artificial, but I like how it highlights the difficulties of maintaining state between <code>read</code> calls, which I think is a pretty common case for AsyncRead.</p>



<a name="268318231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268318231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268318231">(Jan 17 2022 at 21:52)</a>:</h4>
<p>Yield closures are nice for that versus having an async function which starts from scratch each call. But it all just needs to kind of get played around with.</p>



<a name="268318616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268318616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268318616">(Jan 17 2022 at 21:58)</a>:</h4>
<p>It'd be really nice to have some sort of yield method semantics, where the generator state transform gets run on the impl'd type itself. But I don't really know how that would interact with the usual separation of type and impl.</p>



<a name="268329154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268329154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268329154">(Jan 18 2022 at 00:39)</a>:</h4>
<p>I like the idea of having a dedicated trait or traits for splitting, so that some things don't have to implement it if it doesn't make sense.</p>



<a name="268368655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268368655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268368655">(Jan 18 2022 at 10:07)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> could you expand on "Standardizing &amp;T: AsyncRead could be a footgun for types that only permit a single concurrent reader/writer (tokio::TcpStream)." please? I would expect you simply would not implement AsyncRead for &amp;TcpStream. Are you saying you want to permit simultaneous read and write but not simultaneous read?</p>



<a name="268368875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268368875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268368875">(Jan 18 2022 at 10:09)</a>:</h4>
<p>My current preference is to implement AsyncRead/AsyncWrite for &amp; types. That follows the sync libs most closely and is simplest (no new traits, etc). I'm keen to understand any problems with that approach (and in particular why the trade off is different for the async case vs the existing sync code).</p>



<a name="268372157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268372157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268372157">(Jan 18 2022 at 10:40)</a>:</h4>
<p>Well, the reason Tokio doesn't implement AsyncRead/AsyncWrite for <code>&amp;TcpStream</code> and friends is that this is incompatible with a poll-based trait.</p>



<a name="268372248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268372248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268372248">(Jan 18 2022 at 10:41)</a>:</h4>
<p>Because you generally only wake the waker from the most recent poll call, but if multiple tasks are making such calls, then you can't tell the difference between multiple poll calls from within one task, and multiple poll calls from different tasks</p>



<a name="268376685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268376685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268376685">(Jan 18 2022 at 11:23)</a>:</h4>
<p>So you don't want multiple readers because it could lead to unfair scheduling of the tasks which are reading? But since read and write are different, the wakers can be differentiated? Or scheduling is not  a problem in practice?</p>



<a name="268376841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268376841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268376841">(Jan 18 2022 at 11:25)</a>:</h4>
<p>Is that still a problem with async fns? It seems like it ought to be?</p>



<a name="268378313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268378313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268378313">(Jan 18 2022 at 11:40)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> in you split trait, what are the GAT lifetimes for? And why is the result of Split a tuple of values? What are the concrete types which get returned? How would it be implemented?</p>



<a name="268378532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268378532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268378532">(Jan 18 2022 at 11:43)</a>:</h4>
<p>(My experiment essentially requires the same backing code as impls on &amp; refs, but the impl is on a wrapper type rather than a &amp; ref)</p>



<a name="268378879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268378879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268378879">(Jan 18 2022 at 11:47)</a>:</h4>
<p>(Ah, I see the GAT lifetime  is so that the wrapper types can keep a reference to self)</p>



<a name="268379290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268379290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268379290">(Jan 18 2022 at 11:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>FileReader&lt;&#39;a&gt;(&amp;&#39;a File);
FileWriter&lt;&#39;a&gt;(&amp;&#39;a File);

impl AsyncSplit for File {
    type ReadHalf&lt;&#39;a&gt; = FileReader&lt;&#39;a&gt;;
    type WriteHalf&lt;&#39;a&gt; = FileWriter&lt;&#39;a&gt;;

    fn split&lt;&#39;a&gt;(&amp;&#39;a mut self) -&gt; (FileReader&lt;&#39;a&gt;, FileWriter&lt;&#39;a&gt;) {
        (FileReader(self), FileWriter(self))
    }
}

impl&lt;&#39;a&gt; AsyncRead for FileReader&lt;&#39;a&gt; {
    async fn read(&amp;mut self, buf: &amp;mut BufRead) -&gt; Result&lt;()&gt; {
        self.0.async_read(buf)
    }
}

impl&lt;&#39;a&gt; AsyncWrite for FileWriter&lt;&#39;a&gt; {
    async fn write(&amp;mut self, buf: &amp;[u8]) -&gt; Result&lt;()&gt; {
        self.0.async_write(buf)
    }
}
</code></pre></div>



<a name="268381486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268381486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268381486">(Jan 18 2022 at 12:12)</a>:</h4>
<p>It's not about unfair scheduling, it's about some of the calls to <code>read</code> getting completely lost and never completing because their waker was ignored due to a later unrelated call to poll.</p>



<a name="268385297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268385297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268385297">(Jan 18 2022 at 12:46)</a>:</h4>
<p>Yes, as alice explained, some types support only a single concurrent reader and writer, because only one waker is stored and woken up per direction</p>



<a name="268385332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268385332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268385332">(Jan 18 2022 at 12:47)</a>:</h4>
<p>The reader and writer wakers are stored individually</p>



<a name="268385444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268385444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268385444">(Jan 18 2022 at 12:48)</a>:</h4>
<p>And yes, the GAT is to support wrapper types that implement AsyncRead/Write respectively (given we don't have the &amp;T impls)</p>



<a name="268385486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268385486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268385486">(Jan 18 2022 at 12:48)</a>:</h4>
<p><a href="https://docs.rs/tokio/latest/tokio/net/tcp/struct.ReadHalf.html">https://docs.rs/tokio/latest/tokio/net/tcp/struct.ReadHalf.html</a></p>



<a name="268387750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268387750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268387750">(Jan 18 2022 at 13:07)</a>:</h4>
<p>I see, thanks!</p>



<a name="268388137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268388137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268388137">(Jan 18 2022 at 13:10)</a>:</h4>
<p>So, is the waker a thing still a problem with the async fns rather than the poll functions? It seems like it should be if the waker is only identified by its task?</p>



<a name="268395481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268395481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268395481">(Jan 18 2022 at 14:10)</a>:</h4>
<p>No, it's only a problem with the poll functions.</p>



<a name="268395650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268395650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268395650">(Jan 18 2022 at 14:12)</a>:</h4>
<p>That's why a function like <code>async fn readable</code> is usually provided as well.</p>



<a name="268396005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268396005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268396005">(Jan 18 2022 at 14:14)</a>:</h4>
<p>Which gets it's own unique waker slot in a vec/map.</p>



<a name="268396037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268396037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268396037">(Jan 18 2022 at 14:14)</a>:</h4>
<p>I'm not sure if tokio does this, but I know smol does.</p>



<a name="268396160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268396160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268396160">(Jan 18 2022 at 14:15)</a>:</h4>
<p>Ah yeah, tokio does it with a linked list.</p>



<a name="268399156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268399156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268399156">(Jan 18 2022 at 14:35)</a>:</h4>
<p>So then the only issue with impls on references in a world with async fns is that there are some types for which we want simultaneous read/write but not multiple readers for logical reasons?</p>



<a name="268432787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268432787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268432787">(Jan 18 2022 at 18:08)</a>:</h4>
<p>I only skimmed, but <code>async fn read(....)</code> also requires reserving a buffer for every single in-flight read, which isn't really an option for high concurrency net servers.</p>



<a name="268433051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268433051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268433051">(Jan 18 2022 at 18:10)</a>:</h4>
<p>A sketch, but this would support concurrent read / write, avoid reserving buffers for in-flight read, and use <code>async fn</code>: <a href="https://gist.github.com/carllerche/5d7037bd55dac1cb72891529a4ff1540">https://gist.github.com/carllerche/5d7037bd55dac1cb72891529a4ff1540</a></p>



<a name="268433087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268433087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268433087">(Jan 18 2022 at 18:10)</a>:</h4>
<p><code>async fn read</code> and <code>async fn write</code> could included as methods w/ default impls and implemented in terms of ready &amp; try_read / try_write</p>



<a name="268435247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268435247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268435247">(Jan 18 2022 at 18:27)</a>:</h4>
<p>and that problem is real. i've spoken with engineers that cannot have 8kb allocated PER socket waiting for a read that might come eventually. they want to use a single buffer for whatever socket becomes ready</p>



<a name="268440516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268440516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268440516">(Jan 18 2022 at 19:08)</a>:</h4>
<p>Do we even need AsyncRead/AsyncWrite then? Rather than just Read/Write.</p>



<a name="268440944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268440944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268440944">(Jan 18 2022 at 19:10)</a>:</h4>
<p>I guess we could make things more ergonomic by making try_read/try_write async so that the WouldBlock case is handled internally, but in most cases the future would resolve immediately?</p>



<a name="268441119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268441119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268441119">(Jan 18 2022 at 19:12)</a>:</h4>
<p>It is possible we don't need AsyncRead / AsyncWrite, however, overloading Read / Write has historically not panned out well</p>



<a name="268441137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268441137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268441137">(Jan 18 2022 at 19:12)</a>:</h4>
<p>in this case though, the AsyncIo trait would provide the necessary trait bound</p>



<a name="268441519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268441519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268441519">(Jan 18 2022 at 19:15)</a>:</h4>
<p>I do think we need separate traits for AsyncRead/AsyncWrite rather than using Read/Write, because some types will have a <em>different</em> operation they need to do in the non-blocking case.</p>



<a name="268441599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268441599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268441599">(Jan 18 2022 at 19:16)</a>:</h4>
<p>But I'd love to have something like <code>smol::Async</code> in the standard library for the case where this is as simple as "put FD/handle into non-blocking mode, and expect it to select/epoll/etc as readable/writable when ready".</p>



<a name="268441778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268441778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268441778">(Jan 18 2022 at 19:17)</a>:</h4>
<p>The idea of providing a better abstraction over <em>just</em> the readiness operation seems potentially viable.</p>



<a name="268445802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268445802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268445802">(Jan 18 2022 at 19:49)</a>:</h4>
<p>That isn't compatible with io-uring.</p>



<a name="268496031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268496031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268496031">(Jan 19 2022 at 06:10)</a>:</h4>
<p>That abstraction doesn't need to be.</p>



<a name="268496041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268496041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268496041">(Jan 19 2022 at 06:10)</a>:</h4>
<p>It's a helper for the common case, not an obligate framework.</p>



<a name="268496080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268496080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268496080">(Jan 19 2022 at 06:11)</a>:</h4>
<p>(Also, I'm increasingly wondering if the right async for io_uring looks <em>completely</em> different and we should just build the right async for other things.)</p>



<a name="268516536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/268516536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#268516536">(Jan 19 2022 at 10:08)</a>:</h4>
<p>I'm also thinking there is no good one size fits all API. Not sure what the implications for that look like</p>



<a name="269126019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/269126019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#269126019">(Jan 24 2022 at 15:56)</a>:</h4>
<p>With sync read, a common pattern is to loop, calling <code>read</code> repeatedly until it returns 0 bytes  (i.e., reading is complete), filling a single buffer and processing the buffer at the end. Am I right that this doesn't happen so often in the async world? I.e., you want to process data as it arrives rather than buffer it and process when complete? Is there ever any need to follow that pattern (files vs network?). If one were using the readiness pattern for async IO traits, how would one use it to do such repeated reads (or check that the resource has nothing more to read)? I imagine you need to call Ready::ready each time, so presumably you'd need a pre-allocated or growable buffer?</p>



<a name="269126514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/269126514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#269126514">(Jan 24 2022 at 15:59)</a>:</h4>
<p>An HTTP server might repeatedly read into a couple kilobyte buffer and stream the rest</p>



<a name="269126757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/269126757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#269126757">(Jan 24 2022 at 16:00)</a>:</h4>
<p>Do you know how that would look using the AsyncIo trait proposal?</p>



<a name="269171369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/269171369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#269171369">(Jan 24 2022 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> I've definitely written the "read into buffer, handle partial reads, do something with buffer, repeat" loop in both sync and async code. That includes both "process whatever partial read I get" cases and "make sure I have enough data to process" cases (the latter for things like parsing).</p>



<a name="269171443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/AyncRead/Write%3A%20async%20fn%20vs%20polling/near/269171443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/AyncRead.2FWrite.3A.20async.20fn.20vs.20polling.html#269171443">(Jan 24 2022 at 20:55)</a>:</h4>
<p>For the latter case, I've done both "read a length, read_exact that many bytes" and "read into a buffer however many bytes I get, if I don't have enough to process, read more".</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>