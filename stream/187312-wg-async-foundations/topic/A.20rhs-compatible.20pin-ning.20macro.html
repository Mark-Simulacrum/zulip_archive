<html>
<head><meta charset="utf-8"><title>A rhs-compatible pin-ning macro · wg-async-foundations · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/index.html">wg-async-foundations</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html">A rhs-compatible pin-ning macro</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268731241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268731241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268731241">(Jan 20 2022 at 17:52)</a>:</h4>
<p>Heh, I've managed to write a pretty simple rhs-compatible (ergo-pin-ish) stack pinning macro, so that:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>Just Works™ (it just requires def-site hygiene and/or <code>decl_macro</code>)</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Context</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>It just occurred to me, from having recently been playing with both lifetime extension shenanigans (<a href="https://discord.com/channels/273534239310479360/592856094527848449/933773706575101983">https://discord.com/channels/273534239310479360/592856094527848449/933773706575101983</a>), as well as <code>def_site</code> hygiene shenanigans (<a href="#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin">https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin</a>), that with the latter we can polyfill what would otherwise have needed <code>unsafe fields</code> (by having only-macro-accessible fields), and yet, by virtue of being a macro, it doesn't change the fact that we end up using a literal struct expression, which thus enables lifetime extension to kick in.</p>
<p>That is, the naive <code>macro pin($e) { unsafe { Pin::new_unchecked(&amp;mut { $e }) }}</code> obviously doesn't work, but if instead of <code>Pin</code>, we were to be using a custom struct, then lifetime extension can kick in.</p>
<p>Hence the implementation:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(decl_macro)]</span><span class="w"> </span><span class="c1">// &lt;- we need hygiene for safety</span>

<span class="k">mod</span> <span class="nn">lib</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">StackPinned</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="c1">// &lt;- Private!</span>
<span class="w">        </span><span class="o">&amp;'</span><span class="na">frame</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">impl</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">StackPinned</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"></span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">as_mut</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="nc">mut</span><span class="w"> </span><span class="n">StackPinned</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Safety: the only public constructor</span>
<span class="w">                </span><span class="c1">// is the macro, which takes a</span>
<span class="w">                </span><span class="c1">// `&amp;mut`-lifetime-extended expression.</span>
<span class="w">                </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"></span>
<span class="w">    </span><span class="kr">macro</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$e</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">StackPinned</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">)}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8c5bc627f00e79cede0ae20cb27f8838">Playground</a></li>
</ul>
</div></div>



<a name="268739149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268739149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268739149">(Jan 20 2022 at 18:46)</a>:</h4>
<p>Regarding the "we need hygiene for safety" comment, doesn't macro_rules have hygiene on stable?</p>



<a name="268741699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268741699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268741699">(Jan 20 2022 at 19:04)</a>:</h4>
<p>Not for field names, I believe: a <code>macro_rules!</code> would have needed that <code>&amp;mut T</code> field to have been declared public</p>



<a name="268741872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268741872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268741872">(Jan 20 2022 at 19:06)</a>:</h4>
<p>Yep</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0451</span><span class="p">]</span>: <span class="nc">field</span><span class="w"> </span><span class="sc">'0'</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">struct</span> <span class="o">'</span><span class="na">StackPinned</span><span class="o">'</span> <span class="nc">is</span><span class="w"> </span><span class="n">private</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">25</span>:<span class="mi">36</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="cp">$crate</span>::<span class="n">lib</span>::<span class="n">StackPinned</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                    </span><span class="o">^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">field</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">43</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="nc">lib</span>::<span class="n">StackPinned</span><span class="o">&lt;</span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                                  </span><span class="o">-------------------</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">invocation</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
</code></pre></div>



<a name="268748528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268748528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268748528">(Jan 20 2022 at 19:57)</a>:</h4>
<p>ah, I see</p>



<a name="268755809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268755809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268755809">(Jan 20 2022 at 20:52)</a>:</h4>
<p>This is the best I've been able to do in stable Rust: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=b536f548e13de6de48c8ac0f81831b84">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=b536f548e13de6de48c8ac0f81831b84</a>. It's way less ergonomic since the <code>StackPinned</code> is then just a type-state proof and it needs to be <em>moved</em> into a <code>Pin</code> to activate that property (since without hygiene, callers have non-<code>unsafe</code> access to the fields, and thus they are free to <code>take()</code> the referee and whatnot):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pinnable</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">pin</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>At that point the current macro is better; the whole point of a rhs-macro was being able to pin and rename in one go</p>



<a name="268828255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268828255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268828255">(Jan 21 2022 at 11:20)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> are you sure this is sound? I may very well be missing something, but I don't believe the following should be allowed?:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8ae49b336e050b4e34a0e7ce94d9b466">playground</a></p>



<a name="268828333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268828333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268828333">(Jan 21 2022 at 11:21)</a>:</h4>
<p><code>pin!</code> doesn't actually appear to pin. And because <code>as_mut</code> takes <code>&amp;mut self</code> we could do:</p>
<ul>
<li>call <code>pin!</code></li>
<li>call <code>as_mut</code></li>
<li>call <code>mem::swap</code></li>
<li>call <code>as_mut</code> again</li>
<li>we now have undefined behavior</li>
</ul>



<a name="268828523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268828523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268828523">(Jan 21 2022 at 11:23)</a>:</h4>
<p>As I understand it "pin to the stack" and "get a <code>Pin&lt;&amp;mut T&gt;</code>" require being done in a single operation; otherwise we can mess with the intermediate type like I've shown ^ ?</p>



<a name="268828634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268828634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268828634">(Jan 21 2022 at 11:24)</a>:</h4>
<p>Well, does your code really swap the pinned elements, or do they just swap a struct with a reference to those pinned elements?</p>



<a name="268828908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268828908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268828908">(Jan 21 2022 at 11:27)</a>:</h4>
<p>Oh yeah, good point!</p>



<a name="268829052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268829052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268829052">(Jan 21 2022 at 11:28)</a>:</h4>
<p>Yeah, I think you're right that we're only swapping the references - and the actual pinning happens on the stack. Which I guess the name <code>StackPinned</code> might have given away <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="268829301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268829301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268829301">(Jan 21 2022 at 11:31)</a>:</h4>
<p>I think I did manage to do something cool? I believe we might be able to collapse <code>pin!</code> and <code>as_mut</code> into a single operation?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=5203838d76a17dd93d7cfc8d5fc89b1b">playground</a></p>



<a name="268837661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268837661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268837661">(Jan 21 2022 at 12:52)</a>:</h4>
<p>ahh, dang -- maybe false hope? If we do this, we end up with a bunch of compiler errors again:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268838486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268838486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268838486">(Jan 21 2022 at 13:00)</a>:</h4>
<p>Oh lmao, but this does?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268838942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268838942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268838942">(Jan 21 2022 at 13:02)</a>:</h4>
<p>Does anyone what the state of resolving <code>error[E0716]: temporary value dropped while borrowed</code> for cases like these is in the compiler? Am I right in assuming that this will require Polonius to be integrated first?</p>



<a name="268839288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268839288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268839288">(Jan 21 2022 at 13:06)</a>:</h4>
<p>Polonius wont solve it. The problem is that the destructor runs too early, but polonius does not change when destructors run.</p>



<a name="268839349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268839349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268839349">(Jan 21 2022 at 13:06)</a>:</h4>
<p>The reason that <code>dbg!(pin!(PhantomPinned))</code> works is that the value is dropped at the end of the expression, so as long as you stay within the expression, you're good.</p>



<a name="268839607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268839607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268839607">(Jan 21 2022 at 13:08)</a>:</h4>
<p>Thanks; yeah that makes a lot of sense</p>



<a name="268839770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268839770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268839770">(Jan 21 2022 at 13:10)</a>:</h4>
<p>I'm slowly coming to terms with the idea that <code>pin!/StackPinned/StackPinned::as_mut</code> might just be the best way we can make in-line pinning work for the foreseeable future.</p>



<a name="268839867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268839867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268839867">(Jan 21 2022 at 13:11)</a>:</h4>
<p>The construction also feels analogous to <code>Pin::new/Pin/Pin::as_mut</code>; so even if we need to introduce a few new types, the way it works is actually quite similar.</p>



<a name="268849502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268849502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268849502">(Jan 21 2022 at 14:27)</a>:</h4>
<p>Yeah, that was the objective. I've tried really hard to explore so many analogous variations —believe me, I've had some horrendously crazy stuff going on at some point— and at the end of the day, this implementation of <code>pin!</code>, involving <code>StackPinned!</code> and <code>as_mut!</code>, and the already existing <code>pin_mut!</code> macros are the best thing available out there.</p>
<p>That being said, if we were the core / standard library, we could cut the <code>StackPinned</code> middlecrap and use <code>Pin { pointer: &amp;mut { $e } }</code>, hence yielding a genuine <code>Pin&lt;&amp;mut _&gt;</code> type!</p>
<p>Hence my suggesting this macro <em>here</em>, rather than as a third-party crate: both the <code>def_site</code> and the required access to the private <code>pointer</code> field of <code>Pin</code> lead to this macro having to be featured by the stdlib</p>



<a name="268850434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268850434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268850434">(Jan 21 2022 at 14:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro/near/268849502">said</a>:</p>
<blockquote>
<p>That being said, if we were the core / standard library, we could cut the <code>StackPinned</code> middlecrap and use <code>Pin { pointer: &amp;mut { $e } }</code>, hence yielding a genuine <code>Pin&lt;&amp;mut _&gt;</code> type!</p>
</blockquote>
<p>ohhhhhh!</p>



<a name="268850470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268850470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268850470">(Jan 21 2022 at 14:35)</a>:</h4>
<p>yesssssss</p>



<a name="268865766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/A%20rhs-compatible%20pin-ning%20macro/near/268865766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro.html#268865766">(Jan 21 2022 at 16:21)</a>:</h4>
<p>this looks exciting :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>