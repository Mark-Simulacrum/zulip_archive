<html>
<head><meta charset="utf-8"><title>Which user story is this covered by? · wg-async-foundations · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/index.html">wg-async-foundations</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html">Which user story is this covered by?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260975119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975119">(Nov 10 2021 at 11:15)</a>:</h4>
<p>I've been running into a painful issue in async code lately, and I'm wondering if there's an existing user story that covers it, or if not, if there should be.</p>



<a name="260975172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975172">(Nov 10 2021 at 11:15)</a>:</h4>
<p>I'm trying to write an HTTP request handler that reads the body incrementally, and for each entry in the body, does some processing.</p>



<a name="260975247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975247">(Nov 10 2021 at 11:16)</a>:</h4>
<p>The incremental processing looks like <code>body.read_exact(&amp;mut buf).await?;</code>, which is a suspend point.</p>



<a name="260975309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975309">(Nov 10 2021 at 11:16)</a>:</h4>
<p>But doing the processing requires an object that can't be sent across threads (a <code>git2::Repository</code>).</p>



<a name="260975372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975372">(Nov 10 2021 at 11:17)</a>:</h4>
<p>I have such an object freshly created for <em>this</em> future to use, and no other future will use it, but it still isn't <code>Send</code> so that makes the future not <code>Send</code>.</p>



<a name="260975386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975386">(Nov 10 2021 at 11:17)</a>:</h4>
<p>And <code>tide</code> doesn't handle that (transparently or otherwise).</p>



<a name="260975528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975528">(Nov 10 2021 at 11:19)</a>:</h4>
<p>This feels like a "Rust frustration", in that while in general I understand what Rust is protecting me against, and I definitely want that protection, in this case it feels like there could theoretically be a more nuanced set of types that would allow this to work.</p>



<a name="260975574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975574">(Nov 10 2021 at 11:20)</a>:</h4>
<p>I'm not sure what that would look like, and I'm not sure what the <em>right</em> solution is here, but I'd love to know if there's a good user story for "frustration caused by non-Send types owned by a future".</p>



<a name="260975658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975658">(Nov 10 2021 at 11:20)</a>:</h4>
<p>Right now, my most likely fix to this code is to stop reading the body incrementally, read it all in advance, and then I don't hold non-Send types over a suspend point.</p>



<a name="260975674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260975674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260975674">(Nov 10 2021 at 11:20)</a>:</h4>
<p>But it seems like there should be a better way.</p>



<a name="260976340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260976340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260976340">(Nov 10 2021 at 11:27)</a>:</h4>
<p>If the type in question is not <code>Send</code>, then the two ways are reading it into memory first, and running it on a single-threaded runtime that supports non-Send futures.</p>



<a name="260976422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260976422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260976422">(Nov 10 2021 at 11:28)</a>:</h4>
<p>In some cases where I do need this to work incrementally, I run a background thread that owns the object, and communicate with it via a channel, actor-style.</p>



<a name="260976502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260976502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260976502">(Nov 10 2021 at 11:29)</a>:</h4>
<p>But also, thinking in broader terms, I'm wondering if in the ecosystem we need a way of expressing "you can only use this on one thread at once, but it doesn't have to keep being the <em>same</em> thread".</p>



<a name="260976612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260976612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260976612">(Nov 10 2021 at 11:30)</a>:</h4>
<p>(In other words, the solution-space can include "git2::Repository should have different properties/traits".)</p>



<a name="260980613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/260980613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#260980613">(Nov 10 2021 at 12:13)</a>:</h4>
<p>(For the specific case I encountered, the solution I ended up with was that <code>git2::Repository</code> is <code>Send</code>, but <code>git2::Odb</code> isn't, so I just get the <code>Odb</code> from the <code>Repository</code> each time.)</p>



<a name="261040057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261040057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261040057">(Nov 10 2021 at 19:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F/near/260976502">said</a>:</p>
<blockquote>
<p>But also, thinking in broader terms, I'm wondering if in the ecosystem we need a way of expressing "you can only use this on one thread at once, but it doesn't have to keep being the <em>same</em> thread".</p>
</blockquote>
<p>this is a sentiment expressed by... <span class="user-mention" data-user-id="256841">@Nick Cameron</span> (I think) at some point? Let me see if I can find the zulip thread</p>



<a name="261040179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261040179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261040179">(Nov 10 2021 at 19:17)</a>:</h4>
<p><a href="#narrow/stream/187312-wg-async-foundations/topic/Example.20of.20odd.20composing.20of.20Send">https://rust-lang.zulipchat.com/#narrow/stream/187312-wg-async-foundations/topic/Example.20of.20odd.20composing.20of.20Send</a></p>



<a name="261061441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261061441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261061441">(Nov 10 2021 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F/near/260976502">said</a>:</p>
<blockquote>
<p>But also, thinking in broader terms, I'm wondering if in the ecosystem we need a way of expressing "you can only use this on one thread at once, but it doesn't have to keep being the <em>same</em> thread".</p>
</blockquote>
<p>Does that mean that you can release an <code>Odb</code> within a different thread that whence it was created? If that's the case, and from skimming the API very quickly, it does look like the <code>Odb</code> ought to be <code>Send</code> and remain <code>!Sync</code>. And if the <code>!Sync</code> then still causes problem in your <code>Future</code>, you can soothe Rust by only accessing it through <code>&amp;mut</code>s, and thus wrapping it in a <a href="https://docs.rs/sync_wrapper/0.1.1/sync_wrapper/struct.SyncWrapper.html"><code>SyncWrapper</code></a></p>



<a name="261063020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261063020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261063020">(Nov 10 2021 at 22:15)</a>:</h4>
<p>If, on the other hand, the <code>Odb</code> is tied to a <code>Repo</code>sitory (which is <code>!Sync</code>) and acts as a shared handle to the latter, then, indeed, in Rust, <code>(Repo, Odb&lt;'slf&gt;)</code>, on top of being a self-referential entity, would not be <code>Send</code> even though the two together could be moved across thread boundaries. This just hints at the API potentially missing such a "bundle". It does look like there may be a need for an <code>OdbMut</code> unique handle to the <code>Repo</code>, which would thus be <code>Send</code></p>



<a name="261070406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261070406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261070406">(Nov 10 2021 at 23:18)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> I believe the internal libgit2 odb object is tied to a repo, yes.</p>



<a name="261070417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261070417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261070417">(Nov 10 2021 at 23:18)</a>:</h4>
<p>And in particular, you can always re-obtain the odb from the repo.</p>



<a name="261070452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261070452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261070452">(Nov 10 2021 at 23:19)</a>:</h4>
<p>However, I don't think you can release an odb that's owned by a repo.</p>



<a name="261070676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261070676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261070676">(Nov 10 2021 at 23:21)</a>:</h4>
<p>Oh, but hmmm...</p>



<a name="261070712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261070712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261070712">(Nov 10 2021 at 23:22)</a>:</h4>
<p>It looks like odb actually has internal locking these days, so it might even be <em>sync</em> now.</p>



<a name="261071717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261071717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261071717">(Nov 10 2021 at 23:32)</a>:</h4>
<p><a href="https://github.com/libgit2/libgit2/pull/6109">https://github.com/libgit2/libgit2/pull/6109</a> :)</p>



<a name="261075680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261075680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261075680">(Nov 11 2021 at 00:17)</a>:</h4>
<p>If you are using tide you can always call async_std::spawn_local(.....).await in the handler</p>



<a name="261128778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/Which%20user%20story%20is%20this%20covered%20by%3F/near/261128778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/Which.20user.20story.20is.20this.20covered.20by.3F.html#261128778">(Nov 11 2021 at 12:46)</a>:</h4>
<p>So, it seems there's different flavors of <code>spawn</code>s for different kinds of tasks...  <code>spawn</code> for most general ones, <code>spawn_local</code> for ones that cannot leave the thread that build them(!Send),  <code>spawn_blocking</code> for ones that need not be rescheduled (<code>Send</code>), and it seems the original assumption is that maybe a task that is gonna spawn a local(<code>!Send</code>) child  task needs to be spawned, and the child task need to resident on one of the executor worker threads...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>