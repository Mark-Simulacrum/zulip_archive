<html>
<head><meta charset="utf-8"><title>`pin!` · wg-async-foundations · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/index.html">wg-async-foundations</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html">`pin!`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251918148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/251918148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#251918148">(Sep 03 2021 at 17:48)</a>:</h4>
<p>Has there been any discussion of moving the <code>pin!</code> macro from pin-utils/futures/tokio to <code>std</code>? Macros are insta-stable, so can I open a PR or would an RFC be required first?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// core/src/pin.rs</span>

<span class="cp">#[macro_export]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$($x</span>:<span class="nc">ident</span><span class="p">),</span><span class="o">*</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$(</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="cp">$x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$x</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[allow(unused_mut)]</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="cp">$x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">core</span>::<span class="n">pin</span>::<span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="cp">$x</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251933732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/251933732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#251933732">(Sep 03 2021 at 19:54)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> There's been discussion, but there's also been a lot of discussion about making Pin less visible and less necessary to interact with, and I think we wouldn't want to introduce helpers for something that we end up de-emphasizing.</p>



<a name="251939694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/251939694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#251939694">(Sep 03 2021 at 20:45)</a>:</h4>
<p>Pin is still useful outside the async world, e.g. in cxx, and that's unlikely to change. I don't see why such a basic utility _wouldn't_ be in std.</p>



<a name="253112027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253112027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253112027">(Sep 13 2021 at 15:44)</a>:</h4>
<p>I think it'd be reasonable to include the macro</p>



<a name="253112066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253112066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253112066">(Sep 13 2021 at 15:45)</a>:</h4>
<p>though I think there's also room to bikeshed how it works</p>



<a name="253112090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253112090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253112090">(Sep 13 2021 at 15:45)</a>:</h4>
<p>e.g. I think I might prefer to do</p>



<a name="253112110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253112110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253112110">(Sep 13 2021 at 15:45)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[pin]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.;</span><span class="w"></span>
</code></pre></div>



<a name="253112182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253112182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253112182">(Sep 13 2021 at 15:45)</a>:</h4>
<p>Heh, that almost starts looking like pin-project</p>



<a name="253114362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253114362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253114362">(Sep 13 2021 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.60pin!.60/near/253112110">said</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[pin]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.;</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>this is dank, it makes it look more official than <code>pin!</code>, and its easier to read the code like you'd read non-async rust code</p>



<a name="253609866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253609866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253609866">(Sep 16 2021 at 16:30)</a>:</h4>
<p>is "dank" a good thing :)</p>



<a name="253610001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253610001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253610001">(Sep 16 2021 at 16:31)</a>:</h4>
<p>i think it is when its a meme</p>



<a name="253610080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253610080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253610080">(Sep 16 2021 at 16:31)</a>:</h4>
<p>oh sorry, yeah i forget that I use that word A LOT because california has rooted itself deep in my brain, for me, it always means "extremely good"</p>



<a name="253614773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/253614773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#253614773">(Sep 16 2021 at 17:02)</a>:</h4>
<p>/me realizes he's been misinterpreting things on the internet for a while now...</p>



<a name="254072290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254072290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254072290">(Sep 20 2021 at 15:52)</a>:</h4>
<p>what do folks think about <code>#[pin]</code>--- maybe we should prototype that on <a href="http://crates.io">crates.io</a>?</p>



<a name="254073604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254073604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254073604">(Sep 20 2021 at 16:00)</a>:</h4>
<p>I kind of like it. I think seeing a prototype would be good.</p>



<a name="254103074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254103074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254103074">(Sep 20 2021 at 19:17)</a>:</h4>
<p>I think it would be fine to just try it one project which currently uses <code>pin!</code>. If it works then it will work too. Syntax-wise all options are fine to me, and having it in <code>core</code> makes sense</p>



<a name="254106065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254106065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254106065">(Sep 20 2021 at 19:40)</a>:</h4>
<p>I can write up the macro and open a PR to pin-utils.</p>



<a name="254106094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254106094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254106094">(Sep 20 2021 at 19:41)</a>:</h4>
<p>I personally really like the proc-macro syntax.</p>



<a name="254106571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254106571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254106571">(Sep 20 2021 at 19:44)</a>:</h4>
<blockquote>
<p>Because assigning to a variable followed by pinning is common, there is also a variant of the macro that supports doing both in one go.</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="p">{</span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="p">};</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">my_async_fn</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// async logic here</span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[tokio::main]</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pin</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">future1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_async_fn</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">future2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_async_fn</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">select</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">future1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">future2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="254106610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254106610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254106610">(Sep 20 2021 at 19:44)</a>:</h4>
<p>Tokio already provides a similar decl macro.</p>



<a name="254291730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254291730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254291730">(Sep 21 2021 at 23:09)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> - that last code snippet looks weird to me. <code>pin! { }</code> looks like it's making a new scope, so in just skimming it, it's surprising that <code>future1</code> and <code>future2</code> would still be in scope by the <code>select!</code> block.</p>



<a name="254293172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/254293172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#254293172">(Sep 21 2021 at 23:26)</a>:</h4>
<p>Yeah, which is why the proc macro attribute is better :)</p>



<a name="255084179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/255084179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taiki Endo <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#255084179">(Sep 27 2021 at 17:09)</a>:</h4>
<p>There is another approach on stack-pinning using proc-macro:  <a href="https://github.com/Nemo157/ergo-pin-rs">https://github.com/Nemo157/ergo-pin-rs</a><br>
Related discussion in pin-project: <a href="https://github.com/taiki-e/pin-project/issues/58">https://github.com/taiki-e/pin-project/issues/58</a></p>



<a name="255602129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/255602129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#255602129">(Sep 30 2021 at 16:18)</a>:</h4>
<p>that seems nice too</p>



<a name="255602136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/255602136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#255602136">(Sep 30 2021 at 16:18)</a>:</h4>
<p>(though different)</p>



<a name="256082158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256082158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256082158">(Oct 04 2021 at 15:55)</a>:</h4>
<p>Seeing <code>ergo-pin-rs</code> I'm now wondering what would be needed in order to define something like <code>fn pin&lt;T&gt;(t: T) -&gt; Pin&lt;&amp;'local mut T&gt;;</code>.  Looking at the <code>#[pin]</code> proposal makes me wonder about this case specifically:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// are we pinning `self`, `inner` or `field`?</span>
<span class="cp">#[pin]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">field</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>With a function or macro the pin target is unambiguous:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// it's clear that we're pinning `self.inner` and accessing `field` on it</span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">).</span><span class="n">field</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Am I missing something?</p>



<a name="256090354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256090354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremiah Senkpiel <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256090354">(Oct 04 2021 at 16:40)</a>:</h4>
<p>I think in the case of</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[pin]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">field</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>It looks like we are pinning <code>field</code>, since that would be similar to the 2021 edition change where closure capture is only done on the inner most reference.</p>



<a name="256182846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256182846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256182846">(Oct 05 2021 at 06:05)</a>:</h4>
<p>I had an idea a while ago for <code>super</code> expressions that would force lifetime extension of an expression. Thus <code>pin!</code> could be defined as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$e</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="k">super</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And that would give you <code>ergo-pin</code>-style pin syntax without the attribute macro. And FWIW <code>super</code> keyword is also useful elsewhere (e.g. <code>format_args!</code>, stack-based dynamic dispatch).</p>



<a name="256228290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256228290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256228290">(Oct 05 2021 at 11:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="319552">Jeremiah Senkpiel</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.60pin!.60/near/256090354">said</a>:</p>
<blockquote>
<p>It looks like we are pinning <code>field</code>, since that would be similar to the 2021 edition change where closure capture is only done on the inner most reference.</p>
</blockquote>
<p>That would mean that if we want to pin <code>inner</code>, we'd need to write it as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[pin]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inner</span><span class="p">.</span><span class="n">field</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="256257211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256257211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256257211">(Oct 05 2021 at 14:40)</a>:</h4>
<p>How often does needing to pin the inner, but you are only using 1 field, come up?</p>



<a name="256282648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256282648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256282648">(Oct 05 2021 at 17:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257428">Gus Wynn</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.60pin!.60/near/256257211">said</a>:</p>
<blockquote>
<p>How often does needing to pin the inner, but you are only using 1 field, come up?</p>
</blockquote>
<p>Here's a pattern that comes up fairly regularly:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span>::<span class="n">ready</span><span class="o">!</span><span class="p">(</span><span class="n">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">).</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Perhaps a <code>#[pin]</code> attribute could maybe be smart enough to figure out what exactly to pin; but what I think is more likely is that we'd end up using it like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[pin]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span>::<span class="n">ready</span><span class="o">!</span><span class="p">(</span><span class="n">inner</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Which seems less nice than either a pin macro or pin function.</p>



<a name="256294956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256294956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256294956">(Oct 05 2021 at 18:26)</a>:</h4>
<p>hmm that does seem cleaner! I wonder if an inline non-attribute macro is implementable: <code>let value = task::ready!(pin!(self.inner).poll(cx))?;</code>?</p>



<a name="256296502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256296502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256296502">(Oct 05 2021 at 18:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257428">Gus Wynn</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.60pin!.60/near/256294956">said</a>:</p>
<blockquote>
<p>hmm that does seem cleaner! I wonder if an inline non-attribute macro is implementable: <code>let value = task::ready!(pin!(self.inner).poll(cx))?;</code>?</p>
</blockquote>
<p>That seems like it'd make for a fun experiment!</p>



<a name="256299193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256299193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256299193">(Oct 05 2021 at 18:54)</a>:</h4>
<p>Can it be made not-<code>unsafe</code>? the way that pin-project handles this is by banning all non-pinned access to a field if it is declared to be structurally pinned</p>
<p>ill have to see what <code>ergo-pin-rs</code> does</p>



<a name="256312839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256312839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256312839">(Oct 05 2021 at 20:21)</a>:</h4>
<blockquote>
<p>Can it be made not-<code>unsafe</code>?</p>
</blockquote>
<p>Not without (a) placing an attribute macro around the containing block like ergo-pin does, or (b) a <code>super</code> operator as I suggested</p>



<a name="256488542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256488542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256488542">(Oct 06 2021 at 21:35)</a>:</h4>
<p><span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span> regarding the <code>ready!(pin(self.inner).poll(cx))</code> pattern, you could write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ready</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">pinned</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>where:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">pinned</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span>: <span class="nc">Self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">scope</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pin_mut</span><span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">scope</span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Obviously this pattern can only go so far, since, alas, there is no nice callback style for async callbacks <span aria-label="disappointed" class="emoji emoji-1f61e" role="img" title="disappointed">:disappointed:</span></p>



<a name="256489117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256489117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256489117">(Oct 06 2021 at 21:39)</a>:</h4>
<p>Ohhh, yeah true! That's cool!</p>
<p>cc/ <span class="user-mention" data-user-id="421986">@eholk</span>  this feels like it has similar vibes to what you were talking about the other day.</p>



<a name="256489455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256489455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256489455">(Oct 06 2021 at 21:42)</a>:</h4>
<p>Yeah! I've been thinking a little about something like pinned scopes, but I'm not super happy with what I've come up with so far.</p>



<a name="256489702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256489702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256489702">(Oct 06 2021 at 21:44)</a>:</h4>
<p>What does the <code>ready!</code> macro do?</p>



<a name="256489962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256489962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256489962">(Oct 06 2021 at 21:46)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> <a href="https://doc.rust-lang.org/std/task/macro.ready.html"><code>std::task::ready</code></a>, this will be stable in 1.56 (in 14 days)</p>



<a name="256489988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256489988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256489988">(Oct 06 2021 at 21:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.60pin!.60/near/256488542">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> regarding the <code>ready!(pin(self.inner).poll(cx))</code> pattern, you could write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ready</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">pinned</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>where:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">pinned</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span>: <span class="nc">Self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">scope</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pin_mut</span><span class="o">!</span><span class="p">(</span><span class="n">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">scope</span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Obviously this pattern can only go so far, since, alas, there is no nice callback style for async callbacks <span aria-label="disappointed" class="emoji emoji-1f61e" role="img" title="disappointed">:disappointed:</span></p>
</blockquote>
<p>When do you need to pin a value manually in an async context?</p>



<a name="256490046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256490046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256490046">(Oct 06 2021 at 21:47)</a>:</h4>
<p><span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span> Ah, okay, so <code>ready!</code> seems like the async analog of <code>try!</code>?</p>



<a name="256490356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256490356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256490356">(Oct 06 2021 at 21:50)</a>:</h4>
<p>haha, yeah pretty much! </p>
<p>Ideally we would've been able to implement <code>Try for std::task::Poll&lt;T&gt;</code>, but <code>Poll</code> was stabilized with <code>Try</code> impls for <code>Option&lt;Poll&lt;T&gt;&gt;</code> and <code>Result&lt;Poll&lt;T&gt;, E&gt;</code>. In order to make <code>?</code> <em>just work</em> for <code>Poll</code> we could do some shenanigans through specialization, but the libs team figured that might make things too weird.</p>
<p>So we settled for stabilizing <code>std::task::ready!</code> instead.</p>



<a name="256490593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256490593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256490593">(Oct 06 2021 at 21:52)</a>:</h4>
<p>That makes sense. I guess there's still the option of making <code>?</code> work in the future too.</p>



<a name="256490711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256490711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256490711">(Oct 06 2021 at 21:53)</a>:</h4>
<p>Theoretically we still could, but when it came up earlier this year libs team members seemed against it. So it may not be in the near future, if ever.</p>



<a name="256490913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256490913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256490913">(Oct 06 2021 at 21:55)</a>:</h4>
<p>Yeah, it seems like kind of a lower priority.</p>



<a name="256491107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256491107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256491107">(Oct 06 2021 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="257428">@Gus Wynn</span> I have some distant memory of having needed that, but I can't recall exactly why was that <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> (maybe smth with <code>select!</code>ing inside a loop <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span>)<br>
If that's a rare need, then that's excellent news for the CPS api</p>



<a name="256491604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256491604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256491604">(Oct 06 2021 at 22:01)</a>:</h4>
<p>Anyways, I was mentioning the CPS style since it's an area I've been toying with for a while (<a href="https://docs.rs/with_locals">https://docs.rs/with_locals</a>).<br>
There, I had chosen a <code>#[with] let var = ....;</code> kind of syntax, and, now that I have some distance from it, I realize it's too constraining for the callers. So I'm planning to change that to <code>with!(...)</code> syntax, applicable anywhere.</p>



<a name="256492187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256492187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256492187">(Oct 06 2021 at 22:06)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> I just tinkered a bit more with your example to see how it would look if we exposed it from <code>core::pin</code>, and it looks so good? </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">pin</span>::<span class="p">{</span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">Pin</span><span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello from inside Pin&lt;&amp;mut Self&gt;!"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">foo</span><span class="o">|</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">hello</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><em><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f8dc4c9ad7834db190ea605403eab5b9">playground</a></em></p>



<a name="256493634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256493634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256493634">(Oct 06 2021 at 22:19)</a>:</h4>
<p>Yep. The other option would be a <code>PinExt</code> or  <code>Pinned</code> extension trait, for the <code>foo.pin(|foo| ...)</code> or <code>foo.pinned(|foo| ...)</code>; but the free function doesn't look bad either, and had the advantage of being simpler.</p>



<a name="256516847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256516847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256516847">(Oct 07 2021 at 03:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.60pin!.60/near/256490593">said</a>:</p>
<blockquote>
<p>That makes sense. I guess there's still the option of making <code>?</code> work in the future too.</p>
</blockquote>
<p>I was thinking, that as an alternative to <code>ready!</code> there could be a <code>fn ready(self) -&gt; impl Try...</code> on <code>Pin</code> such that you could write <code>let val = pinned.ready()?</code></p>



<a name="256516873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256516873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256516873">(Oct 07 2021 at 03:07)</a>:</h4>
<p>I like that a bit better than <code>let val = ready!(pinned)</code></p>



<a name="256516941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256516941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256516941">(Oct 07 2021 at 03:08)</a>:</h4>
<p>It's arguable even nicer than <code>let val = pinned?</code>, and is non-breaking.</p>



<a name="256611763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256611763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256611763">(Oct 07 2021 at 16:54)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> I think <code>let val = pinned.ready()?</code> looks really nice!</p>



<a name="256622013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%60pin%21%60/near/256622013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.60pin!.60.html#256622013">(Oct 07 2021 at 17:59)</a>:</h4>
<p><a href="/user_uploads/4715/pkTqzIHBHijLVb22dIX_mn3C/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/pkTqzIHBHijLVb22dIX_mn3C/image.png" title="image.png"><img src="/user_uploads/4715/pkTqzIHBHijLVb22dIX_mn3C/image.png"></a></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>