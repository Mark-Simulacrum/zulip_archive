<html>
<head><meta charset="utf-8"><title>&quot;inline&quot; async fn in traits · wg-async-foundations · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/index.html">wg-async-foundations</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html">&quot;inline&quot; async fn in traits</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="239721278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239721278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239721278">(May 21 2021 at 09:24)</a>:</h4>
<p>So I have this idea that I think could be a nice optimization and also a game changer that basically makes custom poll functions (like those found in <code>AsyncRead</code>, <code>AsyncWrite</code>, and the <code>AsyncDrop</code> that <span class="user-mention" data-user-id="256759">@boats</span> proposed) obsolete. I wrote it up here:</p>
<p><a href="https://hackmd.io/bKfiVPRpTvyX8JK_Ng2EWA?view">https://hackmd.io/bKfiVPRpTvyX8JK_Ng2EWA?view</a></p>
<p>I'd be curious to know what people think.</p>



<a name="239733901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239733901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239733901">(May 21 2021 at 11:21)</a>:</h4>
<p>Hm, I'm a bit unhappy with the action at a distance, particularly if you implement a bunch of different traits for the same type you get a long invisible suffix. (at the very least, requiring the type to be repr(Rust) seems good, or perhaps even repr(async_trait_container)). Figuring out how to expose the relevant lifetimes from the added state and any potential relationships also seems annoying.</p>
<p>It seems a bit unfortunate that we have to resort to such things, too, but at some level I do like the idea. I think it doesn't really feel like it should be constrained to async fn, vs just "one way" to represent impl trait return types in traits, or even <em>the</em> way with a repr(dyn)...? It seems unfortunate that the struct would likely end up pretty huge if it implemented multiple such traits, as e.g. a File would...</p>



<a name="239735891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239735891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239735891">(May 21 2021 at 11:39)</a>:</h4>
<p>How does this idea relate to GATs (at minimum, TAIT) for async trait methods?</p>



<a name="239765135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765135">(May 21 2021 at 15:03)</a>:</h4>
<p>It's true that if you implement a bunch of such traits for one type it could grow precipitously in size. Of course, I'm not sure that's a very likely scenario.</p>



<a name="239765210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765210">(May 21 2021 at 15:04)</a>:</h4>
<p>I plan to write up a kind of survey of the "dyn safe" space in a bit</p>



<a name="239765221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765221">(May 21 2021 at 15:04)</a>:</h4>
<p>I think there are a few options</p>



<a name="239765252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765252">(May 21 2021 at 15:04)</a>:</h4>
<p>It seems to me that there isn't a single "best option" that fits everything</p>



<a name="239765275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765275">(May 21 2021 at 15:04)</a>:</h4>
<p>Ah, there is one other interesting thing about this proposal:</p>



<a name="239765280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765280">(May 21 2021 at 15:04)</a>:</h4>
<p>I just remembered</p>



<a name="239765305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765305">(May 21 2021 at 15:04)</a>:</h4>
<p>It's actually <em>very important</em> for <code>Drop</code> that <em>all the storage it needs is in the self type</em></p>



<a name="239765327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765327">(May 21 2021 at 15:04)</a>:</h4>
<p>this is because:</p>



<a name="239765401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765401">(May 21 2021 at 15:05)</a>:</h4>
<p>if you have </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Default</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="239765453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765453">(May 21 2021 at 15:05)</a>:</h4>
<p>the resulting Future is send if <code>T: Send</code></p>



<a name="239765551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765551">(May 21 2021 at 15:06)</a>:</h4>
<p>but if that may instantiat a drop future</p>



<a name="239765565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765565">(May 21 2021 at 15:06)</a>:</h4>
<p>we would need to account for that</p>



<a name="239765579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765579">(May 21 2021 at 15:06)</a>:</h4>
<p>we could plausibly do that with a <code>T</code> that we know</p>



<a name="239765612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765612">(May 21 2021 at 15:06)</a>:</h4>
<p>e.g., it'd be like a where clause <code>&lt;T as AsyncDrop&gt;::DropFuture: Send</code></p>



<a name="239765639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765639">(May 21 2021 at 15:06)</a>:</h4>
<p>but for a <code>Box&lt;dyn Future&gt;</code> sort of thing</p>



<a name="239765655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765655">(May 21 2021 at 15:06)</a>:</h4>
<p>it's going to be much trickier and weirder</p>



<a name="239765712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765712">(May 21 2021 at 15:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/239765135">said</a>:</p>
<blockquote>
<p>It's true that if you implement a bunch of such traits for one type it could grow precipitously in size. Of course, I'm not sure that's a very likely scenario.</p>
</blockquote>
<p>one other point: I made the repr "invisible" at the impl site, but there is no real reason to do that</p>



<a name="239765738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765738">(May 21 2021 at 15:07)</a>:</h4>
<p>that might help with the action at a distance, <span class="user-mention" data-user-id="116122">@simulacrum</span> -- you could have to "opt in" in some way on the struct itself</p>



<a name="239765997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239765997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239765997">(May 21 2021 at 15:09)</a>:</h4>
<p>Another option would be to forbid the use of local variables live across awaits, and force people to put that state directly into their struct</p>



<a name="239766009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766009">(May 21 2021 at 15:09)</a>:</h4>
<p>but to me, that seems strictly less nice</p>



<a name="239766030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766030">(May 21 2021 at 15:09)</a>:</h4>
<p>still, it might be adequare for most everything</p>



<a name="239766135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766135">(May 21 2021 at 15:10)</a>:</h4>
<p>I'd prefer that the solution is general enough that it works for not just async fn regardless, personally, at least as an easy-ish future extension</p>



<a name="239766183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766183">(May 21 2021 at 15:10)</a>:</h4>
<p>e.g., <code>trait Foo { fn bar(&amp;mut self) -&gt; impl Iterator; }</code></p>



<a name="239766247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766247">(May 21 2021 at 15:10)</a>:</h4>
<p>it could be extended to other traits, yes</p>



<a name="239766326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766326">(May 21 2021 at 15:11)</a>:</h4>
<p>I think though that would work best</p>



<a name="239766329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766329">(May 21 2021 at 15:11)</a>:</h4>
<p>if we had generators</p>



<a name="239766502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766502">(May 21 2021 at 15:12)</a>:</h4>
<p>I added some notes about these things to the doc for now</p>



<a name="239766757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766757">(May 21 2021 at 15:14)</a>:</h4>
<p>hm I don't see how generators play into it - I mean that <em>in general</em> you're basically solving the problem of "function returns a thing that implements Foo and has an unknown to the caller size"</p>



<a name="239766816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766816">(May 21 2021 at 15:14)</a>:</h4>
<p>and you likely want it to be true that if you call it in a generic/known-type context, i.e., not through dyn trait, the compiler still sees through any hiding and doesn't need all this embedding magic</p>



<a name="239766840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239766840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239766840">(May 21 2021 at 15:15)</a>:</h4>
<p>that might not be possible, though, not sure.</p>



<a name="239767172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767172">(May 21 2021 at 15:16)</a>:</h4>
<p>I agree it's not limited to generators</p>



<a name="239767189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767189">(May 21 2021 at 15:16)</a>:</h4>
<p>well</p>



<a name="239767219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767219">(May 21 2021 at 15:17)</a>:</h4>
<p>it has to "lock" the self, to start, and it requires that the trait is something with a "from-fn" method</p>



<a name="239767239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767239">(May 21 2021 at 15:17)</a>:</h4>
<p>async fn gaurantees those properties</p>



<a name="239767248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767248">(May 21 2021 at 15:17)</a>:</h4>
<p>your signature for example does not</p>



<a name="239767291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767291">(May 21 2021 at 15:17)</a>:</h4>
<p>it would have to be <code>fn bar(&amp;mut self) -&gt; impl Iterator + '_</code></p>



<a name="239767312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767312">(May 21 2021 at 15:17)</a>:</h4>
<p>but if it were that, it should work</p>



<a name="239767770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767770">(May 21 2021 at 15:21)</a>:</h4>
<p>sure, that's true</p>



<a name="239767855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767855">(May 21 2021 at 15:21)</a>:</h4>
<p>In theory you could imagine that the dyn trait has a Layout stored, and the caller needs to pass a *mut to memory for that layout</p>



<a name="239767869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767869">(May 21 2021 at 15:21)</a>:</h4>
<p>(not literally, but in the ABI)</p>



<a name="239767960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767960">(May 21 2021 at 15:22)</a>:</h4>
<p>yes, in theory</p>



<a name="239767969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767969">(May 21 2021 at 15:22)</a>:</h4>
<p>and they can do that by allocating -- Box -- by knowing the size since they know the type, so being able to put it on the stack directly before calling</p>



<a name="239767981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239767981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239767981">(May 21 2021 at 15:22)</a>:</h4>
<p>one thing worth pointing out is that async fn cannot use alloca</p>



<a name="239768160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768160">(May 21 2021 at 15:23)</a>:</h4>
<p>hm, why not?</p>



<a name="239768170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768170">(May 21 2021 at 15:23)</a>:</h4>
<p>because their "stack frame' is actually a struct</p>



<a name="239768295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768295">(May 21 2021 at 15:24)</a>:</h4>
<p>I think this also implies that the "unsized rvalues" RFC needs to be scaled back to more the original, alloca-less variant</p>



<a name="239768360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768360">(May 21 2021 at 15:25)</a>:</h4>
<p>I guess, I'm not sure why that matters -- you just need a place to put that stack frame on the stack, right? And then pin it?</p>



<a name="239768441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768441">(May 21 2021 at 15:25)</a>:</h4>
<p>when you run an async fn, all of its storage that might live across an await has to be placed into a struct</p>



<a name="239768470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768470">(May 21 2021 at 15:25)</a>:</h4>
<p>me and <span class="user-mention" data-user-id="116883">@tmandry</span> were considering a case where you used alloca to allocate enough space for the future</p>



<a name="239768482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768482">(May 21 2021 at 15:25)</a>:</h4>
<p>but in that case, you'd have to have a variable-sized field in the struct</p>



<a name="239768495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768495">(May 21 2021 at 15:26)</a>:</h4>
<p>which of course you cannot do</p>



<a name="239768555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768555">(May 21 2021 at 15:26)</a>:</h4>
<p>so you'd need to have some "max size" and use an allocator over that</p>



<a name="239768618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768618">(May 21 2021 at 15:26)</a>:</h4>
<p>at which point you've got a rather different feature, which is one of the ones I'd like to enumerate as a possibility, but which I also do not like as much in some other respects</p>



<a name="239768658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768658">(May 21 2021 at 15:26)</a>:</h4>
<p>I thought a future's size is statically known -- this seems true, otherwise Box wouldn't work either</p>



<a name="239768679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768679">(May 21 2021 at 15:26)</a>:</h4>
<p>that's exactly the point</p>



<a name="239768702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768702">(May 21 2021 at 15:27)</a>:</h4>
<p>you're invoking an unknown future</p>



<a name="239768713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768713">(May 21 2021 at 15:27)</a>:</h4>
<p>oh, you mean that you can't recursively do this</p>



<a name="239768720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768720">(May 21 2021 at 15:27)</a>:</h4>
<p>but your size must be statically known</p>



<a name="239768734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239768734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239768734">(May 21 2021 at 15:27)</a>:</h4>
<p>yeah that's true</p>



<a name="239769044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239769044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239769044">(May 21 2021 at 15:29)</a>:</h4>
<p>well, arguably, that's no different to a recursive call today -- which must also be boxed for a similar reason</p>



<a name="239769064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239769064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239769064">(May 21 2021 at 15:29)</a>:</h4>
<p>(we don't know how deep the recursion will go so can't statically allocate you)</p>



<a name="239772920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239772920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239772920">(May 21 2021 at 15:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/239769044">said</a>:</p>
<blockquote>
<p>well, arguably, that's no different to a recursive call today -- which must also be boxed for a similar reason</p>
</blockquote>
<p>I don't know what this means :)</p>



<a name="239772933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239772933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239772933">(May 21 2021 at 15:54)</a>:</h4>
<p>t's true that a recursive call must be boxed</p>



<a name="239772960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239772960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239772960">(May 21 2021 at 15:54)</a>:</h4>
<p>I'm just not sure what that has to do with these sorts of calls, which are not recursive</p>



<a name="239773020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239773020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239773020">(May 21 2021 at 15:54)</a>:</h4>
<p>(or at least, not necessarily recursive)</p>



<a name="239788639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788639">(May 21 2021 at 17:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116883">@tmandry</span> this topic exists</p>



<a name="239788646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788646">(May 21 2021 at 17:50)</a>:</h4>
<blockquote>
<p>tmandry: I mean I think having it inside makes sense for today's async fn futures</p>
</blockquote>



<a name="239788692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788692">(May 21 2021 at 17:50)</a>:</h4>
<p>it is what the current traits would have you do, if that's what you mean</p>



<a name="239788862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788862">(May 21 2021 at 17:52)</a>:</h4>
<p>I’d love to see some examples of things that implement both AsyncRead and AsyncWrite where the two are used simultaneously (cc <span class="user-mention" data-user-id="211731">@Sean McArthur</span>)</p>



<a name="239788939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788939">(May 21 2021 at 17:52)</a>:</h4>
<p>First example that comes to mind is HTTP/2 over a TcpStream</p>



<a name="239788948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788948">(May 21 2021 at 17:52)</a>:</h4>
<p>links! links!</p>



<a name="239788974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788974">(May 21 2021 at 17:52)</a>:</h4>
<p>its not easy to point at</p>



<a name="239788999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239788999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239788999">(May 21 2021 at 17:53)</a>:</h4>
<p>I have faith in you</p>



<a name="239789052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789052">(May 21 2021 at 17:53)</a>:</h4>
<p>:P</p>



<a name="239789057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789057">(May 21 2021 at 17:53)</a>:</h4>
<p>what I'm trying to figure out is</p>



<a name="239789121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789121">(May 21 2021 at 17:54)</a>:</h4>
<p>I want to know how much the impls make use of the <code>&amp;mut self</code></p>



<a name="239789142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789142">(May 21 2021 at 17:54)</a>:</h4>
<p>to what extent are they mutating data</p>



<a name="239789169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789169">(May 21 2021 at 17:54)</a>:</h4>
<p>you could imagine having an <code>AsyncReadWrite</code> that supports both simultaneously, but with an <code>&amp;self</code></p>



<a name="239789181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789181">(May 21 2021 at 17:54)</a>:</h4>
<p>(based on an idea I just had...)</p>



<a name="239789206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789206">(May 21 2021 at 17:54)</a>:</h4>
<p>but it would require <code>Cell</code> and <code>RefCell</code> etc to mutate fields</p>



<a name="239789225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789225">(May 21 2021 at 17:54)</a>:</h4>
<p>ignoring <code>Send</code> for a second, how terrible would that be?</p>



<a name="239789235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789235">(May 21 2021 at 17:55)</a>:</h4>
<p>for something like a file descriptor, not bad at all</p>



<a name="239789272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789272">(May 21 2021 at 17:55)</a>:</h4>
<p>Yea, so at the core you'd be waiting on readiness for both read and write on the socket itself</p>



<a name="239789365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789365">(May 21 2021 at 17:56)</a>:</h4>
<p>since multiplexing many streams over a single socket means you _can't_  block writing a frame for one stream on reading the next frame for whichever stream it happens to be</p>



<a name="239789487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789487">(May 21 2021 at 17:56)</a>:</h4>
<p>So it seems like we could wave some hands and say "ya ya, concurrently doing that on a socket is actually safe because the OS makes it so"</p>



<a name="239789578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789578">(May 21 2021 at 17:57)</a>:</h4>
<p>but inevitably, you get wrapping types that build in buffering (both directions), or some sort of decode state, etc, and _then_ it's not actually safe to have 2 mut refs</p>



<a name="239789752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789752">(May 21 2021 at 17:59)</a>:</h4>
<p>could you "decompose" the socket into two objects, one for reading and one for writing?</p>



<a name="239789840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239789840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239789840">(May 21 2021 at 17:59)</a>:</h4>
<p>you could, but then you need something like an <code>Arc</code></p>



<a name="239790001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239790001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239790001">(May 21 2021 at 18:00)</a>:</h4>
<p>I didn't mean to say the idea is impossible, just that it might not be free (or maybe there's some crazy magic to uncover).</p>



<a name="239790260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239790260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239790260">(May 21 2021 at 18:02)</a>:</h4>
<p>I'm imagining something where original object could stick around and these both hold a reference. could ensure there aren't duplicates by making them come from <code>&amp;mut self</code> or something</p>



<a name="239790937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239790937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239790937">(May 21 2021 at 18:07)</a>:</h4>
<p>Another example is a duplex tcp proxy, where you want to forward in both directions as the data becomes available. linkerd2 has one, I think tokio got also has a <code>copy_bidirectional</code> helper?</p>



<a name="239793132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239793132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239793132">(May 21 2021 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/239772960">said</a>:</p>
<blockquote>
<p>I'm just not sure what that has to do with these sorts of calls, which are not recursive</p>
</blockquote>
<p>I'm saying one could argue that the caller for these sorts of calls needs to provide somewhere to put it: whether that's a Box, or some arena, or inside their type. The last of those is not ergonomic today, but we could help with it in a variety of ways (e.g., such as you've suggested, by some repr attributes).</p>



<a name="239859417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239859417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239859417">(May 22 2021 at 09:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243965">Sean McArthur</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/239790001">said</a>:</p>
<blockquote>
<p>I didn't mean to say the idea is impossible, just that it might not be free (or maybe there's some crazy magic to uncover).</p>
</blockquote>
<p>it's not super crazy to imagine a <code>&amp;mut self</code> that can't hold references across awaits and where the compiler treats it as "releasing" the <code>&amp;mut</code>, but I don't know that I love the idea from a user's perspective</p>



<a name="239859430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239859430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239859430">(May 22 2021 at 09:21)</a>:</h4>
<p>that said, another option -- which is interesting -- is something like</p>



<a name="239859506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239859506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239859506">(May 22 2021 at 09:22)</a>:</h4>
<p>well, hmm. I was going to say that there's a lower-level trait that you can manually implement if you choose</p>



<a name="239859508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239859508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239859508">(May 22 2021 at 09:22)</a>:</h4>
<p>which is certainly possible</p>



<a name="239859514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239859514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239859514">(May 22 2021 at 09:22)</a>:</h4>
<p>but I'm not sure it's going to work out well</p>



<a name="239859522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239859522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239859522">(May 22 2021 at 09:22)</a>:</h4>
<p>of course the cell-ref-cell idea is plausible too, but that is a kind of overhead (in the multithreaded case in particular, where that translates to actual mutexes, even if they'll never really be needed)</p>



<a name="239941192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239941192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239941192">(May 23 2021 at 10:33)</a>:</h4>
<p><span class="user-mention" data-user-id="243965">@Sean McArthur</span> I'd still like links into the source so I can read up on those types more directly</p>



<a name="239960895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/239960895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#239960895">(May 23 2021 at 16:07)</a>:</h4>
<p>The bidirectional copy is much simpler to link to: <a href="https://github.com/tokio-rs/tokio/blob/master/tokio/src/io/util/copy_bidirectional.rs">https://github.com/tokio-rs/tokio/blob/master/tokio/src/io/util/copy_bidirectional.rs</a></p>



<a name="240077809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240077809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240077809">(May 24 2021 at 16:47)</a>:</h4>
<p>One strategy for supporting concurrent read / writes would be to have an IoReady trait that lets the caller specify which direction they want to listen for: <code>my_io.ready(Ready::Readable | Ready::Writable).awiat</code> then have <code>TryRead</code> and <code>TryWrite</code> traits instead (<code>fn try_read(&amp;mut self, ...) -&gt; io::Result&lt;()&gt;). These would be non-blocking calls and could return </code>io::Result`. This would make implementing read / write trickier and also not be super io-uring friendly.</p>



<a name="240077919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240077919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240077919">(May 24 2021 at 16:48)</a>:</h4>
<p>Alternatively, maybe there is an option where implementations like Tokio TcpStream can implement the de-sugarded versions by hand, then maybe we can make <code>impl AsyncRead for &amp;TcpStream</code> work</p>



<a name="240077970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240077970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240077970">(May 24 2021 at 16:48)</a>:</h4>
<p>THe main missing piece for ^^ to work afaik is some hook indicating the async fn is cancelled so we can cleanup internal state</p>



<a name="240078026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240078026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240078026">(May 24 2021 at 16:49)</a>:</h4>
<p>Besides that, <a href="https://github.com/hyperium/h2/tree/master/src/codec">h2's codec</a> has some encoding and decoding state on top of the <code>AsyncRead + AsyncWrite</code> (which itself builds on top of <code>tokio_util::codec</code>), but then all the stream state happens, and all that is managed inside a single <code>Connection::poll</code>.</p>



<a name="240078275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240078275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240078275">(May 24 2021 at 16:50)</a>:</h4>
<p>Well, implementing AsyncRead for &amp;TcpStream would be a bit more complicated... but there probably is a way to make it work</p>



<a name="240097314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240097314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240097314">(May 24 2021 at 19:09)</a>:</h4>
<p>I already commented on amazon slack regarding this, but I somehow mistook the origin of the doc and also not everyone has access to it. So here again:</p>
<p>This seems pretty similar to what I described at <a href="https://internals.rust-lang.org/t/async-traits-the-less-dynamic-allocations-edition/13048/10">https://internals.rust-lang.org/t/async-traits-the-less-dynamic-allocations-edition/13048/10</a> .</p>
<p>However it has some pros:</p>
<ul>
<li>Static dispatch and allowing better inling</li>
<li>Even the first dynamic allocation is saved, which makes it more interesting for interfaces which are only called once</li>
<li>Compiler is doing the job, and no proc macro dependency</li>
</ul>
<p>And some cons:</p>
<ul>
<li>You don't get a nicely type-erased future back anymore (e.g. when you want to put them into a FuturesUnordered or so</li>
<li>Works only for <code>&amp;mut self</code> calls.</li>
</ul>
<p>I think the latter kind of adds more confusion to the topic than that it helps. People will ask "why does this limitation exist", and one has to go down into all the nittgy gritty details of how this desugars to explain. So I'm rather not inlined of directly having this.</p>



<a name="240097582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240097582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240097582">(May 24 2021 at 19:12)</a>:</h4>
<p>One thing which is more about the article style which confused me is that it in the beginning talks about <code>AsyncDrop</code> and sounds like it would solve the async drop problem - but it really doesn't. The same challenges of the drop method having no guarantee to be called continues to exist. I therefore think it's fine to leave it out for this proposal, and talk about this separately.</p>



<a name="240099755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240099755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240099755">(May 24 2021 at 19:28)</a>:</h4>
<p>One example where <code>&amp;self</code> can be useful:</p>
<p><a href="https://github.com/rust-lang/futures-rs/issues/1365">https://github.com/rust-lang/futures-rs/issues/1365</a> was probably the very first issue where discussion about better async IO traits was brought up.</p>
<p>In the first post there is an example of an in-memory channel which and async send/receive interface where each side could adhere to a trait. The implementation in there could easily be switched to take <code>&amp;self</code> instead of <code>&amp;mut self</code> and thereby to represent a MPMC channel. While this is implementable using purely async/await as the example shows, the proposed async trait version couldn't model that.</p>
<p>Something similar can be said about OS file IO, since sockets can really be read/written from concurrently.</p>



<a name="240100388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240100388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240100388">(May 24 2021 at 19:32)</a>:</h4>
<p><strong>However something interesting occured to me: One can combine this proposal for async traits and combine it with <a href="#narrow/stream/187312-wg-async-foundations/topic/run.20to.20completion.20async.20fn">https://rust-lang.zulipchat.com/#narrow/stream/187312-wg-async-foundations/topic/run.20to.20completion.20async.20fn</a> </strong></p>
<p>If functions run to completion (are just intended to be directly <code>.await</code>ed, there shouldn't be any place anymore where multiple states for <code>&amp;self</code> futures are required for the <code>!Sync</code> case, and those states could also be stored inline. Still doesn't solve the <code>Sync</code> case yet, but one step closer.</p>



<a name="240377265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377265">(May 26 2021 at 19:22)</a>:</h4>
<p>It actually works for <code>&amp;self</code> too, but you can't add add'l fields</p>



<a name="240377340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377340">(May 26 2021 at 19:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224941">Carl Lerche</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/240077919">said</a>:</p>
<blockquote>
<p>Alternatively, maybe there is an option where implementations like Tokio TcpStream can implement the de-sugarded versions by hand, then maybe we can make <code>impl AsyncRead for &amp;TcpStream</code> work</p>
</blockquote>
<p>I'm more and into the idea of supporting <code>&amp;self</code> and having an <code>AsyncReadWrite</code> interface</p>



<a name="240377399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377399">(May 26 2021 at 19:24)</a>:</h4>
<p>but I thnk I'm going to want to rework the doc into multiple versions, there's a lot of moving parts and I'm not sure which one is best altogether</p>



<a name="240377456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377456">(May 26 2021 at 19:24)</a>:</h4>
<p>let me take a look at the internals thread that <span class="user-mention" data-user-id="204219">@Matthias247</span> cited though</p>



<a name="240377731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377731">(May 26 2021 at 19:26)</a>:</h4>
<p>I see. Interesting.</p>



<a name="240377750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377750">(May 26 2021 at 19:26)</a>:</h4>
<p>seems like it can be implemented atop this verson</p>



<a name="240377786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377786">(May 26 2021 at 19:26)</a>:</h4>
<p>I'm not sure if there's going to be a "one size fits all" version here, in the end</p>



<a name="240377801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240377801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240377801">(May 26 2021 at 19:26)</a>:</h4>
<p>afaik this "inline" repr is the only representation that can accommodate async-drop</p>



<a name="240485056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240485056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240485056">(May 27 2021 at 15:25)</a>:</h4>
<p>What would <code>AsyncReadWrite</code> look like?</p>



<a name="240626329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626329">(May 28 2021 at 16:10)</a>:</h4>
<p>I'm been thinking more about this and I think my idea ddn't quite work as is</p>



<a name="240626392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626392">(May 28 2021 at 16:11)</a>:</h4>
<p>In particular, if you have an <code>&amp;self</code> method, I don't really think it's feasible to work with <code>RefCell</code>, and I don't know how you could delegate to another future</p>



<a name="240626426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626426">(May 28 2021 at 16:11)</a>:</h4>
<p>you'd have to do a refcell borrow, and that would create a temporary, and that temporary would have to be preserved across the await, so it really doesn't work.</p>



<a name="240626524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626524">(May 28 2021 at 16:12)</a>:</h4>
<p>that said, I'm now starting to think about other thoughts :) what if we had the ability to declare that two <code>&amp;mut self</code> methods must be able to execute simultaneously? it'd be useful in other contexts</p>



<a name="240626594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626594">(May 28 2021 at 16:12)</a>:</h4>
<p>that said, you could also have a trait that makes "split" into more of a first-class operation, but I don't know how you do that without requiring some extensions to rust's borrowing system; have to think abou that</p>



<a name="240626643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626643">(May 28 2021 at 16:13)</a>:</h4>
<p>basically the equivalent of something like <code>fn split() -&gt; (impl AsyncRead, impl AsyncWrite)</code>, though this has its own dyn trait issues :)</p>



<a name="240626658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240626658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240626658">(May 28 2021 at 16:13)</a>:</h4>
<p>I am pretty centered on this goal of "users should just write async fn"</p>



<a name="240636289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636289">(May 28 2021 at 17:31)</a>:</h4>
<blockquote>
<p>I am pretty centered on this goal of "users should just write async fn"</p>
</blockquote>
<p>+100 on this. Also the reason why I currently just recommend people to use <code>async_trait</code>. It significantly reduces the amount of concepts to learn, and just works.</p>
<p>I definitely like this proposal, and I think even the limitations of <code>&amp;mut</code> are acceptable for most places where I've seen async traits being used. Not being able to model e.g. a <code>Receiver&lt;T&gt;</code> trait for a non-cloneable MPMC (like <a href="https://docs.rs/futures-intrusive/0.4.0/futures_intrusive/channel/struct.GenericChannel.html#method.receive">the futures-intrusive one</a>) is a drawback, but it's probably minor since it can be fixed with wrapping in an <code>Arc</code> and cloning. At least for all the non <code>no-std</code> usecases.</p>
<p>The main downside I can still see is that it can't cover all the use-cases and we will still have <code>async_trait</code> around - so the question on where to use what version will come up <strong>very often</strong>.</p>
<blockquote>
<p>what if we had the ability to declare that two &amp;mut self methods must be able to execute simultaneously? </p>
</blockquote>
<p>What does "simulateneously" mean? Concurrently? From multiple threads? Seems like rather contradictionary to what <code>&amp;mut</code> means so far. And how would it look like?</p>



<a name="240636474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636474">(May 28 2021 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/240626524">said</a>:</p>
<blockquote>
<p>that said, I'm now starting to think about other thoughts :) what if we had the ability to declare that two <code>&amp;mut self</code> methods must be able to execute simultaneously? it'd be useful in other contexts</p>
</blockquote>
<p>Would be really nice. I would have to think about tit some, but perhaps being able to say two traits need to be able to be split could work</p>



<a name="240636562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636562">(May 28 2021 at 17:33)</a>:</h4>
<p>Regarding <code>split</code>: I think having it only on concrete types is totally fine. If someone needs the capability, split immediately and just pass the individual reader and writer. If you don't, then pass around a <code>T: AsyncRead + AsyncWrite</code>. I've now built a couple of libraries around this, and see no issues on that.</p>



<a name="240636608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636608">(May 28 2021 at 17:33)</a>:</h4>
<p>That said, I don't <em>think</em> it would be possible to make it work for TlsStream as, TlsStream may read from the inner stream on write and vice versa</p>



<a name="240636692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636692">(May 28 2021 at 17:34)</a>:</h4>
<p>The automatic splitting has its issues anyway. E.g. its still broken on tokio-tls for certain conditions (see <a href="https://github.com/tokio-rs/tls/issues/40">https://github.com/tokio-rs/tls/issues/40</a>)</p>



<a name="240636693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636693">(May 28 2021 at 17:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> maybe there is a way to say "you must not hold any references across await points"?</p>



<a name="240636822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240636822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240636822">(May 28 2021 at 17:35)</a>:</h4>
<p>In theory, if no references are held to self across await points, it should be possible to split safely?</p>



<a name="240637011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240637011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carl Lerche <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240637011">(May 28 2021 at 17:37)</a>:</h4>
<p>the split handles would have to be !Send, which could cause other problems...</p>



<a name="240638703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240638703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240638703">(May 28 2021 at 17:50)</a>:</h4>
<p>A generic split has a other issues that are not talked about in here. The one in tokio works because it assumes that an underlying io impl can store a different <code>Waker</code> for read and write. If it wouldn't be able to do that, it wouldn't work<br>
 So to make this work for other functions, you would also need to teach the trait about "this is having multiple <code>&amp;mut self</code> methods, but they store individual wakers". Sounds tricky.</p>



<a name="240904130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/240904130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#240904130">(Jun 01 2021 at 07:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/239721278">said</a>:</p>
<blockquote>
<p>So I have this idea that I think could be a nice optimization and also a game changer that basically makes custom poll functions (like those found in <code>AsyncRead</code>, <code>AsyncWrite</code>, and the <code>AsyncDrop</code> that <span class="user-mention silent" data-user-id="256759">boats</span> proposed) obsolete. I wrote it up here:</p>
<p><a href="https://hackmd.io/bKfiVPRpTvyX8JK_Ng2EWA?view">https://hackmd.io/bKfiVPRpTvyX8JK_Ng2EWA?view</a></p>
<p>I'd be curious to know what people think.</p>
</blockquote>
<p>I know I'm coming in a bit late here, but I wanted to share some recent experiences that this proposal seems to want to solve but as far as I can see, doesn't quite get there.</p>
<p>I've been writing a lot of <code>AsyncRead</code> implementations that needs to mix the output of futures/streams in the struct with immediately available data. As a concrete example, consider, WLOG, a reader that internally holds another reader:</p>
<p><code>struct MyReader { embedded: AsyncReadType }</code></p>
<p>We want to write an <code>AsyncRead</code> <code>impl</code> for this type that prefixes every 5 bytes emitted by <code>AsyncReadType</code> with <code>foo:</code>. What I'd <em>like</em> to write is something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">embedded</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="o">..</span><span class="p">]).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">b"foo:"</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="o">..</span><span class="n">n</span><span class="p">]).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Besides being able to use <code>async/await</code> in the trait, this also requires some kind <code>.write()</code> on the <code>buf</code> that yields when there isn't enough capacity in <code>buf</code>. You can imagine how tedious this book-keeping is without async/await. Of course, my real-world examples are much more complicated than this, generally needing to insert more than just one value as well as parse values from the reader and insert those parsed values into the stream.</p>
<p>I haven't seen a proposal of this sort yet, but the inability to write code like this has likely been my top time sink when writing async I/O trait impls.</p>



<a name="241155068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155068">(Jun 02 2021 at 14:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224941">Carl Lerche</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits/near/240636693">said</a>:</p>
<blockquote>
<p>maybe there is a way to say "you must not hold any references across await points"?</p>
</blockquote>
<p>yes, this is certainly possible, I guess the thing to do is to have some canonical examples of the kinds of code we want to write</p>



<a name="241155234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155234">(Jun 02 2021 at 14:19)</a>:</h4>
<p>What I meant by "permit two &amp;mut concurrently" is roughly: it's plausible to imagine having <code>&amp;mut</code> references that don't give access to all the fields of the struct, or which shared access to some. This is a language feature that's been kicking around for a while as a "nice to have". It'd be nice to be able to implement a trait and declare that two methods are "disjoint" (i.e., they either access disjoint memoy, or for shared memory access it in an <code>&amp;self</code>-compatible way)</p>



<a name="241155240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155240">(Jun 02 2021 at 14:19)</a>:</h4>
<p>You can model this by hand like so:</p>



<a name="241155453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155453">(Jun 02 2021 at 14:20)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Merged</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="nc">C</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Left</span><span class="o">&lt;'</span><span class="na">me</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">me</span> <span class="nc">mut</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">me</span> <span class="nc">C</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Right</span><span class="o">&lt;'</span><span class="na">me</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">me</span> <span class="nc">mut</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="o">'</span><span class="na">me</span> <span class="nc">C</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Merged</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">split</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="n">Left</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Right</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">Left</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">self</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">self</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="241155476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155476">(Jun 02 2021 at 14:20)</a>:</h4>
<p>now I can put methods on <code>Left</code> and <code>Right</code></p>



<a name="241155511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155511">(Jun 02 2021 at 14:21)</a>:</h4>
<p>it is <em>plausible</em> to imagine a language feature that makes this easier</p>



<a name="241155630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155630">(Jun 02 2021 at 14:22)</a>:</h4>
<p><span class="user-mention" data-user-id="326186">@Sergio</span> I thnk that my proposal would definitel enable this sort of thing</p>



<a name="241155724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155724">(Jun 02 2021 at 14:22)</a>:</h4>
<p>you would want to (presumably) layer some kind of "write-and-retry" loop on top</p>



<a name="241155760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155760">(Jun 02 2021 at 14:22)</a>:</h4>
<p>that is, you would want a method like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>



<a name="241155772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241155772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241155772">(Jun 02 2021 at 14:22)</a>:</h4>
<p>that either writes <em>all</em> of bytes or fails</p>



<a name="241171527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241171527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241171527">(Jun 02 2021 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Ah, sure, I don't think I was clear in my example, but the idea would be to write data as soon as output buffer capacity becomes available, not only when you have enough space for an entire chunk in the output buffer. For instance, if <code>buf</code> has a capacity of <code>1</code>, <code>buf.write(b"foo:")</code> should write <code>f</code>. When the reader is next polled, it should continue to fill <code>buf</code> as capacity becomes available.</p>



<a name="241171798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241171798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241171798">(Jun 02 2021 at 16:11)</a>:</h4>
<p>So if the next time around <code>buf</code> has a capacity of 2, it should write <code>oo</code>, and so on.</p>



<a name="241172728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241172728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241172728">(Jun 02 2021 at 16:18)</a>:</h4>
<p>I don't see a way to accomplish this in a composable manner without <code>buf</code> being smarter. I think, you could, for instance, have a <code>write!</code> macro called in the async read impl that would make this work, but that wouldn't compose.</p>



<a name="241174309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241174309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241174309">(Jun 02 2021 at 16:30)</a>:</h4>
<p>Maybe that's good enough though. I'll think about it/prototype it.</p>



<a name="241300162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241300162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241300162">(Jun 02 2021 at 18:30)</a>:</h4>
<p><span class="user-mention" data-user-id="326186">@Sergio</span> I don't quite see the problem :/</p>



<a name="241300191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241300191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241300191">(Jun 02 2021 at 18:30)</a>:</h4>
<p>well, maybe I do</p>



<a name="241300226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241300226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241300226">(Jun 02 2021 at 18:30)</a>:</h4>
<p>if you built <code>write</code> atop the abstractions that <span class="user-mention" data-user-id="224941">@Carl Lerche</span> proposed, though, it seems like it would work quite well</p>



<a name="241300550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241300550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241300550">(Jun 02 2021 at 18:32)</a>:</h4>
<p>it'd be something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">AsyncIo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">ready</span><span class="p">(</span><span class="n">Interest</span>::<span class="n">WRITABLE</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">position</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">try_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">position</span><span class="o">..</span><span class="p">])</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="241310811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241310811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241310811">(Jun 02 2021 at 19:53)</a>:</h4>
<p>Yeah! If I'm understanding that correctly, something like that would indeed work. The issue is exactly that <code>buf</code>, or the thing you're writing to, needs to be able to suspend the computation itself if there isn't enough capacity.</p>



<a name="241311790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241311790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241311790">(Jun 02 2021 at 20:00)</a>:</h4>
<p>But I don't see how <code>&amp;mut [u8]</code> could ever implement such a trait in a manner you'd like. That is, the <code>AsyncRead</code> trait would need to change.</p>



<a name="241311995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241311995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241311995">(Jun 02 2021 at 20:02)</a>:</h4>
<p>This is where the "smarter <code>buf</code>" part comes in. Somehow you want to suspend the computation when you're out of capacity, swap the underlying buffer, and then resume the computation.</p>



<a name="241326252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241326252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241326252">(Jun 02 2021 at 22:08)</a>:</h4>
<p><span class="user-mention" data-user-id="326186">@Sergio</span> I think it's fine to change the <code>AsyncRead</code> trait, and indeed I'm assuming some changes, but I don't quite understand what you are saying about the role of a "smarter buf"</p>



<a name="241326287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241326287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241326287">(Jun 02 2021 at 22:08)</a>:</h4>
<p>can you maybe sketch out the pseudo-code of what you <em>wish</em> you could do?</p>



<a name="241326295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241326295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241326295">(Jun 02 2021 at 22:08)</a>:</h4>
<p>and/or show me how it might work in C# :)</p>



<a name="241329985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241329985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241329985">(Jun 02 2021 at 22:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> The small snippet I pasted before is an example, but here's an even smaller one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="nc">Cursor</span><span class="o">&lt;</span><span class="n">Cow</span><span class="o">&lt;'</span><span class="nb">static</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="nc">Cursor</span><span class="o">&lt;</span><span class="n">Cow</span><span class="o">&lt;'</span><span class="nb">static</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">AsyncRead</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">poll_read</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">ReadBuf</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b":"</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="241330165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241330165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241330165">(Jun 02 2021 at 22:59)</a>:</h4>
<p>The ideal semantics would be:</p>
<ul>
<li>A <code>read_to_end</code> of <code>Event</code> would read the equivalent of the contents of <code>buf</code> after <code>write!(buf, "{}:{}", self.name, b":", self.value);</code>. In fact, this is what I would <em>really</em> love to be able to write. Such an implementation is within grasp if the above can be written, of course.</li>
<li><code>write_all</code> writes into <code>buf</code> incrementally. If there is one byte of capacity available in <code>buf</code>, 1 byte is written, if two, two, and so on.</li>
</ul>



<a name="241330413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241330413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241330413">(Jun 02 2021 at 23:02)</a>:</h4>
<p>Any future that's returned by <code>write_all</code> is going to store <code>buf</code>, necessarily, so it can write to it. As it is today, in <code>tokio</code> <em>and</em> <code>futures</code>, that <code>buf</code> points to a concrete backing slice. As soon as that slice is filled, there's no way for the future to say: "hey, go get me another backing slice, I'm done with this one, and then continue right at this point."</p>



<a name="241330521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241330521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241330521">(Jun 02 2021 at 23:03)</a>:</h4>
<p>I'm not sure you can do this in C#. Maybe full call/cc semantics <em>would</em> allow you to implement this, however.</p>



<a name="241330916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241330916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241330916">(Jun 02 2021 at 23:08)</a>:</h4>
<p>But my thinking was more along the lines of a <code>ReadBuf</code> that is able to return a special future that can swap out it's backing buffer when the current one fills up, waiting for said buffer to become available.</p>



<a name="241331302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241331302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241331302">(Jun 02 2021 at 23:13)</a>:</h4>
<p>Here's a real-world implementation of a slightly fancier <code>Event</code> today: <a href="https://github.com/SergioBenitez/Rocket/blob/f1ecb79a7ea536bacc7b7e92d33bf5406c0c635f/core/lib/src/response/stream/raw_sse.rs#L184-L231">https://github.com/SergioBenitez/Rocket/blob/f1ecb79a7ea536bacc7b7e92d33bf5406c0c635f/core/lib/src/response/stream/raw_sse.rs#L184-L231</a></p>



<a name="241337146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241337146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241337146">(Jun 03 2021 at 00:41)</a>:</h4>
<p>Is that meant to be awaiting writing into the <code>ReadBuf</code>? It's usually going to have a fixed sized, and so if there isn't room, those <code>write_all().await</code> would never work (or would error on a short-write)</p>



<a name="241337347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241337347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sergio <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241337347">(Jun 03 2021 at 00:45)</a>:</h4>
<p>Yeah, that's exactly my point! :)</p>



<a name="241337673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async-foundations/topic/%22inline%22%20async%20fn%20in%20traits/near/241337673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean McArthur <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async-foundations/topic/.22inline.22.20async.20fn.20in.20traits.html#241337673">(Jun 03 2021 at 00:51)</a>:</h4>
<p>Well then, I did the silly thing and just read the code and went <em>woah is someone wrong on the internet?!</em></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>