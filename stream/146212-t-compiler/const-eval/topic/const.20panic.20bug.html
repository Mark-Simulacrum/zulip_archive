<html>
<head><meta charset="utf-8"><title>const panic bug · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html">const panic bug</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260556198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260556198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260556198">(Nov 07 2021 at 05:50)</a>:</h4>
<p><code>#![feature(const_panic)]</code> was stabilized in <a href="https://github.com/rust-lang/rust/issues/89508">#89508</a>. However, <code>core::panicking::panic</code> is not <code>const</code>, causing anything like <code>assert!</code> fails (like in <a href="https://github.com/rust-lang/rust/issues/89542">#89542</a>). I recall a hack being used to determine if evaluation was at compile time or runtime. Given that <code>panic_fmt</code> is <em>not</em> being stabilized, there's no need to stabilize <code>Arguments::new_v1</code> as <code>const</code>. That said, something still has to be done — I believe along the lines of the aforementioned hack. There is <code>const_panic_fmt</code>, which <a href="https://github.com/rust-lang/rust/blob/223f58085aacb586c06c7dbfaa60b85c1b1f1da4/compiler/rustc_const_eval/src/const_eval/machine.rs#L66">appears to be</a> called any time <code>panic_fmt</code> is called during const eval. If that's the case, should I slap <code>#[rustc_do_not_const_check]</code> on <code>core::panicking::panic</code> in the same manner as  <code>core::panicking::panic_fmt</code>? If not, what should be done?</p>



<a name="260556204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260556204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260556204">(Nov 07 2021 at 05:50)</a>:</h4>
<p>This will need to be backported given that <code>const_panic</code> is already in beta.</p>



<a name="260556380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260556380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260556380">(Nov 07 2021 at 05:56)</a>:</h4>
<p>Putting <code>#[rustc_do_not_const_check]</code> does resolve the error as expected, but I'm not sure if it's correct.</p>



<a name="260556734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260556734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260556734">(Nov 07 2021 at 06:05)</a>:</h4>
<p>Interestingly, it looks like this only affects rustc &amp; stdlib. User code (code without stability attributes) has no issue handling this.</p>



<a name="260568742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260568742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260568742">(Nov 07 2021 at 11:30)</a>:</h4>
<p>I would check with Mara - we've not yet migrated std/core to 2021 which means they're using older macros for panicking, maybe we missed a stabilization somewhere?</p>



<a name="260568847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260568847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260568847">(Nov 07 2021 at 11:32)</a>:</h4>
<p>It seems suspicious that we only hit this now, since I'm pretty sure there's asserts in at least some compiler and std const code, though maybe I'm misremembering</p>



<a name="260569077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260569077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260569077">(Nov 07 2021 at 11:39)</a>:</h4>
<p>If this only affects std, it probably doesn't <em>require</em> a backport, right?</p>



<a name="260569710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260569710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260569710">(Nov 07 2021 at 11:55)</a>:</h4>
<p>Hm so it looks like it's hitting the wrong branch in panic_2015 which isn't yet intended to be stable</p>



<a name="260570009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260570009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260570009">(Nov 07 2021 at 12:01)</a>:</h4>
<p>I have changed <code>core::panicking::panic</code> to const in <a href="https://github.com/rust-lang/rust/issues/90273">#90273</a></p>



<a name="260583856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260583856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260583856">(Nov 07 2021 at 16:47)</a>:</h4>
<p>I'm the one who stabilized const panic initially — I <strong>definitely</strong> missed something here as assertions were supposed to be permitted. I couldn't figure out why <a href="https://github.com/rust-lang/rust/issues/89542">#89542</a> was failing at first, but it turns out that's why.</p>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> I was able to reproduce this on master as of last night, so that apparently wasn't sufficient.</p>
<p>cc <span class="user-mention" data-user-id="310399">@Mara</span></p>



<a name="260583919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260583919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260583919">(Nov 07 2021 at 16:48)</a>:</h4>
<p>I do think this should be backported even if it only affects std. Other internal things have been in the past to my knowledge. It seems odd that we would knowingly let a bug hit stable.</p>



<a name="260584123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260584123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260584123">(Nov 07 2021 at 16:52)</a>:</h4>
<p>Also, iirc from last night this occurred regardless of edition in use</p>



<a name="260585663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260585663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260585663">(Nov 07 2021 at 17:22)</a>:</h4>
<p>I think it's just std thing that require const unstable to be used by const unstable only.</p>



<a name="260585744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260585744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260585744">(Nov 07 2021 at 17:23)</a>:</h4>
<p>Maybe we need to slap const stable attributes to some of these panic functions?</p>



<a name="260587789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260587789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260587789">(Nov 07 2021 at 18:03)</a>:</h4>
<p><code>Arguments::new_v1</code> can be made const and is internal, so that's a non-issue to do. <code>fn panic</code> is not and calls <code>panic_fmt</code>, hence my hesitancy. I <em>think</em> const eval will hook into the latter's call from <code>panic</code> due to the changes you made, but I wasn't confident enough to mark that "do not check" as well.</p>



<a name="260609546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260609546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260609546">(Nov 08 2021 at 02:35)</a>:</h4>
<p>I had a look at the const checking code and I don't think <code>rustc_do_not_const_check</code> have any implication  on const stability.</p>



<a name="260609571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260609571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260609571">(Nov 08 2021 at 02:35)</a>:</h4>
<p>It's just <code>begin_panic_fn</code> and <code>panic_display</code> are hooked and cause early return so the const stability checking is skipped.</p>



<a name="260610322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260610322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260610322">(Nov 08 2021 at 02:52)</a>:</h4>
<p>Apply this patch and it should build fine:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/library/core/src/lib.rs b/library/core/src/lib.rs</span>
<span class="gh">index 5f44087cabb..4b279377b30 100644</span>
<span class="gd">--- a/library/core/src/lib.rs</span>
<span class="gi">+++ b/library/core/src/lib.rs</span>
<span class="gu">@@ -158,6 +158,7 @@</span>
 #![feature(const_precise_live_drops)]
 #![feature(const_raw_ptr_deref)]
 #![feature(const_refs_to_cell)]
<span class="gi">+#![feature(core_panic)]</span>
 #![feature(decl_macro)]
 #![feature(doc_cfg)]
 #![feature(doc_notable_trait)]
<span class="gh">diff --git a/library/core/src/panicking.rs b/library/core/src/panicking.rs</span>
<span class="gh">index 29124c87e1b..682a85ef828 100644</span>
<span class="gd">--- a/library/core/src/panicking.rs</span>
<span class="gi">+++ b/library/core/src/panicking.rs</span>
<span class="gu">@@ -36,6 +36,7 @@</span>
 #[cfg_attr(not(feature = "panic_immediate_abort"), inline(never))]
 #[cfg_attr(feature = "panic_immediate_abort", inline)]
 #[track_caller]
<span class="gi">+#[rustc_const_unstable(feature = "core_panic", issue = "none")]</span>
 #[lang = "panic"] // needed by codegen for panic on overflow and other `Assert` MIR terminators
 pub const fn panic(expr: &amp;'static str) -&gt; ! {
     // Use Arguments::new_v1 instead of format_args!("{}", expr) to potentially
<span class="gu">@@ -50,6 +51,7 @@ pub const fn panic(expr: &amp;'static str) -&gt; ! {</span>
 #[inline]
 #[track_caller]
 #[lang = "panic_str"] // needed for `non-fmt-panics` lint
<span class="gi">+#[rustc_const_unstable(feature = "core_panic", issue = "none")]</span>
 pub const fn panic_str(expr: &amp;str) -&gt; ! {
     panic_display(&amp;expr);
 }
</code></pre></div>



<a name="260610796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260610796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260610796">(Nov 08 2021 at 03:03)</a>:</h4>
<p>Alright. I'll give that a shot tonight and send a PR if it works. Thanks for investigating.</p>



<a name="260616776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260616776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260616776">(Nov 08 2021 at 05:29)</a>:</h4>
<p>Was there a specific case you found the attribute on <code>panic_str</code> was necessary? I tested a patch with only the addition of the feature gate and unstable attribute on <code>panic</code> and all UI tests pass (including a new one testing this specific behavior)</p>



<a name="260618907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260618907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260618907">(Nov 08 2021 at 06:20)</a>:</h4>
<p>Created <a href="https://github.com/rust-lang/rust/issues/90687">#90687</a> to fix this.</p>



<a name="260669567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260669567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260669567">(Nov 08 2021 at 15:10)</a>:</h4>
<p><code>panic!({"str"})</code></p>



<a name="260669682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260669682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260669682">(Nov 08 2021 at 15:11)</a>:</h4>
<p>We don't do that in std, so it shouldn't really matter; I add it for symmetry only.</p>



<a name="260695622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260695622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260695622">(Nov 08 2021 at 18:04)</a>:</h4>
<p>Meh, I'll add it in later today just in case. That said, why don't you think this should be backported?</p>



<a name="260715656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260715656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260715656">(Nov 08 2021 at 20:39)</a>:</h4>
<p>Why should it be?</p>



<a name="260715668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260715668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260715668">(Nov 08 2021 at 20:39)</a>:</h4>
<p>You don't need to backport to use it.</p>



<a name="260716600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260716600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260716600">(Nov 08 2021 at 20:47)</a>:</h4>
<p>Maybe I should've checked that haha. It makes sense. If so I'll remove the backport request from the PR message.</p>



<a name="260725883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260725883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260725883">(Nov 08 2021 at 22:07)</a>:</h4>
<p>Turns out that unstable attribute isn't necessary, even for stdlib. Ironically adding it <em>introduces</em> an error. Either way I've added it as an explicit test</p>



<a name="260741350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260741350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260741350">(Nov 09 2021 at 00:58)</a>:</h4>
<p>Oh you are right, it isn't currently needed.</p>



<a name="260741365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20panic%20bug/near/260741365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20panic.20bug.html#260741365">(Nov 09 2021 at 00:58)</a>:</h4>
<p>I only need it locally because I am basing on my PR which removes special treatment of panic_str.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>