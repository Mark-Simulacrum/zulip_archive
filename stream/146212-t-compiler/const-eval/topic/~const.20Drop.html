<html>
<head><meta charset="utf-8"><title>~const Drop · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html">~const Drop</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265672514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265672514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265672514">(Dec 21 2021 at 11:02)</a>:</h4>
<p>There is a very relevant difference between <code>T: ~const Drop</code> bounds and <code>T: Drop</code>. The latter means that there is a user written <code>Drop</code> impl for that type. The bound will not hold for types like <code>String</code> which just have a field that impls drop manually.</p>
<p><code>~const Drop</code> on the other hand holds for all types that satisfy one of the following:</p>
<ul>
<li>have no <code>Drop</code> impl or drop glue (meaning this condition is also true for all fields, recursively)</li>
<li>have an <code>impl const Drop</code></li>
<li>have drop glue, but all fields satisfy one of these three rules</li>
</ul>
<p>This requires some fancy handling, the latest of which is <a href="https://github.com/rust-lang/rust/pull/92149">https://github.com/rust-lang/rust/pull/92149</a></p>
<p>I'm wondering if it would make sense to desugar <code>~const Drop</code> to some completely different predicate that is specially crafted for upholding these rules. We could create a libcore-private lang  item trait (<code>DropGlueish</code>) that we replace all uses of <code>~const Drop</code> with (as <code>~const DropGlueish</code>). Then there should be no more confusion with <code>Drop</code> within the trait solver.</p>
<p>Thoughts? <span class="user-mention" data-user-id="361356">@fee1-dead</span></p>



<a name="265674056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265674056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265674056">(Dec 21 2021 at 11:20)</a>:</h4>
<p>Yes, that is what I meant when I wrote the short comment on that PR.</p>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/~const.20Drop/near/265672514">said</a>:</p>
<blockquote>
<ul>
<li>have drop glue, but all fields satisfy one of these three rules</li>
</ul>
</blockquote>
<p>This is probably not correct. Here are the exact semantics: (to me)</p>
<p>To prove that <code>T: ~const Drop</code>, one needs to either </p>
<ol>
<li>prove <code>T: Copy</code>, or</li>
<li>prove that <code>T: !Drop</code>(i.e. no explicit non-const drop impl) <strong>and</strong> all of its recursive fields types satisfy <code>~const Drop</code>.</li>
</ol>
<p>Whether a type has <code>impl const Drop</code> does not matter because it doesn't remove the drop glues.</p>



<a name="265677292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265677292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265677292">(Dec 21 2021 at 12:01)</a>:</h4>
<p>Oh lol, I did not see your comment. Sorry yea, good thing we both came to the same conclusion independently.</p>



<a name="265677454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265677454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265677454">(Dec 21 2021 at 12:03)</a>:</h4>
<p>Yes, your formulation is simpler and easier to implement. Mine is roundabout, but I think still results in the same behaviour?</p>



<a name="265913357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265913357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265913357">(Dec 23 2021 at 12:49)</a>:</h4>
<blockquote>
<p><code>have an impl const Drop</code></p>
</blockquote>
<p>that's not sufficient on its own, right? additionally all fields also need to be <code>~const Drop</code></p>



<a name="265913424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265913424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265913424">(Dec 23 2021 at 12:50)</a>:</h4>
<p>basically the bound means that the (auto-generated) drop_in_place for this type could be a const fn</p>



<a name="265913453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265913453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265913453">(Dec 23 2021 at 12:51)</a>:</h4>
<blockquote>
<p>prove that T: !Drop(i.e. no explicit non-const drop impl)</p>
</blockquote>
<p>so that's what <code>!Drop</code> means? this is confusing, I would expect <code>!Drop</code> means there is <em>no</em> <code>impl Drop</code> for this type, const or otherwise</p>



<a name="265915723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265915723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265915723">(Dec 23 2021 at 13:21)</a>:</h4>
<p>I didn't propose that meaning of <code>!Drop</code>, I just used it because I thought it was straightforward...</p>



<a name="265915829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265915829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265915829">(Dec 23 2021 at 13:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/~const.20Drop/near/265913357">said</a>:</p>
<blockquote>
<blockquote>
<p><code>have an impl const Drop</code></p>
</blockquote>
<p>that's not sufficient on its own, right? additionally all fields also need to be <code>~const Drop</code></p>
</blockquote>
<p>Yes, which is why I thought his formulation was incorrect</p>



<a name="265915996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265915996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265915996">(Dec 23 2021 at 13:25)</a>:</h4>
<p>Ah.. yea, the <code>impl const Drop</code> should error at the impl site if the fields don't also all hold <code>~const Drop</code>. That's why knowing there's a <code>const Drop</code> impl needs no further recursive checking</p>



<a name="265916757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265916757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265916757">(Dec 23 2021 at 13:35)</a>:</h4>
<p>That sounds like too much magic. It is perfectly fine for a type to implement <code>const Drop</code> while having non-const drop glue. For example, generic types. If we decided that <code>impl const Drop</code> had the requirements, then it actually causes pain for generic code :<code>impl&lt;T: ~const Drop&gt; const Drop for Foo</code></p>



<a name="265919141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265919141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265919141">(Dec 23 2021 at 14:03)</a>:</h4>
<p>If you already have a Foo&lt;T&gt; type that you have to manually impl Drop glue for, one extra bound doesn't seem like a big deal. It's not as good as "automatically" solving it or whatever, but it's a very small ask on the user.</p>



<a name="265919754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265919754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265919754">(Dec 23 2021 at 14:10)</a>:</h4>
<p>I prefer special casing <code>~const Drop</code> in trait system logic over this, because this special cases checking validity of const impls of <code>Drop</code>, and it doesn't remove the need to special case it in trait system logic. It's probably unnecessary complexity.</p>



<a name="265924339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265924339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265924339">(Dec 23 2021 at 15:04)</a>:</h4>
<p>We already have such magic in impls for <code>impl Copy for Type</code>. The impl itself errors if any of <code>Type</code>'s fields are <code>!Copy</code>. But I see the point that <code>Drop</code> is more special, as it can't have more bounds than the type declaration</p>



<a name="265924433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265924433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265924433">(Dec 23 2021 at 15:05)</a>:</h4>
<p>Seems kind of bad though if you get an error about a drop impl not being <code>const</code> even though it is declared as such, especially since the error will mention private fields and types that may be a few crates removed</p>



<a name="265924647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265924647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265924647">(Dec 23 2021 at 15:07)</a>:</h4>
<p>At least for non generic fields we should check it at the impl site. Now about generic fields.... I feel like there's a footgun here, i'll try to draft an example of what I'm thinking</p>



<a name="265927886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265927886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265927886">(Dec 23 2021 at 15:44)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=1a5f79b63bda64cbed3409e62ef00c4e">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=1a5f79b63bda64cbed3409e62ef00c4e</a> shows that you can observe how a generic parameter is used inside the type. This basically makes <code>~const Drop</code> a new marker trait that is magic like <code>Send</code> is. Not saying this isn't how we should do it, as it is convenient for users, but it may be a new thing library authors need to be aware of from now on.</p>



<a name="265932275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265932275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265932275">(Dec 23 2021 at 16:38)</a>:</h4>
<p>Can't you already observe how generic parameters are used even on <strong>stable</strong>?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// upstream</span>
<span class="k">struct</span> <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">std</span>::<span class="n">marker</span>::<span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// user crate</span>
<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="c1">// later changed to..</span>

<span class="k">struct</span> <span class="nc">BarNew</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// user's code now BREAKS 🤯</span>
<span class="c1">//</span>
<span class="c1">// const fn bar_&lt;T&gt;(_: BarNew&lt;T&gt;) {}</span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=1a5f79b63bda64cbed3409e62ef00c4e">play</a></p>



<a name="265933117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265933117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265933117">(Dec 23 2021 at 16:49)</a>:</h4>
<p>Oh wow...</p>



<a name="265933283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265933283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265933283">(Dec 23 2021 at 16:51)</a>:</h4>
<p>I did not know this. That is surprising to me, but obvious when considering how <code>needs_drop</code> works</p>



<a name="265933462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/~const%20Drop/near/265933462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/~const.20Drop.html#265933462">(Dec 23 2021 at 16:53)</a>:</h4>
<p>I guess we should make the diagnostic on your example explain this...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>