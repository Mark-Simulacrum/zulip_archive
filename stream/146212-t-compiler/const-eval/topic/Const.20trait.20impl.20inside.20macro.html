<html>
<head><meta charset="utf-8"><title>Const trait impl inside macro · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html">Const trait impl inside macro</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255880115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255880115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> chocolate <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255880115">(Oct 02 2021 at 15:59)</a>:</h4>
<p>Hello. I was wondering if someone could help me figure out why the following does not compile: </p>
<div class="codehilite"><pre><span></span><code>#![feature(const_mut_refs)]
#![feature(const_fn_trait_bound)]
#![feature(const_trait_impl)]

pub struct Test&lt;T&gt;(T);

// This does not work:
macro_rules! impl_copy_clone {
    () =&gt; (
        impl&lt;T: Copy&gt; const Copy for Test&lt;T&gt; {}

        impl&lt;T: Copy + Clone&gt; const Clone for Test&lt;T&gt; {
            fn clone(&amp;self) -&gt; Self {
                Self(self.0)
            }

            fn clone_from(&amp;mut self, source: &amp;Self) {
                *self = source.clone()
            }
        }
    )
}

impl_copy_clone!();

// This works:

impl&lt;T: Copy&gt; const Copy for Test&lt;T&gt; {}

impl&lt;T: Copy + Clone&gt; const Clone for Test&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        Self(self.0)
    }

    fn clone_from(&amp;mut self, source: &amp;Self) {
        *self = source.clone()
    }
}
</code></pre></div>
<p>It gives the following error:</p>
<div class="codehilite"><pre><span></span><code>   |
12 | /         impl&lt;T: Copy + Clone&gt; const Clone for Test&lt;T&gt; {
13 | |             fn clone(&amp;self) -&gt; Self {
14 | |                 Self(self.0)
15 | |             }
...  |
19 | |             }
20 | |         }
   | |_________^
...
24 |   impl_copy_clone!();
   |   ------------------- in this macro invocation
   |
   = note: `clone_from` not implemented
</code></pre></div>
<p>Link to Rust playground: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=0b1e69165fc36765d4063b0edca2adae">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=0b1e69165fc36765d4063b0edca2adae</a></p>



<a name="255882470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255882470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255882470">(Oct 02 2021 at 16:39)</a>:</h4>
<p>We don't support default implementations of trait methods properly. You need to implement all methods, even ones with a default body</p>



<a name="255882554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255882554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255882554">(Oct 02 2021 at 16:40)</a>:</h4>
<p>No, this is related to Ident being used instead of Symbol to compare method names.</p>



<a name="255882559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255882559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255882559">(Oct 02 2021 at 16:40)</a>:</h4>
<p>Working on a fix now</p>



<a name="255882580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255882580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> chocolate <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255882580">(Oct 02 2021 at 16:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Const.20trait.20impl.20inside.20macro/near/255882470">said</a>:</p>
<blockquote>
<p>We don't support default implementations of trait methods properly. You need to implement all methods, even ones with a default body</p>
</blockquote>
<p>That's what I am doing. I am implementing the default method also.</p>



<a name="255882605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255882605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255882605">(Oct 02 2021 at 16:41)</a>:</h4>
<p>Oh, yea sorry, didn't read the code properly.</p>



<a name="255882942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255882942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> chocolate <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255882942">(Oct 02 2021 at 16:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Const.20trait.20impl.20inside.20macro/near/255882559">said</a>:</p>
<blockquote>
<p>Working on a fix now</p>
</blockquote>
<p>Great! Is there a git issue I can follow?</p>



<a name="255887478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20trait%20impl%20inside%20macro/near/255887478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20trait.20impl.20inside.20macro.html#255887478">(Oct 02 2021 at 18:04)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/89471">#89471</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>