<html>
<head><meta charset="utf-8"><title>Const procedural macros · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html">Const procedural macros</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253864700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253864700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253864700">(Sep 18 2021 at 12:21)</a>:</h4>
<p>Hey, I don’t know if this has been brought up before (I didn’t see an issue on the const-eval repo). But have people thought about using <code>const</code> for procedural macros?</p>
<p>This is blocked on things like const heap alloc, but I was thinking down the the road it could be nice. Since if it could be evaluated by miri, then it can be in a regular crate right? It would also allow you to use non-FFI safe types like Result in procedural macro signatures. You could do more interesting things like having traits for the different kinds macros, for example: imagine if implementing a derive looked like this.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// core::derive</span>
<span class="k">trait</span><span class="w"> </span><span class="n">Derive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">derive</span><span class="p">(</span><span class="n">stream</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">TokenStream</span><span class="p">,</span><span class="w"> </span><span class="n">CompilerError</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Derive</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Clone</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">derive</span><span class="p">(</span><span class="n">stream</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">TokenStream</span><span class="p">,</span><span class="w"> </span><span class="n">CompilerError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_macro_input</span><span class="o">!</span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">syn</span>::<span class="n">DeriveInput</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">quote</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Generate Clone impl...</span>
<span class="w">    </span><span class="p">}.</span><span class="n">into</span><span class="p">())</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253864874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253864874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253864874">(Sep 18 2021 at 12:23)</a>:</h4>
<p>We don't need procedural macro signatures to be ffi safe today already?</p>



<a name="253865097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865097">(Sep 18 2021 at 12:26)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Result is FFI safe? I always assumed proc macros were <code>fn (TokenStream) -&gt; TokenStream</code>, because they couldn’t have Result.</p>



<a name="253865110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865110">(Sep 18 2021 at 12:27)</a>:</h4>
<p>Result isn't FFI safe, but proc macros don't need to be</p>



<a name="253865125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865125">(Sep 18 2021 at 12:27)</a>:</h4>
<p>we already have custom serialization/deserialization code for all proc macro calls / APIs that passes things over ffi in safe way</p>



<a name="253865217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865217">(Sep 18 2021 at 12:29)</a>:</h4>
<p>I mean, now I’m more curious why it’s not Result. It’s a bit annoying that proc macro error handling is different from everything else.</p>



<a name="253865438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865438">(Sep 18 2021 at 12:33)</a>:</h4>
<p>Either way, the  main benefit would still be being able to put everything in one crate and avoiding the triangle of crates I run into today of <code>crate</code>, <code>crate-macros</code>, and <code>crate-shared</code> when I have code I want to share between macros and the runtime, such as string parsing code.</p>



<a name="253865525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865525">(Sep 18 2021 at 12:35)</a>:</h4>
<p>One issue is type checking, this would need to determine the macros with type checking... which affects macro expansion, which affects type checking.</p>



<a name="253865644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865644">(Sep 18 2021 at 12:37)</a>:</h4>
<p>(It also pushes macro expansion later)</p>



<a name="253865728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865728">(Sep 18 2021 at 12:38)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> That’s a good point about type checking, how would it push macro expansion later?</p>



<a name="253865826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253865826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253865826">(Sep 18 2021 at 12:40)</a>:</h4>
<p>It seems like it would push macro expansion closer to codegen, sometime after monomorphization. Although I guess this might not be a fundamental problem.</p>



<a name="253875070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253875070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253875070">(Sep 18 2021 at 15:19)</a>:</h4>
<p>hold up. there's two things being mixed here.</p>
<ol>
<li>defining a proc macro in a crate that also uses said proc macro</li>
<li>running proc macros in CTFE (or maybe simply in miri)</li>
</ol>



<a name="253875165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253875165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253875165">(Sep 18 2021 at 15:21)</a>:</h4>
<p>the latter is straight forward (but not simple) to do, and if we use miri instead of CTFE we already got everything like heap, files and stuff working and can nicely sandbox it. The miri thing is the same idea as just doing it by compiling the proc macro to wasm and running that.</p>



<a name="253875509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253875509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253875509">(Sep 18 2021 at 15:27)</a>:</h4>
<p>defining proc macros inline is slightly more involved. Especially defining them in libcore XD. I mean... do we keep two separate dependency graphs for inline proc macros and the actual crate? Otherwise you can't have a heap in libcore as you don't have Box or Vec. If we keep two separate dependency graphs... what is the libcore of the proc macro? the one rustc was built with? Are we using proc macros in libcore today? It seems to me like that would be a first intermediate step</p>



<a name="253875569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253875569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253875569">(Sep 18 2021 at 15:28)</a>:</h4>
<p>As a less confusing example: How would you handle the heap in such proc macros for targets that have no liballoc?</p>



<a name="253875591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253875591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253875591">(Sep 18 2021 at 15:29)</a>:</h4>
<p>we'd have to fall back to using the host. But now you're mixing host code and target code in one crate. I don't know if we can possibly keep that sane</p>



<a name="253878594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253878594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253878594">(Sep 18 2021 at 16:22)</a>:</h4>
<p>don't proc macros always run on the host using host code?</p>



<a name="253879046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253879046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253879046">(Sep 18 2021 at 16:31)</a>:</h4>
<p>They wouldn't when if const proc macros were to be introduced.</p>



<a name="253883625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253883625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253883625">(Sep 18 2021 at 17:53)</a>:</h4>
<p>but the host is doing the compiling, and the proc macro must be fully compiled and executed before the overall compilation is done. Even if it's const, the host is still doing it.</p>



<a name="253890868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253890868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253890868">(Sep 18 2021 at 20:10)</a>:</h4>
<p>Sure, but in case of const proc macro, the proc macro is part of the crate that uses it AFAIUI. This crate will be compiled for the target and not host when it isn't used by a build script.</p>



<a name="253891062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253891062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253891062">(Sep 18 2021 at 20:14)</a>:</h4>
<p>Probably off topic, but why are proc macro crates set up like this? It seems like they should be compile time only and should not cause a literal crate dependency that could cause proc macro code to get linked in with stuff compiled for the target</p>



<a name="253891175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253891175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253891175">(Sep 18 2021 at 20:17)</a>:</h4>
<p>They don't get linked with target crates, Cargo knows that they're proc macro crates and only builds them for the host</p>



<a name="253891258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253891258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253891258">(Sep 18 2021 at 20:18)</a>:</h4>
<p>is that the same distinction as <code>dependencies</code> vs <code>dev-dependencies</code>?</p>



<a name="253891286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253891286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253891286">(Sep 18 2021 at 20:18)</a>:</h4>
<p>because IIRC proc macro crates look like regular dependencies in the Cargo.toml file</p>



<a name="253892028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253892028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253892028">(Sep 18 2021 at 20:32)</a>:</h4>
<p>Cargo does this automatically for proc macros</p>



<a name="253892048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253892048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253892048">(Sep 18 2021 at 20:32)</a>:</h4>
<p><code>dev-dependencies</code> get built for the target, so it's not the same thing</p>



<a name="253892060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253892060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253892060">(Sep 18 2021 at 20:33)</a>:</h4>
<p><code>build-dependencies</code> get built for the host, so it's closer to that</p>



<a name="253895300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253895300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253895300">(Sep 18 2021 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Const.20procedural.20macros/near/253883625">said</a>:</p>
<blockquote>
<p>but the host is doing the compiling, and the proc macro must be fully compiled and executed before the overall compilation is done. Even if it's const, the host is still doing it.</p>
</blockquote>
<p>Const eval is executed as target though. If you are crossing from 64-bit host to 32-bit target, then in const eval <code>size_of::&lt;usize&gt;()</code> is 4, but in proc macro <code>size_of::&lt;usize&gt;()</code> is 8.</p>



<a name="253895872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253895872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253895872">(Sep 18 2021 at 21:46)</a>:</h4>
<p>I don't think there is any contradiction here, because of the two "meta-levels" involved. Inside the proc macro, <code>size_of::&lt;usize&gt;()</code> evaluates to 8, but you can construct a <code>TokenTree</code> representing <code>"size_of::&lt;usize&gt;()"</code> and that will eventually be compiled as target and evaluate to 4</p>



<a name="253895904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253895904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253895904">(Sep 18 2021 at 21:47)</a>:</h4>
<p>although maybe I'm missing a subtlety about what is "const" in this proposal</p>



<a name="253912939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253912939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253912939">(Sep 19 2021 at 03:21)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> I think you have it, at least that’s how I would expect it to work, but I think that does show that having it in one crate is a bit of a double-edged sword. For example; the following might not behave like you expect.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">PTR_SIZE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">derive</span><span class="p">(</span><span class="n">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// 4 or 8?</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253913077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253913077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253913077">(Sep 19 2021 at 03:24)</a>:</h4>
<p>I don't know whether that is the sort of thing that people will guess wrong and cause bugs, but I would hope that that returns 8. Everything in and upstream of a proc macro crate should be relative to the host parameters</p>



<a name="253913123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253913123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253913123">(Sep 19 2021 at 03:25)</a>:</h4>
<p>Is it possible for the downstream crate to use <code>PTR_SIZE</code>? Or does cargo's proc-macro handling mean that functions and constants are not really linked in or available</p>



<a name="253913481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253913481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253913481">(Sep 19 2021 at 03:32)</a>:</h4>
<p>Ah...</p>
<div class="codehilite"><pre><span></span><code>error: `proc-macro` crate types currently cannot export any items other than functions tagged with `#[proc_macro]`, `#[proc_macro_derive]`, or `#[proc_macro_attribute]`
  --&gt; bar/src/lib.rs:16:1
   |
16 | pub const FOO: usize = std::mem::size_of::&lt;usize&gt;();
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre></div>



<a name="253941253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Const%20procedural%20macros/near/253941253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Const.20procedural.20macros.html#253941253">(Sep 19 2021 at 12:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Const.20procedural.20macros/near/253913123">said</a>:</p>
<blockquote>
<p>Is it possible for the downstream crate to use <code>PTR_SIZE</code>? Or does cargo's proc-macro handling mean that functions and constants are not really linked in or available</p>
</blockquote>
<p>The way you do that today is you have to a third regular crate that exposes all of your shared code between proc-macros and regular code, that you depend on in both <code>crate</code> and <code>crate-macros</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>