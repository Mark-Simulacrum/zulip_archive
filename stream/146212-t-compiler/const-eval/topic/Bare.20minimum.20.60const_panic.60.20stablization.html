<html>
<head><meta charset="utf-8"><title>Bare minimum `const_panic` stablization · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html">Bare minimum `const_panic` stablization</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252870367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252870367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252870367">(Sep 11 2021 at 00:56)</a>:</h4>
<p>The blocking concern of stabilising const panic in <a href="https://github.com/rust-lang/rust/issues/85194">#85194</a> is the edition 2021 difference. Given that there is <a href="https://github.com/rust-lang/rust/issues/86998">#86998</a>, would it make sense to stabilise the bare minimum of <code>const_panic</code>, aka <code>panic!(literal)</code> where the literal does not contain <code>{</code> or <code>}</code>? Stabilisation of <code>panic!(const_str)</code> or <code>panic!("{}", const_str)</code> could be deferred.</p>



<a name="252903594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252903594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252903594">(Sep 11 2021 at 11:42)</a>:</h4>
<p>I think we should just put in the work to get <code>panic!("{}", some_str)</code> working. It seems like it wouldn't really need that much more work to get working</p>



<a name="252913812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252913812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252913812">(Sep 11 2021 at 14:40)</a>:</h4>
<p>It would require ~const.</p>



<a name="252914370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252914370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252914370">(Sep 11 2021 at 14:51)</a>:</h4>
<p>actually it probably would just require a macro match arm to match on "{}" and convert that to just the some_str</p>



<a name="252914379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252914379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252914379">(Sep 11 2021 at 14:51)</a>:</h4>
<p>assuming some_str must also be a static string</p>



<a name="252920679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252920679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252920679">(Sep 11 2021 at 16:38)</a>:</h4>
<p>It's ok for literal</p>



<a name="252920682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252920682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252920682">(Sep 11 2021 at 16:38)</a>:</h4>
<p>But ~const is needed for computed strings</p>



<a name="252932281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932281">(Sep 11 2021 at 20:12)</a>:</h4>
<p>The <code>const_format</code> assertion macros need to be able to panic with a <code>&amp;'static str</code> non-literal constant,<br>
though that could be done with a function instead of the panic macro.<br>
It's a false dichotomy to say that it must be either "just literal panic messages" or "full support for compile-time formatting"</p>



<a name="252932486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932486">(Sep 11 2021 at 20:17)</a>:</h4>
<p>I don't think it's desirable to have additional functions just for panicking in const context.</p>



<a name="252932496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932496">(Sep 11 2021 at 20:17)</a>:</h4>
<p>We already have <code>panic_str</code>, but that should be the <em>temporary</em> solution.</p>



<a name="252932573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932573">(Sep 11 2021 at 20:18)</a>:</h4>
<p>I propose to just have <code>panic!(literal)</code> stabilised because it's better than nothing. We can still improve later and allow more types of const panic</p>



<a name="252932603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932603">(Sep 11 2021 at 20:19)</a>:</h4>
<p>isn't 2021 moving away from that though?</p>



<a name="252932609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932609">(Sep 11 2021 at 20:19)</a>:</h4>
<p>i thought that was the whole issue</p>



<a name="252932670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932670">(Sep 11 2021 at 20:20)</a>:</h4>
<p>Yes, so that's why I want to enforce that the literal does not contain { or }</p>



<a name="252932681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932681">(Sep 11 2021 at 20:20)</a>:</h4>
<p>Because we don't want to introduce things possible in 2015/18 but not in 2021.</p>



<a name="252932700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932700">(Sep 11 2021 at 20:21)</a>:</h4>
<p>would one be allowed to use {{ and }} like a normal format situation?</p>



<a name="252932725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932725">(Sep 11 2021 at 20:21)</a>:</h4>
<p>I would say it should be allowed in 2021, but not in 2018 (because it'll print {{}} verbatim rather than {}).</p>



<a name="252932849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932849">(Sep 11 2021 at 20:23)</a>:</h4>
<p>that can at least be explained to the public without feeling inconsistent</p>



<a name="252932867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252932867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252932867">(Sep 11 2021 at 20:23)</a>:</h4>
<p>My rough plan is to scan the first token of non-2021 <code>panic</code> invocation. If it's a literal that does not contain { or }, then forward it to <code>panic_2021</code> instead <code>panic_2015</code>. Then we could stabilise <code>const_panic</code> for panic_fmt but keep panic_str and panic_any still gated.</p>



<a name="252950440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252950440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252950440">(Sep 12 2021 at 02:03)</a>:</h4>
<p>Turns out this plan doesn't quite work, because panic_2015 has a <code>{...}</code> wrapper while panic_2021 doesn't. And that causes subtle difference: <a href="https://github.com/rust-lang/rust/issues/80846">#80846</a>.</p>



<a name="252950513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252950513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252950513">(Sep 12 2021 at 02:04)</a>:</h4>
<p>Could we just stabilise const panic only for Rust 2021 but not 2015/18?</p>



<a name="252950622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252950622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252950622">(Sep 12 2021 at 02:06)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="310399">@Mara</span> since you probably know the most about panic macros.</p>



<a name="252979850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252979850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252979850">(Sep 12 2021 at 11:28)</a>:</h4>
<p>yeah, only stabilizing it for rust 2021 is probably the easiest way to go</p>



<a name="252981753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/252981753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#252981753">(Sep 12 2021 at 12:05)</a>:</h4>
<p>(const panic for <code>panic!("literal")</code> already works in 2021, behind the feature gate)</p>



<a name="253072505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253072505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253072505">(Sep 13 2021 at 11:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization/near/252913812">said</a>:</p>
<blockquote>
<p>It would require ~const.</p>
</blockquote>
<p>we can cheat... knowing that compilation will fail anyway, we can just ignore const rules and evaluate any debug impl</p>



<a name="253113246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253113246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253113246">(Sep 13 2021 at 15:52)</a>:</h4>
<p>I wonder if a MCP is needed for that; it doesn't sound trivial to do and we likely need to add a machine for that</p>



<a name="253113443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253113443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253113443">(Sep 13 2021 at 15:53)</a>:</h4>
<p>Or at least modifying the current one by quite a lot, so that it doesn't use mir_for_ctfe and do all the checks etc.. It sounds a little bit more powerful than unleash miri.</p>



<a name="253155558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253155558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253155558">(Sep 13 2021 at 20:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization/near/253072505">said</a>:</p>
<blockquote>
<p>we can cheat... knowing that compilation will fail anyway, we can just ignore const rules and evaluate any debug impl</p>
</blockquote>
<p>I prototyped this idea and it doesn't seem to work well. Without having <code>const</code> and often not having <code>#[inline]</code>, many functions needed don't have MIR available.</p>



<a name="253223569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253223569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253223569">(Sep 14 2021 at 09:42)</a>:</h4>
<p>hmm... makes sense. Maybe we can convince T-libs and T-lang that impl const Display for &amp;str is something we could stabilize without stabilizing the feature</p>



<a name="253226435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253226435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253226435">(Sep 14 2021 at 10:10)</a>:</h4>
<p><code>impl Display for str</code> is implemented as <code>f.pad(self)</code>: <a href="https://github.com/rust-lang/rust/blob/9f85cd6f2ab2769c16e89dcdddb3e11d9736b351/library/core/src/fmt/mod.rs#L2124">https://github.com/rust-lang/rust/blob/9f85cd6f2ab2769c16e89dcdddb3e11d9736b351/library/core/src/fmt/mod.rs#L2124</a></p>
<p><code>Formatter::pad</code> is a non-trivial function calling many other functions: <a href="https://github.com/rust-lang/rust/blob/master/library/core/src/fmt/mod.rs#L1372-L1417">https://github.com/rust-lang/rust/blob/master/library/core/src/fmt/mod.rs#L1372-L1417</a></p>



<a name="253226578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253226578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253226578">(Sep 14 2021 at 10:11)</a>:</h4>
<p>none of which will get called if width and precision are <code>None</code>, which is why I would have thought the "just wing it" solution could work</p>



<a name="253226835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253226835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253226835">(Sep 14 2021 at 10:14)</a>:</h4>
<p>so <code>const Display</code> is likely out of scope, and we need to figure out how to make the writing to stderr that the panic does simpler in const contexts</p>



<a name="253226953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253226953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253226953">(Sep 14 2021 at 10:15)</a>:</h4>
<p>or, as long as we get <code>format_args!("{}", some_str)</code> to work in const contexts, we can make the panic logic in CTFE deconstruct the ArgumentV1 of the string and figure out how to print it itself.</p>



<a name="253226957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253226957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253226957">(Sep 14 2021 at 10:15)</a>:</h4>
<p>that may actually be the least hacky solution</p>



<a name="253257212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253257212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253257212">(Sep 14 2021 at 14:08)</a>:</h4>
<p>I often arrive at a solution where we add some sort of function <code>is_in_const_context</code> where when called at runtime we evaluate it to <code>false</code>, but when evaluated by the CTFE engine it returns <code>true</code>...</p>



<a name="253257341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253257341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253257341">(Sep 14 2021 at 14:09)</a>:</h4>
<p>It is so bad that it shouldn't even be exposed as a nightly feature...</p>



<a name="253258006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253258006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253258006">(Sep 14 2021 at 14:13)</a>:</h4>
<p>well.... we will need something like that <em>anyway</em> if we ever want to use SIMD or other stuff in libstd functions that should also be const fn</p>



<a name="253258082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253258082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253258082">(Sep 14 2021 at 14:13)</a>:</h4>
<p>there has been lots of discussion around "fast runtime path" vs "const fn path"</p>



<a name="253258193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253258193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253258193">(Sep 14 2021 at 14:14)</a>:</h4>
<p>and both co-existing for the same const fn, but only one getting picked depending on the caller context</p>



<a name="253258350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253258350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253258350">(Sep 14 2021 at 14:15)</a>:</h4>
<p><a href="https://github.com/rust-lang/const-eval/issues/7#issuecomment-576243335">https://github.com/rust-lang/const-eval/issues/7#issuecomment-576243335</a> is my idea for this</p>



<a name="253258559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253258559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253258559">(Sep 14 2021 at 14:16)</a>:</h4>
<p>it would also make it possible to "add" logging/tracing libraries to your const fn code</p>



<a name="253261831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253261831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253261831">(Sep 14 2021 at 14:35)</a>:</h4>
<p>I mean... technically we could add a magic generic parameter to all const fn that is <code>PhantomConst&lt;true&gt;</code> if in a const context and <code>PhantomConst&lt;false&gt;</code> otherwise. Then you can implement <code>const MyTrait for MyStruct&lt;PhantomConst&lt;true&gt;&gt;</code> and <code>MyTrait for MyStruct&lt;PhantomConst&lt;false&gt;&gt;</code>, and everything works out. If your impl is the same, you can do <code>impl&lt;const constness: bool&gt; const MyTrait for MyStruct&lt;PhantomConst&lt;constness&gt;&gt;</code> to cover both cases automatically.</p>



<a name="253261849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253261849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253261849">(Sep 14 2021 at 14:35)</a>:</h4>
<p>now we just need to make that process painless XD</p>



<a name="253262047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253262047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253262047">(Sep 14 2021 at 14:36)</a>:</h4>
<p>inside a <code>const fn</code> you could then invoke this as <code>&lt;MyStruct&lt;MAGIC&gt; as MyTrait&gt;::my_method()</code></p>



<a name="253297433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253297433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253297433">(Sep 14 2021 at 18:15)</a>:</h4>
<p>Or maybe, just special-case <code>panic!("{}", ...)</code>? I have an alternative way here: <a href="https://github.com/nbdd0121/rust/commit/23a85bf74d0cae2841da86bf0cdf56769b2dd364">https://github.com/nbdd0121/rust/commit/23a85bf74d0cae2841da86bf0cdf56769b2dd364</a></p>



<a name="253304099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253304099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253304099">(Sep 14 2021 at 18:58)</a>:</h4>
<p>Wonderful. Wow. It's so simple and we can just remove it when const trait impls are a thing. I love it.</p>



<a name="253317053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253317053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253317053">(Sep 14 2021 at 20:17)</a>:</h4>
<p>While the simple trick works for const panic, I think in the long term we still want a const_eval_select. Is there anyone currently working on it?</p>



<a name="253354409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/253354409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#253354409">(Sep 15 2021 at 02:41)</a>:</h4>
<p>PR filed <a href="https://github.com/rust-lang/rust/issues/88954">#88954</a></p>



<a name="254521674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254521674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254521674">(Sep 23 2021 at 11:52)</a>:</h4>
<p>I took a stab but I didn’t know how to generate the correct code on the LLVM side.</p>



<a name="254522278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254522278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254522278">(Sep 23 2021 at 11:58)</a>:</h4>
<p>When it generates function calls, it takes a slice of Values, but for the intrinsics codegen I have a slice of Operands.</p>



<a name="254524738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254524738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254524738">(Sep 23 2021 at 12:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization/near/254522278">said</a>:</p>
<blockquote>
<p>When it generates function calls, it takes a slice of Values, but for the intrinsics codegen I have a slice of Operands.</p>
</blockquote>
<p>the code that codegens function calls also starts out with operands, maybe forward to that? or, hopefully less intrusive: at the site where we decide a call is an intrinsic, replace the instance with the runtime instance and proceed on the non-intri path</p>



<a name="254566096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254566096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254566096">(Sep 23 2021 at 16:42)</a>:</h4>
<p>I wonder if instead of <code>const_eval_select&lt;ARG, F, G, RET&gt;(ARG, F, G) -&gt; RET</code> we could have <code>call_if_rt&lt;ARG, F&gt;(F, ARG) -&gt; Option&lt;(F as Fn&lt;Arg&gt;)::Output&gt;</code>. The later will allow us to keep the const logic in the same function, and can have bound on F enforced by typeck without special code.</p>



<a name="254590208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254590208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254590208">(Sep 23 2021 at 19:23)</a>:</h4>
<p>oh heh, that's a neat trick</p>



<a name="254590301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254590301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254590301">(Sep 23 2021 at 19:24)</a>:</h4>
<p>could even simplify it more by making it return a bool and having F not have any return type or arguments</p>



<a name="254590458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254590458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254590458">(Sep 23 2021 at 19:25)</a>:</h4>
<p>then we just use a closure and pass arguments by using local vars from the outside scope</p>



<a name="254590499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254590499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254590499">(Sep 23 2021 at 19:25)</a>:</h4>
<p>in const mode, the closure is still created, but that's fine, as long as we don't call it, there is no error</p>



<a name="254594808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254594808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254594808">(Sep 23 2021 at 19:55)</a>:</h4>
<p>Returning bool is problematic because dataflow does not know if the local vars are initialized. With <code>Option</code> you can just do a <code>if let Some(x) = call_if_rt(... ) { return x; }</code>. Passing no arguments might be okay.</p>



<a name="254693271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254693271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254693271">(Sep 24 2021 at 12:11)</a>:</h4>
<p>oh duh, right</p>



<a name="254847400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254847400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254847400">(Sep 25 2021 at 15:18)</a>:</h4>
<p>I have dug into it again, and I found a pretty simple method, using <code>codegen_call_terminator</code> within itself:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">intrinsic</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">sym</span>::<span class="n">const_eval_select</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// We don't need anything more at this point.</span>
<span class="w">            </span><span class="c1">// we just need to codegen this as a call to the third argument with a single argument</span>
<span class="w">            </span><span class="c1">// passed (that is the first element of this function call).</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">codegen_call_terminator</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">helper</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">bx</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">terminator</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="o">..=</span><span class="mi">0</span><span class="p">],</span><span class="w"></span>
<span class="w">                </span><span class="n">destination</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">cleanup</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">fn_span</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And then I get a linker error:</p>
<div class="codehilite"><pre><span></span><code>error: linking with `cc` failed: exit status: 1
   |
   = note: &quot;cc&quot; &quot;-m64&quot; -snip-

   = note: /usr/bin/ld: /rust/build/x86_64-unknown-linux-musl/test/ui/intrinsics/const-eval-select-x86_64/a.const_eval_select_x86_64.d828b235-cgu.0.rcgu.o: in function `const_eval_select_x86_64::main&#39;:
           const_eval_select_x86_64.d828b235-cgu.0:(.text._ZN24const_eval_select_x86_644main17h3b2c5442a737866cE+0x36): undefined reference to `const_eval_select_x86_64::eq_rt&#39;
           /usr/bin/ld: const_eval_select_x86_64.d828b235-cgu.0:(.text._ZN24const_eval_select_x86_644main17h3b2c5442a737866cE+0x67): undefined reference to `const_eval_select_x86_64::eq_rt&#39;
           collect2: error: ld returned 1 exit status

   = help: some `extern` functions couldn&#39;t be found; some native libraries may need to be installed or have their path specified
   = note: use the `-l` flag to specify native libraries to link
   = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#cargorustc-link-libkindname)

error: aborting due to previous error
</code></pre></div>



<a name="254847998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254847998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254847998">(Sep 25 2021 at 15:28)</a>:</h4>
<p>oh wow XD Probably need to collect the runtime function in <a href="https://github.com/rust-lang/rust/blob/97032a6dfacdd3548e4bff98c90a6b3875a14077/compiler/rustc_monomorphize/src/collector.rs">https://github.com/rust-lang/rust/blob/97032a6dfacdd3548e4bff98c90a6b3875a14077/compiler/rustc_monomorphize/src/collector.rs</a>, but I'm not sure where</p>



<a name="254849114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254849114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254849114">(Sep 25 2021 at 15:44)</a>:</h4>
<p>Thanks for the pointer, I found it. and if the tests pass I will be submitting a PR soon.</p>



<a name="254863794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254863794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254863794">(Sep 25 2021 at 19:24)</a>:</h4>
<p>I came up with a new approach that does the same thing but requires no codegen changes at all, inspired from panic_fmt and const_panic_fmt</p>



<a name="254863846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254863846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254863846">(Sep 25 2021 at 19:25)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[lang = </span><span class="s">"call_if_rt"</span><span class="cp">]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call_if_rt</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">f</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[lang = </span><span class="s">"const_call_if_rt"</span><span class="cp">]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">const_call_if_rt</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">None</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="254863957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254863957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254863957">(Sep 25 2021 at 19:27)</a>:</h4>
<p>We can simply redirect the call_if_rt to const_call_if_rt just like what we do for panic_fmt and const_panic_fmt.</p>



<a name="254932918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254932918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254932918">(Sep 26 2021 at 13:50)</a>:</h4>
<p>I like this a lot</p>



<a name="254932937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Bare%20minimum%20%60const_panic%60%20stablization/near/254932937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Bare.20minimum.20.60const_panic.60.20stablization.html#254932937">(Sep 26 2021 at 13:51)</a>:</h4>
<p>Needs no codegen or typeck changes and just a small thing in ctfe to switch the function</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>