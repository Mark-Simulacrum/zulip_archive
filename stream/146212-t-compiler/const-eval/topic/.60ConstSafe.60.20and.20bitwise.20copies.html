<html>
<head><meta charset="utf-8"><title>`ConstSafe` and bitwise copies · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html">`ConstSafe` and bitwise copies</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="179958556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179958556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179958556">(Nov 05 2019 at 18:03)</a>:</h4>
<p><code>ConstSafe</code> and <code>ConstRefSafe</code> seem to be the framework we're planning to use to enable heap allocation in constants. Am I correct in saying that <code>ConstSafe</code> is a requirement on types? And does <code>ConstSafe</code> imply that something is bitwise copyable?</p>



<a name="179958716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179958716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179958716">(Nov 05 2019 at 18:05)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">V</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>This code will compile on 1.39 stable, but obviously not all <code>Vec</code>s are <code>ConstSafe</code>, just the one returned from <code>Vec::new</code></p>



<a name="179958820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179958820" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179958820">(Nov 05 2019 at 18:06)</a>:</h4>
<p>How do we differentiate <code>Box::new(1)</code> from <code>Vec::new()</code> when both would be <code>const fn</code> under most proposals for heap allocation in consts? We still want to be able to do <code>const B: &amp;Box&lt;i32&gt; = &amp;Box::new(1);</code> after all.</p>



<a name="179958852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179958852" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179958852">(Nov 05 2019 at 18:07)</a>:</h4>
<p>cc <span class="user-group-mention" data-user-group-id="1916">@WG-const-eval</span> <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="179959089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179959089" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179959089">(Nov 05 2019 at 18:09)</a>:</h4>
<p>Do we need an additional effect here? i.e.<code> const(ref) fn new(x: T) -&gt; Box&lt;T&gt;</code></p>



<a name="179966743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179966743" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179966743">(Nov 05 2019 at 19:20)</a>:</h4>
<p>uh... maybe we were a bit too quick to stabilize <code>Vec::new</code> as a <code>const fn</code>? Cc <span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="179967459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179967459" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179967459">(Nov 05 2019 at 19:27)</a>:</h4>
<p>I think this became a problem as soon as we allowed types with custom <code>Drop</code> impls to be returned from a <code>const fn</code> while allowing <code>Drop</code> types in the final value of a <code>const</code>. Users can write stable <code>const</code> constructors for their own <code>Vec</code>-like container types today.</p>



<a name="179967889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179967889" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179967889">(Nov 05 2019 at 19:31)</a>:</h4>
<p>I dont see a relation to <code>Drop</code> here TBH?</p>



<a name="179967925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179967925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179967925">(Nov 05 2019 at 19:31)</a>:</h4>
<p>one could have a silly <code>Vec</code> with heap allocations that doesnt drop</p>



<a name="179967936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179967936" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179967936">(Nov 05 2019 at 19:31)</a>:</h4>
<p>Uh yeah, I guess I really mean non-<code>Copy</code>?</p>



<a name="179968040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968040" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968040">(Nov 05 2019 at 19:32)</a>:</h4>
<p>I mean for <code>Copy</code> types its trivial that we can bit-copy them^^</p>



<a name="179968072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968072" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968072">(Nov 05 2019 at 19:33)</a>:</h4>
<p><code>NeedsDrop</code> is what's talked about in <code>qualify_consts</code></p>



<a name="179968091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968091" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968091">(Nov 05 2019 at 19:33)</a>:</h4>
<p>I thought thats for other purposes?</p>



<a name="179968113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968113" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968113">(Nov 05 2019 at 19:33)</a>:</h4>
<p>it (a) protects against calling non-const-drop impls during const eval, and (b) affects promotion</p>



<a name="179968126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968126" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968126">(Nov 05 2019 at 19:33)</a>:</h4>
<p>but the final value of a const is explicitly <em>exempt</em> from it</p>



<a name="179968467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968467" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968467">(Nov 05 2019 at 19:36)</a>:</h4>
<p>Basically, by writing <code>const fn</code>, you are implicitly stating that the returned value is bitwise copyable, even if the returned type is not <code>Copy</code>.</p>



<a name="179968881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179968881" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179968881">(Nov 05 2019 at 19:40)</a>:</h4>
<p>Well, even by constructing something in a <code>const</code> at all. E.g., if I have a <code>Fd(u32)</code> that closes a file descriptor when dropped (and thus can't be copy) and I put it in a <code>const</code>, bad things will happen.</p>



<a name="179969428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179969428" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179969428">(Nov 05 2019 at 19:46)</a>:</h4>
<p>well in a const you cant open a file to get a file descriptor^^</p>



<a name="179969635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179969635" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179969635">(Nov 05 2019 at 19:48)</a>:</h4>
<p>Right, my point is that being in a <code>const</code> allows you to bitwise copy things that are not <code>Copy</code>. While this is fine for now, it means we would need additional machinery to enable things that are <strong>really</strong> not <code>Copy</code> in a const context. We can't just reuse <code>const fn</code> for this.</p>



<a name="179969907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179969907" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179969907">(Nov 05 2019 at 19:51)</a>:</h4>
<p>Alternatively, we could do less bitwise copying of <code>const</code>s, and have it really act like you copy-pasted the initializer into your code. Like you, I  think those semantics may be unworkable, but it should be discussed at least.</p>



<a name="179970170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179970170" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179970170">(Nov 05 2019 at 19:54)</a>:</h4>
<p>How would my idea work inside a loop for example? <code>loop { x = CONST_BOX; }</code></p>



<a name="179970216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179970216" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179970216">(Nov 05 2019 at 19:54)</a>:</h4>
<p>(it doesn't XD)</p>



<a name="179970303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179970303" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179970303">(Nov 05 2019 at 19:55)</a>:</h4>
<p>^^</p>



<a name="179970385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179970385" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179970385">(Nov 05 2019 at 19:56)</a>:</h4>
<p>Well I mean, we could make it do something, but like you said, nothing about it would be const</p>



<a name="179971570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179971570" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179971570">(Nov 05 2019 at 20:08)</a>:</h4>
<p>well, the plan might be to first inspect the final value of the constant, and only if that contains any heap pointers <code>ConstSafe</code> becomes relevant</p>



<a name="179971627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179971627" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179971627">(Nov 05 2019 at 20:09)</a>:</h4>
<p>with <code>const</code> changing the value of the constant already is semver-breaking anyway as there could be arbitrary compile-time dependencies</p>



<a name="179972333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179972333" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179972333">(Nov 05 2019 at 20:16)</a>:</h4>
<p>Delaying all <code>ConstSafe</code> errors until MIRI is run seems ungreat to me. Also this means generic consts can be <code>ConstSafe</code> for some <code>T</code> but not others? I think being explicit is better here.</p>



<a name="179974808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179974808" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179974808">(Nov 05 2019 at 20:39)</a>:</h4>
<p>well it's kind of too late for an entirely type-based solution, it seems...</p>



<a name="179975236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/179975236" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#179975236">(Nov 05 2019 at 20:43)</a>:</h4>
<p>Like I said, I think we would need an effect, a modifier on top of <code>const</code> that says "this code can execute at compile time, but its result is not necessarily bitwise copyable". If we don't wish to (edit) detect this in the interpreter.</p>



<a name="180012229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180012229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180012229">(Nov 06 2019 at 08:44)</a>:</h4>
<blockquote>
<p>well, the plan might be to first inspect the final value of the constant, and only if that contains any heap pointers <code>ConstSafe</code> becomes relevant</p>
</blockquote>
<p>as <span class="user-mention" data-user-id="119009">@eddyb</span> noted on the const heap issue that won't work for associated constants or other generic situtations. Maybe we need to explore the exposed-const-fn-bodies strategy again by bubbling up information like whether it allocates or not</p>



<a name="180018306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018306">(Nov 06 2019 at 10:21)</a>:</h4>
<blockquote>
<p>Like I said, I think we would need an effect, a modifier on top of <code>const</code> that says "this code can execute at compile time, but its result is not necessarily bitwise copyable". If we don't wish to (edit) detect this in the interpreter.</p>
</blockquote>
<p>We can automatically determine if the result is bitwise copyable once we have a concrete const value, though</p>



<a name="180018360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018360" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018360">(Nov 06 2019 at 10:22)</a>:</h4>
<blockquote>
<p>as @eddyb noted on the const heap issue that won't work for associated constants or other generic situtations. Maybe we need to explore the exposed-const-fn-bodies strategy again by bubbling up information like whether it allocates or not</p>
</blockquote>
<p>Then we'll just have to be conservative. Though I am not sure how.</p>



<a name="180018510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018510" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018510">(Nov 06 2019 at 10:24)</a>:</h4>
<p>Right, we can just go for a post monomorphization error, but we don't want to unless we really have to</p>



<a name="180018696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018696" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018696">(Nov 06 2019 at 10:27)</a>:</h4>
<p>So just to be sure I got it, the current proposal is that the final value of a <code>const</code> must be either free of heap ptrs (or even free of ptrs that point to not-yet-interned memory?), or their type must be<code>ConstSafe</code>. Is that right? Is that allowing strictly more than we do right now?</p>



<a name="180018785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018785" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018785">(Nov 06 2019 at 10:29)</a>:</h4>
<p>hm, consts can point to not yet-interned memory right now I think, with things like <code>const FOO: &amp;Vec&lt;i32&gt; = &amp;Vec::new();</code>.  This is not promotion.</p>



<a name="180018925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018925">(Nov 06 2019 at 10:31)</a>:</h4>
<p>free of heap pointers is the only condition</p>



<a name="180018926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018926" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018926">(Nov 06 2019 at 10:31)</a>:</h4>
<p>this is the "enclosing scope" stuff</p>



<a name="180018931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018931" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018931">(Nov 06 2019 at 10:31)</a>:</h4>
<p>I wonder if we can backpadel on that for consts...</p>



<a name="180018933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018933" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018933">(Nov 06 2019 at 10:31)</a>:</h4>
<p>not-yet-interned memory does not exist</p>



<a name="180018938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018938" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018938">(Nov 06 2019 at 10:32)</a>:</h4>
<blockquote>
<p>not-yet-interned memory does not exist</p>
</blockquote>
<p>hu?</p>



<a name="180018982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018982" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018982">(Nov 06 2019 at 10:32)</a>:</h4>
<p>well, it isn't checked at least</p>



<a name="180018998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180018998" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180018998">(Nov 06 2019 at 10:32)</a>:</h4>
<p>we intern everything that is referenced, but there may be dangling pointers, so we error on these</p>



<a name="180019000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019000">(Nov 06 2019 at 10:32)</a>:</h4>
<p>but everything that is not dangling is interned</p>



<a name="180019005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019005">(Nov 06 2019 at 10:32)</a>:</h4>
<p>right but in a const it's actually hard to reference anything</p>



<a name="180019007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019007" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019007">(Nov 06 2019 at 10:32)</a>:</h4>
<p>right</p>



<a name="180019016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019016" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019016">(Nov 06 2019 at 10:33)</a>:</h4>
<p>at least assuming <span class="user-mention" data-user-id="119009">@eddyb</span> goes through with changing promotion in consts to do "MIR extraction" like it does in runtime contexts</p>



<a name="180019020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019020" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019020">(Nov 06 2019 at 10:33)</a>:</h4>
<p>anyway, that seems orthogonal</p>



<a name="180019031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019031" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019031">(Nov 06 2019 at 10:33)</a>:</h4>
<p>then the only remaining way to do that is to use the "enclosing scope" rule, I think. so if we could somehow move into a place where consts never contain any not-yet-interned pointers (or else we error), that would be good. it would make the heap story much easier, anyway.</p>



<a name="180019087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019087" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019087">(Nov 06 2019 at 10:34)</a>:</h4>
<p>the only problem with that proposal is that it has post monomorphization errors just like if you do <code>0 - T::ASSOC_CONST</code> it may error post monomorphization</p>



<a name="180019125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019125" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019125">(Nov 06 2019 at 10:34)</a>:</h4>
<p>how would that make the heap story easier?</p>



<a name="180019138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019138" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019138">(Nov 06 2019 at 10:35)</a>:</h4>
<p>we'd know that all currently defined <code>const</code> are good</p>



<a name="180019165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019165">(Nov 06 2019 at 10:35)</a>:</h4>
<p>the problem with the proposed check is that if we define a const using some generic const, we cannot check if the return value contains any heap ptrs</p>



<a name="180019167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019167">(Nov 06 2019 at 10:35)</a>:</h4>
<p>I don't know how that could be done without significant overcommitting to the interned memory</p>



<a name="180019171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019171" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019171">(Nov 06 2019 at 10:35)</a>:</h4>
<p>so we have to demand <code>ConstSafe</code></p>



<a name="180019221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019221" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019221">(Nov 06 2019 at 10:36)</a>:</h4>
<p><code>const FOO: () = { let x = &42; };</code> should not intern</p>



<a name="180019245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019245" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019245">(Nov 06 2019 at 10:36)</a>:</h4>
<blockquote>
<p><code>const FOO: () = { let x = &42; };</code> should not intern</p>
</blockquote>
<p>we do intern for dead run-time code, what is worse about dead compile-time code?</p>



<a name="180019250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019250">(Nov 06 2019 at 10:36)</a>:</h4>
<p>if we eagerly intern, that would happen though</p>



<a name="180019262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019262" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019262">(Nov 06 2019 at 10:36)</a>:</h4>
<p>hmm...</p>



<a name="180019293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019293" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019293">(Nov 06 2019 at 10:37)</a>:</h4>
<p>the problem is less about "dead" and more about "not referenced by final constant"</p>



<a name="180019312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019312" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019312">(Nov 06 2019 at 10:37)</a>:</h4>
<p>vs "not referenced by remaining code", for the run-time case. seems symmetric to me.</p>



<a name="180019395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019395">(Nov 06 2019 at 10:38)</a>:</h4>
<p>ok, so assuming overcommit is fine. how do we know when to intern?</p>



<a name="180019396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019396" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019396">(Nov 06 2019 at 10:38)</a>:</h4>
<p>but I think you are right that it doesn't really help... we cannot just start demanding <code>ConstSafe</code> on opaque consts as we already allow using them without any such bound</p>



<a name="180019421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019421" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019421">(Nov 06 2019 at 10:39)</a>:</h4>
<p>yea, that's the problem with the generic situation and it was a problem at 1.0</p>



<a name="180019504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019504" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019504">(Nov 06 2019 at 10:40)</a>:</h4>
<p>yeah</p>



<a name="180019511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019511" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019511">(Nov 06 2019 at 10:40)</a>:</h4>
<p>we could treat generic constants as <code>!ConstRefSafe</code>, but that won't help for the value of the constant</p>



<a name="180019526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019526" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019526">(Nov 06 2019 at 10:40)</a>:</h4>
<p>oh, no we can't do that either</p>



<a name="180019531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019531" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019531">(Nov 06 2019 at 10:40)</a>:</h4>
<p>that's not backcompat though?</p>



<a name="180019534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019534" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019534">(Nov 06 2019 at 10:40)</a>:</h4>
<p>yea I just realized that, too</p>



<a name="180019556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019556">(Nov 06 2019 at 10:41)</a>:</h4>
<p>basically we need a new flag similar to the cell checks</p>



<a name="180019562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019562">(Nov 06 2019 at 10:41)</a>:</h4>
<p>but even if we could break everything, what would we even do? it looks like you basically want all generic and assoc consts to be <code>ConstSafe</code></p>



<a name="180019563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019563" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019563">(Nov 06 2019 at 10:41)</a>:</h4>
<p>but it also needs to look at function bodies :D</p>



<a name="180019564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019564" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019564">(Nov 06 2019 at 10:41)</a>:</h4>
<p>that's a severe restriction for their usefulnes</p>



<a name="180019573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019573" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019573">(Nov 06 2019 at 10:41)</a>:</h4>
<blockquote>
<p>but it also needs to look at function bodies :D</p>
</blockquote>
<p>I hope you mean "return value", we should never inspect the <em>code</em></p>



<a name="180019634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019634">(Nov 06 2019 at 10:42)</a>:</h4>
<p>well... we have precedent for that in terms of <code>Send</code> and <code>Sync</code> marker traits</p>



<a name="180019646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019646" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019646">(Nov 06 2019 at 10:42)</a>:</h4>
<p>except that noone ever did something like that for functions</p>



<a name="180019647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019647" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019647">(Nov 06 2019 at 10:42)</a>:</h4>
<p>only types</p>



<a name="180019683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019683" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019683">(Nov 06 2019 at 10:43)</a>:</h4>
<p>so you want to basically infer "returns const safe" for functions? might as well infer <code>const fn</code> then. :P</p>



<a name="180019699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019699" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019699">(Nov 06 2019 at 10:43)</a>:</h4>
<p>but even so... that would still be overly restrictive, so we don't want that</p>



<a name="180019752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019752" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019752">(Nov 06 2019 at 10:44)</a>:</h4>
<p>I'm still for the post-monomorphization-errors if they occur rarely</p>



<a name="180019810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019810" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019810">(Nov 06 2019 at 10:45)</a>:</h4>
<p>well we don't know how rare they will be</p>



<a name="180019890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019890" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019890">(Nov 06 2019 at 10:46)</a>:</h4>
<p>maybe <code>Box::new</code> cannot be a <code>const fn</code> after all, just a <code>const(heap) fn</code>...</p>



<a name="180019934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019934">(Nov 06 2019 at 10:47)</a>:</h4>
<p>that won't help, because then <code>Vec::push</code> will also be <code>const (heap)</code> and a function using <code>Vec::push</code>, even if not putting that thing into its return value will also be <code>const (heap)</code> even if it doesn't need to be</p>



<a name="180019948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019948" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019948">(Nov 06 2019 at 10:47)</a>:</h4>
<p>and values into which <code>const(heap)</code> computations flow may only be used as "full" <code>const</code> values of their type is <code>ConstSafe</code></p>



<a name="180019959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019959" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019959">(Nov 06 2019 at 10:47)</a>:</h4>
<p>like, <code>ConstSafe</code> is the thing that "masks" the <code>heap</code> effect</p>



<a name="180019973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180019973" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180019973">(Nov 06 2019 at 10:47)</a>:</h4>
<p>you'll need to look at function bodies to figure out <code>const (heap)</code></p>



<a name="180020027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020027" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020027">(Nov 06 2019 at 10:48)</a>:</h4>
<p>how is that proposal different from mine?</p>



<a name="180020029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020029" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020029">(Nov 06 2019 at 10:48)</a>:</h4>
<p>functions need to set it</p>



<a name="180020033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020033" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020033">(Nov 06 2019 at 10:48)</a>:</h4>
<p>it's explicit, not inferred</p>



<a name="180020063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020063" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020063">(Nov 06 2019 at 10:49)</a>:</h4>
<p>even if we end up inferring things I think it is good to start with the explicit calculus and work out its rules^^</p>



<a name="180020065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020065" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020065">(Nov 06 2019 at 10:49)</a>:</h4>
<p>hm</p>



<a name="180020198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020198" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020198">(Nov 06 2019 at 10:50)</a>:</h4>
<p>but anyway, first consts should be able to call generic fns before we take on another big project^^</p>



<a name="180020219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020219" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020219">(Nov 06 2019 at 10:50)</a>:</h4>
<p>it seems like <code>Vec::new</code> doesnt make anything worse, so there is no emergency here</p>



<a name="180020227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020227" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020227">(Nov 06 2019 at 10:50)</a>:</h4>
<p>ok this seems nice... it's opt-in, just like if everything were <code>const</code> and we'd have <code>notconst</code> functions</p>



<a name="180020245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020245" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020245">(Nov 06 2019 at 10:51)</a>:</h4>
<p>yea, users can already do that for their own types</p>



<a name="180020261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020261" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020261">(Nov 06 2019 at 10:51)</a>:</h4>
<p><code>Vec::new</code> just does it for a libstd type</p>



<a name="180020270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180020270" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180020270">(Nov 06 2019 at 10:51)</a>:</h4>
<p>yeah</p>



<a name="180021400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180021400" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180021400">(Nov 06 2019 at 11:05)</a>:</h4>
<p>I summarized this at <a href="https://github.com/rust-lang/const-eval/issues/20#issuecomment-550260232" target="_blank" title="https://github.com/rust-lang/const-eval/issues/20#issuecomment-550260232">https://github.com/rust-lang/const-eval/issues/20#issuecomment-550260232</a></p>



<a name="180021407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180021407" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180021407">(Nov 06 2019 at 11:05)</a>:</h4>
<p>though "effect" seems like a wrong term to me now, this is purely a property of the return value, not the computation</p>



<a name="180021473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180021473" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180021473">(Nov 06 2019 at 11:06)</a>:</h4>
<p>it's more like "refinement types"</p>



<a name="180021498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180021498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180021498">(Nov 06 2019 at 11:06)</a>:</h4>
<p><code>Vec::new()</code> returns a "<code>Vec</code> that is <code>ConstSafe</code>" (even though the type in general is not)</p>



<a name="180021509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180021509" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180021509">(Nov 06 2019 at 11:06)</a>:</h4>
<p>while <code>Box::new(0)</code> makes no such extra statement</p>



<a name="180036511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180036511" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180036511">(Nov 06 2019 at 14:22)</a>:</h4>
<blockquote>
<p>at least assuming <span class="user-mention silent" data-user-id="119009">eddyb</span> goes through with changing promotion in consts to do "MIR extraction" like it does in runtime contexts</p>
</blockquote>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> informed me that we can't with the current setup, but should be trivial once promotion is its own pass</p>



<a name="180036648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180036648" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180036648">(Nov 06 2019 at 14:24)</a>:</h4>
<p>speaking of which, I should go review their PRs :P</p>



<a name="180036691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180036691" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180036691">(Nov 06 2019 at 14:25)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I love refinement types and the <code>Vec</code> vs <code>Box</code> distinction makes perfect sense to me but I'm a bit worried there's no "simple" solution in general</p>



<a name="180039804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180039804" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180039804">(Nov 06 2019 at 14:55)</a>:</h4>
<blockquote>
<p><code>Vec::new()</code> returns a "<code>Vec</code> that is <code>ConstSafe</code>" (even though the type in general is not)</p>
</blockquote>
<p>Neat!</p>



<a name="180044393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstSafe%60%20and%20bitwise%20copies/near/180044393" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/.60ConstSafe.60.20and.20bitwise.20copies.html#180044393">(Nov 06 2019 at 15:40)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> tis might also be a good way to think about some of our other type-based analyses... <code>CopyValueOf&lt;Option&lt;T&gt;&gt;</code> refers to those values of type <code>Option&lt;T&gt;</code> that can be copied, like <code>None</code>, etc</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>