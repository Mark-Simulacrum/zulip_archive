<html>
<head><meta charset="utf-8"><title>Regions in `ty::Const`&#x27;s ty · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html">Regions in `ty::Const`&#x27;s ty</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249535867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249535867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249535867">(Aug 15 2021 at 23:36)</a>:</h4>
<p>When working for PR <a href="https://github.com/rust-lang/rust/issues/88018">#88018</a> I discovered that <code>rustc_typeck</code> and <code>rustc_mir_build</code> has different expectations regarding the regions used in <code>ty::Const</code>. <code>rustc_mir_build</code> pretty much expects <code>ty::Const</code>'s ty to have all erased regions, while <code>rustc_typeck</code>'s current usage expects non-erased type. This discrepancy causes ICE in <a href="https://github.com/rust-lang/rust/issues/78174">#78174</a>.</p>
<p>My PR currently just creates a <code>from_anon_const_erased</code> which is supposed to be called during MIR building while the <code>from_anon_const</code>'ll be called from type checker. But I wonder if instead I should ensure that all regions in <code>ty::Const</code>'s ty to be erased, and then convert them to back <code>ReStatic</code> in type checker. I guess that should be okay since no regions other than <code>ReLateBound</code> and <code>ReStatic</code> should appear in constant's type?</p>



<a name="249558429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249558429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249558429">(Aug 16 2021 at 07:47)</a>:</h4>
<p>Hm, in the future constants might be able to refer to generic lifetime parameters of the surrounding context (similar to how they should be able to refer to generic type/const parameters)</p>



<a name="249558521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249558521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249558521">(Aug 16 2021 at 07:48)</a>:</h4>
<p>erasing and later un-erasing also strikes me as conceptually the wrong approach</p>



<a name="249559595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249559595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249559595">(Aug 16 2021 at 08:02)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> have you tried playing with <a href="https://github.com/rust-lang/rust/blob/3a24abd22fd25c836d8b4d75ff46c833f9c3934c/compiler/rustc_mir/src/transform/promote_consts.rs#L864">this code</a>, e.g. using <code>re_static</code> there, as <span class="user-mention" data-user-id="124288">@oli</span> suggested?<br>
I have no idea what that code does though...^^</p>



<a name="249572129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249572129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249572129">(Aug 16 2021 at 10:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Regions.20in.20.60ty.3A.3AConst.60's.20ty/near/249559595">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> have you tried playing with <a href="https://github.com/rust-lang/rust/blob/3a24abd22fd25c836d8b4d75ff46c833f9c3934c/compiler/rustc_mir/src/transform/promote_consts.rs#L864">this code</a>, e.g. using <code>re_static</code> there, as <span class="user-mention silent" data-user-id="124288">oli</span> suggested?<br>
I have no idea what that code does though...^^</p>
</blockquote>
<p>Lifetimes are all erased in MIR so that's not relevant</p>



<a name="249573491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249573491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249573491">(Aug 16 2021 at 10:52)</a>:</h4>
<p>well I can just quote what <span class="user-mention" data-user-id="124288">@oli</span> said^^</p>
<blockquote>
<p>From a cursory glance I would say it is promotion related. If someone wants to dig into this, dumping the MIR before mir borrowck and checking the exact lifetimes that show up is probably the right way. Maybe it is incorrect for us to use re_erased in <a href="http://promote_consts.rs">promote_consts.rs</a>. It is ok to use in general, but in promotion we also use it for the substs of unevaluated constants that point to the promoted. These substs may have to be re_static</p>
</blockquote>



<a name="249574366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249574366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249574366">(Aug 16 2021 at 11:03)</a>:</h4>
<p>Well, I am pretty sure the issue is <code>type_of</code> returning <code>ReErased</code>, which isn't expected by the <a href="https://github.com/rust-lang/rust/blob/3a24abd22fd25c836d8b4d75ff46c833f9c3934c/compiler/rustc_mir/src/borrow_check/universal_regions.rs#L653">borrow checker</a>.</p>



<a name="249575197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249575197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249575197">(Aug 16 2021 at 11:15)</a>:</h4>
<p>yeah the borrow checker should never call functions that return <code>ReErased</code></p>



<a name="249575207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Regions%20in%20%60ty%3A%3AConst%60%27s%20ty/near/249575207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Regions.20in.20.60ty.3A.3AConst.60&#x27;s.20ty.html#249575207">(Aug 16 2021 at 11:15)</a>:</h4>
<p>there is some kind of phase violation going on here</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>