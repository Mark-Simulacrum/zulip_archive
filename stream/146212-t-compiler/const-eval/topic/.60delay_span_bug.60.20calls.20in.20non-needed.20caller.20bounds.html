<html>
<head><meta charset="utf-8"><title>`delay_span_bug` calls in non-needed caller bounds · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html">`delay_span_bug` calls in non-needed caller bounds</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255203177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255203177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255203177">(Sep 28 2021 at 11:50)</a>:</h4>
<p>I'm trying to fix an ICE in the following example, which admittedly is a somewhat contrived example, but there are more real-world examples where this also results in ICEs. I chose this example since this is what I initially analyzed.</p>
<div class="codehilite"><pre><span></span><code>#![allow(incomplete_features)]
#![feature(generic_const_exprs)]

pub trait Foo {
    const SIZE: usize;

    fn to_bytes(&amp;self) -&gt; [u8; Self::SIZE];
}

pub fn bar&lt;G: Foo&gt;(a: &amp;G) -&gt; u8
where
    [(); G::SIZE]: Sized,
{
    deeper_bar(a)
}

fn deeper_bar&lt;G: Foo&gt;(a: &amp;G) -&gt; u8
where
    [(); G::SIZE]: Sized,
{
    a.to_bytes()[0]
}

fn main() {}
</code></pre></div>
<p>The problem here is that when we typecheck <code>bar</code> we try to prove <code>&lt;[(); G::SIZE] as Sized&gt;</code> for the where clause in <code>deeper_bar</code> during the check of the call expression. We will of course always find the built-in candidate, but prior to that we use the caller bounds when assembling candidates, so specifically the where clause <code>[(); G::SIZE]: Sized</code> on <code>bar</code>. We then try to relate these two bounds, which will cause us to equate the two associated constants (at this stage we cannot resolve the associated constant <code>G::SIZE</code> of <code>deeper_bar</code>).<br>
The problem now is that when we try to resolve the associated item we call <code>codegen_fulfill_obligation</code> with <code>&lt;^0 as Foo&gt;</code> which we can't prove and now this will result in a call of <code>delay_span_bug</code>. This will later ICE because a <code>delay_span_bug</code> was called even though no error has occurred (the built-in candidate proves this Sized obligation obviously).</p>
<p>I see two possible ways this might be handled. When we try to assemble candidates for <code>&lt;[&lt;(); _] as Sized&gt;</code> and use the caller bounds we equate the two obligations <code>&lt;[(); _] as Sized&gt; (bar) == &lt;[(); _] as Sized&gt; (deeper_bar)</code>. Here we create a <code>ConstEquate</code> predicate, which we later evaluate, but let this relation pass as true and therefore don't ignore the candidate from the caller bounds right away, which will then cause the <code>delay_span_bug</code> call later. Evaluating the relation right away and rejecting this caller bound candidate seems like the most plausible fix to me. Although I don't know whether handling type relations involving constants in this way generally would yield to other problems.</p>
<p>Another solution would be to write a custom function of <code>codegen_fulfill_obligation</code> for associated constants, in<br>
which we don't call <code>delay_span_bug</code> but instead propagate the error upwards (this propagation is already done<br>
now, its just that we propagate <code>ErrorReported</code> instead of the actual type of error), this would then allow us<br>
to handle this higher in the call stack. The downside to this is that this handling can happen much higher in the<br>
callstack, so that might result in confusing code. <br>
Can anybody help me with this?</p>



<a name="255203490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255203490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255203490">(Sep 28 2021 at 11:53)</a>:</h4>
<p>I dont really know how to fix this but there are a tonne of <code>I-ICE</code> <code>F-generic_const_exprs</code>  issues open that would be fixed by solving this</p>



<a name="255205522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255205522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255205522">(Sep 28 2021 at 12:11)</a>:</h4>
<p><code>/// Assumes that this is run after the entire crate has been successfully type-checked.</code><br>
this comment on <code>codegen_fulfill_obligations</code> and the name <strong>codegen</strong>_fulfill_obligatons</p>



<a name="255205557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255205557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255205557">(Sep 28 2021 at 12:11)</a>:</h4>
<p>makes me think that really we ought to have a separate method for this as we are calling codegen_fulfill_obligations during typeck now</p>



<a name="255205677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255205677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255205677">(Sep 28 2021 at 12:12)</a>:</h4>
<p>(or make codegen_fullfill_obligations return a result or whatever, either way calling the current <code>codegen_fulfill_obligatons</code> is definitely wrong)</p>



<a name="255213703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255213703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255213703">(Sep 28 2021 at 13:14)</a>:</h4>
<p>Oh wow, I missed that comment. Thanks for mentioning that. I agree that calling <code>codegen_fullfill_obligations</code> is the problem here. I'll try to fix that.</p>



<a name="255234943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255234943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255234943">(Sep 28 2021 at 15:21)</a>:</h4>
<p>Should it actually be possible in this context to infer the value for <code>&lt;^0 as Foo&gt;</code> here or is it expected that we cannot resolve that inference variable at this point, so that using a placeholder here is correct?</p>



<a name="255235247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255235247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255235247">(Sep 28 2021 at 15:23)</a>:</h4>
<p>I think its entirely possible that we can get inference variables we cant resolve when trying to fulfill a ConstEquate obligation</p>



<a name="255235806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255235806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255235806">(Sep 28 2021 at 15:27)</a>:</h4>
<p>Ok thanks. Do you think that a <code>ConstEquate</code> obligation is the only context in which that can happen?</p>



<a name="255236095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236095">(Sep 28 2021 at 15:29)</a>:</h4>
<p>there doesn't seem to be many places that call <code>Infcx::const_eval_resolve</code>so I think so</p>



<a name="255236112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236112">(Sep 28 2021 at 15:29)</a>:</h4>
<p>or well</p>



<a name="255236123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236123">(Sep 28 2021 at 15:29)</a>:</h4>
<p>i dont know about other places ^^</p>



<a name="255236234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236234">(Sep 28 2021 at 15:30)</a>:</h4>
<p>but ConstEquate seems to be a large portion of the usage of <code>Infcx::const_eval_resolve</code></p>



<a name="255236343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236343">(Sep 28 2021 at 15:30)</a>:</h4>
<p>there's <code>is_const_evaluatable</code> which might run into issues <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="255236440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236440">(Sep 28 2021 at 15:31)</a>:</h4>
<p>it evaluates a const if it cant unify it with a <code>ConstEvaluatable</code> in the paramenv which seems like it might hit the same issue but im not sure really</p>



<a name="255236727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255236727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255236727">(Sep 28 2021 at 15:32)</a>:</h4>
<p><code>ConstEquate</code> obligations are where i've seen most of the ICEs for this coming from though ^^</p>



<a name="255237042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255237042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255237042">(Sep 28 2021 at 15:34)</a>:</h4>
<p>I don't really understand what the rationale is for registering <code>ConstEquate</code> obligations in the first place. What is stopping us from evaluating those inside the <code>TypeRelation</code> instances itself?</p>



<a name="255237141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255237141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255237141">(Sep 28 2021 at 15:35)</a>:</h4>
<p>my understanding is that <code>ConstEquate</code> was added to try delay unifying constants because it can cause cycles but in reality it didnt really do much</p>



<a name="255237171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255237171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255237171">(Sep 28 2021 at 15:35)</a>:</h4>
<p>I might be wrong about that though</p>



<a name="255237565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255237565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255237565">(Sep 28 2021 at 15:38)</a>:</h4>
<p>I dont <em>think</em> this is the cause of the problem though, if we just tried to equate immediately instead of registering a <code>ConstEquate</code> obligation, the inference var would still be there and still potentially be unresolvable</p>



<a name="255241027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255241027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255241027">(Sep 28 2021 at 15:58)</a>:</h4>
<p>I thought that one possible approach would be to propagate the error upwards to the type relation, instead of delaying the bugs. So e.g. when assembling candidates from caller bounds we use <a href="https://github.com/rust-lang/rust/blob/1d71ba862309d59df710078a845c8772ffb22aba/compiler/rustc_trait_selection/src/traits/select/mod.rs#L2127-L2139"><code>match_poly_trait_ref</code></a> which would simply ignore that candidate if the type relation check fails. But if we allow the type relation to pass and just register a <code>ConstEquate</code> obligation to be checked later, as we currently do, then it becomes much more difficult to correctly propagate the errors that we want to avoid calling <code>delay_span_bug</code> for, as far as I can tell.</p>



<a name="255241530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255241530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255241530">(Sep 28 2021 at 16:01)</a>:</h4>
<p>Do you know whether <code>ConstEquate</code> obligations only originate from the type relation?</p>



<a name="255241583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255241583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255241583">(Sep 28 2021 at 16:01)</a>:</h4>
<p>I am not sure</p>



<a name="255243845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255243845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255243845">(Sep 28 2021 at 16:14)</a>:</h4>
<p>Not sure how much you looked into this, but can you say what you believe to be the core problem with this issue?</p>



<a name="255247240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255247240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255247240">(Sep 28 2021 at 16:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328097">BN</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds/near/255243845">said</a>:</p>
<blockquote>
<p>Not sure how much you looked into this, but can you say what you believe to be the core problem with this issue?</p>
</blockquote>
<p>when we have some const containing an inference variable, for example <code>{ &lt;T as Trait&lt;_&gt;&gt;::ASSOC }</code> and we want to know whether its the same as some other const (hence ConstEquate). If we fail to unify with <code>try_unify_abstract_const</code> (which walks the THIR of both consts and checks if they are equal) then we attempt to evaluate both consts to see if they evaluate to the same thing (this is what <code>Infcx::const_eval_resolve</code> is doing I believe)</p>
<p>When we call <code>const_eval_resolve</code> it (at some point) tries to find what impl satisfies <code>&lt;T as Trait&lt;_&gt;&gt;</code> so that we can evaluate the associated const <code>ASSOC</code>. Since there's an inference variable we turn it into something like <code>for&lt;U&gt; &lt;T as Trait&lt;U&gt;&gt;</code> and try to find an impl that satisfies that traitref. (finding the impl that satisfies the traitref is what <code>codegen_fulfill_obligation</code> is doing)</p>
<p><code>codegen_fulfill_obligation</code> is not meant to run during typeck though, it's only meant to run when we <em>already</em> know that the trait ref can actually be fulfilled (because typeck has run). So when it cant find an impl to fulfill <code>for&lt;U&gt; &lt;T as Trait&lt;U&gt;&gt;</code> we ICE with that <code>encountered Unimplemented blah blah</code> because without <code>generic_const_exprs</code> it would mean that we messed up somewhere and code typeck'ed when it shouldn't have</p>
<p>The core issue IMO  is that we're calling <code>codegen_fulfill_obligation</code> when we dont actually know if there's an impl out there that fulfills the trait ref. Or maybe the core issue is that <code>codegen_fulfill_obligation</code> should handle being called during typeck, I don't know which is the right framing...</p>



<a name="255247667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255247667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255247667">(Sep 28 2021 at 16:37)</a>:</h4>
<p>^ this is basically my understanding of the issue</p>



<a name="255248313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255248313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255248313">(Sep 28 2021 at 16:41)</a>:</h4>
<p>with all that said I feel like my understanding here is not completely correct, I would expect things to be ICEing a <em>whole lot more</em> so I think im missing something</p>



<a name="255248831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255248831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255248831">(Sep 28 2021 at 16:44)</a>:</h4>
<p>there's an issue open that suggests that <code>tcx.const_eval_resolve</code> instead of <code>infcx.const_eval_resolve</code> would fix this as it doesnt do the replacing inference vars with <code>for&lt;...&gt;</code> (I tried this a while back and it didnt fix stuff)</p>



<a name="255271803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255271803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255271803">(Sep 28 2021 at 18:17)</a>:</h4>
<p>Thanks a lot for the helpful answer. I'll try to look more into this issue.</p>



<a name="255432593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255432593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255432593">(Sep 29 2021 at 16:47)</a>:</h4>
<p>I've looked into <a href="https://github.com/rust-lang/rust/issues/83249">#83249</a>, I have some questions and thoughts about that. </p>
<p>When we check the argument type of the call <code>foo([0; 1]);</code> we <a href="https://github.com/rust-lang/rust/blob/207d9558d00dd5cc438a6418ba96912d396e2155/compiler/rustc_typeck/src/check/fn_ctxt/checks.rs#L415">demand</a> that the type of the argument is always a subtype of the type of the parameter. Now in this case we have an inference variable here for the type of the parameter. </p>
<p>Is this inference variable ever resolvable?  In theory we should know that the inference variable corresponds to some type that implements Foo but I don't see how we could ever get a concrete type for <code>T</code> here, except of course the argument type but we try to relate that to the parameter type here.</p>
<p>Assuming that we would know that the inference variable implements Foo, how would we proceed? Would we look for all kinds of impls and see whether there is a unique impl whose associated constant <code>N</code> is equal to 1? If not, how could we ever eq relate these constants (to me it seems as if the const in the parameter always remains 'non-concrete')? </p>
<p>If we would settle for the approach of looking for a unique implementation of Foo, wouldn't we need some other construct than an inference variable to convey the information that the type we look for implements Foo?</p>
<p>If we don't expect the type system to be able to infer the right type for <code>T</code> in the parameter, we should probably always consider <code>ConstEquate</code> type relations that involve inference variables as false and try to give good diagnostics that suggest to provide the correct type (as in <code>foo&lt;u8&gt;([u8; 1])</code>.</p>



<a name="255433382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255433382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255433382">(Sep 29 2021 at 16:51)</a>:</h4>
<p>this issue which is a duplicate of that issue has a case where it is realistic for the inference vars to get resolved eventually <a href="https://github.com/rust-lang/rust/issues/82418">#82418</a> <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=04e711e02c9323e2c4fe1fcf187eb68f">playground</a></p>



<a name="255433952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255433952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255433952">(Sep 29 2021 at 16:54)</a>:</h4>
<p>ah although actually yes even in <a href="https://github.com/rust-lang/rust/issues/83249">#83249</a> that inference variable can totally be resolved because of the type annotation <code>let _: u8</code></p>



<a name="255434720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/255434720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#255434720">(Sep 29 2021 at 16:59)</a>:</h4>
<p>I don't know much about how type inference actually works though so I wont be much help with those questions</p>



<a name="257356974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257356974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257356974">(Oct 13 2021 at 12:33)</a>:</h4>
<p><span class="user-mention" data-user-id="328097">@BN</span> are you still interested/are working on this? I spoke with lcnr and a solution was come up with but they wanted to speak with niko before deciding for sure (no idea how long that will take)</p>



<a name="257358927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257358927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257358927">(Oct 13 2021 at 12:48)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="326176">@Boxy [she/her]</span> , I'm still interested in this issue. I've worked on it and I thought most of the functionality of postponing the evaluation of consts is already in place in the compiler, but either I must have misunderstood something or was too conservative in postponing certain types of consts, because I got a weird error when trying to compile std. I wanted to give this another shot, but if you have a working solution then thats obviously not necessary. Would you be looking for someone to implement that?</p>



<a name="257359371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257359371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257359371">(Oct 13 2021 at 12:51)</a>:</h4>
<p>Yea, I wanted to know if you wanted to have a go at implementing it (I probably should have said in the original message, oh well)</p>



<a name="257359544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257359544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257359544">(Oct 13 2021 at 12:52)</a>:</h4>
<p>Yes, i'd like to do that. Thanks for keeping me in mind.</p>



<a name="257359697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257359697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257359697">(Oct 13 2021 at 12:54)</a>:</h4>
<p>Ok i'll write up the idea then</p>



<a name="257362492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257362492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257362492">(Oct 13 2021 at 13:13)</a>:</h4>
<p>Currently in <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_infer/src/infer/mod.rs#L1582-L1597">infcx.const_eval_resolve</a> we canonicalize the <code>unevaluated</code> and <code>paramenv</code> (which replaces inference variables with the stuff that we discussed before) </p>
<p>What we want to do instead of canonicalizing is to return <code>Err::TooGeneric</code> when there are inference vars. Which will cause our handling of <code>ConstEquate</code> to <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/fulfill.rs#L614-L618">stall on the inference vars</a> which means we wont evaluate the const until all the inference vars have been resolved (and if we cant, it'll error)</p>



<a name="257362685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257362685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257362685">(Oct 13 2021 at 13:14)</a>:</h4>
<p>as a side effect of this change the test added in <a href="https://github.com/rust-lang/rust/pull/89588">this PR</a> (sorry :P) will likely start failing but that's fine the test can be removed and we'll open an issue to make the code compile again</p>



<a name="257363924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257363924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257363924">(Oct 13 2021 at 13:22)</a>:</h4>
<p>I've had the same solution in mind, I chose to always reject or rather postpone (by returing the <code>TooGeneric</code> error) the evaluations of consts inside a ConstEquate predicate whenever we have a bound placeholder as a subst. But this resulted in a very confusing error during compilation of std. Is the placeholder the result of the canonicalization or rather is it possible for bound placeholders to be introduced in situations in which we don't have inference vars?</p>



<a name="257364307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257364307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257364307">(Oct 13 2021 at 13:25)</a>:</h4>
<p>The canonicalisation introduces boundvars not placeholders so I dont think checking for placeholders is the right thing to do</p>



<a name="257364493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257364493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257364493">(Oct 13 2021 at 13:26)</a>:</h4>
<p>I think I checked for bound vars, I'll try to push my local branch. One second</p>



<a name="257364542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257364542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257364542">(Oct 13 2021 at 13:27)</a>:</h4>
<p>I dont know everywhere boundvars get created in the compiler but checking for inference vars instead of bound vars seems more correct given what we're trying to accomplish here</p>



<a name="257364585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257364585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257364585">(Oct 13 2021 at 13:27)</a>:</h4>
<p>(particularly I wouldn't be surprised if we get bound vars not coming from inference vars)</p>



<a name="257365112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257365112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257365112">(Oct 13 2021 at 13:30)</a>:</h4>
<p><a href="https://github.com/b-naber/rust/commit/5d72a23a92755b41f5c319d093228ade995fc67c">https://github.com/b-naber/rust/commit/5d72a23a92755b41f5c319d093228ade995fc67c</a></p>



<a name="257365234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257365234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257365234">(Oct 13 2021 at 13:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds/near/257364542">said</a>:</p>
<blockquote>
<p>I dont know everywhere boundvars get created in the compiler but checking for inference vars instead of bound vars seems more correct given what we're trying to accomplish here</p>
</blockquote>
<p>Yes thats what I thought, its probably too conservative to always reject bound vars.</p>



<a name="257365514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257365514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257365514">(Oct 13 2021 at 13:32)</a>:</h4>
<p>oh hmm I hadnt thought about changing resolve_associated_item <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="257367200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257367200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257367200">(Oct 13 2021 at 13:43)</a>:</h4>
<p>Ah no actually the problem wasn't that the std didn't compile (that must have been another issue), but that we were failing most of the <code>ui/abi</code> tests. I don't really know anything about the abi functionality. Any idea how that might be related to this solution?</p>



<a name="257367511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257367511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257367511">(Oct 13 2021 at 13:45)</a>:</h4>
<p>mmm I'm not really sure I'd have to get your changes setup locally and see whats happening when we fail to resolve an assoc item</p>



<a name="257367836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257367836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257367836">(Oct 13 2021 at 13:47)</a>:</h4>
<p>I can try to implement the changes you proposed first and see whether I get similar problems, before you need to look into this.</p>



<a name="257368699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257368699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257368699">(Oct 13 2021 at 13:52)</a>:</h4>
<p>I think that's probably worth a shot <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="257373140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257373140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257373140">(Oct 13 2021 at 14:18)</a>:</h4>
<p>I'll probably have time for that either this evening or tomorrow</p>



<a name="257549720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257549720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257549720">(Oct 14 2021 at 14:59)</a>:</h4>
<p><span class="user-mention" data-user-id="326176">@Boxy [she/her]</span> We still get the same errors in the abi tests if we postpone the evaluation of consts before the canonicalization. All of the failing tests I've looked at include the link attribute to <code>rust_test_helpers.c</code>. I don't know how one can debug this.</p>



<a name="257549804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257549804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257549804">(Oct 14 2021 at 15:00)</a>:</h4>
<p>do you have code I can poke/look at?</p>



<a name="257549841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257549841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257549841">(Oct 14 2021 at 15:00)</a>:</h4>
<p><a href="https://github.com/b-naber/rust/tree/eval_consts_infer_vars">https://github.com/b-naber/rust/tree/eval_consts_infer_vars</a></p>



<a name="257550099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550099">(Oct 14 2021 at 15:01)</a>:</h4>
<p>can you debug out the substs to see what the inference vars are?</p>



<a name="257550398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550398">(Oct 14 2021 at 15:03)</a>:</h4>
<p>How do you get debug output when running <code>x.py test</code>?</p>



<a name="257550412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550412">(Oct 14 2021 at 15:03)</a>:</h4>
<p>Uh</p>



<a name="257550418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550418">(Oct 14 2021 at 15:03)</a>:</h4>
<p>good question</p>



<a name="257550446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550446">(Oct 14 2021 at 15:03)</a>:</h4>
<p>i tend to make a second cargo project and run <code>rustc +stage1 main.rs</code> lol...</p>



<a name="257550553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550553">(Oct 14 2021 at 15:04)</a>:</h4>
<p>but this is test specific i think. Those abi tests always fail when you compile them in a seperate file, e.g. in playground</p>



<a name="257550581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550581">(Oct 14 2021 at 15:04)</a>:</h4>
<p>oh... hmm ive no idea then</p>



<a name="257550685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550685">(Oct 14 2021 at 15:05)</a>:</h4>
<p>(looking at your code btw I don't think you're handling lifetime infernece variables correctly)</p>



<a name="257550710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550710">(Oct 14 2021 at 15:05)</a>:</h4>
<p>(I think those are still going through the canonicalisation and turning into <code>for&lt;'a&gt;</code> probably)</p>



<a name="257550746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550746">(Oct 14 2021 at 15:05)</a>:</h4>
<p>( I dont know if the test failures would be caused by that though)</p>



<a name="257550874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550874">(Oct 14 2021 at 15:06)</a>:</h4>
<p>(if erasing lifetimes in substs (tcx.erase_lifetimes) then it probably is caused by that)</p>



<a name="257550904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550904">(Oct 14 2021 at 15:06)</a>:</h4>
<p>I dont think they are relevant here, since if it misses the test branch it just works as usual and the tests obviously passed before the changes</p>



<a name="257550975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550975">(Oct 14 2021 at 15:07)</a>:</h4>
<p>hmmmm right</p>



<a name="257550979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257550979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257550979">(Oct 14 2021 at 15:07)</a>:</h4>
<p>by test branch I meant the check for inference variables</p>



<a name="257551105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257551105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257551105">(Oct 14 2021 at 15:07)</a>:</h4>
<p>but you're right in general we should take inferred lifetimes into account here</p>



<a name="257732990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257732990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257732990">(Oct 15 2021 at 17:16)</a>:</h4>
<p><span class="user-mention" data-user-id="326176">@Boxy [she/her]</span> so turns out the failures of the abi tests were due to problems on my local machine(I recently installed binutils and putting that in my path caused its version of ar to be used which was incompatible with my architecture and caused errors when building the static library for <code>rust_test_helpers</code>. Sorry for the confusion</p>



<a name="257733071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733071">(Oct 15 2021 at 17:17)</a>:</h4>
<p>Besides the test that you mentioned previously, we have one other test failing though:</p>
<div class="codehilite"><pre><span></span><code>// run-pass
#![feature(generic_const_exprs)]
#![allow(incomplete_features)]

trait Foo {}

impl&lt;const N: usize&gt; Foo for [(); N] where Self: FooImpl&lt;{ N == 0 }&gt; {}

trait FooImpl&lt;const IS_ZERO: bool&gt; {}

impl FooImpl&lt;{ 0u8 == 0u8 }&gt; for [(); 0] {}

impl&lt;const N: usize&gt; FooImpl&lt;{ 0u8 != 0u8 }&gt; for [(); N] {}

fn foo&lt;T: Foo&gt;(_v: T) {}

fn main() {
    foo([]);
    foo([()]);
}
</code></pre></div>
<p>which seems like a more serious problem</p>



<a name="257733072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733072">(Oct 15 2021 at 17:17)</a>:</h4>
<p>oh thats a relief</p>



<a name="257733118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733118">(Oct 15 2021 at 17:17)</a>:</h4>
<p><em>that</em> on the other hand isnt</p>



<a name="257733122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733122">(Oct 15 2021 at 17:17)</a>:</h4>
<p>I'm trying to investigate, but if you have any ideas now, let me know please</p>



<a name="257733273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733273">(Oct 15 2021 at 17:18)</a>:</h4>
<p>what is the error message you're getting?</p>



<a name="257733343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733343">(Oct 15 2021 at 17:19)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0119]: conflicting implementations of trait `FooImpl&lt;{ 0u8 == 0u8 }&gt;` for type `[(); 0]`
  --&gt; src/test/ui/const-generics/generic_const_exprs/issue-73899.rs:13:1
   |
11 | impl FooImpl&lt;{ 0u8 == 0u8 }&gt; for [(); 0] {}
   | ------------- first implementation here
12 |
13 | impl&lt;const N: usize&gt; FooImpl&lt;{ 0u8 != 0u8 }&gt; for [(); N] {}
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ conflicting implementation for `[(); 0]`

error: aborting due to previous error
</code></pre></div>



<a name="257733375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733375">(Oct 15 2021 at 17:19)</a>:</h4>
<p>Seems as if the constants arent being evaluated at all here</p>



<a name="257733411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733411">(Oct 15 2021 at 17:19)</a>:</h4>
<p>hmm yeah</p>



<a name="257733650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733650">(Oct 15 2021 at 17:21)</a>:</h4>
<p>mmmm does the error go away if you call <code>infcx.resolve_vars_if_possible</code> on the substs</p>



<a name="257733782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733782">(Oct 15 2021 at 17:22)</a>:</h4>
<p>though im not sure why there are inference vars here, i'm not familiar with this code lol</p>



<a name="257733914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257733914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257733914">(Oct 15 2021 at 17:23)</a>:</h4>
<p>I'll try that out. But you're right we should definitely check whether we can resolve infer vars before postponing any evaluations.</p>



<a name="257736340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60delay_span_bug%60%20calls%20in%20non-needed%20caller%20bounds/near/257736340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60delay_span_bug.60.20calls.20in.20non-needed.20caller.20bounds.html#257736340">(Oct 15 2021 at 17:39)</a>:</h4>
<p>ok that fixes it. Thanks a lot, Boxy</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>