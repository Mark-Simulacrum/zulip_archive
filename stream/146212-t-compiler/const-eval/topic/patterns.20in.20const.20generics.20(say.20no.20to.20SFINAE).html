<html>
<head><meta charset="utf-8"><title>patterns in const generics (say no to SFINAE) · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html">patterns in const generics (say no to SFINAE)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276306608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276306608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276306608">(Mar 23 2022 at 09:30)</a>:</h4>
<p>Really short version: no silent CTFE errors, but specify legal patterns in the generics.</p>
<p>When checking whether an impl overlaps with another, we first check the pattern, if that has no overlap, we compute the constants with loud errors.</p>
<p>Syntactically I am thinking something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="w"> </span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>Now I get that this is not perfectly general (no way to specify logic for even vs odd array sizes or special case all powers of two), but it would cover this recurring use case of special casing ranges.</p>



<a name="276306968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276306968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276306968">(Mar 23 2022 at 09:34)</a>:</h4>
<blockquote>
<p>Now I get that this is not perfectly general (no way to specify logic for even vs odd array sizes or special case all powers of two), but it would cover this recurring use case of special casing ranges.</p>
</blockquote>
<p>Yeah, but that's something we definitely want to support, don't we?</p>



<a name="276306982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276306982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276306982">(Mar 23 2022 at 09:34)</a>:</h4>
<p>so we still need silent CTFE errors</p>



<a name="276307034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276307034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276307034">(Mar 23 2022 at 09:35)</a>:</h4>
<p>generally I am not completely happy with having fallible patterns here</p>



<a name="276307128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276307128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276307128">(Mar 23 2022 at 09:36)</a>:</h4>
<p>though xd</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">OPT</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MaybeLen</span><span class="o">&lt;</span><span class="n">OPT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="276307137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276307137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276307137">(Mar 23 2022 at 09:36)</a>:</h4>
<p>avoiding the need for constraining impls :3</p>



<a name="276307283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276307283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276307283">(Mar 23 2022 at 09:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/patterns.20in.20const.20generics.20.28say.20no.20to.20SFINAE.29/near/276307128">said</a>:</p>
<blockquote>
<p>though xd</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">OPT</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MaybeLen</span><span class="o">&lt;</span><span class="n">OPT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>idk, it feels a bit like a hack to me especially this. And if we can't avoid anything impl wise with this approach, I don't think adding it is worth the additional complexity</p>



<a name="276307294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276307294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276307294">(Mar 23 2022 at 09:38)</a>:</h4>
<p>both impl wise and learnability for the user</p>



<a name="276314992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276314992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276314992">(Mar 23 2022 at 10:49)</a>:</h4>
<blockquote>
<p>Yeah, but that's something we definitely want to support, don't we?</p>
</blockquote>
<p>I don't know... it's cool to be able to do it, but do we have valid use cases?</p>
<p>we should probably bring patterns up as a valid, but limited alternative. </p>
<p>OK back to my drawing board</p>



<a name="276315151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315151">(Mar 23 2022 at 10:50)</a>:</h4>
<p>even <code>impl&lt;const OPT @ Some(N): Option&lt;usize&gt; MaybeLen&lt;OPT&gt; {}</code> is something I don't want to write</p>



<a name="276315219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315219">(Mar 23 2022 at 10:51)</a>:</h4>
<p>I want to instead write</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MaybeLen</span><span class="o">&lt;</span><span class="nb">Some</span><span class="p">(</span><span class="n">OPT</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="276315247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315247">(Mar 23 2022 at 10:51)</a>:</h4>
<p>and that does have quite a few valid use cases</p>



<a name="276315345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315345">(Mar 23 2022 at 10:52)</a>:</h4>
<p>i would generally assume that people will use "non-patternable" conditions during candidate selection</p>



<a name="276315731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315731">(Mar 23 2022 at 10:55)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">MyExt</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">fn</span> <span class="nf">arr_and_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyExt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">some_function</span><span class="p">(</span><span class="n">N</span><span class="p">)];</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">arr_and_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Self</span>::<span class="n">Output</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">MyExt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">arr_and_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Self</span>::<span class="n">Output</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276315837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315837">(Mar 23 2022 at 10:56)</a>:</h4>
<p>if we want to <code>array_where_some_function_panics.arr_and_slice()</code> to use the slice version instead, we have to add a condition to prevent a loud error</p>



<a name="276315850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/patterns%20in%20const%20generics%20%28say%20no%20to%20SFINAE%29/near/276315850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/patterns.20in.20const.20generics.20(say.20no.20to.20SFINAE).html#276315850">(Mar 23 2022 at 10:56)</a>:</h4>
<p>idk if that pattern seems too likely</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>