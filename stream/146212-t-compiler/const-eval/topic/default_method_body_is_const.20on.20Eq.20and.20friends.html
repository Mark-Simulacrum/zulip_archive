<html>
<head><meta charset="utf-8"><title>default_method_body_is_const on Eq and friends · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html">default_method_body_is_const on Eq and friends</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265059358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265059358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265059358">(Dec 15 2021 at 19:09)</a>:</h4>
<p>I opened <a href="https://github.com/rust-lang/rust/issues/91439">#91439</a>, but it's failing due to a shortcoming in the interpreter. Specifically <code>is_ctfe_mir_available</code> seems to return <code>false</code> when called on a defaulted method body <a href="https://github.com/rust-lang/rust/blob/c5ecc157043ba413568b09292001a4a74b541a4e/compiler/rustc_const_eval/src/const_eval/machine.rs#L244">here</a>. My guess is that we need to force <code>mir_for_ctfe</code> for default methods that are <code>const</code>. Does that sound right?</p>



<a name="265060410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265060410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265060410">(Dec 15 2021 at 19:16)</a>:</h4>
<p>is this just cross crate? because I thought we had a test checking that it actually works</p>



<a name="265060434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265060434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265060434">(Dec 15 2021 at 19:16)</a>:</h4>
<p>(it being the attribute, not cross crate)</p>



<a name="265065969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265065969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265065969">(Dec 15 2021 at 19:54)</a>:</h4>
<p>My tests are in <code>core</code>, and the default impls are also in <code>core</code>, so I think it's not cross-crate.</p>



<a name="265066529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265066529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265066529">(Dec 15 2021 at 19:58)</a>:</h4>
<p>Another possibility is that <code>PartialEq::ne</code>is special-cased somehow by the time it gets to the MIR pipeline?</p>



<a name="265067735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265067735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265067735">(Dec 15 2021 at 20:05)</a>:</h4>
<p>Oh, btw the issue also occurs when writing <code>.lt</code>, it's not specific to <code>&lt;</code>.</p>



<a name="265078849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265078849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265078849">(Dec 15 2021 at 21:39)</a>:</h4>
<p>Can you build a standalone example or is it core or lang item specific?</p>



<a name="265085065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265085065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265085065">(Dec 15 2021 at 22:27)</a>:</h4>
<p>It doesn't work cross crate and <code>library/core/tests/cmp.rs</code> is an integration test which is cross-crate.</p>



<a name="265090925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265090925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265090925">(Dec 15 2021 at 23:22)</a>:</h4>
<p>So yea, we don't seem to be putting the mir for CTFE into crate metadata for these functions.</p>



<a name="265093517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265093517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265093517">(Dec 15 2021 at 23:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="352985">tm</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends/near/265085065">said</a>:</p>
<blockquote>
<p>It doesn't work cross crate and <code>library/core/tests/cmp.rs</code> is an integration test which is cross-crate.</p>
</blockquote>
<p>Heh, whoops. That was not very smart of me.</p>



<a name="265093639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265093639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265093639">(Dec 15 2021 at 23:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends/near/265090925">said</a>:</p>
<blockquote>
<p>So yea, we don't seem to be putting the mir for CTFE into crate metadata for these functions.</p>
</blockquote>
<p>I'm working on some Polonius stuff RN, but I'll get to this in a few days if no one else does.</p>



<a name="265113404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265113404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265113404">(Dec 16 2021 at 05:15)</a>:</h4>
<p>We do need more cross-crate tests and if we are "constifying" more stuff in libcore we must be sure that it doesn't affect stable code.</p>
<p><a href="https://github.com/rust-lang/rust/pull/91928#issuecomment-993839596">https://github.com/rust-lang/rust/pull/91928#issuecomment-993839596</a> &lt;- this is failing due to a cross-crate issue as well I think.</p>



<a name="265157097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const%20on%20Eq%20and%20friends/near/265157097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/default_method_body_is_const.20on.20Eq.20and.20friends.html#265157097">(Dec 16 2021 at 13:43)</a>:</h4>
<p>Just opened <a href="https://github.com/rust-lang/rust/issues/92001">#92001</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>