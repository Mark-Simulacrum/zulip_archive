<html>
<head><meta charset="utf-8"><title>const_eval_select assumptions · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html">const_eval_select assumptions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262595905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262595905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262595905">(Nov 24 2021 at 14:31)</a>:</h4>
<p>I only just noticed this in the const_eval_select docs</p>
<blockquote>
<p>The Rust compiler assumes that it is sound to replace a call to a const fn with the result produced by evaluating it at compile-time. If evaluating the function at run-time were to produce a different result, or have any other observable side-effects, the behavior is undefined.</p>
</blockquote>
<p>I don't think this is a good idea. This kind of UB is at best extremely hard to check for -- it is very hard to even define properly. <br>
(Defining it properly requires defining what "same result" means, and equality is hard -- in particular since in this case this is equality of the whole machine state due to possible side-effects.)<br>
We shouldnt have UB that we can not properly define or test for. Hence I dont think we should allow the compiler to do such replacement.</p>



<a name="262597480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262597480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262597480">(Nov 24 2021 at 14:45)</a>:</h4>
<p>yea, it's more "library-UB" than anything else</p>



<a name="262626166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262626166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262626166">(Nov 24 2021 at 18:38)</a>:</h4>
<p>it pretty clearly says "the compiler assumes" though, which cannot be library UB</p>



<a name="262626701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262626701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262626701">(Nov 24 2021 at 18:44)</a>:</h4>
<p>Yea, that's mostly suboptimal formulation. I don't believe anyone has plans to actually do this. I don't see a reason for it. It's just the same problem with any other optimization that eagerly evaluates a const fn call or memoizes it at runtime. We have no way of knowing whether a const fn is pure</p>



<a name="262941915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262941915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262941915">(Nov 28 2021 at 18:35)</a>:</h4>
<p>Hm, I wondering what it would even mean for this to be "library UB", given that it is a language intrinsic...</p>



<a name="262941983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262941983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262941983">(Nov 28 2021 at 18:36)</a>:</h4>
<p>and I think there is an interesting underlying safety question here: given a safe crate <code>evil</code>, is it sound to write code like this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dont_be_evil</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">evil</span>::<span class="n">do_something</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evil</span>::<span class="n">do_something</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unreachable_unchecked</span><span class="p">()</span>: <span class="p">}}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262943108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262943108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262943108">(Nov 28 2021 at 19:01)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/91325">https://github.com/rust-lang/rust/pull/91325</a></p>



<a name="262943421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262943421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262943421">(Nov 28 2021 at 19:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/const_eval_select.20assumptions/near/262597480">said</a>:</p>
<blockquote>
<p>yea, it's more "library-UB" than anything else</p>
</blockquote>
<p>I am pretty sure we are already violating this with <code>align_offset</code>...<br>
<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8118d91a56a277ecb6653c8c70a66641">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8118d91a56a277ecb6653c8c70a66641</a><br>
Or maybe I misinterpreted what you meant by "library UB". My interpretation of it is you want <code>dont_be_evil</code> to be sound. But it already isnt (using unstable features).</p>



<a name="262943703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262943703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262943703">(Nov 28 2021 at 19:16)</a>:</h4>
<p>I think we basically either have to make <code>const_align_offset</code> <code>unsafe</code> (putting an obligation on the caller that the compiletime/runtime distinction is <em>not observable</em>), or we have to entirely get rid of this <code>const_eval_select</code> side-condition and just live with the fact that the same function can behave vastly differently at compiletime and runtime.</p>



<a name="262944978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262944978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262944978">(Nov 28 2021 at 19:49)</a>:</h4>
<p>having functions behave differently at compile and runtime also helps unblock floating point in const</p>



<a name="262945030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262945030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262945030">(Nov 28 2021 at 19:50)</a>:</h4>
<p>honestly, i think that condition is way more trouble than its worth, even if it seems like it might be nice for the compiler to be able to do things like that</p>



<a name="262945385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262945385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262945385">(Nov 28 2021 at 19:59)</a>:</h4>
<p>I dont think the compiler should be able to do things like that (and I tried to make that clear above, in fact my first message in this thread complains exactly about that... not sure how I could have been more clear here. :/ ). But possibly other libraries (in particular unsafely implemented ones) should.</p>



<a name="262947868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262947868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262947868">(Nov 28 2021 at 21:00)</a>:</h4>
<p>I think we'll end up violating the "equality rule" (whatever equality would mean) anyway, once we get const heap. I would very much like const_eval_select to be safe and public. It feels to me similarly footgunny like mem::forget, but I can't really say why it should be unsafe forever. We just declared it as such because it was the safe (heh) choice to start out with</p>



<a name="262954693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262954693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262954693">(Nov 28 2021 at 23:35)</a>:</h4>
<p>Yeah, it seems too easy for people to add stuff like debug assertions or logging to the non-const version (we even do the former in the stdlib — we only do it in cases where the assertion would be UB if it triggered, but i could easily see people wanting to use it for a correctness check, not realizing the issue)</p>



<a name="262954750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262954750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262954750">(Nov 28 2021 at 23:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/const_eval_select.20assumptions/near/262945385">said</a>:</p>
<blockquote>
<p>I tried to make that clear above, in fact my first message in this thread complains exactly about that... not sure how I could have been more clear here. :/</p>
</blockquote>
<p>You were clear, I was agreeing. Sorry if it came off as a disagreement.</p>



<a name="262957169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_eval_select%20assumptions/near/262957169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_eval_select.20assumptions.html#262957169">(Nov 29 2021 at 00:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/const_eval_select.20assumptions/near/262947868">said</a>:</p>
<blockquote>
<p>I think we'll end up violating the "equality rule" (whatever equality would mean) anyway, once we get const heap. I would very much like const_eval_select to be safe and public. It feels to me similarly footgunny like mem::forget, but I can't really say why it should be unsafe forever. We just declared it as such because it was the safe (heh) choice to start out with</p>
</blockquote>
<p>it's a safe choice only as long as we follow our own rules ;)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>