<html>
<head><meta charset="utf-8"><title>const impl trait const check · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html">const impl trait const check</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249962951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20impl%20trait%20const%20check/near/249962951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html#249962951">(Aug 19 2021 at 09:41)</a>:</h4>
<p>we allow non const param candidates as const if there are no non-const trait impls for that trait</p>



<a name="249963007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20impl%20trait%20const%20check/near/249963007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html#249963007">(Aug 19 2021 at 09:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/4968a8bbd19cea8713aabff9b1575ec60e208670/compiler/rustc_mir/src/transform/check_consts/check.rs#L889-L902">https://github.com/rust-lang/rust/blob/4968a8bbd19cea8713aabff9b1575ec60e208670/compiler/rustc_mir/src/transform/check_consts/check.rs#L889-L902</a></p>



<a name="249963044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20impl%20trait%20const%20check/near/249963044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html#249963044">(Aug 19 2021 at 09:42)</a>:</h4>
<p>this seems wrong to me:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// crate-a</span>
<span class="cp">#![feature(const_fn_trait_bound)]</span><span class="w"></span>
<span class="cp">#![feature(const_trait_impl)]</span><span class="w"></span>
<span class="cp">#![feature(const_trait_bound_opt_out)]</span><span class="w"></span>
<span class="cp">#![allow(incomplete_features)]</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">assoc</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="k">const</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>::<span class="n">assoc</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crate-b</span>
<span class="cp">#![feature(const_fn_trait_bound)]</span><span class="w"></span>
<span class="cp">#![feature(const_trait_impl)]</span><span class="w"></span>
<span class="cp">#![feature(const_trait_bound_opt_out)]</span><span class="w"></span>
<span class="cp">#![allow(incomplete_features)]</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">a</span>::<span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">assoc</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"hey ho"</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">F</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w">  </span><span class="n">a</span>::<span class="n">foo</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249963061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20impl%20trait%20const%20check/near/249963061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html#249963061">(Aug 19 2021 at 09:43)</a>:</h4>
<p>results in </p>
<div class="codehilite"><pre><span></span><code>error[E0080]: could not evaluate static initializer
  --&gt; /home/lcnr/wtf/a/src/lib.rs:11:5
   |
11 |     T::assoc()
   |     ^^^^^^^^^^
   |     |
   |     calling non-const function `&lt;Foo as A&gt;::assoc`
   |     inside `foo::&lt;Foo&gt;` at /home/lcnr/wtf/a/src/lib.rs:11:5
   |
  ::: src/main.rs:15:19
   |
15 | static F: bool =  a::foo::&lt;Foo&gt;();
   |                   --------------- inside `F` at src/main.rs:15:19
</code></pre></div>



<a name="249963073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20impl%20trait%20const%20check/near/249963073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html#249963073">(Aug 19 2021 at 09:43)</a>:</h4>
<p>i.e. const eval throws ub</p>



<a name="249965485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const%20impl%20trait%20const%20check/near/249965485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const.20impl.20trait.20const.20check.html#249965485">(Aug 19 2021 at 10:11)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="361356">@fee1-dead</span> I guess at this point we should move to re-using the regular trait system logic to prove bounds on the param env by making sure <code>?const</code> bounds show up as <code>NotConst</code> in the param env, while having a substitution system that replaces all <code>?const</code> bounds with <code>NotConst</code> or <code>Const</code> depending on the constness of the caller. That way we don't have to duplicate such checking and can just trust the trait system to figure it out</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>