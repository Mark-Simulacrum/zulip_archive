<html>
<head><meta charset="utf-8"><title>Do we want the result of size_of to be considered stable? · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html">Do we want the result of size_of to be considered stable?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276359123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276359123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276359123">(Mar 23 2022 at 16:17)</a>:</h4>
<p>From the "How do we want const generics to impact stability?" topic:</p>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/How.20do.20we.20want.20const.20generics.20to.20impact.20stability.3F/near/276353752">said</a>:</p>
<blockquote>
<p>I do actually want to be able to write code like <code>let a: [u8; std::mem::size_of::&lt;Foo&gt;()] = [1, 2, 3, 4]</code>. And I would <em>expect</em> it to stop compiling if Foo changed size.</p>
</blockquote>



<a name="276359352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276359352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276359352">(Mar 23 2022 at 16:18)</a>:</h4>
<p>There's a good argument to be made that the above code should be a deny-by-default lint, because it can be a breaking change if the internals of Foo change.</p>



<a name="276359798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276359798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276359798">(Mar 23 2022 at 16:21)</a>:</h4>
<p>To be specific, there are multiple scenarios where the above code breaks:</p>
<ul>
<li>(Acceptable) Foo is defined in your crate, and you added a field.</li>
<li>(Bad) Foo is imported from another crate. The developer added a private field, and you just updated your dependencies (maybe without even realizing it).</li>
<li>(Bad) Foo didn't change, but you upgraded your compiler, and the way Foo is laid out changed, its size is now different.</li>
</ul>



<a name="276359973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276359973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276359973">(Mar 23 2022 at 16:22)</a>:</h4>
<p>Scenario 1 isn't a problem (you changed the fields yourself, you can expect the size to change)</p>



<a name="276360257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276360257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276360257">(Mar 23 2022 at 16:24)</a>:</h4>
<p>Scenario 2 can be guarded against: say that <code>size_of</code> returns an opaque const value if the type has private fields, or is marked as <code>#[non_exhaustive]</code>.</p>



<a name="276360549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276360549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276360549">(Mar 23 2022 at 16:25)</a>:</h4>
<p>Scenario 3 is harder to guard against: you have to say that <code>size_of</code> is opaque unless &lt;previous conditions&gt; AND the type has a representation that is guaranteed to be fixed (currently this is only <code>repr(C)</code>).</p>



<a name="276360769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276360769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276360769">(Mar 23 2022 at 16:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F/near/276360257">said</a>:</p>
<blockquote>
<p>Scenario 2 can be guarded against: say that <code>size_of</code> returns an opaque const value if the type has private fields, or is marked as <code>#[non_exhaustive]</code>.</p>
</blockquote>
<p>Can't that already break today, via dependencies on <code>size_of</code>? You could write an assert.</p>



<a name="276360826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276360826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276360826">(Mar 23 2022 at 16:26)</a>:</h4>
<p>?</p>



<a name="276360849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276360849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276360849">(Mar 23 2022 at 16:26)</a>:</h4>
<p>You mean break at runtime?</p>



<a name="276361089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361089">(Mar 23 2022 at 16:28)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">mytest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">ForeignType</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276361115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361115">(Mar 23 2022 at 16:28)</a>:</h4>
<p>Sure</p>



<a name="276361134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361134">(Mar 23 2022 at 16:28)</a>:</h4>
<p>You're allowed to write that today. Is that "breakage"?</p>



<a name="276361164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361164">(Mar 23 2022 at 16:28)</a>:</h4>
<p>the difference IMO is that you can still compile the crate</p>



<a name="276361238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361238">(Mar 23 2022 at 16:29)</a>:</h4>
<p>(static assert exists, so that also breaks at compile time)</p>



<a name="276361269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361269">(Mar 23 2022 at 16:29)</a>:</h4>
<p>though imo that difference doesn't really matter too much, does it?</p>



<a name="276361308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361308">(Mar 23 2022 at 16:29)</a>:</h4>
<p>i think the context is making static assert not work for sizes of thigns not guaranteed isnt it</p>



<a name="276361391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361391">(Mar 23 2022 at 16:29)</a>:</h4>
<p>I think this is like the difference between using regular references and using refcells.</p>



<a name="276361446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361446">(Mar 23 2022 at 16:30)</a>:</h4>
<p>well yes, but that's a breaking change, which is the issue raised by <span class="user-mention" data-user-id="239881">@Josh Triplett</span> afaict</p>



<a name="276361549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361549">(Mar 23 2022 at 16:30)</a>:</h4>
<p><em>or maybe not, a bit confused</em> <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span></p>



<a name="276361668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361668">(Mar 23 2022 at 16:31)</a>:</h4>
<p>That's what I was wondering as well.</p>



<a name="276361733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361733">(Mar 23 2022 at 16:31)</a>:</h4>
<p>If your dependency uses refcells internally, it may suddenly break at runtime it changes how types are stored or whatever. Making sure it doesn't happen is the responsibility of the upstream maintainer, because they decided to "abandon" the guarantees of the rust type system to do things manually.</p>



<a name="276361773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361773">(Mar 23 2022 at 16:32)</a>:</h4>
<p>It would also be a breaking change to make <code>let x = [0; size_of::&lt;ForeignType&gt;()];</code> stop working, right?</p>



<a name="276361838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361838">(Mar 23 2022 at 16:32)</a>:</h4>
<p>That works today AFAICT.</p>



<a name="276361881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276361881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276361881">(Mar 23 2022 at 16:32)</a>:</h4>
<p>It wouldn't stop working</p>



<a name="276362075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362075">(Mar 23 2022 at 16:33)</a>:</h4>
<p>It'd just break to match it up with another constant at compile time? For instance, <code>let x: [0; 4] = [0; size_of::&lt;ForeignType&gt;()];</code>?</p>



<a name="276362107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362107">(Mar 23 2022 at 16:33)</a>:</h4>
<p>Yeah</p>



<a name="276362191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362191">(Mar 23 2022 at 16:34)</a>:</h4>
<p>Quoting the examples again:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">make_array</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">];</span><span class="w"></span>

<span class="c1">// ALLOWED</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_array</span><span class="p">();</span><span class="w"></span>

<span class="c1">// ALLOWED</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>

<span class="c1">// MAYBE ALLOWED</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>

<span class="c1">// ERROR</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">];</span><span class="w"></span>

<span class="c1">// ERROR</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>
</code></pre></div>



<a name="276362252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362252">(Mar 23 2022 at 16:34)</a>:</h4>
<p>(note that I have no idea how difficult any of this would be to implement)</p>



<a name="276362535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362535">(Mar 23 2022 at 16:36)</a>:</h4>
<blockquote>
<p>It would also be a breaking change to make <code>let x = [0; size_of::&lt;ForeignType&gt;()];</code> stop working, right?</p>
</blockquote>
<p>To be clear, everything mentioned so far would be a breaking change. That's why I said this should be a lint.</p>



<a name="276362670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362670">(Mar 23 2022 at 16:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F/near/276362535">said</a>:</p>
<blockquote>
<blockquote>
<p>It would also be a breaking change to make <code>let x = [0; size_of::&lt;ForeignType&gt;()];</code> stop working, right?</p>
</blockquote>
<p>To be clear, all of this would be a breaking change. That's why I said this should be a lint.</p>
</blockquote>
<p>I see. So you want to add a lint in the current edition, and not actually make it breaking until a future edition?</p>



<a name="276362938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276362938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276362938">(Mar 23 2022 at 16:38)</a>:</h4>
<p>Sure</p>



<a name="276365088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365088">(Mar 23 2022 at 16:51)</a>:</h4>
<p>Also, to finish my summary:</p>
<blockquote>
<p>Scenario 3 is harder to guard against: you have to say that size_of is opaque unless &lt;previous conditions&gt; AND the type has a representation that is guaranteed to be fixed (currently this is only repr(C)).</p>
</blockquote>
<p>Josh argues that this too restrictive, because the ecosystem expects to be able to use the size of a known type to eg transmute it to bytes; though the semantics of safe_transmute are still being hashed out. Josh argues that there may already be an assumption in the ecosystem that the size of a type will not change if its fields don't change, even if the compiler makes no such guarantee. I argued that the ecosystem would definitely be wrong to make such an assumption, because there's a (subjectively) very common understanding that the compiler may add new niches to enums in the future, which would definitely change layouts.</p>
<p>I also suggested that the language could add multiple stable representations over time, eg <code>repr(rust2021)</code>, <code>repr(rust2024)</code>, etc, so that <code>repr(C)</code> isn't the only way to have some stability in how a type is laid out.</p>



<a name="276365286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365286">(Mar 23 2022 at 16:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/How.20do.20we.20want.20const.20generics.20to.20impact.20stability.3F/near/276361919">said</a>:</p>
<blockquote>
<p>The question is, unless it gets specified, how prolific do you want those reprs to be.<br>
I have a similar thing planned (unstable) for lccc, where the central abi defines the layout in that version, and then you can reach for <code>repr(lcrust_v0)</code> to get the layout from a particular version, and there will be one for each new layout, but there won't be that many because I expect to redefine the layout very infrequently: for the most part, only as required.  <br>
That comes with the trade off of having far less optimization opportunities as they have to be weighed against the cost of adding to that.</p>
</blockquote>
<p>I'd say "roughly one representation per edition".</p>



<a name="276365371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365371">(Mar 23 2022 at 16:53)</a>:</h4>
<p>Ok, that's fair.</p>



<a name="276365377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365377">(Mar 23 2022 at 16:53)</a>:</h4>
<p>Note that these representations would only be for types that <em>need</em> a fixed layout.</p>



<a name="276365470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365470">(Mar 23 2022 at 16:53)</a>:</h4>
<p>These layouts would likely have to be specified, as to what transformations are allowed to be performed. <br>
I can help with that</p>



<a name="276365518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365518">(Mar 23 2022 at 16:54)</a>:</h4>
<p>So given eg</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foobar</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="nc">Foo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nc">Bar</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the layout of Foobar would still be implementation-defined</p>



<a name="276365608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365608">(Mar 23 2022 at 16:54)</a>:</h4>
<p>But </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(rust2021)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Foobar</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="nc">Foo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span>: <span class="nc">Bar</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>would have a fixed representation</p>



<a name="276365619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365619">(Mar 23 2022 at 16:54)</a>:</h4>
<p>(I assume you mean unspecified, rather than implementation-defined. I don't see rustc ever documented repr(Rust))</p>



<a name="276365639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276365639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276365639">(Mar 23 2022 at 16:54)</a>:</h4>
<p>Right</p>



<a name="276370554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276370554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276370554">(Mar 23 2022 at 17:24)</a>:</h4>
<p>note that <code>transmute</code> already does such a size check, so if you transmute a repr(Rust) thing to something else, you opt into size change breakage already</p>



<a name="276370604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276370604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276370604">(Mar 23 2022 at 17:25)</a>:</h4>
<p>doing that explicitly via size_of is just a convenient way to opt into breakage <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="276371741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276371741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276371741">(Mar 23 2022 at 17:32)</a>:</h4>
<p>And then we have one (or two if you count usize and isize separately) size that changes depending on target_pointer_width.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_arg_infer)]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">ZEROS1</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="kt">usize</span>::<span class="n">from_ne_bytes</span><span class="p">([</span><span class="sc">b'0'</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="kt">usize</span>::<span class="n">BITS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">ZEROS2</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="kt">usize</span>::<span class="n">from_ne_bytes</span><span class="p">([</span><span class="sc">b'0'</span><span class="p">;</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">()]);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">ZEROS3</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="kt">usize</span>::<span class="n">from_ne_bytes</span><span class="p">([</span><span class="sc">b'0'</span><span class="p">;</span><span class="w"> </span><span class="n">_</span><span class="p">]);</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_ne_bytes</span><span class="p">(</span><span class="n">bytes</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">()])</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// SAFETY: integers are plain old datatypes so we can always transmute to them</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276391905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276391905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276391905">(Mar 23 2022 at 20:03)</a>:</h4>
<p>I think that a change in size_of is only reasonably a semver break <em>if</em> you're already prevented from adding/removing fields by semver. However, if at least one field is private then you're allowed to add more private fields, so you're allowed to change your size_of.</p>



<a name="276408059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276408059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276408059">(Mar 23 2022 at 22:12)</a>:</h4>
<p>Or <code>#[non_exhaustive]</code></p>



<a name="276418841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276418841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276418841">(Mar 24 2022 at 00:06)</a>:</h4>
<p>This all really reminds me of those whole "there should be a derive to opt into stable layout" conversation in safe-transmute, distinct from the underlying marker trait that checks whether it's <em>currently</em> ok.</p>



<a name="276418895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276418895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276418895">(Mar 24 2022 at 00:07)</a>:</h4>
<p>where's repr(linear) when you need it?</p>
<p>if only someone from T-lang was here</p>



<a name="276445962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276445962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276445962">(Mar 24 2022 at 08:51)</a>:</h4>
<p>I have trouble seeing how this works with <code>const foo: usize = std::mem::size_of::&lt;Foo&gt;();</code>, <code>[0; foo]</code>, I'm somewhat thinking about some places, i've had to stash the size_of in a traits associated const (for reasons)... generally these are newtype of a primitive + a phantom data, where the primitive is hidden behind a bunch of trait bounds.</p>



<a name="276446182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276446182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276446182">(Mar 24 2022 at 08:53)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">foo</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>my impl idea was that the value of <code>foo</code> is opaque cause <code>foo</code> uses <code>std::mem::size_of::&lt;Foo&gt;()</code> which is opaque</p>



<a name="276446198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276446198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276446198">(Mar 24 2022 at 08:53)</a>:</h4>
<p>but i haven't thought much about it tbh</p>



<a name="276447025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276447025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276447025">(Mar 24 2022 at 09:01)</a>:</h4>
<p>FWIW, the lib where I think these things are hard to track, <a href="https://github.com/ratmice/enum_extra/blob/main/lib/src/lib.rs#L86">https://github.com/ratmice/enum_extra/blob/main/lib/src/lib.rs#L86</a>, which eventually bottoms out at some <code>std::mem::size_of::&lt;T&gt;::()</code> in some macro call.</p>



<a name="276447851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276447851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276447851">(Mar 24 2022 at 09:10)</a>:</h4>
<p>I guess it should work, because T in this case is always some ground primitive type, but i'm not actually sure if I can show that that is the case, as the type is being pulled out of some macro type, and it just happens that the compiler only allows primitive types there...</p>



<a name="276452913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276452913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276452913">(Mar 24 2022 at 10:01)</a>:</h4>
<p>I use <code>const _: [(); 12] = [(); std::mem::size_of::&lt;Foo&gt;()];</code> all the time to check the size of my type at compile time or assert that it has a specific size for performance reasons. Yes I am aware this is architecture and compiler specific, I want to be informed if the size of my type is affected as a result. There are loads of examples of this use case in rustc, like <a href="https://github.com/rust-lang/rust/blob/600a80dedf71ce02e778e59f4884866c3030c819/compiler/rustc_ast/src/ast.rs#L1127-L1129">this</a>. I don't think this practice should be discouraged, let alone banned.</p>



<a name="276456934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276456934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276456934">(Mar 24 2022 at 10:39)</a>:</h4>
<blockquote>
<p>I don't think this practice should be discouraged, let alone banned.</p>
</blockquote>
<p>I think for your use-case, it would make sense to require a static assert; eg, something that says "I want compilation to fail if this predicate is false, but the predicate isn't guaranteed by the type system".</p>



<a name="276457086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276457086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276457086">(Mar 24 2022 at 10:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="254366">matt rice</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F/near/276445962">said</a>:</p>
<blockquote>
<p>I have trouble seeing how this works with <code>const foo: usize = std::mem::size_of::&lt;Foo&gt;();</code>, <code>[0; foo]</code>, I'm somewhat thinking about some places, i've had to stash the size_of in a traits associated const (for reasons)... generally these are newtype of a primitive + a phantom data, where the primitive is hidden behind a bunch of trait bounds.</p>
</blockquote>
<p>Yeah, the only way opaque consts would make sense if they are infectious. Eg, the following code would be forbidden:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[opaque]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">Y</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="276457137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276457137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276457137">(Mar 24 2022 at 10:41)</a>:</h4>
<blockquote>
<p>Eg, the following code is forbidden:</p>
</blockquote>
<p>why forbidden? can't <code>Y</code> be forced to be opaque as well?</p>



<a name="276457199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276457199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276457199">(Mar 24 2022 at 10:42)</a>:</h4>
<p>Sure, that's what I mean by infectious</p>



<a name="276457230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276457230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276457230">(Mar 24 2022 at 10:42)</a>:</h4>
<p>Eg you'd have to write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[opaque]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[opaque]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">Y</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="276459048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276459048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276459048">(Mar 24 2022 at 11:00)</a>:</h4>
<p>Although... other semantics are possible:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">crate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[opaque]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Y</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">crate</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">a</span>::<span class="p">{</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// OK</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">array</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="n">X</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Y</span><span class="p">];</span><span class="w"></span>

<span class="w">        </span><span class="c1">// ERROR</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">array</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">42</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Y</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276459272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276459272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276459272">(Mar 24 2022 at 11:02)</a>:</h4>
<p>In any case, this is probably something you'd want an escape hatch; a way to say "yes, I know these values aren't guaranteed to unify in future version, but I'm pretty sure they will, so don't bother me".</p>



<a name="276459435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276459435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276459435">(Mar 24 2022 at 11:04)</a>:</h4>
<p>I'm not certain about that second semantics in the case where we have trait associated consts, and you have one trait impl which is opaque and another concrete.  but kind of melts my brain tbh...</p>



<a name="276459498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276459498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276459498">(Mar 24 2022 at 11:05)</a>:</h4>
<p>I guess it'd need to be checked when doing the impl or whatever....</p>



<a name="276460721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276460721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276460721">(Mar 24 2022 at 11:17)</a>:</h4>
<p>You can imagine it'd work like RPITs.</p>



<a name="276460943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276460943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276460943">(Mar 24 2022 at 11:19)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">crate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">A</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">B</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">fn</span> <span class="nf">get_value</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Display</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">fn</span> <span class="nf">get_value</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[opaque]</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">fn</span> <span class="nf">get_value</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">crate</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">a</span>::<span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">MyTrait</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// OK</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">array</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">42</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">A</span>::<span class="n">X</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="c1">// OK</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">A</span>::<span class="n">get_value</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// ERROR</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">array</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">42</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">B</span>::<span class="n">X</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ERROR</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">B</span>::<span class="n">get_value</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276461014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276461014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276461014">(Mar 24 2022 at 11:20)</a>:</h4>
<p>(keeping in mind semantics for RPITs-in-traits aren't stable, etc)</p>



<a name="276461387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276461387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276461387">(Mar 24 2022 at 11:24)</a>:</h4>
<p>Yeah, I think the case i'm worried about is where we do something to the effect of:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">MyTrait</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// ??</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="n">T</span>::<span class="n">X</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276461500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276461500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276461500">(Mar 24 2022 at 11:25)</a>:</h4>
<p>Anyhow that is how these consts propagate in that url i linked above.</p>



<a name="276461870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276461870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276461870">(Mar 24 2022 at 11:29)</a>:</h4>
<p>In that case the constant is already opaque in current Rust, I think?</p>



<a name="276462340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276462340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276462340">(Mar 24 2022 at 11:35)</a>:</h4>
<p>Never mind. I tested some variants in the playground and the compiler doesn't really support the relevant features, so "current rust" doesn't really have an opinion on the subject.</p>



<a name="276462458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276462458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276462458">(Mar 24 2022 at 11:36)</a>:</h4>
<p>Ahh perhaps, I'm not sure I haven't looked into the compiler guts a whole lot at this point</p>



<a name="276462580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Do%20we%20want%20the%20result%20of%20size_of%20to%20be%20considered%20stable%3F/near/276462580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Do.20we.20want.20the.20result.20of.20size_of.20to.20be.20considered.20stable.3F.html#276462580">(Mar 24 2022 at 11:38)</a>:</h4>
<p>It makes sense that, in your example, <code>T::X</code> would be opaque from the point of view of Foo, because there is no guarantee <code>T::X</code> would have any specific value.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>