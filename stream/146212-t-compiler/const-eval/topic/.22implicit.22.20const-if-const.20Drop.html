<html>
<head><meta charset="utf-8"><title>&quot;implicit&quot; const-if-const Drop · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html">&quot;implicit&quot; const-if-const Drop</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267594283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267594283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267594283">(Jan 11 2022 at 15:06)</a>:</h4>
<p>I was just reviewing <a href="https://github.com/rust-lang/rust/pull/92433">https://github.com/rust-lang/rust/pull/92433</a> (cc <span class="user-mention" data-user-id="361356">@fee1-dead</span> ) and was wondering whether any <code>~const Trait</code> bound should automatically imply <code>~const Drop</code>. It would be backwards compatible to add since we have no stable <code>~const Trait</code> bounds yet. It would unfortunately mean that any type that has a <code>Drop</code> impl and implements a trait constly essentially also needs to make its <code>Drop</code> impl const, as it is not really usable in const contexts otherwise. Is that too much of an edge case so we could ignore it (considering there would be no workaround)? Any other ideas on how to prevent us from having to add <code>~const Drop</code> to essentially all generic args of <code>const fn</code>?</p>



<a name="267595198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267595198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267595198">(Jan 11 2022 at 15:13)</a>:</h4>
<p><code>~const Tr</code> does not always require <code>~const Drop</code> though, e.g. <code>fn foo&lt;F: ~const Fn()&gt;(func: &amp;F) {}</code></p>



<a name="267595229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267595229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267595229">(Jan 11 2022 at 15:13)</a>:</h4>
<p>yea, but <em>very often</em> XD</p>



<a name="267595259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267595259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267595259">(Jan 11 2022 at 15:13)</a>:</h4>
<p>although i'd admit that that PR took quite a lot of tokens</p>



<a name="267595308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267595308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267595308">(Jan 11 2022 at 15:13)</a>:</h4>
<p>I just want us to talk about it, maybe someone can come up with a cool solution</p>



<a name="267670539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267670539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267670539">(Jan 12 2022 at 01:10)</a>:</h4>
<p>opt-out: <code>T: ~const Trait + ?Drop</code> means requires maybe-const <code>Trait</code> but doesn't require const drop</p>



<a name="267671566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267671566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267671566">(Jan 12 2022 at 01:23)</a>:</h4>
<p>That could be misinterpreted as <code>T: ~const Trait</code> and <code>T: ?Drop</code>, though.</p>



<a name="267672054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267672054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267672054">(Jan 12 2022 at 01:31)</a>:</h4>
<p><code>~const Trait + ?const Drop</code></p>



<a name="267679873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267679873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267679873">(Jan 12 2022 at 03:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.22implicit.22.20const-if-const.20Drop/near/267595229">said</a>:</p>
<blockquote>
<p>yea, but <em>very often</em> XD</p>
</blockquote>
<p>Some practical data: I checked <code>core/src/option.rs</code>, there are 31<code>~const</code> bounds, 9 of which uses <code>~const Trait + ~const Drop</code>, 14 of them use s <code>~const Drop</code> only, and 8 of <code>~const Trait</code>only. So having <code>~const Trait</code> imply <code>~const Drop</code> just reduces 1 line but now we need 8 negative bounds.</p>



<a name="267679889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/267679889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#267679889">(Jan 12 2022 at 03:54)</a>:</h4>
<p>All <code>~const Trait + ~const Drop</code> cases involves <code>FnOnce()</code></p>



<a name="274880927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/274880927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#274880927">(Mar 10 2022 at 19:08)</a>:</h4>
<p>What, we could do is allow all types to be dropped in const fn but simply make it a no-op for non-const Drop during const eval</p>



<a name="274942654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/274942654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#274942654">(Mar 11 2022 at 08:11)</a>:</h4>
<p>Wouldn't that be inconsistent in some cases? Where the distinction between const eval code and runtime code isn't clear</p>



<a name="274942716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%22implicit%22%20const-if-const%20Drop/near/274942716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.22implicit.22.20const-if-const.20Drop.html#274942716">(Mar 11 2022 at 08:12)</a>:</h4>
<p>It's like the compiler automatically inserting <code>const_eval_select(x, mem::forget, mem::drop)</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>