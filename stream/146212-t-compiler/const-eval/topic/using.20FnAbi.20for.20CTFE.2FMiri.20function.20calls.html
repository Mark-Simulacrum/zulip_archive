<html>
<head><meta charset="utf-8"><title>using FnAbi for CTFE/Miri function calls · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html">using FnAbi for CTFE/Miri function calls</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262934570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262934570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262934570">(Nov 28 2021 at 15:35)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <span class="user-mention" data-user-id="124288">@oli</span> I am finally working on porting Miri to use <code>FnAbi</code> like <span class="user-mention" data-user-id="119009">@eddyb</span> has been suggesting for years. My current progress is at <a href="https://github.com/RalfJung/rust/tree/fni-abi">https://github.com/RalfJung/rust/tree/fni-abi</a>. However, I ran into an ICE that I cannot make sense of:</p>
<div class="codehilite"><pre><span></span><code>---- [ui] ui/const-generics/issues/issue-67739.rs#min stdout ----

error in revision `min`: Error: expected failure status (Some(1)) but received status Some(101).
status: exit status: 101
command: &quot;/home/r/src/rust/rustc.2/build/x86_64-unknown-linux-gnu/stage1/bin/rustc&quot; &quot;/home/r/src/rust/rustc.2/src/test/ui/const-generics/issues/issue-67739.rs&quot; &quot;-Zthreads=1&quot; &quot;--target=x86_64-unknown-linux-gnu&quot; &quot;--cfg&quot; &quot;min&quot; &quot;--error-format&quot; &quot;json&quot; &quot;-Ccodegen-units=1&quot; &quot;-Zui-testing&quot; &quot;-Zdeduplicate-diagnostics=no&quot; &quot;-Zemit-future-incompat-report&quot; &quot;--emit&quot; &quot;metadata&quot; &quot;-C&quot; &quot;prefer-dynamic&quot; &quot;--out-dir&quot; &quot;/home/r/src/rust/rustc.2/build/x86_64-unknown-linux-gnu/test/ui/const-generics/issues/issue-67739.min&quot; &quot;-A&quot; &quot;unused&quot; &quot;-Crpath&quot; &quot;-O&quot; &quot;-Cdebuginfo=0&quot; &quot;-Lnative=/home/r/src/rust/rustc.2/build/x86_64-unknown-linux-gnu/native/rust-test-helpers&quot; &quot;-L&quot; &quot;/home/r/src/rust/rustc.2/build/x86_64-unknown-linux-gnu/test/ui/const-generics/issues/issue-67739.min/auxiliary&quot;
stdout:
------------------------------------------

------------------------------------------
stderr:
------------------------------------------
error: internal compiler error: compiler/rustc_traits/src/normalize_erasing_regions.rs:54:32: could not fully normalize `fn() -&gt; usize {std::mem::size_of::&lt;&lt;Self as Trait&gt;::Associated&gt;}`

thread &#39;rustc&#39; panicked at &#39;Box&lt;dyn Any&gt;&#39;, compiler/rustc_errors/src/lib.rs:1169:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.59.0-dev running on x86_64-unknown-linux-gnu

note: compiler flags: -Z threads=1 -Z ui-testing -Z deduplicate-diagnostics=no -Z emit-future-incompat-report -C codegen-units=1 -C prefer-dynamic -C rpath -C debuginfo=0

query stack during panic:
#0 [normalize_generic_arg_after_erasing_regions] normalizing `fn() -&gt; usize {core::mem::size_of::&lt;&lt;Self as Trait&gt;::Associated&gt;}`
#1 [fn_abi_of_instance] computing call ABI of `core::mem::size_of::&lt;&lt;Self as Trait&gt;::Associated&gt;`
end of query stack
</code></pre></div>
<p>The ICE originates in <a href="https://github.com/RalfJung/rust/blob/faf552d62c5518c6f3f2f9384549626daa913ce5/compiler/rustc_const_eval/src/interpret/terminator.rs#L95">this line</a>, which looks very much like the corresponding code in codegen... so I am not sure what I have to do differently here. (Handling intrinsics differently was meant to fix this but didn't, if I get everything else to work I will likely take that back again.)</p>



<a name="262934643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262934643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262934643">(Nov 28 2021 at 15:36)</a>:</h4>
<p>Here's the full backtrace: <a href="https://pastebin.com/H7Ce6Rdh">https://pastebin.com/H7Ce6Rdh</a></p>



<a name="262934678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262934678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262934678">(Nov 28 2021 at 15:37)</a>:</h4>
<p>also Cc <span class="user-mention" data-user-id="216206">@lcnr</span> since this involves const generics</p>



<a name="262935260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262935260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262935260">(Nov 28 2021 at 15:50)</a>:</h4>
<p>can't look into this until wednesday, but to me this looks like you either have to substitute the generic arguments or you're missing the right param env if you want <code>Self</code> to be generic</p>



<a name="262935267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262935267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262935267">(Nov 28 2021 at 15:51)</a>:</h4>
<p>you need a bound <code>Self: Trait</code> in the param env in this case</p>



<a name="262935288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262935288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262935288">(Nov 28 2021 at 15:51)</a>:</h4>
<p>feel free to remind me at the end of this week if you still need help i and forget this</p>



<a name="262937452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262937452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262937452">(Nov 28 2021 at 16:47)</a>:</h4>
<p>hm, it should be using the param_env from the InterpCx via the <code>HasParamEnv</code> impl.<br>
possibly <a href="https://github.com/RalfJung/rust/blob/faf552d62c5518c6f3f2f9384549626daa913ce5/compiler/rustc_const_eval/src/interpret/terminator.rs#L70-L72">this code</a> is wrong (I had some trouble there dealing with the <code>Binder</code>) -- though the exact same code already exists in <code>traits.rs</code> so I hoped it would be correct.^^</p>



<a name="262937576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262937576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262937576">(Nov 28 2021 at 16:50)</a>:</h4>
<p>it could also be that some of that FnAbi code just is not ready to be called in TooGeneric situations -- situations that <em>do</em> come up in CTFE</p>



<a name="262957527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/using%20FnAbi%20for%20CTFE/Miri%20function%20calls/near/262957527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/using.20FnAbi.20for.20CTFE.2FMiri.20function.20calls.html#262957527">(Nov 29 2021 at 00:48)</a>:</h4>
<p>PR is up at <a href="https://github.com/rust-lang/rust/pull/91342">https://github.com/rust-lang/rust/pull/91342</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>