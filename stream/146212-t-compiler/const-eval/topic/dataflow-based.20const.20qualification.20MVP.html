<html>
<head><meta charset="utf-8"><title>dataflow-based const qualification MVP · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html">dataflow-based const qualification MVP</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="167138317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167138317" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167138317">(Jun 02 2019 at 20:56)</a>:</h4>
<p>What are the odds that a "dedicated beginner" (me) could implement dataflow-based const qualification?</p>
<p>I've read some of the background information (<a href="https://github.com/rust-lang/rust/issues/53819" target="_blank" title="https://github.com/rust-lang/rust/issues/53819">#53819</a>), so I have a rough idea of what is needed. I think this is the next logical step now that <a href="https://github.com/rust-lang/rust/issues/58403" target="_blank" title="https://github.com/rust-lang/rust/issues/58403">#58403</a> has been merged. I'll briefly explain how I would implement this so you can tell me if I'm way off base.</p>
<p>There's currently 4 different qualifications: <code>HasMutInterior</code>, <code>NeedsDrop</code>, <code>IsNotPromotable</code>, <code>IsNotImplicitlyPromotable</code>. Dataflow analysis would track the whether each local is definitely not <code>Qual</code> or maybe <code>Qual</code> (where <code>Qual</code> is one of the aforementioned qualifications). A const block like <code>let a = if 1 == 2 { Some(Vec::new()) } else { None }</code> would result in <code>a</code> being maybe <code>NeedsDrop</code>. There's already a generic framework for bitvector dataflow analysis on MIR, but I'm not sure if it will work here. The <code>join</code> operation for this analysis is  just a union (if a local is maybe qualified from one entrypoint and definitely not qualified from another, it becomes maybe qualifed), but <code>trans</code> is a bit more complex since when one local is assigned to another, its qualification bits must also be copied over. I don't think a simple <code>gen</code>/<code>kill</code> framework allows this.</p>
<p>I don't want to slow down implementation of this feature if it's already on someone's todo list, since I will probably be pretty slow. But if @eddyb is super busy, maybe I could help move this along?</p>



<a name="167138833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167138833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167138833">(Jun 02 2019 at 21:12)</a>:</h4>
<p>Sorry for the extensive edits; this got posted while I was editing it.</p>



<a name="167139022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167139022" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167139022">(Jun 02 2019 at 21:18)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/60166/files#r289447620" target="_blank" title="https://github.com/rust-lang/rust/pull/60166/files#r289447620">https://github.com/rust-lang/rust/pull/60166/files#r289447620</a> should probably also land before this is tackled</p>



<a name="167139042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167139042" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167139042">(Jun 02 2019 at 21:19)</a>:</h4>
<p>Oh and is there any reason <code>IsNotPromotable</code> is not called <code>IsNotConst</code>? I thought implicit promotion is the only promotion we'd have, I never saw the other thing ("normal const stuff") be called "promotion".</p>



<a name="167141130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167141130" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167141130">(Jun 02 2019 at 22:15)</a>:</h4>
<p>In my reading, I found PR <a href="https://github.com/rust-lang/rust/issues/59796" target="_blank" title="https://github.com/rust-lang/rust/issues/59796">#59796</a> that made the change. The justification appears in <a href="https://github.com/rust-lang/rust/pull/58403#discussion_r265978523" target="_blank" title="https://github.com/rust-lang/rust/pull/58403#discussion_r265978523">https://github.com/rust-lang/rust/pull/58403#discussion_r265978523</a>, but I don't understand the second bullet point under "explicit promotion".</p>



<a name="167161573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167161573" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167161573">(Jun 03 2019 at 07:18)</a>:</h4>
<p>so seems like this is about <code>&amp;</code> in <code>const</code> context? Hm. But something also has to check things like <code>foo</code> in <code>const X = foo</code> to e.g. not call run-time methods etc...</p>



<a name="167163279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167163279" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167163279">(Jun 03 2019 at 07:40)</a>:</h4>
<p>Yea.... <code>IsNotPromotable</code> is a bad name and should be <code>IsNotConst</code>, We only have special code for <code>IsNotImplicitlyPromotable</code> since we don't promote const fn calls in regular functions</p>



<a name="167167437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167167437" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167167437">(Jun 03 2019 at 08:39)</a>:</h4>
<p>but <span class="user-mention" data-user-id="119009">@eddyb</span> in that post linked above seems to say we renamed it from <code>IsNotConst</code> to <code>IsNotImplicitlyPromotable</code>?</p>



<a name="167167526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167167526" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167167526">(Jun 03 2019 at 08:40)</a>:</h4>
<p>I guess part of the problem here is that in <code>const X: &amp;i32 = &amp;foo();</code>, this is also called "promotion".</p>



<a name="167169379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167169379" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167169379">(Jun 03 2019 at 09:08)</a>:</h4>
<p>yea</p>



<a name="167169919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167169919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167169919">(Jun 03 2019 at 09:16)</a>:</h4>
<p>but then by which name does the analysis go that checks the part "outside the <code>&amp;</code> in a <code>const</code>?</p>



<a name="167170224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167170224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167170224">(Jun 03 2019 at 09:20)</a>:</h4>
<p>well, that's not one analysis, but two: <code>IsNotConst</code> and <code>IsNotImplicitlyPromotable</code></p>



<a name="167170232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167170232" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167170232">(Jun 03 2019 at 09:20)</a>:</h4>
<p>inside a const you only run <code>IsNotConst</code></p>



<a name="167170772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167170772" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167170772">(Jun 03 2019 at 09:26)</a>:</h4>
<p>I thought <code>IsNotConst</code> aka <code>IsNotPromotable</code> is what gets used inside the <code>&amp;</code>? Or is that the same thing as outside? (IIRC not, because of concerns like interior mutability)</p>



<a name="167173460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173460" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173460">(Jun 03 2019 at 10:03)</a>:</h4>
<p>wait what</p>



<a name="167173479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173479" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173479">(Jun 03 2019 at 10:03)</a>:</h4>
<p>I thought we decided <code>IsNotConst</code> was a pointless name?</p>



<a name="167173501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173501" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173501">(Jun 03 2019 at 10:04)</a>:</h4>
<p>"not const" is either "not promotable" or "an error anyway"</p>



<a name="167173543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173543" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173543">(Jun 03 2019 at 10:04)</a>:</h4>
<p>depending on context</p>



<a name="167173571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173571" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173571">(Jun 03 2019 at 10:04)</a>:</h4>
<blockquote>
<p>but then by which name does the analysis go that checks the part "outside the <code>&amp;</code> in a const?</p>
</blockquote>
<p>it doesn't have a qualification name, that just emits errors</p>



<a name="167173601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173601" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173601">(Jun 03 2019 at 10:05)</a>:</h4>
<p>like, the qualifications are properties of values, and "const-checking errored" isn't really one</p>



<a name="167173606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173606" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173606">(Jun 03 2019 at 10:05)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="120791">@RalfJ</span> does that make sense?</p>



<a name="167173688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173688" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173688">(Jun 03 2019 at 10:06)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> "There's already a generic framework for bitvector dataflow analysis on MIR, but I'm not sure if it will work here" - yes, that is precisely what we mean by "dataflow"</p>



<a name="167173705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173705" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173705">(Jun 03 2019 at 10:06)</a>:</h4>
<p>I <em>never</em> intended for anyone to write a dataflow implementation themselves, I'm sorry if that was ever an interpretation of anything I said</p>



<a name="167173882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173882" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173882">(Jun 03 2019 at 10:09)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> so, each <code>Qualif</code> becomes one dataflow implementation (and, yeah, <code>IsNotX</code> should become <code>MaybeNotX</code> and the rest get prefixed with <code>Maybe</code>) - you can do this generically, using the <code>Qualif</code> trait, FWIW</p>



<a name="167173962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173962" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173962">(Jun 03 2019 at 10:10)</a>:</h4>
<p>union is <code>|</code> and on assignment you <code>gen</code> (which is <code>|=</code>, really)</p>



<a name="167173981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173981" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173981">(Jun 03 2019 at 10:10)</a>:</h4>
<p>you'd never kill anything atm (maybe in the future if we allow an assignment to "clear" flags)</p>



<a name="167173996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173996" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173996">(Jun 03 2019 at 10:10)</a>:</h4>
<p>oh I guess you do kill <code>MaybeNeedsDrop</code> on an <code>Operand::Move</code>, sorry</p>



<a name="167173999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167173999" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167173999">(Jun 03 2019 at 10:10)</a>:</h4>
<p>but that's it</p>



<a name="167174035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174035" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174035">(Jun 03 2019 at 10:11)</a>:</h4>
<p>like, <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/impls/storage_liveness.rs" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/impls/storage_liveness.rs">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/impls/storage_liveness.rs</a> is pretty okay template to start off with</p>



<a name="167174092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174092" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174092">(Jun 03 2019 at 10:12)</a>:</h4>
<p>computing the dataflow should be easy, the slightly trickier part is inspecting the results (because we don't have an ergonomic cursor for it yet)</p>



<a name="167174125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174125" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174125">(Jun 03 2019 at 10:13)</a>:</h4>
<p>or, actually, we don't have to rename anything, you could have <code>Maybe&lt;NeedsDrop&gt;</code> where <code>Maybe</code> is the wrapper that does dataflow</p>



<a name="167174253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174253" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174253">(Jun 03 2019 at 10:15)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> the most important thing is something like <code>some_simd_intrinsic_with_required_const_arg(a, b, 123)</code> - that's forceful promotion so it allows <code>const fn</code> calls, unlike implicit promotion</p>



<a name="167174680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174680" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174680">(Jun 03 2019 at 10:20)</a>:</h4>
<blockquote>
<p>like, the qualifications are properties of values, and "const-checking errored" isn't really one</p>
</blockquote>
<p>that's weird, where is const-checking happening then?^^</p>



<a name="167174806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174806" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174806">(Jun 03 2019 at 10:22)</a>:</h4>
<blockquote>
<p>that's forceful promotion so it allows const fn calls, unlike implicit promotion</p>
</blockquote>
<p>this is still not syntactically visible as <code>const</code> context. Seems dangerous to me.</p>



<a name="167174838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174838" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174838">(Jun 03 2019 at 10:22)</a>:</h4>
<p>Last time we were like "sure let's just allow <code>const fn</code> there" we painted ourselves into a very bad corner. Did we just repeat that mistake...? :(</p>



<a name="167174906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167174906" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167174906">(Jun 03 2019 at 10:23)</a>:</h4>
<p>also, "calls <code>const fn</code>" is not a property of a value, so I am very confused now about what these "qualifications" are</p>



<a name="167193911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167193911" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167193911">(Jun 03 2019 at 14:16)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> ^</p>



<a name="167194102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194102" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194102">(Jun 03 2019 at 14:18)</a>:</h4>
<p>const-checking "just happens". it emits errors</p>



<a name="167194151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194151" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194151">(Jun 03 2019 at 14:19)</a>:</h4>
<p>it's not reified into flags. it either errors and prevents compilation from succeeding, or doesn't</p>



<a name="167194210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194210" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194210">(Jun 03 2019 at 14:19)</a>:</h4>
<p>"the computation of this value may involve a <code>const fn</code> call" is a better description, I guess</p>



<a name="167194214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194214">(Jun 03 2019 at 14:19)</a>:</h4>
<blockquote>
<p>const-checking "just happens". it emits errors</p>
</blockquote>
<p>well that does not seem to work: <a href="https://github.com/rust-lang/rust/pull/61399#discussion_r289727281" target="_blank" title="https://github.com/rust-lang/rust/pull/61399#discussion_r289727281">https://github.com/rust-lang/rust/pull/61399#discussion_r289727281</a></p>



<a name="167194295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194295" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194295">(Jun 03 2019 at 14:20)</a>:</h4>
<p>there we have code that calls a non-const intrinsic, which is allowed -- the check supposed to prevent that is in <code>IsNotPromotable::in_call</code></p>



<a name="167194357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194357" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194357">(Jun 03 2019 at 14:20)</a>:</h4>
<blockquote>
<p>"the computation of this value may involve a <code>const fn</code> call" is a better description, I guess</p>
</blockquote>
<p>it's not <em>values</em> then that matter, but locals? because "the computation of a value" is a nonesneical statement, a value (e.g. <code>3</code>) is already computed</p>



<a name="167194407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194407" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194407">(Jun 03 2019 at 14:21)</a>:</h4>
<p>I'd love if these qualifications could be stated as syntactic appromximations of dynamic properties of a semantic value, but that is seemingly not the case</p>



<a name="167194422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194422" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194422">(Jun 03 2019 at 14:21)</a>:</h4>
<p>I don't mean a concrete value, but things like <code>Operand</code>s</p>



<a name="167194448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194448" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194448">(Jun 03 2019 at 14:21)</a>:</h4>
<p>so, expressions?</p>



<a name="167194473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194473" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194473">(Jun 03 2019 at 14:21)</a>:</h4>
<p>they're not "expressions" in MIR, that's my point</p>



<a name="167194592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194592">(Jun 03 2019 at 14:22)</a>:</h4>
<p>well the closest we got to a consensus in <a href="https://github.com/rust-lang/unsafe-code-guidelines/pull/40" target="_blank" title="https://github.com/rust-lang/unsafe-code-guidelines/pull/40">https://github.com/rust-lang/unsafe-code-guidelines/pull/40</a> was to use "expression" for not-yet-computed things</p>



<a name="167194613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194613" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194613">(Jun 03 2019 at 14:22)</a>:</h4>
<p>they're certainly not values either, FWIW :)</p>



<a name="167194656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194656" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194656">(Jun 03 2019 at 14:23)</a>:</h4>
<p><code>NeedsDrop</code> and <code>HasInteriorMut</code> are properties of values</p>



<a name="167194698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194698" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194698">(Jun 03 2019 at 14:23)</a>:</h4>
<p>though I am also sometimes confused about <code>NeedsDrop</code>, because sometimes it seems to be about whether the  computed value needs dropping, and sometimes about whether computing the value requires dropping some other stuff</p>



<a name="167194758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194758" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194758">(Jun 03 2019 at 14:24)</a>:</h4>
<p>the latter really being a "calling non-const fn" kind of check</p>



<a name="167194761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194761" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194761">(Jun 03 2019 at 14:24)</a>:</h4>
<p>no, it's definitely not the latter</p>



<a name="167194884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194884" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194884">(Jun 03 2019 at 14:25)</a>:</h4>
<p>drops aren't part of the computation, they're side-effects that aren't tracked by any of this</p>



<a name="167194918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194918" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194918">(Jun 03 2019 at 14:25)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I guess you could s/expression/dataflow (sub)graph</p>



<a name="167194938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194938" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194938">(Jun 03 2019 at 14:25)</a>:</h4>
<p>the point is, we have some checks for stuff that need to happen in const context -- such as only calling const fn, not doing forbidden operations (ptr-int casts or so), and so on. the same checks are also relevant when determining candidates for implicit promotion, and the same checks apply in "explicit promotion". So I thought this would all be the same framework.</p>



<a name="167194973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167194973" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167194973">(Jun 03 2019 at 14:25)</a>:</h4>
<blockquote>
<p>drops aren't part of the computation, they're side-effects that aren't tracked by any of this</p>
</blockquote>
<p>drops are definitely part of the computation though... at least the drops happening during the computation</p>



<a name="167195047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195047" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195047">(Jun 03 2019 at 14:26)</a>:</h4>
<p>we don't actually look at <code>Drop</code> terminators</p>



<a name="167195067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195067" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195067">(Jun 03 2019 at 14:26)</a>:</h4>
<p>oO</p>



<a name="167195082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195082" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195082">(Jun 03 2019 at 14:26)</a>:</h4>
<p>so I don't know why you thought that</p>



<a name="167195102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195102" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195102">(Jun 03 2019 at 14:26)</a>:</h4>
<p>well because its the only thing that makes sense?^^</p>



<a name="167195109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195109" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195109">(Jun 03 2019 at 14:26)</a>:</h4>
<p>maybe you confused with the side-effect <code>Operand::Move</code> has?</p>



<a name="167195120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195120">(Jun 03 2019 at 14:26)</a>:</h4>
<p>why would it make sense?</p>



<a name="167195161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195161">(Jun 03 2019 at 14:27)</a>:</h4>
<p>the only reason we want to prevent drops is to avoid calling drop glue that is not a <code>const fn</code> right?</p>



<a name="167195165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195165">(Jun 03 2019 at 14:27)</a>:</h4>
<p><code>NeedsDrop</code> is "<code>Drop(x)</code> might not be a noop"</p>



<a name="167195178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195178" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195178">(Jun 03 2019 at 14:27)</a>:</h4>
<p>so for normal calls we look at <code>Call</code> terminators, and then we also need to separately take care of the implicit drop calls</p>



<a name="167195186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195186" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195186">(Jun 03 2019 at 14:27)</a>:</h4>
<p>that's the dynamic property we actually care about: dont execute a <code>Drop</code> terminator</p>



<a name="167195195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195195" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195195">(Jun 03 2019 at 14:27)</a>:</h4>
<p>brb then I'll look at the code and explain this a bit better</p>



<a name="167195278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195278">(Jun 03 2019 at 14:28)</a>:</h4>
<p>but anyway, in const contexts, we emit errors. whether we emit all the errors we should is another story, and consititutes bugs, basically</p>



<a name="167195280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195280" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195280">(Jun 03 2019 at 14:28)</a>:</h4>
<p><code>NeedsDrop</code> is a different thing, I understand that. we also need to make sure <code>const</code> dont need dropping or so.</p>



<a name="167195289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195289" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195289">(Jun 03 2019 at 14:28)</a>:</h4>
<p>but the other thing also has to be checked somewhere</p>



<a name="167195595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195595" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195595">(Jun 03 2019 at 14:30)</a>:</h4>
<p>but taking a step back -- <code>IsNotPromotable::in_call</code> performs some crucial checks that should be done for <em>any function call in const context</em>. and that makes sense, after all this is about whether some function call can be (explicitly?) promoted to context context. So to me this really sounds like an <code>IsNotConst</code> analysis. And the fact that we don't treat it as such seems to already cause bugs -- and I don't understand how we even ended up there.</p>



<a name="167195878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195878" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195878">(Jun 03 2019 at 14:33)</a>:</h4>
<p>I dont see a qualitative difference between the kind of checks that need to be done in <code>const</code> context to determine if this is okay, and the kind of checks that need to be done "on parts of the MIR of a normal function" to determine if we can promote it. many of the checks are very similar, just the latter case should be a bit more restrictive.<br>
The fact that we have <em>two different</em> kinds of things working "on parts of the MIR of a normal function" makes me very uneasy. I don't see any good argument for that. We already have a way to explicitly ask for const context (and hence get everything "promoted"): make it a <code>const</code> item.</p>



<a name="167195952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167195952" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167195952">(Jun 03 2019 at 14:33)</a>:</h4>
<p>I don't think the niche usecase of SIMD intrinsics with some arguments having to be <code>const</code> justifies making promotability analysis (an extremely subtle piece of code with a history of bugs) more complicated</p>



<a name="167196020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196020" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196020">(Jun 03 2019 at 14:34)</a>:</h4>
<p><em>sigh</em></p>



<a name="167196170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196170" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196170">(Jun 03 2019 at 14:35)</a>:</h4>
<p>so, <code>Drop</code>: we <em>read</em> <code>NeedsDrop</code>, but not <em>write</em> it: <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1357" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1357">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1357</a></p>



<a name="167196205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196205" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196205">(Jun 03 2019 at 14:35)</a>:</h4>
<p>does this make sense?</p>



<a name="167196311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196311">(Jun 03 2019 at 14:36)</a>:</h4>
<p><code>NeedsDrop</code> doesn't capture that a <code>Drop</code> has happened or might happen or anything like that</p>



<a name="167196402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196402">(Jun 03 2019 at 14:37)</a>:</h4>
<p>this looks wrong tho <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L489" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L489">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L489</a></p>



<a name="167196436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196436" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196436">(Jun 03 2019 at 14:37)</a>:</h4>
<p>yeah I got that :) now I am not sure where "the other" drop analysis is happening though but that's okay. probably the same place as some of the other things that I dont know where they are happening.</p>



<a name="167196498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196498">(Jun 03 2019 at 14:38)</a>:</h4>
<p>uhm, there is no other analysis?</p>



<a name="167196505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196505">(Jun 03 2019 at 14:38)</a>:</h4>
<p>I really don't know what you're talking about</p>



<a name="167196538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196538" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196538">(Jun 03 2019 at 14:38)</a>:</h4>
<p>"const checking", wherever that is in the code</p>



<a name="167196585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196585" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196585">(Jun 03 2019 at 14:39)</a>:</h4>
<p>no, that is the check</p>



<a name="167196589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196589" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196589">(Jun 03 2019 at 14:39)</a>:</h4>
<p>you're looking at it</p>



<a name="167196594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196594" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196594">(Jun 03 2019 at 14:39)</a>:</h4>
<p>that's const-checking</p>



<a name="167196714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196714">(Jun 03 2019 at 14:40)</a>:</h4>
<p>the "other drop analysis" is the one that makes this an error:</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">Foo</span><span class="p">).</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</pre></div>



<a name="167196756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196756" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196756">(Jun 03 2019 at 14:40)</a>:</h4>
<p>what I linked is what causes that error</p>



<a name="167196795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196795">(Jun 03 2019 at 14:41)</a>:</h4>
<p>it really is that simple</p>



<a name="167196820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196820" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196820">(Jun 03 2019 at 14:41)</a>:</h4>
<p>simple?!??</p>



<a name="167196825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196825" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196825">(Jun 03 2019 at 14:41)</a>:</h4>
<p>this is all crazy complicated^^</p>



<a name="167196857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196857">(Jun 03 2019 at 14:41)</a>:</h4>
<p>simple would be "walk the MIR, if there is a <code>Drop</code> terminator then complain". or something like that.</p>



<a name="167196865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196865" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196865">(Jun 03 2019 at 14:41)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1370-L1371" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1370-L1371">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1370-L1371</a></p>



<a name="167196868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196868" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196868">(Jun 03 2019 at 14:41)</a>:</h4>
<p>it's right here</p>



<a name="167196879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196879">(Jun 03 2019 at 14:41)</a>:</h4>
<p>yes, this is what this is <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1348" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1348">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1348</a></p>



<a name="167196882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196882" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196882">(Jun 03 2019 at 14:41)</a>:</h4>
<p>this is just a visit of the MIR</p>



<a name="167196965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196965" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196965">(Jun 03 2019 at 14:42)</a>:</h4>
<p>but this is... not part of any qualif...?</p>



<a name="167196970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196970" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196970">(Jun 03 2019 at 14:42)</a>:</h4>
<p>it checks <code>NeedsDrop</code> because this runs pre-elaboration (drop elaboration has to run after borrowck but this code must run before borrowck)</p>



<a name="167196999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167196999" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167196999">(Jun 03 2019 at 14:42)</a>:</h4>
<p>no, it's inside this impl block <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L923-L928" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L923-L928">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L923-L928</a></p>



<a name="167197062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197062" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197062">(Jun 03 2019 at 14:43)</a>:</h4>
<p>hm okay</p>



<a name="167197133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197133" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197133">(Jun 03 2019 at 14:44)</a>:</h4>
<p>the qualifs have been split out, so everything should be fairly readable now</p>



<a name="167197141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197141" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197141">(Jun 03 2019 at 14:44)</a>:</h4>
<p>the overall structure is still making my head explode</p>



<a name="167197147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197147" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197147">(Jun 03 2019 at 14:44)</a>:</h4>
<p>they are computed structurally, and then read by the checking code</p>



<a name="167197152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197152">(Jun 03 2019 at 14:44)</a>:</h4>
<p>like, so where's the thing that prevents <code>&amp;(0, Foo).0</code> from being promoted?</p>



<a name="167197167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197167">(Jun 03 2019 at 14:45)</a>:</h4>
<p>once we move to dataflow they'll be even more decoupled</p>



<a name="167197179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197179" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197179">(Jun 03 2019 at 14:45)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> that is the promotion check also reading <code>NeedsDrop</code></p>



<a name="167197199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197199" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197199">(Jun 03 2019 at 14:45)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L760" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L760">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L760</a></p>



<a name="167197206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197206" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197206">(Jun 03 2019 at 14:45)</a>:</h4>
<p>can't be that check because that shows an error (those <code>mode != Fn</code> things are very hard to understand... I got it now but there's no comments, at least not the places where these decisions are being made)</p>



<a name="167197368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197368" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197368">(Jun 03 2019 at 14:47)</a>:</h4>
<p>(and yes it did get better than it was before, but the structure is still different from what I'd expect so I am still confused^^)</p>



<a name="167197463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197463" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197463">(Jun 03 2019 at 14:48)</a>:</h4>
<p><code>mode != Fn</code> means this is not a runtime-only <code>Fn</code></p>



<a name="167197471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197471" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197471">(Jun 03 2019 at 14:48)</a>:</h4>
<p>maybe <code>Fn</code> should be named <code>RuntimeFn</code>?</p>



<a name="167197478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197478" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197478">(Jun 03 2019 at 14:48)</a>:</h4>
<p>would that help?</p>



<a name="167197481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197481" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197481">(Jun 03 2019 at 14:48)</a>:</h4>
<p>yeah so this is basuically <code>if mode.is_const_context()</code>?</p>



<a name="167197496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197496" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197496">(Jun 03 2019 at 14:49)</a>:</h4>
<p>yes</p>



<a name="167197503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197503" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197503">(Jun 03 2019 at 14:49)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="167197528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197528" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197528">(Jun 03 2019 at 14:49)</a>:</h4>
<p>or, rather <code>.may_const_eval</code> (since <code>ConstFn</code> can be called at runtime too)</p>



<a name="167197540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197540" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197540">(Jun 03 2019 at 14:49)</a>:</h4>
<p>sure but that's still "const context" as far as I am concerned</p>



<a name="167197543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197543" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197543">(Jun 03 2019 at 14:49)</a>:</h4>
<p>and "const context" is ambiguous because it could be interpreted as <code>Mode::Const</code></p>



<a name="167197549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197549" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197549">(Jun 03 2019 at 14:49)</a>:</h4>
<p>right</p>



<a name="167197614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197614" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197614">(Jun 03 2019 at 14:50)</a>:</h4>
<p>"const context" means "typechecked according to the rules of the const-type-system"</p>



<a name="167197654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197654" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197654">(Jun 03 2019 at 14:50)</a>:</h4>
<p><code>may_const_eval</code> is somewhat ambiguous becuase code in a <code>RuntimeFn</code> may const-eval if it gets promoted</p>



<a name="167197674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197674" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197674">(Jun 03 2019 at 14:51)</a>:</h4>
<p>hmm right</p>



<a name="167197695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197695">(Jun 03 2019 at 14:51)</a>:</h4>
<p>crap</p>



<a name="167197704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197704">(Jun 03 2019 at 14:51)</a>:</h4>
<p>that <code>return true</code> is indeed a bug</p>



<a name="167197707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197707" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197707">(Jun 03 2019 at 14:51)</a>:</h4>
<p>which is the other thing that I am not clear about yet (and where I think we have a bug)</p>



<a name="167197708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197708" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197708">(Jun 03 2019 at 14:51)</a>:</h4>
<p>ARGH</p>



<a name="167197714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197714">(Jun 03 2019 at 14:51)</a>:</h4>
<p>there are no tests for it!</p>



<a name="167197724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197724" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197724">(Jun 03 2019 at 14:51)</a>:</h4>
<p>it deeply saddens me that we got <em>two</em> kinds of promotion :(</p>



<a name="167197730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197730" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197730">(Jun 03 2019 at 14:51)</a>:</h4>
<p>for what?</p>



<a name="167197739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197739" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197739">(Jun 03 2019 at 14:51)</a>:</h4>
<p>ah</p>



<a name="167197791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197791" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197791">(Jun 03 2019 at 14:52)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> we merged a boolean confusion back in my refactor and no tests caught it</p>



<a name="167197794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197794" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197794">(Jun 03 2019 at 14:52)</a>:</h4>
<p>so it should be... <code>return false</code>? no that makes less sense?</p>



<a name="167197821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197821">(Jun 03 2019 at 14:52)</a>:</h4>
<p>the <code>_ =&gt; {}</code> should be <code>_ =&gt; return true</code></p>



<a name="167197823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197823" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197823">(Jun 03 2019 at 14:52)</a>:</h4>
<p>it's a whitelist</p>



<a name="167197838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197838" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197838">(Jun 03 2019 at 14:53)</a>:</h4>
<p>ah and the <code>return true</code> should be <code>{}</code>?</p>



<a name="167197870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197870">(Jun 03 2019 at 14:53)</a>:</h4>
<p>that entire match is useless where it is</p>



<a name="167197889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197889" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197889">(Jun 03 2019 at 14:53)</a>:</h4>
<p>it should be in <a href="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1229" target="_blank" title="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1229">https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1229</a> I believe</p>



<a name="167197921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197921" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197921">(Jun 03 2019 at 14:54)</a>:</h4>
<p>that was the point I was getting to. which of the "qualifs" are used for "const checking"? I saw <code>NeedsDrop</code> is used, but what about the others? like, checking that calls are <code>const fn</code>?</p>



<a name="167197978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167197978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167197978">(Jun 03 2019 at 14:54)</a>:</h4>
<p>seems like most of "const checking" is also relevant for deciding if something should get promoted, which is why I originally thought that this was all done inside "qualifs"</p>



<a name="167198051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198051" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198051">(Jun 03 2019 at 14:55)</a>:</h4>
<p>but it seems instead we have some of that duplicated (like checking for <code>NeedsDrop</code> at the <code>Drop</code> terminator for "const checking", and checking for <code>NeedsDrop</code> somewhere in the <code>IsNotPromotable</code> analysis)</p>



<a name="167198111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198111">(Jun 03 2019 at 14:56)</a>:</h4>
<p>we don't check for <code>NeedsDrop</code> in <code>IsNotPromotable</code></p>



<a name="167198124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198124" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198124">(Jun 03 2019 at 14:56)</a>:</h4>
<p>like, the <code>IsNot</code> are general-purpose "for other reasons"</p>



<a name="167198132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198132" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198132">(Jun 03 2019 at 14:56)</a>:</h4>
<p>well we check for "is there any qualif set"</p>



<a name="167198169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198169" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198169">(Jun 03 2019 at 14:57)</a>:</h4>
<p>at <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L760" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L760">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L760</a> as you showed me</p>



<a name="167198177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198177" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198177">(Jun 03 2019 at 14:57)</a>:</h4>
<p>that is basically a duplicate of the <code>Drop</code> terminator check</p>



<a name="167198181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198181" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198181">(Jun 03 2019 at 14:57)</a>:</h4>
<p>yeah</p>



<a name="167198208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198208" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198208">(Jun 03 2019 at 14:57)</a>:</h4>
<p>where I thought that this would be shared (not just the analysis, but the check itself) -- part of why I was so confused</p>



<a name="167198324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198324" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198324">(Jun 03 2019 at 14:59)</a>:</h4>
<p>I mean the check is... just asking if it's set</p>



<a name="167198366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198366">(Jun 03 2019 at 14:59)</a>:</h4>
<p>anyway, let's focus on figuring out this intrinsic-related bug :/</p>



<a name="167198379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198379" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198379">(Jun 03 2019 at 15:00)</a>:</h4>
<p>and then same with the <code>const fn</code> checks, which we seem to have at <a href="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1243" target="_blank" title="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1243">https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1243</a> and <a href="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L495" target="_blank" title="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L495">https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L495</a></p>



<a name="167198474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198474" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198474">(Jun 03 2019 at 15:00)</a>:</h4>
<blockquote>
<p>I mean the check is... just asking if it's set</p>
</blockquote>
<p>sure but it has to remember to do that in a place that has nothing to do with <code>Drop</code>.</p>



<a name="167198515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198515" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198515">(Jun 03 2019 at 15:01)</a>:</h4>
<p>yes because that's how we defined the <code>&amp;rvalue</code> promotion</p>



<a name="167198546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198546" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198546">(Jun 03 2019 at 15:01)</a>:</h4>
<p>we defined the extensional effect, not how it gets achieved.</p>



<a name="167198548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198548">(Jun 03 2019 at 15:01)</a>:</h4>
<p>as opposed to checking if there is a <code>Drop</code> for that temporary</p>



<a name="167198568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198568" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198568">(Jun 03 2019 at 15:01)</a>:</h4>
<p>which we can technically do nowadays</p>



<a name="167198571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198571" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198571">(Jun 03 2019 at 15:01)</a>:</h4>
<p>it was just never considered</p>



<a name="167198652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198652" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198652">(Jun 03 2019 at 15:02)</a>:</h4>
<p>I see</p>



<a name="167198668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198668" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198668">(Jun 03 2019 at 15:02)</a>:</h4>
<p>the <code>Drop</code> check came <em>later</em></p>



<a name="167198682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198682" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198682">(Jun 03 2019 at 15:02)</a>:</h4>
<p>and it was a relaxation of <code>NeedsDrop</code> values being completely banned from compile-time</p>



<a name="167198757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198757" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198757">(Jun 03 2019 at 15:03)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> confirmed boolean confusion <a href="https://github.com/rust-lang/rust/commit/f04424acd1bf894d1dc930c2a347871ea8b96dfa#diff-c2552a106550d05b69d5e07612f0f812L391" target="_blank" title="https://github.com/rust-lang/rust/commit/f04424acd1bf894d1dc930c2a347871ea8b96dfa#diff-c2552a106550d05b69d5e07612f0f812L391">https://github.com/rust-lang/rust/commit/f04424acd1bf894d1dc930c2a347871ea8b96dfa#diff-c2552a106550d05b69d5e07612f0f812L391</a></p>



<a name="167198801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198801" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198801">(Jun 03 2019 at 15:04)</a>:</h4>
<p>do you want to fix this or should I?</p>



<a name="167198816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198816">(Jun 03 2019 at 15:04)</a>:</h4>
<p>I want this fixed before we move anything around</p>



<a name="167198895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198895">(Jun 03 2019 at 15:05)</a>:</h4>
<p>so what this did is allow calls to intrinsics <em>other</em> than those listed, to be promoted</p>



<a name="167198917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198917" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198917">(Jun 03 2019 at 15:05)</a>:</h4>
<p><em>lol</em></p>



<a name="167198982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198982" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198982">(Jun 03 2019 at 15:06)</a>:</h4>
<p>but does that mean that so far nobody can actually use these intrinsics in a <code>rustc_const_arg</code>? So we could just stick to not allowing them there?</p>



<a name="167198983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167198983" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167198983">(Jun 03 2019 at 15:06)</a>:</h4>
<p>basically the <code>{}</code> and <code>return true</code> are swapped :(</p>



<a name="167199023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199023" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199023">(Jun 03 2019 at 15:06)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> it's important for SIMD people to be able to call their <code>const fn</code>s for these arguments</p>



<a name="167199030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199030" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199030">(Jun 03 2019 at 15:06)</a>:</h4>
<p>like, this is already considered settled</p>



<a name="167199045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199045">(Jun 03 2019 at 15:07)</a>:</h4>
<p>and on stable AFAIK</p>



<a name="167199068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199068" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199068">(Jun 03 2019 at 15:07)</a>:</h4>
<p>swapping the two branches is not enough though</p>



<a name="167199080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199080" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199080">(Jun 03 2019 at 15:07)</a>:</h4>
<p>because currently we also allow <em>all</em> intrinsics to be called in a <code>const fn</code></p>



<a name="167199088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199088" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199088">(Jun 03 2019 at 15:07)</a>:</h4>
<p>(except for <code>transmute</code>)</p>



<a name="167199177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199177" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199177">(Jun 03 2019 at 15:08)</a>:</h4>
<p>yes but I want this to be fixed, with a test. and maybe evaluate the impact</p>



<a name="167199187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199187" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199187">(Jun 03 2019 at 15:08)</a>:</h4>
<p>how many intrinsics have we exposed on stable?</p>



<a name="167199211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199211">(Jun 03 2019 at 15:09)</a>:</h4>
<p>IIRC just <code>transmute</code> nowadays</p>



<a name="167199217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199217" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199217">(Jun 03 2019 at 15:09)</a>:</h4>
<p>(we un-exposed some of them recently)</p>



<a name="167199228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199228" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199228">(Jun 03 2019 at 15:09)</a>:</h4>
<p>oh I see</p>



<a name="167199231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199231" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199231">(Jun 03 2019 at 15:09)</a>:</h4>
<p>but that's for "core intrinsics"</p>



<a name="167199242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199242" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199242">(Jun 03 2019 at 15:09)</a>:</h4>
<p>doesnt SIMD have a metric shit-ton of intrinsics and expose them all?</p>



<a name="167199256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199256" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199256">(Jun 03 2019 at 15:09)</a>:</h4>
<p>kinda</p>



<a name="167199275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199275" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199275">(Jun 03 2019 at 15:10)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> it's important for SIMD people to be able to call their <code>const fn</code>s for these arguments</p>
</blockquote>
<p>that makes sense. but is there any way we could let those things be checked by "const checking"? Seems reasonable to accept the same things there and in <code>const</code> items, without having to write the check twice...</p>



<a name="167199322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199322" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199322">(Jun 03 2019 at 15:10)</a>:</h4>
<p>they also abuse "linking" to LLVM intrinsics directly, which is a nightmare</p>



<a name="167199360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199360" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199360">(Jun 03 2019 at 15:10)</a>:</h4>
<p>so it might be that SIMD intrinsics are callable from <code>const fn</code> this way</p>



<a name="167199374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199374" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199374">(Jun 03 2019 at 15:10)</a>:</h4>
<p>I really don't know what you mean by "twice"</p>



<a name="167199388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199388" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199388">(Jun 03 2019 at 15:11)</a>:</h4>
<p>like  <a href="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1243" target="_blank" title="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1243">https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L1243</a> and <a href="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L495" target="_blank" title="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L495">https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L495</a></p>



<a name="167199418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199418" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199418">(Jun 03 2019 at 15:11)</a>:</h4>
<p>which both separately rule out non-const-fn calls</p>



<a name="167199456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199456" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199456">(Jun 03 2019 at 15:11)</a>:</h4>
<p>I am not sure where the other things are enforced for both of these... like using unsafe operations or casting ptrs to ints</p>



<a name="167199512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199512" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199512">(Jun 03 2019 at 15:12)</a>:</h4>
<p>ah I see</p>



<a name="167199528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199528" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199528">(Jun 03 2019 at 15:12)</a>:</h4>
<p>well, for const-checking they need to emit errors</p>



<a name="167199541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199541">(Jun 03 2019 at 15:12)</a>:</h4>
<p>that depend on various things</p>



<a name="167199555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199555" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199555">(Jun 03 2019 at 15:12)</a>:</h4>
<p>for <code>rustc_const_arg</code> they also need to emit errors</p>



<a name="167199579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199579" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199579">(Jun 03 2019 at 15:12)</a>:</h4>
<p>the error is very different</p>



<a name="167199609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199609" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199609">(Jun 03 2019 at 15:13)</a>:</h4>
<p><code>rustc_const_arg</code> doesn't cause the argument to be checked as a constant</p>



<a name="167199620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199620">(Jun 03 2019 at 15:13)</a>:</h4>
<p>is there any reason it should be? "you wrote a thing that can't be CTFE'd in a place where we must do CTFE".</p>



<a name="167199624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199624" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199624">(Jun 03 2019 at 15:13)</a>:</h4>
<p>although it would be interesting to try...</p>



<a name="167199714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199714">(Jun 03 2019 at 15:14)</a>:</h4>
<p>but it would require a much stranger scheme</p>



<a name="167199716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199716">(Jun 03 2019 at 15:14)</a>:</h4>
<p><span class="user-mention" data-user-id="223879">@Mahmut Bulut</span> is looking into statically checking intrinsics in const eval, let's see how bad the fallout is first I guess?</p>



<a name="167199727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199727" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199727">(Jun 03 2019 at 15:14)</a>:</h4>
<p>right now we just compute forward</p>



<a name="167199752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199752" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199752">(Jun 03 2019 at 15:14)</a>:</h4>
<p>I mean I guess a slong as "can call <code>const fn</code>" is the <em>only</em> difference between implicit and explicit promotion we should be good (as in, we should have fairly reasonable test coverage)</p>



<a name="167199761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199761" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199761">(Jun 03 2019 at 15:14)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> please ping me here or on IRC about this so I don't keep track of it</p>



<a name="167199774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199774" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199774">(Jun 03 2019 at 15:14)</a>:</h4>
<p>will do</p>



<a name="167199809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199809" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199809">(Jun 03 2019 at 15:15)</a>:</h4>
<p>to be clear, are you including the <code>return true</code> bug?</p>



<a name="167199826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199826" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199826">(Jun 03 2019 at 15:15)</a>:</h4>
<p>(but seriously, I want that in isolation, because when I made that mistake <em>we had no tests</em> - and we clearly still don't)</p>



<a name="167199854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167199854" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167199854">(Jun 03 2019 at 15:15)</a>:</h4>
<p>yes, I'll make sure they are separate PRs then</p>



<a name="167200152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167200152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167200152">(Jun 03 2019 at 15:18)</a>:</h4>
<p>okay ping me on IRC and I'll r+ ASAP</p>



<a name="167200666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167200666" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167200666">(Jun 03 2019 at 15:23)</a>:</h4>
<p>there's also some overlap between the <code>IsNotPromotable</code> vs <code>IsNotImplicitlyPromotable</code>, and <code>mode</code>. We want to allow <code>const fn</code> calls both inside <code>const</code> items and inside <code>rustc_const_arg</code> arguments.</p>



<a name="167200701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167200701" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167200701">(Jun 03 2019 at 15:23)</a>:</h4>
<p>Seems weird to have <code>IsNotImplicitlyPromotable</code> look at the mode at all TBH</p>



<a name="167200727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167200727" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167200727">(Jun 03 2019 at 15:23)</a>:</h4>
<p>I did leave a few comments about some stuff like that</p>



<a name="167200746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167200746" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167200746">(Jun 03 2019 at 15:23)</a>:</h4>
<p>although I'm not sure what you mean</p>



<a name="167201240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201240" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201240">(Jun 03 2019 at 15:27)</a>:</h4>
<p>why does <code>IsNotImplicitlyPromotable</code> look at the mode? instead I'd think that in situations like <code>static X: T := &amp;foo</code>, we'd only look at <code>IsNotPromotable</code></p>



<a name="167201257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201257" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201257">(Jun 03 2019 at 15:28)</a>:</h4>
<p>similar to how we only look at <code>IsNotPromotable</code> for <code>rustc_const_arg</code></p>



<a name="167201320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201320" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201320">(Jun 03 2019 at 15:28)</a>:</h4>
<p>you're saying that's explicit promotion?</p>



<a name="167201329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201329" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201329">(Jun 03 2019 at 15:28)</a>:</h4>
<p>yes</p>



<a name="167201338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201338" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201338">(Jun 03 2019 at 15:28)</a>:</h4>
<p>with the same argument</p>



<a name="167201343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201343">(Jun 03 2019 at 15:28)</a>:</h4>
<p>its happening inside a context where we have to use <code>const</code></p>



<a name="167201349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201349" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201349">(Jun 03 2019 at 15:28)</a>:</h4>
<p>but that's not even promotion :P</p>



<a name="167201369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201369" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201369">(Jun 03 2019 at 15:28)</a>:</h4>
<p>well it is currently treated as such is it not?</p>



<a name="167201382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201382" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201382">(Jun 03 2019 at 15:28)</a>:</h4>
<p>that's just <code>&amp;'static</code> without any promotion happening</p>



<a name="167201387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201387" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201387">(Jun 03 2019 at 15:29)</a>:</h4>
<p>when I did some testing it behaves the same</p>



<a name="167201415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201415" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201415">(Jun 03 2019 at 15:29)</a>:</h4>
<p>ah sorry take a variant of this like <code>(0, &amp;foo)</code></p>



<a name="167201433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201433" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201433">(Jun 03 2019 at 15:29)</a>:</h4>
<p>you need something like <code>f(&amp;g())</code>, I think</p>



<a name="167201437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201437" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201437">(Jun 03 2019 at 15:29)</a>:</h4>
<p>for some reason those are treated differently...</p>



<a name="167201457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201457" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201457">(Jun 03 2019 at 15:29)</a>:</h4>
<p>yeah something like that</p>



<a name="167201464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201464" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201464">(Jun 03 2019 at 15:29)</a>:</h4>
<p>not sure why that makes any difference FWIW^^</p>



<a name="167201486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201486" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201486">(Jun 03 2019 at 15:29)</a>:</h4>
<p><code>Some(&amp;foo)</code> was my usual way to get there IIRC</p>



<a name="167201489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201489" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201489">(Jun 03 2019 at 15:29)</a>:</h4>
<p>tuple might still be top-level, I don't remember</p>



<a name="167201520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201520" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201520">(Jun 03 2019 at 15:30)</a>:</h4>
<p>it's the rule from <code>let x = &amp;f();</code></p>



<a name="167201584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201584" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201584">(Jun 03 2019 at 15:30)</a>:</h4>
<p>I cant remember because in my head it makes no sense to treat them differently than top-level <code>&amp;</code>^^</p>



<a name="167201595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201595" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201595">(Jun 03 2019 at 15:30)</a>:</h4>
<p>yeah, <code>Some(&amp;foo())</code> needs promotion</p>



<a name="167201622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201622" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201622">(Jun 03 2019 at 15:30)</a>:</h4>
<p>well, top-level allows more</p>



<a name="167201630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201630" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201630">(Jun 03 2019 at 15:30)</a>:</h4>
<p>but why?</p>



<a name="167201644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201644" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201644">(Jun 03 2019 at 15:30)</a>:</h4>
<p>like, <code>&amp;String::new()</code> works but <code>Some(&amp;String::new())</code> doesn't</p>



<a name="167201658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201658" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201658">(Jun 03 2019 at 15:30)</a>:</h4>
<p>but why?^^</p>



<a name="167201691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201691" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201691">(Jun 03 2019 at 15:31)</a>:</h4>
<p>because that's the only thing that fit the constraints we had?</p>



<a name="167201716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201716">(Jun 03 2019 at 15:31)</a>:</h4>
<p>I dont know what that means</p>



<a name="167201729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201729" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201729">(Jun 03 2019 at 15:31)</a>:</h4>
<p>it used to be more relaxed, actually, which was very bad</p>



<a name="167201738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201738" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201738">(Jun 03 2019 at 15:31)</a>:</h4>
<p>but I dont know of any soundness reason to treat them differently</p>



<a name="167201768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201768" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201768">(Jun 03 2019 at 15:31)</a>:</h4>
<p>like, anything you are allowed top-level, you should also be allowed "further in"</p>



<a name="167201772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201772" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201772">(Jun 03 2019 at 15:31)</a>:</h4>
<p>if we rely on promotion for the top-level, some things are impossible</p>



<a name="167201782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201782" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201782">(Jun 03 2019 at 15:32)</a>:</h4>
<p>unless we start allowing to promote them</p>



<a name="167201858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201858" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201858">(Jun 03 2019 at 15:32)</a>:</h4>
<p>well is there anything we want to allow top-level but not allow in <em>explicit</em> promotion?</p>



<a name="167201870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201870">(Jun 03 2019 at 15:32)</a>:</h4>
<p>and we don't want to promote <code>Some(&amp;ThisNeedsDrop)</code> <em>anywhere</em></p>



<a name="167201894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201894" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201894">(Jun 03 2019 at 15:32)</a>:</h4>
<p>since we want drops to have consistent semantics</p>



<a name="167201960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201960" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201960">(Jun 03 2019 at 15:33)</a>:</h4>
<p>I mean I'd also be fine not considering that to be part of promotion at all, neither top-level nor nested. it's mostly the inconsistency that bothers me.</p>



<a name="167201980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201980" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201980">(Jun 03 2019 at 15:33)</a>:</h4>
<p>but we used to allow <code>Some(&amp;anything)</code></p>



<a name="167201994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167201994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167201994">(Jun 03 2019 at 15:33)</a>:</h4>
<p>where?</p>



<a name="167202115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202115" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202115">(Jun 03 2019 at 15:34)</a>:</h4>
<p>in constants</p>



<a name="167202395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202395">(Jun 03 2019 at 15:37)</a>:</h4>
<p>well there need to be some checks, but the same checks as for top-level</p>



<a name="167202429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202429" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202429">(Jun 03 2019 at 15:37)</a>:</h4>
<p>@oli I dont understand the comment at  <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1212" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1212">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1212</a><br>
<code>// never promote transmute calls</code> but this doesn't even do anything for runtime-functions (i.e., where promotion would matter)</p>



<a name="167202739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202739" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202739">(Jun 03 2019 at 15:40)</a>:</h4>
<p>that comment belongs to <a href="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L488" target="_blank" title="https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L488">https://github.com/rust-lang/rust/blob/7096ff0ce16b0544b717986ec335798b3151dd8e/src/librustc_mir/transform/qualify_consts.rs#L488</a></p>



<a name="167202944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202944" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202944">(Jun 03 2019 at 15:42)</a>:</h4>
<p>yeah but that's not what that code does^^ okay</p>



<a name="167202970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202970" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202970">(Jun 03 2019 at 15:42)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> for another insteance of a duplicate check, see the two occurrences of <code>is_union</code> in that file</p>



<a name="167202987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167202987" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167202987">(Jun 03 2019 at 15:42)</a>:</h4>
<p>we basically have most checks twice and it's very hard to tell if they are properly in sync</p>



<a name="167203655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167203655" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167203655">(Jun 03 2019 at 15:49)</a>:</h4>
<p>also why is it correct to do the "dont promote things that would execute drop during their evaluation" check only on temporaries?</p>



<a name="167204552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167204552" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167204552">(Jun 03 2019 at 15:59)</a>:</h4>
<p>because we don't promote non-temporaries</p>



<a name="167204857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167204857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167204857">(Jun 03 2019 at 16:02)</a>:</h4>
<p>ah</p>



<a name="167204906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167204906" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167204906">(Jun 03 2019 at 16:03)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> before my change the whitelist, this doesn't do anything <a href="https://github.com/rust-lang/rust/blob/732a2dc09577f93c5eb9e4f037f7ce6723d8d7eb/src/librustc_mir/transform/qualify_consts.rs#L875" target="_blank" title="https://github.com/rust-lang/rust/blob/732a2dc09577f93c5eb9e4f037f7ce6723d8d7eb/src/librustc_mir/transform/qualify_consts.rs#L875">https://github.com/rust-lang/rust/blob/732a2dc09577f93c5eb9e4f037f7ce6723d8d7eb/src/librustc_mir/transform/qualify_consts.rs#L875</a></p>



<a name="167204916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167204916" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167204916">(Jun 03 2019 at 16:04)</a>:</h4>
<p>oh god there was an ICE I removed <a href="https://github.com/rust-lang/rust/blob/732a2dc09577f93c5eb9e4f037f7ce6723d8d7eb/src/librustc_mir/transform/qualify_consts.rs#L1038-L1041" target="_blank" title="https://github.com/rust-lang/rust/blob/732a2dc09577f93c5eb9e4f037f7ce6723d8d7eb/src/librustc_mir/transform/qualify_consts.rs#L1038-L1041">https://github.com/rust-lang/rust/blob/732a2dc09577f93c5eb9e4f037f7ce6723d8d7eb/src/librustc_mir/transform/qualify_consts.rs#L1038-L1041</a></p>



<a name="167204975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167204975" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167204975">(Jun 03 2019 at 16:04)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> it does something, it keeps <code>is_const_fn</code> at <code>false</code></p>



<a name="167204978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167204978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167204978">(Jun 03 2019 at 16:04)</a>:</h4>
<p>load-bearing <code>delay_span_bug</code>s Q_Q</p>



<a name="167205352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205352" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205352">(Jun 03 2019 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> but there are no errors attached to <code>is_const_fn</code>!</p>



<a name="167205379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205379" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205379">(Jun 03 2019 at 16:10)</a>:</h4>
<p>I tried to cast some of the things you told me into comments <span class="user-mention" data-user-id="119009">@eddyb</span> , please have a look at <a href="https://github.com/rust-lang/rust/pull/61492" target="_blank" title="https://github.com/rust-lang/rust/pull/61492">https://github.com/rust-lang/rust/pull/61492</a> and check that they reflect what you wanted to say</p>



<a name="167205435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205435" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205435">(Jun 03 2019 at 16:10)</a>:</h4>
<p>yea <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span> I just saw it.</p>



<a name="167205450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205450" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205450">(Jun 03 2019 at 16:10)</a>:</h4>
<p>so basically people added intrinsics to the whitelist to disable the ICE</p>



<a name="167205510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205510" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205510">(Jun 03 2019 at 16:11)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> <span class="user-mention" data-user-id="124288">@oli</span> I still think "const context" is ambiguous :/</p>



<a name="167205519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205519" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205519">(Jun 03 2019 at 16:11)</a>:</h4>
<p>I'm sure my original implementation didn't have an ICE...</p>



<a name="167205530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205530">(Jun 03 2019 at 16:11)</a>:</h4>
<p>not sure what I broke from then on</p>



<a name="167205690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205690" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205690">(Jun 03 2019 at 16:13)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <span class="user-mention silent" data-user-id="124288">oli</span> I still think "const context" is ambiguous :/</p>
</blockquote>
<p>hm. it is terminology I have been using for a bit, including in some blog posts. and so far nobody complained^^</p>



<a name="167205694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205694" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205694">(Jun 03 2019 at 16:13)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> wait, there is one way to fix this: rename <code>Mode::Const</code> to <code>Mode::OtherConst</code></p>



<a name="167205779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205779" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205779">(Jun 03 2019 at 16:14)</a>:</h4>
<p>sure I can do that. I guess when I rename things I can also rename <code>Fn</code> to <code>NonConstFn</code> or so?</p>



<a name="167205785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205785" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205785">(Jun 03 2019 at 16:14)</a>:</h4>
<p>it's very much contextually ambiguous :P</p>



<a name="167205795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205795">(Jun 03 2019 at 16:14)</a>:</h4>
<p>hmm sure</p>



<a name="167205991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167205991" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167205991">(Jun 03 2019 at 16:16)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> wait, there is one way to fix this: rename <code>Mode::Const</code> to <code>Mode::OtherConst</code></p>
</blockquote>
<p>what about <code>Mode::ConstItem</code>?</p>



<a name="167206012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206012" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206012">(Jun 03 2019 at 16:17)</a>:</h4>
<p>no, because it's a catch-all for anon consts too</p>



<a name="167206020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206020" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206020">(Jun 03 2019 at 16:17)</a>:</h4>
<p>like <code>[T; 0]</code>, <code>Array&lt;T, 1&gt;</code> etc.</p>



<a name="167206095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206095" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206095">(Jun 03 2019 at 16:18)</a>:</h4>
<p><code>const_mode: Option&lt;ConstMode&gt;</code>, where <code>Fn</code> is <code>None</code> instead of a variant on <code>Mode</code>?</p>



<a name="167206165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206165">(Jun 03 2019 at 16:18)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> ftr, the duplication would slowly go away as we allow more things in the const context</p>



<a name="167206492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206492" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206492">(Jun 03 2019 at 16:22)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> ftr, the duplication would slowly go away as we allow more things in the const context</p>
</blockquote>
<p>that's a good point</p>



<a name="167206563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206563" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206563">(Jun 03 2019 at 16:23)</a>:</h4>
<p>in the "endgame", what is left to check for general const context? calling only <code>const fn</code>, which you guys are currently struggling to fix for intrinsics ;) , and maybe some <code>unconst</code> stuff? But there'll still be <code>Drop</code> terminator checks, too, and something about interior mutability. (and hopefully <code>Sync</code>...)</p>



<a name="167206741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206741" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206741">(Jun 03 2019 at 16:25)</a>:</h4>
<p>I mean having const checks is not a problem</p>



<a name="167206762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206762" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206762">(Jun 03 2019 at 16:25)</a>:</h4>
<p>the annoying thing is that some logic must be replicated for qualifying promotion</p>



<a name="167206831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206831">(Jun 03 2019 at 16:26)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> it's taking me a while to see what you mean but some of the more fine-grained duplication... is part of the cleanup</p>



<a name="167206850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206850" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206850">(Jun 03 2019 at 16:26)</a>:</h4>
<p>before it was unduplicated because the qualification was done by mutating <em>while</em> checking!</p>



<a name="167206881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206881" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206881">(Jun 03 2019 at 16:26)</a>:</h4>
<p>whereas we want to move to just using the dataflow framework</p>



<a name="167206927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206927" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206927">(Jun 03 2019 at 16:27)</a>:</h4>
<blockquote>
<p>the annoying thing is that some logic must be replicated for qualifying promotion</p>
</blockquote>
<p>yes</p>



<a name="167206953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167206953" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167206953">(Jun 03 2019 at 16:27)</a>:</h4>
<p>the cleanup did remove some other duplication though I feel -- or at least made the overall structure much clearer -- that that was still definitely a good step IMO</p>



<a name="167207001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207001" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207001">(Jun 03 2019 at 16:28)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> anyway, I don't think I managed to get across why top-level borrows are "leaked" to <code>'static</code> instead of promoted</p>



<a name="167207066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207066" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207066">(Jun 03 2019 at 16:28)</a>:</h4>
<p>diagnostics aside, can we phrase "const checking" as "making sure an <code>IsNotConst</code> qualif is not set anywhere"? and then make <code>IsNotPromotable</code> basically a minor extension of that qualif if at all needed?</p>



<a name="167207098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207098" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207098">(Jun 03 2019 at 16:29)</a>:</h4>
<p>but that doesn't mean anything :/</p>



<a name="167207132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207132" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207132">(Jun 03 2019 at 16:29)</a>:</h4>
<p>qualifications are of "value"s. whatever you want to call them</p>



<a name="167207146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207146" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207146">(Jun 03 2019 at 16:29)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> anyway, I don't think I managed to get across why top-level borrows are "leaked" to <code>'static</code> instead of promoted</p>
</blockquote>
<p>well I understand the checks are weaker. and it makes sense that they would be weaker than promotion un runtime <code>fn</code>. I dont know where that is implemented though.</p>



<a name="167207171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207171" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207171">(Jun 03 2019 at 16:29)</a>:</h4>
<p>there are side-effects that don't produce a value</p>



<a name="167207184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207184" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207184">(Jun 03 2019 at 16:29)</a>:</h4>
<p>like a <code>-&gt; !</code> <code>const fn</code></p>



<a name="167207281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207281" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207281">(Jun 03 2019 at 16:30)</a>:</h4>
<p>or, idk, maybe <code>InlineAsm</code>?</p>



<a name="167207297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207297">(Jun 03 2019 at 16:30)</a>:</h4>
<p>or <code>Drop</code>, I guess</p>



<a name="167207362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207362" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207362">(Jun 03 2019 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> no, I mean, why <code>&amp;f()</code> allows more than <code>Some(&amp;f())</code> - both in constants</p>



<a name="167207474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207474" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207474">(Jun 03 2019 at 16:32)</a>:</h4>
<p>anyway, you can disable that behavior by getting rid of this (and using the <code>visit_expr</code> from the "then" side of the <code>if</code> in all cases <a href="https://github.com/rust-lang/rust/blob/master/src/librustc/middle/region.rs#L1280-L1301" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/middle/region.rs#L1280-L1301">https://github.com/rust-lang/rust/blob/master/src/librustc/middle/region.rs#L1280-L1301</a></p>



<a name="167207498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207498">(Jun 03 2019 at 16:32)</a>:</h4>
<p>and then do a crater run to see what breaks</p>



<a name="167207525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207525" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207525">(Jun 03 2019 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> aside from back-compat, I <em>really</em> want <code>&amp;String::from("foo")</code> to work one day</p>



<a name="167207583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207583" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207583">(Jun 03 2019 at 16:33)</a>:</h4>
<p>and if you're not at the top-level there is no way that would ever be <code>&amp;'static</code> (unless we add a way to say that <code>String</code>'s <code>Drop</code> is "promotable away")</p>



<a name="167207634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207634">(Jun 03 2019 at 16:33)</a>:</h4>
<p>but at the top-level we can use the <code>let</code> rules and say that the "enclosing scope" is <code>'static</code></p>



<a name="167207705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207705" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207705">(Jun 03 2019 at 16:34)</a>:</h4>
<p>it's both backwards and forwards compatible</p>



<a name="167207715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167207715" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167207715">(Jun 03 2019 at 16:34)</a>:</h4>
<p>that's why we did it that way</p>



<a name="167208006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208006" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208006">(Jun 03 2019 at 16:37)</a>:</h4>
<p>why would <code>Some(&amp;String::from("foo"))</code> not work?</p>



<a name="167208019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208019" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208019">(Jun 03 2019 at 16:37)</a>:</h4>
<p>because that already means something</p>



<a name="167208024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208024" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208024">(Jun 03 2019 at 16:37)</a>:</h4>
<p>the way we intern consts, anything that lives when the const is done computing can be interned</p>



<a name="167208134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208134" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208134">(Jun 03 2019 at 16:38)</a>:</h4>
<p>like, <code>f(&amp;String::from("foo"))</code> means "call <code>f</code> then drop the <code>String</code>"</p>



<a name="167208164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208164" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208164">(Jun 03 2019 at 16:38)</a>:</h4>
<p>hm</p>



<a name="167208185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208185" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208185">(Jun 03 2019 at 16:39)</a>:</h4>
<p>really, look at how <code>let x = &amp;f();</code> rules work</p>



<a name="167208197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208197">(Jun 03 2019 at 16:39)</a>:</h4>
<p>there are literally over 6 years of history here</p>



<a name="167208204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208204" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208204">(Jun 03 2019 at 16:39)</a>:</h4>
<p>okay when I ran into this I didnt think about <code>Drop</code>, I was more surprised that <code>Some(&amp;Cell::new(0))</code> does not work. there's no good reason at all for that IMO...</p>



<a name="167208224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208224">(Jun 03 2019 at 16:39)</a>:</h4>
<p>you mean <code>&amp;AtomicUsize</code>, right?</p>



<a name="167208229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208229">(Jun 03 2019 at 16:39)</a>:</h4>
<p>cause that's not <code>Sync</code></p>



<a name="167208281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208281" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208281">(Jun 03 2019 at 16:40)</a>:</h4>
<p>yeah (thought we dont always properly check <code>Sync</code> during promotion but that's another thing)</p>



<a name="167208377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208377" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208377">(Jun 03 2019 at 16:41)</a>:</h4>
<p>but you agree <code>f(&amp;AtomicUsize::new(0))</code> shouldn't promote, yeah?</p>



<a name="167208478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208478" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208478">(Jun 03 2019 at 16:42)</a>:</h4>
<p>(if it promotes, executing that code more than once may see a non-<code>0</code> there)</p>



<a name="167208496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208496" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208496">(Jun 03 2019 at 16:42)</a>:</h4>
<p><code>Some</code> is a special-case of an ADT constructor that looks like a function call</p>



<a name="167208514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208514" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208514">(Jun 03 2019 at 16:42)</a>:</h4>
<p>we can change things about it if we wanted to. it's a red herring</p>



<a name="167208523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208523" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208523">(Jun 03 2019 at 16:43)</a>:</h4>
<p>actual functions are far more important</p>



<a name="167208556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208556">(Jun 03 2019 at 16:43)</a>:</h4>
<blockquote>
<p>but you agree <code>f(&amp;AtomicUsize::new(0))</code> shouldn't promote, yeah?</p>
</blockquote>
<p>I dont know what "promotion" means any more. ;) but I think <code>static FOO = f(&amp;AtomicUsize::new(0))</code> should work (and same for <code>const</code>)</p>



<a name="167208615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208615" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208615">(Jun 03 2019 at 16:44)</a>:</h4>
<p>well maybe not for <code>const</code> if the reference ends up in the result</p>



<a name="167208632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208632" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208632">(Jun 03 2019 at 16:44)</a>:</h4>
<p>interior mutability and const, yada yada (we'll hopefully soon have interning check for that)</p>



<a name="167208636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208636" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208636">(Jun 03 2019 at 16:44)</a>:</h4>
<p>but for <code>static</code></p>



<a name="167208658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208658" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208658">(Jun 03 2019 at 16:44)</a>:</h4>
<p>it's too tenuous IMO</p>



<a name="167208701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208701" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208701">(Jun 03 2019 at 16:45)</a>:</h4>
<p>you'd agree <code>x = f(&amp;AtomicUsize::new(0))</code> in a loop <em>even in a <code>static</code></em> should never be promoted, right?</p>



<a name="167208730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208730" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208730">(Jun 03 2019 at 16:45)</a>:</h4>
<p>...?</p>



<a name="167208736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208736" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208736">(Jun 03 2019 at 16:45)</a>:</h4>
<p>again I dont know what promotion means here</p>



<a name="167208747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208747" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208747">(Jun 03 2019 at 16:45)</a>:</h4>
<p>but I see no reason not to just execute that code using normal CTFE rules and then intern the result</p>



<a name="167208810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208810" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208810">(Jun 03 2019 at 16:46)</a>:</h4>
<p>of coruse it shouldnt "factor out" the <code>AtomicUsize::new</code></p>



<a name="167208811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208811" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208811">(Jun 03 2019 at 16:46)</a>:</h4>
<p>promotion means there is only one <code>AtomicUsize</code> and it gets reused instead of each iteration having its own</p>



<a name="167208821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208821">(Jun 03 2019 at 16:46)</a>:</h4>
<p>so I guess it'd be more like what you call "leaking"</p>



<a name="167208831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208831">(Jun 03 2019 at 16:46)</a>:</h4>
<p>you can't "leak" in a loop</p>



<a name="167208844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208844" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208844">(Jun 03 2019 at 16:46)</a>:</h4>
<p>you only have one local</p>



<a name="167208884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208884" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208884">(Jun 03 2019 at 16:47)</a>:</h4>
<p>so?</p>



<a name="167208893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167208893" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167208893">(Jun 03 2019 at 16:47)</a>:</h4>
<p>there is something special about "this only happens once" that can make this work, but it's very much a special-case</p>



<a name="167209002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209002">(Jun 03 2019 at 16:48)</a>:</h4>
<p>hm. seems like my mental model for <code>&amp;</code> in <code>static</code> is just off</p>



<a name="167209048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209048" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209048">(Jun 03 2019 at 16:49)</a>:</h4>
<p>if you think of <code>const</code> and <code>static</code> RHSes as <code>const fn</code> functions that are used to initialize them, that would help a lot</p>



<a name="167209056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209056">(Jun 03 2019 at 16:49)</a>:</h4>
<p>my idea was to just compile to MIR and evaluate that, and because we dont drop the top "stack frame" (corresponding to the body of the item) we can just leak everything in that frame that we still need</p>



<a name="167209071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209071" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209071">(Jun 03 2019 at 16:49)</a>:</h4>
<p>your mental model might be that of the pre-miri evaluator which did something very silly for <code>&amp;foo</code></p>



<a name="167209103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209103" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209103">(Jun 03 2019 at 16:49)</a>:</h4>
<blockquote>
<p>if you think of <code>const</code> and <code>static</code> RHSes as <code>const fn</code> functions that are used to initialize them, that would help a lot</p>
</blockquote>
<p>well but that does not explain why <code>&amp;foo()</code> works</p>



<a name="167209105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209105" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209105">(Jun 03 2019 at 16:50)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> so, what happens to per-loop iteration <code>StorageLive...StorageDead</code>?</p>



<a name="167209158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209158" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209158">(Jun 03 2019 at 16:50)</a>:</h4>
<p>yes, <code>&amp;foo()</code> is very much a special case</p>



<a name="167209190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209190" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209190">(Jun 03 2019 at 16:50)</a>:</h4>
<p>well sure if there's a <code>StorageDead</code> that cannot be used in the final value</p>



<a name="167209203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209203" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209203">(Jun 03 2019 at 16:51)</a>:</h4>
<p>everything except the top-level special-case has <code>Drop</code>s and <code>StorageDead</code>s!</p>



<a name="167209229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209229">(Jun 03 2019 at 16:51)</a>:</h4>
<blockquote>
<p>yes, <code>&amp;foo()</code> is very much a special case</p>
</blockquote>
<p>in particular it's a special case not just for the analysis but for MIR generation as well, right?</p>



<a name="167209237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209237" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209237">(Jun 03 2019 at 16:51)</a>:</h4>
<p>it's like a regulat function</p>



<a name="167209249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209249" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209249">(Jun 03 2019 at 16:51)</a>:</h4>
<p><code>&amp;foo()</code> is a special-case <em>only</em> for MIR generation</p>



<a name="167209259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209259" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209259">(Jun 03 2019 at 16:51)</a>:</h4>
<p>all of the behavior falls out of that</p>



<a name="167209265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209265" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209265">(Jun 03 2019 at 16:51)</a>:</h4>
<blockquote>
<p><code>&amp;foo()</code> is a special-case <em>only</em> for MIR generation</p>
</blockquote>
<p>well you linked me to some part where it's a special case of the analysis?</p>



<a name="167209325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209325" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209325">(Jun 03 2019 at 16:52)</a>:</h4>
<p>what analysis? <code>middle::region</code>?</p>



<a name="167209333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209333" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209333">(Jun 03 2019 at 16:52)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc/middle/region.rs#L1280-L1301" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/middle/region.rs#L1280-L1301">https://github.com/rust-lang/rust/blob/master/src/librustc/middle/region.rs#L1280-L1301</a><br>
oh wait that's not in const_qualif</p>



<a name="167209339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209339" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209339">(Jun 03 2019 at 16:52)</a>:</h4>
<p>lol</p>



<a name="167209347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209347" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209347">(Jun 03 2019 at 16:52)</a>:</h4>
<p>I assumed it had to be^^</p>



<a name="167209366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209366">(Jun 03 2019 at 16:52)</a>:</h4>
<p>no, because it's <em>not promotion</em></p>



<a name="167209373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209373" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209373">(Jun 03 2019 at 16:52)</a>:</h4>
<blockquote>
<p>all of the behavior falls out of that</p>
</blockquote>
<p>okay that helps a lot!</p>



<a name="167209395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209395">(Jun 03 2019 at 16:53)</a>:</h4>
<p>you can just not run the promotion pass and top-level in const/static would still have the behavior of top-level in <code>let</code></p>



<a name="167209469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209469" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209469">(Jun 03 2019 at 16:54)</a>:</h4>
<blockquote>
<p>you can just not run the promotion pass and top-level in const/static would still have the behavior of top-level in <code>let</code></p>
</blockquote>
<p>that's not what I meant though, I meant <code>&amp;</code> in statics could generally be "not promotion". but at least I understand now where the distinction is coming from.</p>



<a name="167209480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209480" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209480">(Jun 03 2019 at 16:54)</a>:</h4>
<p>you could do that but then you can't have normal drops</p>



<a name="167209489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209489" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209489">(Jun 03 2019 at 16:54)</a>:</h4>
<p>and I'd rather "doesn't get dropped" be the exception not the rule</p>



<a name="167209525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209525" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209525">(Jun 03 2019 at 16:55)</a>:</h4>
<p>like, I want <code>{ let mut v = vec![]; ... v.iter().sum() }</code> to very much behave like runtime code</p>



<a name="167209541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209541">(Jun 03 2019 at 16:55)</a>:</h4>
<p>and drop the <code>Vec</code></p>



<a name="167209595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209595" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209595">(Jun 03 2019 at 16:56)</a>:</h4>
<p>you can't have that and "all <code>&amp;</code> are <code>&amp;'static</code>"</p>



<a name="167209602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209602" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209602">(Jun 03 2019 at 16:56)</a>:</h4>
<p>not to mention conflicting borrows</p>



<a name="167209608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209608" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209608">(Jun 03 2019 at 16:56)</a>:</h4>
<p>well we clean up the CTFE context</p>



<a name="167209612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209612" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209612">(Jun 03 2019 at 16:56)</a>:</h4>
<p>so drop-or-no-drop is not observable</p>



<a name="167209615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209615" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209615">(Jun 03 2019 at 16:56)</a>:</h4>
<p>that doesn't matter, it still needs to be <em>checked</em></p>



<a name="167209645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209645" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209645">(Jun 03 2019 at 16:57)</a>:</h4>
<p>we used to <em>not have a const checking pass</em></p>



<a name="167209663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209663" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209663">(Jun 03 2019 at 16:57)</a>:</h4>
<p>and just eval'd it which did whatever</p>



<a name="167209680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209680" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209680">(Jun 03 2019 at 16:57)</a>:</h4>
<p>and we used to just not run the borrowck on const expressions</p>



<a name="167209722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209722" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209722">(Jun 03 2019 at 16:58)</a>:</h4>
<p>and that was bad?</p>



<a name="167209778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209778">(Jun 03 2019 at 16:58)</a>:</h4>
<p>I actually hope to equip CTFE/Miri with enough checks that that should still reject anything we have to reject</p>



<a name="167209795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209795">(Jun 03 2019 at 16:58)</a>:</h4>
<p>yes, for the same reason we have a borrow-checker!</p>



<a name="167209817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209817" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209817">(Jun 03 2019 at 16:59)</a>:</h4>
<p>and that's universal quantification</p>



<a name="167209828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209828" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209828">(Jun 03 2019 at 16:59)</a>:</h4>
<p>on generics, on ambient state, and on dataflow paths</p>



<a name="167209849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209849" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209849">(Jun 03 2019 at 16:59)</a>:</h4>
<p>sure the checks would get delayed to instantiation time</p>



<a name="167209857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167209857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167209857">(Jun 03 2019 at 16:59)</a>:</h4>
<p>which is probably not great</p>



<a name="167210763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167210763" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167210763">(Jun 03 2019 at 17:10)</a>:</h4>
<p>it's not just not great, it's counter to almost everything Rust stands for!</p>



<a name="167211061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167211061" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167211061">(Jun 03 2019 at 17:14)</a>:</h4>
<p>uh... hyperbole etc?^^</p>



<a name="167211104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167211104" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167211104">(Jun 03 2019 at 17:15)</a>:</h4>
<p>no, I mean, Rust is all about detecting statically detectable things ahead of time</p>



<a name="167211176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167211176" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167211176">(Jun 03 2019 at 17:16)</a>:</h4>
<p>generics and traits in Rust are designed with polymorphic checks (mainly borrowck) in mind</p>



<a name="167211200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167211200" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167211200">(Jun 03 2019 at 17:16)</a>:</h4>
<p>and also, being able to reason about runtime functions without knowing <em>anything</em> about their bodies</p>



<a name="167213469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167213469" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167213469">(Jun 03 2019 at 17:45)</a>:</h4>
<p>well the failure mode is less catastrophic when "uncheked" code gets executed in CTFE vs. "for real" (aka, no UB). but I do agree that it makes sense to have these analyses! I just usually understand analysis by first understanding the dynamic property they want to prove, and then relating things to that. but that's not how const-qualif is explained, documented or designed (from what I can see).</p>



<a name="167213992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167213992" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167213992">(Jun 03 2019 at 17:50)</a>:</h4>
<p>IOW I am just lamenting not having made enough progress on <a href="https://github.com/rust-rfcs/const-eval/issues/17" target="_blank" title="https://github.com/rust-rfcs/const-eval/issues/17">https://github.com/rust-rfcs/const-eval/issues/17</a> ^^</p>



<a name="167227111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167227111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167227111">(Jun 03 2019 at 20:17)</a>:</h4>
<p>Based on the ensuing discussion, I think the answer to my first question:</p>
<blockquote>
<p>What are the odds that a "dedicated beginner" (me) could implement dataflow-based const qualification?</p>
</blockquote>
<p>Is "no" for most definitions of "beginner" and "dedicated". I may be able to help with other things like writing tests and collecting knowledge about promotion into one place.</p>
<p>I would like to explain my mental model after watching oli-obk's compiler lecture on miri and reading some of the relevant bits of rustc over the weekend. Obviously I've probably overlooked some things.</p>
<p>There's two kinds of validation we want to run on <code>const</code> blocks (I know the definition of "valid" changes subtly depending on the exact context): a pre-monomorphization static check and a dynamic check that occurs as miri is running. The goal is to catch errors as early as possible in the analysis while providing good diagnostics. Some operations (e.g. calls to non-const functions or casting pointers to integers) can be forbidden statically with a flow-insensitive analysis (iterating over the basic blocks). However, some requirements of <code>const</code> blocks (e.g. whether a value with interior mutability appears in the return place) require a path-sensitive analysis.</p>
<p>Currently, control-flow is forbidden in CTFE, so there is only one possible execution path (unwind edges are ignored). We can enumerate this path simply by iterating over the basic blocks, meaning our naive analysis is actually path-sensitive for this simple class of CFGs. However, there are still some cases (associated consts) where errors can only be caught post-monomorphization.</p>
<p>We want to extend CTFE to arbitrarily complex CFGs but still catch as many errors statically as possible. We can do a conservative flow-sensitive analysis (dataflow) to find all places where a value definitely, maybe, or definitely does not meet a condition (e.g. <code>HasMutInterior</code>) (the tri-state comes from the combination two separate dataflow passes as in <code>MaybeUninitializedPlaces</code> and <code>MaybeInitializedPlaces</code>). I don't know whether you've decided to only allow things that can be statically proven to be const-safe, or if you want to run miri when something is only maybe const-safe. The first would disallow  stuff like <code>const x: Option&lt;&amp;Cell&lt;u32&gt;&gt; = if true { None } else { Some(&amp;Cell::new(0)) }</code>, but the second would allow it (I'm still not 100% on the promotion rules, maybe this example is wrong).</p>



<a name="167227507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167227507" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167227507">(Jun 03 2019 at 20:21)</a>:</h4>
<p>definitely only allow if static checks succeeded</p>



<a name="167227866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167227866" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167227866">(Jun 03 2019 at 20:25)</a>:</h4>
<blockquote>
<p>like, I want <code>{ let mut v = vec![]; ... v.iter().sum() }</code> to very much behave like runtime code</p>
</blockquote>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> A somewhat unrelated question, could we short-circuit qualification with a simple type-based analysis for this example assuming the vec holds a primitive type?</p>



<a name="167228108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167228108" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167228108">(Jun 03 2019 at 20:27)</a>:</h4>
<p>If we know type of the result of CTFE cannot possibly have interior mutability or a drop impl, we don't need to do any of the path-sensitive analysis right?</p>



<a name="167229863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167229863" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167229863">(Jun 03 2019 at 20:43)</a>:</h4>
<blockquote>
<p>collecting knowledge about promotion into one place.</p>
</blockquote>
<p>yes that would be great! that place would be <a href="https://github.com/rust-rfcs/const-eval/" target="_blank" title="https://github.com/rust-rfcs/const-eval/">https://github.com/rust-rfcs/const-eval/</a></p>



<a name="167229939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167229939" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167229939">(Jun 03 2019 at 20:44)</a>:</h4>
<p>I plan to incorporate some of what I learned today, but I am not sure when I will have time :/</p>



<a name="167230061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167230061" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167230061">(Jun 03 2019 at 20:45)</a>:</h4>
<blockquote>
<p>However, there are still some cases (associated consts) where errors can only be caught post-monomorphization.</p>
</blockquote>
<p>we use the types in those cases and remain conservative</p>



<a name="167230135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167230135" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167230135">(Jun 03 2019 at 20:46)</a>:</h4>
<p>so, the checks in miri should actually never fire as of right now. (once we allow transmutes and fn ptrs in const code this will change though.)</p>



<a name="167308770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167308770" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> vertexclique <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167308770">(Jun 04 2019 at 15:58)</a>:</h4>
<p>I tried using <code> _ =&gt; {} </code> and also <code>return false</code>. It is not visiting that point in qualify_const for a test case I am testing on. It is compiling anyway. I don't know where is the whitelist checks for intrinsics occurs.</p>



<a name="167309078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167309078" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> vertexclique <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167309078">(Jun 04 2019 at 16:01)</a>:</h4>
<p>For both cases I used this test</p>
<div class="codehilite"><pre><span></span><span class="cp">#![feature(core_intrinsics)]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="kp">&amp;</span><span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">std</span>::<span class="n">intrinsics</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
</pre></div>



<a name="167309289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167309289" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> vertexclique <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167309289">(Jun 04 2019 at 16:03)</a>:</h4>
<p>I didn't understand where <code>const</code> context but not <code>const fn</code> checks are…</p>



<a name="167311054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167311054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167311054">(Jun 04 2019 at 16:21)</a>:</h4>
<p>I think this is just dead code that you removed. Not dead in the sense that it wasn't ever hit, but that its value is irrelevant, because the actual checks are elsewhere</p>



<a name="167311234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167311234" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> vertexclique <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167311234">(Jun 04 2019 at 16:23)</a>:</h4>
<p>My understanding is same.</p>



<a name="167311334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167311334" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167311334">(Jun 04 2019 at 16:24)</a>:</h4>
<p>oh, I have an idea, gimme a sec</p>



<a name="167311632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167311632" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167311632">(Jun 04 2019 at 16:28)</a>:</h4>
<p>hm, no, didn't pan out</p>



<a name="167319207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167319207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167319207">(Jun 04 2019 at 17:51)</a>:</h4>
<blockquote>
<p>For both cases I used this test</p>
<div class="codehilite"><pre><span></span><span class="cp">#![feature(core_intrinsics)]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="kp">&amp;</span><span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">std</span>::<span class="n">intrinsics</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
</pre></div>


</blockquote>
<p>that's not promotion -- top-level <code>&amp;</code> is special</p>



<a name="167319233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167319233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167319233">(Jun 04 2019 at 17:51)</a>:</h4>
<p>if you want to test promotion, do it with something like <code>let x: &amp;'static _ = &amp;intrinsics::...</code></p>



<a name="167377310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167377310" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167377310">(Jun 05 2019 at 11:02)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> I really don't understand your question - how can the <code>Vec</code> element type matter? <code>Vec</code> has a <code>Drop</code> impl regardless of the element type</p>



<a name="167380578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380578" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380578">(Jun 05 2019 at 11:56)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I still disagree with this FWIW but I don't have the energy today to give you a good explanation <a href="https://github.com/rust-lang/rust/pull/61492/files#r289985850" target="_blank" title="https://github.com/rust-lang/rust/pull/61492/files#r289985850">https://github.com/rust-lang/rust/pull/61492/files#r289985850</a></p>



<a name="167380634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380634">(Jun 05 2019 at 11:57)</a>:</h4>
<p>if you <em>really</em> want we could do the on-side-effect checking, and disqualify a local from promotion that way</p>



<a name="167380716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380716">(Jun 05 2019 at 11:58)</a>:</h4>
<p>at which point it could be its own self-encapsulated check</p>



<a name="167380723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380723" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380723">(Jun 05 2019 at 11:58)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> I still disagree with this FWIW but I don't have the energy today to give you a good explanation <a href="https://github.com/rust-lang/rust/pull/61492/files#r289985850" target="_blank" title="https://github.com/rust-lang/rust/pull/61492/files#r289985850">https://github.com/rust-lang/rust/pull/61492/files#r289985850</a></p>
</blockquote>
<p>what's your argument beside the historical coincidence about the order in which they were added to the code base?</p>



<a name="167380725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380725" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380725">(Jun 05 2019 at 11:58)</a>:</h4>
<p>but you'd still need to do <em>the other checks</em></p>



<a name="167380770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380770" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380770">(Jun 05 2019 at 11:59)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I think it's a coincidence that they both care about drops</p>



<a name="167380796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380796" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380796">(Jun 05 2019 at 12:00)</a>:</h4>
<p>the const-checking one would need to eventually start allowing <code>const impl Drop</code></p>



<a name="167380884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380884" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380884">(Jun 05 2019 at 12:00)</a>:</h4>
<p>while promotion in fn's can never do that, since the respective drop is at runtime</p>



<a name="167380904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380904" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380904">(Jun 05 2019 at 12:00)</a>:</h4>
<p>so they'd eventually use two flags instead of one <code>NeedsDrop</code></p>



<a name="167380937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167380937" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167380937">(Jun 05 2019 at 12:01)</a>:</h4>
<p>like, <code>NeedsNonConstDrop</code> and <code>NeedsDrop</code></p>



<a name="167381015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167381015" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167381015">(Jun 05 2019 at 12:02)</a>:</h4>
<p>one is about not executing implicit non-<code>const fn</code> <code>Drop::drop</code> calls, the other is about preserving observable behavior</p>



<a name="167381163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167381163" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167381163">(Jun 05 2019 at 12:04)</a>:</h4>
<p>it gets weirder when there are multiple uses of a promoted local, and only some of them are promoted</p>



<a name="167381170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167381170" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167381170">(Jun 05 2019 at 12:04)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> tried to make some changes in this area</p>



<a name="167381188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167381188" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167381188">(Jun 05 2019 at 12:04)</a>:</h4>
<p>even if they both checked <code>Drop</code> terminators, the checks would be quite different</p>



<a name="167381237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167381237" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167381237">(Jun 05 2019 at 12:05)</a>:</h4>
<p>anyway, after <a href="https://github.com/rust-lang/rust/issues/61539" target="_blank" title="https://github.com/rust-lang/rust/issues/61539">https://github.com/rust-lang/rust/issues/61539</a>, I <em>really</em> need a break</p>



<a name="167383699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167383699" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167383699">(Jun 05 2019 at 12:37)</a>:</h4>
<p>I did some cleanups, but I don't think I went through with everything I wanted</p>



<a name="167383702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167383702" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167383702">(Jun 05 2019 at 12:37)</a>:</h4>
<p>I really need a todo list</p>



<a name="167393884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167393884" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167393884">(Jun 05 2019 at 14:28)</a>:</h4>
<blockquote>
<p>while promotion in fn's can never do that, since the respective drop is at runtime</p>
</blockquote>
<p>well, <em>If</em> the drop is <code>const impl</code> we could allow promoting (that is assuming we are willing to promote arbitrary <code>const fn</code> calls -- which is less of a problem for calls that don't return anything, like <code>drop</code>)</p>



<a name="167394139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167394139" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167394139">(Jun 05 2019 at 14:30)</a>:</h4>
<blockquote>
<p>one is about not executing implicit non-<code>const fn</code> <code>Drop::drop</code> calls, the other is about preserving observable behavior</p>
</blockquote>
<p>but in that case then, wouldnt we want to ignore some "qualif"s in the promotion part because they are only relevant for const checking?</p>



<a name="167395882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167395882" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167395882">(Jun 05 2019 at 14:46)</a>:</h4>
<blockquote>
<p>well, <em>If</em> the drop is <code>const impl</code> we could allow promoting (that is assuming we are willing to promote arbitrary <code>const fn</code> calls -- which is less of a problem for calls that don't return anything, like <code>drop</code>)</p>
</blockquote>
<p>not a good idea imo. User code will "randomly" (from the perspective of someone who doesn't know about promotion) start to stop running destructors</p>



<a name="167403375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167403375" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167403375">(Jun 05 2019 at 15:59)</a>:</h4>
<p>it won't stop running them, it'll run them at CTFE time</p>



<a name="167408248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/167408248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#167408248">(Jun 05 2019 at 16:54)</a>:</h4>
<p><strong>@eddyb</strong> my point was merely that we could skip running dataflow as an optimization if the result type of the const block cannot have interior mutability behind a reference and is not needs drop.</p>



<a name="168419154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419154" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419154">(Jun 18 2019 at 16:46)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> IMO that's both a premature optimization <em>and</em> dangerous <em>even if</em> it's sound now (which I don't know if it is)</p>



<a name="168419240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419240" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419240">(Jun 18 2019 at 16:47)</a>:</h4>
<p>because if we change some things in the "unoptimized" version and the <em>condition</em> for using the "optimized" version don't take that into account, they can be out of sync</p>



<a name="168419256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419256" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419256">(Jun 18 2019 at 16:47)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> also I don't understand why "reaching definition" might be needed</p>



<a name="168419323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419323" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419323">(Jun 18 2019 at 16:48)</a>:</h4>
<p>(from the other thread)</p>



<a name="168419356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419356" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419356">(Jun 18 2019 at 16:48)</a>:</h4>
<p>I feel bad because it seems like I'm just confusing everyone with something that should be otherwise not that complicated :(</p>



<a name="168419526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419526" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419526">(Jun 18 2019 at 16:50)</a>:</h4>
<p>Unfortunately I have a pretty low threshold for confusion :) Reaching definitions lets us create a use-def chain, which we can use to enumerate all possible rvalues that could get assigned to the return place</p>



<a name="168419575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419575" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419575">(Jun 18 2019 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> that's implying a full rewrite of the pass though?</p>



<a name="168419591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419591" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419591">(Jun 18 2019 at 16:51)</a>:</h4>
<p>as opposed to just computing the same bits as today, but using the dataflow framework</p>



<a name="168419608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419608" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419608">(Jun 18 2019 at 16:51)</a>:</h4>
<p>which handles control-flow unlike the limitation of linear control-flow today</p>



<a name="168419692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419692" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419692">(Jun 18 2019 at 16:52)</a>:</h4>
<p>not to mention it's hard to encode everything touching a local in an use-def chain</p>



<a name="168419718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419718" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419718">(Jun 18 2019 at 16:53)</a>:</h4>
<p>we're reaching VSDG-level of complexity</p>



<a name="168419829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419829">(Jun 18 2019 at 16:54)</a>:</h4>
<p>I think it would yes.</p>



<a name="168419831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419831">(Jun 18 2019 at 16:54)</a>:</h4>
<p>also, what would you do for loops? forward dataflow can track properties of locals modified by a loop, but "pulling" the definition from an Use-Def chain would need to handle the fixpoint of loops which is where most of the complexity of VSDG comes from</p>



<a name="168419844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419844" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419844">(Jun 18 2019 at 16:54)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay but I never suggested any of this?</p>



<a name="168419854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419854" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419854">(Jun 18 2019 at 16:54)</a>:</h4>
<p>I guess I was confused when you mentioned the existing dataflow framework above</p>



<a name="168419883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419883" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419883">(Jun 18 2019 at 16:55)</a>:</h4>
<p>this is why I think that maybe I should do it myself because I don't seem to get across just how simple this is supposed to be</p>



<a name="168419929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419929" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419929">(Jun 18 2019 at 16:55)</a>:</h4>
<p>I do not have a problem with that :)</p>



<a name="168419945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168419945" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168419945">(Jun 18 2019 at 16:55)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> "dataflow analysis" aka (forward) propagation of 1 bit of information per local variable, not "dataflow graph"</p>



<a name="168420002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420002">(Jun 18 2019 at 16:56)</a>:</h4>
<p>yeah the only issue is that  I keep accumulating TODO items faster than I can dispatch them :(</p>



<a name="168420085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420085" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420085">(Jun 18 2019 at 16:57)</a>:</h4>
<p>So, reaching defs keeps a bit for each assignment in the program, not for each local</p>



<a name="168420111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420111">(Jun 18 2019 at 16:57)</a>:</h4>
<p>(not sure if I'm repeating stuff you already know)</p>



<a name="168420127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420127" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420127">(Jun 18 2019 at 16:57)</a>:</h4>
<p>yeah I know. I just have no idea why you'd switch to something incredibly more difficult</p>



<a name="168420134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420134" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420134">(Jun 18 2019 at 16:57)</a>:</h4>
<p>(unless you don't want to handle loops?)</p>



<a name="168420234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420234" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420234">(Jun 18 2019 at 16:58)</a>:</h4>
<p>Why does reaching definitions not handle loops?</p>



<a name="168420238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420238" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420238">(Jun 18 2019 at 16:58)</a>:</h4>
<p>(even then it's more work unless you reconstruct a DAG version of the MIR, more VSDG-like. that would be useful for unification of "type-level const expressions" in the context of const generics :P)</p>



<a name="168420252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420252" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420252">(Jun 18 2019 at 16:58)</a>:</h4>
<p>back-edges in the CFG are handled fine I believe</p>



<a name="168420259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420259" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420259">(Jun 18 2019 at 16:59)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> it's not really the "reaching definitions" but rather how you plan to use them</p>



<a name="168420277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420277" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420277">(Jun 18 2019 at 16:59)</a>:</h4>
<p>to "pull" the definition of a value</p>



<a name="168420305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420305" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420305">(Jun 18 2019 at 16:59)</a>:</h4>
<p>this is bad because in a loop, a value can depend on things in previous iterations</p>



<a name="168420450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420450" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420450">(Jun 18 2019 at 17:00)</a>:</h4>
<p>forward dataflow can saturate a property, and we know that's sound (especially since it runs in the same direction the code would run at runtime :P), but if you do it by "pulling" things, you run into soundness concerns of cyclic analyses</p>



<a name="168420500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420500" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420500">(Jun 18 2019 at 17:01)</a>:</h4>
<p>we'd have this problem if we wanted to, say, promote a  value that was constructed by a loop</p>



<a name="168420543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420543" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420543">(Jun 18 2019 at 17:01)</a>:</h4>
<p>we'd have to represent the cyclical control-flow around the assignments, too</p>



<a name="168420544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420544" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420544">(Jun 18 2019 at 17:01)</a>:</h4>
<p>Rephrasing, I'll get the set of definitions which are live, but those definitions may depend on earlier values</p>



<a name="168420553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420553" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420553">(Jun 18 2019 at 17:01)</a>:</h4>
<p>in the loop iteration</p>



<a name="168420560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420560" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420560">(Jun 18 2019 at 17:02)</a>:</h4>
<p>?</p>



<a name="168420598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420598" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420598">(Jun 18 2019 at 17:02)</a>:</h4>
<p>yes. and you need a fixpoint algorithm</p>



<a name="168420614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420614" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420614">(Jun 18 2019 at 17:02)</a>:</h4>
<p>and I'm not sure I can think of one</p>



<a name="168420642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420642" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420642">(Jun 18 2019 at 17:02)</a>:</h4>
<p>not to mention this is harder than doing the (straight)forward dataflow the rest of the compiler uses</p>



<a name="168420765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420765" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420765">(Jun 18 2019 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> so, today, we have one bitvec per <code>Qualif</code> implementor and we mutate them on every <code>Assign</code>/<code>Call</code>. and this works only for linear control-flow. if we switched to using the dataflow framework, we'd have one dataflow result for each <code>Qualif</code> implementor, that we could advance, and it gives us access to one bitvec each</p>



<a name="168420787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420787">(Jun 18 2019 at 17:04)</a>:</h4>
<p>so for linear control-flow we'd just observe the same values in those bitvecs</p>



<a name="168420816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420816">(Jun 18 2019 at 17:04)</a>:</h4>
<p>but more interesting control-flow would also "just work"</p>



<a name="168420857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420857">(Jun 18 2019 at 17:05)</a>:</h4>
<p>and most of the code won't have to change at all to account for this</p>



<a name="168420866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420866" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420866">(Jun 18 2019 at 17:05)</a>:</h4>
<p>Okay, so you were thinking of something like the strategy that I mentioned  at the top of this (one bit per local representing qualif-state)</p>



<a name="168420891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420891" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420891">(Jun 18 2019 at 17:05)</a>:</h4>
<p>yeah which is literally what we do today</p>



<a name="168420899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420899" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420899">(Jun 18 2019 at 17:05)</a>:</h4>
<p>but I wasn't sure how to fit this into the "gen-kill" framework</p>



<a name="168420950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420950" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420950">(Jun 18 2019 at 17:06)</a>:</h4>
<p>those are silly names for set/unset</p>



<a name="168420957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420957" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420957">(Jun 18 2019 at 17:06)</a>:</h4>
<p>or I should say, "historical names"</p>



<a name="168420984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420984" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420984">(Jun 18 2019 at 17:06)</a>:</h4>
<p>since the transfer function depends on whether another bit in the dataflow is set</p>



<a name="168420994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420994">(Jun 18 2019 at 17:06)</a>:</h4>
<p>which might change as we're iterating</p>



<a name="168420998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168420998" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168420998">(Jun 18 2019 at 17:07)</a>:</h4>
<p>what do you mean?</p>



<a name="168421019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421019" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421019">(Jun 18 2019 at 17:07)</a>:</h4>
<p>oh</p>



<a name="168421021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421021" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421021">(Jun 18 2019 at 17:07)</a>:</h4>
<p>OH</p>



<a name="168421031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421031" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421031">(Jun 18 2019 at 17:07)</a>:</h4>
<p>/me facepalms</p>



<a name="168421033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421033" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421033">(Jun 18 2019 at 17:07)</a>:</h4>
<p>So if I have <code>_1 = _2</code>, I only want to gen <code>_1</code> if the qualif bit for <code>_2</code> is set</p>



<a name="168421098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421098" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421098">(Jun 18 2019 at 17:08)</a>:</h4>
<p>I'm sorry it took me so long to find out that this is was your issue :(</p>



<a name="168421141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421141" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421141">(Jun 18 2019 at 17:08)</a>:</h4>
<p>that's okay, I'm maybe a bit too shy</p>



<a name="168421161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421161">(Jun 18 2019 at 17:09)</a>:</h4>
<p>I kept wondering what am I missing, but this makes sense</p>



<a name="168421198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421198" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421198">(Jun 18 2019 at 17:09)</a>:</h4>
<p>I can do this in a generic dataflow algorithm, but not in the <code>BitDenotation</code>-based one.</p>



<a name="168421202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421202" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421202">(Jun 18 2019 at 17:09)</a>:</h4>
<p>I was so intent of removing dependencies between the various bits... that I forgot how dataflow analysis works</p>



<a name="168421414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421414" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421414">(Jun 18 2019 at 17:12)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay yeah it can still be bit-based, and it should reach fixpoint, you just can't compute the effects in isolation...</p>



<a name="168421429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421429" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421429">(Jun 18 2019 at 17:12)</a>:</h4>
<p>I still think "pull" would be too much of a change :(</p>



<a name="168421548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421548">(Jun 18 2019 at 17:14)</a>:</h4>
<p>"pull"?</p>



<a name="168421562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421562">(Jun 18 2019 at 17:14)</a>:</h4>
<p>the thing you were talking about, to walk to the definition</p>



<a name="168421582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168421582" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168421582">(Jun 18 2019 at 17:14)</a>:</h4>
<p>you're "pulling" the definition. whereas right now we're "pushing" properties to the use</p>



<a name="168423548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423548">(Jun 18 2019 at 17:16)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> so uhhh we technically could add <code>bits[i] = bits[j]</code> / <code>bits[i] |= bits[j]</code> on top of the <code>bits[i] = constant</code> that gen/kill represent, to the existing dataflow framework, but <span class="user-mention" data-user-id="116083">@pnkfelix</span> might hate us :D</p>



<a name="168423677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423677" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423677">(Jun 18 2019 at 17:17)</a>:</h4>
<p>we would have to change the <code>Qualif</code> methods to do something quite different than just <code>-&gt; bool</code>, but it shouldn't be that bad (and we could do it today, with the linear controlflow restriction, before messing with the dataflow framework)</p>



<a name="168423784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423784">(Jun 18 2019 at 17:18)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> A custom dataflow  algorithm isn't  that hard, there's already one here for liveness (that I think could have been implemented on top of `BitDenotation?)</p>



<a name="168423787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423787">(Jun 18 2019 at 17:18)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/9606f6fa64926a84d82e3c62dbdc57f5c10f756d/src/librustc_mir/util/liveness.rs#L59" target="_blank" title="https://github.com/rust-lang/rust/blob/9606f6fa64926a84d82e3c62dbdc57f5c10f756d/src/librustc_mir/util/liveness.rs#L59">https://github.com/rust-lang/rust/blob/9606f6fa64926a84d82e3c62dbdc57f5c10f756d/src/librustc_mir/util/liveness.rs#L59</a></p>



<a name="168423818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423818" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423818">(Jun 18 2019 at 17:19)</a>:</h4>
<p>yeah I know I'd just hate myself and maybe risk making it unsound</p>



<a name="168423835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423835" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423835">(Jun 18 2019 at 17:19)</a>:</h4>
<p>I think the liveness one is separate because liveness is backwards dataflow IIRC</p>



<a name="168423951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168423951" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168423951">(Jun 18 2019 at 17:20)</a>:</h4>
<p>I have a branch on which I wrote a thing I called "eventflow" that was bidirectional and was focused on tracking "something may have happened in the past/future" as opposed to "stateful properties"</p>



<a name="168424004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168424004" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168424004">(Jun 18 2019 at 17:21)</a>:</h4>
<p>(like, it was saturating, <code>gen</code>-only so to speak, whereas <code>liveness</code> uses <code>kill</code>)</p>



<a name="168424007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168424007" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168424007">(Jun 18 2019 at 17:21)</a>:</h4>
<p>ah, that's right</p>



<a name="168424229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168424229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168424229">(Jun 18 2019 at 17:23)</a>:</h4>
<p>(<a href="https://github.com/eddyb/rust/blob/copy-elision/src/librustc_mir/analysis/eventflow.rs" target="_blank" title="https://github.com/eddyb/rust/blob/copy-elision/src/librustc_mir/analysis/eventflow.rs">https://github.com/eddyb/rust/blob/copy-elision/src/librustc_mir/analysis/eventflow.rs</a>)</p>



<a name="168426387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168426387" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168426387">(Jun 18 2019 at 17:26)</a>:</h4>
<p>so, I'm a bit conflicted now. I certainly think that some sort of sparse array of "where should the value for this output bit come from? unchanged, constant (gen/kill), or some other input bit?", generated the same way gen/kill sets are today, could be faster to compute with than re-doing all the per-statement logic on every propagation</p>



<a name="168426436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168426436" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168426436">(Jun 18 2019 at 17:27)</a>:</h4>
<p>but I'm not sure what we should be doing. at least I'm still more confident in forward dataflow for reasoning about the state of locals at some point in the control-flow</p>



<a name="168426929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168426929" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168426929">(Jun 18 2019 at 17:32)</a>:</h4>
<p>So we could keep the "gen/kill" set, then add an ancillary "steal" sparse map per CFG-edge</p>



<a name="168427260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168427260" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168427260">(Jun 18 2019 at 17:35)</a>:</h4>
<p>The normal dataflow analyses would all have empty "steal" maps so I don't think it would slow things down too much in the normal case</p>



<a name="168438280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168438280" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168438280">(Jun 18 2019 at 17:51)</a>:</h4>
<p>There's one other thing that I found confusing and that may be applicable: the current framework lets you inspect the initial state of each block (and optionally the initial state at each statement) when defining your transfer function. I'm not 100% sure why this is useful. I <em>think</em> it helps the rate of convergence since if we have<code>_1 = Some(Cell::new()); _2 = _1;</code>, we could immediately gen the bit for <code>_2</code> instead of "steal"-ing from <code>_1</code></p>



<a name="168438581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168438581" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168438581">(Jun 18 2019 at 17:54)</a>:</h4>
<p>The only place that parameter is actually used is here: <a href="https://github.com/rust-lang/rust/blob/44fb88d25282d9362774536965f2455f677734f3/src/librustc_mir/dataflow/impls/borrows.rs#L207" target="_blank" title="https://github.com/rust-lang/rust/blob/44fb88d25282d9362774536965f2455f677734f3/src/librustc_mir/dataflow/impls/borrows.rs#L207">https://github.com/rust-lang/rust/blob/44fb88d25282d9362774536965f2455f677734f3/src/librustc_mir/dataflow/impls/borrows.rs#L207</a></p>



<a name="168439717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168439717" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168439717">(Jun 18 2019 at 18:05)</a>:</h4>
<p>wait</p>



<a name="168439747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168439747" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168439747">(Jun 18 2019 at 18:05)</a>:</h4>
<p>let me actually check the propagation :|</p>



<a name="168439930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168439930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168439930">(Jun 18 2019 at 18:07)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> it's intra-block only &lt;<a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/mod.rs#L574-L597" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/mod.rs#L574-L597">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/mod.rs#L574-L597</a>&gt;</p>



<a name="168440021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440021" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440021">(Jun 18 2019 at 18:08)</a>:</h4>
<p>which makes sense, the gen/kill sets are only computed once per block</p>



<a name="168440088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440088" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440088">(Jun 18 2019 at 18:09)</a>:</h4>
<p>So that flag changes whether you can see the effects of previous statements in the block applied to the initial entry set when defining transfer functions for later statements</p>



<a name="168440278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440278">(Jun 18 2019 at 18:11)</a>:</h4>
<p>Otherwise every statement in the block sees only the effect from <code>start_block_effect</code></p>



<a name="168440381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440381" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440381">(Jun 18 2019 at 18:12)</a>:</h4>
<p>which is either all-ones or all-zeros, IIRC</p>



<a name="168440442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440442" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440442">(Jun 18 2019 at 18:13)</a>:</h4>
<p>No, you can have custom <code>start_block_effect</code>s. Like marking all parameters to a function as <code>DefinitelyInitialized</code></p>



<a name="168440471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440471" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440471">(Jun 18 2019 at 18:13)</a>:</h4>
<p>hmm but that's invalid except for the start block?</p>



<a name="168440491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440491" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440491">(Jun 18 2019 at 18:13)</a>:</h4>
<p>everything else should assume the most conservative thing possible</p>



<a name="168440560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440560" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440560">(Jun 18 2019 at 18:14)</a>:</h4>
<p>(e.g. you can move out of those argument locals)</p>



<a name="168440584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440584" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440584">(Jun 18 2019 at 18:14)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/44fb88d25282d9362774536965f2455f677734f3/src/librustc_mir/dataflow/mod.rs#L201" target="_blank" title="https://github.com/rust-lang/rust/blob/44fb88d25282d9362774536965f2455f677734f3/src/librustc_mir/dataflow/mod.rs#L201">https://github.com/rust-lang/rust/blob/44fb88d25282d9362774536965f2455f677734f3/src/librustc_mir/dataflow/mod.rs#L201</a></p>



<a name="168440640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440640" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440640">(Jun 18 2019 at 18:15)</a>:</h4>
<p>Right, so <code>on_entry</code> will have the value from <code>start_block_effect</code></p>



<a name="168440781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440781" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440781">(Jun 18 2019 at 18:16)</a>:</h4>
<p>while defining transfer functions in <em>all</em> basic blocks</p>



<a name="168440795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440795">(Jun 18 2019 at 18:16)</a>:</h4>
<p>It's just not useful there</p>



<a name="168440979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168440979" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168440979">(Jun 18 2019 at 18:18)</a>:</h4>
<p>Oh wait. I'm wrong, it just has those effects in the<code>START_BLOCK</code></p>



<a name="168441006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168441006" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168441006">(Jun 18 2019 at 18:18)</a>:</h4>
<p><em>phew</em></p>



<a name="168441022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168441022" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168441022">(Jun 18 2019 at 18:18)</a>:</h4>
<p>All other blocks will have see the entry set be either all zeros or all ones like you said</p>



<a name="168608696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168608696" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168608696">(Jun 20 2019 at 15:59)</a>:</h4>
<p>@eddyb, I did another readthrough of <code>qualify_consts.rs</code> in my free time yesterday. I think I  want to make <code>BitDenotation</code> variant over transfer functions, so if/when <a href="https://github.com/rust-lang/rust/issues/61787" target="_blank" title="https://github.com/rust-lang/rust/issues/61787">#61787</a>  lands, <code>GenKillSet</code> will become the canonical implementer but const-qualification will have one that adds the ability to copy bits from other locals (this operation will be pretty slow if there's a lot of assignments).</p>



<a name="168608835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168608835" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168608835">(Jun 20 2019 at 16:00)</a>:</h4>
<p>I then want to split <code>qualify_consts</code> into two logical passes, the first checks for const correctness (e.g. calling non-const fns, accessing mutable statics, etc.). The second is where we run dataflow.</p>



<a name="168609071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609071" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609071">(Jun 20 2019 at 16:03)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="168609078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609078" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609078">(Jun 20 2019 at 16:03)</a>:</h4>
<p>That is :)</p>



<a name="168609160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609160" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609160">(Jun 20 2019 at 16:04)</a>:</h4>
<p>so, the way I imagined this would go</p>



<a name="168609174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609174" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609174">(Jun 20 2019 at 16:05)</a>:</h4>
<p>(deleted)</p>



<a name="168609205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609205" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609205">(Jun 20 2019 at 16:05)</a>:</h4>
<p>is that we would keep the current pass</p>



<a name="168609248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609248">(Jun 20 2019 at 16:05)</a>:</h4>
<p>but run the dataflow <em>before</em> it, such that we can seek the results at any <code>Location</code> we need</p>



<a name="168609315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609315" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609315">(Jun 20 2019 at 16:06)</a>:</h4>
<p>so most of the code would remain unchanged (risking little to no bugs :P)</p>



<a name="168609358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609358">(Jun 20 2019 at 16:07)</a>:</h4>
<p>My next thought was "I'm worried about creating a massive, unreviewable diff since the control flow in <code>qualify_consts</code> is pretty hard to separate out" :)</p>



<a name="168609388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609388" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609388">(Jun 20 2019 at 16:07)</a>:</h4>
<p>like, the way things are set up right now is that very little of the code actually <em>writes</em> the bitvecs, most of it reads them</p>



<a name="168609399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609399" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609399">(Jun 20 2019 at 16:08)</a>:</h4>
<p>That makes things easier, so <code>ConstCx</code> will also store dataflow results, and <code>in_local</code> will fetch the results of dataflow analysis</p>



<a name="168609445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609445" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609445">(Jun 20 2019 at 16:08)</a>:</h4>
<p>and if we have the dataflow results we should be able to seek them as we do the const-checking</p>



<a name="168609447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609447" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609447">(Jun 20 2019 at 16:08)</a>:</h4>
<p>yupp :D</p>



<a name="168609734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609734" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609734">(Jun 20 2019 at 16:12)</a>:</h4>
<p>I'm planning to work on this in the evenings (I'm UTC-8:00, so in 9 hours or so), so I'll keep doing progress reports and ask questions if I get stuck</p>



<a name="168609797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609797" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609797">(Jun 20 2019 at 16:13)</a>:</h4>
<p>I haven't considered abstracting dataflow before at the level of "ahead-of-time computation for each whole block" but I really like the idea!</p>



<a name="168609808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609808" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609808">(Jun 20 2019 at 16:13)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> have you had a chance to discuss this with <span class="user-mention" data-user-id="116083">@pnkfelix</span> or <span class="user-mention" data-user-id="116009">@nikomatsakis</span> yet?</p>



<a name="168609877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609877" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609877">(Jun 20 2019 at 16:14)</a>:</h4>
<p>if modular enough NLL borrowck might be able to use it to enhance some aspects of, say, error reporting (cc <span class="user-mention" data-user-id="116118">@Matthew Jasper</span> I guess?)</p>



<a name="168609951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/168609951" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#168609951">(Jun 20 2019 at 16:15)</a>:</h4>
<p>No, I think niko is unavailable, but i can try to have a sync talk with <span class="user-mention" data-user-id="116083">@pnkfelix</span> if he's not too busy.</p>



<a name="169050825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169050825" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169050825">(Jun 26 2019 at 17:16)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="119009">@eddyb</span>, I got a bit side-tracked while trying to customize dataflow analysis (see <a href="https://github.com/rust-lang/rust/issues/62010" target="_blank" title="https://github.com/rust-lang/rust/issues/62010">#62010</a>, <a href="https://github.com/rust-lang/rust/issues/62062" target="_blank" title="https://github.com/rust-lang/rust/issues/62062">#62062</a>, <a href="https://github.com/rust-lang/rust/issues/61787" target="_blank" title="https://github.com/rust-lang/rust/issues/61787">#61787</a>).  I'm returning to const-qualification now. However, I think there's a problem with adding a general-purpose assign operator (<code>bit[i] = bit[j]</code>) to transfer functions. The reason the "gen-kill" paradigm is useful is that it composes nicely, allowing us to build up a single pair of bit-vectors which apply the transfer functions of all statements in the block. As soon as we add and assign operator, however, we can no longer coalesce transfer functions in this way, since the order of assignments relative to gens and kills matters. For example, I believe the following cannot be expressed by a single gen/kill set and a single, ordered list of assignments:</p>
<div class="codehilite"><pre><span></span><span class="n">_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_1</span><span class="w"></span>
<span class="n">_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="n">_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_2</span><span class="w"></span>
<span class="n">_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="n">_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_2</span><span class="w"></span>
</pre></div>


<p>This means that such a transfer function can't be nicely added to the existing dataflow execution engine. We would need a separate, slower one which goes statement-by-statement.</p>



<a name="169051541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169051541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169051541">(Jun 26 2019 at 17:25)</a>:</h4>
<p>I considered whether transfer functions could be split into three components, assign before gen-kill, gen-kill, and assign after gen-kill, but I think  that's not possible for every basic block.</p>



<a name="169051602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169051602" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169051602">(Jun 26 2019 at 17:26)</a>:</h4>
<p>Can't come up with a good example though</p>



<a name="169052715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169052715" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169052715">(Jun 26 2019 at 17:39)</a>:</h4>
<p>Hmm, maybe I'm wrong</p>



<a name="169053060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169053060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169053060">(Jun 26 2019 at 17:42)</a>:</h4>
<p>If the RHS has been <code>gen</code>-ed or <code>kill</code>-ed earlier in the block, instead of assigning, you just <code>gen</code>/<code>kill</code> it. And assignments are always applied before <code>gen</code> and <code>kill</code>.</p>



<a name="169074441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169074441" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169074441">(Jun 26 2019 at 19:55)</a>:</h4>
<p>The other issue here is that the dataflow at location APIs rely on transfer functions being idempotent (<code>trans(trans(v)) == trans(v)</code>). A transfer function like  <code>_1 = _2; _2 = _3</code> does not meet this assumption.</p>



<a name="169128749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169128749" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169128749">(Jun 27 2019 at 12:17)</a>:</h4>
<p>sooo there's a less efficient but still per-block view of this: per-element (e.g. per-local) <code>Unchanged | Clear | Set | CopyFrom(OtherElement)</code></p>



<a name="169128772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169128772" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169128772">(Jun 27 2019 at 12:17)</a>:</h4>
<p>kill/gen is a 2-bit encoding of <code>Unchanged | Clear | Set</code>, split into two bit vectors for efficiency reasons</p>



<a name="169128841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169128841" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169128841">(Jun 27 2019 at 12:18)</a>:</h4>
<p>if you want to use kill/gen bitvecs + another vec for "copy from", you'll have to clear the 2 you're not using, for any action</p>



<a name="169128880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169128880" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169128880">(Jun 27 2019 at 12:19)</a>:</h4>
<p>gen/kill are <em>already</em> exclusive. this "two bitvecs and one regular vec" would still have to be exclusive</p>



<a name="169128956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169128956" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169128956">(Jun 27 2019 at 12:20)</a>:</h4>
<p>although, come to think of it, <code>A | B | C | ... | Z(Local)</code> is the same size as <code>Local</code>, thanks to <code>newtype_index!</code> and <span class="user-mention" data-user-id="124288">@oli</span>'s attribute hacks for validity ranges</p>



<a name="169156752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169156752" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169156752">(Jun 27 2019 at 17:42)</a>:</h4>
<p>How do you encode the relative order of assignments in that scheme (e.g. <code>_1 = _2; _2 = _3</code>)? I think you need a collection that maintains the order of <code>CopyFrom(OtherElement)</code> within a block.</p>



<a name="169156936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169156936" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169156936">(Jun 27 2019 at 17:44)</a>:</h4>
<p>Does this make you reconsider the reaching definitions formulation of const-qualification at all? I'm starting to think that building a use-def chain would be simpler than supporting <code>CopyFrom</code></p>



<a name="169462009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462009" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462009">(Jul 02 2019 at 08:21)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> sorry, I didn't see that question. I would assume you would just do the SSA thing?</p>



<a name="169462101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462101" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462101">(Jul 02 2019 at 08:22)</a>:</h4>
<p>like, you would end up with an <code>state</code> array for which <code>state[1] == CopyFrom(_2)</code> and <code>state[2] == CopyFrom(_3)</code></p>



<a name="169462258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462258" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462258">(Jul 02 2019 at 08:24)</a>:</h4>
<p>but you can only get <code>CopyFrom(x)</code> if <code>state[x]</code> is <code>Unchanged</code> at that point in the block  when <code>CopyFrom</code> would've been emitted</p>



<a name="169462289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462289" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462289">(Jul 02 2019 at 08:25)</a>:</h4>
<p>that is, <code>CopyFrom</code> uses <em>the on-entry</em> value</p>



<a name="169462343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462343">(Jul 02 2019 at 08:25)</a>:</h4>
<p>so you could imagine it in another way: <code>AtBlockEntry(Local) | Clear | Set</code></p>



<a name="169462389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462389" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462389">(Jul 02 2019 at 08:26)</a>:</h4>
<p>where everything is initialized to <code>AtBlockEntry(Local)</code></p>



<a name="169462425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462425" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462425">(Jul 02 2019 at 08:26)</a>:</h4>
<p>and on <code>Assign(x, y)</code> you literally just go <code>state[x] = state[y]</code>, copying the intra-block state</p>



<a name="169462806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169462806" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169462806">(Jul 02 2019 at 08:31)</a>:</h4>
<p>which <em>might</em> be <code>AtBlockEntry(y)</code> but could be anything else</p>



<a name="169463535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169463535" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169463535">(Jul 02 2019 at 08:43)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> wait, what about something like <code>x = (y, z);</code> - that needs to <code>|</code> two other locals' bits together, so you do need a list of <code>|=</code> operations instead...</p>



<a name="169463779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169463779" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169463779">(Jul 02 2019 at 08:47)</a>:</h4>
<p>this is turning into an SSA-like DAG of operations isn't it :P</p>



<a name="169497551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169497551" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169497551">(Jul 02 2019 at 16:52)</a>:</h4>
<p>Hmm, yes. While we could solve that particular case by tracking individual move paths (e.g. <code>a.b.c</code>) and doing  deaggregation, we can't handle successive assignments to an array index (e.g. <code>a[x]</code>) without <code>|</code>. At that point I think there's no way to efficiently concatenate statement transfer functions; you have to step through each basic block statement-by-statement.</p>
<p>As the transfer function of the per-local approach becomes more expensive, I become more convinced that a reaching definitions formulation would be comparable in performance. While you have to store a bit for each definition of a local (instead of each local), you only have to run a single dataflow analysis for all 4 qualifications.</p>
<p>The big question is how to handle cycles in the use-def chain while propagating qualifications, but I believe a simple graph traversal is sufficient. To start, each definition of a local is unconditionally qualified, unconditionally not qualified, or qualified if any one of a set of locals may be qualified. When the last case happens, we add all definitions of the aforementioned set of locals that reach the current point to a work queue, and recursively process them until we find one that is definitely qualified or we run out of definitions in the queue. If we encounter a cyclical dependency (as would occur in <code>loop { x = x + 1}</code>), that definition will already be on the work queue. We should be able to simply skip these tautologies (<code>qualif(x = x + 1) -&gt; qualif(x = x+ 1)</code>), since the only way the condition can be qualified is if one of the other definitions (in this case of <code>x</code>) on the work queue is qualified.</p>
<p>I have been continuing work on a reaching definitions pass a bit (I extended <code>rustc_peek</code> and wrote a test, and started on a use-def chain). I'm worried about the memory overhead of storing all reaching definitions for every use of a local in the body. It would be nice to compute these on-demand, but accessing intra-block dataflow state requires processing all previous statements in the block, so without processing them in order at the beginning, we would be quadratic in the worst case.</p>



<a name="169497697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169497697" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169497697">(Jul 02 2019 at 16:54)</a>:</h4>
<p>Sorry for the brain dump <span class="user-mention" data-user-id="119009">@eddyb</span> <span aria-label="silence" class="emoji emoji-1f910" role="img" title="silence">:silence:</span></p>



<a name="169499823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169499823" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169499823">(Jul 02 2019 at 17:19)</a>:</h4>
<p>given what I've seen regarding VSDG, I'm really scared of relying on "reaching definitions" in an analysis</p>



<a name="169499997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169499997" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169499997">(Jul 02 2019 at 17:20)</a>:</h4>
<p><em>at most</em> I would create some sort of data structure to help do forward dataflow, with a restriction like single-dominating-definition</p>



<a name="169500254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169500254" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169500254">(Jul 02 2019 at 17:23)</a>:</h4>
<p>you can even build the equivalent of "decision trees" except without conditions. so they're more like "merge trees"</p>



<a name="169500271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169500271" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169500271">(Jul 02 2019 at 17:23)</a>:</h4>
<p>as long as you don't touch backedges</p>



<a name="169500321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169500321" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169500321">(Jul 02 2019 at 17:24)</a>:</h4>
<p>and then you propagate along those merge edges until fixpoint, like the current dataflow algorithm</p>



<a name="169500410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169500410" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169500410">(Jul 02 2019 at 17:25)</a>:</h4>
<p>this is what I get for assuming one could just slap dataflow onto qualify_consts....</p>



<a name="169502747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169502747" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169502747">(Jul 02 2019 at 17:50)</a>:</h4>
<p>VSDG is value state dependence graph?</p>



<a name="169507021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169507021" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169507021">(Jul 02 2019 at 18:33)</a>:</h4>
<p>Yes it is</p>



<a name="169624742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169624742" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169624742">(Jul 04 2019 at 06:45)</a>:</h4>
<p>yeah</p>



<a name="169624819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169624819" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169624819">(Jul 04 2019 at 06:46)</a>:</h4>
<p>the soundness of converting a CFG to VSDG is pretty much all in the loops, you have to get them right - if you have a DAG (so no backedges, no looping) it's almost trivial to convert the branches at the splits to selects at the merges</p>



<a name="169624847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169624847" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169624847">(Jul 04 2019 at 06:47)</a>:</h4>
<p>(and an entire function would be SESE, or at least very easy to turn SEME into SESE)</p>



<a name="169627816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169627816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169627816">(Jul 04 2019 at 07:54)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> frankly, the sensible thing to do would probably be to convert each block into something <em>like</em> "reaching definition", but without needing the existing dataflow analysis to do (I guess "still-live-on-block-exit writes to this local" is more or less what I'd want there), and then do dataflow-like propagation of bits, but without caching the results or anything, just keep redoing each block's work (based on those "known writes") until fixpoint</p>



<a name="169627893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/169627893" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#169627893">(Jul 04 2019 at 07:55)</a>:</h4>
<p>we could reuse some of the dataflow framework for "propagate until fixpoint" but the transfer function would be more involved than <code>(bits - kill) | gen</code></p>



<a name="170568002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170568002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170568002">(Jul 10 2019 at 18:43)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I wrote up a summary of my thoughts on this on <a href="https://github.com/rust-lang/rust/issues/53819" target="_blank" title="https://github.com/rust-lang/rust/issues/53819">#53819</a>. I still don't understand your concerns regarding VSDGs since I don't have the theoretical background. Basically, I think that the custom dataflow analysis which propagates qualif bits each iteration will be as sound/precise as one that computes the use-def chain ahead of time and then propagates qualification bits on that.</p>



<a name="170568050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170568050" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170568050">(Jul 10 2019 at 18:43)</a>:</h4>
<p>There's some justification for this idea at the end of my post, but I'm not sure how convincing you'll find it :)</p>



<a name="170605396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605396" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605396">(Jul 11 2019 at 06:23)</a>:</h4>
<p>I don't really understand how you even plan to use a def-use chain</p>



<a name="170605400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605400" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605400">(Jul 11 2019 at 06:24)</a>:</h4>
<p>if you want to handle mutation</p>



<a name="170605446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605446" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605446">(Jul 11 2019 at 06:24)</a>:</h4>
<p>anyway, I don't see how you can be correct around loops without a lot of painful work</p>



<a name="170605454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605454" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605454">(Jul 11 2019 at 06:25)</a>:</h4>
<p>whereas dataflow sidesteps the problem by <em>interpreting the loop</em></p>



<a name="170605741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605741" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605741">(Jul 11 2019 at 06:31)</a>:</h4>
<p>It feels like we're talking past each other a bit. Do you think you could provide a more concrete example of how this falls apart around loops? A use-def chain is built via a dataflow analysis, so I'm not really sure what you mean with your last statement</p>



<a name="170605815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605815" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605815">(Jul 11 2019 at 06:32)</a>:</h4>
<p>I guess that would be hard if you don't understand how I plan to use a use-def chain in the first place</p>



<a name="170605828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605828" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605828">(Jul 11 2019 at 06:33)</a>:</h4>
<p>are you mapping locations of uses to definitions?</p>



<a name="170605833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605833">(Jul 11 2019 at 06:33)</a>:</h4>
<p>Yes</p>



<a name="170605837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605837" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605837">(Jul 11 2019 at 06:33)</a>:</h4>
<p>because that's already an improvement, and not really a def-use chain</p>



<a name="170605841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605841" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605841">(Jul 11 2019 at 06:33)</a>:</h4>
<p>Uses of each local to definitions of that lovey</p>



<a name="170605842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605842" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605842">(Jul 11 2019 at 06:33)</a>:</h4>
<p>that's "reaching definition"</p>



<a name="170605846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605846" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605846">(Jul 11 2019 at 06:33)</a>:</h4>
<p>Local</p>



<a name="170605894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605894" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605894">(Jul 11 2019 at 06:34)</a>:</h4>
<p>but not all definitions, surely? only the reaching ones?</p>



<a name="170605898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605898" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605898">(Jul 11 2019 at 06:34)</a>:</h4>
<p>Correct</p>



<a name="170605906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605906" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605906">(Jul 11 2019 at 06:34)</a>:</h4>
<p>yeah I think we should say "reaching defs" not "def-use chain"</p>



<a name="170605922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605922" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605922">(Jul 11 2019 at 06:35)</a>:</h4>
<p>the latter makes more sense when you have one def and many uses and you can use an intrusive linked list or something</p>



<a name="170605926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605926" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605926">(Jul 11 2019 at 06:35)</a>:</h4>
<p>like, for SSA</p>



<a name="170605999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170605999" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170605999">(Jul 11 2019 at 06:36)</a>:</h4>
<p>it's useful for visiting all uses of a def, because use -&gt; def in that sort if situation is already provided</p>



<a name="170606014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606014" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606014">(Jul 11 2019 at 06:36)</a>:</h4>
<p>okay so what do you do for <code>local.field = ...;</code>?</p>



<a name="170606030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606030" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606030">(Jul 11 2019 at 06:37)</a>:</h4>
<p>does it count as a "def"? I would probably switch to "reaching writes"</p>



<a name="170606033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606033" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606033">(Jul 11 2019 at 06:37)</a>:</h4>
<p>My impression was that a UD chain is a data structure which one can build after doing a reaching definitions analysis</p>



<a name="170606084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606084" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606084">(Jul 11 2019 at 06:38)</a>:</h4>
<p>it doesn't make sense when you have mutations though</p>



<a name="170606090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606090" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606090">(Jul 11 2019 at 06:38)</a>:</h4>
<p>in SSA, you get a use-def chain for free (since each variable is only defined once)</p>



<a name="170606101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606101" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606101">(Jul 11 2019 at 06:38)</a>:</h4>
<p>not exactly, you get use-&gt;def for free, but not def-&gt;uses</p>



<a name="170606136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606136" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606136">(Jul 11 2019 at 06:39)</a>:</h4>
<p>anyway, regardless of terminology (which I'm not 100% sure of either, I'd defer to <span class="user-mention" data-user-id="116009">@nikomatsakis</span>)</p>



<a name="170606144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606144" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606144">(Jul 11 2019 at 06:39)</a>:</h4>
<p>Okay so when you have mutations, there are multiple points where any one local can be "defined"</p>



<a name="170606155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606155" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606155">(Jul 11 2019 at 06:39)</a>:</h4>
<p>do you track both partial mutations and merging branches?</p>



<a name="170606197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606197">(Jul 11 2019 at 06:40)</a>:</h4>
<p>(I'm using defined to mean: "any part of this variable can be written")</p>



<a name="170606215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606215" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606215">(Jul 11 2019 at 06:40)</a>:</h4>
<p>yeah that's prone to confusion, I'd just call that a write or mutation</p>



<a name="170606230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606230" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606230">(Jul 11 2019 at 06:40)</a>:</h4>
<p>Yes. Partial mutations are tracked. Any assignment to a projection of a local is a "partial definition"</p>



<a name="170606276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606276" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606276">(Jul 11 2019 at 06:41)</a>:</h4>
<p>e.g. <code>if c { x = a; } else { x = b; } x.f = y; use(x);</code></p>



<a name="170606278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606278">(Jul 11 2019 at 06:41)</a>:</h4>
<p>re: merging branches, are you refering to the join operator for reaching defs dataflow ?</p>



<a name="170606340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606340" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606340">(Jul 11 2019 at 06:42)</a>:</h4>
<p><code>use(x)</code> -&gt; <code>["x =a", "x =b", "x.f=y"]</code></p>



<a name="170606345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606345" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606345">(Jul 11 2019 at 06:42)</a>:</h4>
<p>Would be the use-def chain that the current analysis builds</p>



<a name="170606378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606378" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606378">(Jul 11 2019 at 06:43)</a>:</h4>
<p>okay so.....</p>



<a name="170606383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606383" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606383">(Jul 11 2019 at 06:43)</a>:</h4>
<p>but <code>if c { x.f = a } else {x.f = b} x = y; use(x);</code> would result in  <code>["x = y"]</code></p>



<a name="170606385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606385" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606385">(Jul 11 2019 at 06:43)</a>:</h4>
<p>how do you evaluate that?</p>



<a name="170606397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606397" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606397">(Jul 11 2019 at 06:43)</a>:</h4>
<p>that's basically my overall question: you're building the equivalent of a VSDG fragment, except less principled</p>



<a name="170606471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606471" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606471">(Jul 11 2019 at 06:44)</a>:</h4>
<p>Reaching definitions analysis is what's doing the work here</p>



<a name="170606477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606477" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606477">(Jul 11 2019 at 06:44)</a>:</h4>
<p>no, I mean, not how you compute it</p>



<a name="170606482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606482" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606482">(Jul 11 2019 at 06:45)</a>:</h4>
<p>how do you evaluate a property of <code>x</code> on that chain</p>



<a name="170606503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606503" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606503">(Jul 11 2019 at 06:45)</a>:</h4>
<p>Ah, you need to look at the rvalue of each assignment</p>



<a name="170606508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606508" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606508">(Jul 11 2019 at 06:46)</a>:</h4>
<p>but in what order/</p>



<a name="170606562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606562">(Jul 11 2019 at 06:46)</a>:</h4>
<p>in pseudo-VSDG it would be something like <code>select(c, { x = a; }, { x = b; }) &gt;&gt;= { x.f = y; }</code></p>



<a name="170606593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606593" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606593">(Jul 11 2019 at 06:47)</a>:</h4>
<p>What do you mean by "order"?</p>



<a name="170606600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606600" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606600">(Jul 11 2019 at 06:47)</a>:</h4>
<p>how do you combine <code>a</code>, <code>b</code> and <code>y</code> into <code>x</code>?</p>



<a name="170606611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606611" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606611">(Jul 11 2019 at 06:47)</a>:</h4>
<p>or more high-level: <code>x = Foo { f: y, ..select(c, a, b) }</code></p>



<a name="170606616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606616" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606616">(Jul 11 2019 at 06:47)</a>:</h4>
<p>γ is basically <code>select</code> or the C <code>?:</code> operator</p>



<a name="170606677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606677" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606677">(Jul 11 2019 at 06:48)</a>:</h4>
<p>okay it's actually indistinguishable from y, dammit</p>



<a name="170606690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606690" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606690">(Jul 11 2019 at 06:48)</a>:</h4>
<p>I'll replace it with <code>select</code></p>



<a name="170606691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606691" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606691">(Jul 11 2019 at 06:48)</a>:</h4>
<p>the union of the qualification bits for each of <code>a</code>, <code>b</code> and <code>y</code></p>



<a name="170606706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606706" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606706">(Jul 11 2019 at 06:49)</a>:</h4>
<p>so you just union every write together?</p>



<a name="170606711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606711" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606711">(Jul 11 2019 at 06:49)</a>:</h4>
<p>(If <code>c</code> is the condition, it's not considered)</p>



<a name="170606727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606727" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606727">(Jul 11 2019 at 06:49)</a>:</h4>
<p>Every write which could possible reach that point in the program yes</p>



<a name="170606737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606737" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606737">(Jul 11 2019 at 06:49)</a>:</h4>
<p>no matter the order.... hmmmmm</p>



<a name="170606784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606784">(Jul 11 2019 at 06:50)</a>:</h4>
<p>I'm really confused why the order matters</p>



<a name="170606795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606795">(Jul 11 2019 at 06:50)</a>:</h4>
<p>well, you're side-stepping it partially by mapping locations of uses</p>



<a name="170606812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606812" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606812">(Jul 11 2019 at 06:50)</a>:</h4>
<p>so you at least have correct reaching writes for any use at the point of any other write</p>



<a name="170606816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606816">(Jul 11 2019 at 06:51)</a>:</h4>
<p>If <code>x</code> has multiple reaching definitions, if any one of them is maybe qualified, we need to assume that <code>x</code> is maybe qualifed</p>



<a name="170606824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606824" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606824">(Jul 11 2019 at 06:51)</a>:</h4>
<p>for const qualif, sure</p>



<a name="170606918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606918" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606918">(Jul 11 2019 at 06:53)</a>:</h4>
<p>so this works specifically because the writes are order-independent</p>



<a name="170606949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170606949" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170606949">(Jul 11 2019 at 06:53)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay, so, let me know if you've written this down before</p>



<a name="170607004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607004" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607004">(Jul 11 2019 at 06:54)</a>:</h4>
<p>The order of writes is handled by the dataflow analysis. If there's a whole definition of <code>x</code> followed by  a partial definition of <code>x</code>, both will reach a "use" further down</p>



<a name="170607044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607044" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607044">(Jul 11 2019 at 06:54)</a>:</h4>
<p>When there's multiple entries, the reaching definitions at exit of all predecessors are unioned</p>



<a name="170607077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607077" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607077">(Jul 11 2019 at 06:55)</a>:</h4>
<p>for every local <code>x</code>, you're propagating a conservative approximation <code>f(x)</code> to every use of <code>x</code>, made by merging all the writes to <code>x</code> uniformly</p>



<a name="170607105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607105" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607105">(Jul 11 2019 at 06:55)</a>:</h4>
<p>to do this, you're first propagating a <code>writes(x)</code> set, and <code>f(x)</code> at any given point is <code>writes(x).map(f).fold(merge)</code> at that point</p>



<a name="170607161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607161">(Jul 11 2019 at 06:56)</a>:</h4>
<p>Yes. Can we change <code>f(x)</code> to <code>qualif(x)</code></p>



<a name="170607165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607165">(Jul 11 2019 at 06:56)</a>:</h4>
<p>propagating <code>f</code> directly is equivalent to propagating <code>writes</code>, but the latter is more reusable, for multiple functions</p>



<a name="170607173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607173" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607173">(Jul 11 2019 at 06:56)</a>:</h4>
<p>yeah I just meant dataflow in general</p>



<a name="170607182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607182" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607182">(Jul 11 2019 at 06:56)</a>:</h4>
<p>Yes!</p>



<a name="170607191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607191">(Jul 11 2019 at 06:57)</a>:</h4>
<p>okay so I see why this is sound, it's because of the unordered <code>merge</code> (ignoring full writes)</p>



<a name="170607197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607197">(Jul 11 2019 at 06:57)</a>:</h4>
<p>(and it can be done using only gens and kills</p>



<a name="170607201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607201" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607201">(Jul 11 2019 at 06:57)</a>:</h4>
<p>you couldn't use this for constant folding, for example</p>



<a name="170607257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607257" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607257">(Jul 11 2019 at 06:58)</a>:</h4>
<p>(I'm a bit worried that naively doing this with the gen/kill dataflow framework might be less efficient than other alternatives but that's unrelated to my other concerns)</p>



<a name="170607264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607264" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607264">(Jul 11 2019 at 06:58)</a>:</h4>
<p>I'm pretty sure you can't, because then you need a lattice containing all possible values</p>



<a name="170607268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607268" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607268">(Jul 11 2019 at 06:58)</a>:</h4>
<p>for the constant</p>



<a name="170607298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607298" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607298">(Jul 11 2019 at 06:59)</a>:</h4>
<p>hmm, you could handle <code>a += 1</code> because you'd be seeing <code>a = a + 1</code> and it's like <code>a@2 = a@1 + 1</code></p>



<a name="170607324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607324" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607324">(Jul 11 2019 at 06:59)</a>:</h4>
<p>what you couldn't handle is the distinction between <code>if/else</code> and the entry vs backedge of a loop</p>



<a name="170607428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607428" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607428">(Jul 11 2019 at 07:01)</a>:</h4>
<p>but even then, if your <code>merge(a, b)</code> is <code>if a? == b? { a } else { None }</code>... that's still order-independent</p>



<a name="170607498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607498">(Jul 11 2019 at 07:02)</a>:</h4>
<p>The analysis  I have in mind doesn't assume anything about conditionals, so the <code>a? == b?</code> is confusing to me</p>



<a name="170607500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607500" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607500">(Jul 11 2019 at 07:02)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay, so, full writes are SSA-like which is very good, and having multiple of them is always from a "CFG merge", so only partial writes can be order-dependent</p>



<a name="170607512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607512" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607512">(Jul 11 2019 at 07:03)</a>:</h4>
<p>I meant for constant-folding: keep the value only if it's equal on all edges</p>



<a name="170607595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607595" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607595">(Jul 11 2019 at 07:04)</a>:</h4>
<p>okay so if you were doing symbolic tracking of ADTs, or even using miri allocations, then my previous example with <code>a</code>, <code>b</code> and <code>y</code> flowing into <code>x</code> would be a problem</p>



<a name="170607627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607627" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607627">(Jul 11 2019 at 07:05)</a>:</h4>
<p>pretty much because you don't have a <code>merge</code>, you have side-effects</p>



<a name="170607649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607649" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607649">(Jul 11 2019 at 07:05)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay... what else, how do you handle <code>&amp;mut x</code>?</p>



<a name="170607659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607659" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607659">(Jul 11 2019 at 07:05)</a>:</h4>
<p>or borrows in general, I guess, not just mutable ones</p>



<a name="170607704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607704">(Jul 11 2019 at 07:06)</a>:</h4>
<p>It's what you proposed on nagisa's PR</p>



<a name="170607706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607706" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607706">(Jul 11 2019 at 07:06)</a>:</h4>
<p>(since <code>&amp;Cell&lt;T&gt;</code> could still mutate <code>T</code>)</p>



<a name="170607717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607717" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607717">(Jul 11 2019 at 07:06)</a>:</h4>
<p>assume the worst, based on the type?</p>



<a name="170607725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607725" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607725">(Jul 11 2019 at 07:06)</a>:</h4>
<p>do you track it in the chain though?</p>



<a name="170607728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607728" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607728">(Jul 11 2019 at 07:06)</a>:</h4>
<p>I use <code>HaveBeenBorrowedLocals</code> to see if a pointer to <code>x</code> could possible exist at a given program point</p>



<a name="170607740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607740" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607740">(Jul 11 2019 at 07:07)</a>:</h4>
<p>oh</p>



<a name="170607762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607762" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607762">(Jul 11 2019 at 07:07)</a>:</h4>
<p>If so, I mark any indirect definitions as <em>possibly</em> writing to <code>x</code></p>



<a name="170607770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607770" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607770">(Jul 11 2019 at 07:07)</a>:</h4>
<p>(Indirect definitions are <code>*p = ...</code>)</p>



<a name="170607785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607785" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607785">(Jul 11 2019 at 07:07)</a>:</h4>
<p>that's not enough, and it could be wrong qualif-wise</p>



<a name="170607833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607833">(Jul 11 2019 at 07:08)</a>:</h4>
<p>counterexample?</p>



<a name="170607837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607837" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607837">(Jul 11 2019 at 07:08)</a>:</h4>
<p>function calls</p>



<a name="170607843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607843" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607843">(Jul 11 2019 at 07:08)</a>:</h4>
<p>Those are handled</p>



<a name="170607849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607849" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607849">(Jul 11 2019 at 07:08)</a>:</h4>
<p>so what do you do then?</p>



<a name="170607853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607853" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607853">(Jul 11 2019 at 07:08)</a>:</h4>
<p>(one moment</p>



<a name="170607887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607887" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607887">(Jul 11 2019 at 07:09)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/62547/files#diff-f7260434bc49a5d0402c7cf7f08ea77cR58" target="_blank" title="https://github.com/rust-lang/rust/pull/62547/files#diff-f7260434bc49a5d0402c7cf7f08ea77cR58">https://github.com/rust-lang/rust/pull/62547/files#diff-f7260434bc49a5d0402c7cf7f08ea77cR58</a></p>



<a name="170607892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607892" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607892">(Jul 11 2019 at 07:09)</a>:</h4>
<p>here</p>



<a name="170607899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607899" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607899">(Jul 11 2019 at 07:09)</a>:</h4>
<p>I'm scared of opening that :D</p>



<a name="170607980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607980" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607980">(Jul 11 2019 at 07:10)</a>:</h4>
<p>I mean your can look at the domain</p>



<a name="170607989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170607989" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170607989">(Jul 11 2019 at 07:10)</a>:</h4>
<p>?</p>



<a name="170608002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608002">(Jul 11 2019 at 07:10)</a>:</h4>
<p>or go to <a href="https://github.com/rust-lang/rust/issues/62547" target="_blank" title="https://github.com/rust-lang/rust/issues/62547">#62547</a></p>



<a name="170608005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608005">(Jul 11 2019 at 07:10)</a>:</h4>
<p>I'm scared of looking at the PR <em>right</em> now</p>



<a name="170608011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608011">(Jul 11 2019 at 07:10)</a>:</h4>
<div class="codehilite"><pre><span></span>        // We can&#39;t know (without MIR inlining or explicit annotation) whether a callee mutates
        // data behind a pointer. If the address of one of our locals is observable, it may be the
        // target of such a mutation. A type-based analysis (e.g. does this function take any type
        // containing a mutable reference as a parameter?) is insufficient, since raw pointers can
        // be laundered through any integral type.
</pre></div>



<a name="170608026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608026">(Jul 11 2019 at 07:11)</a>:</h4>
<p>So we treat all function calls as "indirect definitions"</p>



<a name="170608086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608086" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608086">(Jul 11 2019 at 07:12)</a>:</h4>
<p>This is not precise, but it's not clear to me how one would do any better</p>



<a name="170608116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608116" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608116">(Jul 11 2019 at 07:13)</a>:</h4>
<p>okay, yeah, that sounds fine (I already wrote a similar analysis last year. ugh I really need to get all of that merged)</p>



<a name="170608144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608144" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608144">(Jul 11 2019 at 07:13)</a>:</h4>
<p>but anyway, from all of this what I gather is:<br>
1. "use-def" confused the hell out of me, "reaching writes" makes a lot more sense<br>
2. "merge all writes", in an order-independent way, is what makes this work, and it should be somehow put up front (maybe make it a literal <code>bool</code> that gets <code>|</code>'d by the framework?)</p>



<a name="170608225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608225" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608225">(Jul 11 2019 at 07:15)</a>:</h4>
<p>"use-def chain" and "reaching definitions" are terms of art so I'm loathe to change them. If more people chime in I will. AFAICT I'm using them correctly.</p>



<a name="170608229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608229">(Jul 11 2019 at 07:15)</a>:</h4>
<p>and qualify_consts should have the 2 type-based qualif's simply ignore the qualification if the type isn't even susceptible to it</p>



<a name="170608233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608233">(Jul 11 2019 at 07:15)</a>:</h4>
<p>The "def" part is confusing though</p>



<a name="170608250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608250">(Jul 11 2019 at 07:15)</a>:</h4>
<p>they are terms of art that apply much better in more SSA-like situations :P</p>



<a name="170608297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608297">(Jul 11 2019 at 07:16)</a>:</h4>
<p>actually, hmm, for the 2 non-type-based qualifs (the promotable stuff), you want borrows to just set them</p>



<a name="170608306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608306">(Jul 11 2019 at 07:16)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> so maybe just treat non-frozen borrows as resetting to the "worst case for that type"?</p>



<a name="170608307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608307" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608307">(Jul 11 2019 at 07:17)</a>:</h4>
<p>I agree you can bail out for <code>HasInteriorMut</code> and <code>NeedsDrop</code></p>



<a name="170608330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608330" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608330">(Jul 11 2019 at 07:17)</a>:</h4>
<p>Well, why not wait until there's actually a write to the target of a pointer?</p>



<a name="170608331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608331" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608331">(Jul 11 2019 at 07:17)</a>:</h4>
<p>which for the unpromotability qualifs, the worst case doesn't depend on the type and it's 1/<code>true</code></p>



<a name="170608389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608389" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608389">(Jul 11 2019 at 07:18)</a>:</h4>
<p>tracking indirect writes is neat but IMO too expensive, and it's not like we promote anything you can borrow more than once anyway?</p>



<a name="170608396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608396" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608396">(Jul 11 2019 at 07:18)</a>:</h4>
<p>(I'm still not 100% on how this extends to promotability, my mental model has been exclusively <code>HasInteriorMut</code> and <code>NeedsDrop</code>)</p>



<a name="170608424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608424" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608424">(Jul 11 2019 at 07:19)</a>:</h4>
<p>like, we don't allow user variables, only temps, in the MIR of promoted expressions, so anything you could borrow yourself and mutate doesn't need to be allowed</p>



<a name="170608448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608448" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608448">(Jul 11 2019 at 07:19)</a>:</h4>
<p>yeah for those two it's just easier to assume that they're type-based once they're borrowed</p>



<a name="170608532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608532" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608532">(Jul 11 2019 at 07:21)</a>:</h4>
<p>this would be easier, IMO, if you weren't restricted by using the existing dataflow framework, for creating the chains (or "sets", really)</p>



<a name="170608546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608546" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608546">(Jul 11 2019 at 07:21)</a>:</h4>
<p>since you could have richer enums describing the kind of write</p>



<a name="170608624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608624" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608624">(Jul 11 2019 at 07:23)</a>:</h4>
<p>I think it is likely  to be more efficient, I think it would take more implementation work though.</p>



<a name="170608634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608634">(Jul 11 2019 at 07:23)</a>:</h4>
<p>I did propose a custom dataflow framework at the top of this thread</p>



<a name="170608635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608635" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608635">(Jul 11 2019 at 07:23)</a>:</h4>
<p>fair enough</p>



<a name="170608651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608651" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608651">(Jul 11 2019 at 07:23)</a>:</h4>
<p>I'm a bit mad that we have to transfer information between locals. that's the only reason what I had in mind doesn't work :(</p>



<a name="170608659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608659" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608659">(Jul 11 2019 at 07:24)</a>:</h4>
<blockquote>
<p>I <em>never</em> intended for anyone to write a dataflow implementation themselves, I'm sorry if that was ever an interpretation of anything I said</p>
</blockquote>
<p>XD</p>



<a name="170608704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608704">(Jul 11 2019 at 07:24)</a>:</h4>
<p>oh well now I can pretend this took ages to happen because it's actually hard</p>



<a name="170608755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608755" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608755">(Jul 11 2019 at 07:25)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> maybe we should have a discussion with <span class="user-mention" data-user-id="124288">@oli</span> and <span class="user-mention" data-user-id="116009">@nikomatsakis</span> and <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> to pick some terminology that we all agree on?</p>



<a name="170608767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608767" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608767">(Jul 11 2019 at 07:25)</a>:</h4>
<p>I think "reaching writes set" is the most accurate</p>



<a name="170608821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608821">(Jul 11 2019 at 07:26)</a>:</h4>
<p>and you could also use a different "ever borrowed" kill/gen dataflow (might already exist for generators)</p>



<a name="170608846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608846" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608846">(Jul 11 2019 at 07:26)</a>:</h4>
<p>well, no, you need "ever mutably borrowed"</p>



<a name="170608867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608867" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608867">(Jul 11 2019 at 07:27)</a>:</h4>
<p>Yes that would be nice. I'm fine with "reaching writes set", although I think the actual implementor of <code>BitDenotation</code> should be called <code>ReachingDefinitions</code>.</p>



<a name="170608881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608881" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608881">(Jul 11 2019 at 07:27)</a>:</h4>
<p><code>ReachingDefs</code> is okay I guess</p>



<a name="170608884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608884" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608884">(Jul 11 2019 at 07:27)</a>:</h4>
<p>As long as it's not doing anything special</p>



<a name="170608895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608895">(Jul 11 2019 at 07:28)</a>:</h4>
<p>the "ever mutably borrowed" would be to gate whether you're assuming the worst or actually merging the writes set</p>



<a name="170608970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608970" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608970">(Jul 11 2019 at 07:28)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> can we land a "reaching defs" that ignores indirect writes or borrows and has no infra for doing the "merge RHSes of writes" style of dataflow?</p>



<a name="170608989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170608989" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170608989">(Jul 11 2019 at 07:29)</a>:</h4>
<p>How do you mean "ignores writes"?</p>



<a name="170609007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609007" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609007">(Jul 11 2019 at 07:29)</a>:</h4>
<p>typo, sorry. anyway I think  such a PR would be easier to review</p>



<a name="170609014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609014" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609014">(Jul 11 2019 at 07:29)</a>:</h4>
<p>oh and I keep forgetting, I should ping <span class="user-mention" data-user-id="116083">@pnkfelix</span> to look at this stuff</p>



<a name="170609127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609127" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609127">(Jul 11 2019 at 07:31)</a>:</h4>
<p>So the "merge RHSes of writes" is seperate from the dataflow pass</p>



<a name="170609129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609129" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609129">(Jul 11 2019 at 07:31)</a>:</h4>
<p>in the current PR</p>



<a name="170609186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609186" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609186">(Jul 11 2019 at 07:32)</a>:</h4>
<p>I could take out all handling of indirect writes/borrows  and only do dataflow on defs locals that are never borrowed</p>



<a name="170609198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609198" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609198">(Jul 11 2019 at 07:32)</a>:</h4>
<p>but I don't know how much easier that would be to review.</p>



<a name="170609203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609203" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609203">(Jul 11 2019 at 07:32)</a>:</h4>
<p>oh I guess you could use one bit for "was borrowed"</p>



<a name="170609232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609232" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609232">(Jul 11 2019 at 07:33)</a>:</h4>
<p>That's already been implemented in  the<code>HaveBeenBorrowedLocals</code> dataflow analysis</p>



<a name="170609239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609239" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609239">(Jul 11 2019 at 07:33)</a>:</h4>
<p>(which was meant for generators originally)</p>



<a name="170609246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609246" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609246">(Jul 11 2019 at 07:33)</a>:</h4>
<p>and <code>&amp;mut x</code> would act as if it was a <code>x = unknown()</code> but not in the program</p>



<a name="170609256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609256" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609256">(Jul 11 2019 at 07:33)</a>:</h4>
<p>well, in your case, frozen borrows are fine</p>



<a name="170609318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609318" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609318">(Jul 11 2019 at 07:34)</a>:</h4>
<p>What if I have <code>let p = &amp;mut x; x = 2; *p = 4;</code></p>



<a name="170609332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609332" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609332">(Jul 11 2019 at 07:34)</a>:</h4>
<p>ah drat I see</p>



<a name="170609355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170609355" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170609355">(Jul 11 2019 at 07:35)</a>:</h4>
<p>okay, fine</p>



<a name="170610299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170610299" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170610299">(Jul 11 2019 at 07:51)</a>:</h4>
<p>I'm off to bed. If you like you can take a look at the reaching definitions analysis itself</p>



<a name="170610300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170610300" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170610300">(Jul 11 2019 at 07:51)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/62547/files#diff-f7260434bc49a5d0402c7cf7f08ea77c" target="_blank" title="https://github.com/rust-lang/rust/pull/62547/files#diff-f7260434bc49a5d0402c7cf7f08ea77c">https://github.com/rust-lang/rust/pull/62547/files#diff-f7260434bc49a5d0402c7cf7f08ea77c</a></p>



<a name="170610370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170610370" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170610370">(Jul 11 2019 at 07:52)</a>:</h4>
<p>I think it's comprehensible (but then again I wrote it)</p>



<a name="170610434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170610434" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170610434">(Jul 11 2019 at 07:53)</a>:</h4>
<p>This is separate from the "chain" data structure which determines precisely which subset of writes are reachable for a use of a given local</p>



<a name="170610779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170610779" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170610779">(Jul 11 2019 at 07:58)</a>:</h4>
<p>the output of "reaching definitions" is all definitions of <strong>any</strong> local which reach a given statement</p>



<a name="170854445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170854445" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170854445">(Jul 14 2019 at 23:51)</a>:</h4>
<p>I've rebased <a href="https://github.com/rust-lang/rust/issues/62547" target="_blank" title="https://github.com/rust-lang/rust/issues/62547">#62547</a> with some fixes and additional documentation in the hopes of clearing up some of the confusion. I've also left some comments on github justifying the naming of <code>UseDefChain</code> and <code>ReachingDefinitions</code> and discussing how this could be used to implement const propagation.</p>



<a name="170854449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/170854449" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#170854449">(Jul 14 2019 at 23:52)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="171013711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171013711" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171013711">(Jul 16 2019 at 18:29)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Could I pick your brain for a little while about the current logic around const qualification?</p>



<a name="171095449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171095449" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171095449">(Jul 17 2019 at 16:51)</a>:</h4>
<p>pinging <span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="171448696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171448696" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171448696">(Jul 22 2019 at 17:09)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> this line in <code>const_qualify.rs</code> makes dataflow-based const qualification a bit harder, since it makes the <code>IsNotPromotable</code> pass dependent on <code>HasMutInterior</code>. Is there a better way to express this?</p>



<a name="171448705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171448705" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171448705">(Jul 22 2019 at 17:09)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/4bc1ce7bdb7f5dc9ea07c0b630c087d8e11140e4/src/librustc_mir/transform/qualify_consts.rs#L768" target="_blank" title="https://github.com/rust-lang/rust/blob/4bc1ce7bdb7f5dc9ea07c0b630c087d8e11140e4/src/librustc_mir/transform/qualify_consts.rs#L768">https://github.com/rust-lang/rust/blob/4bc1ce7bdb7f5dc9ea07c0b630c087d8e11140e4/src/librustc_mir/transform/qualify_consts.rs#L768</a></p>



<a name="171769750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171769750" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171769750">(Jul 26 2019 at 12:37)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Is there someone who can help clarify the current logic in <code>qualify_consts.rs</code> for me?</p>



<a name="171783289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171783289" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171783289">(Jul 26 2019 at 15:29)</a>:</h4>
<p>I can help</p>



<a name="171783604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171783604" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171783604">(Jul 26 2019 at 15:33)</a>:</h4>
<p>The comment in the link you posted suggests that the dependency exists just to reduce duplicate diagnostics. Maybe we can dedup another way</p>



<a name="171851398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851398" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851398">(Jul 27 2019 at 16:29)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="124288">@oli</span>! So the basic idea is to replace <code>Qualifs::in_local</code>, which is currently only kept up to date within a block, with a flow-sensitive version derived from dataflow analysis (either reaching definitions based or using a not-yet-implemented custom dataflow analysis). I'm a bit confused because "const qualification" is also run in normal functions to mark candidates for promotion, but I can't really imagine what it means to track promotability across basic blocks.</p>



<a name="171851503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851503" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851503">(Jul 27 2019 at 16:32)</a>:</h4>
<p>we only track promotability across asserts and uncoditional jump I believe</p>



<a name="171851505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851505">(Jul 27 2019 at 16:32)</a>:</h4>
<p>we won't ever expand that</p>



<a name="171851508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851508" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851508">(Jul 27 2019 at 16:32)</a>:</h4>
<p>I think I'm just trying to clarify what exactly the semantics are around <code>Qualifs[Is{Implicitly,}Promotable]</code> in this particular pass. If we have <code>a = if x { b } else { c }</code> where both <code>b</code> and <code>c</code> are promotable, we could never really promote <code>a</code> right?</p>



<a name="171851512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851512" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851512">(Jul 27 2019 at 16:32)</a>:</h4>
<p>no, not ever</p>



<a name="171851518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851518" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851518">(Jul 27 2019 at 16:33)</a>:</h4>
<p>WIthout doing const-prop/dead-code elimination first (but that's a ways off)</p>



<a name="171851521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851521" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851521">(Jul 27 2019 at 16:33)</a>:</h4>
<p>may not even promote <code>b</code> or <code>c</code> if they depend on values created before the <code>if</code></p>



<a name="171851522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851522" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851522">(Jul 27 2019 at 16:33)</a>:</h4>
<p>const prop isn't happening before promotion</p>



<a name="171851523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851523" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851523">(Jul 27 2019 at 16:33)</a>:</h4>
<p>promotion needs to happen in a guaranteed manner</p>



<a name="171851526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851526" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851526">(Jul 27 2019 at 16:33)</a>:</h4>
<p>const prop is opportunistic</p>



<a name="171851567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851567" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851567">(Jul 27 2019 at 16:34)</a>:</h4>
<p>So does it even make sense to track<code>IsPromotable</code> in a flow-sensitive manner?</p>



<a name="171851591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851591" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851591">(Jul 27 2019 at 16:35)</a>:</h4>
<p>I think we just need to do this for <code>HasMutInterior</code> and <code>NeedsDrop</code></p>



<a name="171851592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851592">(Jul 27 2019 at 16:35)</a>:</h4>
<p>I thought it was necessary for const eval?</p>



<a name="171851593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851593" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851593">(Jul 27 2019 at 16:35)</a>:</h4>
<p>oh right</p>



<a name="171851594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851594" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851594">(Jul 27 2019 at 16:35)</a>:</h4>
<p>those are enough</p>



<a name="171851650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851650" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851650">(Jul 27 2019 at 16:36)</a>:</h4>
<p>Okay good! I think that simplifies things for me</p>



<a name="171851703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851703" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851703">(Jul 27 2019 at 16:38)</a>:</h4>
<p>I'm going to try and refactor <code>qualif_consts.rs</code> to use a flow-sensitive backend to determine <code>HasMutInterior</code> and <code>NeedsDrop</code> for each local at each program point.</p>



<a name="171851725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851725" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851725">(Jul 27 2019 at 16:39)</a>:</h4>
<p>And then try to get a proof of concept going that uses <a href="https://github.com/rust-lang/rust/issues/62547" target="_blank" title="https://github.com/rust-lang/rust/issues/62547">#62547</a> to build that flow-sensitive backend</p>



<a name="171851934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171851934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171851934">(Jul 27 2019 at 16:45)</a>:</h4>
<p>A few more clarifications around promotion; I believe the main use-case is R-value static promotion like <code>let x = &amp;5</code>. We only need to promote things when their reference is taken. Otherwise things are just handled by const-eval?</p>



<a name="171856135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171856135" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171856135">(Jul 27 2019 at 18:53)</a>:</h4>
<p>Yes</p>



<a name="171856136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171856136" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171856136">(Jul 27 2019 at 18:53)</a>:</h4>
<p>Const prop to be exact</p>



<a name="171856177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171856177" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171856177">(Jul 27 2019 at 18:54)</a>:</h4>
<p>Well, also there's repeat expression initializers</p>



<a name="171856180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171856180" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171856180">(Jul 27 2019 at 18:54)</a>:</h4>
<p>And the hack for SIMD</p>



<a name="171856193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171856193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171856193">(Jul 27 2019 at 18:54)</a>:</h4>
<p>Where function arguments are promoted</p>



<a name="171858656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171858656" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171858656">(Jul 27 2019 at 20:18)</a>:</h4>
<p>Okay. I just saw these in <code>Candidate</code>  enum over in <code>promote_consts.rs</code>.</p>



<a name="171955225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/171955225" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#171955225">(Jul 29 2019 at 15:24)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Just a heads up. I'm going to start on this this evening, but I will be pretty slow. I've tried to get started a few times before, but ground to a halt. I think a lack of understanding around promotion as well as the cyclomatic complexity of some functions were the problem. Hopefully the first one will be less of a problem now :)</p>



<a name="172930985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172930985" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Regueiro <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172930985">(Aug 10 2019 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> Hey, how's progress out of curiosity?</p>



<a name="172956416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956416" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956416">(Aug 11 2019 at 06:31)</a>:</h4>
<p><span class="user-mention" data-user-id="124069">@Alexander Regueiro</span> Short answer: stalled.</p>



<a name="172956604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956604" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956604">(Aug 11 2019 at 06:37)</a>:</h4>
<p><span class="user-mention" data-user-id="124069">@Alexander Regueiro</span> Long answer: I'm doubtful that I'm able to move this forward since whenever I've tried to extend the current qualification logic to more complex CFGs, it requires a pretty large re-architecting. This makes preserving the existing behavior of the const qualifier difficult, and makes me worry that my work won't get merged. I can't help but feel that <span class="user-mention" data-user-id="119009">@eddyb</span>  has a much simpler solution in mind that I am unable to see, which is a bit discouraging.</p>



<a name="172956608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956608" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956608">(Aug 11 2019 at 06:37)</a>:</h4>
<p>ugh I fell behind this again :(</p>



<a name="172956609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956609" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956609">(Aug 11 2019 at 06:37)</a>:</h4>
<p>If you're interested in working on this, either by yourself or in collaboration, let me know and we can have a synchronous discussion.</p>



<a name="172956615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956615" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956615">(Aug 11 2019 at 06:38)</a>:</h4>
<p>(also, last week I was away on vacation)</p>



<a name="172956662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956662" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956662">(Aug 11 2019 at 06:38)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> so the problem you hit is that there are still interactions between the different bits, right?</p>



<a name="172956663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956663" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956663">(Aug 11 2019 at 06:38)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> No problem.</p>



<a name="172956665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956665">(Aug 11 2019 at 06:38)</a>:</h4>
<p>is it that silly thing that has a comment on it saying it's to improve error quality?</p>



<a name="172956669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956669" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956669">(Aug 11 2019 at 06:38)</a>:</h4>
<p>we could try turning it off in the current code and see what happens</p>



<a name="172956670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956670" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956670">(Aug 11 2019 at 06:38)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Yes, that's the only explicit dependency</p>



<a name="172956671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956671" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956671">(Aug 11 2019 at 06:38)</a>:</h4>
<p>maybe we can massage the diagnostics so they make sense</p>



<a name="172956681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956681" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956681">(Aug 11 2019 at 06:39)</a>:</h4>
<p>actually, hmm</p>



<a name="172956725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956725" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956725">(Aug 11 2019 at 06:40)</a>:</h4>
<p>I think that if we just clear one flag and not set the other, it might cause bugs</p>



<a name="172956742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956742" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956742">(Aug 11 2019 at 06:41)</a>:</h4>
<p>e.g. <code>&amp;&amp;Cell::new(0)</code> might try to promote the outer reference even if the inner one isn't allowed to be promoted</p>



<a name="172956783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956783" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956783">(Aug 11 2019 at 06:42)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay, new idea: you know how the actual promotion works? the part that mutates?</p>



<a name="172956794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956794" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956794">(Aug 11 2019 at 06:43)</a>:</h4>
<p>mutates the MIR? In <code>promote_consts.rs</code>?</p>



<a name="172956797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956797" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956797">(Aug 11 2019 at 06:43)</a>:</h4>
<p>it traverses all the intermediary Rvalue's by using the "promotability state" information to know where the <em>only</em> assignment to a local is</p>



<a name="172956798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956798" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956798">(Aug 11 2019 at 06:43)</a>:</h4>
<p>so basically it's like an SSA tree</p>



<a name="172956845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956845" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956845">(Aug 11 2019 at 06:44)</a>:</h4>
<p>we could do that same traversal and check that every borrow is actually promotable</p>



<a name="172956848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956848" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956848">(Aug 11 2019 at 06:44)</a>:</h4>
<p><em>after</em> having computed everything locally</p>



<a name="172956851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956851" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956851">(Aug 11 2019 at 06:44)</a>:</h4>
<p>so <code>&amp;expr</code> would always have no bits set</p>



<a name="172956854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956854" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956854">(Aug 11 2019 at 06:44)</a>:</h4>
<p>My understanding was that only temporaries which are assigned to exactly once are considered for promotion</p>



<a name="172956859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956859" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956859">(Aug 11 2019 at 06:44)</a>:</h4>
<p>This is what you're saying?</p>



<a name="172956865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956865" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956865">(Aug 11 2019 at 06:45)</a>:</h4>
<p>yeah, but you have to keep in mind that you can have e.g. <code>&amp;(1 + 2, false)</code> which is several Rvalue's</p>



<a name="172956868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956868" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956868">(Aug 11 2019 at 06:45)</a>:</h4>
<p>so they form a tree, similar to the AST for the expression</p>



<a name="172956874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956874" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956874">(Aug 11 2019 at 06:45)</a>:</h4>
<p>That would be translated to <code>_1 = 1+2; _2 = false; _3 = (_1, _2); _4 = &amp;_3</code>?</p>



<a name="172956875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956875" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956875">(Aug 11 2019 at 06:45)</a>:</h4>
<p>something like that yeah</p>



<a name="172956916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956916" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956916">(Aug 11 2019 at 06:46)</a>:</h4>
<p>give or take a panic on arithmetic overflow?</p>



<a name="172956919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956919">(Aug 11 2019 at 06:46)</a>:</h4>
<p>yupp</p>



<a name="172956924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956924" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956924">(Aug 11 2019 at 06:46)</a>:</h4>
<p>once we compute the bits for what locals <em>contain</em> then we can do a tentative promotion (maybe even in the mutating code, just make it failible? but that might be too hard)</p>



<a name="172956926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956926" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956926">(Aug 11 2019 at 06:47)</a>:</h4>
<p>and bail out if we find anything fishy</p>



<a name="172956935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956935" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956935">(Aug 11 2019 at 06:47)</a>:</h4>
<p>so &amp;&amp;Cell::new(0) would not mind the outer reference <em>by itself</em> but also look inside, and in the inner reference, it would find Cell::new(0) with interior mutability</p>



<a name="172956940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956940">(Aug 11 2019 at 06:47)</a>:</h4>
<p>this could mean we might be able to even remove some of the uses of the qualification bits</p>



<a name="172956981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956981" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956981">(Aug 11 2019 at 06:48)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> wow I feel so dumb</p>



<a name="172956984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956984" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956984">(Aug 11 2019 at 06:48)</a>:</h4>
<p>What does the MIR look like for <code>&amp;&amp;Cell::new(0)</code>? I'm not quite sure what problem you're solving here.</p>



<a name="172956987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956987" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956987">(Aug 11 2019 at 06:48)</a>:</h4>
<p>yeah we only need to support the promotion usecases for "SSA tree equivalent to linear control-flow"</p>



<a name="172956992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956992" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956992">(Aug 11 2019 at 06:49)</a>:</h4>
<p>Right, we don't need to do dataflow for promotion.</p>



<a name="172956994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172956994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172956994">(Aug 11 2019 at 06:49)</a>:</h4>
<p>the problem is that right now the inner &amp;Cell::new(0) is marked as Unpromotable</p>



<a name="172957000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957000">(Aug 11 2019 at 06:49)</a>:</h4>
<p><em>because</em> the temp it borrows, holding a Cell&lt;i32&gt;, is InteriorMut</p>



<a name="172957004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957004" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957004">(Aug 11 2019 at 06:49)</a>:</h4>
<p>and that's the dependency between two qualif bits that you hit</p>



<a name="172957005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957005">(Aug 11 2019 at 06:49)</a>:</h4>
<p>Since we have an additional rule that "promotable temps can only be assigned to exactly once"</p>



<a name="172957051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957051" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957051">(Aug 11 2019 at 06:50)</a>:</h4>
<p>wait so what do we need dataflow for? the interiormut/needsdrop?</p>



<a name="172957054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957054">(Aug 11 2019 at 06:50)</a>:</h4>
<p>Yes. Exactly those two qualifs I believe.</p>



<a name="172957109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957109" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957109">(Aug 11 2019 at 06:52)</a>:</h4>
<p>are you interested in changing the code on master to rely on the "SSA-like tree" for promotion checking? assuming we never write the qualifs again after initialization for promotable temps, we should already be able to use local_qualifs to do this second pass</p>



<a name="172957112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957112" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957112">(Aug 11 2019 at 06:52)</a>:</h4>
<p>Okay, so this is the genesis behind the current code clearing <code>HasMutInterior</code> and replacing it with <code>IsNotPromotable</code>.</p>



<a name="172957113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957113" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957113">(Aug 11 2019 at 06:52)</a>:</h4>
<p>I could also look into it since I have a bit more free time now (long story)</p>



<a name="172957115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957115" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957115">(Aug 11 2019 at 06:52)</a>:</h4>
<p>how did I miss this lmao</p>



<a name="172957120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957120">(Aug 11 2019 at 06:52)</a>:</h4>
<p>on assignment</p>



<a name="172957131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957131" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957131">(Aug 11 2019 at 06:53)</a>:</h4>
<p>yeah that's done so anything containing the unpromotable reference isn't accidentally considered promotable itself</p>



<a name="172957132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957132" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957132">(Aug 11 2019 at 06:53)</a>:</h4>
<p>for a second I thought you could just keep HasMutInterior but that's a really bad idea</p>



<a name="172957134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957134" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957134">(Aug 11 2019 at 06:53)</a>:</h4>
<p>because things will clear it based on type</p>



<a name="172957191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957191">(Aug 11 2019 at 06:55)</a>:</h4>
<p>Regarding your "SSA-like tree" framing, how is that different from the current code?</p>



<a name="172957247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957247" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957247">(Aug 11 2019 at 06:56)</a>:</h4>
<p>It currently relies on a linear CFG because one always exists in <code>const fn</code>s since jumps are disallowed, and it can assume that promotable temps exist in a subset of the CFG which is linear because promotable temps can only be assigned to once in the <code>mir::Body</code></p>



<a name="172957300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957300" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957300">(Aug 11 2019 at 06:58)</a>:</h4>
<p>what I mean is not relying on the bits to be propagated correctly</p>



<a name="172957301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957301" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957301">(Aug 11 2019 at 06:58)</a>:</h4>
<p>Let me know how I can clarify that. (That sentence confuses me and I wrote it)</p>



<a name="172957307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957307" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957307">(Aug 11 2019 at 06:59)</a>:</h4>
<p>hmm, actually...</p>



<a name="172957311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957311">(Aug 11 2019 at 06:59)</a>:</h4>
<p>if we could somehow avoid code duplication (by making the step-wise stuff, like the current Qualif trait implementors, general enough)</p>



<a name="172957313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957313" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957313">(Aug 11 2019 at 07:00)</a>:</h4>
<p>we might be able to just write a promotion-checking pass with no dataflow</p>



<a name="172957358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957358">(Aug 11 2019 at 07:00)</a>:</h4>
<p>more like your def-use idea, but simpler because no branching</p>



<a name="172957364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957364" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957364">(Aug 11 2019 at 07:00)</a>:</h4>
<p>and then we can figure out how to implement const-checking with the same primitives</p>



<a name="172957378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957378" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957378">(Aug 11 2019 at 07:01)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="120791">@RalfJ</span> might like this direction?</p>



<a name="172957415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957415" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957415">(Aug 11 2019 at 07:02)</a>:</h4>
<p>right now the code is a mess because it sort of does two (quite related) things at the same time</p>



<a name="172957420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957420" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957420">(Aug 11 2019 at 07:02)</a>:</h4>
<p>the dataflow concerns are enough for me to want to split it up if possible</p>



<a name="172957421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957421" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957421">(Aug 11 2019 at 07:02)</a>:</h4>
<blockquote>
<p>right now the code is a mess because it sort of does two (quite related) things at the same time</p>
</blockquote>
<p>This has been a big struggle for me :)</p>



<a name="172957424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957424" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957424">(Aug 11 2019 at 07:02)</a>:</h4>
<p>I'm really sorry Q_Q</p>



<a name="172957437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957437" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957437">(Aug 11 2019 at 07:03)</a>:</h4>
<p>Yes, my original thought was that we want a linear pass which does promotion and a dataflow-based pass which checks for <code>HasMutInterior</code> and <code>NeedsDrop</code></p>



<a name="172957479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957479" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957479">(Aug 11 2019 at 07:04)</a>:</h4>
<p>yeah, it's just that the linear pass can be nicer because it can look at the "SSA-like trees" instead of being stateful</p>



<a name="172957491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957491" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957491">(Aug 11 2019 at 07:05)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> I have... an evil idea...</p>



<a name="172957493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957493" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957493">(Aug 11 2019 at 07:05)</a>:</h4>
<p>that I should've had ages ago :(</p>



<a name="172957494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957494" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957494">(Aug 11 2019 at 07:05)</a>:</h4>
<p>but there's a line in the current code which replaces <code>HasMutInterior</code> with <code>IsNotPromotable</code> when an assignment like <code>_1 = &amp;_2</code> occurs</p>



<a name="172957495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957495" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957495">(Aug 11 2019 at 07:05)</a>:</h4>
<p>we can do conservative approximations</p>



<a name="172957500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957500" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957500">(Aug 11 2019 at 07:05)</a>:</h4>
<p>So the two seem linked in some way that I still don't fully understand</p>



<a name="172957542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957542" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957542">(Aug 11 2019 at 07:06)</a>:</h4>
<blockquote>
<p>we can do conservative approximations</p>
</blockquote>
<p>?</p>



<a name="172957544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957544" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957544">(Aug 11 2019 at 07:06)</a>:</h4>
<p>so, that line is irrelevant for const-checking: an error would've always been emitted for that assignment, so it doesn't matter what you do as long as you don't cause more errors</p>



<a name="172957548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957548">(Aug 11 2019 at 07:06)</a>:</h4>
<blockquote>
<p>so, that line is irrelevant for const-checking: an error would've always been emitted for that assignment, so it doesn't matter what you do as long as you don't cause more errors</p>
</blockquote>
<p>So it really is just for diagnostics (as the comment suggests)</p>



<a name="172957549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957549" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957549">(Aug 11 2019 at 07:06)</a>:</h4>
<p>so ideally you would just turn off the HasInteriorMut flag (&amp;T is always Freeze anyway, regardless of &amp;)</p>



<a name="172957555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957555" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957555">(Aug 11 2019 at 07:07)</a>:</h4>
<p>but for promotion, you do need to keep track that you have an unpromotable reference so you don't promote something larger that contains it</p>



<a name="172957558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957558" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957558">(Aug 11 2019 at 07:07)</a>:</h4>
<p>because e.g. &amp;&amp;0 is promoted as &amp;'static &amp;'static 0, at the outermost reference (the inner one isn't promoted separately)</p>



<a name="172957609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957609" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957609">(Aug 11 2019 at 07:09)</a>:</h4>
<p>anyway, the conservative approx: we don't care about the order and just gather dependencies between locals, i.e. what <em>may</em> flow into what (note that this could be a cyclic graph because of loops)</p>



<a name="172957654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957654" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957654">(Aug 11 2019 at 07:10)</a>:</h4>
<p>and then we saturate it to fixpoint</p>



<a name="172957657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957657" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957657">(Aug 11 2019 at 07:10)</a>:</h4>
<p>we only need to specially handle one thing, which is initialization state</p>



<a name="172957664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957664" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957664">(Aug 11 2019 at 07:11)</a>:</h4>
<p>if a local is <em>definitely moved out of fully</em> at a drop, then what the local contained in it when it was initialized doesn't matter</p>



<a name="172957668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957668" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957668">(Aug 11 2019 at 07:11)</a>:</h4>
<p>but that can be done with an existing dataflow analysis pass</p>



<a name="172957670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957670" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957670">(Aug 11 2019 at 07:11)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> gah I wish I wasn't so stubborn to come up with this before you spent time working on a framework Q_Q</p>



<a name="172957711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957711" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957711">(Aug 11 2019 at 07:12)</a>:</h4>
<p>or, wait, how close is this to what you have?</p>



<a name="172957715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957715" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957715">(Aug 11 2019 at 07:12)</a>:</h4>
<blockquote>
<p>anyway, the conservative approx: we don't care about the order and just gather dependencies between locals, i.e. what <em>may</em> flow into what (note that this could be a cyclic graph because of loops)</p>
</blockquote>
<p>This part seems pretty simlar?</p>



<a name="172957716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957716">(Aug 11 2019 at 07:12)</a>:</h4>
<p>because if I did another dumb thing and described the code you've already written,,, then we'll just use that</p>



<a name="172957717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957717" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957717">(Aug 11 2019 at 07:12)</a>:</h4>
<p>I guess I'mm still waking up here</p>



<a name="172957725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957725" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957725">(Aug 11 2019 at 07:13)</a>:</h4>
<blockquote>
<p>I guess I'mm still waking up here</p>
</blockquote>
<p>I'm falling asleep here, so at least it's fair XD</p>



<a name="172957784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957784">(Aug 11 2019 at 07:15)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie</span> gah I wish I wasn't so stubborn to come up with this before you spent time working on a framework Q_Q</p>
</blockquote>
<p>I'm only interested in helping to get <a href="https://github.com/rust-lang/rust/issues/49146" target="_blank" title="https://github.com/rust-lang/rust/issues/49146">#49146</a> (and friends) implemented</p>



<a name="172957827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957827" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957827">(Aug 11 2019 at 07:16)</a>:</h4>
<p>okay, so we have 2 tasks we could do on master:</p>
<p>1. remove the Operand::Move side-effect of clearning the NeedsDrop qualif bit, and use a dataflow initialization analysis to know when a drop is dead<br>
2. compute promotion candidates in promote_consts instead of qualify_consts (i.e. all of them, without checking), and validate them by traversing the tree of temps</p>



<a name="172957829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957829">(Aug 11 2019 at 07:16)</a>:</h4>
<p>and then I think we can "just" land your PR?!</p>



<a name="172957832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957832" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957832">(Aug 11 2019 at 07:16)</a>:</h4>
<p>do you think you'd want to do one of these or should I take a stab at it?</p>



<a name="172957935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957935" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957935">(Aug 11 2019 at 07:18)</a>:</h4>
<p>You should take a stab at it. I think both steps are productive. However, I think we should think about using a custom dataflow analysis and not my PR.</p>



<a name="172957939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957939" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957939">(Aug 11 2019 at 07:18)</a>:</h4>
<p>if your PR is order-agnostic then it's not that different from my conservative idea</p>



<a name="172957954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957954" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957954">(Aug 11 2019 at 07:19)</a>:</h4>
<p>In order to use it i was going to have to change each <code>in_x</code> method from <code>Qualif</code> to return an enum like</p>



<a name="172957959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957959" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957959">(Aug 11 2019 at 07:19)</a>:</h4>
<p>like, you still need 1. with your PR, right? otherwise, you couldn't deal with the distinction between moved-out locals and still-initialized, drop-wise</p>



<a name="172957963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957963" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957963">(Aug 11 2019 at 07:19)</a>:</h4>
<div class="codehilite"><pre><span></span>Definitely
Conditionally(Vec&lt;Local&gt;)
Not
</pre></div>



<a name="172957966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172957966" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172957966">(Aug 11 2019 at 07:19)</a>:</h4>
<p>yeah that is reasonable</p>



<a name="172958010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958010">(Aug 11 2019 at 07:20)</a>:</h4>
<p>I think we can make it more efficient, but that is sort of the thing we need to do in order to be generic enough to handle this</p>



<a name="172958011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958011">(Aug 11 2019 at 07:20)</a>:</h4>
<p>Okay, in that case doing it on top of my PR would be fine. It just seemed really heavy on allocations.</p>



<a name="172958013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958013" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958013">(Aug 11 2019 at 07:20)</a>:</h4>
<p>ahh, see</p>



<a name="172958015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958015" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958015">(Aug 11 2019 at 07:20)</a>:</h4>
<p>that's where you have to get clever :P</p>



<a name="172958020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958020" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958020">(Aug 11 2019 at 07:21)</a>:</h4>
<p>And my PR is already really heavy on allocations</p>



<a name="172958022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958022" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958022">(Aug 11 2019 at 07:21)</a>:</h4>
<p>lemme show you an example of avoiding allocations</p>



<a name="172958064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958064" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958064">(Aug 11 2019 at 07:22)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc/mir/mod.rs#L1235" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/mir/mod.rs#L1235">https://github.com/rust-lang/rust/blob/master/src/librustc/mir/mod.rs#L1235</a></p>



<a name="172958065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958065" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958065">(Aug 11 2019 at 07:22)</a>:</h4>
<p>wow this doesn't even use Cow anymore</p>



<a name="172958074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958074" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958074">(Aug 11 2019 at 07:23)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> frankly, once we get rid of the two promotability qualifs, things are going to be muuuch better</p>



<a name="172958076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958076" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958076">(Aug 11 2019 at 07:23)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie</span> frankly, once we get rid of the two promotability qualifs, things are going to be muuuch better</p>
</blockquote>
<p>Agreed</p>



<a name="172958078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958078" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958078">(Aug 11 2019 at 07:23)</a>:</h4>
<p>Needs more existential types</p>



<a name="172958084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958084" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958084">(Aug 11 2019 at 07:23)</a>:</h4>
<p>because the other two are about value properties, <em>not</em> how you got a value. how many ways do you know to get one value from another?</p>



<a name="172958124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958124" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958124">(Aug 11 2019 at 07:24)</a>:</h4>
<p>projection and construction</p>



<a name="172958127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958127" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958127">(Aug 11 2019 at 07:24)</a>:</h4>
<p>that's... it</p>



<a name="172958141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958141" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958141">(Aug 11 2019 at 07:25)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> so what's going to be left is, uhh, a Ty -&gt; bool and AggregateKind -&gt; bool</p>



<a name="172958142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958142" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958142">(Aug 11 2019 at 07:25)</a>:</h4>
<p>that's it I'm pretty sure</p>



<a name="172958193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958193">(Aug 11 2019 at 07:27)</a>:</h4>
<p>types are an upper bound, aggregates are a lower bound, everything else is the same between !Freeze and NeedsDrop</p>



<a name="172958358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958358">(Aug 11 2019 at 07:33)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> we could probably even dedup the "promotable locals" by basically using your "where is this written to" information and limiting to one full initialization</p>



<a name="172958404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958404" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958404">(Aug 11 2019 at 07:34)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I think I need to go to bed now, but hopefully you could try implementing your ideas and see what problems arise. When I tried implementing qualification on top of my PR I had to make<code>Qualif::in_local</code> recursive (memoization was necessary to keep this reasonably efficient). Perhaps your ideas are simpler and don't require as much storage. I think maybe I do better when looking at code than talking in the abstract (the exception being the current implementation of <code>qualify_consts</code> I guess :)</p>



<a name="172958420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958420" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958420">(Aug 11 2019 at 07:35)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> status: making sure that commenting this out results in a test failure <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L771" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L771">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L771</a></p>



<a name="172958473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958473" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958473">(Aug 11 2019 at 07:37)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Yes, one nice side-effect of the use-def pass is you can answer queries like "give me all the temporaries which have exactly one definition"</p>



<a name="172958586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958586" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958586">(Aug 11 2019 at 07:41)</a>:</h4>
<p>wait, "def-use"... but, we don't care about the uses :P</p>



<a name="172958641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958641" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958641">(Aug 11 2019 at 07:43)</a>:</h4>
<p>Well yes, basically anything that enumerates "def"s can give you that (for some definition of "def")</p>



<a name="172958646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958646" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958646">(Aug 11 2019 at 07:43)</a>:</h4>
<p>can we just call it "find_accesses"? or "accesses"?</p>



<a name="172958649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958649" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958649">(Aug 11 2019 at 07:43)</a>:</h4>
<p>or "find_writes" idk</p>



<a name="172958692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958692" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958692">(Aug 11 2019 at 07:44)</a>:</h4>
<p>"find_writes" is fine with me.</p>



<a name="172958698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958698" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958698">(Aug 11 2019 at 07:45)</a>:</h4>
<p>("access" would include both reads and writes, not sure if that's what you're going for)</p>



<a name="172958744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958744" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958744">(Aug 11 2019 at 07:46)</a>:</h4>
<p>Totally unrelated, I have a branch which tried to split the propagation of qualifs between locals from the use of those qualifs into separate passes</p>



<a name="172958747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958747" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958747">(Aug 11 2019 at 07:46)</a>:</h4>
<p><a href="https://github.com/ecstatic-morse/rust/tree/qualifs" target="_blank" title="https://github.com/ecstatic-morse/rust/tree/qualifs">https://github.com/ecstatic-morse/rust/tree/qualifs</a></p>



<a name="172958755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958755" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958755">(Aug 11 2019 at 07:47)</a>:</h4>
<p>If you find yourself doing something similar, maybe it would be useful to look at?</p>



<a name="172958756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958756" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958756">(Aug 11 2019 at 07:47)</a>:</h4>
<p>thanks!</p>



<a name="172958759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958759" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958759">(Aug 11 2019 at 07:47)</a>:</h4>
<p>The end goal was to replace <code>QualifsPerLocal</code> with something based on dataflow (at least for <code>HasMutInterior</code> and <code>NeedsDrop</code>)</p>



<a name="172958799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958799" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958799">(Aug 11 2019 at 07:48)</a>:</h4>
<p>This was the least intrusive approach I could see</p>



<a name="172958801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958801" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958801">(Aug 11 2019 at 07:48)</a>:</h4>
<blockquote>
<p>error: internal compiler error: src/librustc_mir/interpret/intern.rs:183: const qualif failed to prevent mutable references</p>
</blockquote>



<a name="172958804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172958804" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172958804">(Aug 11 2019 at 07:48)</a>:</h4>
<p>I guess that's my confirmation and also assurance that even if we screw up, miri will catch us</p>



<a name="172960928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172960928" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172960928">(Aug 11 2019 at 09:00)</a>:</h4>
<blockquote>
<p>I guess that's my confirmation and also assurance that even if we screw up, miri will catch us</p>
</blockquote>
<p>well, sometimes. we started building that safety net with <span class="user-mention" data-user-id="124288">@oli</span> 's refactoring of interning.</p>



<a name="172960934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172960934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172960934">(Aug 11 2019 at 09:01)</a>:</h4>
<p>I am not sure yet if we catch <em>all</em> errors. but that is the goal.</p>



<a name="172960937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172960937" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172960937">(Aug 11 2019 at 09:01)</a>:</h4>
<p>this goes hand-in-hand with documenting in <a href="https://github.com/rust-rfcs/const-eval" target="_blank" title="https://github.com/rust-rfcs/const-eval">https://github.com/rust-rfcs/const-eval</a> what exactly <em>needs</em> to be checked</p>



<a name="172960940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172960940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172960940">(Aug 11 2019 at 09:01)</a>:</h4>
<p>help with that would be much appreciated, as UCG is taking up basically all of my Rust time these days</p>



<a name="172960988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172960988" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172960988">(Aug 11 2019 at 09:02)</a>:</h4>
<p>and please report a bug if you find something that miri does not catch :D</p>



<a name="172973302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172973302" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Regueiro <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172973302">(Aug 11 2019 at 15:45)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> I see. Thanks. Maybe worth another chat with him in that case... otherwise, a rearchitecting isn't necessarily a terrible thing.</p>



<a name="172977786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/172977786" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Regueiro <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#172977786">(Aug 11 2019 at 18:05)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie</span> I see. Thanks. Maybe worth another chat with him in that case... otherwise, a rearchitecting isn't necessarily a terrible thing.</p>
</blockquote>
<p>Oh gosh... I see I missed a long conversation between the two of you before I even replied hah. Good to see anyway.</p>



<a name="173033828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173033828" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173033828">(Aug 12 2019 at 15:33)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> feel free to ping me daily or so - I haven't gotten to it because I decided to look into fixing miri's substs situation</p>



<a name="173108408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173108408" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173108408">(Aug 13 2019 at 12:30)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> one down! <a href="https://github.com/rust-lang/rust/pull/63518" target="_blank" title="https://github.com/rust-lang/rust/pull/63518">https://github.com/rust-lang/rust/pull/63518</a></p>



<a name="173178360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173178360" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173178360">(Aug 14 2019 at 06:24)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> on no :( <a href="https://github.com/rust-lang/rust/pull/63518#issuecomment-521117822" target="_blank" title="https://github.com/rust-lang/rust/pull/63518#issuecomment-521117822">https://github.com/rust-lang/rust/pull/63518#issuecomment-521117822</a></p>



<a name="173179177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173179177" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173179177">(Aug 14 2019 at 06:44)</a>:</h4>
<p>Huh, idk what change caused this to become legal</p>



<a name="173179185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173179185" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173179185">(Aug 14 2019 at 06:44)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> it was always legal, I'm just dumb</p>



<a name="173179195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173179195" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173179195">(Aug 14 2019 at 06:45)</a>:</h4>
<p>moving out of a variable clears its NeedsDrop</p>



<a name="173179268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173179268" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173179268">(Aug 14 2019 at 06:46)</a>:</h4>
<p>and what's allowed on beta/nightly is reassigning locals</p>



<a name="173179288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173179288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173179288">(Aug 14 2019 at 06:47)</a>:</h4>
<p>Ah. Yea I remember a change there</p>



<a name="173188724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173188724" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173188724">(Aug 14 2019 at 09:43)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> I started on the second thing, I'm thinking I should do a crater run that ensures both strategies produce the same results</p>



<a name="173507207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173507207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173507207">(Aug 18 2019 at 23:52)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Sorry, I wasn't able to be at a computer for most of last week. I've been able to work on the refactor this weekend though.</p>



<a name="173507325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173507325" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173507325">(Aug 18 2019 at 23:56)</a>:</h4>
<p>I'll try to get my branch to a more easily understandable state and publish it ASAP so I can get your feedback.</p>



<a name="173829680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173829680" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173829680">(Aug 21 2019 at 20:33)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> okay I finally got around to doing it: <a href="https://github.com/rust-lang/rust/compare/master...eddyb:promo-sanity" target="_blank" title="https://github.com/rust-lang/rust/compare/master...eddyb:promo-sanity">https://github.com/rust-lang/rust/compare/master...eddyb:promo-sanity</a></p>



<a name="173829688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173829688" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173829688">(Aug 21 2019 at 20:33)</a>:</h4>
<p>gtg now but I will report tomorrow wiith test results</p>



<a name="173853588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173853588" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173853588">(Aug 22 2019 at 05:17)</a>:</h4>
<p>@eddyb Awesome. I'm almost done with my branch. I'll publish tomorrow morning. Sorry for the lack of coordination. I've been a bit busy.</p>



<a name="173899589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899589" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899589">(Aug 22 2019 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <a href="https://github.com/rust-lang/rust/compare/master...ecstatic-morse:qualifs-temp" target="_blank" title="https://github.com/rust-lang/rust/compare/master...ecstatic-morse:qualifs-temp">https://github.com/rust-lang/rust/compare/master...ecstatic-morse:qualifs-temp</a></p>



<a name="173899619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899619" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899619">(Aug 22 2019 at 16:51)</a>:</h4>
<p>So I ended up doing a custom dataflow implementation, not the use-def chain based one</p>



<a name="173899624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899624" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899624">(Aug 22 2019 at 16:51)</a>:</h4>
<p>heh, nice</p>



<a name="173899668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899668" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899668">(Aug 22 2019 at 16:52)</a>:</h4>
<p>wait, I didn't realize that</p>



<a name="173899682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899682" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899682">(Aug 22 2019 at 16:52)</a>:</h4>
<p>The reason was that I wanted to allow const-qualification to still run in the old, RPO mode</p>



<a name="173899702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899702" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899702">(Aug 22 2019 at 16:53)</a>:</h4>
<p>Since we don't actually need to have dataflow-based qualification for non-const fns</p>



<a name="173899720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899720" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899720">(Aug 22 2019 at 16:53)</a>:</h4>
<p>aaaah I see</p>



<a name="173899732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899732" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899732">(Aug 22 2019 at 16:53)</a>:</h4>
<p>And the use-def chain required implementing <code>Q::in_{operand,rvalue,...}</code> differently for each mode</p>



<a name="173899737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899737" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899737">(Aug 22 2019 at 16:53)</a>:</h4>
<p>right, and eventually we can rip out most of that and do it on-demand</p>



<a name="173899789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899789" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899789">(Aug 22 2019 at 16:54)</a>:</h4>
<p>Whereas with a custom dataflow impl, all the <code>Qualif</code> methods stay pretty much the same</p>



<a name="173899800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899800" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899800">(Aug 22 2019 at 16:54)</a>:</h4>
<p>while trying to share as much logic as possible (I went the other way, duplicating logic, for my initial test of the separate checker)</p>



<a name="173899823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899823" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899823">(Aug 22 2019 at 16:54)</a>:</h4>
<p>and I can just implement another <code>Resolver</code> that runs in the old mode</p>



<a name="173899855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899855" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899855">(Aug 22 2019 at 16:55)</a>:</h4>
<p>Yeah, so you're trying to separate promotion from qualification which I think is a good idea.</p>



<a name="173899935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899935" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899935">(Aug 22 2019 at 16:56)</a>:</h4>
<p>Promotion never actually needs to run in dataflow mode, because only temporaries with exactly one assignment are promotable</p>



<a name="173899967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899967" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899967">(Aug 22 2019 at 16:56)</a>:</h4>
<p>I kept running into confusing issues where if you have errors, promotion is limited one way or another</p>



<a name="173899982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173899982" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173899982">(Aug 22 2019 at 16:56)</a>:</h4>
<p>like min_const_fn will promote nothing if there are min_const_fn check errors</p>



<a name="173900012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900012" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900012">(Aug 22 2019 at 16:57)</a>:</h4>
<p>and then if you have non-trivial control-flow, the linear checker will just not see entire parts of it</p>



<a name="173900042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900042" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900042">(Aug 22 2019 at 16:58)</a>:</h4>
<p>like my promoter chose to promote this <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const-eval/issue-52475.rs#L10" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const-eval/issue-52475.rs#L10">https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const-eval/issue-52475.rs#L10</a></p>



<a name="173900152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900152">(Aug 22 2019 at 16:59)</a>:</h4>
<p>because, well, it can promote in anything just as well as it can promote in runtime functions</p>



<a name="173900177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900177" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900177">(Aug 22 2019 at 16:59)</a>:</h4>
<p>dataflow only needs to handle two bits, really, HasMutInterior and NeedsDrop</p>



<a name="173900201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900201" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900201">(Aug 22 2019 at 16:59)</a>:</h4>
<p>Hmm, can we not promote <code>&amp;0</code> there?</p>



<a name="173900228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900228" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900228">(Aug 22 2019 at 17:00)</a>:</h4>
<p><code>check_const</code> never looks at the body of the <code>while</code></p>



<a name="173900290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900290" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900290">(Aug 22 2019 at 17:00)</a>:</h4>
<p>so it never picks up promotion candidates from within</p>



<a name="173900351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900351" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900351">(Aug 22 2019 at 17:00)</a>:</h4>
<p>anyway this just means I need another special-case</p>



<a name="173900382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900382" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900382">(Aug 22 2019 at 17:01)</a>:</h4>
<p>Oh wow. that's because the body gets rejected by <code>min_const_fn</code></p>



<a name="173900386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900386" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900386">(Aug 22 2019 at 17:01)</a>:</h4>
<p>?</p>



<a name="173900423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900423" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900423">(Aug 22 2019 at 17:01)</a>:</h4>
<p>no, min_const_fn applies only to <code>const fn</code></p>



<a name="173900470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900470" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900470">(Aug 22 2019 at 17:02)</a>:</h4>
<p>this is an array length</p>



<a name="173900493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900493" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900493">(Aug 22 2019 at 17:02)</a>:</h4>
<p>Ah yes, duh</p>



<a name="173900554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900554" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900554">(Aug 22 2019 at 17:03)</a>:</h4>
<p>So I thought the const checking code does look at loop bodies</p>



<a name="173900586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900586" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900586">(Aug 22 2019 at 17:03)</a>:</h4>
<p>it gives up the moment it sees a branch, I guess if it were an infinite loop it would have seen the body :P</p>



<a name="173900596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900596" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900596">(Aug 22 2019 at 17:03)</a>:</h4>
<p>When it traverses basic blocks, if it sees one that was already visited (a back-edge in the CFG) it calls <code>non_const</code></p>



<a name="173900610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900610" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900610">(Aug 22 2019 at 17:04)</a>:</h4>
<p>this gets promoted btw <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const-eval/issue-52475.rs#L4" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const-eval/issue-52475.rs#L4">https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const-eval/issue-52475.rs#L4</a></p>



<a name="173900655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900655" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900655">(Aug 22 2019 at 17:04)</a>:</h4>
<p>Does the promotion logic give up as soon as it sees a branch</p>



<a name="173900659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900659" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900659">(Aug 22 2019 at 17:04)</a>:</h4>
<p>?</p>



<a name="173900665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900665">(Aug 22 2019 at 17:04)</a>:</h4>
<p>not just one that was visited. also note the None</p>



<a name="173900704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900704">(Aug 22 2019 at 17:04)</a>:</h4>
<p>it takes a linear path, so it gives up if there are multiple targets</p>



<a name="173900754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900754" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900754">(Aug 22 2019 at 17:05)</a>:</h4>
<p>wow Zulip is so laggy for me now</p>



<a name="173900887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900887" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900887">(Aug 22 2019 at 17:06)</a>:</h4>
<p>Oh, <code>SwitchInt</code> is <code>None</code> here</p>



<a name="173900923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900923" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900923">(Aug 22 2019 at 17:06)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/07ea2604075d6f896addce0e6949c7cf25dd3715/src/librustc_mir/transform/qualify_consts.rs#L323" target="_blank" title="https://github.com/rust-lang/rust/blob/07ea2604075d6f896addce0e6949c7cf25dd3715/src/librustc_mir/transform/qualify_consts.rs#L323">https://github.com/rust-lang/rust/blob/07ea2604075d6f896addce0e6949c7cf25dd3715/src/librustc_mir/transform/qualify_consts.rs#L323</a></p>



<a name="173900932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900932" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900932">(Aug 22 2019 at 17:06)</a>:</h4>
<p>I understand now</p>



<a name="173900963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173900963" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173900963">(Aug 22 2019 at 17:07)</a>:</h4>
<p>yeah all of these <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L950-L956" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L950-L956">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L950-L956</a></p>



<a name="173901112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173901112" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173901112">(Aug 22 2019 at 17:08)</a>:</h4>
<p>and, success!</p>



<a name="173901961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173901961" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173901961">(Aug 22 2019 at 17:17)</a>:</h4>
<p>So there's still a ton to do on my branch, I need to implement the <code>TempOnlyResolver</code>, then check to see that the cursor is actually observing the proper set of effects. Basically, because qualif propagation was intertwined with const checking in the original code, some of the checks may be run before e.g. the return place of a call is given qualifs and some may be run after.</p>



<a name="173902833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173902833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173902833">(Aug 22 2019 at 17:26)</a>:</h4>
<p>Separating the existing pass into three: qualif propagation, const checking, and promotion is I think a noble goal. Splitting up the latter two (which your PR does) makes validating the separation of "qualif propagation" a lot easier.</p>



<a name="173904190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/173904190" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#173904190">(Aug 22 2019 at 17:41)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> here it is, sorry for the delays <a href="https://github.com/rust-lang/rust/pull/63812" target="_blank" title="https://github.com/rust-lang/rust/pull/63812">https://github.com/rust-lang/rust/pull/63812</a></p>



<a name="174049005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174049005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174049005">(Aug 24 2019 at 18:13)</a>:</h4>
<p>So I opened <a href="https://github.com/rust-lang/rust/issues/63860" target="_blank" title="https://github.com/rust-lang/rust/issues/63860">#63860</a>, which contains a write-up of the changes in my branch. I'm working on splitting up <code>assign</code> in the current pass since its main purpose is obsoleted now that we don't actually propagate qualifs in <code>Checker</code>. I guess after implementing <code>TempOnlyResolver</code> I'll see if I can get the tests passing (the build/test cycle takes forever on my local machine, so I'll probably abuse CI for this).</p>



<a name="174187265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174187265" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174187265">(Aug 27 2019 at 00:30)</a>:</h4>
<p>The latest version of <a href="https://github.com/rust-lang/rust/issues/63860" target="_blank" title="https://github.com/rust-lang/rust/issues/63860">#63860</a> results in an index out of bounds ICE here: <a href="https://github.com/rust-lang/rust/blob/9b91b9c10e3c87ed333a1e34c4f46ed68f1eee06/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L427" target="_blank" title="https://github.com/rust-lang/rust/blob/9b91b9c10e3c87ed333a1e34c4f46ed68f1eee06/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L427">https://github.com/rust-lang/rust/blob/9b91b9c10e3c87ed333a1e34c4f46ed68f1eee06/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L427</a></p>



<a name="174187327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174187327" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174187327">(Aug 27 2019 at 00:32)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Do you have any idea how this would get triggered?</p>



<a name="174198879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174198879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174198879">(Aug 27 2019 at 05:56)</a>:</h4>
<p>That can only happen on broken mir</p>



<a name="174198893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174198893" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174198893">(Aug 27 2019 at 05:57)</a>:</h4>
<p>Maybe promotion does something only halfway?</p>



<a name="174199045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174199045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174199045">(Aug 27 2019 at 06:00)</a>:</h4>
<p>@oli like perhaps my PR is now incorrectly marking something for promotion something that the code that does promotion can't translate to a Body?</p>



<a name="174199054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174199054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174199054">(Aug 27 2019 at 06:01)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="174199430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174199430" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174199430">(Aug 27 2019 at 06:11)</a>:</h4>
<p>Sounds like it</p>



<a name="174199436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174199436" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174199436">(Aug 27 2019 at 06:11)</a>:</h4>
<p>What code is causing the ICE?</p>



<a name="174199598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174199598" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174199598">(Aug 27 2019 at 06:14)</a>:</h4>
<p>I don't have the error message in front of me now, but I'll have a look at it as well as the generated MIR tomorrow. Do you have any other tips for debugging promotion?</p>



<a name="174199619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174199619" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174199619">(Aug 27 2019 at 06:15)</a>:</h4>
<p>(the name of the function being processed appears in the query stack)</p>



<a name="174200954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174200954" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174200954">(Aug 27 2019 at 06:43)</a>:</h4>
<p>I believe we have some debug tracing in <a href="http://promote.rs" target="_blank" title="http://promote.rs">promote.rs</a></p>



<a name="174200964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174200964" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174200964">(Aug 27 2019 at 06:43)</a>:</h4>
<p>I can have a look at your PR later, maybe I'll see sth</p>



<a name="174243403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174243403" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174243403">(Aug 27 2019 at 16:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/5d20ff4d2718c820632b38c1e49d4de648a9810b/src/libcore/num/dec2flt/rawfp.rs#L260" target="_blank" title="https://github.com/rust-lang/rust/blob/5d20ff4d2718c820632b38c1e49d4de648a9810b/src/libcore/num/dec2flt/rawfp.rs#L260">https://github.com/rust-lang/rust/blob/5d20ff4d2718c820632b38c1e49d4de648a9810b/src/libcore/num/dec2flt/rawfp.rs#L260</a></p>



<a name="174243491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174243491" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174243491">(Aug 27 2019 at 16:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/0" target="_blank" title="https://github.com/rust-lang/rust/issues/0">#0</a> [mir_borrowck] processing <code>num::dec2flt::rawfp::round_normal</code></p>



<a name="174243612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174243612" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174243612">(Aug 27 2019 at 16:04)</a>:</h4>
<div class="codehilite"><pre><span></span>thread &#39;rustc&#39; panicked at &#39;index out of bounds: the len is 6 but the index is 7&#39;, /home/mackendy/src/rust/rust/src/libcore/slice/mod.rs:2715:10
stack backtrace:
   0: std::sys_common::backtrace::print
   1: std::panicking::default_hook::{{closure}}
   2: std::panicking::default_hook
   3: &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::Fn&lt;A&gt;&gt;::call
             at ./src/liballoc/boxed.rs:936
   4: rustc::util::common::panic_hook
             at src/librustc/util/common.rs:43
   5: std::panicking::rust_panic_with_hook
   6: std::panicking::continue_panic_fmt
   7: rust_begin_unwind
   8: core::panicking::panic_fmt
   9: core::panicking::panic_bounds_check
  10: rustc_mir::borrow_check::nll::type_check::TypeVerifier::sanitize_place::{{closure}}
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:0
  11: rustc::mir::Place::iterate_over::iterate_over2
             at ./src/librustc/mir/mod.rs:1932
  12: rustc::mir::visit::Visitor::super_rvalue
             at ./src/librustc/mir/visit.rs:0
  13: &lt;rustc_mir::borrow_check::nll::type_check::TypeVerifier as rustc::mir::visit::Visitor&gt;::visit_rvalue
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:332
  14: rustc::mir::visit::Visitor::super_assign
             at ./src/librustc/mir/visit.rs:410
  15: rustc::mir::visit::Visitor::visit_assign
             at ./src/librustc/mir/visit.rs:99
  16: rustc::mir::visit::Visitor::super_statement
             at ./src/librustc/mir/visit.rs:348
  17: rustc::mir::visit::Visitor::visit_statement
             at ./src/librustc/mir/visit.rs:92
  18: rustc::mir::visit::Visitor::super_basic_block_data
             at ./src/librustc/mir/visit.rs:315
  19: rustc::mir::visit::Visitor::visit_basic_block_data
             at ./src/librustc/mir/visit.rs:81
  20: rustc::mir::visit::Visitor::super_body
             at ./src/librustc/mir/visit.rs:273
  21: &lt;rustc_mir::borrow_check::nll::type_check::TypeVerifier as rustc::mir::visit::Visitor&gt;::visit_body
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:382
  22: rustc_mir::borrow_check::nll::type_check::TypeVerifier::sanitize_promoted
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:554
  23: rustc_mir::borrow_check::nll::type_check::TypeVerifier::sanitize_place::{{closure}}
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:458
  24: rustc::mir::Place::iterate_over::iterate_over2
             at ./src/librustc/mir/mod.rs:1932
  25: rustc::mir::visit::Visitor::super_rvalue
             at ./src/librustc/mir/visit.rs:0
  26: &lt;rustc_mir::borrow_check::nll::type_check::TypeVerifier as rustc::mir::visit::Visitor&gt;::visit_rvalue
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:332
  27: rustc::mir::visit::Visitor::super_assign
             at ./src/librustc/mir/visit.rs:410
  28: rustc::mir::visit::Visitor::visit_assign
             at ./src/librustc/mir/visit.rs:99
  29: rustc::mir::visit::Visitor::super_statement
             at ./src/librustc/mir/visit.rs:348
  30: rustc::mir::visit::Visitor::visit_statement
             at ./src/librustc/mir/visit.rs:92
  31: rustc::mir::visit::Visitor::super_basic_block_data
             at ./src/librustc/mir/visit.rs:315
  32: rustc::mir::visit::Visitor::visit_basic_block_data
             at ./src/librustc/mir/visit.rs:81
  33: rustc::mir::visit::Visitor::super_body
             at ./src/librustc/mir/visit.rs:273
  34: &lt;rustc_mir::borrow_check::nll::type_check::TypeVerifier as rustc::mir::visit::Visitor&gt;::visit_body
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:382
  35: rustc_mir::borrow_check::nll::type_check::type_check_internal
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:204
  36: rustc_mir::borrow_check::nll::type_check::type_check
             at src/librustc_mir/borrow_check/nll/type_check/mod.rs:156
  37: rustc_mir::borrow_check::nll::compute_regions
             at src/librustc_mir/borrow_check/nll/mod.rs:107
  38: rustc_mir::borrow_check::do_mir_borrowck
             at src/librustc_mir/borrow_check/mod.rs:187
  39: rustc_mir::borrow_check::mir_borrowck::{{closure}}
             at src/librustc_mir/borrow_check/mod.rs:96
  40: rustc::infer::InferCtxtBuilder::enter::{{closure}}
             at ./src/librustc/infer/mod.rs:522
  41: rustc::ty::context::GlobalCtxt::enter_local::{{closure}}::{{closure}}
             at ./src/librustc/ty/context.rs:1624
  42: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1847
  43: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1780
  44: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1846
  45: rustc::ty::context::GlobalCtxt::enter_local::{{closure}}
             at ./src/librustc/ty/context.rs:1623
  46: rustc::ty::context::tls::with_related_context::{{closure}}
             at ./src/librustc/ty/context.rs:1953
  47: rustc::ty::context::tls::with_context::{{closure}}
             at ./src/librustc/ty/context.rs:1936
  48: rustc::ty::context::tls::with_context_opt
             at ./src/librustc/ty/context.rs:1925
  49: rustc::ty::context::tls::with_context
             at ./src/librustc/ty/context.rs:1936
  50: rustc::ty::context::tls::with_related_context
             at ./src/librustc/ty/context.rs:1949
  51: rustc::ty::context::GlobalCtxt::enter_local
             at ./src/librustc/ty/context.rs:1615
  52: rustc::infer::InferCtxtBuilder::enter
             at ./src/librustc/infer/mod.rs:521
  53: rustc_mir::borrow_check::mir_borrowck
             at src/librustc_mir/borrow_check/mod.rs:93
  54: rustc::ty::query::&lt;impl rustc::ty::query::config::QueryAccessors for rustc::ty::query::queries::mir_borrowck&gt;::compute::{{closure}}
             at ./src/librustc/ty/query/plumbing.rs:999
  55: rustc::ty::query::__query_compute::mir_borrowck
             at ./src/librustc/ty/query/plumbing.rs:950
  56: rustc::ty::query::&lt;impl rustc::ty::query::config::QueryAccessors for rustc::ty::query::queries::mir_borrowck&gt;::compute
             at ./src/librustc/ty/query/plumbing.rs:991
  57: rustc::dep_graph::graph::DepGraph::with_task_impl::{{closure}}::{{closure}}
             at ./src/librustc/dep_graph/graph.rs:277
  58: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1847
  59: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1780
  60: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1846
  61: rustc::dep_graph::graph::DepGraph::with_task_impl::{{closure}}
             at ./src/librustc/dep_graph/graph.rs:276
  62: rustc::ty::context::tls::with_context::{{closure}}
             at ./src/librustc/ty/context.rs:1936
  63: rustc::ty::context::tls::with_context_opt
             at ./src/librustc/ty/context.rs:1925
  64: rustc::ty::context::tls::with_context
             at ./src/librustc/ty/context.rs:1936
  65: rustc::dep_graph::graph::DepGraph::with_task_impl
             at ./src/librustc/dep_graph/graph.rs:270
  66: rustc::dep_graph::graph::DepGraph::with_task
             at ./src/librustc/dep_graph/graph.rs:202
  67: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::force_query_with_job::{{closure}}::{{closure}}
             at ./src/librustc/ty/query/plumbing.rs:558
  68: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::start_query::{{closure}}::{{closure}}
             at ./src/librustc/ty/query/plumbing.rs:277
  69: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1847
  70: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1780
  71: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1846
  72: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::start_query::{{closure}}
             at ./src/librustc/ty/query/plumbing.rs:276
  73: rustc::ty::context::tls::with_related_context::{{closure}}
             at ./src/librustc/ty/context.rs:1953
  74: rustc::ty::context::tls::with_context::{{closure}}
             at ./src/librustc/ty/context.rs:1936
  75: rustc::ty::context::tls::with_context_opt
             at ./src/librustc/ty/context.rs:1925
  76: rustc::ty::context::tls::with_context
             at ./src/librustc/ty/context.rs:1936
  77: rustc::ty::context::tls::with_related_context
             at ./src/librustc/ty/context.rs:1949
  78: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::start_query
             at ./src/librustc/ty/query/plumbing.rs:265
  79: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::force_query_with_job::{{closure}}
             at ./src/librustc/ty/query/plumbing.rs:550
  80: rustc::ty::query::plumbing::with_diagnostics
             at ./src/librustc/ty/query/plumbing.rs:210
  81: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::force_query_with_job
             at ./src/librustc/ty/query/plumbing.rs:549
  82: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::get_query
             at ./src/librustc/ty/query/plumbing.rs:431
  83: rustc::ty::query::plumbing::&lt;impl rustc::ty::context::TyCtxt&gt;::ensure_query
             at ./src/librustc/ty/query/plumbing.rs:612
  84: rustc::ty::query::TyCtxtEnsure::mir_borrowck
             at ./src/librustc/ty/query/plumbing.rs:1027
  85: rustc_interface::passes::analysis::{{closure}}::{{closure}}
             at src/librustc_interface/passes.rs:957
  86: rustc::ty::&lt;impl rustc::ty::context::TyCtxt&gt;::par_body_owners::{{closure}}
             at ./src/librustc/ty/mod.rs:2771
  87: core::iter::traits::iterator::Iterator::for_each::call::{{closure}}
             at ./src/libcore/iter/traits/iterator.rs:613
  88: &lt;core::slice::Iter&lt;T&gt; as core::iter::traits::iterator::Iterator&gt;::fold
             at ./src/libcore/slice/mod.rs:3211
  89: core::iter::traits::iterator::Iterator::for_each
 ```
</pre></div>



<a name="174243825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174243825" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174243825">(Aug 27 2019 at 16:07)</a>:</h4>
<p>So there's the failing function body as well as a backtrace for good measure. Although there's no line number for the closure in `sanitize_place, I did verify what statement was failing</p>



<a name="174244064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174244064" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174244064">(Aug 27 2019 at 16:09)</a>:</h4>
<p>Surprisingly, replacing the body of that function with <code>unimplemented</code> allows all of <code>core</code> to compile.</p>



<a name="174244112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174244112" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174244112">(Aug 27 2019 at 16:09)</a>:</h4>
<p>Which implies that only that function triggers the problem.</p>



<a name="174248016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248016" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248016">(Aug 27 2019 at 16:54)</a>:</h4>
<p>I'm assuming that removing the assert_eq will pass, too</p>



<a name="174248047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248047" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248047">(Aug 27 2019 at 16:55)</a>:</h4>
<p>If so, you're somehow losing the argument marker for x.f</p>



<a name="174248383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248383" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248383">(Aug 27 2019 at 16:59)</a>:</h4>
<p>Yes, commenting out <code>assert_eq</code> works as well</p>



<a name="174248393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248393" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248393">(Aug 27 2019 at 16:59)</a>:</h4>
<p>Can you say more about argument markers <span class="user-mention" data-user-id="124288">@oli</span> ?</p>



<a name="174248695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248695">(Aug 27 2019 at 17:02)</a>:</h4>
<p>Do you mean that I'm trying to promote <code>x.f</code> even though it's a field of an argument?</p>



<a name="174248819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248819" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248819">(Aug 27 2019 at 17:04)</a>:</h4>
<p>btw, I figured out <code>-Zdump-mir=func_name</code> so I have the MIR after promotion.</p>



<a name="174248855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248855" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248855">(Aug 27 2019 at 17:05)</a>:</h4>
<div class="codehilite"><pre><span></span>        _63 = &amp;(promoted[0]: (&amp;&#39;static str, u32, u32)); // bb7[4]: scope 4 at src/libcore/macros.rs:19:38: 19:92
        _62 = &amp;(*_63);                   // bb7[5]: scope 4 at src/libcore/macros.rs:19:38: 19:92
        const panicking::panic_fmt(move _34, move _62) -&gt; bb1; // bb7[6]: scope 4 at src/libcore/macros.rs:18:9: 19:93
</pre></div>



<a name="174248968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174248968" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174248968">(Aug 27 2019 at 17:06)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> do you think you could breifly explain the <code>promoted[0]</code> syntax to me?</p>



<a name="174249018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174249018" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174249018">(Aug 27 2019 at 17:07)</a>:</h4>
<p>I'm guessing <code>promoted[0]</code> refers to the newly created <code>mir::Body</code> that computes the promoted value.</p>



<a name="174249044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174249044" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174249044">(Aug 27 2019 at 17:07)</a>:</h4>
<p>And <code>(&amp;'static str, u32, u32)</code> is the return type of that <code>mir::Body</code>?</p>



<a name="174249508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174249508" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174249508">(Aug 27 2019 at 17:12)</a>:</h4>
<p>There's two promoteds, one holds a <code>[&str; 3]</code> with some strings for assert, and this one holds the filename, line number, and column number.</p>



<a name="174250219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174250219" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174250219">(Aug 27 2019 at 17:21)</a>:</h4>
<p>The second <code>promoted</code> seems like it has almost the right number of locals to cause <code>index is 7, len is 6</code></p>



<a name="174250233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174250233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174250233">(Aug 27 2019 at 17:21)</a>:</h4>
<div class="codehilite"><pre><span></span>promoted[1] in  num::dec2flt::rawfp::round_normal: [&amp;str; 3] = {
    let mut _0: [&amp;str; 3];               // return place in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _1: [&amp;str; 3];               // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _2: &amp;str;                    // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _3: &amp;&#39;static str;            // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _4: &amp;str;                    // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _5: &amp;&#39;static str;            // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _6: &amp;str;                    // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _7: &amp;&#39;static str;            // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    scope 1 {
        scope 2 {
            scope 3 {
                scope 4 {
                    scope 5 {
                    }
                }
                scope 6 {
                }
            }
        }
    }

    bb0: {
        _3 = const &quot;assertion failed: `(left == right)`\n  left: `&quot;; // bb0[0]: scope 0 at src/libcore/macros.rs:53:28: 55:17
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [97, 115, 115, 101, 114, 116, 105, 111, 110, 32, 102, 97, 105, 108, 101, 100, 58, 32, 96, 40, 108, 101, 102, 116, 32, 61, 61, 32, 114, 105, 103, 104, 116, 41, 96, 10, 32, 32, 108, 101, 102, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [35184372088831], len: Size { raw: 45 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 45 }
                                         // mir::Constant
                                         // + span: src/libcore/macros.rs:53:28: 55:17
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [97, 115, 115, 101, 114, 116, 105, 111, 110, 32, 102, 97, 105, 108, 101, 100, 58, 32, 96, 40, 108, 101, 102, 116, 32, 61, 61, 32, 114, 105, 103, 104, 116, 41, 96, 10, 32, 32, 108, 101, 102, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [35184372088831], len: Size { raw: 45 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 45 } }
        _2 = &amp;(*_3);                     // bb0[1]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _5 = const &quot;`,\n right: `&quot;;      // bb0[2]: scope 0 at src/libcore/macros.rs:53:28: 55:17
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [96, 44, 10, 32, 114, 105, 103, 104, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [4095], len: Size { raw: 12 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 12 }
                                         // mir::Constant
                                         // + span: src/libcore/macros.rs:53:28: 55:17
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [96, 44, 10, 32, 114, 105, 103, 104, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [4095], len: Size { raw: 12 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 12 } }
        _4 = &amp;(*_5);                     // bb0[3]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _7 = const &quot;`&quot;;                  // bb0[4]: scope 0 at src/libcore/macros.rs:53:28: 55:17
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [1], len: Size { raw: 1 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 1 }
                                         // mir::Constant
                                         // + span: src/libcore/macros.rs:53:28: 55:17
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [1], len: Size { raw: 1 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 1 } }
        _6 = &amp;(*_7);                     // bb0[5]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _1 = [move _2, move _4, move _6]; // bb0[6]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _0 = move _1;                    // bb0[7]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        return;                          // bb0[8]: scope 0 at src/libcore/macros.rs:53:28: 55:17
    }
}
</pre></div>



<a name="174250331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174250331" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174250331">(Aug 27 2019 at 17:22)</a>:</h4>
<p>Maybe something happens in a later pass?</p>



<a name="174250870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174250870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174250870">(Aug 27 2019 at 17:29)</a>:</h4>
<p>Also, after commenting out that line, building continues on to stage 1 std artifacts (the previous failure in core was from stage 0 std artifacts???) and fails on <code>ptr::&lt;impl cmp::Ord for *const T&gt;::cmp</code></p>



<a name="174251028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174251028" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174251028">(Aug 27 2019 at 17:30)</a>:</h4>
<p>I believe that is here <a href="https://github.com/rust-lang/rust/blob/0396aace27eea97c3603e9683e921807dff2a314/src/libcore/ptr/mod.rs#L2885" target="_blank" title="https://github.com/rust-lang/rust/blob/0396aace27eea97c3603e9683e921807dff2a314/src/libcore/ptr/mod.rs#L2885">https://github.com/rust-lang/rust/blob/0396aace27eea97c3603e9683e921807dff2a314/src/libcore/ptr/mod.rs#L2885</a></p>



<a name="174253588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174253588" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174253588">(Aug 27 2019 at 18:01)</a>:</h4>
<p>No later pass removes a local AFAICT. I think I'll need more guidance to debug this.</p>



<a name="174256054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174256054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174256054">(Aug 27 2019 at 18:29)</a>:</h4>
<p>this wouldnt have anything to do with the ICE I noted at <a href="https://github.com/rust-lang/rust/pull/63580#issuecomment-525164084" target="_blank" title="https://github.com/rust-lang/rust/pull/63580#issuecomment-525164084">https://github.com/rust-lang/rust/pull/63580#issuecomment-525164084</a>, would it?</p>



<a name="174256378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174256378" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174256378">(Aug 27 2019 at 18:32)</a>:</h4>
<p>I think that ICE is occurring because we're running the <code>Inliner</code> optimization pass. I need to investigate more though...</p>



<a name="174257004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174257004" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174257004">(Aug 27 2019 at 18:39)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span>  Seems plausible. I can revert that PR and see if it helps</p>



<a name="174266105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174266105" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174266105">(Aug 27 2019 at 20:07)</a>:</h4>
<p>We don't run mir opts on libcore I think</p>



<a name="174266745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174266745" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174266745">(Aug 27 2019 at 20:13)</a>:</h4>
<p>Do you still have the mir of promoted 0 at hand?</p>



<a name="174268424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174268424" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174268424">(Aug 27 2019 at 20:29)</a>:</h4>
<p>@oli I don't, and I'm having trouble getting <code>x.py</code> to resume from the right place.</p>



<a name="174268492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174268492" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174268492">(Aug 27 2019 at 20:30)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Is there something specific you're looking for?</p>



<a name="174313743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174313743" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174313743">(Aug 27 2019 at 21:59)</a>:</h4>
<div class="codehilite"><pre><span></span>// MIR for `num::dec2flt::rawfp::round_normal`
// source = MirSource { instance: Item(DefId(0:519 ~ core[b842]::num[0]::dec2flt[0]::rawfp[0]::round_normal[0])), promoted: Some(promoted[0]) }
// pass_name = QualifyAndPromoteConstants
// disambiguator = after

promoted[0] in  num::dec2flt::rawfp::round_normal: (&amp;&#39;static str, u32, u32) = {
    let mut _0: (&amp;&#39;static str, u32, u32); // return place in scope 0 at src/libcore/macros.rs:19:38: 19:92
    let mut _1: (&amp;&#39;static str, u32, u32); // in scope 0 at src/libcore/macros.rs:19:39: 19:92
    scope 1 {
        scope 2 {
            scope 3 {
                scope 4 {
                    scope 5 {
                    }
                }
                scope 6 {
                }
            }
        }
    }

    bb0: {
        _1 = (const &quot;src/libcore/num/dec2flt/rawfp.rs&quot;, const 264u32, const 5u32); // bb0[0]: scope 0 at src/libcore/macros.rs:19:39: 19:92
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [115, 114, 99, 47, 108, 105, 98, 99, 111, 114, 101, 47, 110, 117, 109, 47, 100, 101, 99, 50, 102, 108, 116, 47, 114, 97, 119, 102, 112, 46, 114, 115], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [4294967295], len: Size { raw: 32 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 32 }
                                         // mir::Constant
                                         // + span: src/libcore/num/dec2flt/rawfp.rs:264:5: 264:40
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [115, 114, 99, 47, 108, 105, 98, 99, 111, 114, 101, 47, 110, 117, 109, 47, 100, 101, 99, 50, 102, 108, 116, 47, 114, 97, 119, 102, 112, 46, 114, 115], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [4294967295], len: Size { raw: 32 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 32 } }
                                         // ty::Const
                                         // + ty: u32
                                         // + val: Scalar(0x00000108)
                                         // mir::Constant
                                         // + span: src/libcore/num/dec2flt/rawfp.rs:264:5: 264:40
                                         // + ty: u32
                                         // + literal: Const { ty: u32, val: Scalar(0x00000108) }
                                         // ty::Const
                                         // + ty: u32
                                         // + val: Scalar(0x00000005)
                                         // mir::Constant
                                         // + span: src/libcore/num/dec2flt/rawfp.rs:264:5: 264:40
                                         // + ty: u32
                                         // + literal: Const { ty: u32, val: Scalar(0x00000005) }
        _0 = move _1;                    // bb0[1]: scope 0 at src/libcore/macros.rs:19:38: 19:92
        return;                          // bb0[2]: scope 0 at src/libcore/macros.rs:19:38: 19:92
    }
}
</pre></div>



<a name="174313794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174313794" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174313794">(Aug 27 2019 at 22:00)</a>:</h4>
<div class="codehilite"><pre><span></span>// MIR for `num::dec2flt::rawfp::round_normal`
// source = MirSource { instance: Item(DefId(0:519 ~ core[b842]::num[0]::dec2flt[0]::rawfp[0]::round_normal[0])), promoted: Some(promoted[1]) }
// pass_name = QualifyAndPromoteConstants
// disambiguator = after

promoted[1] in  num::dec2flt::rawfp::round_normal: [&amp;str; 3] = {
    let mut _0: [&amp;str; 3];               // return place in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _1: [&amp;str; 3];               // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _2: &amp;str;                    // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _3: &amp;&#39;static str;            // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _4: &amp;str;                    // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _5: &amp;&#39;static str;            // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _6: &amp;str;                    // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    let mut _7: &amp;&#39;static str;            // in scope 0 at src/libcore/macros.rs:53:28: 55:17
    scope 1 {
        scope 2 {
            scope 3 {
                scope 4 {
                    scope 5 {
                    }
                }
                scope 6 {
                }
            }
        }
    }

    bb0: {
        _3 = const &quot;assertion failed: `(left == right)`\n  left: `&quot;; // bb0[0]: scope 0 at src/libcore/macros.rs:53:28: 55:17
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [97, 115, 115, 101, 114, 116, 105, 111, 110, 32, 102, 97, 105, 108, 101, 100, 58, 32, 96, 40, 108, 101, 102, 116, 32, 61, 61, 32, 114, 105, 103, 104, 116, 41, 96, 10, 32, 32, 108, 101, 102, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [35184372088831], len: Size { raw: 45 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 45 }
                                         // mir::Constant
                                         // + span: src/libcore/macros.rs:53:28: 55:17
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [97, 115, 115, 101, 114, 116, 105, 111, 110, 32, 102, 97, 105, 108, 101, 100, 58, 32, 96, 40, 108, 101, 102, 116, 32, 61, 61, 32, 114, 105, 103, 104, 116, 41, 96, 10, 32, 32, 108, 101, 102, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [35184372088831], len: Size { raw: 45 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 45 } }
        _2 = &amp;(*_3);                     // bb0[1]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _5 = const &quot;`,\n right: `&quot;;      // bb0[2]: scope 0 at src/libcore/macros.rs:53:28: 55:17
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [96, 44, 10, 32, 114, 105, 103, 104, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [4095], len: Size { raw: 12 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 12 }
                                         // mir::Constant
                                         // + span: src/libcore/macros.rs:53:28: 55:17
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [96, 44, 10, 32, 114, 105, 103, 104, 116, 58, 32, 96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [4095], len: Size { raw: 12 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 12 } }
        _4 = &amp;(*_5);                     // bb0[3]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _7 = const &quot;`&quot;;                  // bb0[4]: scope 0 at src/libcore/macros.rs:53:28: 55:17
                                         // ty::Const
                                         // + ty: &amp;&#39;static str
                                         // + val: Slice { data: Allocation { bytes: [96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [1], len: Size { raw: 1 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 1 }
                                         // mir::Constant
                                         // + span: src/libcore/macros.rs:53:28: 55:17
                                         // + ty: &amp;&#39;static str
                                         // + literal: Const { ty: &amp;&#39;static str, val: Slice { data: Allocation { bytes: [96], relocations: Relocations(SortedMap { data: [] }), undef_mask: UndefMask { blocks: [1], len: Size { raw: 1 } }, align: Align { pow2: 0 }, mutability: Immutable, extra: () }, start: 0, end: 1 } }
        _6 = &amp;(*_7);                     // bb0[5]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _1 = [move _2, move _4, move _6]; // bb0[6]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        _0 = move _1;                    // bb0[7]: scope 0 at src/libcore/macros.rs:53:28: 55:17
        return;                          // bb0[8]: scope 0 at src/libcore/macros.rs:53:28: 55:17
    }
}
</pre></div>



<a name="174313809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174313809" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174313809">(Aug 27 2019 at 22:01)</a>:</h4>
<p>This is right after promotion</p>



<a name="174318233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174318233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174318233">(Aug 27 2019 at 23:15)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> I have the mir dumps from all passes again, let me know what you want me to look for. I didn't see anything super obvious</p>



<a name="174321537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174321537" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174321537">(Aug 28 2019 at 00:17)</a>:</h4>
<p>Same error occurs with Wesley Wiser's PR reverted</p>



<a name="174337127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174337127" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174337127">(Aug 28 2019 at 06:43)</a>:</h4>
<p>this is super odd. if the len is 6, that means the max index is 5, so it can't be promoted[1]</p>



<a name="174337171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174337171" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174337171">(Aug 28 2019 at 06:44)</a>:</h4>
<p>how many locals does the mir::Body of the function itself have?</p>



<a name="174337177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174337177" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174337177">(Aug 28 2019 at 06:44)</a>:</h4>
<p>maybe we're not inside a promoted?</p>



<a name="174348513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174348513" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174348513">(Aug 28 2019 at 10:05)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> it would be a good idea to compare the two computation methods and ensure they always agree, like I do in my PR</p>



<a name="174372250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174372250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174372250">(Aug 28 2019 at 15:14)</a>:</h4>
<p>(deleted)</p>



<a name="174372278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174372278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174372278">(Aug 28 2019 at 15:14)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> about 60 XD</p>



<a name="174372295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174372295" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174372295">(Aug 28 2019 at 15:14)</a>:</h4>
<p>oh</p>



<a name="174372296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174372296" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174372296">(Aug 28 2019 at 15:15)</a>:</h4>
<p>nevermind then</p>



<a name="174372311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174372311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174372311">(Aug 28 2019 at 15:15)</a>:</h4>
<p>no clue what's going on, this is very odd</p>



<a name="174375891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174375891" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174375891">(Aug 28 2019 at 15:50)</a>:</h4>
<p>Okay, I'm gonna have a go at compare mode</p>



<a name="174375969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174375969" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174375969">(Aug 28 2019 at 15:51)</a>:</h4>
<p>It will take some time though, so if you have ideas in the meantime I'm all ears</p>



<a name="174377220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174377220" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174377220">(Aug 28 2019 at 16:03)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> FWIW I meant <em>just</em> for the <code>promotion_candidates</code> list</p>



<a name="174377794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174377794" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174377794">(Aug 28 2019 at 16:10)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I was planning on putting the old code into a module and calling old::Checker::check_const, then comparing the output</p>



<a name="174377812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174377812" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174377812">(Aug 28 2019 at 16:10)</a>:</h4>
<p>This is about what you had in mind?</p>



<a name="174377830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174377830" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174377830">(Aug 28 2019 at 16:10)</a>:</h4>
<p>I guess? I'm not sure how involved your changes are</p>



<a name="174378064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174378064" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174378064">(Aug 28 2019 at 16:13)</a>:</h4>
<p>I guess I could try to run them as part of the same code path</p>



<a name="174378087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174378087" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174378087">(Aug 28 2019 at 16:13)</a>:</h4>
<p>The whole hog approach might be quicker, I'll take a look today</p>



<a name="174513117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174513117" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174513117">(Aug 30 2019 at 03:45)</a>:</h4>
<p>I've implemented a compare mode. It appears that promotion qualifs are not being properly detected when there's a <code>Deref</code> involved. I'll look into the underlying causes tomorrow.</p>



<a name="174571403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174571403" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174571403">(Aug 30 2019 at 18:37)</a>:</h4>
<p>It turned out to be  a simple bug: I wasn't initializing the dataflow state for the start block properly. As a result, I believe I was trying to promote some temporaries whose value came from an argument. I thought I would have seen this in the dumped MIR however (perhaps I was looking at stale output?). I'll make sure to check timestamps in the future.</p>



<a name="174571525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174571525" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174571525">(Aug 30 2019 at 18:38)</a>:</h4>
<p>The dataflow-based code is still missing some candidates for promotion however. It appears to be static slices in complex CFGs. I'll keep debugging.</p>



<a name="174578391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174578391" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174578391">(Aug 30 2019 at 20:06)</a>:</h4>
<p>I've figured out the source of the missed promotions.</p>



<a name="174578562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174578562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174578562">(Aug 30 2019 at 20:09)</a>:</h4>
<p>The flow-sensitive qualification code checks to see if the address of a local has been observed at a given program point. Temporary slices in loops will always have their address observed at the definition site (is this clear?). The flow-sensitive code is very conservative, and if it sees a pointer write or a function call, it assumes that any local whose address is observable may have been mutated, and thus may now contain any qualif.</p>



<a name="174578687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174578687" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174578687">(Aug 30 2019 at 20:10)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/ecca4b8c4bea678615175e1673ffcb647a94eb4a/src/libsyntax/attr/builtin.rs#L371" target="_blank" title="https://github.com/rust-lang/rust/blob/ecca4b8c4bea678615175e1673ffcb647a94eb4a/src/libsyntax/attr/builtin.rs#L371">https://github.com/rust-lang/rust/blob/ecca4b8c4bea678615175e1673ffcb647a94eb4a/src/libsyntax/attr/builtin.rs#L371</a></p>



<a name="174579319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174579319" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174579319">(Aug 30 2019 at 20:19)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Since we know that the type <code>&amp;[&amp;str]</code> is always <code>Freeze</code>, we can assume that indirect writes don't mutate it. And a temporary like the RHS of <code>let x: &amp;'static [Cell&lt;u32&gt;] = &amp;[]</code> is not promotable anyway since it <code>HasInteriorMut</code>. Is this correct?</p>



<a name="174579728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174579728" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174579728">(Aug 30 2019 at 20:25)</a>:</h4>
<p>If so, I guess we need to track whether a local has been mutably borrowed, or has been borrowed and is not <code>Freeze</code>.</p>



<a name="174584659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174584659" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174584659">(Aug 30 2019 at 21:38)</a>:</h4>
<p>iirc we even promote <code>&amp;mut []</code>, but that may just be inside static mut</p>



<a name="174584819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174584819" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174584819">(Aug 30 2019 at 21:41)</a>:</h4>
<p>But in general: this is awesome news!</p>



<a name="174585052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174585052" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174585052">(Aug 30 2019 at 21:44)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span>  <code>&amp;mut []</code> is indeed promoted in non-const <code>fn</code>s. We'll need to figure out a way to justify this inside CFGs with back-edges to be backwards compatible.</p>



<a name="174585166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174585166" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174585166">(Aug 30 2019 at 21:46)</a>:</h4>
<p>Perhaps the answer is to wait for <span class="user-mention" data-user-id="119009">@eddyb</span> s PR to get merged that separates promotion and const-qualification entirely</p>



<a name="174585225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174585225" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174585225">(Aug 30 2019 at 21:47)</a>:</h4>
<p>I'm also running flow-based qualification for <code>IsNotPromotable</code> and <code>IsNotImplicitlyPromotable</code>, which is not necessary, so implementing a linear <code>TempOnlyQualifier</code> that preserves the current behavior could make this go away.</p>



<a name="174586028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174586028" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174586028">(Aug 30 2019 at 21:59)</a>:</h4>
<p>The tests should be running on CI now. Hopefully we see some regressions since <code>HasMutInterior</code> is no longer replaced with <code>IsNotPromotable</code></p>



<a name="174604143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174604143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174604143">(Aug 31 2019 at 06:10)</a>:</h4>
<p>There's 18 failing tests, reflecting about 4-5 bugs in my PR. I'm going to fix the trivial ones, then implement<code>TempOnlyQualifier</code>.</p>



<a name="174604257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174604257" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174604257">(Aug 31 2019 at 06:15)</a>:</h4>
<p>I think the failure in <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const_arg_promotable.rs" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const_arg_promotable.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/const_arg_promotable.rs</a> may be caused because we no longer swap <code>HasMutInterior</code> for <code>IsNotPromotable</code>. I don't know this for sure though. It's pretty easy to fix this particular case: simply check for <code>HasMutInterior</code> as well as <code>IsNotPromotable</code> when making sure args are promotable, but I suspect there's a deeper reason to exchange those two qualifs.</p>



<a name="174606024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174606024" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174606024">(Aug 31 2019 at 07:09)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> btw, since you are working on const-qualif, your input on <a href="https://github.com/rust-rfcs/const-eval/pull/27" target="_blank" title="https://github.com/rust-rfcs/const-eval/pull/27">https://github.com/rust-rfcs/const-eval/pull/27</a> (and on the information in that repo in general) would be much appreciated :)</p>



<a name="174606073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174606073" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174606073">(Aug 31 2019 at 07:10)</a>:</h4>
<p>if there's things you learned that you think the next person working on const qualif should be able to just read somewhere, please add them there</p>



<a name="174606505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174606505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174606505">(Aug 31 2019 at 07:24)</a>:</h4>
<p>(<span class="user-mention" data-user-id="120791">@RalfJ</span> in case you don’t know, dylan is ecstatic-morse; just mentioning this as they’ve already commented on that PR)</p>



<a name="174609479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174609479" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174609479">(Aug 31 2019 at 09:03)</a>:</h4>
<p>(I did not know that, thanks!)</p>



<a name="174615884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174615884" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174615884">(Aug 31 2019 at 12:31)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie</span> yeaaaaaah crater takes forever though</p>



<a name="174639091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174639091" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174639091">(Sep 01 2019 at 00:28)</a>:</h4>
<p>I changed my Zulip name to be consistent with my github. Someday I'll go full name everywhere, but not today XD</p>



<a name="174639101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174639101" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174639101">(Sep 01 2019 at 00:29)</a>:</h4>
<p>I won't have a lot of time over the weekend to work on this, so expect some more progress on Tuesday</p>



<a name="174843914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174843914" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174843914">(Sep 04 2019 at 01:22)</a>:</h4>
<p>After fixing some minor bugs, CI is now green for <a href="https://github.com/rust-lang/rust/issues/63860" target="_blank" title="https://github.com/rust-lang/rust/issues/63860">#63860</a>. This version of the PR still includes my hack to enable <code>&amp;mut []</code> promotion within loops (I'm currently trying to devise a test which demonstrates its unsoundness), which can be removed once I stop using a  flow-sensitive for promotion and go back to the temp-only one. I'll post an update here once that is implemented</p>



<a name="174917130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174917130" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174917130">(Sep 04 2019 at 19:59)</a>:</h4>
<p>Okay, so the latest commit on <a href="https://github.com/rust-lang/rust/issues/63860" target="_blank" title="https://github.com/rust-lang/rust/issues/63860">#63860</a> contains a <code>TempOnlyResolver</code> that doesn't use dataflow, but instead applies the transfer function which underlies the dataflow analysis (expressed in <code>QualifPropagator</code>) linearly, similar to how the existing qualification scheme works.</p>



<a name="174917276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174917276" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174917276">(Sep 04 2019 at 20:00)</a>:</h4>
<p>I've also removed the hack that enabled <code>&amp;mut []</code>, and CI is still passing, so any lingering soundness holes are unknown to me.</p>



<a name="174917364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174917364" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174917364">(Sep 04 2019 at 20:01)</a>:</h4>
<p>The latest version of this PR leaves intact the existing mutation of qualifs, and uses the <code>compare</code> function to log when their results differ from the new <code>Resolver</code>-based ones.</p>



<a name="174917435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174917435" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174917435">(Sep 04 2019 at 20:01)</a>:</h4>
<p>However, only the <code>Resolver</code> based ones are actually used</p>



<a name="174917577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174917577" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174917577">(Sep 04 2019 at 20:03)</a>:</h4>
<p>There are occasionally different results, but any difference I observe now is benign (usually a type being <code>IsNotImplicitlyPromotable</code> in addition to <code>IsNotPromotable</code>)</p>



<a name="174917748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174917748" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174917748">(Sep 04 2019 at 20:05)</a>:</h4>
<p>It looks like no <code>rustc</code> tests fail due to the absence of the <code>HasMutInterior -&gt; IsNotPromotable</code> replacement. I still have no idea what form a test case for this would take.</p>



<a name="174925028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/174925028" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#174925028">(Sep 04 2019 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> So I think we should have a sync discussion about the next steps here. There's a way to implement <code>if</code> and (eventually) <code>loop</code> in const contexts with minimal changes.Basically, we continue running the old-style propagation logic but overriding it with the results from the <code>FlowSensitiveResolver</code> if we're in a <code>const</code> context. I'm a bit worried about this, because it will exercise new, untested code paths in the existing checker now by traversing the entire <code>mir::Body</code> instead of stopping at <code>SwitchInt</code>. </p>
<p>Alternatively, we could also work towards a greenfield system that separates promotion and const-checking. I envision something roughly like this:<br>
- Compute the dataflow results for <code>HasMutInterior</code> and <code>NeedsDrop</code> (if in a const context).<br>
- Visit the <code>mir::Body</code> looking for violations of const safety (if in a const context). This pass would be much simpler than the existing const checking logic because it is no longer stateful: it doesn't need to keep track of promotable values and can simply use the dataflow cursor when it needs to query for <code>HasMutInterior</code> and <code>NeedsDrop</code>. The end-goal would be to unify this with the logic in <code>qualify_min_const_fn</code>.<br>
- Compute the structural promotability of temps. This is the logic in <code>promote_consts</code> where we count the number of definitions of each temporary to see if they are eligible for promotion.<br>
- Promote temps.  If we are running in a const context, we can reuse dataflow results for <code>HasMutInterior</code> and <code>NeedsDrop</code>. Otherwise, we'll need to compute them on-demand using <code>TempOnlyResolver</code>. Then we propagate <code>IsNotPromotable</code> and <code>IsNotImplicitlyPromotable</code>, also using <code>TempOnlyResolver</code>.<br>
- Finally, validate the arguments passed to functions with <code>#[rustc_args_required_const(...)]</code>. This could maybe be folded into the previous step.</p>
<p>Most of the work here would be in separating const-checking and promotion logic. You've already done some of this in <a href="https://github.com/rust-lang/rust/issues/63812" target="_blank" title="https://github.com/rust-lang/rust/issues/63812">#63812</a>. We could run the newly separated pass in a compare-mode with the old one until we are happy with its correctness.</p>



<a name="175720067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175720067" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175720067">(Sep 14 2019 at 21:59)</a>:</h4>
<p>I implemented this in <a href="https://github.com/rust-lang/rust/issues/64470" target="_blank" title="https://github.com/rust-lang/rust/issues/64470">#64470</a></p>



<a name="175720068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175720068" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175720068">(Sep 14 2019 at 21:59)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> ^</p>



<a name="175771327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175771327" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175771327">(Sep 15 2019 at 23:23)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="120791">@RalfJ</span> <span class="user-mention" data-user-id="119009">@eddyb</span> I switched to a more conservative analysis for doing qualification in the presence of indirect writes (<code>*p = x</code>) that is closer to the pre-dataflow approach. However, it's kind of hacky as I explain in the most recent comment on <a href="https://github.com/rust-lang/rust/issues/64470" target="_blank" title="https://github.com/rust-lang/rust/issues/64470">#64470</a>. Perhaps you'd like to weigh in on what we should do here long term to enable mutable borrows?</p>



<a name="175783969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175783969" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175783969">(Sep 16 2019 at 05:18)</a>:</h4>
<p>ugh I'm going to lose my notifications if I jump right in here</p>



<a name="175783972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175783972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175783972">(Sep 16 2019 at 05:18)</a>:</h4>
<p>I can't spend too much time on this until the crater run finishes (I wish I never bothered with crater, it's so bad nowadays...)</p>



<a name="175783987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175783987" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175783987">(Sep 16 2019 at 05:19)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> but, what I think is that a non-frozen borrow should assume the worst about the contents of the local being borrowed</p>



<a name="175783997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175783997" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175783997">(Sep 16 2019 at 05:19)</a>:</h4>
<p>that is, indirect writes can be ignored because they <em>can't make it worse</em> than what the borrow already assumed</p>



<a name="175784066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784066" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784066">(Sep 16 2019 at 05:21)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Specifically, how do you want to handle <code>const fn ident&lt;T&gt;(x: T) -&gt; T { x }</code>?</p>



<a name="175784074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784074" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784074">(Sep 16 2019 at 05:21)</a>:</h4>
<p><code>x</code> has to have <code>HasMutInterior</code></p>



<a name="175784139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784139" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784139">(Sep 16 2019 at 05:23)</a>:</h4>
<p>One way is to separate "can be mutated through a reference" from "is not <code>Freeze</code>".</p>



<a name="175784146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784146" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784146">(Sep 16 2019 at 05:23)</a>:</h4>
<p>(right now const validation uses <code>HasMutInterior</code> for both)</p>



<a name="175784334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784334" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784334">(Sep 16 2019 at 05:29)</a>:</h4>
<p>Anyways, I'll ping you once your crater run is done</p>



<a name="175784388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784388" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784388">(Sep 16 2019 at 05:30)</a>:</h4>
<p>hey, sorry to bother you? but what are you working on? I've been seeing the notifications for a couple weeks and I've grown curious about this :P</p>



<a name="175784470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784470" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784470">(Sep 16 2019 at 05:32)</a>:</h4>
<p><span class="user-mention" data-user-id="132916">@Christian Poveda</span> The first comment on  <a href="https://github.com/rust-lang/rust/issues/63860" target="_blank" title="https://github.com/rust-lang/rust/issues/63860">#63860</a> gives some background</p>



<a name="175784536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784536" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784536">(Sep 16 2019 at 05:34)</a>:</h4>
<p>Ohh ok thanks!</p>



<a name="175784604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784604" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784604">(Sep 16 2019 at 05:36)</a>:</h4>
<p>I don't understand why that function is interesting at all</p>



<a name="175784606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784606" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784606">(Sep 16 2019 at 05:36)</a>:</h4>
<p>it's just <code>_0 = _1</code></p>



<a name="175784635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784635" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784635">(Sep 16 2019 at 05:37)</a>:</h4>
<blockquote>
<p><code>x</code> has to have <code>HasMutInterior</code></p>
</blockquote>
<p>yes... and?</p>



<a name="175784645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784645" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784645">(Sep 16 2019 at 05:37)</a>:</h4>
<p>if you take a reference to it, <em>it could be used to mutate <code>x</code></em></p>



<a name="175784657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784657" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784657">(Sep 16 2019 at 05:38)</a>:</h4>
<blockquote>
<p>One way is to separate "can be mutated through a reference" from "is not <code>Freeze</code>".</p>
</blockquote>
<p>they... are the same thing tho</p>



<a name="175784716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784716">(Sep 16 2019 at 05:39)</a>:</h4>
<p>I really don't know why the identity function is significant</p>



<a name="175784789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784789" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784789">(Sep 16 2019 at 05:40)</a>:</h4>
<p>I mean within that body, no references exist to it, so it cannot be mutated through a reference</p>



<a name="175784800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784800" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784800">(Sep 16 2019 at 05:41)</a>:</h4>
<p>yes it can!</p>



<a name="175784809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784809" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784809">(Sep 16 2019 at 05:41)</a>:</h4>
<p>if you borrow it and pass it to some function <em>even without any bounds</em> it can use specialization to access some <code>Cell</code> inside</p>



<a name="175784816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784816">(Sep 16 2019 at 05:41)</a>:</h4>
<p>but <code>x</code> could be runtime so this is largely irrelevant - it's unpromotable anyway</p>



<a name="175784891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784891" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784891">(Sep 16 2019 at 05:43)</a>:</h4>
<p>Promotion is irrelevant here. The issue is <code>NeedsDrop</code></p>



<a name="175784945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784945" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784945">(Sep 16 2019 at 05:44)</a>:</h4>
<p>the risk of reinitialization?</p>



<a name="175784960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784960" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784960">(Sep 16 2019 at 05:44)</a>:</h4>
<p>There's a drop Terminator at the end of <code>ident</code></p>



<a name="175784981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175784981" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175784981">(Sep 16 2019 at 05:45)</a>:</h4>
<p>So when we do <code>_0 = _1</code>, we clear <code>NeedsDrop</code> but not <code>HasMutInterior</code></p>



<a name="175785026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785026">(Sep 16 2019 at 05:46)</a>:</h4>
<p>wait but you can clear both</p>



<a name="175785039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785039" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785039">(Sep 16 2019 at 05:46)</a>:</h4>
<p>wait are we worried about indirect accesses reinitializing something?</p>



<a name="175785043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785043" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785043">(Sep 16 2019 at 05:46)</a>:</h4>
<p>Yes</p>



<a name="175785049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785049" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785049">(Sep 16 2019 at 05:47)</a>:</h4>
<p>aaaaaaaah</p>



<a name="175785056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785056">(Sep 16 2019 at 05:47)</a>:</h4>
<p>okay yeah for that you need "was ever borrowed" or "may have ever been borrowed before this point"</p>



<a name="175785063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785063" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785063">(Sep 16 2019 at 05:47)</a>:</h4>
<p>the former is a decent approximation</p>



<a name="175785117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785117" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785117">(Sep 16 2019 at 05:48)</a>:</h4>
<p>sorry, when you said "can be mutated through a reference" I thought there was implied that you'd know whether there was a reference</p>



<a name="175785124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785124" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785124">(Sep 16 2019 at 05:48)</a>:</h4>
<p><code>HasMutInterior</code> tells you that <em>if</em> you have a reference, it can be used to mutate even if it's not a mutable reference</p>



<a name="175785126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785126" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785126">(Sep 16 2019 at 05:48)</a>:</h4>
<p>Yep sounds good. Btw this is not a blocker until we wanna unlock mutable references in const bodies</p>



<a name="175785197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785197">(Sep 16 2019 at 05:50)</a>:</h4>
<p>this is confusing me a bit</p>



<a name="175785200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785200" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785200">(Sep 16 2019 at 05:50)</a>:</h4>
<p>since I can't easily tell what depends on what</p>



<a name="175785217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785217" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785217">(Sep 16 2019 at 05:51)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> I guess the conservative thing to do for indirect accesses, function calls and <code>InlineAsm</code>, is to assume that anything that was borrowed mutably <em>or</em> sharedly with a <code>!Frozen</code> type, may be mutated</p>



<a name="175785262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785262" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785262">(Sep 16 2019 at 05:52)</a>:</h4>
<p>you can't really rely on <code>HasInteriorMut</code> easily because <code>HasInteriorMut</code> can be affected by this... I think?</p>



<a name="175785264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785264" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785264">(Sep 16 2019 at 05:52)</a>:</h4>
<p>or maybe <code>NeedsDrop</code> can</p>



<a name="175785269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785269" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785269">(Sep 16 2019 at 05:52)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="120791">@RalfJ</span> I guess</p>



<a name="175785283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785283" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785283">(Sep 16 2019 at 05:53)</a>:</h4>
<p>can a <code>&amp;Option&lt;UnsafeCell&lt;T&gt;&gt;</code> ever go from <code>None</code> to <code>Some</code>, under any model?</p>



<a name="175785301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785301" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785301">(Sep 16 2019 at 05:54)</a>:</h4>
<p>if not then I guess you can make anything borrow-related depend on <code>HasInteriorMut</code></p>



<a name="175785379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785379" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785379">(Sep 16 2019 at 05:55)</a>:</h4>
<p>Wow, Zulip is awful on Android :)</p>



<a name="175785423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785423" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785423">(Sep 16 2019 at 05:56)</a>:</h4>
<p>be careful, it also drains my battery really fast</p>



<a name="175785426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785426" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785426">(Sep 16 2019 at 05:56)</a>:</h4>
<blockquote>
<p>Wow, Zulip is awful on Android :)</p>
</blockquote>
<p>yes... your messages arrive after 30 mins or so...</p>



<a name="175785437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785437" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785437">(Sep 16 2019 at 05:56)</a>:</h4>
<p>There was an example that made me uneasy about using <code>HasInteriorMut</code> to track whether a local could be mutated indirectly, but I don't remember it off the top of my head.</p>



<a name="175785440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785440" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785440">(Sep 16 2019 at 05:56)</a>:</h4>
<p>I have to hold the back button to kill the app and remove lag (which was noticeably in other apps) and not risk depleting my battery in a few minutes</p>



<a name="175785539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785539" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785539">(Sep 16 2019 at 05:59)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="118594">ecstatic-morse</span> I guess the conservative thing to do for indirect accesses, function calls and <code>InlineAsm</code>, is to assume that anything that was borrowed mutably <em>or</em> sharedly with a <code>!Frozen</code> type, may be mutated</p>
</blockquote>
<p>I think I will implement a dataflow pass that detects this, then check it along with <code>NeedsDrop</code> at <code>Drop</code> terminators.</p>



<a name="175785596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785596" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785596">(Sep 16 2019 at 06:00)</a>:</h4>
<p>There's already <code>HaveBeenBorrowedLocals</code>; I just need a slight variation on this.</p>



<a name="175785764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785764" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785764">(Sep 16 2019 at 06:04)</a>:</h4>
<blockquote>
<p>if not then I guess you can make anything borrow-related depend on <code>HasInteriorMut</code></p>
</blockquote>
<p>I think this may be correct, but for some reason I'm wary. I guess because it may get cleared accidentally?</p>



<a name="175785853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175785853" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175785853">(Sep 16 2019 at 06:06)</a>:</h4>
<p>(This isn't an issue now, but may be in the future if we get more aggressive about clearing qualifs when locals are assigned to or moved out of)</p>



<a name="175799817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175799817" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175799817">(Sep 16 2019 at 10:20)</a>:</h4>
<blockquote>
<p>can a <code>&amp;Option&lt;UnsafeCell&lt;T&gt;&gt;</code> ever go from <code>None</code> to <code>Some</code>, under any model?</p>
</blockquote>
<p>well... with <code>&amp;Option&lt;UnsafeCell&lt;bool&gt;&gt;</code> I think Stacked Borrows lets it go from <code>Some</code> to <code>None</code>, yes. I also see no way (that Miri could implement) to forbid that.<br>
enum layout optimizations are really annoying that way...</p>



<a name="175800315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175800315" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175800315">(Sep 16 2019 at 10:31)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> yeah, see <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=2932bbee72bee2461e104410964f925d" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=2932bbee72bee2461e104410964f925d">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=2932bbee72bee2461e104410964f925d</a>. interior mutability in Stacked Borrows is a per-location thing, so if the discriminant shares locations with the interior, it can be mutated...</p>



<a name="175802730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175802730" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175802730">(Sep 16 2019 at 11:14)</a>:</h4>
<p>miri can overwrite the <code>layout_of</code> query and remove all layout optimizations :D</p>



<a name="175803042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175803042" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175803042">(Sep 16 2019 at 11:20)</a>:</h4>
<p>lol</p>



<a name="175803054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175803054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175803054">(Sep 16 2019 at 11:20)</a>:</h4>
<p>that doesn't help for defining UB though ;)</p>



<a name="175803695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175803695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175803695">(Sep 16 2019 at 11:32)</a>:</h4>
<p>could miri record what value ranges may be written to an interior mut location?</p>



<a name="175804611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175804611" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175804611">(Sep 16 2019 at 11:49)</a>:</h4>
<p>maybe. in my nightmares.^^</p>



<a name="175804920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175804920" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175804920">(Sep 16 2019 at 11:55)</a>:</h4>
<p>I assumed as much</p>



<a name="175864037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175864037" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175864037">(Sep 16 2019 at 23:56)</a>:</h4>
<p>I'm now happy with the analysis in <a href="https://github.com/rust-lang/rust/issues/64470" target="_blank" title="https://github.com/rust-lang/rust/issues/64470">#64470</a>. I'd like to split that PR up a bit, so that the generic dataflow engine and the new <code>IndirectlyMutableLocals</code> analysis can get a proper review. However, the code in the <code>check_consts</code> directory is ready to be reviewed in its current state.</p>



<a name="175864322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175864322" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175864322">(Sep 17 2019 at 00:01)</a>:</h4>
<p>I also wanted to float the idea of putting the new, dataflow-based validation pass behind a feature gate. In other words, only enable it if <code>#![feature(const_if)]</code> or <code>#![feature(const_loop)]</code> is enabled. We can use the existing pass for promotion if we add a flag to it that disables the validation errors (the ones that are currently commented out on my PR). This would mean that <a href="https://github.com/rust-lang/rust/issues/64470" target="_blank" title="https://github.com/rust-lang/rust/issues/64470">#64470</a> could advance independently of <a href="https://github.com/rust-lang/rust/issues/63812" target="_blank" title="https://github.com/rust-lang/rust/issues/63812">#63812</a>.</p>



<a name="175864606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175864606" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175864606">(Sep 17 2019 at 00:06)</a>:</h4>
<p>I want to put the new qualification pass behind a feature flag because I'm worried about accidentally allowing a const operation that was previously banned. Such a change will be insta-stable unless the new pass is behind a flag. While a <code>crater</code> run will be able to tell us if my PR regresses currently valid code, there's not a corpus of currently broken const code beyond the test suite. Letting people play around with <code>#![feature(const_if)]</code> should give us some more data.</p>



<a name="175867418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175867418" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175867418">(Sep 17 2019 at 01:03)</a>:</h4>
<p>sounds like a good idea to proceed carefully</p>



<a name="175877395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175877395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175877395">(Sep 17 2019 at 05:27)</a>:</h4>
<p>Oh btw <code>let mut x: Option&lt;Cell&lt;i32&gt;&gt; = None; let p = &amp;mut x; *p = Some(Cell::new(4));</code> is enough to require that we track <code>HasMutInterior</code> separate from <code>IsIndirectlyMutable</code> with the current rules. It wouldn't be too hard to extend them, but I think it's premature to try to combine the two concepts.</p>



<a name="175943269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175943269" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175943269">(Sep 17 2019 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> I'm gonna start splitting up my PR now. I'm also gonna rebase changes in <code>check_consts</code> since there's currently 3 different forms of the analysis in the git history (I'll keep the original series of commits on my fork)</p>



<a name="175962524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175962524" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175962524">(Sep 18 2019 at 00:58)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="119009">@eddyb</span> I rebased <a href="https://github.com/rust-lang/rust/issues/64470" target="_blank" title="https://github.com/rust-lang/rust/issues/64470">#64470</a> so that it can be reviewed commit-by-commit. Specifically the changes in <code>qualifs.rs</code> should be easier to review now. I also removed some of the unused code in <code>resolver.rs</code> that will be required to combine with <a href="https://github.com/rust-lang/rust/issues/63812" target="_blank" title="https://github.com/rust-lang/rust/issues/63812">#63812</a>. Finally, I split out the dataflow portion of the PR in <a href="https://github.com/rust-lang/rust/issues/64566" target="_blank" title="https://github.com/rust-lang/rust/issues/64566">#64566</a> since there's a lot of design space there.</p>



<a name="175962596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/175962596" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#175962596">(Sep 18 2019 at 01:00)</a>:</h4>
<p>I don't think I'm going to split out the addition of the <code>IndirectlyMutableLocals</code> dataflow pass into its own PR, since it's not very big and pretty closely coupled to this PR, so comment away if you see problems.</p>



<a name="176046162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176046162" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176046162">(Sep 18 2019 at 21:00)</a>:</h4>
<blockquote>
<p>I want to put the new qualification pass behind a feature flag because I'm worried about accidentally allowing a const operation that was previously banned. Such a change will be insta-stable unless the new pass is behind a flag.</p>
</blockquote>
<p>or we could have migration mode like we did for the borrow checker: run both, warn/ICE/whatever if they disagree.</p>



<a name="176059820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176059820" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176059820">(Sep 19 2019 at 00:43)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span>  I both love (T-lang) and hate (T-release) that idea -- it's gonna be fun for rollups :P</p>



<a name="176073816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176073816" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176073816">(Sep 19 2019 at 06:55)</a>:</h4>
<p>yeah</p>



<a name="176074015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176074015" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176074015">(Sep 19 2019 at 06:58)</a>:</h4>
<p>well actually, I was not suggesting the thing with two runs of the test suite</p>



<a name="176074021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176074021" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176074021">(Sep 19 2019 at 06:58)</a>:</h4>
<p>I was suggesting the thing we do right now where we run both AST and NLL borrowck in production</p>



<a name="176140492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176140492" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176140492">(Sep 19 2019 at 20:47)</a>:</h4>
<blockquote>
<p>I was suggesting the thing we do right now where we run both AST and NLL borrowck in production</p>
</blockquote>
<p>The current code always runs the new, dataflow-based validator but prevents it from emitting any errors. Then it compares the errors (<code>Span</code> plus <code>fmt::Debug</code> for the error struct) and ICEs if the sequence of errors is not identical with the old validator.</p>



<a name="176140620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176140620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176140620">(Sep 19 2019 at 20:48)</a>:</h4>
<p>I'm not really sure how to present this to the user. I guess we could emit a warning to nightly users saying "we messed something up, could you create an issue with your code so we can debug it"?</p>



<a name="176140847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176140847" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176140847">(Sep 19 2019 at 20:52)</a>:</h4>
<p>Btw, I have a proof-of-concept branch that enables <code>if</code> and <code>match</code> in consts behind a feature flag so I can write better tests for the dataflow-based validator.</p>



<a name="176140914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176140914" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176140914">(Sep 19 2019 at 20:52)</a>:</h4>
<p><a href="https://github.com/ecstatic-morse/rust/tree/const-if" target="_blank" title="https://github.com/ecstatic-morse/rust/tree/const-if">https://github.com/ecstatic-morse/rust/tree/const-if</a></p>



<a name="176144536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176144536" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176144536">(Sep 19 2019 at 21:37)</a>:</h4>
<blockquote>
<p>I'm not really sure how to present this to the user. I guess we could emit a warning to nightly users saying "we messed something up, could you create an issue with your code so we can debug it"?</p>
</blockquote>
<p>Isn't that just an ICE?</p>



<a name="176144983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176144983" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176144983">(Sep 19 2019 at 21:42)</a>:</h4>
<p>I guess an ICE seems a little extreme to me, but y'all have more experience with this stuff than I do</p>



<a name="176145413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176145413" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176145413">(Sep 19 2019 at 21:48)</a>:</h4>
<p>ICEs are a perfect fit for "we messed something up"</p>



<a name="176145421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176145421" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176145421">(Sep 19 2019 at 21:48)</a>:</h4>
<p>that's why they exist :D</p>



<a name="176167569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176167569" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176167569">(Sep 20 2019 at 06:06)</a>:</h4>
<p>not quite, in this case I think we'd want it as a future incompat warning</p>



<a name="176167575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176167575" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176167575">(Sep 20 2019 at 06:06)</a>:</h4>
<p>if it's an ICE we'd be breaking user code</p>



<a name="176167579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176167579" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176167579">(Sep 20 2019 at 06:06)</a>:</h4>
<p>we want to be able to crater it and to wait for ppl to tell us about their woes</p>



<a name="176263881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176263881" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176263881">(Sep 21 2019 at 13:00)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> sure, but after cratering we should make it an ICE</p>



<a name="176263899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176263899" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176263899">(Sep 21 2019 at 13:01)</a>:</h4>
<p>crater takes too long</p>



<a name="176263902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176263902" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176263902">(Sep 21 2019 at 13:01)</a>:</h4>
<p>I have made a different suggestion on the PR</p>



<a name="176263906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/176263906" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#176263906">(Sep 21 2019 at 13:01)</a>:</h4>
<p>just only ICE on nightly for now :D</p>



<a name="177078284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177078284" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177078284">(Oct 01 2019 at 17:32)</a>:</h4>
<p>I'm working on a fix for <a href="https://github.com/rust-lang/rust/issues/64945" target="_blank" title="https://github.com/rust-lang/rust/issues/64945">#64945</a> now. My local git repo for rust was corrupted somehow, so I'm trying to fix those concurrently.</p>



<a name="177088926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177088926" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177088926">(Oct 01 2019 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="119009">@eddyb</span> I opened <a href="https://github.com/rust-lang/rust/issues/64967" target="_blank" title="https://github.com/rust-lang/rust/issues/64967">#64967</a> to fix <a href="https://github.com/rust-lang/rust/issues/64945" target="_blank" title="https://github.com/rust-lang/rust/issues/64945">#64945</a>. I'll continue investigating whether similar mismatches are possible.</p>



<a name="177089587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177089587" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177089587">(Oct 01 2019 at 19:31)</a>:</h4>
<p>Also, I think <code>IndirectlyMutableLocals</code> is currently unsound in the presence of unsafe code and aggregates.</p>
<div class="codehilite"><pre><span></span><span class="cp">#[derive(Default)]</span><span class="w"></span>
<span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">PartialInteriorMut</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">Cell</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PartialInteriorMut</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pa</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="c1">// Doesn&#39;t cause `x` to get marked as indirectly mutable</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pb</span>: <span class="kp">&amp;</span><span class="nc">Cell</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">pa</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Cell</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">pb</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w">  </span><span class="c1">// Mutates `x` indirectly even though `x` is not marked indirectly mutable!!!</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Basically, we need to look at the type of the place base (not the type of the place after projections) to see whether to mark it as indirectly mutable.</p>



<a name="177709683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177709683" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177709683">(Oct 09 2019 at 12:46)</a>:</h4>
<p>that code is UB though according to current Stacked Borrows</p>



<a name="177709695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177709695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177709695">(Oct 09 2019 at 12:47)</a>:</h4>
<p>but then this might or might not be what our final aliasing model says</p>



<a name="177709716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177709716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177709716">(Oct 09 2019 at 12:47)</a>:</h4>
<p>mixed interior mut is a contentious case</p>



<a name="177709840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177709840" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177709840">(Oct 09 2019 at 12:48)</a>:</h4>
<p>oh I guess this is <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/134#issuecomment-538678208" target="_blank" title="https://github.com/rust-lang/unsafe-code-guidelines/issues/134#issuecomment-538678208">https://github.com/rust-lang/unsafe-code-guidelines/issues/134#issuecomment-538678208</a></p>



<a name="177709946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177709946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177709946">(Oct 09 2019 at 12:50)</a>:</h4>
<p>in any case, good catch!</p>



<a name="177710023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177710023" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177710023">(Oct 09 2019 at 12:50)</a>:</h4>
<p>that comment makes me wonder if this is more about using raw pointers outside their original range, or partial interior mutability</p>



<a name="177710055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177710055" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177710055">(Oct 09 2019 at 12:50)</a>:</h4>
<p>it also raises some policy questions: if const-code has UB, do we care if our const-qualification analyses are incorrect?</p>



<a name="177999733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/177999733" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Regueiro <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#177999733">(Oct 12 2019 at 18:00)</a>:</h4>
<p>what's the latest on this, out of curiosity? do we have some form of dataflow-based CTFE  in rustc nightly yet?</p>



<a name="178000842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/dataflow-based%20const%20qualification%20MVP/near/178000842" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/146212-t-compiler/const-eval/topic/dataflow-based.20const.20qualification.20MVP.html#178000842">(Oct 12 2019 at 18:29)</a>:</h4>
<p>It was merged in <a href="https://github.com/rust-lang/rust/issues/64470" target="_blank" title="https://github.com/rust-lang/rust/issues/64470">#64470</a>. See <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Next.20steps.20for.20promotion.20and.20validation" title="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Next.20steps.20for.20promotion.20and.20validation">https://rust-lang.zulipchat.com/#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Next.20steps.20for.20promotion.20and.20validation</a> for the latest news.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>