<html>
<head><meta charset="utf-8"><title>Is this ok for a const fn to not have `#[rustc_const_*]`? · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html">Is this ok for a const fn to not have `#[rustc_const_*]`?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258683302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258683302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258683302">(Oct 22 2021 at 09:06)</a>:</h4>
<p>Most <code>const fn</code> in the <code>std</code>/<code>alloc</code>/<code>core</code>  I've seen so far have either <code>#[rustc_const_unstable]</code> or <code>#[rustc_const_stable]</code>, but <code>UnsafeCell::raw_get</code> has neither: <a href="https://github.com/rust-lang/rust/blob/68a698baf6bfc61d85ce6e25122a092c60c7f21a/library/core/src/cell.rs#L1963-L1964">source</a>. Is this fine or an error?</p>



<a name="258692394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258692394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258692394">(Oct 22 2021 at 10:30)</a>:</h4>
<p>If it's omitted that just means it's been const as long as it's been stable.</p>



<a name="258713286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258713286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258713286">(Oct 22 2021 at 13:43)</a>:</h4>
<p>We should probably start requiring either attribute for stable const fn, so that we don't accidentally stabilize the constness somewhere</p>



<a name="258766624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258766624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258766624">(Oct 22 2021 at 20:04)</a>:</h4>
<p>I can try to implement this if you say where I should add this check <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="258795557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258795557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258795557">(Oct 23 2021 at 01:26)</a>:</h4>
<p>Once I get around to implementing the const-stable on unstable function lint, it would be trivial to add a check like this in I would think.</p>



<a name="258818139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258818139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258818139">(Oct 23 2021 at 11:18)</a>:</h4>
<p>Cool! Can you tag me (<code>@wafflelapkin</code> on github), once you make the PR? Just want to know the progress :)</p>



<a name="258842095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/258842095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#258842095">(Oct 23 2021 at 20:52)</a>:</h4>
<p>I will if I remember. Which honestly is probably less likely than not.</p>



<a name="261745812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261745812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261745812">(Nov 17 2021 at 05:39)</a>:</h4>
<p>Coming back around to this. This <em>should</em> already be caught on stable methods. The relevant code is <a href="https://github.com/rust-lang/rust/blob/d914f17ca71a33a89b2dc3436fca51b1a091559e/compiler/rustc_passes/src/stability.rs#L579-L592">here</a> with it being called in a pass <a href="https://github.com/rust-lang/rust/blob/d914f17ca71a33a89b2dc3436fca51b1a091559e/compiler/rustc_passes/src/stability.rs#L617-L623">here</a>. Interestingly, this is only <em>supposed</em> to apply to stable methods, which is surprising to me.</p>



<a name="261745887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261745887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261745887">(Nov 17 2021 at 05:41)</a>:</h4>
<p>And yes, <a href="https://github.com/rust-lang/rust/blob/d914f17ca71a33a89b2dc3436fca51b1a091559e/src/test/ui/stability-attribute/missing-const-stability.rs">there is a test</a> that's supposed to ensure this. No idea where the pass is going wrong.</p>



<a name="261760158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261760158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261760158">(Nov 17 2021 at 09:27)</a>:</h4>
<p>After updating that code to be more extensive, I'm back to tests. I'm 99% sure it's because it's an <code>impl</code> block. I'll figure it out when I get more time.</p>



<a name="261762849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261762849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261762849">(Nov 17 2021 at 09:56)</a>:</h4>
<p>Figured it out — the method just wasn't being called in one specific location. You would not believe how many errors this is emitting... 208 in <code>core</code> alone.</p>



<a name="261763151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261763151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261763151">(Nov 17 2021 at 09:58)</a>:</h4>
<p>Also! Before I forget. This change necessarily includes <a href="https://github.com/rust-lang/rust/issues/90687">#90687</a>. I'd prefer that be merged separately as it includes its own test, but it should be done before this code is completed. If someone is willing to review, that would be great.</p>



<a name="261791358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261791358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261791358">(Nov 17 2021 at 14:29)</a>:</h4>
<p>In one specific code path, the check was forgotten to be called and it currently misses 208 methods? whoah</p>



<a name="261820884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261820884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261820884">(Nov 17 2021 at 17:46)</a>:</h4>
<p>Admittedly I expanded the check to include unstable methods as well, but yes. Just in core.</p>



<a name="261821096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261821096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261821096">(Nov 17 2021 at 17:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F/near/261762849">said</a>:</p>
<blockquote>
<p>Figured it out — the method just wasn't being called in one specific location. You would not believe how many errors this is emitting... 208 in <code>core</code> alone.</p>
</blockquote>
<p>oh wow. also makes me wonder how we can avoid such mistakes in the future...</p>



<a name="261821257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261821257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261821257">(Nov 17 2021 at 17:49)</a>:</h4>
<p>Well...I have previously worked on the assumption that the attributes weren't necessary if it was the same as the regular stability. To the point I'd actually remove it if they were being stabilized at the same time. I presume others have done the same.</p>



<a name="261821273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261821273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261821273">(Nov 17 2021 at 17:49)</a>:</h4>
<p>But this change will ensure no one does that again.</p>



<a name="261876438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261876438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261876438">(Nov 18 2021 at 01:46)</a>:</h4>
<p>For sanity purposes I'm going to initially limit the change to only stable methods (essentially just fixing the existing bug). Turns out it's far more reasonable ("only" 14 errors in core)</p>



<a name="261878751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/Is%20this%20ok%20for%20a%20const%20fn%20to%20not%20have%20%60%23%5Brustc_const_%2A%5D%60%3F/near/261878751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/Is.20this.20ok.20for.20a.20const.20fn.20to.20not.20have.20.60.23.5Brustc_const_*.5D.60.3F.html#261878751">(Nov 18 2021 at 02:26)</a>:</h4>
<p><span class="user-mention" data-user-id="273349">@Waffle Lapkin</span> PR for reference: <a href="https://github.com/rust-lang/rust/issues/90998">#90998</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>