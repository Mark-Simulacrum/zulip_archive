<html>
<head><meta charset="utf-8"><title>`ConstEvaluatable` generic functions · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html">`ConstEvaluatable` generic functions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="204125452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204125452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204125452">(Jul 16 2020 at 18:45)</a>:</h4>
<p>We currently allow the following code:</p>
<div class="codehilite"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// std::mem::size_of::&lt;T&gt;();</span>
<span class="w">    </span><span class="mi">42</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204125563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204125563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204125563">(Jul 16 2020 at 18:45)</a>:</h4>
<p>Uncommenting <code>std::mem::size_of::&lt;T&gt;()</code> makes <code>foo</code> depend on its type parameter <code>T</code> and causes the following error (as expected):</p>
<div class="codehilite"><pre><span></span><code>error: constant expression depends on a generic parameter
 --&gt; src/lib.rs:7:17
  |
7 |     let _ = [0; foo::&lt;T&gt;()];
  |                 ^^^^^^^^^^
  |
  = note: this may fail depending on what value the parameter takes
</code></pre></div>



<a name="204125854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204125854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204125854">(Jul 16 2020 at 18:48)</a>:</h4>
<p>While this case is fairly artificial, something like this might be more relevant:</p>
<div class="codehilite"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204125946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204125946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204125946">(Jul 16 2020 at 18:48)</a>:</h4>
<p>This suddenly breaks on 32 bit systems</p>



<a name="204126106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204126106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204126106">(Jul 16 2020 at 18:49)</a>:</h4>
<p>I personally would therefore like to prevent <code>PredicateKind::ConstEvaluatable</code> from looking into functions with generic parameters which are not concrete</p>



<a name="204126187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204126187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204126187">(Jul 16 2020 at 18:50)</a>:</h4>
<p>Thereby forbidding all of the above uses of <code>foo</code>.</p>



<a name="204126255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204126255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204126255">(Jul 16 2020 at 18:50)</a>:</h4>
<p>(this probably needs a future compat warning, as some of these examples already compile on stable)</p>



<a name="204126553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204126553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204126553">(Jul 16 2020 at 18:53)</a>:</h4>
<p>Does this seem sensible to all of you? cc <span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="204132625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204132625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204132625">(Jul 16 2020 at 19:38)</a>:</h4>
<p>Depending on how we implement const wf this might become moot in a year or two</p>



<a name="204180936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204180936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204180936">(Jul 17 2020 at 08:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60ConstEvaluatable.60.20generic.20functions/near/204132625">said</a>:</p>
<blockquote>
<p>Depending on how we implement const wf this might become moot in a year or two</p>
</blockquote>
<p>as in we'll allow it again in a year or two anyway?</p>



<a name="204195954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204195954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204195954">(Jul 17 2020 at 11:39)</a>:</h4>
<p>hmm, not completely sure, I expect we somehow allow this. This depends on how <a href="https://github.com/rust-lang/rust/issues/68436">#68436</a> (which sadly ended up being the most requested const generics issue after <a href="https://github.com/rust-lang/rust/issues/74113">#74113</a> is now working <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>) pans out I guess</p>



<a name="204196205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196205">(Jul 17 2020 at 11:43)</a>:</h4>
<p>We want to allow calling <code>foo::&lt;T&gt;</code> independently of if it actually uses <code>T</code>(potentially requiring a where bound).</p>



<a name="204196245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196245">(Jul 17 2020 at 11:44)</a>:</h4>
<p>We currently look inside of <code>foo</code> to decide if it may be used, which I would like to prevent</p>



<a name="204196870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196870">(Jul 17 2020 at 11:53)</a>:</h4>
<p>well, it's not that we look, but rather that miri will just succeed if it's not <em>dynamically</em> used</p>



<a name="204196881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196881">(Jul 17 2020 at 11:53)</a>:</h4>
<p>since, well, miri doesn't execute all paths :P</p>



<a name="204196908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196908">(Jul 17 2020 at 11:53)</a>:</h4>
<p>I think I said already but what we could do is just stop at calls of <code>const fn</code>s and require that all of their parameters are known</p>



<a name="204196969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196969">(Jul 17 2020 at 11:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60ConstEvaluatable.60.20generic.20functions/near/204196908">said</a>:</p>
<blockquote>
<p>I think I said already but what we could do is just stop at calls of <code>const fn</code>s and require that all of their parameters are known</p>
</blockquote>
<p>which  is what I am proposing here, isn't it <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="204196988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204196988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204196988">(Jul 17 2020 at 11:54)</a>:</h4>
<p>well, specifically have miri stop</p>



<a name="204197001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204197001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204197001">(Jul 17 2020 at 11:54)</a>:</h4>
<p>nothing else in the compiler would care/know about this</p>



<a name="204197024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204197024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204197024">(Jul 17 2020 at 11:55)</a>:</h4>
<p>this is similar to miri hitting a <code>&lt;T as Trait&gt;::method</code> call - if it doesn't know <code>T</code>, it can't resolve what function will actually get called</p>



<a name="204197032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204197032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204197032">(Jul 17 2020 at 11:55)</a>:</h4>
<p>so we can pretend it's like that</p>



<a name="204211430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204211430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204211430">(Jul 17 2020 at 14:21)</a>:</h4>
<p>Isn't it weird to forbid something now, which will break stable code, just to allow it again later?</p>



<a name="204211571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204211571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204211571">(Jul 17 2020 at 14:23)</a>:</h4>
<p>I am not sure if we will allow it this way later</p>



<a name="204211789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204211789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204211789">(Jul 17 2020 at 14:24)</a>:</h4>
<p>I.e. if we add required <code>where</code> bounds here</p>
<div class="codehilite"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mi">42</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204211887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204211887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204211887">(Jul 17 2020 at 14:25)</a>:</h4>
<p>so by not forbidding this now, we might get driven into a corner when implementing const wf</p>



<a name="204212091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204212091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204212091">(Jul 17 2020 at 14:27)</a>:</h4>
<p>we put a lot of effort into making miri able to evaluate polymorphic functions, could we just make where bounds do this instead of forbidding it in general? Right now you can only use the generic parameters in runtime positions I think</p>



<a name="204212399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204212399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204212399">(Jul 17 2020 at 14:29)</a>:</h4>
<ul>
<li>we currently supply the parent generics to repeat expressions on stable (preventing an ice on <code>[0u64; std::mem::size_of::&lt;T&gt;()]</code></li>
</ul>



<a name="204212558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204212558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204212558">(Jul 17 2020 at 14:30)</a>:</h4>
<ul>
<li>we do add a <code>PredicateKind::ConstEvaluatable</code> for every anon const (repeat expression length), requiring that the given rep expr length does not actually depend on any generic parameters until we figure out const wf</li>
</ul>



<a name="204212652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204212652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204212652">(Jul 17 2020 at 14:31)</a>:</h4>
<ul>
<li>while checking this, we look into functions (as we just run miri and test if it succeeds)</li>
</ul>



<a name="204212769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204212769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204212769">(Jul 17 2020 at 14:32)</a>:</h4>
<p>So only stop miri from doing this while checking <code>ConstEvaluatable</code></p>



<a name="204212963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204212963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204212963">(Jul 17 2020 at 14:33)</a>:</h4>
<p>I think we can get away with that... I don't think any reasonable/useful code will actually break from this</p>



<a name="204213081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213081">(Jul 17 2020 at 14:34)</a>:</h4>
<blockquote>
<p>with that</p>
</blockquote>
<p>whats "that" here?</p>



<a name="204213125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213125">(Jul 17 2020 at 14:34)</a>:</h4>
<p>preventing the invocation of generic functions during CTFE if the CTFE was triggered from <code>ConstEvaluable</code></p>



<a name="204213156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213156">(Jul 17 2020 at 14:35)</a>:</h4>
<p>So without a future compat period?</p>



<a name="204213213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213213">(Jul 17 2020 at 14:35)</a>:</h4>
<p>I'd say we see what happens on crater. The only case that I can think of that users may depend on is <code>std::ptr::null</code></p>



<a name="204213236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213236">(Jul 17 2020 at 14:35)</a>:</h4>
<p>My main concern is that <code>let _ = [0; std::mem::size_of::&lt;*mut T&gt;()]</code> and friends currently work, which might sometimes get used</p>



<a name="204213606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213606">(Jul 17 2020 at 14:38)</a>:</h4>
<blockquote>
<p>what happens on crater</p>
</blockquote>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span>  if no one else wants to open a PR here I will try and get to this next week</p>



<a name="204213700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213700">(Jul 17 2020 at 14:39)</a>:</h4>
<p>bringing me back to my original question: why do repeat expr lengths need this? Can we just keep them being special and allowing them having generic parameters?</p>



<a name="204213760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213760">(Jul 17 2020 at 14:40)</a>:</h4>
<p>Don't they have the same problems as all other const generic parameters?</p>



<a name="204213795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213795">(Jul 17 2020 at 14:40)</a>:</h4>
<p>i.e. what happens for <code>let _ = [0; std::mem::size_of::&lt;T&gt;() - 4]</code></p>



<a name="204213922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213922">(Jul 17 2020 at 14:41)</a>:</h4>
<p>post monorphization errors happen, but that's not really part of the type system</p>



<a name="204213936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204213936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204213936">(Jul 17 2020 at 14:41)</a>:</h4>
<p>it's only during codegen (or <code>collect</code>)</p>



<a name="204214200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214200">(Jul 17 2020 at 14:43)</a>:</h4>
<p>can we just make it a future incompat lint the moment we start implementing wf?</p>



<a name="204214254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214254">(Jul 17 2020 at 14:44)</a>:</h4>
<p>basically make it a future incompat lint when there's an opt-out?</p>



<a name="204214287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214287">(Jul 17 2020 at 14:44)</a>:</h4>
<p>because right now we wouldn't be giving users any way out</p>



<a name="204214294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214294">(Jul 17 2020 at 14:44)</a>:</h4>
<p>What's the difference between this and <a href="https://github.com/rust-lang/rust/issues/68436">https://github.com/rust-lang/rust/issues/68436</a>? I am getting somewhat confused here</p>



<a name="204214373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214373">(Jul 17 2020 at 14:45)</a>:</h4>
<p>yea... I don't think you're the confused one</p>



<a name="204214399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214399">(Jul 17 2020 at 14:45)</a>:</h4>
<p>it's me not having internalized all this stuff fully yet, I'll have that done soon</p>



<a name="204214424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214424">(Jul 17 2020 at 14:45)</a>:</h4>
<p>I was literally reading that issue (again, to refresh my mind) when you commented with the link</p>



<a name="204214761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214761">(Jul 17 2020 at 14:48)</a>:</h4>
<p>Ok, sorry about the mess above.</p>



<a name="204214789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214789">(Jul 17 2020 at 14:48)</a>:</h4>
<p>So what about <br>
<span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60ConstEvaluatable.60.20generic.20functions/near/204214200">said</a>:</p>
<blockquote>
<p>can we just make it a future incompat lint the moment we start implementing wf?<br>
basically make it a future incompat lint when there's an opt-out?<br>
because right now we wouldn't be giving users any way out</p>
</blockquote>



<a name="204214822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214822">(Jul 17 2020 at 14:49)</a>:</h4>
<p>I personally feel like we haven't been able to formulate the exact goals and requirements here yet,<br>
which makes the discussions in that issue quite draining for me <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="204214881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214881">(Jul 17 2020 at 14:49)</a>:</h4>
<p>well, a future incompat lint is always opt-out, isn't it? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="204214952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204214952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204214952">(Jul 17 2020 at 14:50)</a>:</h4>
<p>oh? I'll write a summary and mark the discussion as resolved</p>



<a name="204215030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204215030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204215030">(Jul 17 2020 at 14:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60ConstEvaluatable.60.20generic.20functions/near/204214881">said</a>:</p>
<blockquote>
<p>well, a future incompat lint is always opt-out, isn't it? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>
</blockquote>
<p>hehe, that's not the solution I like, because if ppl turn them off (can they?) it'll mean when there's an actual fix they can apply, they won't see anything (and until then, they just got a useless warning)</p>



<a name="204215142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204215142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204215142">(Jul 17 2020 at 14:51)</a>:</h4>
<p>"the discussion" you mean <a href="https://github.com/rust-lang/rust/issues/68436">#68436</a>? I haven't even fully understood the problem, how can this already be resolved</p>



<a name="204215341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204215341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204215341">(Jul 17 2020 at 14:53)</a>:</h4>
<blockquote>
<p>actual fix</p>
</blockquote>
<p>We currently only allow functions which actually do not depend on any params, so you can just use any type you want for these functions</p>



<a name="204215395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204215395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204215395">(Jul 17 2020 at 14:53)</a>:</h4>
<p>so <code>[0; std::mem::size_of::&lt;*mut T&gt;()]</code> can always be replaced with <code>[0; std::mem::size_of::&lt;*mut ()&gt;()]</code></p>



<a name="204215464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204215464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204215464">(Jul 17 2020 at 14:54)</a>:</h4>
<p>Which admittedly does not communicate the intent as well as the original version</p>



<a name="204216354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204216354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204216354">(Jul 17 2020 at 15:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60ConstEvaluatable.60.20generic.20functions/near/204215142">said</a>:</p>
<blockquote>
<p>"the discussion" you mean <a href="https://github.com/rust-lang/rust/issues/68436">#68436</a>? I haven't even fully understood the problem, how can this already be resolved</p>
</blockquote>
<p>if we repeat the array length expression in the where bounds in some way (e.g. <code>where {std::mem::size_of::&lt;*mut T&gt;()}</code>) (ignore syntax bikeshed, let's just go with anything that works first) and fo reach <code>AnonConst</code> in the function body we require that either there's an exactly equal constant in the where bounds, or in case of <code>Unevaluated</code> we compare the MIR in a lossy way</p>



<a name="204216410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204216410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204216410">(Jul 17 2020 at 15:01)</a>:</h4>
<p>the where bounds are never evaluated unless they are <code>!needs_subst</code></p>



<a name="204216464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204216464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204216464">(Jul 17 2020 at 15:01)</a>:</h4>
<p>but instead where bounds on items used in a function are treated the same way as <code>AnonConst</code></p>



<a name="204216567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204216567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204216567">(Jul 17 2020 at 15:02)</a>:</h4>
<p>(there must be a where bound for the constant on the surrounding item)</p>



<a name="204218207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204218207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204218207">(Jul 17 2020 at 15:15)</a>:</h4>
<p>okay, so that's a solution, which makes sense, even if it's somewhat unwieldy for</p>
<div class="codehilite"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204218307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204218307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204218307">(Jul 17 2020 at 15:15)</a>:</h4>
<p>we can't really solve this without adding some kind of logic system into mir, which doesn't really seem feasable, afaict</p>



<a name="204218488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204218488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204218488">(Jul 17 2020 at 15:17)</a>:</h4>
<p>So now that I have a solution which seems fine, I am only missing the problem which requires this solution <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>
<p>Will just wait for your summary here</p>



<a name="204223037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204223037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204223037">(Jul 17 2020 at 15:51)</a>:</h4>
<p>yea sorry <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> I'm focussing on the mir-opt talk I'm holding tomorrow</p>



<a name="204223648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204223648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204223648">(Jul 17 2020 at 15:55)</a>:</h4>
<p>oooh, nice <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span> will it get uploaded afterwards?</p>



<a name="204224246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204224246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204224246">(Jul 17 2020 at 15:58)</a>:</h4>
<p>definitely</p>



<a name="204227433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204227433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204227433">(Jul 17 2020 at 16:22)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> hmm for some reason I thought the <code>size_of</code> example wouldn't break but I guess that's only because it's an intrinsic, a normal <code>const fn</code>would have problems still :/</p>



<a name="204227439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204227439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204227439">(Jul 17 2020 at 16:22)</a>:</h4>
<p><em>sigh</em></p>



<a name="204227499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204227499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204227499">(Jul 17 2020 at 16:23)</a>:</h4>
<p>allowing <code>size_of</code> would be quite a big bodge imo</p>



<a name="204227640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204227640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204227640">(Jul 17 2020 at 16:24)</a>:</h4>
<p><code>size_of</code> also is not an intrinsic. It calls an intrinsic which does not look into <code>ty::Ptr</code> so it doesn't care about <code>T</code></p>



<a name="204227644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204227644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204227644">(Jul 17 2020 at 16:24)</a>:</h4>
<p>if we do it would be because it's an intrinsic, not because it's <code>size_of</code></p>



<a name="204227663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204227663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204227663">(Jul 17 2020 at 16:24)</a>:</h4>
<p>ah if it's wrapped then it doesn't matter</p>



<a name="204228220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204228220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204228220">(Jul 17 2020 at 16:29)</a>:</h4>
<p>Also see</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#![feature(variant_count)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">variant_count</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">()];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204228781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204228781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204228781">(Jul 17 2020 at 16:34)</a>:</h4>
<p>heh</p>



<a name="204228954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204228954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204228954">(Jul 17 2020 at 16:36)</a>:</h4>
<p>/me realizes this means changing the way intrinsics are implemented can very easily cause accidental breakage rn</p>



<a name="204229013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204229013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204229013">(Jul 17 2020 at 16:37)</a>:</h4>
<p>let's say we only return a value if <code>!ty.needs_substs</code></p>



<a name="204229021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204229021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204229021">(Jul 17 2020 at 16:37)</a>:</h4>
<p>sudden breakage</p>



<a name="204390171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204390171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204390171">(Jul 20 2020 at 06:29)</a>:</h4>
<p>Luckily <code>type_id</code> is still const unstable</p>



<a name="204390172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204390172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204390172">(Jul 20 2020 at 06:29)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/74538">https://github.com/rust-lang/rust/pull/74538</a></p>



<a name="204390176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204390176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204390176">(Jul 20 2020 at 06:29)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#![feature(const_type_id)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">&#39;static</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span>::<span class="n">any</span>::<span class="n">TypeId</span>::<span class="n">of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="mi">7</span><span class="w"></span>
<span class="w">    </span><span class="p">}];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204392340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204392340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204392340">(Jul 20 2020 at 07:13)</a>:</h4>
<p>hah, yea, but that would've been a soundness fix, so...</p>



<a name="204546065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546065">(Jul 21 2020 at 13:19)</a>:</h4>
<p>Thanks for pinging me here <a href="https://github.com/rust-lang/rust/pull/74491#issuecomment-661846982">https://github.com/rust-lang/rust/pull/74491#issuecomment-661846982</a> <span class="user-mention" data-user-id="124288">@oli</span> </p>
<p>That's pretty concerning <span aria-label="cold sweat" class="emoji emoji-1f630" role="img" title="cold sweat">:cold_sweat:</span></p>



<a name="204546124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546124">(Jul 21 2020 at 13:20)</a>:</h4>
<p>yea, but there's an easy fix, because we already created infrastructure for it</p>



<a name="204546221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546221">(Jul 21 2020 at 13:20)</a>:</h4>
<blockquote>
<p>We may should probably just move your optimization under mir-opt-level 3</p>
</blockquote>
<p>?</p>



<a name="204546231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546231">(Jul 21 2020 at 13:20)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Body.html#structfield.required_consts">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Body.html#structfield.required_consts</a></p>



<a name="204546283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546283">(Jul 21 2020 at 13:21)</a>:</h4>
<p>well, if we move the optimization to mir-opt-level 3, which still is the "contains broken optimizations" list, we don't expose this to nightly or stable users</p>



<a name="204546332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546332">(Jul 21 2020 at 13:21)</a>:</h4>
<p>yeah, but that doesn't really seem desirable if this opt otherwise improves perf</p>



<a name="204546491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546491">(Jul 21 2020 at 13:23)</a>:</h4>
<p>I just mean it as a temporary measure</p>



<a name="204546509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546509">(Jul 21 2020 at 13:23)</a>:</h4>
<p>so the code is merged and tested</p>



<a name="204546529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546529">(Jul 21 2020 at 13:23)</a>:</h4>
<p>I like small PRs <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="204546877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204546877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204546877">(Jul 21 2020 at 13:26)</a>:</h4>
<p>anyway, about your suggestion. It's to do <code>body.is_polymorphic = body.needs_subst();</code> right after mir building and then make the future incompat lint use that flag if a function with that flag is interpreted while still polymorphic?</p>



<a name="204547818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204547818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204547818">(Jul 21 2020 at 13:36)</a>:</h4>
<p>something like that</p>



<a name="204547836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204547836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204547836">(Jul 21 2020 at 13:36)</a>:</h4>
<p>yeah, don't quite know how to implement this myself</p>



<a name="204547849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204547849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204547849">(Jul 21 2020 at 13:36)</a>:</h4>
<p>not really too familiar with mir <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="204547910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204547910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204547910">(Jul 21 2020 at 13:37)</a>:</h4>
<p>should I try and implement this myself?</p>



<a name="204547960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204547960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204547960">(Jul 21 2020 at 13:37)</a>:</h4>
<p>have the time for this rn</p>



<a name="204548703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204548703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204548703">(Jul 21 2020 at 13:44)</a>:</h4>
<p>I'm still worried we'll break valid code</p>



<a name="204548813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204548813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204548813">(Jul 21 2020 at 13:45)</a>:</h4>
<p>so I want to somewhat quickly get const wf bounds working</p>



<a name="204548902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204548902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204548902">(Jul 21 2020 at 13:46)</a>:</h4>
<p>step 0: add the ability to add bounds? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="204548946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204548946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204548946">(Jul 21 2020 at 13:46)</a>:</h4>
<p>step 0: add future compat warning<br>
step 1: add bounds</p>



<a name="204548948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204548948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204548948">(Jul 21 2020 at 13:46)</a>:</h4>
<p>I'd feel much better about adding constraints if there's an "escape" hatch</p>



<a name="204549054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549054">(Jul 21 2020 at 13:47)</a>:</h4>
<p>I'd be fine with doing both in one PR, but I'd wager that adding bounds is hard</p>



<a name="204549232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549232">(Jul 21 2020 at 13:49)</a>:</h4>
<p>mixing that with the future compat warning seems fragile/bitrotty</p>



<a name="204549275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549275">(Jul 21 2020 at 13:49)</a>:</h4>
<p>but I may be overreacting here</p>



<a name="204549342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549342">(Jul 21 2020 at 13:49)</a>:</h4>
<p>My main concern is that it will take a while for const wf bounds to hit stable</p>



<a name="204549403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549403">(Jul 21 2020 at 13:50)</a>:</h4>
<p>so we can't really just impl both at the same time (or we can, but it won't help people on stable)</p>



<a name="204549432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549432">(Jul 21 2020 at 13:50)</a>:</h4>
<p>ah</p>



<a name="204549459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549459">(Jul 21 2020 at 13:50)</a>:</h4>
<p>but we can turn on the future incompat lint together with the feature gate</p>



<a name="204549691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549691">(Jul 21 2020 at 13:52)</a>:</h4>
<p>aaaaaaaaaa</p>



<a name="204549713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549713">(Jul 21 2020 at 13:52)</a>:</h4>
<p>I would turn this into a hard error together with the feature gate tbh <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="204549826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549826">(Jul 21 2020 at 13:53)</a>:</h4>
<p>ok... how about we stop dodging around hypotheticals and you do the future compat warning as a hard error for crater and see how bad it is</p>



<a name="204549857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549857">(Jul 21 2020 at 13:53)</a>:</h4>
<p>then we can turn it into a future incompat lint</p>



<a name="204549974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204549974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204549974">(Jul 21 2020 at 13:54)</a>:</h4>
<p>I think a compat lint which says "hey, what you are doing is dangerous and will stop compiling in the future, consider replacing the contained type variables with dummy values for now, see issue #XXXXX for more details" should always be on</p>



<a name="204550023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204550023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204550023">(Jul 21 2020 at 13:55)</a>:</h4>
<p>Will do so, I don't think we encounter this too frequently</p>



<a name="204550047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204550047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204550047">(Jul 21 2020 at 13:55)</a>:</h4>
<p>jup, but it's good to have numbers</p>



<a name="204554918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204554918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204554918">(Jul 21 2020 at 14:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VALUE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span>::<span class="n">VALUE</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204555000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204555000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204555000">(Jul 21 2020 at 14:36)</a>:</h4>
<p>I think this fails with that check, let me quickly add this as a test</p>



<a name="204555382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204555382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204555382">(Jul 21 2020 at 14:39)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="p">());</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LENGTH</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">LENGTH</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204555728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204555728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204555728">(Jul 21 2020 at 14:42)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">PhantomData</span><span class="p">;</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">S</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">m1</span>: <span class="nc">PhantomData</span><span class="o">&lt;&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">m2</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">S</span>::<span class="n">size</span><span class="p">()],</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">S</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">size</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204555925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204555925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204555925">(Jul 21 2020 at 14:43)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VALUE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">VALUE</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204555957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204555957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204555957">(Jul 21 2020 at 14:43)</a>:</h4>
<p>^ the last one is interesting... do we want to allow that?</p>



<a name="204556118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204556118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204556118">(Jul 21 2020 at 14:44)</a>:</h4>
<p>Aaaaaaaaaaah, the horror</p>



<a name="204556955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204556955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204556955">(Jul 21 2020 at 14:51)</a>:</h4>
<p>We can't just use <code>unused_generic_params</code> here, because afaik that works on optimized mir</p>



<a name="204557536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204557536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204557536">(Jul 21 2020 at 14:54)</a>:</h4>
<p>so we pretty much need to run something similar to <code>unused_generic_params</code> directly after <code>mir_built</code> and then check that all used generic params are concrete in the substs of the given unevaluated const</p>



<a name="204557989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204557989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204557989">(Jul 21 2020 at 14:57)</a>:</h4>
<p>As this is also user facing behavior we can't really use a shortcut and only consider the first<code>n</code>(64 for polymorphization) generic parameters, so that may end up costing some perf</p>



<a name="204559338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559338">(Jul 21 2020 at 15:06)</a>:</h4>
<p>what's the problem with moving it to using <code>mir_built</code>?</p>



<a name="204559424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559424">(Jul 21 2020 at 15:07)</a>:</h4>
<p>That we want <code>unused_generic_params</code> to run on optimized mir, as we want as many unused params as possible</p>



<a name="204559527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559527">(Jul 21 2020 at 15:08)</a>:</h4>
<p>so this check and polymorphization have somewhat contradictory goals</p>



<a name="204559654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559654">(Jul 21 2020 at 15:09)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116107">@davidtwco</span> both how expensive is <code>unused_generic_params</code> and using dynamic allocation instead of <code>Bitset&lt;u64&gt;</code> and did you try using it on <code>mir_built</code> instead of <code>optimized_mir</code>?</p>



<a name="204559683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559683">(Jul 21 2020 at 15:09)</a>:</h4>
<p>ooh</p>



<a name="204559868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559868">(Jul 21 2020 at 15:10)</a>:</h4>
<p>wait, but why do you care about unsued generic params? I thought you just wanted to plainly forbid all generic params used in constants?</p>



<a name="204559872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559872">(Jul 21 2020 at 15:10)</a>:</h4>
<p>It used a normal <code>BitSet</code> originally which didn’t have that limitation - eddy suggested changing it but it wasn’t that expensive IIRC.</p>



<a name="204559970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204559970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204559970">(Jul 21 2020 at 15:11)</a>:</h4>
<p>I haven’t tried using <code>mir_built</code> - that might be more expensive if it’s traversing a lot more MIR; I assume it’d still work though.</p>



<a name="204560162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560162">(Jul 21 2020 at 15:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/.60ConstEvaluatable.60.20generic.20functions/near/204559868">said</a>:</p>
<blockquote>
<p>wait, but why do you care about unsued generic params? I thought you just wanted to plainly forbid all generic params used in constants?</p>
</blockquote>
<p>Because I want to allow</p>
<div class="codehilite"><pre><span></span><code><span class="k">fn</span> <span class="nf">test</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204560346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560346">(Jul 21 2020 at 15:14)</a>:</h4>
<p>Let me think about this a bit more</p>



<a name="204560353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560353">(Jul 21 2020 at 15:14)</a>:</h4>
<p>right. Can you get that by checking if <code>tcx.optimized_mir(def_id_of_anon_const).needs_subst()</code>?</p>



<a name="204560484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560484">(Jul 21 2020 at 15:15)</a>:</h4>
<p><code>tcx.mir_built(def_id_of_anon_const).needs_subst()</code> may work, or just checking if type/const params exist, we don't care about lifetimes</p>



<a name="204560520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560520">(Jul 21 2020 at 15:15)</a>:</h4>
<p>That would mean that we deal with "local" anon consts differently to other consts though, does it?</p>



<a name="204560665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560665">(Jul 21 2020 at 15:16)</a>:</h4>
<p>not sure I understand</p>



<a name="204560685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560685">(Jul 21 2020 at 15:16)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VALUE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span>::<span class="n">VALUE</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204560709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560709">(Jul 21 2020 at 15:17)</a>:</h4>
<p>the mir of <code>Foo::&lt;u8&gt;::VALUE</code> still needs substs</p>



<a name="204560735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560735">(Jul 21 2020 at 15:17)</a>:</h4>
<p>so <code>tcx.mir_built(def_id_of_anon_const).needs_subst()</code> would fail here</p>



<a name="204560765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560765">(Jul 21 2020 at 15:17)</a>:</h4>
<p>hmm</p>



<a name="204560785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204560785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204560785">(Jul 21 2020 at 15:17)</a>:</h4>
<p>so we should check for this const if the substs of the unevaluated consts are all fully concrete (ignoring lifetimes)</p>



<a name="204561041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561041">(Jul 21 2020 at 15:19)</a>:</h4>
<p>so... we have the situation where we have an <code>Unevaluated</code> pointing to an associated generic const, there we just need to check whether the substs are concrete, yes, but if you have an anon-const, that anon const will have the substs of the surrounding function in scope no matter if it uses them</p>



<a name="204561053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561053">(Jul 21 2020 at 15:19)</a>:</h4>
<p>so there you'd need to look at the MIR</p>



<a name="204561193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561193">(Jul 21 2020 at 15:20)</a>:</h4>
<p>that might work <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="204561203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561203">(Jul 21 2020 at 15:20)</a>:</h4>
<p>at least it's worth trying</p>



<a name="204561391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561391">(Jul 21 2020 at 15:21)</a>:</h4>
<p>oh and you need to compute this on the mir_built, so at the same time that <code>required_consts</code> is computed</p>



<a name="204561451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561451">(Jul 21 2020 at 15:21)</a>:</h4>
<p>you can't query the <code>mir_built</code> except in the <code>mir_const</code> query</p>



<a name="204561598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561598">(Jul 21 2020 at 15:22)</a>:</h4>
<p>added a <code>bool</code> to <code>mir::Body</code> for now</p>



<a name="204561609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561609">(Jul 21 2020 at 15:22)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="204561626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204561626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204561626">(Jul 21 2020 at 15:22)</a>:</h4>
<p>we can always turn it into a query later</p>



<a name="204563223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204563223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204563223">(Jul 21 2020 at 15:33)</a>:</h4>
<p>looks good! thanks for helping me figuring this out <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> time to start a crater run for now</p>



<a name="204567272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204567272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204567272">(Jul 21 2020 at 16:04)</a>:</h4>
<p>opened <a href="https://github.com/rust-lang/rust/issues/74595">#74595</a></p>



<a name="204718848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204718848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204718848">(Jul 22 2020 at 20:30)</a>:</h4>
<p>concerning const wf bounds, we need some syntax for them if we don't just want to use <code>[u8; expression]:,</code> for this</p>



<a name="204718996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204718996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204718996">(Jul 22 2020 at 20:31)</a>:</h4>
<p>I personally quite like </p>
<div class="codehilite"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()),</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204719498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204719498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204719498">(Jul 22 2020 at 20:36)</a>:</h4>
<p>Wait, do we want to automatically consider mentions of <code>[T; expr]</code> in where bounds as a const wf bound on expr?</p>



<a name="204719540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204719540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204719540">(Jul 22 2020 at 20:37)</a>:</h4>
<p>That would allow us to get the implementation done without having to worry about syntax and design stuff</p>



<a name="204719565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204719565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204719565">(Jul 22 2020 at 20:37)</a>:</h4>
<p>which is quite nice™</p>



<a name="204771221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771221">(Jul 23 2020 at 08:21)</a>:</h4>
<p>I think we need to require wf on array length consts</p>



<a name="204771319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771319">(Jul 23 2020 at 08:23)</a>:</h4>
<p>So what I am thinking about:</p>
<div class="codehilite"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()]</span>: <span class="nc">Trait</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204771338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771338">(Jul 23 2020 at 08:23)</a>:</h4>
<p>does this imply that <code>std::mem::size_of::&lt;T&gt;()</code> computes successfully inside of <code>foo</code></p>



<a name="204771353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771353">(Jul 23 2020 at 08:23)</a>:</h4>
<p>I think it should</p>



<a name="204771419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771419">(Jul 23 2020 at 08:24)</a>:</h4>
<p>I agree</p>



<a name="204771835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771835">(Jul 23 2020 at 08:29)</a>:</h4>
<p>So about the design here. We probably want to relate the hir/mir of consts in the body with the hir/mir of the where bounds.</p>



<a name="204771859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771859">(Jul 23 2020 at 08:29)</a>:</h4>
<p>Similar to how we relate types in <code>TypeRelation</code></p>



<a name="204771969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771969">(Jul 23 2020 at 08:30)</a>:</h4>
<p>So it would probably be "cleaner" to do this on <code>optimized_mir</code>, but I am kind of afraid of strange optimization stuff happening and having to deal with promoteds and stuff</p>



<a name="204771988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204771988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204771988">(Jul 23 2020 at 08:31)</a>:</h4>
<p>while working on hir probably just requires walking the ast tree</p>



<a name="204772106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204772106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204772106">(Jul 23 2020 at 08:32)</a>:</h4>
<p>with a very liberal usage of "just"</p>



<a name="204776968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204776968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204776968">(Jul 23 2020 at 09:35)</a>:</h4>
<p>Also, should we allow</p>
<div class="codehilite"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204777025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777025">(Jul 23 2020 at 09:36)</a>:</h4>
<p>considering that the return type of a function is also part of the public api this makes sense to me</p>



<a name="204777027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777027">(Jul 23 2020 at 09:36)</a>:</h4>
<p>without needing a where bound here</p>



<a name="204777044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777044">(Jul 23 2020 at 09:36)</a>:</h4>
<p>uh</p>



<a name="204777072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777072">(Jul 23 2020 at 09:37)</a>:</h4>
<p>we can start out with the simple variant</p>



<a name="204777082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777082">(Jul 23 2020 at 09:37)</a>:</h4>
<p>and figure out improvements later</p>



<a name="204777184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777184">(Jul 23 2020 at 09:38)</a>:</h4>
<p>I don't think also inferring const wf from the function API will be a big effort, but yeah, the main priority is probably just get where bounds working here</p>



<a name="204777187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777187">(Jul 23 2020 at 09:38)</a>:</h4>
<p>you can implement the <code>required_const_bounds</code> by creating a query that runs on <code>mir_const</code> or <code>mir_validated</code></p>



<a name="204777211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777211">(Jul 23 2020 at 09:38)</a>:</h4>
<p>you just need to run it wherever the query that you depend on is stolen</p>



<a name="204777216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204777216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204777216">(Jul 23 2020 at 09:38)</a>:</h4>
<p>(before the stealing of course ^^)</p>



<a name="204781542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204781542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> boats <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204781542">(Jul 23 2020 at 10:36)</a>:</h4>
<p>I've only skimmed this discussion, but my impression is there's consensus this shouldn't be allowed for now regardless of whether or not you use the type parameter in the body of the fn?</p>



<a name="204781560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204781560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> boats <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204781560">(Jul 23 2020 at 10:36)</a>:</h4>
<p>From a lang perspective, we try not to have the bodies of functions leak information like this does</p>



<a name="204782340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204782340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204782340">(Jul 23 2020 at 10:49)</a>:</h4>
<p>I think so.</p>
<p>One concern brought up by <span class="user-mention" data-user-id="124288">@oli</span> is that by forbidding this, we have a breaking change which can't really be circumvented before const wf bounds are on stable (which we will hopefully be able to get to nightly in the next few weeks).</p>



<a name="204782417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204782417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204782417">(Jul 23 2020 at 10:50)</a>:</h4>
<p>So for example <code>let _ = [0; std::mem::size_of::&lt;*mut T&gt;()]</code> is a lot more expressive than <code>let _ = [0; std::mem::size_of::&lt;*mut ConcreteDummy&gt;()]</code></p>



<a name="204783007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/%60ConstEvaluatable%60%20generic%20functions/near/204783007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> boats <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/.60ConstEvaluatable.60.20generic.20functions.html#204783007">(Jul 23 2020 at 10:59)</a>:</h4>
<p>Yea we'll see how crater turns out and decide what to do</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>