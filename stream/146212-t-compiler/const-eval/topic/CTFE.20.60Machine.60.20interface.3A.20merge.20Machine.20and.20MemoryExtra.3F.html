<html>
<head><meta charset="utf-8"><title>CTFE `Machine` interface: merge Machine and MemoryExtra? · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html">CTFE `Machine` interface: merge Machine and MemoryExtra?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275852989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275852989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275852989">(Mar 18 2022 at 19:40)</a>:</h4>
<p>When implementing a Machine instance, it is somewhat arbitrary to put things into the Machine itself vs putting them into MemoryExtra. Both exist exactly once globally. However, MemoryExtra is actually available in more places, so ultimately putting things there is "more powerful". In Miri we have thus gradually moved fields from the machine to MemoryExtra.<br>
I wonder if we should just go all-in on this, and move the <code>machine: M</code> field from <code>InterpCx</code> to <code>Memory</code>, and entirely remove <code>MemoryExtra</code>. Does anyone see a problem with that approach (other than it being slightly odd)?</p>



<a name="275853223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275853223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275853223">(Mar 18 2022 at 19:42)</a>:</h4>
<p>honestly at that point there is barely anything left in <code>InterpCx</code>: the <code>tcx</code> is duplicated in <code>Memory</code>, so what's left is param_env and recursion_limit. So the alternative would be to just make all the methods on <code>Memory</code> (that need access to <code>machine</code> or <code>tcx</code> or so) instead methods on <code>InterpCx</code> (and get rid of both <code>MemoryExtra</code> and the <code>tcx</code> field in <code>Memory</code>). I think I like that more, TBH. The memory split predates splitting <code>Allocation</code> into its entirely own thing so we still have <em>some</em> layering going on even after basically merging the InterpCx and Memory layers.</p>



<a name="275907216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275907216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275907216">(Mar 19 2022 at 12:06)</a>:</h4>
<p>I like making memory more independent!</p>



<a name="275907236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275907236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275907236">(Mar 19 2022 at 12:07)</a>:</h4>
<p>We could consider moving memory earlier in the compilation, too, basically making it only depend on allocations and the basic mir interpret types</p>



<a name="275913653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275913653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275913653">(Mar 19 2022 at 14:43)</a>:</h4>
<p>I am proposing to make memory <em>less</em> independent</p>



<a name="275913699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275913699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275913699">(Mar 19 2022 at 14:44)</a>:</h4>
<p>basically I am suggesting that the attempt to make it independent doesn't actually work, as we keep having to move things into memory so that they are available in places where we need them</p>



<a name="275913718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275913718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275913718">(Mar 19 2022 at 14:45)</a>:</h4>
<p>the parts of memory that can reasonable be made independent are already moved to <code>Allocation</code></p>



<a name="275925109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275925109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275925109">(Mar 19 2022 at 19:20)</a>:</h4>
<p>Well... memory operations moved onto InterpCx makes the Memory struct more independent, as it can stop caring about the things that need the machine</p>



<a name="275926031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275926031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275926031">(Mar 19 2022 at 19:42)</a>:</h4>
<p>Just offering this up because I think it's related.</p>
<p>The "tag was created here and invalidated here" diagnostics I'm working on currently produce much better errors than things like a use after free. I glanced over the code related to use after free errors and it wasn't clear to me that I could implement similar diagnostics for them, because I couldn't find a good place to add all the state that is required.</p>
<p>I kind of feel like the end state (heh) is having an InterpCx passed to most/all functions so that we can retrieve information about interpreter state when errors happen, or store state in it when certain events happen.</p>
<p>An alternative, which I implemented in an earlier branch, is doing a <code>map_err</code> once an error bubbles up to a function that has an InterpCx and thus can paste on the additional information. That doesn't seem like a good design to me.</p>



<a name="275926143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275926143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275926143">(Mar 19 2022 at 19:45)</a>:</h4>
<p>For example, stacked borrows is very neatly factored... Except for the &amp;GlobalState that is passed to nearly everything that doesn't have an InterpCx.</p>



<a name="275990205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275990205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275990205">(Mar 20 2022 at 22:02)</a>:</h4>
<p>we'll never be able to pass an <code>InterpCx</code> to the <code>memory_{read,written}</code> hooks, since those <em>also</em> borrow an <code>Allocation</code> that is part of the <code>InterpCx</code></p>



<a name="275990214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275990214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275990214">(Mar 20 2022 at 22:03)</a>:</h4>
<p>otherwise I think we already pass it basically everywhere?</p>



<a name="275990218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/275990218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#275990218">(Mar 20 2022 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F/near/275926143">said</a>:</p>
<blockquote>
<p>For example, stacked borrows is very neatly factored... Except for the &amp;GlobalState that is passed to nearly everything that doesn't have an InterpCx.</p>
</blockquote>
<p>how is GlobalState violating the "neat factoring"? being passed to everything is exactly its point :)</p>



<a name="277654297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/CTFE%20%60Machine%60%20interface%3A%20merge%20Machine%20and%20MemoryExtra%3F/near/277654297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/CTFE.20.60Machine.60.20interface.3A.20merge.20Machine.20and.20MemoryExtra.3F.html#277654297">(Apr 03 2022 at 18:39)</a>:</h4>
<p>I prepared a PR for this: <a href="https://github.com/rust-lang/rust/pull/95620">https://github.com/rust-lang/rust/pull/95620</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>