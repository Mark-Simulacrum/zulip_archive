<html>
<head><meta charset="utf-8"><title>const_fn_fn_ptr_basics · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html">const_fn_fn_ptr_basics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268760091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/268760091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#268760091">(Jan 20 2022 at 21:24)</a>:</h4>
<p>What is the status of the <code>const_fn_fn_ptr_basics</code> feature? I see that it's marked as unstable. Is there more that needs to be implemented, or is there anything blocking stabilization?</p>



<a name="268818628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/268818628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#268818628">(Jan 21 2022 at 09:53)</a>:</h4>
<p>Hmm... do we have a tracking issue for that? Can't find it on mobile</p>



<a name="268833651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/268833651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#268833651">(Jan 21 2022 at 12:16)</a>:</h4>
<p>Maybe this <a href="https://github.com/rust-lang/rust/issues/63997">https://github.com/rust-lang/rust/issues/63997</a> ("Tracking issue for const fn pointers")?</p>



<a name="268837488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/268837488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#268837488">(Jan 21 2022 at 12:50)</a>:</h4>
<p>ah yea... the lang team basically said I need to open a PR that allows function pointers in const fn without making them callable and then we can FCP that</p>



<a name="268837513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/268837513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#268837513">(Jan 21 2022 at 12:50)</a>:</h4>
<p>I should have more time for such things next week</p>



<a name="268873464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/268873464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#268873464">(Jan 21 2022 at 17:19)</a>:</h4>
<p>Sounds good. I can probably lend some cycles to help if you need them!</p>



<a name="269657385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269657385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269657385">(Jan 27 2022 at 23:32)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span>  - I spent a little bit of time today poking at different test cases, and it seems like we might have pretty close to the behavior we want already. Here are a couple of playground links with examples:</p>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=640938f255c5ee28e4d149495a1f12b3">Function pointers can't be called in const code</a></li>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=664f29be0b63efe5e3af18cc9d88beac">Can create and pass function pointers in const code</a></li>
</ul>
<p>Are there more cases that are still missing?</p>



<a name="269657457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269657457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269657457">(Jan 27 2022 at 23:33)</a>:</h4>
<p>The error message in the first case could be a little better though...</p>



<a name="269707905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269707905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269707905">(Jan 28 2022 at 09:24)</a>:</h4>
<p>The error message may be better soon, there's a PR in flight for it</p>



<a name="269708172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269708172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269708172">(Jan 28 2022 at 09:26)</a>:</h4>
<p>But yes, we just need to "stabilize" the feature. I just want to do this together with trait objects and trait bounds, which need a tiny bit of care.</p>



<a name="269776604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269776604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269776604">(Jan 28 2022 at 18:02)</a>:</h4>
<p>Ah, great! What's left with trait bounds? Is it something you'd like help on?</p>



<a name="269776667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269776667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269776667">(Jan 28 2022 at 18:02)</a>:</h4>
<p>(I have a colleague who's eager to use these features, so if I can help move them towards stabilization I'd be happy to!)</p>



<a name="269784466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269784466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269784466">(Jan 28 2022 at 18:54)</a>:</h4>
<p>Cool, basically most of the work is making a PR that stabilizes all the features and removes all the feature checks. I just remember that we had something redundant in trait bound checks that may be annoying to remove. Feel free to give it a go and even open a partial PR. I do recommend tackling one feature gate per commit though, as it will make rebasing easier if you get merge conflicts in the ui tests</p>



<a name="269786855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269786855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269786855">(Jan 28 2022 at 19:08)</a>:</h4>
<p>It might be good to go ahead and do the stabilizations at the same time but in separate PRs rather than trying to FCP them together. Or do you explicitly want them FCP'd together <span class="user-mention" data-user-id="124288">@oli</span> ?</p>



<a name="269789501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269789501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269789501">(Jan 28 2022 at 19:29)</a>:</h4>
<p>Yea, together, they are all gated for the same reason... we wanted them to mean something different in const fn, and now we just want to treat them like we treat them in const items</p>



<a name="269807580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269807580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269807580">(Jan 28 2022 at 21:50)</a>:</h4>
<p>What does this feature enable? The tracking issue is the generic const fn one last I checked.</p>



<a name="269815773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269815773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269815773">(Jan 28 2022 at 23:05)</a>:</h4>
<p><code>const_fn_fn_ptr_basics</code> lets you pass around function pointers in const code, you just can't call them. I'm not sure what <code>const_fn_trait_bounds</code> does yet.</p>



<a name="269834207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/269834207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#269834207">(Jan 29 2022 at 03:25)</a>:</h4>
<p>I see no reason that shouldn't be allowed on stable.</p>



<a name="271214712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271214712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271214712">(Feb 09 2022 at 00:38)</a>:</h4>
<p>I got some time to work on this today. I still need to update tests, but here's what I've got for a stabilization PR: <a href="https://github.com/eholk/rust/commit/02856253eaeb6d29afd073a7e5e716d22ec481af">https://github.com/eholk/rust/commit/02856253eaeb6d29afd073a7e5e716d22ec481af</a></p>



<a name="271222486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271222486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271222486">(Feb 09 2022 at 02:24)</a>:</h4>
<p>A once-over on mobile, but the diff looks good.</p>



<a name="271326772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271326772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271326772">(Feb 09 2022 at 18:36)</a>:</h4>
<p>I've got most of the tests working now, but I'm stumped on <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/min_const_fn/allow_const_fn_ptr.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui/consts/min_const_fn/allow_const_fn_ptr.rs</a></p>



<a name="271326838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271326838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271326838">(Feb 09 2022 at 18:37)</a>:</h4>
<p>The stderr from the test is currently:</p>
<div class="codehilite"><pre><span></span><code>error: module has missing stability attribute
  --&gt; /home/ericholk/repo/rust/src/test/ui/consts/min_const_fn/allow_const_fn_ptr.rs:1:1
   |
LL | / #![feature(rustc_attrs, staged_api, rustc_allow_const_fn_unstable)]
LL | |
LL | | #[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
LL | | #[rustc_const_stable(since=&quot;1.0.0&quot;, feature = &quot;mep&quot;)]
...  |
LL | |
LL | | fn main() {}
   | |____________^

error: aborting due to previous error
</code></pre></div>



<a name="271326925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271326925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271326925">(Feb 09 2022 at 18:37)</a>:</h4>
<p>I removed the three lines that contain <code>const_fn_fn_ptr_basics</code>, but I'm not sure how to add the missing stability attribute.</p>



<a name="271326993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271326993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271326993">(Feb 09 2022 at 18:38)</a>:</h4>
<p>More generally, I'm not sure what this test is supposed to be testing.</p>



<a name="271327751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271327751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271327751">(Feb 09 2022 at 18:43)</a>:</h4>
<p>Reads to me like the test is for the use of <code>#[rustc_allow_const_fn_unstable(const_fn_fn_ptr_basics)]</code> which (I think) allows the standard library to use this feature in stable apis even without requiring the calling code to have the feature enabled. If we're stabilizing the feature, then I don't think we need this test anymore.</p>



<a name="271327835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271327835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271327835">(Feb 09 2022 at 18:44)</a>:</h4>
<p>sounds good. I'll delete it then!</p>



<a name="271330089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271330089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271330089">(Feb 09 2022 at 19:00)</a>:</h4>
<p>alright, I just put up the pull request: <a href="https://github.com/rust-lang/rust/pull/93827">https://github.com/rust-lang/rust/pull/93827</a></p>



<a name="271330226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271330226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271330226">(Feb 09 2022 at 19:01)</a>:</h4>
<p>I noticed <a href="https://github.com/rust-lang/rust/issues/93706">#93706</a> says there still needs to be a documentation PR. Does anyone know the state of that or what's needed?</p>



<a name="271402495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271402495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271402495">(Feb 10 2022 at 08:57)</a>:</h4>
<p>Awesome! Looked over it and it lgtm. If you want you can also throw const_impl_trait out in the same PR.</p>
<p>Wrt documentation, all that needs updating is the reference in  <a href="https://doc.rust-lang.org/stable/reference/const_eval.html?highlight=Const#const-functions">https://doc.rust-lang.org/stable/reference/const_eval.html?highlight=Const#const-functions</a></p>



<a name="271406639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics/near/271406639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/const_fn_fn_ptr_basics.html#271406639">(Feb 10 2022 at 09:39)</a>:</h4>
<p>Please also remove <code>ops::ty::DynTrait</code> as well as <code>ops::ty::TraitBoundNotConst</code>. <code>dyn</code> should be part of the stabilization and the latter was obsolete after I introduced <code>~const</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>