<html>
<head><meta charset="utf-8"><title>inline const too powerful? · t-compiler/const-eval · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/index.html">t-compiler/const-eval</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html">inline const too powerful?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249434158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249434158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249434158">(Aug 14 2021 at 02:28)</a>:</h4>
<p>If my reading of <a href="https://github.com/rust-lang/rfcs/issues/2920">rfc#2920</a> is correct, inline const blocks are basically just const items with types inferred. But currently it can refer to const parameters like array repeat length (well, since it's implemented with the same code). This seems to be more powerful than the RFC suggests it should be.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(inline_const)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">V</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="p">;</span><span class="w"> </span><span class="c1">// Not allowed</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">V</span><span class="p">];</span><span class="w"> </span><span class="c1">// Okay</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// Okay, but should it?</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249434792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249434792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249434792">(Aug 14 2021 at 02:44)</a>:</h4>
<p>From the RFC:</p>
<blockquote>
<p>the long-term goal is to allow array length expressions to use generic parameters. When this happens, inline const expressions and patterns will also be allowed to refer to in-scope generics.</p>
</blockquote>



<a name="249434815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249434815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249434815">(Aug 14 2021 at 02:45)</a>:</h4>
<p>I believe the RFC text talks about type parameters but didn't mention about const parameters</p>



<a name="249434856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249434856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249434856">(Aug 14 2021 at 02:45)</a>:</h4>
<p>const parameters are a kind of generic parameter</p>



<a name="249435294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249435294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249435294">(Aug 14 2021 at 02:58)</a>:</h4>
<p>I guess that means the</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UNIQUE_IDENT</span>: <span class="nc">Ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.;</span><span class="w"> </span><span class="n">UNIQUE_IDENT</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>part is not very accurate then. Personally I am okay with it being either restrictive or expressive, but I just want to make sure that this isn't an oversight</p>



<a name="249435595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249435595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249435595">(Aug 14 2021 at 03:04)</a>:</h4>
<p>Why isn't <code>const X: usize = V;</code> allowed?</p>



<a name="249437271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249437271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249437271">(Aug 14 2021 at 03:18)</a>:</h4>
<p>That's <a href="https://doc.rust-lang.org/error-index.html#E0401">E0401</a>.</p>



<a name="249437280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249437280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249437280">(Aug 14 2021 at 03:19)</a>:</h4>
<p>It turns out <a href="https://github.com/rust-lang/rust/issues/82518">#82518</a> is caused by inline consts being too powerful. "Investigate handling of const parameters in patterns." is still listed as a remaining issue of const generics.</p>



<a name="249437346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249437346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249437346">(Aug 14 2021 at 03:20)</a>:</h4>
<p>Now I am leaning towards restricting inline consts from accessing generic parameters.</p>



<a name="249437995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249437995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249437995">(Aug 14 2021 at 03:35)</a>:</h4>
<p>What did you expect to happen there?<br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4427534951a1342079ee8292a9fda0ea">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4427534951a1342079ee8292a9fda0ea</a></p>
<div class="codehilite"><pre><span></span><code>fn foo&lt;const V: usize&gt;() {
  match 0 {
    V =&gt; {},
    _ =&gt; {},
  }
}
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error[E0158]: const parameters cannot be referenced in patterns
 --&gt; src/lib.rs:4:5
  |
4 |     V =&gt; {},
  |     ^

error: aborting due to previous error
</code></pre></div>



<a name="249438418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249438418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249438418">(Aug 14 2021 at 03:44)</a>:</h4>
<p>I think <code>const</code> items <em>should</em> be able to refer to the generic parameters of the enclosing function, the fact that they can't seems like an artificial limitation.</p>



<a name="249438807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249438807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249438807">(Aug 14 2021 at 03:53)</a>:</h4>
<p>inline consts can be used in pattern position. We could say that "only inline consts in expression position can refer to const params" but that'll be confusing</p>



<a name="249438960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249438960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249438960">(Aug 14 2021 at 03:56)</a>:</h4>
<p>From my perspective, you're arguing that being able to use generic parameters in scope should be more verbose, because one is forced to use associated constants.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">V</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// Not allowed</span>
<span class="w">    </span><span class="s">"Ab"</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>↕↕↕↕<br>
(this side compiles)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">V</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">V</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"Ab"</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">Self</span>::<span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">Foo</span>::<span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span>::<span class="n">call</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249440104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440104">(Aug 14 2021 at 04:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/inline.20const.20too.20powerful.3F/near/249438807">said</a>:</p>
<blockquote>
<p>We could say that "only inline consts in expression position can refer to const params" but that'll be confusing</p>
</blockquote>
<p>Those are already the rules for associated constants that use generic parameters(eg: <code>Foo::&lt;X&gt;::BAR</code>) in patterns:</p>
<div class="codehilite"><pre><span></span><code>error: constant pattern depends on a generic parameter
 --&gt; src/lib.rs:9:9
  |
9 |         Foo::&lt;X&gt;::BAR =&gt; 100,
  |         ^^^^^^^^^^^^^
</code></pre></div>
<p>and directly using the const parameter as a pattern:</p>
<div class="codehilite"><pre><span></span><code>error[E0158]: const parameters cannot be referenced in patterns
 --&gt; src/lib.rs:4:5
  |
4 |     V =&gt; {},
  |     ^

error: aborting due to previous error
</code></pre></div>



<a name="249440433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440433">(Aug 14 2021 at 04:30)</a>:</h4>
<p>those follow very different code path from inline consts though</p>



<a name="249440444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440444">(Aug 14 2021 at 04:31)</a>:</h4>
<p>E.g. const params in patterns are checked in THIR construction</p>



<a name="249440498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440498">(Aug 14 2021 at 04:32)</a>:</h4>
<p>While inline consts are eagerly evaluated so that their values are known before THIR of the containing function is even constructed</p>



<a name="249440514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440514">(Aug 14 2021 at 04:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/inline.20const.20too.20powerful.3F/near/249440498">said</a>:</p>
<blockquote>
<p>While inline consts are eagerly evaluated so that their values are known before THIR of the containing function is even constructed</p>
</blockquote>
<p>Huh? Why is that how inline const has to always work?</p>



<a name="249440611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440611">(Aug 14 2021 at 04:35)</a>:</h4>
<p>This looks to me like you're looking into how it's currently implemented, and then saying "welp, no way it can work how you want it to".</p>



<a name="249440990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249440990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249440990">(Aug 14 2021 at 04:45)</a>:</h4>
<p>It should be possible for inline consts that don't refer to any generic parameters in scope to be evaluated eagerly, while those that do wouldn't be <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="249442142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249442142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249442142">(Aug 14 2021 at 05:18)</a>:</h4>
<p>I suppose what's currently doable without duplicating diagnostic generation is to check ty::Const for Param during THIR construction, so it'll be</p>
<div class="codehilite"><pre><span></span><code>error[E0158]: const parameters cannot be referenced in patterns
 --&gt; src/lib.rs:5:11
  |
5 |     const { V } =&gt; {},
  |           ^^^^^
</code></pre></div>
<p>couldn't pinpoint to V anymore since AnonConst has been evaluated already, but good enough for now.</p>



<a name="249442505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249442505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249442505">(Aug 14 2021 at 05:29)</a>:</h4>
<p>Analogous to <a href="#narrow/stream/146212-t-compiler.2Fconst-eval/topic/inline.20const.20too.20powerful.3F/near/249440990">what I said</a> about inline const,<br>
associated constants that come from concrete types are evaluated eagerly,<br>
so that this generic function errors without ever being used<br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=00b7ceaa472fd1226360542cf5c88921">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=00b7ceaa472fd1226360542cf5c88921</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">Foo</span>::<span class="n">X</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error: this operation will panic at runtime
 --&gt; src/lib.rs:8:13
  |
8 |     let _ = [0][Foo::X];
  |             ^^^^^^^^^^^ index out of bounds: the length is 1 but the index is 10
  |
  = note: `#[deny(unconditional_panic)]` on by default
</code></pre></div>
<p>While constants coming from generic types<br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=0862a8b35ba9e24f34788f1fd92ebe11">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=0862a8b35ba9e24f34788f1fd92ebe11</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">marker</span>::<span class="n">PhantomData</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">loop</span><span class="p">{};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bar</span>::<span class="n">X</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>are only evaluated when the function is called with concrete types</p>
<div class="codehilite"><pre><span></span><code>error: any use of this value will cause an error
 --&gt; src/main.rs:6:26
  |
6 |     const X: Option&lt;T&gt; = loop{};
  |     ---------------------^^^^^^-
  |                          |
  |                          exceeded interpreter step limit (see `#[const_eval_limit]`)
  |
  = note: `#[deny(const_err)]` on by default
  = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!
  = note: for more information, see issue #71800 &lt;https://github.com/rust-lang/rust/issues/71800&gt;

error: aborting due to previous error
</code></pre></div>
<p>(this doesn't error when <code>foo::&lt;u32&gt;()</code> is commented out)</p>



<a name="249442780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249442780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249442780">(Aug 14 2021 at 05:36)</a>:</h4>
<p>Basically I keep seeing parallels between associated constants and inline const, so it woudn't seem at all confusing if the error was the same for both</p>
<div class="codehilite"><pre><span></span><code>error: constant pattern depends on a generic parameter
 --&gt; src/lib.rs:9:9
  |
9 |         Foo::&lt;X&gt;::BAR =&gt; 100,
  |         ^^^^^^^^^^^^^
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error: inline const pattern depends on a generic parameter
 --&gt; src/lib.rs:9:9
  |
9 |         const{ foo(X) } =&gt; 100,
  |         ^^^^^^^^^^^^^^^
</code></pre></div>



<a name="249443635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249443635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249443635">(Aug 14 2021 at 06:01)</a>:</h4>
<blockquote>
<p>let _ = [0][Foo::X];</p>
</blockquote>
<p>IIRC This is done by MIR const prop pass, so it's pretty late</p>



<a name="249444342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249444342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249444342">(Aug 14 2021 at 06:24)</a>:</h4>
<p>Can we stick to user-facing semantics? I don't care how this is implemented.</p>
<p>If I had just learnt about inline const, I would expect it to just work with generic parameters, and would find it more surprising that it doesn't work at all than I would find that "inline const pattern depends on a generic parameter" error.</p>



<a name="249452181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249452181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249452181">(Aug 14 2021 at 10:04)</a>:</h4>
<p>patterns are special here, they participate in exhaustiveness checking, which needs to know the actual value. we can treat them as unknown/opaque, but that needs an rfc. inline consts in expressions should def support generics, following the same rules as array lengths</p>



<a name="249459186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146212-t-compiler/const-eval/topic/inline%20const%20too%20powerful%3F/near/249459186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/146212-t-compiler/const-eval/topic/inline.20const.20too.20powerful.3F.html#249459186">(Aug 14 2021 at 13:07)</a>:</h4>
<p>yeah generics should work -- and indeed then the desugaring does not literally work any more, though morally it is still accruate</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>