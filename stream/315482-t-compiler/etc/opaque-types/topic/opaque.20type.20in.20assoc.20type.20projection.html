<html>
<head><meta charset="utf-8"><title>opaque type in assoc type projection · t-compiler/etc/opaque-types · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/index.html">t-compiler/etc/opaque-types</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html">opaque type in assoc type projection</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272835849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272835849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272835849">(Feb 22 2022 at 17:16)</a>:</h4>
<p>The following snippet stops compiling with lazy TAIT but works on master. The reason for that is that we stop eagerly replacing nested opaque types with inference variables. Instead we leave the opaque types opaque, causing breakage when associated type normalization generates inference vars for the associated types and compares those (as the inference var now gets resolved to the opaque type instead of the hidden type)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Duh</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Duh</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Assoc</span>: <span class="nc">Duh</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// the fact that `R` is the `::Output` projection on `F` causes</span>
<span class="c1">// an intermediate inference var to be generated which is then later</span>
<span class="c1">// compared against the actually found `Assoc` type.</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">R</span>: <span class="nc">Duh</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// The `impl Send` here is then later compared against the inference var</span>
<span class="c1">// created, causing the inference var to be set to `impl Send` instead of</span>
<span class="c1">// the hidden type. We already have obligations registered on the inference</span>
<span class="c1">// var to make it uphold the `: Duh` bound on `Trait::Assoc`. The opaque</span>
<span class="c1">// type does not implement `Duh`, even if its hidden type does. So we error out.</span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//~^ ERROR `impl Send: Duh` is not satisfied</span>
<span class="w">    </span><span class="o">||</span><span class="w"> </span><span class="mi">42</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272836098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272836098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272836098">(Feb 22 2022 at 17:17)</a>:</h4>
<p>Note that</p>



<a name="272836192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272836192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272836192">(Feb 22 2022 at 17:18)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Duh</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Duh</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Assoc</span>: <span class="nc">Duh</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span>: <span class="nc">Duh</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mi">42</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>compiles fine, we specifically need the impl to have a projection in its bounds</p>



<a name="272837267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272837267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272837267">(Feb 22 2022 at 17:25)</a>:</h4>
<p>Note that this breakage was only found in a single crate: <a href="https://github.com/andrewhickman/mock-server">https://github.com/andrewhickman/mock-server</a></p>
<p>cc <span class="user-mention" data-user-id="353015">@Andrew Hickman</span> I'm not even sure this was ever meant to compile, as it's very confusing to have an <code>impl Send</code> satisfy any bound other than <code>Send</code>, but alas, this seems to have been stable for at least two years now <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="272837779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272837779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272837779">(Feb 22 2022 at 17:29)</a>:</h4>
<p>Then again, it's fairly logical how the compiler comes to this conclusion. it sees the <code>42</code> and starts looking for impls, and during this whole process, uses <code>i32</code> for <code>F</code> in the impl, which all succeeds. The only thing that happens then is that <code>F</code> (which is <code>i32</code>) gets compared to <code>impl Send</code>, because of checking whether the impl's assoc types match the specified assoc types</p>



<a name="272838983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272838983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272838983">(Feb 22 2022 at 17:37)</a>:</h4>
<p>A hacky way to fix this would be to change <a href="https://github.com/rust-lang/rust/blob/1e2f63de0a5e9a32d97d355f6351665e77455be2/compiler/rustc_trait_selection/src/traits/project.rs#L216-L228">https://github.com/rust-lang/rust/blob/1e2f63de0a5e9a32d97d355f6351665e77455be2/compiler/rustc_trait_selection/src/traits/project.rs#L216-L228</a> to prefer setting hidden types to inference vars over resolving the inference var to an opaque type</p>



<a name="272948763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/opaque%20type%20in%20assoc%20type%20projection/near/272948763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/opaque.20type.20in.20assoc.20type.20projection.html#272948763">(Feb 23 2022 at 13:36)</a>:</h4>
<p>I did the quick hack by re-using the back-compat-hack function that I already used for two other regressions, so <a href="https://github.com/rust-lang/rust/pull/94081">https://github.com/rust-lang/rust/pull/94081</a> now resolves all the issues found in crater</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>