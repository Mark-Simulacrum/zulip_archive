<html>
<head><meta charset="utf-8"><title>#84657 unsound TAIT lifetimes · t-compiler/etc/opaque-types · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/index.html">t-compiler/etc/opaque-types</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/.2384657.20unsound.20TAIT.20lifetimes.html">#84657 unsound TAIT lifetimes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277158848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/%2384657%20unsound%20TAIT%20lifetimes/near/277158848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/.2384657.20unsound.20TAIT.20lifetimes.html#277158848">(Mar 30 2022 at 15:04)</a>:</h4>
<p>In the linked issue, the defining use</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">_defining_use</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">b</span> <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="p">())</span><span class="w"> </span>-&gt; <span class="nc">Converter</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>implies <code>'a: 'b</code> (can be added explicitly, too). The opaque type does not have this outlives bound, and since it's a TAIT, we can directly invoke methods on it. Those methods are run on the hidden type's impl, and can now be mis-used because the impl for <code>&amp;'b &amp;'a ()</code> can rightly rely on the outlives bound. The bug is that this defining use is accepted.</p>



<a name="277159119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/%2384657%20unsound%20TAIT%20lifetimes/near/277159119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/.2384657.20unsound.20TAIT.20lifetimes.html#277159119">(Mar 30 2022 at 15:06)</a>:</h4>
<p>For RPIT this is not an issue, because you actually need to invoke the function with a valid argument: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=3208524b2dcf9efc9aad7e49bc735065">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=3208524b2dcf9efc9aad7e49bc735065</a></p>



<a name="277159404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/%2384657%20unsound%20TAIT%20lifetimes/near/277159404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/.2384657.20unsound.20TAIT.20lifetimes.html#277159404">(Mar 30 2022 at 15:08)</a>:</h4>
<p>we already check that the defining uses don't have stricter trait bounds than the opaque type definition, I guess we failed to check the same for outlives bounds</p>



<a name="277160452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/%2384657%20unsound%20TAIT%20lifetimes/near/277160452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/.2384657.20unsound.20TAIT.20lifetimes.html#277160452">(Mar 30 2022 at 15:15)</a>:</h4>
<p>TLDR:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Underconstrained</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span>: <span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Send</span><span class="p">;</span><span class="w"></span>

<span class="c1">// no `'b: 'a` bound</span>
<span class="k">fn</span> <span class="nf">underconstrain</span><span class="o">&lt;'</span><span class="na">x</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">y</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Underconstrained</span><span class="o">&lt;'</span><span class="na">x</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">y</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//~^ should error here, but doesn't right now</span>
<span class="w">    </span><span class="fm">unimplemented!</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277163205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/%2384657%20unsound%20TAIT%20lifetimes/near/277163205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/.2384657.20unsound.20TAIT.20lifetimes.html#277163205">(Mar 30 2022 at 15:35)</a>:</h4>
<p>Hmm... I wonder if we can make</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">type</span> <span class="nc">Underconstrained</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Send</span><span class="p">;</span><span class="w"></span>

<span class="c1">// no `Trait` bound</span>
<span class="k">fn</span> <span class="nf">underconstrain</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Trait</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Underconstrained</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//~^ ERROR the trait bound `T: Trait`</span>
<span class="w">    </span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>unsound, too?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>