<html>
<head><meta charset="utf-8"><title>rpit refactor · t-compiler/etc/opaque-types · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/index.html">t-compiler/etc/opaque-types</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html">rpit refactor</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271859417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/271859417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#271859417">(Feb 14 2022 at 17:26)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="144729" href="/#narrow/stream/144729-wg-traits/topic/rpit.20refactor">#wg-traits &gt; rpit refactor</a> by <span class="user-mention silent" data-user-id="124288">oli</span>.</p>



<a name="271904489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/271904489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#271904489">(Feb 14 2022 at 23:27)</a>:</h4>
<p>Is this thread to track re-landing the lazy tait pr?</p>



<a name="271942828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/271942828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#271942828">(Feb 15 2022 at 08:50)</a>:</h4>
<p>No, I was just trying to move all the threads over to this stream for organization purposes</p>



<a name="274003369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274003369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274003369">(Mar 03 2022 at 17:00)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="274003404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274003404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274003404">(Mar 03 2022 at 17:01)</a>:</h4>
<p>just got ...</p>



<a name="274003422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274003422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274003422">(Mar 03 2022 at 17:01)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0277]: the size for values of type `My-T` cannot be known at compilation time
  --&gt; /home/spastorino/src/oss/rust4/src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:51
   |
LL | fn ident_as_my_trait&lt;&#39;a, T&gt;(_u: &amp;&#39;a i32, t: T) -&gt; impl MyTrait&lt;T&gt;
   |                          -                        ^^^^^^^^^^^^^^^ doesn&#39;t have a size known at compile-time
   |                          |
   |                          this type parameter needs to be `std::marker::Sized`
</code></pre></div>



<a name="274003458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274003458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274003458">(Mar 03 2022 at 17:01)</a>:</h4>
<p>interesting ...</p>



<a name="274003504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274003504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274003504">(Mar 03 2022 at 17:01)</a>:</h4>
<p>and another test that was failing is now passing</p>



<a name="274004852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274004852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274004852">(Mar 03 2022 at 17:10)</a>:</h4>
<p>looks like there's still a mix-up between the duplicated and original generics</p>



<a name="274004926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274004926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274004926">(Mar 03 2022 at 17:11)</a>:</h4>
<p>oh</p>



<a name="274004931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274004931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274004931">(Mar 03 2022 at 17:11)</a>:</h4>
<p>hold up</p>



<a name="274004946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274004946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274004946">(Mar 03 2022 at 17:11)</a>:</h4>
<p>that's just a diagnostic bug</p>



<a name="274005001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274005001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274005001">(Mar 03 2022 at 17:11)</a>:</h4>
<p>ha, it's working. The error is probably because we only duplicate the generic params but not their bounds</p>



<a name="274005024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274005024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274005024">(Mar 03 2022 at 17:11)</a>:</h4>
<p>so it's missing the implicit <code>Sized</code> bound</p>



<a name="274027995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274027995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274027995">(Mar 03 2022 at 19:42)</a>:</h4>
<p>I guess I should be copying here <a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L821">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L821</a> instead of passing <code>&amp;[]</code></p>



<a name="274037170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274037170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274037170">(Mar 03 2022 at 20:46)</a>:</h4>
<p>well, this set is empty, I guess I should be calling some kind of query that gives me not only the bounds that come from the AST but also the computes ones</p>



<a name="274037839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274037839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274037839">(Mar 03 2022 at 20:51)</a>:</h4>
<p>I'm not sure if the problem I'm having right now is because I'd need to properly lower param bounds on ast lowering and in particular compute the implicit ones or that's something that needs to be computed on typeck when building args</p>



<a name="274039532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274039532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274039532">(Mar 03 2022 at 21:02)</a>:</h4>
<p>I'm not exactly sure where auto trait bounds are materialized</p>



<a name="274039583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274039583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274039583">(Mar 03 2022 at 21:02)</a>:</h4>
<p>I'd guess somewhere on <code>astconv</code></p>



<a name="274039762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274039762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274039762">(Mar 03 2022 at 21:04)</a>:</h4>
<p>Before trying to add bounds: what exactly is the error? is it a duplicate of the "normal" error?</p>



<a name="274039962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274039962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274039962">(Mar 03 2022 at 21:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274003422">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>error[E0277]: the size for values of type `My-T` cannot be known at compilation time
  --&gt; /home/spastorino/src/oss/rust4/src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:51
   |
LL | fn ident_as_my_trait&lt;&#39;a, T&gt;(_u: &amp;&#39;a i32, t: T) -&gt; impl MyTrait&lt;T&gt;
   |                          -                        ^^^^^^^^^^^^^^^ doesn&#39;t have a size known at compile-time
   |                          |
   |                          this type parameter needs to be `std::marker::Sized`
</code></pre></div><br>
</p>
</blockquote>
<p><span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="274040051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040051">(Mar 03 2022 at 21:06)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> as @<strong>_oli</strong> have said, I guess we are missing bounds for generic parameters</p>



<a name="274040117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040117">(Mar 03 2022 at 21:07)</a>:</h4>
<p>went ahead and copied them over without thinking that much but then realized that the set was empty (probably something I should have done since the beginning anyway) but is not helping in this case because these are auto traits, so those are not going to show up on ast lowering</p>



<a name="274040251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040251">(Mar 03 2022 at 21:08)</a>:</h4>
<p>I think we need something like <a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L1670">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L1670</a> to get the where bounds to put onto <a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L1751">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L1751</a></p>



<a name="274040368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040368">(Mar 03 2022 at 21:09)</a>:</h4>
<p>hmm, <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="274040583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040583">(Mar 03 2022 at 21:10)</a>:</h4>
<p>Tho, that only works for where bounds I guess... you're right in that we should also add the non-where bounds in <a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L821">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L821</a></p>



<a name="274040606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040606">(Mar 03 2022 at 21:11)</a>:</h4>
<p>Probably better to start out with that and go to where bounds later</p>



<a name="274040867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274040867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274040867">(Mar 03 2022 at 21:13)</a>:</h4>
<p>They are lowered in <a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L2275">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L2275</a></p>



<a name="274041385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041385">(Mar 03 2022 at 21:18)</a>:</h4>
<p>ohh I've gone a different route</p>



<a name="274041430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041430">(Mar 03 2022 at 21:18)</a>:</h4>
<p>it's not working though</p>



<a name="274041468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041468">(Mar 03 2022 at 21:18)</a>:</h4>
<p>Probably need to start tracking the bounds via <a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L917">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_ast_lowering/src/lib.rs#L917</a>, too, but not sure yet how (on mobile, can't help much rn)</p>



<a name="274041474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041474">(Mar 03 2022 at 21:18)</a>:</h4>
<p>the problem I'm seeing is that <code>param.bounds</code> is empty</p>



<a name="274041508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041508">(Mar 03 2022 at 21:18)</a>:</h4>
<p>Uhm</p>



<a name="274041529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041529">(Mar 03 2022 at 21:18)</a>:</h4>
<p>Where? ^^</p>



<a name="274041577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041577">(Mar 03 2022 at 21:19)</a>:</h4>
<p>param is the stuff that's passed to <code>generic_param_from_name</code></p>



<a name="274041649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041649">(Mar 03 2022 at 21:19)</a>:</h4>
<p>it's a <code>GenericParam</code></p>



<a name="274041651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041651">(Mar 03 2022 at 21:19)</a>:</h4>
<p>so from AST</p>



<a name="274041738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041738">(Mar 03 2022 at 21:20)</a>:</h4>
<p>but I'm not sure how something from the AST would have that kind of information, if it's never written down</p>



<a name="274041747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041747">(Mar 03 2022 at 21:20)</a>:</h4>
<p>it's not that the code says <code>T: Send</code></p>



<a name="274041749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041749">(Mar 03 2022 at 21:20)</a>:</h4>
<p>Ah I see, that makes more sense than my approach I guess</p>



<a name="274041790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041790">(Mar 03 2022 at 21:20)</a>:</h4>
<p>yeah, but the thing is ... where/how do I find <code>Send</code> bound there?</p>



<a name="274041817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041817">(Mar 03 2022 at 21:21)</a>:</h4>
<p>I was guessing that that was not going to be found on ast lowering</p>



<a name="274041837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041837">(Mar 03 2022 at 21:21)</a>:</h4>
<p>more likely on <code>astconv</code> or somewhere in <code>typeck</code> ?</p>



<a name="274041861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041861">(Mar 03 2022 at 21:21)</a>:</h4>
<p><code>Send</code>?</p>



<a name="274041907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041907">(Mar 03 2022 at 21:21)</a>:</h4>
<p>I meant, the information that <code>Send</code> is a bound of <code>T</code> in <code>fn ident_as_my_trait&lt;'a, T&gt;(_u: &amp;'a i32, t: T) -&gt; impl MyTrait&lt;T&gt;</code></p>



<a name="274041913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041913">(Mar 03 2022 at 21:21)</a>:</h4>
<p>Where is <code>Send</code> coming from? Your error mentions <code>Sized</code></p>



<a name="274041987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041987">(Mar 03 2022 at 21:22)</a>:</h4>
<p>the <code>Sized</code> is added if <code>?Sized</code> is missing later, so that's a separate issue probably</p>



<a name="274041999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274041999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274041999">(Mar 03 2022 at 21:22)</a>:</h4>
<p>sorry, I meant, <code>Sized</code>, anyway, auto traits :)</p>



<a name="274042026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042026">(Mar 03 2022 at 21:22)</a>:</h4>
<p>Ah ok</p>



<a name="274042105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042105">(Mar 03 2022 at 21:23)</a>:</h4>
<p>Yea, there is no <code>Sized</code> here, but somewhere we imply <code>Sized</code> if no <code>?Sized</code> bound exists</p>



<a name="274042126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042126">(Mar 03 2022 at 21:23)</a>:</h4>
<p>right</p>



<a name="274042183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042183">(Mar 03 2022 at 21:23)</a>:</h4>
<p>that's what I'm looking for and I'd guess that happens on <code>astconv</code>? or somewhere on <code>typeck</code>?</p>



<a name="274042346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042346">(Mar 03 2022 at 21:24)</a>:</h4>
<p>No clue, but you can go through the mentions of <code>sized_trait</code> or whatever the lang item function is called</p>



<a name="274042371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042371">(Mar 03 2022 at 21:25)</a>:</h4>
<p>Or possibly SizedTrait for the enum variant</p>



<a name="274042458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042458">(Mar 03 2022 at 21:25)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="274042871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042871">(Mar 03 2022 at 21:29)</a>:</h4>
<p>It does happen in <code>astconv</code></p>



<a name="274042888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042888">(Mar 03 2022 at 21:29)</a>:</h4>
<p>I think something like <code>add_implied_sized_bound</code></p>



<a name="274042898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274042898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274042898">(Mar 03 2022 at 21:29)</a>:</h4>
<p>or something like that</p>



<a name="274043126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274043126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274043126">(Mar 03 2022 at 21:30)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/32cbc7630b2d6b7141e2588f91380c1a58cf0016/compiler/rustc_typeck/src/astconv/mod.rs#L900">https://github.com/rust-lang/rust/blob/32cbc7630b2d6b7141e2588f91380c1a58cf0016/compiler/rustc_typeck/src/astconv/mod.rs#L900</a></p>



<a name="274043354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274043354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274043354">(Mar 03 2022 at 21:32)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="274043373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274043373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274043373">(Mar 03 2022 at 21:32)</a>:</h4>
<p>gonna check how/where is called</p>



<a name="274043456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274043456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274043456">(Mar 03 2022 at 21:32)</a>:</h4>
<p>right, on <code>gather_explicit_predicates_of</code></p>



<a name="274043621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274043621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274043621">(Mar 03 2022 at 21:34)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_typeck/src/collect.rs#L2180">https://github.com/rust-lang/rust/blob/4c245bfca05ef0bec7ba2fe24acfb06022765fc8/compiler/rustc_typeck/src/collect.rs#L2180</a></p>



<a name="274043783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274043783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274043783">(Mar 03 2022 at 21:35)</a>:</h4>
<p>I guess this needs a completely different treatment now</p>



<a name="274045678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274045678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274045678">(Mar 03 2022 at 21:53)</a>:</h4>
<p>Yea, with your feature gate you need to not early return and instead fall through to the TAIT arm</p>



<a name="274115472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274115472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274115472">(Mar 04 2022 at 11:29)</a>:</h4>
<p>right, this is what I did but no luck</p>



<a name="274116763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274116763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274116763">(Mar 04 2022 at 11:43)</a>:</h4>
<p>Sorry, can't help today. I guess try to follow the trail of that error and see where the bound (or lack thereof) comes from</p>



<a name="274116796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274116796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274116796">(Mar 04 2022 at 11:43)</a>:</h4>
<p>Like turn on tracing, run with and without your gate and compare the output</p>



<a name="274168026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274168026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274168026">(Mar 04 2022 at 18:15)</a>:</h4>
<p>so ... was investigating a bit</p>



<a name="274168088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274168088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274168088">(Mar 04 2022 at 18:16)</a>:</h4>
<p><code>gather_explicit_predicates_of</code> is never called on this <code>OpaqueTy</code></p>



<a name="274168130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274168130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274168130">(Mar 04 2022 at 18:16)</a>:</h4>
<p>it's called on a <code>Trait</code>, <code>Impl</code> and <code>Fn</code> but not on a <code>OpaqueTy</code></p>



<a name="274168155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274168155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274168155">(Mar 04 2022 at 18:16)</a>:</h4>
<p>checking calls to this function, maybe for some reason is skipped and shouldn't</p>



<a name="274169442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274169442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274169442">(Mar 04 2022 at 18:27)</a>:</h4>
<p>I'm finding stuff like</p>



<a name="274169561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274169561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274169561">(Mar 04 2022 at 18:28)</a>:</h4>
<div class="codehilite"><pre><span></span><code>DEBUG rustc_typeck::collect predicates_of(def_id=DefId(0:7 ~ generics_assoc_type[66f0]::ident_as_my_trait)) = GenericPredicates { parent: None, predicates: [(Binder(TraitPredicate(&lt;T as std::marker::Sized&gt;,      polarity:Positive), []), src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:26: 9:27 (#0)), (Binder(OutlivesPredicate(ReStatic, ReEarlyBound(0, &#39;a)), []), src/test/ui/impl-trait/v2/generics-assoc-type.rs:11:     14: 11:16 (#0))] }
</code></pre></div>



<a name="274169581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274169581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274169581">(Mar 04 2022 at 18:28)</a>:</h4>
<p>but not finding the bound for <code>My-T</code></p>



<a name="274169850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274169850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274169850">(Mar 04 2022 at 18:30)</a>:</h4>
<p>ohh this is probably coming from <code>explicit_item_bounds</code></p>



<a name="274169897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274169897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274169897">(Mar 04 2022 at 18:31)</a>:</h4>
<p>in particular from <a href="https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/collect/item_bounds.rs#L71">https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/collect/item_bounds.rs#L71</a> I'd guess</p>



<a name="274171153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274171153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274171153">(Mar 04 2022 at 18:38)</a>:</h4>
<p>What part of the compiler emits the error?  Does this happen with anything other than <code>Sized</code>?</p>



<a name="274175265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274175265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274175265">(Mar 04 2022 at 19:09)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  ├─0ms DEBUG rustc_typeck::collect::item_bounds HERE: predicates=[(Binder(TraitPredicate(&lt;Opaque(DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), [My-T]) as std::marker::Sized&gt;, polarit     y:Positive), []), src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:51: 9:66 (#3)), (Binder(TraitPredicate(&lt;Opaque(DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), [My-T]) as MyTrait&lt;     My-T&gt;&gt;, polarity:Positive), []), src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:56: 9:66 (#0))]
</code></pre></div>



<a name="274175342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274175342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274175342">(Mar 04 2022 at 19:10)</a>:</h4>
<p>found that <code>item_bounds</code> and so <code>explicit_item_bounds</code> are returning the right thing</p>



<a name="274175662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274175662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274175662">(Mar 04 2022 at 19:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274171153">said</a>:</p>
<blockquote>
<p>What part of the compiler emits the error?  Does this happen with anything other than <code>Sized</code>?</p>
</blockquote>
<p>happening in this query <a href="https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/lib.rs#L530">https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/lib.rs#L530</a></p>



<a name="274175787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274175787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274175787">(Mar 04 2022 at 19:14)</a>:</h4>
<p>more precisely <a href="https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L453">https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L453</a></p>



<a name="274175924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274175924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274175924">(Mar 04 2022 at 19:14)</a>:</h4>
<p>the error exactly comes from here <a href="https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L675-L678">https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L675-L678</a></p>



<a name="274175943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274175943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274175943">(Mar 04 2022 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> anyway, you get the idea :)</p>



<a name="274176007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274176007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274176007">(Mar 04 2022 at 19:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274175342">said</a>:</p>
<blockquote>
<p>found that <code>item_bounds</code> and so <code>explicit_item_bounds</code> are returning the right thing</p>
</blockquote>
<p>given that this is returning the right thing, unsure what's going on really</p>



<a name="274176245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274176245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274176245">(Mar 04 2022 at 19:18)</a>:</h4>
<p>hmm maybe <code>substs</code> here <a href="https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L767-L768">https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L767-L768</a> are not correct?</p>



<a name="274178959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274178959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274178959">(Mar 04 2022 at 19:40)</a>:</h4>
<p><code>substs</code> at that point contains <code>My-T</code></p>



<a name="274179046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274179046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274179046">(Mar 04 2022 at 19:41)</a>:</h4>
<p>this is the sequence of events ...</p>



<a name="274179063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274179063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274179063">(Mar 04 2022 at 19:41)</a>:</h4>
<div class="codehilite"><pre><span></span><code>   2 DEBUG rustc_typeck::collect::type_of concrete_ty = My-T
   1 ┐rustc_typeck::check::check::check_opaque_meets_bounds def_id=DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), substs=[My-T], span=src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:51     : 9:66 (#3), origin=FnReturn(DefId(0:7 ~ generics_assoc_type[66f0]::ident_as_my_trait))
838  ├─0ms DEBUG rustc_typeck::check::check HERE: HERE: hir_id=HirId { owner: DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), local_id: 0 }
   1 ├─0ms DEBUG rustc_typeck::check::check HERE: HERE: substs=[My-T]
   2 ├─0ms DEBUG rustc_typeck::check::check HERE: HERE: opaque_ty=Opaque(DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), [My-T])
   3 ├─0ms DEBUG rustc_typeck::check::inherited register_predicate(Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::marker::Sized&gt;, polarity:Positive), []), cause=ObligationCause { span: src/test/ui/impl-     trait/v2/generics-assoc-type.rs:9:51: 9:66 (#3), body_id: HirId { owner: DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), local_id: 0 }, code: Some(OpaqueType) }, param_env=ParamEnv {      caller_bounds: [Binder(OutlivesPredicate(ReStatic, ReEarlyBound(0, &#39;a)), []), Binder(TraitPredicate(&lt;T as std::marker::Sized&gt;, polarity:Positive), [])], reveal: UserFacing, constness: NotConst }, depth=0))
   4 ├─0ms DEBUG rustc_typeck::check::inherited register_predicate(Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as MyTrait&lt;My-T&gt;&gt;, polarity:Positive), []), cause=ObligationCause { span: src/test/ui/impl-trait     /v2/generics-assoc-type.rs:9:51: 9:66 (#3), body_id: HirId { owner: DefId(0:10 ~ generics_assoc_type[66f0]::ident_as_my_trait::{opaque#0}), local_id: 0 }, code: Some(OpaqueType) }, param_env=ParamEnv { calle     r_bounds: [Binder(OutlivesPredicate(ReStatic, ReEarlyBound(0, &#39;a)), []), Binder(TraitPredicate(&lt;T as std::marker::Sized&gt;, polarity:Positive), [])], reveal: UserFacing, constness: NotConst }, depth=0))
   5 ├─0ms DEBUG rustc_typeck::check::check HERE: HERE: hidden substs=[My-T]
   6 ├─0ms DEBUG rustc_typeck::check::check HERE: HERE: hidden_type=My-T
   7 ├─0ms TRACE rustc_typeck::check::check hidden_type=My-T
   8 error[E0277]: the size for values of type `My-T` cannot be known at compilation time
   9  --&gt; src/test/ui/impl-trait/v2/generics-assoc-type.rs:9:51
  10   |
  11 9 | fn ident_as_my_trait&lt;&#39;a, T&gt;(_u: &amp;&#39;a i32, t: T) -&gt; impl MyTrait&lt;T&gt;
  12   |                          -                        ^^^^^^^^^^^^^^^ doesn&#39;t have a size known at compile-time
  13   |                          |
  14   |                          this type parameter needs to be `std::marker::Sized`
</code></pre></div>



<a name="274179918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274179918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274179918">(Mar 04 2022 at 19:48)</a>:</h4>
<p>I guess the problem is here <a href="https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L767">https://github.com/rust-lang/rust/blob/e8e52bd1dc27fe0f5f7936fb85139932faef3f73/compiler/rustc_typeck/src/check/check.rs#L767</a></p>



<a name="274179969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274179969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274179969">(Mar 04 2022 at 19:49)</a>:</h4>
<p>and I should be grabbing <code>generics</code>/<code>bounds</code> from the <code>OpaqueTy</code> and come with the corresponding <code>substs</code> but not 100% sure</p>



<a name="274183513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274183513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274183513">(Mar 04 2022 at 20:18)</a>:</h4>
<p>This indeed semms like a ParamEnv issue.  Should we subtitute <code>T</code> into <code>My-T</code> in the ParamEnv, or would it just be worse?</p>



<a name="274183610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274183610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274183610">(Mar 04 2022 at 20:20)</a>:</h4>
<p>Where does this ParamEnv come from? Why does it have a bound on <code>T</code>?</p>



<a name="274183783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274183783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274183783">(Mar 04 2022 at 20:21)</a>:</h4>
<p>The ParamEnv comes from L644, so it contains all the bounds the defining function has.  But all of them are on <code>T</code> instead of <code>My-T</code>.</p>



<a name="274185648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274185648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274185648">(Mar 04 2022 at 20:39)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> thanks for your thoughts, <span class="user-mention" data-user-id="232957">@Jack Huey</span> was also chatting to me</p>



<a name="274185693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274185693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274185693">(Mar 04 2022 at 20:40)</a>:</h4>
<p>it's fixed</p>



<a name="274185707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274185707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274185707">(Mar 04 2022 at 20:40)</a>:</h4>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>    let defining_use_anchor = match *origin {<span class="w"></span>
<span class="gd">-        hir::OpaqueTyOrigin::FnReturn(did) | hir::OpaqueTyOrigin::AsyncFn(did) =&gt; did,</span><span class="w"></span>
<span class="gi">+        hir::OpaqueTyOrigin::FnReturn(did) =&gt; {</span><span class="w"></span>
<span class="gi">+            if tcx.sess.features_untracked().return_position_impl_trait_v2 { def_id } else { did }</span><span class="w"></span>
<span class="gi">+        }</span><span class="w"></span>
<span class="gi">+        hir::OpaqueTyOrigin::AsyncFn(did) =&gt; did,</span><span class="w"></span>
<span class="w"> </span>        hir::OpaqueTyOrigin::TyAlias =&gt; def_id,<span class="w"></span>
</code></pre></div>



<a name="274185735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274185735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274185735">(Mar 04 2022 at 20:40)</a>:</h4>
<p>we were getting <code>param_env</code> using the function instead of the <code>def_id</code> of the opaque type</p>



<a name="274609348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274609348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274609348">(Mar 08 2022 at 21:26)</a>:</h4>
<p>another problem that I'm having right now is ...</p>



<a name="274609422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274609422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274609422">(Mar 08 2022 at 21:26)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Captures</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Captures</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_lifetime</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Captures</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274609442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274609442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274609442">(Mar 08 2022 at 21:26)</a>:</h4>
<blockquote>
<p>error: internal compiler error: compiler/rustc_middle/src/ty/subst.rs:635:17: type parameter <code>T/#1</code> (T/1) out of range when substituting, substs=[T]</p>
</blockquote>



<a name="274609489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274609489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274609489">(Mar 08 2022 at 21:26)</a>:</h4>
<p>and I see this in the logs ...</p>



<a name="274609559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274609559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274609559">(Mar 08 2022 at 21:27)</a>:</h4>
<blockquote>
<p>├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [My-T])], item_def_id:      DefId(2:7919 ~ core[23f5]::iter::traits::iterator::Iterator::Item) }, Ty(Opaque(DefId(0:11 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}::{opaque#0}), [T]))), [])</p>
</blockquote>



<a name="274609616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274609616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274609616">(Mar 08 2022 at 21:27)</a>:</h4>
<p>no idea why there are 2 elements in <code>substs</code> there</p>



<a name="274612178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274612178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274612178">(Mar 08 2022 at 21:47)</a>:</h4>
<p>I'm guessing that projection obligation is coming from fold_opaque_ty, so I recommend logging that function and checking out whether it's already broken there</p>



<a name="274729238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274729238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274729238">(Mar 09 2022 at 18:10)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> as you have said the problem originates here <a href="https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L489">https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L489</a></p>



<a name="274729294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274729294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274729294">(Mar 09 2022 at 18:10)</a>:</h4>
<p>the content of <code>ty</code>, <code>opaque_type_key</code> and <code>origin</code> are ...</p>



<a name="274729316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274729316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274729316">(Mar 09 2022 at 18:10)</a>:</h4>
<div class="codehilite"><pre><span></span><code>│ ├─0ms DEBUG rustc_infer::infer::opaque_types HERE: ty=Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [T])
│ ├─0ms DEBUG rustc_infer::infer::opaque_types HERE: opaque_type_key=OpaqueTypeKey { def_id: DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), substs: [T] }
│ ├─0ms DEBUG rustc_infer::infer::opaque_types HERE: origin=FnReturn(DefId(0:7 ~ nested_return_type[c165]::nested_assoc_type))
</code></pre></div>



<a name="274729627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274729627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274729627">(Mar 09 2022 at 18:13)</a>:</h4>
<p>then inside <code>fold_opaque_ty</code> here <a href="https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L549">https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L549</a></p>



<a name="274729637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274729637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274729637">(Mar 09 2022 at 18:13)</a>:</h4>
<p>we get</p>



<a name="274729651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274729651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274729651">(Mar 09 2022 at 18:13)</a>:</h4>
<blockquote>
<p>│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types HERE: item_bounds=[(Binder(TraitPredicate(&lt;Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [My-T]) as std::marker::Sized&gt;, polarity:Positive), []), src/test/ui/impl-trait/v2/nested-return-type.rs:10:38: 10:70 (<a href="https://github.com/rust-lang/rust/issues/3">#3</a>)), (Binder(TraitPredicate(&lt;Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [My-T]) as std::iter::Iterator&gt;, polarity:Positive), []), src/test/ui/impl-trait/v2/nested-return-type.rs:10:43: 10:70 (<a href="https://github.com/rust-lang/rust/issues/0">#0</a>)), (Binder(ProjectionPredicate(ProjectionTy { substs: [Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [My-T])], item_def_id: DefId(2:7919 ~ core[23f5]::iter::traits::iterator::Iterator::Item) }, Ty(Opaque(DefId(0:11 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}::{opaque#0}), [T]))), []), src/test/ui/impl-trait/v2/nested-return-type.rs:10:52: 10:69 (<a href="https://github.com/rust-lang/rust/issues/0">#0</a>))]</p>
</blockquote>



<a name="274733033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733033">(Mar 09 2022 at 18:40)</a>:</h4>
<p>then after that we iterate over the <code>item_bounds</code></p>



<a name="274733041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733041">(Mar 09 2022 at 18:40)</a>:</h4>
<p>the last bound is</p>



<a name="274733052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733052">(Mar 09 2022 at 18:41)</a>:</h4>
<blockquote>
<p>│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [My-T])], item_def_id: DefId(2:7919 ~ core[23f5]::iter::traits::iterator::Iterator::Item) }, Ty(Opaque(DefId(0:11 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}::{opaque#0}), [T]))), [])</p>
</blockquote>



<a name="274733141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733141">(Mar 09 2022 at 18:41)</a>:</h4>
<p>and when it calls <code>predicate.subst(tcx, substs);</code> in <a href="https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L555">https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L555</a></p>



<a name="274733393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733393">(Mar 09 2022 at 18:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274733052">said</a>:</p>
<blockquote>
<blockquote>
<p>│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [Opaque(DefId(0:10 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}), [My-T])], item_def_id: DefId(2:7919 ~ core[23f5]::iter::traits::iterator::Iterator::Item) }, Ty(Opaque(DefId(0:11 ~ nested_return_type[c165]::nested_assoc_type::{opaque#0}::{opaque#0}), [T]))), [])</p>
</blockquote>
</blockquote>
<p>predicate is the one from here <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="274733496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733496">(Mar 09 2022 at 18:44)</a>:</h4>
<p>and subst comes from <code>opaque_type_key</code> from above, which is <code>substs: [T]</code></p>



<a name="274733523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733523">(Mar 09 2022 at 18:44)</a>:</h4>
<p>that's where we get ...</p>



<a name="274733528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733528">(Mar 09 2022 at 18:44)</a>:</h4>
<blockquote>
<p>error: internal compiler error: compiler/rustc_middle/src/ty/subst.rs:635:17: type parameter <code>T/#1</code> (T/1) out of range when substituting, substs=[T]</p>
</blockquote>



<a name="274733549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733549">(Mar 09 2022 at 18:44)</a>:</h4>
<p>anyway unsure why/how</p>



<a name="274733877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274733877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274733877">(Mar 09 2022 at 18:47)</a>:</h4>
<p>I'd guess the impl trait inside the impl trait is somehow not being set up correctly but I can't see why/how</p>



<a name="274734366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274734366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274734366">(Mar 09 2022 at 18:50)</a>:</h4>
<p>Where is the <code>T/#1</code> type in the predicate?</p>



<a name="274734897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274734897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274734897">(Mar 09 2022 at 18:54)</a>:</h4>
<p>yeah, I'm not sure, I don't see that</p>



<a name="274735119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274735119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274735119">(Mar 09 2022 at 18:56)</a>:</h4>
<p>is it that last <code>T</code>? (Is this <code>-Zverbose</code>?)</p>



<a name="274735466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274735466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274735466">(Mar 09 2022 at 18:59)</a>:</h4>
<p><code>-Zverbose</code> yeah</p>



<a name="274735606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274735606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274735606">(Mar 09 2022 at 19:00)</a>:</h4>
<p>if it's <code>T</code> and not <code>My-T</code> is the <code>T</code> that's coming from the function definition</p>



<a name="274735680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274735680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274735680">(Mar 09 2022 at 19:00)</a>:</h4>
<p>unsure what you do you mean by last</p>



<a name="274735999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274735999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274735999">(Mar 09 2022 at 19:02)</a>:</h4>
<p>I mean, the <code>T</code> in the <code>Opaque</code> substs</p>



<a name="274736025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736025">(Mar 09 2022 at 19:02)</a>:</h4>
<p>probably - that's the only <code>T</code> I see</p>



<a name="274736043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736043">(Mar 09 2022 at 19:02)</a>:</h4>
<p>yeah</p>



<a name="274736078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736078">(Mar 09 2022 at 19:02)</a>:</h4>
<p>just in case</p>



<a name="274736084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736084">(Mar 09 2022 at 19:02)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Check that nested impl Trait items work in functions with generic parameters.</span>
<span class="c1">// check-pass</span>

<span class="cp">#![feature(return_position_impl_trait_v2)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Captures</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Captures</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;'</span><span class="na">a</span>: <span class="o">'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_lifetime</span><span class="o">&lt;'</span><span class="na">a</span>: <span class="o">'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Captures</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274736148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736148">(Mar 09 2022 at 19:03)</a>:</h4>
<p>this is the example being executed and when you see <code>My-T</code> it's that <code>T</code> from the function but the one that's copied to the impl trait</p>



<a name="274736149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736149">(Mar 09 2022 at 19:03)</a>:</h4>
<p>Do you need both <code>nested_assoc_type</code> <em>and</em> <code>nested_assoc_lifetime</code> for it to fail?</p>



<a name="274736176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736176">(Mar 09 2022 at 19:03)</a>:</h4>
<p>probably not</p>



<a name="274736185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736185">(Mar 09 2022 at 19:03)</a>:</h4>
<p>If you only have one, what happens</p>



<a name="274736193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736193">(Mar 09 2022 at 19:03)</a>:</h4>
<p>let me reduce the test case</p>



<a name="274736330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736330">(Mar 09 2022 at 19:04)</a>:</h4>
<p>I guess this ...</p>



<a name="274736338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736338">(Mar 09 2022 at 19:04)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(return_position_impl_trait_v2)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274736342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736342">(Mar 09 2022 at 19:04)</a>:</h4>
<p>is a good test case</p>



<a name="274736380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736380">(Mar 09 2022 at 19:04)</a>:</h4>
<p>compiling ...</p>



<a name="274736517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736517">(Mar 09 2022 at 19:05)</a>:</h4>
<p>The predicate here is basically <code>&lt;(nested_assoc_type::opaque#0)&lt;My-T&gt; as Iterator&gt;::Item = (nested_assoc_type::opaque#0::opaque#0)&lt;T&gt;</code></p>



<a name="274736739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736739">(Mar 09 2022 at 19:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274736338">said</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(return_position_impl_trait_v2)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>this test case compiles</p>



<a name="274736949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736949">(Mar 09 2022 at 19:08)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(return_position_impl_trait_v2)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;'</span><span class="na">a</span>: <span class="o">'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274736959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736959">(Mar 09 2022 at 19:08)</a>:</h4>
<p>this one fails</p>



<a name="274736996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274736996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274736996">(Mar 09 2022 at 19:08)</a>:</h4>
<p>so we clearly see where the index 1 is coming from</p>



<a name="274737057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737057">(Mar 09 2022 at 19:09)</a>:</h4>
<p>How do you expect the lowering to be here? This?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">opaque</span><span class="w"> </span><span class="n">X</span><span class="o">&lt;</span><span class="n">My</span><span class="o">-</span><span class="n">T</span><span class="o">&gt;</span>: <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="o">&lt;</span><span class="n">My</span><span class="o">-</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="n">opaque</span><span class="w"> </span><span class="n">Y</span><span class="o">&lt;</span><span class="n">My</span><span class="o">-</span><span class="n">T</span><span class="o">&gt;</span>: <span class="nb">Sized</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">X</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274737135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737135">(Mar 09 2022 at 19:09)</a>:</h4>
<p>yes</p>



<a name="274737187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737187">(Mar 09 2022 at 19:09)</a>:</h4>
<p>and with the <code>'a</code> all the same but <code>fn nested_assoc_type&lt;'a: 'a, T&gt;() -&gt; X&lt;T&gt; {}</code></p>



<a name="274737203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737203">(Mar 09 2022 at 19:09)</a>:</h4>
<p>So, that last <code>T</code> should be <code>My-T</code>?</p>



<a name="274737333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737333">(Mar 09 2022 at 19:10)</a>:</h4>
<p>I think so, if I'm understanding correct what's going on yes</p>



<a name="274737379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737379">(Mar 09 2022 at 19:10)</a>:</h4>
<p>I guess we are getting the bounds from the function when we should be getting the bounds from the opaque type</p>



<a name="274737527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737527">(Mar 09 2022 at 19:11)</a>:</h4>
<p>Uh, maybe not bounds, but substs</p>



<a name="274737613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737613">(Mar 09 2022 at 19:12)</a>:</h4>
<p>yeah</p>



<a name="274737659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737659">(Mar 09 2022 at 19:12)</a>:</h4>
<p>another different thing but related to this issue</p>



<a name="274737681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737681">(Mar 09 2022 at 19:12)</a>:</h4>
<p>not sure what's going on with <code>ty_for_param</code></p>



<a name="274737710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737710">(Mar 09 2022 at 19:12)</a>:</h4>
<p>in the sense that ... it shows up in the backtrace in this way ...</p>



<a name="274737756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737756">(Mar 09 2022 at 19:13)</a>:</h4>
<div class="codehilite"><pre><span></span><code>577    13: &lt;rustc_middle::ty::subst::SubstFolder&gt;::ty_for_param
   1   14: &lt;rustc_middle::ty::subst::SubstFolder as rustc_middle::ty::fold::TypeFolder&gt;::fold_ty
   2              at ./compiler/rustc_middle/src/ty/subst.rs:594:29
</code></pre></div>



<a name="274737783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737783">(Mar 09 2022 at 19:13)</a>:</h4>
<p>like is not pointing to a specific file/line of code</p>



<a name="274737788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737788">(Mar 09 2022 at 19:13)</a>:</h4>
<p>and also</p>



<a name="274737828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737828">(Mar 09 2022 at 19:13)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    fn ty_for_param(&amp;self, p: ty::ParamTy, source_ty: Ty&lt;&#39;tcx&gt;) -&gt; Ty&lt;&#39;tcx&gt; {
        debug!(&quot;HERE: there we go&quot;);
</code></pre></div>



<a name="274737832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274737832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274737832">(Mar 09 2022 at 19:13)</a>:</h4>
<p>that's not printed</p>



<a name="274738253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274738253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274738253">(Mar 09 2022 at 19:17)</a>:</h4>
<p>Maybe you need to set debug to true in your config.toml</p>



<a name="274738560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274738560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274738560">(Mar 09 2022 at 19:19)</a>:</h4>
<p>I have it set to true</p>



<a name="274738623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274738623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274738623">(Mar 09 2022 at 19:20)</a>:</h4>
<p>all the backtrace is showing the right stuff but that call and weirdly it doesn't print what's going on inside of it</p>



<a name="274738837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274738837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274738837">(Mar 09 2022 at 19:21)</a>:</h4>
<p>anyway, that's weird but not really important because I clearly see what's going on inside of it</p>



<a name="274739550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274739550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274739550">(Mar 09 2022 at 19:26)</a>:</h4>
<p>created a new topic about the debugging problem <a class="stream-topic" data-stream-id="182449" href="/#narrow/stream/182449-t-compiler.2Fhelp/topic/not.20seeing.20debug.20info.20ty_for_param">#t-compiler/help &gt; not seeing debug info ty_for_param</a></p>



<a name="274739678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274739678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274739678">(Mar 09 2022 at 19:27)</a>:</h4>
<p>anyway ... back to this as I've said I guess we are getting the substs from the function when we should be getting them from the opaque type or something similar</p>



<a name="274739930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274739930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274739930">(Mar 09 2022 at 19:28)</a>:</h4>
<p>It's also separately weird: I dont know how you're getting an index of 1 for T</p>



<a name="274739999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274739999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274739999">(Mar 09 2022 at 19:29)</a>:</h4>
<p>Unless for some reason the generics are like <code>[My-T, T]</code></p>



<a name="274740119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274740119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274740119">(Mar 09 2022 at 19:30)</a>:</h4>
<p>I guess it's because you have <code>['a, T]</code></p>



<a name="274740146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274740146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274740146">(Mar 09 2022 at 19:30)</a>:</h4>
<p><code>T</code> is index 1</p>



<a name="274740196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274740196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274740196">(Mar 09 2022 at 19:30)</a>:</h4>
<p>so the <code>substs</code> that are wrong are the ones coming here I guess <a href="https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L450">https://github.com/rust-lang/rust/blob/73b4e591af0805abbd722d5f719b020858022f65/compiler/rustc_infer/src/infer/opaque_types.rs#L450</a></p>



<a name="274740545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274740545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274740545">(Mar 09 2022 at 19:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274609422">said</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Captures</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Captures</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_lifetime</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Captures</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>There's no <code>'a</code> here though?</p>



<a name="274740681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274740681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274740681">(Mar 09 2022 at 19:34)</a>:</h4>
<p>the last example I'm talking about is</p>



<a name="274740685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274740685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274740685">(Mar 09 2022 at 19:34)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(return_position_impl_trait_v2)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;'</span><span class="na">a</span>: <span class="o">'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274741157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274741157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274741157">(Mar 09 2022 at 19:38)</a>:</h4>
<p>I think you are lowering the opaque type bounds in the function's scope. Right now you are only using the opaque type def id remapping to duplicate the generics. But the bounds need to be lowered in the same closure I believe</p>



<a name="274752383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274752383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274752383">(Mar 09 2022 at 21:06)</a>:</h4>
<p>I'm a bit confused right now but I think <a href="https://github.com/rust-lang/rust/compare/master...spastorino:rpit-refactor#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4R1782">this</a> and <a href="https://github.com/rust-lang/rust/compare/master...spastorino:rpit-refactor#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4R1802">this</a> need to go through <code>remapped_def_id</code></p>



<a name="274752927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274752927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274752927">(Mar 09 2022 at 21:10)</a>:</h4>
<p>if I do so I get the following ...</p>



<a name="274752933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274752933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274752933">(Mar 09 2022 at 21:11)</a>:</h4>
<div class="codehilite"><pre><span></span><code> 1 error[E0277]: the size for values of type `My-T` cannot be known at compilation time
  2  --&gt; src/test/ui/impl-trait/v2/nested-return-type.rs:6:38
  3   |
  4 6 | fn nested_assoc_type&lt;&#39;a: &#39;a, T&gt;() -&gt; impl Iterator&lt;Item = impl Sized&gt; {
  5   |                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ doesn&#39;t have a size known at compile-time
  6   |
  7 note: required by a bound in `nested_assoc_type::{opaque#0}`
  8  --&gt; src/test/ui/impl-trait/v2/nested-return-type.rs:6:30
  9   |
 10 6 | fn nested_assoc_type&lt;&#39;a: &#39;a, T&gt;() -&gt; impl Iterator&lt;Item = impl Sized&gt; {
 11   |                              ^ required by this bound in `nested_assoc_type::{opaque#0}`
 12
 13 thread &#39;rustc&#39; panicked at &#39;aborting due to `-Z treat-err-as-bug=1`&#39;, compiler/rustc_errors/src/lib.rs:1200:27
</code></pre></div>



<a name="274753054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274753054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274753054">(Mar 09 2022 at 21:12)</a>:</h4>
<p>it may be that that's a bit of progress but I'm not clearly thinking right now :)</p>



<a name="274753670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274753670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274753670">(Mar 09 2022 at 21:18)</a>:</h4>
<p>Sounds like maybe param env or substs are off again</p>



<a name="274754048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274754048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274754048">(Mar 09 2022 at 21:21)</a>:</h4>
<p>yeah</p>



<a name="274754055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274754055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274754055">(Mar 09 2022 at 21:21)</a>:</h4>
<p>need to take a look at the logs</p>



<a name="274754068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274754068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274754068">(Mar 09 2022 at 21:21)</a>:</h4>
<p>will check tomorrow</p>



<a name="274801754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274801754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274801754">(Mar 10 2022 at 08:05)</a>:</h4>
<p><a href="https://gist.github.com/spastorino/ba217e0769ddbb97f24e10022cd2798a#file-gistfile1-txt-L125">https://gist.github.com/spastorino/ba217e0769ddbb97f24e10022cd2798a#file-gistfile1-txt-L125</a></p>
<p>Shows that you also modified the params in the return type, so your function signature is now <code>fn foo&lt;T&gt;() -&gt; GeneratedOpaqueTy&lt;My-T&gt;</code></p>



<a name="274839756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274839756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274839756">(Mar 10 2022 at 14:12)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>should desugar to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">opaque</span><span class="w"> </span><span class="k">type</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="p">;</span><span class="w"></span>
<span class="n">opaque</span><span class="w"> </span><span class="k">type</span> <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>but actually we get</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">opaque</span><span class="w"> </span><span class="k">type</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Sized</span><span class="p">;</span><span class="w"></span>
<span class="n">opaque</span><span class="w"> </span><span class="k">type</span> <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">nested_assoc_type</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>



<a name="274877559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274877559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274877559">(Mar 10 2022 at 18:39)</a>:</h4>
<p>So I guess the next step is to make <a href="https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L1761">https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L1761</a> not an empty slice anymore, but copy the where bounds of the function, too</p>



<a name="274877560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274877560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274877560">(Mar 10 2022 at 18:39)</a>:</h4>
<p>So I guess the next step is to make <a href="https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L1761">https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L1761</a> not an empty slice anymore, but copy the where bounds of the function, too</p>



<a name="274877561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274877561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274877561">(Mar 10 2022 at 18:39)</a>:</h4>
<p>For that we need to start passing them along like we do in_scope_generic_params</p>



<a name="274877718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274877718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274877718">(Mar 10 2022 at 18:40)</a>:</h4>
<p>Probably in <a href="https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L945">https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L945</a>, but not sure where exactly</p>



<a name="274885824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274885824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274885824">(Mar 10 2022 at 19:44)</a>:</h4>
<p>where clauses: is this still about fixing the ICE, or the next implementation step?</p>



<a name="274889558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274889558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274889558">(Mar 10 2022 at 20:16)</a>:</h4>
<p>Next impl step</p>



<a name="274892745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274892745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274892745">(Mar 10 2022 at 20:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274885824">said</a>:</p>
<blockquote>
<p>where clauses: is this still about fixing the ICE, or the next implementation step?</p>
</blockquote>
<p>just in case, the previously mentioned issues are all fixed now</p>



<a name="274892919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274892919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274892919">(Mar 10 2022 at 20:49)</a>:</h4>
<p>for completion the problem we had was the thing I've mentioned yesterday when in some part of the code I wasn't remapping the def_id and also with inner impl traits, the remapping was being overriding by the inner impl trait making the remapping return the wrong def_id</p>



<a name="274897011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274897011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274897011">(Mar 10 2022 at 21:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/274877718">said</a>:</p>
<blockquote>
<p>Probably in <a href="https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L945">https://github.com/spastorino/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/lib.rs#L945</a>, but not sure where exactly</p>
</blockquote>
<p>by this you meant that when we call <code>add_in_band_defs</code> to carry in band definitions at the call site we should also pass down predicates and store them inside that function so it can be used when the closure passed is called?</p>



<a name="274897109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274897109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274897109">(Mar 10 2022 at 21:26)</a>:</h4>
<p>but in particular my question is ... if you mentioned this is because (I guess) you know that at the call site predicates of the function are available to be passed down</p>



<a name="274897291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274897291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274897291">(Mar 10 2022 at 21:28)</a>:</h4>
<p>in particular I guess passing it down from here <a href="https://github.com/rust-lang/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/item.rs#L1304">https://github.com/rust-lang/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/item.rs#L1304</a></p>



<a name="274897434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274897434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274897434">(Mar 10 2022 at 21:29)</a>:</h4>
<p>and if that's the case unsure in particular what to do here <a href="https://github.com/rust-lang/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/item.rs#L366">https://github.com/rust-lang/rust/blob/2084c20b4cacac3adf741b0da6e2b1ab3e23017a/compiler/rustc_ast_lowering/src/item.rs#L366</a></p>



<a name="274957021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/274957021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#274957021">(Mar 11 2022 at 10:30)</a>:</h4>
<p>I'm assuming we can get all info from the generics argument, so no need to touch call sites</p>



<a name="275216589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/275216589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#275216589">(Mar 14 2022 at 10:24)</a>:</h4>
<p>The current lowering of TAIT is different of RPIT.  TAITs implicitly inherit lifetimes of their environment (mostly the generics on the trait binding), while RPIT make an effort to drop them.  I need to have a uniform handling of both for <a href="https://github.com/rust-lang/rust/issues/91557">#91557</a>, what should be the preferred model?</p>



<a name="275217323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/275217323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#275217323">(Mar 14 2022 at 10:31)</a>:</h4>
<p>My preference is to do the following: for trivial TAITs (just an opaque type directly) we'd stop nesting the opaque type, and for all other TAITs, we'd do the same thing we're doing for RPIT. For now we can just do the RPIT thing for all TAITs and see into the optimization later</p>



<a name="275217369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/275217369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#275217369">(Mar 14 2022 at 10:31)</a>:</h4>
<p>This is not binding consensus, just my opinion</p>



<a name="276471387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471387">(Mar 24 2022 at 12:59)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> was suggesting me that for my changes to be more self-contained that I make changes to the resolver</p>



<a name="276471477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471477">(Mar 24 2022 at 12:59)</a>:</h4>
<p>I was also mentioning this to <span class="user-mention" data-user-id="248906">@cjgillot</span> and they were telling me that <a href="https://github.com/rust-lang/rust/issues/88186">#88186</a> gets rid of <code>ResolverAstLowering</code></p>



<a name="276471489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471489">(Mar 24 2022 at 12:59)</a>:</h4>
<p>in particular here <a href="https://github.com/rust-lang/rust/pull/88186/files#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4L161">https://github.com/rust-lang/rust/pull/88186/files#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4L161</a></p>



<a name="276471610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471610">(Mar 24 2022 at 13:00)</a>:</h4>
<p>wanted to bring up this discussion here so we can think about a better approach</p>



<a name="276471795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471795">(Mar 24 2022 at 13:01)</a>:</h4>
<p>if I understood <span class="user-mention" data-user-id="124288">@oli</span>'s correctly, we would want to get rid of the need of remembering to do this kind of things <a href="https://github.com/rust-lang/rust/compare/master...spastorino:rpit-refactor#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4R669">https://github.com/rust-lang/rust/compare/master...spastorino:rpit-refactor#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4R669</a></p>



<a name="276471904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471904">(Mar 24 2022 at 13:02)</a>:</h4>
<p>and have the def_id automatically be the right one</p>



<a name="276471993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276471993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276471993">(Mar 24 2022 at 13:03)</a>:</h4>
<p>by containing all this logic in an impl of the resolver trait that basically have this mapping and does the right thing we would be hiding this things from users</p>



<a name="276472124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276472124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276472124">(Mar 24 2022 at 13:04)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="248906">@cjgillot</span> thoughts? in particular if we are going to get rid of <code>ResolverAstLowering</code> doesn't make sense to base this changes on the existence of it</p>



<a name="276490448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276490448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276490448">(Mar 24 2022 at 15:16)</a>:</h4>
<p>ah, well, that's even better, as in that case we can design exactly what we want instead of having to shoehorn it into <code>ResolverAstLowering</code></p>



<a name="276495188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/276495188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#276495188">(Mar 24 2022 at 15:47)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> can you explain the "exactly what we want" part?</p>



<a name="277451334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451334">(Apr 01 2022 at 17:22)</a>:</h4>
<p>I'm still a bit confused on how to properly handle node_ids, hir_ids and def_ids for this let's copy generic parameters idea</p>



<a name="277451398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451398">(Apr 01 2022 at 17:23)</a>:</h4>
<p>yesterday I had a meeting with <span class="user-mention" data-user-id="116009">@nikomatsakis</span> and ended mentioning him this problem</p>



<a name="277451551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451551">(Apr 01 2022 at 17:24)</a>:</h4>
<p>for instance ... in an example like</p>



<a name="277451554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451554">(Apr 01 2022 at 17:24)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Clone</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Clone</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">t</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277451598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451598">(Apr 01 2022 at 17:24)</a>:</h4>
<p>in the AST we would have ...</p>



<a name="277451609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451609">(Apr 01 2022 at 17:24)</a>:</h4>
<ul>
<li><code>ast::Fn</code>(node_id=N0)<ul>
<li><code>ast::Generics</code><ul>
<li>ast::GenericParam`(ident=T, node_id=N1)</li>
</ul>
</li>
<li>ReturnType <code>ast::Ty</code>(node_id=N2)<ul>
<li><code>TyKind::ImplTrait</code>(node_id=N3)</li>
<li><code>ast::GenericBounds</code></li>
</ul>
</li>
</ul>
</li>
</ul>



<a name="277451915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451915">(Apr 01 2022 at 17:27)</a>:</h4>
<p>in the name resolver we have created...</p>



<a name="277451928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451928">(Apr 01 2022 at 17:27)</a>:</h4>
<ul>
<li>a DefId D1 for the function </li>
<li>a DefId D2 for T </li>
<li>a DefId D3 for the Impl Trait</li>
</ul>



<a name="277451989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451989">(Apr 01 2022 at 17:27)</a>:</h4>
<p>and we have a map <code>resolver.node_id_to_def_id</code> that contains <em>at least</em> the def-id for each <em>declaration</em></p>



<a name="277451995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277451995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277451995">(Apr 01 2022 at 17:27)</a>:</h4>
<ul>
<li>N0 -&gt; D1</li>
<li>N1 -&gt; D2</li>
<li>N3 -&gt; D3 &lt;-- Niko has mixed feelings about this</li>
</ul>



<a name="277452066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452066">(Apr 01 2022 at 17:28)</a>:</h4>
<p>we want to generate...</p>



<a name="277452201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452201">(Apr 01 2022 at 17:29)</a>:</h4>
<ul>
<li><code>hir::ItemKind::Fn</code>: Item for the function<ul>
<li>this has DefId D1</li>
<li><code>hir::Generics</code><ul>
<li><code>hir::GenericParam</code>(hir_id = H0, name = T)<ul>
<li>this has DefId D2</li>
<li><code>hir::GenericBounds</code><ul>
<li>... <code>T: Clone</code> ... with hir_id H2</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>return type is a <code>hir::Ty</code> with...<ul>
<li><code>hir::OpaqueDef</code>(D3, <code>[T]</code>)</li>
</ul>
</li>
<li><code>hir::ItemKind::OpaqueTy</code><ul>
<li>this has DefId D3 <em>which is a child of D1</em></li>
<li><code>hir::Generics</code><ul>
<li><code>hir::GenericParam</code>(hir_id = H1, name = U)<ul>
<li>this has (fresh) DefId D4 </li>
<li>[<code>hir::GenericBounds</code>][]<ul>
<li>... <code>U: Clone</code> ... with hir_id H3</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>



<a name="277452523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452523">(Apr 01 2022 at 17:31)</a>:</h4>
<p>one of the things that we've talked about is that we would probably want to use DUMMY_NODE_ID for all this new hir nodes</p>



<a name="277452572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452572">(Apr 01 2022 at 17:31)</a>:</h4>
<p>I haven't tried that yet, but this makes sense to me given that there's no correspondence with anything in the AST for these new nodes</p>



<a name="277452692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452692">(Apr 01 2022 at 17:32)</a>:</h4>
<p>we need to lower things twice but with different hir_id_owners for the function and for the rpit</p>



<a name="277452777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452777">(Apr 01 2022 at 17:32)</a>:</h4>
<p>so I wanted to confirm with you guys <span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="248906">@cjgillot</span> if all this stuff makes sense</p>



<a name="277452810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452810">(Apr 01 2022 at 17:33)</a>:</h4>
<p>in particular I have doubts if using <code>DUMMY_NODE_ID</code> will  work</p>



<a name="277452835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452835">(Apr 01 2022 at 17:33)</a>:</h4>
<p>and what I should exactly do with <code>OpaqueDef</code>'s generics</p>



<a name="277452853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452853">(Apr 01 2022 at 17:33)</a>:</h4>
<p>Do you mean you want to clone the main AST into a second (cleaned-up) copy of the AST?</p>



<a name="277452863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452863">(Apr 01 2022 at 17:33)</a>:</h4>
<p>And then lower this copy?</p>



<a name="277452892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452892">(Apr 01 2022 at 17:33)</a>:</h4>
<p>no</p>



<a name="277452897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452897">(Apr 01 2022 at 17:33)</a>:</h4>
<p>I'd be lowering the same AST node twice</p>



<a name="277452986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277452986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277452986">(Apr 01 2022 at 17:34)</a>:</h4>
<p>just with different hir owner and using DUMMY_NODE_ID as the id of the node for the copy</p>



<a name="277453081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453081">(Apr 01 2022 at 17:35)</a>:</h4>
<p>Which node are you lowering twice?</p>



<a name="277453221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453221">(Apr 01 2022 at 17:36)</a>:</h4>
<p>the generic params</p>



<a name="277453231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453231">(Apr 01 2022 at 17:36)</a>:</h4>
<p>The issue with DUMMY_NODE_ID is that <code>lower_node_id</code> needs to be fixed-up to ignore it.  You have <code>next_id</code> which can do the same job.</p>



<a name="277453303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453303">(Apr 01 2022 at 17:37)</a>:</h4>
<p>(= provide you with a new node_id to be used)</p>



<a name="277453366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453366">(Apr 01 2022 at 17:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277453231">said</a>:</p>
<blockquote>
<p>The issue with DUMMY_NODE_ID is that <code>lower_node_id</code> needs to be fixed-up to ignore it.  You have <code>next_id</code> which can do the same job.</p>
</blockquote>
<p>from what I've seen yes, but it is not inserted in some maps</p>



<a name="277453446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453446">(Apr 01 2022 at 17:38)</a>:</h4>
<p>What is <code>it</code> referring to?</p>



<a name="277453507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453507">(Apr 01 2022 at 17:38)</a>:</h4>
<p>sorry, I got confused</p>



<a name="277453521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453521">(Apr 01 2022 at 17:38)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span> <span class="nf">lower_node_id</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ast_node_id</span>: <span class="nc">NodeId</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">hir</span>::<span class="n">HirId</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_ne!</span><span class="p">(</span><span class="n">ast_node_id</span><span class="p">,</span><span class="w"> </span><span class="n">DUMMY_NODE_ID</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="277453528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453528">(Apr 01 2022 at 17:38)</a>:</h4>
<p>yeah that needs to be fixed</p>



<a name="277453627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453627">(Apr 01 2022 at 17:39)</a>:</h4>
<p>Can't you just call <code>next_node_id</code>?</p>



<a name="277453663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453663">(Apr 01 2022 at 17:39)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/92e7288fae1fca7f1445a81fb302f56a79454c15/compiler/rustc_ast_lowering/src/lib.rs#L640-L647">https://github.com/rust-lang/rust/blob/92e7288fae1fca7f1445a81fb302f56a79454c15/compiler/rustc_ast_lowering/src/lib.rs#L640-L647</a></p>



<a name="277453678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453678">(Apr 01 2022 at 17:39)</a>:</h4>
<p>there I could be using the remapping</p>



<a name="277453929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453929">(Apr 01 2022 at 17:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277453627">said</a>:</p>
<blockquote>
<p>Can't you just call <code>next_node_id</code>?</p>
</blockquote>
<p>I think I could but the question is why do we want to have a node id if we don't need it?</p>



<a name="277453995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277453995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277453995">(Apr 01 2022 at 17:42)</a>:</h4>
<p>anyway, I can try this idea out and see how far I can get</p>



<a name="277454011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454011">(Apr 01 2022 at 17:42)</a>:</h4>
<p>if sounds reasonable</p>



<a name="277454211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454211">(Apr 01 2022 at 17:44)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> are you suggesting to have a node id for some specific reason I may not be seeing?</p>



<a name="277454268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454268">(Apr 01 2022 at 17:44)</a>:</h4>
<p>or should I just try out to see how far I can go with this idea?</p>



<a name="277454326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454326">(Apr 01 2022 at 17:44)</a>:</h4>
<p><code>next_node_id</code> just increments a counter, it won't do anything fishy behind your back :)</p>



<a name="277454372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454372">(Apr 01 2022 at 17:45)</a>:</h4>
<p>No reason besides because you need one.</p>



<a name="277454381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454381">(Apr 01 2022 at 17:45)</a>:</h4>
<p>I don't want to be creating node-ids because they <em>shouldn't</em> have to be there</p>



<a name="277454397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454397">(Apr 01 2022 at 17:45)</a>:</h4>
<p>but let me check what piece of code you are talking about</p>



<a name="277454419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454419">(Apr 01 2022 at 17:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277453231">said</a>:</p>
<blockquote>
<p>The issue with DUMMY_NODE_ID is that <code>lower_node_id</code> needs to be fixed-up to ignore it.  You have <code>next_id</code> which can do the same job.</p>
</blockquote>
<p>I think this is a misunderstanding</p>



<a name="277454445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454445">(Apr 01 2022 at 17:45)</a>:</h4>
<p>though on whose part I'm not sure</p>



<a name="277454467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454467">(Apr 01 2022 at 17:46)</a>:</h4>
<p>the DUMMY_NODE_ID is only used when creating the (fresh) def-ids during lowering</p>



<a name="277454520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454520">(Apr 01 2022 at 17:46)</a>:</h4>
<p>and that function is already equipped to take a <code>DUMMY_NODE_ID</code> as argument</p>



<a name="277454544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454544">(Apr 01 2022 at 17:46)</a>:</h4>
<p>I don't think we need <code>DUMMY_NODE_ID</code> in any other places</p>



<a name="277454677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454677">(Apr 01 2022 at 17:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> you're saying that in this case we should use that convenience not only because semmantically is more precise but also because when we are going to fetch a def_id for these new copied generics, we should do that through the remapping, correct?</p>



<a name="277454704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454704">(Apr 01 2022 at 17:47)</a>:</h4>
<p>right-- the node-id in question is used to update the resolver map</p>



<a name="277454719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454719">(Apr 01 2022 at 17:48)</a>:</h4>
<p>I don't think the resolver map should need to be updated :)</p>



<a name="277454832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454832">(Apr 01 2022 at 17:48)</a>:</h4>
<p>This resolver map is also used to build the <code>DefId &lt;-&gt; HirId</code> map.  If a DefId does not appear in it, there will be an ICE somewhere.</p>



<a name="277454861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454861">(Apr 01 2022 at 17:49)</a>:</h4>
<p>The <code>local_def_id_to_hir_id</code> map I mean. EDIT: the other one, sorry.</p>



<a name="277454884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454884">(Apr 01 2022 at 17:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277454832">said</a>:</p>
<blockquote>
<p>This resolver map is also used to build the <code>DefId &lt;-&gt; HirId</code> map.  If a DefId does not appear in it, there will be an ICE somewhere.</p>
</blockquote>
<p>I'm referring to the <code>node_id_to_hir_id</code> map</p>



<a name="277454900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277454900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277454900">(Apr 01 2022 at 17:49)</a>:</h4>
<p>let me find the code in question, one sec</p>



<a name="277455110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455110">(Apr 01 2022 at 17:50)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/244a73c549d1468908bfd4efcb0f568a3b4ae557/compiler/rustc_resolve/src/lib.rs#L1226-L1264">https://github.com/rust-lang/rust/blob/244a73c549d1468908bfd4efcb0f568a3b4ae557/compiler/rustc_resolve/src/lib.rs#L1226-L1264</a></p>



<a name="277455156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455156">(Apr 01 2022 at 17:51)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/244a73c549d1468908bfd4efcb0f568a3b4ae557/compiler/rustc_resolve/src/lib.rs#L1258">this store</a> would not happen</p>



<a name="277455168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455168">(Apr 01 2022 at 17:51)</a>:</h4>
<p>and I think it should not have to happen</p>



<a name="277455242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455242">(Apr 01 2022 at 17:51)</a>:</h4>
<p>personally I would prefer for <a href="https://github.com/rust-lang/rust/blob/244a73c549d1468908bfd4efcb0f568a3b4ae557/compiler/rustc_resolve/src/lib.rs#L1229">this argument</a> to be an <code>Option&lt;NodeId&gt;</code>, but anyway</p>



<a name="277455255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455255">(Apr 01 2022 at 17:51)</a>:</h4>
<p>This store is used by <code>lower_node_id</code> to update <code>local_id_to_def_id</code>.</p>



<a name="277455426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455426">(Apr 01 2022 at 17:52)</a>:</h4>
<p>yes, and that fn should never be called</p>



<a name="277455444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455444">(Apr 01 2022 at 17:52)</a>:</h4>
<p>i.e., if we made a "new node id" here</p>



<a name="277455452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455452">(Apr 01 2022 at 17:52)</a>:</h4>
<p>it would never be looked up</p>



<a name="277455555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455555">(Apr 01 2022 at 17:53)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="277455580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455580">(Apr 01 2022 at 17:53)</a>:</h4>
<p>what <em>will</em> happen</p>



<a name="277455582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455582">(Apr 01 2022 at 17:53)</a>:</h4>
<p>Then, you'd have a GenericParam whose HirId is not associated to a DefId.  I recall that some typechecking code assumes there is one such DefId in all case.</p>



<a name="277455646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455646">(Apr 01 2022 at 17:54)</a>:</h4>
<p>no, I don't think that's right</p>



<a name="277455674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455674">(Apr 01 2022 at 17:54)</a>:</h4>
<p>what I mean is</p>



<a name="277455692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455692">(Apr 01 2022 at 17:54)</a>:</h4>
<p>if you look at the example I wrote out above</p>



<a name="277455700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455700">(Apr 01 2022 at 17:54)</a>:</h4>
<p>we are lowering the same AST node twice</p>



<a name="277455709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455709">(Apr 01 2022 at 17:54)</a>:</h4>
<p>say it has the node-id N1</p>



<a name="277455724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455724">(Apr 01 2022 at 17:54)</a>:</h4>
<p>that is mapped by the resolver to DefId1</p>



<a name="277455739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455739">(Apr 01 2022 at 17:54)</a>:</h4>
<p>(in that <code>node_id_to_def_id</code> table)</p>



<a name="277455756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455756">(Apr 01 2022 at 17:55)</a>:</h4>
<p>so when we go to look it up, we get back <code>DefId1</code></p>



<a name="277455778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455778">(Apr 01 2022 at 17:55)</a>:</h4>
<p>but the second time, we've installed the def-id-remapper, which maps that to <code>DefId2</code> (the new <code>DefId</code> we created)</p>



<a name="277455801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455801">(Apr 01 2022 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277455582">said</a>:</p>
<blockquote>
<p>Then, you'd have a GenericParam whose HirId is not associated to a DefId.  I recall that some typechecking code assumes there is one such DefId in all case.</p>
</blockquote>
<p>where is this association between <code>HirId</code> and <code>DefId</code> made?</p>



<a name="277455828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455828">(Apr 01 2022 at 17:55)</a>:</h4>
<p>I told Santiago, my rule of thumb is that we should be shooting to have each IR be "true to itself".</p>



<a name="277455865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455865">(Apr 01 2022 at 17:55)</a>:</h4>
<p>i.e., we don't need to make fake AST nodes, I hope</p>



<a name="277455926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455926">(Apr 01 2022 at 17:56)</a>:</h4>
<p>In lowering, it's called <code>local_id_to_def_id</code>.  Outside, it's <code>tcx.hir().local_def_id: HirId -&gt; LocalDefId</code>.</p>



<a name="277455971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455971">(Apr 01 2022 at 17:56)</a>:</h4>
<p>that's a map, it looks like</p>



<a name="277455986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455986">(Apr 01 2022 at 17:56)</a>:</h4>
<p>right</p>



<a name="277455996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277455996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277455996">(Apr 01 2022 at 17:56)</a>:</h4>
<p>this is the map that gets reset when you have a new <code>hir_id_owner</code>, right?</p>



<a name="277456007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456007">(Apr 01 2022 at 17:57)</a>:</h4>
<p>Yes.</p>



<a name="277456025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456025">(Apr 01 2022 at 17:57)</a>:</h4>
<p>that was important, that's part of why this whole thing works</p>



<a name="277456084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456084">(Apr 01 2022 at 17:57)</a>:</h4>
<p>right, it gets updated here</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">def_id</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">resolver</span><span class="p">.</span><span class="n">opt_local_def_id</span><span class="p">(</span><span class="n">ast_node_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">owners</span><span class="p">.</span><span class="n">ensure_contains_elem</span><span class="p">(</span><span class="n">def_id</span><span class="p">,</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">hir</span>::<span class="n">MaybeOwner</span>::<span class="n">Phantom</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">hir</span>::<span class="n">MaybeOwner</span>::<span class="n">Phantom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">owners</span><span class="p">[</span><span class="n">def_id</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// Do not override a `MaybeOwner::Owner` that may already here.</span>
<span class="w">                        </span><span class="o">*</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hir</span>::<span class="n">MaybeOwner</span>::<span class="n">NonOwner</span><span class="p">(</span><span class="n">hir_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">local_id_to_def_id</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">local_id</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277456086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456086">(Apr 01 2022 at 17:57)</a>:</h4>
<p>this is the code I was talking about:</p>



<a name="277456109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456109">(Apr 01 2022 at 17:57)</a>:</h4>
<p>the <code>ast_node_id</code> we have there is NOT the new node-id you would create</p>



<a name="277456155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456155">(Apr 01 2022 at 17:58)</a>:</h4>
<p>it's the <em>old</em> node-id</p>



<a name="277456168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456168">(Apr 01 2022 at 17:58)</a>:</h4>
<p>or rather</p>



<a name="277456174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456174">(Apr 01 2022 at 17:58)</a>:</h4>
<p>the <em>only</em> node-id</p>



<a name="277456176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456176">(Apr 01 2022 at 17:58)</a>:</h4>
<p>since there is only one</p>



<a name="277456222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456222">(Apr 01 2022 at 17:58)</a>:</h4>
<p>in the branch today there are two, and we "clone" the AST node, but if we don't do that, there is only one</p>



<a name="277456235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456235">(Apr 01 2022 at 17:58)</a>:</h4>
<p>but we do have to remap the def-id we pull out of that table</p>



<a name="277456265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456265">(Apr 01 2022 at 17:58)</a>:</h4>
<p>I would argue that not doing so is an oversight regardless</p>



<a name="277456282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456282">(Apr 01 2022 at 17:58)</a>:</h4>
<p>I like the idea of wrapping <code>resolver</code> so we can't have such bugs</p>



<a name="277456415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456415">(Apr 01 2022 at 17:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277456235">said</a>:</p>
<blockquote>
<p>but we do have to remap the def-id we pull out of that table</p>
</blockquote>
<p>Lowering only ever fill this table.</p>



<a name="277456523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456523">(Apr 01 2022 at 18:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277456282">said</a>:</p>
<blockquote>
<p>I like the idea of wrapping <code>resolver</code> so we can't have such bugs</p>
</blockquote>
<p>Which bug?</p>



<a name="277456678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456678">(Apr 01 2022 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277456415">said</a>:</p>
<blockquote>
<p>Lowering only ever fill this table.</p>
</blockquote>
<p>sorry, the table I meant is the result of calling <code>self.resolver.opt_local_def_id(ast_node_id)</code></p>



<a name="277456690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456690">(Apr 01 2022 at 18:01)</a>:</h4>
<p>My concern is: we have a GenericParam for which we have created a <code>DefId2</code> and a <code>HirId2</code>.  We should link the two at one point.</p>



<a name="277456708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456708">(Apr 01 2022 at 18:01)</a>:</h4>
<p>and the fact that we don't remap that return value is the bug</p>



<a name="277456732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456732">(Apr 01 2022 at 18:01)</a>:</h4>
<p>yes, and we will</p>



<a name="277456744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456744">(Apr 01 2022 at 18:01)</a>:</h4>
<p>right at the code I showed you</p>



<a name="277456752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456752">(Apr 01 2022 at 18:01)</a>:</h4>
<p>what will happen is this:</p>



<a name="277456762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456762">(Apr 01 2022 at 18:01)</a>:</h4>
<p>we have the node id N1</p>



<a name="277456765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456765">(Apr 01 2022 at 18:01)</a>:</h4>
<p>Why would we remap this return value?</p>



<a name="277456808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456808">(Apr 01 2022 at 18:01)</a>:</h4>
<p>because we've got a "remap def ids" table that contains <code>DefId1 -&gt; DefId2</code></p>



<a name="277456832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456832">(Apr 01 2022 at 18:02)</a>:</h4>
<p>that's kind of the whole idea</p>



<a name="277456897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277456897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277456897">(Apr 01 2022 at 18:02)</a>:</h4>
<p>we want to lower the ast node twice, but remap the def-ids that we map to within it to point to the new generic parameters</p>



<a name="277457004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457004">(Apr 01 2022 at 18:03)</a>:</h4>
<p>Oh. I get it. That is a very heavy hammer, considering you only need to remap the def-ids that appear in a <code>Res</code>, don't you?</p>



<a name="277457079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457079">(Apr 01 2022 at 18:03)</a>:</h4>
<p>basically: anything that referred to the old generic parameter has to be remapped to the new ones</p>



<a name="277457112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457112">(Apr 01 2022 at 18:03)</a>:</h4>
<p>I think this occurs in two places</p>



<a name="277457174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457174">(Apr 01 2022 at 18:04)</a>:</h4>
<p>one is the <code>Res</code> and the other is the one we are talking about now :)</p>



<a name="277457182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457182">(Apr 01 2022 at 18:04)</a>:</h4>
<p>but there might be other places, I don't know</p>



<a name="277457203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457203">(Apr 01 2022 at 18:04)</a>:</h4>
<p>I don't recall whether we searched</p>



<a name="277457216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457216">(Apr 01 2022 at 18:04)</a>:</h4>
<p>I think we did, actually</p>



<a name="277457251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457251">(Apr 01 2022 at 18:04)</a>:</h4>
<p>in any case it should happen always we are inside this with_remapping_call (we should switch to a resolver that always remaps)</p>



<a name="277457306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457306">(Apr 01 2022 at 18:05)</a>:</h4>
<p>didn't want to stop your discussion but if you agreed on this, my main doubt is ...</p>



<a name="277457329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457329">(Apr 01 2022 at 18:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277452835">said</a>:</p>
<blockquote>
<p>and what I should exactly do with <code>OpaqueDef</code>'s generics</p>
</blockquote>
<p><span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="277457393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457393">(Apr 01 2022 at 18:05)</a>:</h4>
<p><code>OpaqueDef</code> has <code>GenericArg</code>s</p>



<a name="277457450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457450">(Apr 01 2022 at 18:06)</a>:</h4>
<p>which are <code>Const</code>, <code>Type</code>, <code>Lifetime</code></p>



<a name="277457464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457464">(Apr 01 2022 at 18:06)</a>:</h4>
<p>in particular <code>Const</code> holds an <code>AnonConst</code></p>



<a name="277457538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457538">(Apr 01 2022 at 18:06)</a>:</h4>
<p>I was telling Niko that my idea of <code>OpaqueDef</code> is that it's the declaration part of the opaque type, so the thing that's placed on the function's return type</p>



<a name="277457640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457640">(Apr 01 2022 at 18:07)</a>:</h4>
<p>so I'd guess that we would need to have all the generic parameters inside it and all the things that are pointed by those generic parameters "hold" the same node_ids, hir_ids, def_id as the function does</p>



<a name="277457758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457758">(Apr 01 2022 at 18:08)</a>:</h4>
<p>because I found some errors with that, given that I was already creating new node_ids, hir_ids and things and I ended with the need of creating everything new for there on</p>



<a name="277457785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457785">(Apr 01 2022 at 18:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277457174">said</a>:</p>
<blockquote>
<p>one is the <code>Res</code> and the other is the one we are talking about now :)</p>
</blockquote>
<p>I did not consider what we are walking about as re-mapping, since we are creating the DefId entirely.<br>
Remark: <code>Res</code> embeds a DefId, and <code>lower_res</code> never uses <code>resolver.local_def_id</code>, it must be handled separately.</p>



<a name="277457797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457797">(Apr 01 2022 at 18:08)</a>:</h4>
<p>but I guess we shouldn't do anything, we should just use fns stuff</p>



<a name="277457859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457859">(Apr 01 2022 at 18:08)</a>:</h4>
<p>anonymous constant ids... I wish they weren't present in the AST</p>



<a name="277457864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457864">(Apr 01 2022 at 18:08)</a>:</h4>
<p>but</p>



<a name="277457911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277457911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277457911">(Apr 01 2022 at 18:09)</a>:</h4>
<p>well, do they have the surrounding generics in scope?</p>



<a name="277458031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458031">(Apr 01 2022 at 18:09)</a>:</h4>
<p>The AnonConst only exists as a default argument, so we can probably drop it.</p>



<a name="277458179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458179">(Apr 01 2022 at 18:10)</a>:</h4>
<p>However, we still have the same question about the Const's type, which may contain its AnonConst.</p>



<a name="277458371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458371">(Apr 01 2022 at 18:12)</a>:</h4>
<p>Yeah, I'm pondering. The real question is what amount it makes sense to "move over" to the new item.</p>



<a name="277458430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458430">(Apr 01 2022 at 18:12)</a>:</h4>
<p>(I'm also vaguely pondering the question of "what <em>if</em> they shared generics" -- i.e., what if we extend the core model to support that)</p>



<a name="277458677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458677">(Apr 01 2022 at 18:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277458031">said</a>:</p>
<blockquote>
<p>The AnonConst only exists as a default argument, so we can probably drop it.</p>
</blockquote>
<p>yeah, that's correct</p>



<a name="277458678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458678">(Apr 01 2022 at 18:14)</a>:</h4>
<p>Allowing the inner type could access the outer function generics is the current model, isn't it?</p>



<a name="277458720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458720">(Apr 01 2022 at 18:14)</a>:</h4>
<p>anyway, I wonder what to do with the ids that are going to live inside <code>OpaqueDef</code></p>



<a name="277458730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458730">(Apr 01 2022 at 18:14)</a>:</h4>
<p>I'm not sure about that</p>



<a name="277458736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458736">(Apr 01 2022 at 18:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277458678">said</a>:</p>
<blockquote>
<p>Allowing the inner type could access the outer function generics is the current model, isn't it?</p>
</blockquote>
<p>Right, just want to make sure I'm advocating for the right change :)</p>



<a name="277458748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458748">(Apr 01 2022 at 18:14)</a>:</h4>
<p>I know you were skeptical before :)</p>



<a name="277458849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458849">(Apr 01 2022 at 18:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277458031">said</a>:</p>
<blockquote>
<p>The AnonConst only exists as a default argument, so we can probably drop it.</p>
</blockquote>
<p>can you say more about "default argument" here?</p>



<a name="277458961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458961">(Apr 01 2022 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor/near/277458736">said</a>:</p>
<blockquote>
<p>Right, just want to make sure I'm advocating for the right change :)</p>
</blockquote>
<p>I still feel strongly that we should align the "way we talk and think about it" with "the way it's implemented", but it may be that dealing with constants makes me want to change the former, not the latter</p>



<a name="277458990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277458990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277458990">(Apr 01 2022 at 18:16)</a>:</h4>
<p>it's the default value of the generic parameter, and this is going to be substituted anyway by the actual value</p>



<a name="277459014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459014">(Apr 01 2022 at 18:16)</a>:</h4>
<p>in what context?</p>



<a name="277459029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459029">(Apr 01 2022 at 18:16)</a>:</h4>
<p>like, do you mean that you have a specific example where this is the case?</p>



<a name="277459245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459245">(Apr 01 2022 at 18:18)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">F</span>: <span class="kt">u32</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">F</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">                      </span><span class="o">^^^^^</span><span class="w"></span>
</code></pre></div>



<a name="277459392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459392">(Apr 01 2022 at 18:19)</a>:</h4>
<p>The <code>{ 5 }</code> is the AnonConst we are talking about.</p>



<a name="277459566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459566">(Apr 01 2022 at 18:20)</a>:</h4>
<p>correct and what I was saying is for this <code>{ 5 }</code> anon, I guess I could leave the same ids in the <code>OpaqueDef</code></p>



<a name="277459589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459589">(Apr 01 2022 at 18:20)</a>:</h4>
<p>I see.</p>



<a name="277459636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459636">(Apr 01 2022 at 18:21)</a>:</h4>
<p><code>OpaqueDef</code> ids of F, same as in the fn, ids of <code>{ 5 }</code> same as in the fn</p>



<a name="277459654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459654">(Apr 01 2022 at 18:21)</a>:</h4>
<p>that's what I wonder if it's correct</p>



<a name="277459682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459682">(Apr 01 2022 at 18:21)</a>:</h4>
<p>I'm thinking about a case like <code>T: Blah&lt;[u8; { .... }]&gt;</code></p>



<a name="277459747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459747">(Apr 01 2022 at 18:21)</a>:</h4>
<p>I have to review how those kind of things are setup right now, when exactly they get isolated</p>



<a name="277459763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459763">(Apr 01 2022 at 18:21)</a>:</h4>
<p>but I don't see any fundamental problem</p>



<a name="277459856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459856">(Apr 01 2022 at 18:22)</a>:</h4>
<p>I suspect we just want to use the same def-id in both cases</p>



<a name="277459867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277459867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277459867">(Apr 01 2022 at 18:22)</a>:</h4>
<p>but apply it to different arguments</p>



<a name="277460058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460058">(Apr 01 2022 at 18:23)</a>:</h4>
<p>Do you mean create an ad-hoc <code>const Foo&lt;T&gt; = { ... }</code> and use it?</p>



<a name="277460178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460178">(Apr 01 2022 at 18:24)</a>:</h4>
<p>No</p>



<a name="277460192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460192">(Apr 01 2022 at 18:24)</a>:</h4>
<p>I mean, we already do that</p>



<a name="277460202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460202">(Apr 01 2022 at 18:24)</a>:</h4>
<p>if I 'm not mistaken</p>



<a name="277460215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460215">(Apr 01 2022 at 18:24)</a>:</h4>
<p>that is, those constants have their own def-ids</p>



<a name="277460301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460301">(Apr 01 2022 at 18:25)</a>:</h4>
<p>Where do we do that?</p>



<a name="277460362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460362">(Apr 01 2022 at 18:25)</a>:</h4>
<p>I probably don't mean the same thing you did</p>



<a name="277460401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460401">(Apr 01 2022 at 18:26)</a>:</h4>
<p>The constants have their own def-id, but having generic parameters of their own would be new.</p>



<a name="277460442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460442">(Apr 01 2022 at 18:26)</a>:</h4>
<p>For now, they only have those of the enclosing item.</p>



<a name="277460522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277460522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277460522">(Apr 01 2022 at 18:27)</a>:</h4>
<p>I have to go review later, gotta focus on other things for now :)</p>



<a name="277508843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277508843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277508843">(Apr 02 2022 at 05:52)</a>:</h4>
<p>we can still re-use the constant from the function. it doesn't matter that it is using the generics from the function, as we can still substitute those.</p>
<p>basically reference that constant as <code>function_path::&lt;X, Y, Z&gt;::{constant#42}</code> where <code>X, Y, Z</code> are in the space of the opaque type. This may get a bit messy around lifetimes though, as the opaque type may not be binding all lifetimes so we end up having to insert <code>'static</code> for those</p>



<a name="277508873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315482-t-compiler/etc/opaque-types/topic/rpit%20refactor/near/277508873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315482-t-compiler/etc/opaque-types/topic/rpit.20refactor.html#277508873">(Apr 02 2022 at 05:52)</a>:</h4>
<p>as a first version we could also just use <code>'static</code> for all the lifetime params</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>