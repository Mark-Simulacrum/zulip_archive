<html>
<head><meta charset="utf-8"><title>Basic-blocks and move/init · t-compiler/wg-polonius · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/index.html">t-compiler/wg-polonius</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html">Basic-blocks and move/init</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260462029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260462029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260462029">(Nov 05 2021 at 20:42)</a>:</h4>
<p>I took a little break from .next to work on one of the simpler tasks I mentioned <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20Hackathon.202021-07-30/near/247609442">prior to the resumption of Polonius sprints</a>, speeding up move/inits by taking advantage of basic blocks.</p>
<p>I wrote up an experience report as part of <a href="https://github.com/rust-lang/polonius/issues/182">rust-lang/polonius#182</a>, but it's quite long for such a simple idea, so don't feel obligated to read the whole thing. It's targeted more at neophytes. However, it does discuss some shortcomings in Soufflé (not sure if they're in DDLog) that we'll encounter if we try to use more basic-block aware analyses as well as some workarounds I found. These don't really apply to <code>datafrog</code>, where we have total control over the underlying queries.</p>



<a name="260469320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260469320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260469320">(Nov 05 2021 at 21:54)</a>:</h4>
<p>that is a lovely write-up (shame about the soufflé shortcomings tho)</p>



<a name="260469417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260469417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260469417">(Nov 05 2021 at 21:56)</a>:</h4>
<p>(this exploration into the "everything is horn clauses" mantra also reminded me of a paper arguing for the use of Horn clauses as the compiler IR)</p>



<a name="260470636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260470636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260470636">(Nov 05 2021 at 22:08)</a>:</h4>
<p>I was also expecting that a solution to the move/init inefficiencies would be to use the MIR dataflow framework (or possibly even the correct  <code>Analysis</code>directly) — and was also maybe contemplating this for liveness</p>



<a name="260470955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260470955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260470955">(Nov 05 2021 at 22:11)</a>:</h4>
<p>(depending on exactly how the split would be chosen, it could e.g. have meant having a shared library of types/traits close to fact gen, either in the same shared type library that chalk has, or one in the same spirit)</p>



<a name="260474594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260474594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260474594">(Nov 05 2021 at 22:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Basic-blocks.20and.20move.2Finit/near/260470636">said</a>:</p>
<blockquote>
<p>I was also expecting that a solution to the move/init inefficiencies would be to use the MIR dataflow framework (or possibly even the correct  <code>Analysis</code>directly) — and was also maybe contemplating this for liveness</p>
</blockquote>
<p>Yeah, this would also work. Both Souffle and DDLog allow you to call arbitrary functions in rule bodies as constraints, as does <code>datafrog</code>. Unfortunately, doing this in Souffle would require C++ bindings to the dataflow framework, which is huge bummer.</p>



<a name="260476637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260476637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260476637">(Nov 05 2021 at 23:26)</a>:</h4>
<p>(that was a very enjoyable read, you should post it to your blog :)</p>



<a name="260476766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260476766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260476766">(Nov 05 2021 at 23:28)</a>:</h4>
<div class="message_inline_image"><a href="https://imgs.xkcd.com/comics/superlative.png"><img src="https://uploads.zulipusercontent.net/fae6361411ff8b7811c40eb28681fd24846cbcdb/68747470733a2f2f696d67732e786b63642e636f6d2f636f6d6963732f73757065726c61746976652e706e67"></a></div><p>"His blog has four posts, all apologies for not posting more"</p>



<a name="260476903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260476903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260476903">(Nov 05 2021 at 23:30)</a>:</h4>
<p>:D</p>



<a name="260477460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260477460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260477460">(Nov 05 2021 at 23:38)</a>:</h4>
<p>I'll also say, just so I don't forget, that it's not quite as simple as hooking up datalog with a dataflow cursor. Cursors are only efficient if you visit statements in dataflow order (backwards for liveness), in random order each seek is worst-case linear in the number of statements per block. This can be problematic when you have something that propagates forward but also needs to check liveness. One option is to cache liveness data within a basic block, since we should be generating many facts for the same basic block in a row.</p>



<a name="260477565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260477565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260477565">(Nov 05 2021 at 23:40)</a>:</h4>
<p>and you could use a more advanced caching strategy if that's not enough.</p>



<a name="260673073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673073">(Nov 08 2021 at 15:34)</a>:</h4>
<p>one thing I am very curious about:</p>



<a name="260673099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673099">(Nov 08 2021 at 15:34)</a>:</h4>
<p>whether a top-down approach (vs bottom-up) would be a winner</p>



<a name="260673118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673118">(Nov 08 2021 at 15:35)</a>:</h4>
<p>for example, for MIR, when we compute liveness, we do it per-variable</p>



<a name="260673120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673120">(Nov 08 2021 at 15:35)</a>:</h4>
<p>we don't use bit sets</p>



<a name="260673134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673134">(Nov 08 2021 at 15:35)</a>:</h4>
<p>I found that to be quite a bit faster</p>



<a name="260673184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673184">(Nov 08 2021 at 15:35)</a>:</h4>
<p>that's not really <em>top down</em> but it does show that sometimes tracing through the IR for one particular thing is better than not</p>



<a name="260673224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673224">(Nov 08 2021 at 15:36)</a>:</h4>
<p>I could imagine that, e.g., looking at each use of a variable and just checking whether it's initiailized, borrowed, etc might actually be faster, particularly if we added in some kind of incremental approach ala DD Log</p>



<a name="260673298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673298">(Nov 08 2021 at 15:36)</a>:</h4>
<p>well, the incremental isn't really needed per se</p>



<a name="260673320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673320">(Nov 08 2021 at 15:36)</a>:</h4>
<p>I'm just saying if we cache the results from a particular point</p>



<a name="260673341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260673341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260673341">(Nov 08 2021 at 15:36)</a>:</h4>
<p>this could work <em>particularly</em> well combined with a naive analysis to highlight potential errors</p>



<a name="260716299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260716299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260716299">(Nov 08 2021 at 20:45)</a>:</h4>
<p>particularly well compared to the current move/init or to rustc’s move/init analysis ? (I’m still personally a tad skeptical about using datalog for move/init tbh)</p>



<a name="260729496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260729496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260729496">(Nov 08 2021 at 22:41)</a>:</h4>
<p>either, imo</p>



<a name="260729505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260729505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260729505">(Nov 08 2021 at 22:41)</a>:</h4>
<p>I'm not sure whether <em>datalog</em> is the way to go</p>



<a name="260729522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260729522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260729522">(Nov 08 2021 at 22:41)</a>:</h4>
<p>though I still want to have some kind of crystal clear reference rules</p>



<a name="260729553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260729553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260729553">(Nov 08 2021 at 22:41)</a>:</h4>
<p>but I think that having "coarse-grained" analysis to uncover trouble points and then analyzing those specific trouble points seems like a win</p>



<a name="260729609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260729609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260729609">(Nov 08 2021 at 22:42)</a>:</h4>
<p>we certainly have problems in rustc with propagating tons of bits being slow, too</p>



<a name="260784758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks%20and%20move/init/near/260784758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Basic-blocks.20and.20move.2Finit.html#260784758">(Nov 09 2021 at 11:33)</a>:</h4>
<p>the idea has potential (and it sounds to me like there'd be a tipping point where one of the 2 approaches is better than the other) and we should surely try it at the very least</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>