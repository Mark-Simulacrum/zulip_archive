<html>
<head><meta charset="utf-8"><title>`Locations::All` · t-compiler/wg-polonius · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/index.html">t-compiler/wg-polonius</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html">`Locations::All`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260610389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260610389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260610389">(Nov 08 2021 at 02:54)</a>:</h4>
<p>Following up on <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Placeholder.20liveness.20aside/near/250961160">this comment</a>, I found these situations where <code>Locations::All</code> is used:</p>
<ul>
<li>Returns </li>
<li><a href="https://github.com/rust-lang/rust/blob/5fa94f3c57e27a339bc73336cd260cd875026bd1/compiler/rustc_borrowck/src/type_check/input_output.rs#L113-L115">Generator yields</a> (What's up with that span BTW?)</li>
<li>Type annotations<br>
    -  <a href="https://github.com/rust-lang/rust/blob/5fa94f3c57e27a339bc73336cd260cd875026bd1/compiler/rustc_borrowck/src/type_check/input_output.rs#L113-L115">(on statements)</a><br>
     - <a href="https://github.com/rust-lang/rust/blob/5fa94f3c57e27a339bc73336cd260cd875026bd1/compiler/rustc_borrowck/src/type_check/mod.rs#L491-L496">(on variables/args)</a></li>
</ul>
<p>All but the last have have an obvious location in the MIR (<code>Return</code> terminators, <code>Yield</code> terminators, the statement with the type annotation, and (for function args) the entry to the function (where it should propagate since function arguments are live to start)). However, for type annotations on variable declarations, I think we would need to emit the outlives constraint at all locations where the variable is assigned? This would be a bit of a pain.</p>
<p>We could also switch to a <code>subset_everywhere</code> relation for <code>Locations::All</code> outlives constraints and either use disjunction or seed <code>subset_base</code> with <code>subset_everywhere</code> when both origins are live (or, for the optimized variant, one becomes live). This would fix the cases where we have several GBs of <code>subset</code> tuples, many of which are ignored since the origin (e.g. the return place) is not live.</p>



<a name="260611623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260611623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260611623">(Nov 08 2021 at 03:23)</a>:</h4>
<p>On the other hand, I wonder if some of the places where <code>Locations::All</code> is used don't actually generate constraints: the variable type case is part of <a href="https://github.com/rust-lang/rust/blob/5fa94f3c57e27a339bc73336cd260cd875026bd1/compiler/rustc_borrowck/src/type_check/mod.rs#L330-L336"><code>TypeVerifier</code></a>, which claims to be solely a sanity check.</p>



<a name="260613420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260613420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260613420">(Nov 08 2021 at 04:07)</a>:</h4>
<p>No. It looks like <code>TypeVerifier</code> is responsible for generating constraints.</p>



<a name="260648022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260648022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260648022">(Nov 08 2021 at 12:05)</a>:</h4>
<p>(splitting the outlives relations into two à la <code>subset_everywhere</code> was the approach I prototyped in <a href="https://github.com/lqd/borrow-check/commits/fix_oom">https://github.com/lqd/borrow-check/commits/fix_oom</a> (as you've seen a rustc branch generating these facts is simple, but <a href="https://github.com/lqd/rust/tree/fix_oom">here it was</a>). Since it impacted rules subtly, in order to not miss subsets while also not just moving the materializations from rustc to polonius, niko preferred prototyping changing fact gen in rustc, in their own different branch)</p>



<a name="260672368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672368">(Nov 08 2021 at 15:30)</a>:</h4>
<p>I think I had a similar analysis, <span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span>, some time back.</p>



<a name="260672394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672394">(Nov 08 2021 at 15:30)</a>:</h4>
<p>I'm wondering: if we change (say) return types or member constraints</p>



<a name="260672422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672422">(Nov 08 2021 at 15:30)</a>:</h4>
<p>I think perhaps we permit some weirdness in code that doesn't return ?</p>



<a name="260672429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672429">(Nov 08 2021 at 15:30)</a>:</h4>
<p>maybe not</p>



<a name="260672462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672462">(Nov 08 2021 at 15:30)</a>:</h4>
<p>regarding type annotations, I'm curious</p>



<a name="260672597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672597">(Nov 08 2021 at 15:31)</a>:</h4>
<p>I think we may ultimately want to move to a set of facts that more closely matches the MIR, and in particular not to include (e.g.) <code>clear_origin</code> but more like <code>var_assigned(X, N)</code> and <code>type_of_var(X, T)</code> and <code>origin_in_type(T, O)</code>, from which we can deducate <code>clear_origin(X, O, N)</code>.</p>



<a name="260672635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260672635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260672635">(Nov 08 2021 at 15:31)</a>:</h4>
<p>in this case, could we also readily deduce "inserting" the required subset relations at each point that the var is assigned?</p>



<a name="260692318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260692318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260692318">(Nov 08 2021 at 17:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/.60Locations.3A.3AAll.60/near/260672635">said</a>:</p>
<blockquote>
<p>in this case, could we also readily deduce "inserting" the required subset relations at each point that the var is assigned?</p>
</blockquote>
<p>Thinking adversarially, what if we had a local that is only initialized via a raw pointer? (This is outside the realm of well-defined Rust, but I don't think it's UB at the moment):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">i32</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">addr_of_mut</span><span class="o">!</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>x</code> is never defined, so I'm worried that this would type check (because the type checker would see that <code>x</code> has the same type as the return place) and also borrow check (since without a definition we would never associate the existential region variable for <code>x</code>'s local with <code>'a</code>).</p>



<a name="260692556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260692556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260692556">(Nov 08 2021 at 17:45)</a>:</h4>
<p>Surprisingly, <code>addr_of</code> causes an error because <code>x</code> is uninitialized. I think this is a bug in <code>addr_of</code>. Part of the reason it exists is to create pointers to uninitialized data.</p>



<a name="260697620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260697620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260697620">(Nov 08 2021 at 18:19)</a>:</h4>
<p>yes, we've often discussed whether that is allowed</p>



<a name="260697668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260697668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260697668">(Nov 08 2021 at 18:19)</a>:</h4>
<p>I'm not sure I agree that this is an error</p>



<a name="260697674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260697674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260697674">(Nov 08 2021 at 18:19)</a>:</h4>
<p>I think locals are different than other forms of storage</p>



<a name="260697749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260697749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260697749">(Nov 08 2021 at 18:20)</a>:</h4>
<p>I suspect we also want, for example, the freedom to reuse storage once it has been "moved out" from</p>



<a name="260697803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260697803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260697803">(Nov 08 2021 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/.60Locations.3A.3AAll.60/near/260697668">said</a>:</p>
<blockquote>
<p>I'm not sure I agree that this is an error</p>
</blockquote>
<p>er, I mean that it should be considered "ok"</p>



<a name="260697823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/%60Locations%3A%3AAll%60/near/260697823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/.60Locations.3A.3AAll.60.html#260697823">(Nov 08 2021 at 18:21)</a>:</h4>
<p>still, good question</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>