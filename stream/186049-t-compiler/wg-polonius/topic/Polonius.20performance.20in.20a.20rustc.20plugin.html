<html>
<head><meta charset="utf-8"><title>Polonius performance in a rustc plugin · t-compiler/wg-polonius · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/index.html">t-compiler/wg-polonius</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html">Polonius performance in a rustc plugin</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251301631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251301631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251301631">(Aug 30 2021 at 22:00)</a>:</h4>
<p>Hey team. I'm using the recently added <a href="https://github.com/rust-lang/rust/pull/86977#issuecomment-902129360"><code>get_body_with_borrowck_facts</code></a> to extract outlives-constraints for my <a href="https://github.com/willcrichton/flowistry">program slicer</a>. However, this is causing serious performance issues.</p>
<p>To run <code>get_body_with_borrowck_facts</code>, I have to enable <code>-Z polonius</code>. This, I assume, replaces the standard borrow checker with polonius in all cases, even though I only need polonius for a small set of functions of interest. The issue is that Polonius is <em>slow</em>. For example, if I run <code>cargo check</code> on <a href="https://github.com/rg3dengine/rg3d">rg3d</a>, this takes 3sec on the main crate. If I run with <code>-Z polonius</code>, this takes <strong>30sec</strong>! So my plugin has to wait 30sec before even starting to compute / return an answer to the user.</p>
<p>Do y'all have any recommendations for how to address this? Barring Polonius getting substantially faster, is there a way for me to call Polonius without having it be the default borrow checker?</p>



<a name="251335857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251335857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251335857">(Aug 31 2021 at 05:57)</a>:</h4>
<p>There is currently no way to have facts and call polonius without it being the default borrow checker.</p>



<a name="251335944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251335944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251335944">(Aug 31 2021 at 05:58)</a>:</h4>
<p>What is likely slow though is the move/init analysis, so there’s an experiment you could do if you have a locally compiled rustc</p>



<a name="251336244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251336244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251336244">(Aug 31 2021 at 06:02)</a>:</h4>
<p>Add an override to rustc Cargo.toml to use a local polonius. There, inhibit the move errors computation by commenting <a href="https://github.com/rust-lang/polonius/blob/0cbbb7c6b2f9dd713266b77c0c13903ac16e1679/polonius-engine/src/output/initialization.rs#L229">https://github.com/rust-lang/polonius/blob/0cbbb7c6b2f9dd713266b77c0c13903ac16e1679/polonius-engine/src/output/initialization.rs#L229</a> and the rules that compute this relation</p>



<a name="251336364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251336364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251336364">(Aug 31 2021 at 06:04)</a>:</h4>
<p>(The var_maybe_partly_initialized_on_exit relation is used in the following steps so don’t comment this one out) if you run tests only the ones dealing with move errors should fail then</p>



<a name="251336779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251336779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251336779">(Aug 31 2021 at 06:08)</a>:</h4>
<p>In some cases this is enough to have acceptable speeds, like on the in-tree benchmarks. But sometimes it isn’t enough, and if that’s the case then it’s going to be a bit harder (with more modifications in rustc to avoid this analysis altogether, or a way for polonius to use rustc’s dataflow framework) or wait until we do it</p>



<a name="251336900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251336900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251336900">(Aug 31 2021 at 06:10)</a>:</h4>
<p>It would be interesting to see which functions in that crate are slow, and which parts of the polonius pipeline are slow on these functions</p>



<a name="251337005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/251337005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#251337005">(Aug 31 2021 at 06:12)</a>:</h4>
<p>Especially as it could also be generating the facts themselves that is slow on e.g. big functions, or another of the pipeline steps, rather than move/init analysis.</p>



<a name="253336333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253336333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253336333">(Sep 14 2021 at 22:54)</a>:</h4>
<p>Ok re: the concerns here. I did some perf analysis of polonius but saw nothing obvious I could help with (barring a deep dive into datafrog internals that I know nothing about).</p>
<p>Would there be any objections to just changing the policy so <code>body_with_borrowck_facts</code> can be used even if <code>-Z polonius</code> is not enabled? Here's what that would look like: <a href="https://github.com/rust-lang/rust/compare/master...willcrichton:allow-single-polonius-call?expand=1">https://github.com/rust-lang/rust/compare/master...willcrichton:allow-single-polonius-call?expand=1</a></p>



<a name="253374538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253374538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253374538">(Sep 15 2021 at 07:40)</a>:</h4>
<p>did you also try what I suggested above ? that would be interesting information for us to have</p>



<a name="253374933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253374933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253374933">(Sep 15 2021 at 07:44)</a>:</h4>
<p>in general, it'd be nice to avoid expanding this unstable API too much, as our hopes/plans are to eventually change all these internal details, but at the same time it doesn't really hurt for <code>body_with_borrowck_facts</code> to have this kind of control</p>



<a name="253454694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253454694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253454694">(Sep 15 2021 at 17:26)</a>:</h4>
<p>I tried compiling against a local polonius, but I get this error:</p>
<div class="codehilite"><pre><span></span><code>   Compiling rustc_borrowck v0.0.0 (/raid/wcrichto/rust.slicer/compiler/rustc_borrowck)
error[E0277]: the trait bound `rustc_middle::ty::RegionVid: Atom` is not satisfied
   --&gt; compiler/rustc_borrowck/src/facts.rs:19:5
    |
19  |     type Origin = RegionVid;
    |     ^^^^^^^^^^^^^^^^^^^^^^^^ the trait `Atom` is not implemented for `rustc_middle::ty::RegionVid`
    |
note: required by a bound in `polonius_engine::FactTypes::Origin`
   --&gt; /raid/wcrichto/polonius/polonius-engine/src/facts.rs:124:18
    |
124 |     type Origin: Atom;
    |                  ^^^^ required by this bound in `polonius_engine::FactTypes::Origin`
</code></pre></div>
<p>I got this with both polonius master and the polonius-engine-v0.13.0 branch. Any suggestions?</p>



<a name="253455156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253455156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253455156">(Sep 15 2021 at 17:29)</a>:</h4>
<p>All  index types (<code>BorrowIndex</code>, <code>Local</code>, etc.) should have <code>Atom</code> impls, which is just Polonius' version of an <code>Index</code> trait. Not sure how that one got lost though? Maybe the <code>rustc_mir</code> split?</p>



<a name="253455163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253455163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253455163">(Sep 15 2021 at 17:29)</a>:</h4>
<p>ah it may be because a lot of crates were changed recently</p>



<a name="253455616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253455616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253455616">(Sep 15 2021 at 17:32)</a>:</h4>
<p>(the split being <a href="https://github.com/rust-lang/rust/pull/80522">https://github.com/rust-lang/rust/pull/80522</a>)</p>



<a name="253455933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253455933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253455933">(Sep 15 2021 at 17:35)</a>:</h4>
<p>maybe some stale incremental state ? as you can see <code>RegionVid</code> does implement <code>Atom</code> <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.RegionVid.html#impl-Atom">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.RegionVid.html#impl-Atom</a></p>



<a name="253456857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253456857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253456857">(Sep 15 2021 at 17:41)</a>:</h4>
<p>Oh I see, I only patched <code>rustc_borrowck</code> but not other crates that depended on <code>polonius-engine</code>, so it was a version mismatch error. Should work now, I'll report back.</p>



<a name="253456942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253456942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253456942">(Sep 15 2021 at 17:41)</a>:</h4>
<p>Also, I filed a PR for my proposed change: <a href="https://github.com/rust-lang/rust/pull/88983">https://github.com/rust-lang/rust/pull/88983</a></p>



<a name="253460416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253460416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253460416">(Sep 15 2021 at 18:01)</a>:</h4>
<p>though if you're only using the outlives constraints in your tool, it doesn't seem like you'd be interested in calling polonius at all ?</p>



<a name="253460729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253460729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253460729">(Sep 15 2021 at 18:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="265377">Will Crichton</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin/near/253456857">said</a>:</p>
<blockquote>
<p>I only patched <code>rustc_borrowck</code> but not other crates that depended on <code>polonius-engine</code></p>
</blockquote>
<p>IIRC you don't need to patch all crates using <code>polonius-engine</code> to point to your local fork but only add a <a href="http://crates.io">crates.io</a> override to the root Cargo.toml</p>



<a name="253462200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253462200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253462200">(Sep 15 2021 at 18:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin/near/253460416">said</a>:</p>
<blockquote>
<p>though if you're only using the outlives constraints in your tool, it doesn't seem like you'd be interested in calling polonius at all ?</p>
</blockquote>
<p>(especially since you mentioned it was slow for your use case, calling it to compute analyses you don't need seems unfortunate)</p>



<a name="253463518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253463518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253463518">(Sep 15 2021 at 18:22)</a>:</h4>
<p>highfive is defo sleeping on the job tho</p>



<a name="253463671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253463671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253463671">(Sep 15 2021 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin/near/253460416">said</a>:</p>
<blockquote>
<p>though if you're only using the outlives constraints in your tool, it doesn't seem like you'd be interested in calling polonius at all ?</p>
</blockquote>
<p>So generally, I'm interested in computing the points-to set for lifetimes. My initial implementation used the outlives-constraints graph (specifically the <code>ConstraintSccGraph</code> generated during <code>mir_borrowck</code>), on which I did a simple flow-insensitive algorithm. Something like: <code>&amp;'n place =&gt; place \in points-to('n)</code> and <code>'a :&gt; 'b =&gt; points-to('b) \subseteq points-to('a)</code>.</p>
<p>If Polonius is computing a similar kind of points-to set, then I would just use that directly.</p>



<a name="253464017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253464017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253464017">(Sep 15 2021 at 18:26)</a>:</h4>
<p>I suspect that <code>origin_contains_loan_at</code>, or maybe <code>origin_contains_loan_anywhere</code>, or <code>known_contains</code> all might be related to what I want?</p>



<a name="253464517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253464517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253464517">(Sep 15 2021 at 18:29)</a>:</h4>
<p>related yes, maybe not in a straigthforward way to get back to the spans you probably need in you slices but yeah</p>



<a name="253464823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253464823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253464823">(Sep 15 2021 at 18:31)</a>:</h4>
<p>That's ok, I just need MIR places. I do all the span computations separately. Are these fields documented anywhere?</p>



<a name="253464862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253464862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253464862">(Sep 15 2021 at 18:31)</a>:</h4>
<p>ok I think I understand, you may now want to change your initial approach if polonius helped you achieve your goal, and the PR above was more specifically that you'd want to say interactively slice parts of a function at a time, while -Z polonius applies to the whole crate/dependency tree ?</p>



<a name="253465103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253465103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253465103">(Sep 15 2021 at 18:33)</a>:</h4>
<p>the last relation is an input and is documented in the facts</p>



<a name="253465267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253465267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253465267">(Sep 15 2021 at 18:34)</a>:</h4>
<p>while the other two are one of the results of the loan analyses (naive/opt, and location insensitive, respectively)</p>



<a name="253465428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253465428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253465428">(Sep 15 2021 at 18:35)</a>:</h4>
<p>Generally, I still only want to slice one function at a time, so the PR is still relevant. I'm building a VSCode extension that you would interactively call as you develop in a Rust workspace. This requires running essentially <code>rustc --profile check</code> on the current crate. I need that step to be as fast as possible, and _then_ I call into Polonius for the specific function I'm slicing.</p>



<a name="253465876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253465876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253465876">(Sep 15 2021 at 18:38)</a>:</h4>
<p>understood (I hope). to be clear I meant that if you still only used the SCCs to do your slicing then polonius wouldn't be useful to you, but I seem to understand you're now kind of prototyping whether it would actually be useful compared to your previous approach, and that is still TBD</p>



<a name="253465952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253465952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253465952">(Sep 15 2021 at 18:39)</a>:</h4>
<p>the PR above making your prototyping/evaluation at the very least possible or less painful</p>



<a name="253479339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253479339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253479339">(Sep 15 2021 at 20:08)</a>:</h4>
<p>Btw I'm running into an issue where the <code>Output</code> from <code>body_with_borrowck_facts</code> is empty -- any obvious reason why that might happen? The input facts are populated, but output facts are not.</p>



<a name="253479416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253479416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253479416">(Sep 15 2021 at 20:09)</a>:</h4>
<p>are all output relations empty ?</p>



<a name="253479589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253479589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253479589">(Sep 15 2021 at 20:10)</a>:</h4>
<p>Yes</p>



<a name="253479764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253479764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253479764">(Sep 15 2021 at 20:11)</a>:</h4>
<p>as a sanity check, could you try polonius on the same inputs ?</p>



<a name="253479800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253479800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253479800">(Sep 15 2021 at 20:11)</a>:</h4>
<p>(the binary, not via rustc)</p>



<a name="253480028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480028">(Sep 15 2021 at 20:13)</a>:</h4>
<p>is there a document for how to do that? like i assume i need to dump the facts then pass them to the polonius binary</p>



<a name="253480115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480115">(Sep 15 2021 at 20:13)</a>:</h4>
<p>the readme does explain it yes <a href="https://github.com/rust-lang/polonius">https://github.com/rust-lang/polonius</a></p>



<a name="253480238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480238">(Sep 15 2021 at 20:14)</a>:</h4>
<p>but basically, you <code>-Znll-facts</code> to get the facts (probably with<code>-Zborrowck=mir</code> as well, in case full NLLs are not enabled) and run polonius on that</p>



<a name="253480638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480638">(Sep 15 2021 at 20:16)</a>:</h4>
<p>oh actually it seems like output is generally only populated if <code>dump_enabled</code> is true, and right now it's set to false</p>



<a name="253480788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480788">(Sep 15 2021 at 20:17)</a>:</h4>
<p>that's why I asked if all relations were empty</p>



<a name="253480839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480839">(Sep 15 2021 at 20:18)</a>:</h4>
<p>only some of them require <code>dump_enabled</code> to be filled</p>



<a name="253480892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480892">(Sep 15 2021 at 20:18)</a>:</h4>
<p>ah so maybe that's not it then</p>



<a name="253480913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480913">(Sep 15 2021 at 20:18)</a>:</h4>
<p>as they're mostly used for debugging purposes</p>



<a name="253480963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253480963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253480963">(Sep 15 2021 at 20:18)</a>:</h4>
<p>which relation would be non-empty for a valid program?</p>



<a name="253481016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253481016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253481016">(Sep 15 2021 at 20:19)</a>:</h4>
<p>let's try it instead with an invalid program and check for errors :3</p>



<a name="253481185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253481185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253481185">(Sep 15 2021 at 20:20)</a>:</h4>
<p>our goal is to emit errors so it may not be set up right for the opposite use case heh</p>



<a name="253482633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253482633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253482633">(Sep 15 2021 at 20:31)</a>:</h4>
<p>ok after setting dump enabled to true and recompiling i'm getting the output i expected</p>



<a name="253482688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253482688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253482688">(Sep 15 2021 at 20:32)</a>:</h4>
<p>...i suppose i should file another PR that sets <code>dump_enabled</code> to true only when <code>body_with_borrowck_facts</code> is called, since that's the only time the extra info would be relevant</p>



<a name="253482900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253482900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253482900">(Sep 15 2021 at 20:33)</a>:</h4>
<p>maybe check with <span class="user-mention" data-user-id="116109">@Vytautas Astrauskas [he/him]</span> if that's also a use-case they have</p>



<a name="253483091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483091">(Sep 15 2021 at 20:34)</a>:</h4>
<p>it may be the case that they wouldn't need/want that, in case it also hurts performance to add too much debug output, say</p>



<a name="253483714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483714">(Sep 15 2021 at 20:37)</a>:</h4>
<p>right, maybe what would make more sense is gathering <code>AllFacts</code> from the call, and then implementing my analysis in polonius</p>



<a name="253483783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483783">(Sep 15 2021 at 20:37)</a>:</h4>
<p>but if you're still in the prototyping phase, maybe have <code>dump_enabled</code> always true locally, so that you're not blocked by it, and then when you know whether it's a viable option for you, you can open PRs in coordination with him so that both your use-cases are taken care of ?</p>



<a name="253483894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483894">(Sep 15 2021 at 20:38)</a>:</h4>
<p>yeah, although since my tool is user-facing it's important to have nightly compatibility if I want people to test it out</p>



<a name="253483909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483909">(Sep 15 2021 at 20:38)</a>:</h4>
<p>so i'm trying hard to not fork rustc</p>



<a name="253483966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483966">(Sep 15 2021 at 20:38)</a>:</h4>
<p>sure, understandable</p>



<a name="253483967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253483967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253483967">(Sep 15 2021 at 20:38)</a>:</h4>
<p>but yes i'll coordinate with vytautas</p>



<a name="253484252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253484252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253484252">(Sep 15 2021 at 20:40)</a>:</h4>
<p>great :)</p>



<a name="253484281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253484281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253484281">(Sep 15 2021 at 20:41)</a>:</h4>
<p>thank you for all the help <span class="user-mention" data-user-id="116113">@lqd</span> !</p>



<a name="253484331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253484331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253484331">(Sep 15 2021 at 20:41)</a>:</h4>
<p>I think they mentioned the relation they were interested in the PR introducing this mechanism, let me look it up</p>



<a name="253484340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253484340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253484340">(Sep 15 2021 at 20:41)</a>:</h4>
<p>sure, no problem, happy to help</p>



<a name="253484969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253484969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253484969">(Sep 15 2021 at 20:46)</a>:</h4>
<p>(it may have been here <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20Hackathon.202021-07-30/near/247716245">https://rust-lang.zulipchat.com/#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20Hackathon.202021-07-30/near/247716245</a> — they'll tell us eventually :)</p>



<a name="253489711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253489711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vytautas Astrauskas [he/him] <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253489711">(Sep 15 2021 at 21:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin/near/253482900">said</a>:</p>
<blockquote>
<p>maybe check with <span class="user-mention silent" data-user-id="116109">Vytautas Astrauskas [he/him]</span> if that's also a use-case they have</p>
</blockquote>
<p>Sounds like our use case. (I am currently a bit buried. I will check later.)</p>



<a name="253846670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253846670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vytautas Astrauskas [he/him] <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253846670">(Sep 18 2021 at 07:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="265377">Will Crichton</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin/near/253480638">said</a>:</p>
<blockquote>
<p>oh actually it seems like output is generally only populated if <code>dump_enabled</code> is true, and right now it's set to false</p>
</blockquote>
<p>In Prusti, we are currently not using the Polonius output facts from the compiler. We call Polonius ourselves with <code>dump_enabled</code>.</p>



<a name="253892062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253892062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253892062">(Sep 18 2021 at 20:33)</a>:</h4>
<p>I thought <code>get_body_with_borrowck_facts</code> called polonius ?</p>



<a name="253892154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/253892154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#253892154">(Sep 18 2021 at 20:35)</a>:</h4>
<p>(but just getting the input facts and calling it directly could also be an interesting alternative I presume, so that the variant, <code>dump_enabled</code>, etc can be more easily controlled by the caller without complicating rustc's API)</p>



<a name="254721572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/254721572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#254721572">(Sep 24 2021 at 15:22)</a>:</h4>
<p>(this was the comment from Vytautas I couldn't find, and to which I was referring earlier, about the facts that prusti was interested in <a href="https://github.com/rust-lang/datafrog/pull/40#issuecomment-904902526">https://github.com/rust-lang/datafrog/pull/40#issuecomment-904902526</a> it was in the datafrog repository)</p>



<a name="261833667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/261833667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#261833667">(Nov 17 2021 at 19:15)</a>:</h4>
<p>btw just to bump this, polonius is still the <a href="https://github.com/rust-lang/rust/issues/1">#1</a> bottleneck in my plugin... i'm seeing times up to 2 minutes to analyze a single (large) function. if anyone is working on polonius performance, I would be happy to work with you / contribute to making things faster, although idk where to start</p>



<a name="261836845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/261836845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#261836845">(Nov 17 2021 at 19:40)</a>:</h4>
<p>I remember asking before about your timings but don’t remember details: which parts of the pipeline are slow, fact gen, move/init, liveness, loan analysis, all of them ? What numbers are you seeing for each of these parts ?</p>
<p>I think we mentioned a workaround last time if the slowness was in computing move errors: they can be manually commented out, while making sure the other relation is still computed for liveness; but that’s unlikely to be super helpful in other situations than during development.</p>
<p>if it’s the 2 first two analyses that take a while, then there is a simple but controversial fix: removing move/init analysis and liveness computation — or being able to bypass them, say (eg with a different flag value) that’s likely less controversial — and go back to using rustc computed liveness. One could imagine adding the liveness relation back in rustc, and in polonius jumping straight to loan analysis if the relation is filled.</p>



<a name="261842613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/261842613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#261842613">(Nov 17 2021 at 20:18)</a>:</h4>
<p>(I don't know about controversial, it seems like an option we should provide at least)</p>



<a name="261860900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/261860900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#261860900">(Nov 17 2021 at 22:36)</a>:</h4>
<p>I also think we probably should, we'll know more on how pressing it is when we see Will's numbers. Until we finalize the rules, ensure they're correct and expressive enough, etc, working on performance (although fun) may be a bit premature but at least this should help fix this issue here, and be relatively easy to do (so it wouldn't be a whole bunch of wasted work if we later change the rules)</p>



<a name="261879477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/261879477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#261879477">(Nov 18 2021 at 02:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin/near/261836845">said</a>:</p>
<blockquote>
<p>I remember asking before about your timings but don’t remember details: which parts of the pipeline are slow, fact gen, move/init, liveness, loan analysis, all of them ? What numbers are you seeing for each of these parts ?</p>
</blockquote>
<p>Happy to run a benchmark, but is there an easy way to profile polonius and distinguish parts of the pipeline without modifying the compiler?</p>



<a name="261915078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/Polonius%20performance%20in%20a%20rustc%20plugin/near/261915078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/Polonius.20performance.20in.20a.20rustc.20plugin.html#261915078">(Nov 18 2021 at 11:30)</a>:</h4>
<p>yes, very easily (in addition to regular profiling tools): </p>
<ul>
<li>fact generation (and the global polonius analysis) already have dedicated events in rustc's self-profiler, so just trying out <a href="https://blog.rust-lang.org/inside-rust/2020/02/25/intro-rustc-self-profile.html">https://blog.rust-lang.org/inside-rust/2020/02/25/intro-rustc-self-profile.html</a> on your function will give numbers for that (depending on the function, and some very specific patterns, this can be big and slow sometimes -- As a reference for others reading this, this is where <code>Locations::All</code> comes in, in addition to the huge, often generated, CFGs with tens of thousands of lifetimes we see in benchmarks)</li>
<li>the "polonius-engine" (the crate rustc uses) can be run out of tree, the repo contains a polonius binary, which loads facts via files on disk (while rustc doesn't serialize them) and runs the engine. rustc can emit these files (via <code>-Znll-facts</code>, there are more details in the readme) so that makes profiling easy as well. but just for ballpark numbers you can also run this binary with logging via <code>RUST_LOG</code>, and each step of the engine pipeline should log partial results, and the time it took to compute them</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>