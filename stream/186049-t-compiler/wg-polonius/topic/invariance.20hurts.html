<html>
<head><meta charset="utf-8"><title>invariance hurts · t-compiler/wg-polonius · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/index.html">t-compiler/wg-polonius</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html">invariance hurts</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277972776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277972776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277972776">(Apr 06 2022 at 03:55)</a>:</h4>
<p>Here is an example that I'd like to revisit at some point:</p>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=c6312219d23da40a3a0114e8b900407e">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=c6312219d23da40a3a0114e8b900407e</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cell</span>::<span class="n">RefCell</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RefCell</span>::<span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[]);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this works on stable, does polonius have trouble with it?</p>



<a name="277974799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277974799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277974799">(Apr 06 2022 at 04:37)</a>:</h4>
<p>it should also compile, although the plan/hope was that we didn’t have to do anything special about variance just yet, if ever.</p>
<p>but I guess it can depend on what you mean by "hurts" and "have trouble" ? Could that be about compatibility like possible errors in code accepted today, or maybe as in "this case is expensive or slow", or something else ?</p>



<a name="277977854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277977854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277977854">(Apr 06 2022 at 05:44)</a>:</h4>
<p>I meant 'does not compile'</p>



<a name="277977868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277977868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277977868">(Apr 06 2022 at 05:44)</a>:</h4>
<p>the (potential) problem is that the type of <code>a</code> must be <code>RefCell&lt;Vec&lt;&amp;L i32&gt;&gt;</code> where <code>L</code> is considered a borrow of <code>p</code></p>



<a name="277977889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277977889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277977889">(Apr 06 2022 at 05:45)</a>:</h4>
<p>i.e., because of the <code>RefCell</code>, you are not allowed to "add" borrows into the vec later as things are pushed, you have to "backpropagate" that constraint</p>



<a name="277977892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277977892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277977892">(Apr 06 2022 at 05:45)</a>:</h4>
<p>I can't remember well enough how we formulated polonius around this but it's been a concern of mine in the past</p>



<a name="277977903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277977903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277977903">(Apr 06 2022 at 05:45)</a>:</h4>
<p>though I think the idea may have been that, yes, the loan is in the vector, but because the borrow hasn't actually <em>happened</em> yet, we don't care</p>



<a name="277977957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277977957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277977957">(Apr 06 2022 at 05:46)</a>:</h4>
<p>I think that works but it's worth noting, because it means loans have an identity that is distinct from the path they are borrowing</p>



<a name="277983293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/invariance%20hurts/near/277983293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/invariance.20hurts.html#277983293">(Apr 06 2022 at 07:13)</a>:</h4>
<p>polonius does not see errors there (but you never know if that's because things are subtly broken or not)</p>
<p>it's worth noting indeed, esp with my reachability experiments, and the tentative discussion of possibly removing loans altogether</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>