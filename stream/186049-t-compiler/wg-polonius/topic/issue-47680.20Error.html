<html>
<head><meta charset="utf-8"><title>issue-47680 Error · t-compiler/wg-polonius · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/index.html">t-compiler/wg-polonius</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html">issue-47680 Error</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257732213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257732213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257732213">(Oct 15 2021 at 17:11)</a>:</h4>
<p>Subsets that arise at <code>b</code> <em>without</em> the <code>None</code> branch (no error):</p>
<div class="codehilite"><pre><span></span><code>subset(&#39;L_Thing, &#39;t0)
subset(&#39;L_Thing, &#39;temp)
subset(&#39;L_Thing, &#39;v)
subset(&#39;t0, &#39;temp)
subset(&#39;t0, &#39;v)
subset(&#39;v, &#39;temp)
</code></pre></div>
<p>Subsets that arise at <code>b</code> <em>without</em> the <code>Some</code> branch (no error):</p>
<div class="codehilite"><pre><span></span><code>subset(&#39;L_*temp, &#39;t0)
subset(&#39;L_*temp, &#39;v)
subset(&#39;L_Thing, &#39;L_*temp)
subset(&#39;L_Thing, &#39;t0)
subset(&#39;L_Thing, &#39;temp)
subset(&#39;L_Thing, &#39;v)
subset(&#39;t0, &#39;v)
subset(&#39;temp, &#39;L_*temp)
subset(&#39;temp, &#39;t0)
subset(&#39;temp, &#39;v)
</code></pre></div>



<a name="257732276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257732276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257732276">(Oct 15 2021 at 17:12)</a>:</h4>
<p>(making a new topic for this)</p>



<a name="257733323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257733323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257733323">(Oct 15 2021 at 17:19)</a>:</h4>
<p>So the <code>None</code> branch has <code>'L_*temp -&gt; 't0</code> and the <code>Some</code> branch has <code>'v -&gt; 'temp</code>, and both have <code>'t0 -&gt; 'v</code></p>



<a name="257733655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257733655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257733655">(Oct 15 2021 at 17:21)</a>:</h4>
<p>What is missing is a notion about this not being able to happen at the same time</p>



<a name="257733662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257733662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257733662">(Oct 15 2021 at 17:21)</a>:</h4>
<p>observation: if you remove the backedge (but keep the unrolled loop), you do not get an error</p>



<a name="257733931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257733931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257733931">(Oct 15 2021 at 17:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/issue-47680.20Error/near/257733662">said</a>:</p>
<blockquote>
<p>observation: if you remove the backedge (but keep the unrolled loop), you do not get an error</p>
</blockquote>
<p>I think it needs 2 iterations (so 3 total), because the access and the invalidation are in the same node (<code>b</code>)</p>



<a name="257734285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257734285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257734285">(Oct 15 2021 at 17:25)</a>:</h4>
<p>Yes</p>



<a name="257734447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257734447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257734447">(Oct 15 2021 at 17:26)</a>:</h4>
<p>Do you think the merging the subset constraints can ever be okay, or do we need to track multiple sets of subset constraints if a node has multiple predecessors?</p>



<a name="257736596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257736596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257736596">(Oct 15 2021 at 17:41)</a>:</h4>
<p>Could we have something like <code>subset_from_pred(O1, O2, AtNode, Pred)</code>, and only compute transitive closure on that with subsets from the same predecessors, then lower that to the regular <code>subset</code>?</p>



<a name="257736827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257736827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257736827">(Oct 15 2021 at 17:43)</a>:</h4>
<p>I don't know! I'm pondering it. =) I think that the "delete subsets if values are dead" in the old polonius could certainly be added here, I have this feeling like it's a kind of "hack" of some kind.</p>



<a name="257736902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257736902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257736902">(Oct 15 2021 at 17:44)</a>:</h4>
<p>But maybe an effective one :)</p>



<a name="257737015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257737015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257737015">(Oct 15 2021 at 17:44)</a>:</h4>
<p>It also seems relevant that the <code>L_*temp</code> on one side is "not the same" as the <code>L_*temp</code> on the other; not sure how to think about that right now.</p>



<a name="257738259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257738259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257738259">(Oct 15 2021 at 17:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="337115">Domenic Quirl</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/issue-47680.20Error/near/257736596">said</a>:</p>
<blockquote>
<p>Could we have something like <code>subset_from_pred(O1, O2, AtNode, Pred)</code>, and only compute transitive closure on that with subsets from the same predecessors, then lower that to the regular <code>subset</code>?</p>
</blockquote>
<p>(I don't think this really works, btw, it seems like at some point we have to combine facts)</p>



<a name="257738398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257738398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257738398">(Oct 15 2021 at 17:54)</a>:</h4>
<p>Yeah, I already realized that this alone just delays the merge by 1 step <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="257741131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741131">(Oct 15 2021 at 18:13)</a>:</h4>
<p>I'm currently thinking about: when would expect an <em>error</em>?</p>



<a name="257741331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741331">(Oct 15 2021 at 18:14)</a>:</h4>
<p>hmm, just realized something</p>



<a name="257741391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741391">(Oct 15 2021 at 18:15)</a>:</h4>
<p>the idea of the new analysis is to track what aliases what and what can be used without an error</p>



<a name="257741434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741434">(Oct 15 2021 at 18:15)</a>:</h4>
<p>the old analysis "knew the future" (what was to come); that seems to really help here, because we can delete some edges since we know <code>v</code> is not used again</p>



<a name="257741482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741482">(Oct 15 2021 at 18:15)</a>:</h4>
<p>so I guess I would say (a) if we want to add some form of liveness, I think we could do so; but also</p>



<a name="257741602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741602">(Oct 15 2021 at 18:16)</a>:</h4>
<p>maybe the answer is that, at the control flow merge, we need to do something more than "union"; i.e., it actually <em>would</em> be some kind of error, I think, if <code>v</code> were used again at the control-flow merge point</p>



<a name="257741628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741628">(Oct 15 2021 at 18:16)</a>:</h4>
<p>or temp were etc</p>



<a name="257741731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741731">(Oct 15 2021 at 18:17)</a>:</h4>
<p>so i.e. the merge could conceivably move some regions to invalidated</p>



<a name="257741865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741865">(Oct 15 2021 at 18:18)</a>:</h4>
<p>but .. I think I might prefer having some kind of clears inserted them things become dead; or if we it more "checked", having a "make live" and "make dead" nodes that get inserted (and it's some kind of error to involve an origin that is not live)</p>



<a name="257741919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257741919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257741919">(Oct 15 2021 at 18:18)</a>:</h4>
<p>even though that was something I was trying not to have :)</p>



<a name="257742154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257742154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257742154">(Oct 15 2021 at 18:20)</a>:</h4>
<p>is .next + some liveness still interesting ? esp compared to the current formulation</p>



<a name="257742463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257742463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257742463">(Oct 15 2021 at 18:22)</a>:</h4>
<p>would it maybe help with expressiveness, or avoid emitting some unnecessary errors that we'd emit with today's version ?</p>



<a name="257742944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257742944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257742944">(Oct 15 2021 at 18:25)</a>:</h4>
<p>Good question... I feel like it's overall simpler? But I'm not sure.</p>



<a name="257743178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743178">(Oct 15 2021 at 18:27)</a>:</h4>
<p>it is currently simpler yeah</p>



<a name="257743265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743265">(Oct 15 2021 at 18:27)</a>:</h4>
<p>its simplicity made it possible for us to remove loans, simplifying it further</p>



<a name="257743337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743337">(Oct 15 2021 at 18:28)</a>:</h4>
<p>(but that can probably be achieved on today's version :)</p>



<a name="257743540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743540">(Oct 15 2021 at 18:29)</a>:</h4>
<p>(in turn it's probably easier to some day make it "production ready" I presume)</p>



<a name="257743583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743583">(Oct 15 2021 at 18:29)</a>:</h4>
<p>I think the forward way of thinking is generally simpler</p>



<a name="257743675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743675">(Oct 15 2021 at 18:30)</a>:</h4>
<p>if you frame liveness as 'allocate' and 'deallocate'</p>



<a name="257743714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743714">(Oct 15 2021 at 18:30)</a>:</h4>
<p>that is still very "operational", which I like</p>



<a name="257743739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743739">(Oct 15 2021 at 18:30)</a>:</h4>
<p>i.e., you can kind of "trace forward" to see what happens</p>



<a name="257743795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743795">(Oct 15 2021 at 18:30)</a>:</h4>
<p>I guess I feel the current analysis is not doing the <em>wrong</em> thing, because I think there are things the user could do at the point of control-flow join where those edges make sense</p>



<a name="257743902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743902">(Oct 15 2021 at 18:31)</a>:</h4>
<p>well, I take that back, in theory there is probably a way for it to recognize an error state</p>



<a name="257743919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257743919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257743919">(Oct 15 2021 at 18:31)</a>:</h4>
<p>that might be moving past datalog though :)</p>



<a name="257744096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744096">(Oct 15 2021 at 18:32)</a>:</h4>
<p>Ok, so</p>



<a name="257744107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744107">(Oct 15 2021 at 18:33)</a>:</h4>
<p>this is combinatorically terrible</p>



<a name="257744159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744159">(Oct 15 2021 at 18:33)</a>:</h4>
<p>but including the derivation path of subsets in the relation seems to at least <em>work</em></p>



<a name="257744314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744314">(Oct 15 2021 at 18:34)</a>:</h4>
<p>push it to a branch? :)</p>



<a name="257744341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744341">(Oct 15 2021 at 18:34)</a>:</h4>
<p>I am going to stop thinking about this for a bit, have to chew on it in the background I think</p>



<a name="257744689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744689">(Oct 15 2021 at 18:37)</a>:</h4>
<p><a href="https://github.com/domenicquirl/polonius.next/blob/5eeadf1f58490c19694c9377a7cf0fb31fc54a14/src/polonius.dl#L76">https://github.com/domenicquirl/polonius.next/blob/5eeadf1f58490c19694c9377a7cf0fb31fc54a14/src/polonius.dl#L76</a></p>



<a name="257744800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744800">(Oct 15 2021 at 18:38)</a>:</h4>
<p>I really need to clean up the tests so I don't need to manually check the output on every example</p>



<a name="257744818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744818">(Oct 15 2021 at 18:38)</a>:</h4>
<p>guaranteed to make a mistake sooner rather than later</p>



<a name="257744872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744872">(Oct 15 2021 at 18:38)</a>:</h4>
<p>What would be better than a full path would be some way to detect and mark exactly the case of multiple predecessors</p>



<a name="257744894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744894">(Oct 15 2021 at 18:39)</a>:</h4>
<p>Essentially a way to say "either do this, or do that, but not both"</p>



<a name="257744929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744929">(Oct 15 2021 at 18:39)</a>:</h4>
<p>still somewhat of a nightmare in terms of performance probably</p>



<a name="257744995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257744995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257744995">(Oct 15 2021 at 18:39)</a>:</h4>
<p>I'll stop for today now as well and do the clean ups tomorrow</p>



<a name="257745004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257745004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257745004">(Oct 15 2021 at 18:39)</a>:</h4>
<p>Bye <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="257822767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257822767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257822767">(Oct 16 2021 at 11:01)</a>:</h4>
<p>I updated the test branch to do 2 loop iterations (because those were previously required to produce the error), and that holds up.</p>



<a name="257822773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257822773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257822773">(Oct 16 2021 at 11:01)</a>:</h4>
<p>I've also been thinking about how to not need to model execution paths, but I'm getting hung up on the fact that there might be cases where new stuff does happen if a specific combination of branches is taken.</p>



<a name="257822795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257822795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257822795">(Oct 16 2021 at 11:01)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">random_n</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Guaranteed to be random</span>
<span class="w">    </span><span class="mi">4</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="k">match</span><span class="w"> </span><span class="n">random_n</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">           </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">           </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">           </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">d</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="257822892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257822892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257822892">(Oct 16 2021 at 11:02)</a>:</h4>
<p>This makes NLL cry quite a lot (though, amusingly, only about the <code>0</code> and <code>1</code> case, and not <code>2</code>), but currently checks with <code>-Zpolonius</code></p>



<a name="257822921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257822921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257822921">(Oct 16 2021 at 11:03)</a>:</h4>
<p>but if you take the branches in order, you get <code>a -&gt; b -&gt; c -&gt; d</code></p>



<a name="257823170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257823170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257823170">(Oct 16 2021 at 11:07)</a>:</h4>
<p>I've been discussing this with some DDLog folks on Discord, but so far there is no specific solution. It was brought up, though, that a version of purely-forward that merges the subsets as before could be used as a pre-pass (like the location insensitive variant) if it accepts more programs than that/NLL (conservatively, that is, correctly)</p>



<a name="257855593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257855593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257855593">(Oct 16 2021 at 19:38)</a>:</h4>
<p>that will be interesting to think about if we can't make it work with some forward simili liveness;  the idea of keeping it as a pre-pass (which likely would also require its own location-insensitive variant) in addition to the existing liveness-based ones seems to undermine the idea that this formulation is simpler, though</p>



<a name="257863593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257863593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257863593">(Oct 16 2021 at 21:41)</a>:</h4>
<p>Well, it still <strong>is</strong> simpler, even if it ends up still being overly conservative. It would definitely be preferable if we can just get this to work fully, but I thought the comment was interesting enough to not get lost</p>



<a name="257863810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257863810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257863810">(Oct 16 2021 at 21:45)</a>:</h4>
<p>if we still need the liveness based variants that we have today, to handle the cases it doesn't handle like 47680, then the whole is not simpler</p>



<a name="257864987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257864987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257864987">(Oct 16 2021 at 22:02)</a>:</h4>
<p>Hm, my angle on this is slightly different. Sure, if I tell you "you need to run this, plus a pre-pass before, plus a more complex set of rules after", then that's more confusing and complicated than just "you need to run this". But the thing is, you don't. There will be one version that is correct and complete in the end, however complex that may be, and if you want the exact definition of borrow checking you only need to consider that version. So I think it's fair to compare the rulesets individually.</p>



<a name="257865036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/257865036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#257865036">(Oct 16 2021 at 22:03)</a>:</h4>
<p>That said, I definitely see your point that a lot of the benefit that we hope to get here is lost in case this version should actually end up as a pre-pass at most</p>



<a name="258338174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258338174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258338174">(Oct 20 2021 at 09:33)</a>:</h4>
<p>Instead of the pathed subsets (which I think get intractable quite quickly), I've been looking at carefully adding a little bit of liveness info. The rules and facts at <a href="https://github.com/domenicquirl/polonius.next/tree/liveness-subsets">https://github.com/domenicquirl/polonius.next/tree/liveness-subsets</a> also solve <code>issue-47680</code>, while leaving other things like <code>self-invalidation-loop</code> intact.</p>



<a name="258338469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258338469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258338469">(Oct 20 2021 at 09:35)</a>:</h4>
<p>The idea there is to stop propagating subset information for origins in variables that stop being live, yet do propagate transitive subset relations that may arise from the possibly dead intermediate. So e.g. moving a variable with an origin through an assignment will yield a relationship between origins that have flown into the variable's origins and those in the assignment target, but anything that explicitly mentions the variable's origins will not be propagated further</p>



<a name="258339059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258339059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258339059">(Oct 20 2021 at 09:40)</a>:</h4>
<p>This means that, for <code>self-invalidation-loop</code>, we retain the transitive relationship between the borrow of <code>x</code> and the <code>v: Vec</code>, which are both outside the loop and alive. But for <code>issue-47680</code>, the two branches are no longer merged.</p>



<a name="258636147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258636147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258636147">(Oct 21 2021 at 23:56)</a>:</h4>
<p>I spent some time digging into <code>issue-47680</code> today. It seems like the root cause is that the creation of <code>&amp;'L_*temp</code> in node <code>b</code> both accesses <code>'temp</code> <em>and</em> invalidates it. However, unlike my self-invalidation example, the loan being created is not the same as the one being invalidated, and so it takes us a while to propagate the <code>invalidate_origin('L_*temp)</code> fact across the subset graph until it results in <code>origin_invalidated('temp)</code>. By the time that happens, we've lost the connection between the access and the invalidation.</p>
<p>What if we remembered the context in which an origin was invalidated? Specifically, when propagating <code>origin_invalidated</code>, remember the loan (or equivalently the point in the CFG when that loan was created) as well. If the invalidation does not occur during the creation of a loan, use some dummy value instead. Then we amend <code>invalidated_origin_accessed</code> to ignore accesses if the accessed origin was invalidated at that same point.</p>
<div class="codehilite" data-code-language="Prolog"><pre><span></span><code><span class="p">.</span><span class="s s-Atom">decl</span> <span class="nf">origin_invalidated</span><span class="p">(</span><span class="nn">origin</span><span class="p">:</span> <span class="nv">Origin</span><span class="p">,</span> <span class="nn">at</span><span class="p">:</span> <span class="nv">Node</span><span class="p">,</span> <span class="nn">source</span><span class="p">:</span> <span class="nv">Node</span><span class="p">)</span>

<span class="nf">invalidated_origin_accessed</span><span class="p">(</span><span class="s s-Atom">o</span><span class="p">,</span> <span class="s s-Atom">n</span><span class="p">)</span> <span class="p">:-</span>
    <span class="nf">access_origin</span><span class="p">(</span><span class="s s-Atom">o</span><span class="p">,</span> <span class="s s-Atom">n</span><span class="p">),</span>
    <span class="nf">origin_invalidated</span><span class="p">(</span><span class="s s-Atom">o</span><span class="p">,</span> <span class="s s-Atom">n</span><span class="p">,</span> <span class="s s-Atom">source</span><span class="p">),</span>
    <span class="s s-Atom">source</span> <span class="p">!</span><span class="o">=</span> <span class="s s-Atom">n</span><span class="p">.</span>
</code></pre></div>



<a name="258636389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258636389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258636389">(Oct 21 2021 at 23:58)</a>:</h4>
<p>I'll try prototyping this to see if it's viable. Let me know if you see something obviously wrong.</p>



<a name="258672093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258672093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258672093">(Oct 22 2021 at 07:09)</a>:</h4>
<p>This makes the error go away, but Im not convinced yet.</p>



<a name="258930500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258930500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258930500">(Oct 25 2021 at 08:39)</a>:</h4>
<p>I've been thinking about this for a while, but I feel like I lack understanding of how exactly the lowering to MIR treats things. Consider this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">  </span><span class="c1">// subset('L_2, 'x)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="c1">// subset('L_*x, 'y), subset('x, 'L_*x) by unrolling</span>
<span class="w">    </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w">         </span><span class="c1">// Read of `*x` invalidates 'L_*x invalidates 'y</span>
<span class="w">                           </span><span class="c1">// Write to `y` accesses 'y</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In surface Rust, e.g. the compiler error, this error is on the same statement. But from what I can tell looking at non-erroneous MIR (swapping the last line), the deref and the assignment would be split into two statements by lowering? If that is the case, I don't <em>think</em> we can have access and invalidation on the same node at the moment.</p>



<a name="258930565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258930565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258930565">(Oct 25 2021 at 08:40)</a>:</h4>
<p>(at the very least the current rules would not catch it, because it takes one edge for the invalidation to take effect)</p>



<a name="258931154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258931154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258931154">(Oct 25 2021 at 08:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/186049-t-compiler.2Fwg-polonius/topic/issue-47680.20Error/near/258672093">said</a>:</p>
<blockquote>
<p>This makes the error go away, but Im not convinced yet.</p>
</blockquote>
<p>It does make me feel uneasy, which I think is mostly because I cannot explain why the rule is correct - that is, why is it OK to ignore illegal access errors that happen within one (potentially repeated) node? To me, this is very much less intuitive than the version which "filters out" origins of dead variables.</p>



<a name="258931265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258931265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258931265">(Oct 25 2021 at 08:47)</a>:</h4>
<p>That's not to say your source-tracking version might not be better in the end - it's at least the minimally invasive fix so far</p>



<a name="258931319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258931319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258931319">(Oct 25 2021 at 08:48)</a>:</h4>
<p>But it'd make me feel better to understand more why it works</p>



<a name="258944850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258944850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258944850">(Oct 25 2021 at 11:18)</a>:</h4>
<p>I share the slight "unease" about using only the location here, rather than some liveness and kill-rules (which feels more principled), in that unrelated changes in rustc's desugaring/lowering, or some change in the user's code that would look semantically identical (e.g. introducing some temporaries), could change between being valid and invalid</p>



<a name="258950439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/issue-47680%20Error/near/258950439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/issue-47680.20Error.html#258950439">(Oct 25 2021 at 12:18)</a>:</h4>
<p>That's a really good point also!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>