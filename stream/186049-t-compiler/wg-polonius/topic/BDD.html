<html>
<head><meta charset="utf-8"><title>BDD · t-compiler/wg-polonius · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/index.html">t-compiler/wg-polonius</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html">BDD</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248982046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248982046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lengyijun <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248982046">(Aug 10 2021 at 13:56)</a>:</h4>
<p>Currently polonius suffer from:</p>
<ol>
<li>Huge memory print</li>
<li>Slow in some cases</li>
</ol>
<p>I accidently notice binary decision diagram helps solve them.<br>
AFAIK, no discussion about bdd and polonius before.<br>
I pick bddbddb, a java program.<br>
I feed the nll-facts and polonius rules into bddbddb, it solves them automatically.<br>
<a href="https://github.com/lengyijun/nll2bdd">https://github.com/lengyijun/nll2bdd</a></p>
<p>Test on naive algorithm:</p>
<table>
<thead>
<tr>
<th></th>
<th>datafrog</th>
<th>bddbddb</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>issue-29466.rs </code></td>
<td>&gt;30min</td>
<td>60s</td>
</tr>
<tr>
<td><code>issue-29540.rs </code></td>
<td>?</td>
<td>?</td>
</tr>
<tr>
<td><code>issue-74564-if-expr-stack-overflow.rs</code></td>
<td>&gt;1h</td>
<td>&gt;1h</td>
</tr>
<tr>
<td>clap</td>
<td>?</td>
<td>1h</td>
</tr>
</tbody>
</table>
<h1>Why bddbddb works well with polonius</h1>
<p>Redundant relation in point, which can be compressed by bdd.</p>
<h1>How to make bddbddb work even faster on polonius?</h1>
<ol>
<li>parallel</li>
<li>
<p>the variable order(NP problem), relation order<br>
A lot of experiments</p>
</li>
<li>
<p>some features in bddbddb: relation split </p>
</li>
</ol>
<h1>Future work</h1>
<ol>
<li>fix <code>issue-74564-if-expr-stack-overflow.rs </code></li>
<li>Test on other algorithm</li>
<li>Rewrite bddbddb in Rust</li>
</ol>
<h2>Reference:</h2>
<p>bddbddb: <a href="http://bddbddb.sourceforge.net/">http://bddbddb.sourceforge.net/</a></p>



<a name="248984254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248984254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248984254">(Aug 10 2021 at 14:11)</a>:</h4>
<p>cool! we did mention BDD in the context of NLLs to have a more compressed representation back then</p>



<a name="248984411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248984411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248984411">(Aug 10 2021 at 14:12)</a>:</h4>
<p>(though to be clear the current state of things is far from production ready, both in cpu time or memory usage. what consequences making it so will that have in the future is currently unclear)</p>



<a name="248984770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248984770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248984770">(Aug 10 2021 at 14:15)</a>:</h4>
<p>the naive algorithm isn't particularly representative either, as its name suggest. the more realistic (with the caveat about production-readiness) variant is the hybrid variant: it starts with a quick location-insensitive pre-pass to locate potential errors to be validated later by the datafrogopt variant (a more optimized version than the naive rules), only if necessary</p>



<a name="248984958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248984958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248984958">(Aug 10 2021 at 14:16)</a>:</h4>
<p>but if you want the datafrog stats on clap (which I assume is the single function whose facts are in the repo, and not the actual clap crate), naive takes around 9s and opt around 4</p>



<a name="248985089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248985089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248985089">(Aug 10 2021 at 14:17)</a>:</h4>
<p>and to illustrate my point above, clap passes the location-insensitive pre-pass filter in 20ms or so</p>



<a name="248985179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248985179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248985179">(Aug 10 2021 at 14:18)</a>:</h4>
<p>(so there is no need to run the other variants taking 4 to 9 seconds)</p>



<a name="248985343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248985343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248985343">(Aug 10 2021 at 14:19)</a>:</h4>
<p>the timings above are for the actual pass, that doesn't count all the setup before: rustc including fact generation, move/init, liveness, etc</p>



<a name="248985690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248985690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248985690">(Aug 10 2021 at 14:21)</a>:</h4>
<p>I'm surprised but the 30 mins for issue-29466, as I don't remember seeing that while testing my recent PR. I may have missed that.</p>



<a name="248985933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248985933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lengyijun <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248985933">(Aug 10 2021 at 14:23)</a>:</h4>
<blockquote>
<p>I'm surprised but the 30 mins for issue-29466, as I don't remember seeing that while testing my recent PR. I may have missed that.</p>
</blockquote>
<p><code>polonius -a naive --show-tuples -v /path/to/nll-facts</code><br>
30min includes move,init,liveness.</p>



<a name="248986023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248986023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248986023">(Aug 10 2021 at 14:24)</a>:</h4>
<p>(but a lot of the slowness I noticed then in the UI tests was related to the impact of the Location:All issue -- which needs fixing, and is somewhat in-progress -- and move/init and liveness)</p>



<a name="248986430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248986430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248986430">(Aug 10 2021 at 14:26)</a>:</h4>
<p>yeah it's nice to have these as reference implementations and documentation etc but it seems unlikely they'll be used as-is for actual production (not to mention rustc already does them, and they're way more efficient)</p>



<a name="248986819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248986819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248986819">(Aug 10 2021 at 14:29)</a>:</h4>
<p>mostly: until our rules are fully decided (something to which I believe we are very close, modulo the HRTB/universe ones) and we achieve our correctness goal, we have deliberately tried to avoid performance work (but we can't really help it sometimes :)</p>



<a name="248988872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248988872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248988872">(Aug 10 2021 at 14:44)</a>:</h4>
<p><a href="http://issue-29466.rs">issue-29466.rs</a> takes 1 minute for me, most of it in initialization analysis, and it passes the location insensitive pre-pass in 2ms:</p>
<div class="codehilite"><pre><span></span><code>INFO polonius_engine::output::initialization - initialization phase 1 completed: 110.7µs
INFO polonius_engine::output::initialization - initialization phase 2: 0 move errors in 90.400914s
INFO polonius_engine::output::liveness - compute_live_origins() completed: 184 tuples, 3.4076469s
INFO polonius_engine::output::location_insensitive - analysis done: 0 `potential_errors` tuples, 0 `potential_subset_errors` tuples, 1.7539ms
</code></pre></div>
<p>Similarly, <code>Naive</code> takes 50ms: </p>
<div class="codehilite"><pre><span></span><code>INFO polonius_engine::output::naive - analysis done: 0 `errors` tuples, 0 `subset_errors` tuples, 50.2949ms
</code></pre></div>
<p>Unless there are some deep issues with either of our facts, and we're not measuring the same things, this is surprising.</p>
<p><span class="user-mention" data-user-id="389101">@lengyijun</span> I'd like to reproduce your results, can you share how you gathered the stats above and how you are launching the executable ?</p>



<a name="248989870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248989870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lengyijun <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248989870">(Aug 10 2021 at 14:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code>~/rust-polonius/build/x86_64-unknown-linux-gnu/stage1/bin/rustc -Znll-facts ~/rust-polonius/src/test/ui/issues/issue-29466.rs
cd nll-facts/main
export PATH=$PATH:~/polonius/target/release
polonius -a naive  -v . &gt; log
</code></pre></div>



<a name="248990062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248990062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248990062">(Aug 10 2021 at 14:55)</a>:</h4>
<p>the <code>-v</code> triggers verbose mode which copies a lot of intermediate data for debugging purposes</p>



<a name="248991282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/186049-t-compiler/wg-polonius/topic/BDD/near/248991282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/186049-t-compiler/wg-polonius/topic/BDD.html#248991282">(Aug 10 2021 at 15:03)</a>:</h4>
<p>(and if you have built your own rustc just to emit the facts, you could use <code>-Zpolonius</code> to compile that test and make your life easier: it'll avoid writing and reading the facts from disk)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>