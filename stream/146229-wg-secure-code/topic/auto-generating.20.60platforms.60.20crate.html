<html>
<head><meta charset="utf-8"><title>auto-generating `platforms` crate · wg-secure-code · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/index.html">wg-secure-code</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html">auto-generating `platforms` crate</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273040430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273040430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273040430">(Feb 24 2022 at 02:43)</a>:</h4>
<p>I have been messing with <code>rustc</code> following some helpful tips by <span class="user-mention" data-user-id="210267">@Nemo157</span>, and noticed that it can output the list of all known targets with <code>rustc --print=target-list</code> as well as detailed info about each target with <code>rustc --print=cfg --target=...</code><br>
This leads me to believe that we could just auto-generate the contents of the <code>platforms</code> crate. No more manual updates or sourcing from Rust Forge. <br>
<span class="user-mention" data-user-id="132721">@Tony Arcieri</span> has anything like this been attempted? Are you aware of any blockers?</p>



<a name="273119733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273119733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273119733">(Feb 24 2022 at 17:12)</a>:</h4>
<p>no, I've done very little work on that crate since... back when RustForge was actually a thing (it's gone now afaik)</p>



<a name="273147403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273147403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273147403">(Feb 24 2022 at 20:45)</a>:</h4>
<p>I'll open an issue to auto-generate this data, then. Probably won't have the time to work on it.</p>



<a name="273173162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273173162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273173162">(Feb 25 2022 at 01:20)</a>:</h4>
<p>Issue filed: <a href="https://github.com/rustsec/rustsec/issues/513">https://github.com/rustsec/rustsec/issues/513</a></p>



<a name="273173201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273173201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273173201">(Feb 25 2022 at 01:21)</a>:</h4>
<p>And yes, looks like we do have all the info we need to auto-generate it. Support tiers are the only tricky bit because they're not in rustc, but in Markdown documentation in a git repo.</p>



<a name="273185179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273185179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273185179">(Feb 25 2022 at 03:30)</a>:</h4>
<p>I have nerd-sniped myself. I am prototyping this now.</p>



<a name="273187762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273187762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273187762">(Feb 25 2022 at 04:27)</a>:</h4>
<p>Okay, I got generation of actual architecture data as well as enums it uses working. The code is in <a href="https://github.com/rustsec/rustsec/tree/auto-generate-platforms-crate/platforms/platforms-data-gen"><code>auto-generate-platforms-crate</code></a> branch on the <code>rustsec</code> repo.</p>



<a name="273187989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273187989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273187989">(Feb 25 2022 at 04:32)</a>:</h4>
<p>I wonder if <code>Option&lt;Env&gt;</code> design is still relevant? Now that the crate has users, we could actually check what people are doing with it.</p>



<a name="273246787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273246787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273246787">(Feb 25 2022 at 16:01)</a>:</h4>
<p>it's definitely important... it's how you disambiguate musl targets, for example</p>



<a name="273265501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273265501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273265501">(Feb 25 2022 at 18:20)</a>:</h4>
<p>Ah, sorry, I wasn't communicating clearly. I mean, is the <code>Option</code> part of it actually relevant? I <em>could</em> just roll this up into the <code>Env</code> enum. <code>Env::None</code> or some such.</p>



<a name="273274294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273274294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273274294">(Feb 25 2022 at 19:29)</a>:</h4>
<p>aah, well, that'd be a breaking change</p>



<a name="273275825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273275825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273275825">(Feb 25 2022 at 19:43)</a>:</h4>
<p>I was thinking about introducing the <code>target_endian</code> and <code>target_pointer_width</code> fields, so it would be a breaking change anyway, and we might as well roll up this change into it.</p>



<a name="273276871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273276871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273276871">(Feb 25 2022 at 19:53)</a>:</h4>
<p>Ok. Maybe tag the struct as <code>#[non_exhaustive]</code> so we can make non-breaking changes like that in the future</p>



<a name="273279013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273279013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273279013">(Feb 25 2022 at 20:13)</a>:</h4>
<p>I think that's the extent of basic information that we will include? So I don't necessarily see a way we will extend it in the future.<br>
Although there is the <code>--print=target-spec-json</code> in Nightly rustc that outputs the following:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"arch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x86_64"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x86-64"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"crt-static-respected"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"data-layout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"dynamic-linking"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gnu"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"executables"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"has-rpath"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"has-thread-local"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"is-builtin"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"llvm-target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x86_64-unknown-linux-gnu"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"max-atomic-width"</span><span class="p">:</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"linux"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"position-independent-executables"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"pre-link-args"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"gcc"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s2">"-m64"</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"relro-level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"full"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"stack-probes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"call"</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"static-position-independent-executables"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"supported-sanitizers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">"address"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"cfi"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"leak"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"memory"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">"thread"</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">"target-family"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">"unix"</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">"target-pointer-width"</span><span class="p">:</span><span class="w"> </span><span class="s2">"64"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="273279181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273279181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273279181">(Feb 25 2022 at 20:15)</a>:</h4>
<p>It might be interesting to support this somehow, but it would probably go into some Ext struct, because it's just a lot of info that you don't necessarily need?</p>



<a name="273279821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273279821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273279821">(Feb 25 2022 at 20:21)</a>:</h4>
<p>I'm just looking for ways to avoid making breaking changes in the future</p>



<a name="273279842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273279842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273279842">(Feb 25 2022 at 20:21)</a>:</h4>
<p>and I don't think anyone is going to be exhaustively pattern matching on these structs</p>



<a name="273281271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273281271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273281271">(Feb 25 2022 at 20:34)</a>:</h4>
<p>Hmm, that does make sense.</p>



<a name="273282153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273282153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273282153">(Feb 25 2022 at 20:39)</a>:</h4>
<p>Alright, let's go with <code>#[non_exhaustive]</code> then!</p>



<a name="273598231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273598231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273598231">(Mar 01 2022 at 06:55)</a>:</h4>
<p>Alright, all the data extraction for auto-generating the <code>platforms</code> crate is done <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <br>
The generator can now print all the data for every platform, including the tier, which is sourced from markdown documentation.<br>
Code is here: <a href="https://github.com/rustsec/rustsec/tree/auto-generate-platforms-crate/platforms/platforms-data-gen/src">https://github.com/rustsec/rustsec/tree/auto-generate-platforms-crate/platforms/platforms-data-gen/src</a><br>
All that remains to do is cosmetics.</p>



<a name="273820278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273820278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273820278">(Mar 02 2022 at 15:07)</a>:</h4>
<p>I am going to drop the <a href="https://github.com/rustsec/rustsec/blob/f37a278f4b3495fb789287ccbe8c6e86719c9ced/platforms/src/target/os.rs#L163-L164">questionable compile-time information</a> in <code>platforms</code> crate because:</p>
<ul>
<li>it can cause build failures in weird configs (you can define both <code>windows</code> and <code>unix</code> at the same time) </li>
<li>it requires adding <code>Unknown</code> variant everywhere, but that overlaps with the valid <code>Unknown</code> variant on the OS and just doesn't make sense on other enums because they error out on attempting to construct them from an invalid string instead of returning <code>Unknown</code></li>
<li><a href="https://doc.rust-lang.org/std/env/consts/"><code>std::env::consts</code></a> provides these values already</li>
</ul>



<a name="273821882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273821882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273821882">(Mar 02 2022 at 15:18)</a>:</h4>
<p>sure</p>



<a name="273842154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273842154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273842154">(Mar 02 2022 at 17:15)</a>:</h4>
<p><span class="user-mention" data-user-id="132721">@Tony Arcieri</span> do we want to keep the design with the <code>Env</code> being wrapped in an <code>Option</code>?<br>
<a href="https://docs.rs/platforms/2.0.0/platforms/platform/struct.Platform.html">https://docs.rs/platforms/2.0.0/platforms/platform/struct.Platform.html</a><br>
On one hand this does match the way the target triple is laid out (<code>aarch64-unknown-linux-gnu</code> with env vs <code>x86_64-apple-darwin</code> without), but then there's stuff like <code>aarch64-unknown-none-hermitkernel</code> where <code>hermit</code> is the OS value. So the target triples are just a mess.<br>
I am tempted to just slap <code>None</code> variant on it and call it a day instead of making an <code>Option&lt;Env&gt;</code>. There is already  a<code>None</code> or <code>Unknown</code> variant on <code>Arch</code> and <code>OS</code>, so this would not even make <code>Env</code> it special. <br>
But I am biased because ditching the <code>Option</code> would simplify auto-generating the code. Any thoughts from the user perspective on this?</p>



<a name="273842724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273842724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273842724">(Mar 02 2022 at 17:19)</a>:</h4>
<p>Using a <code>None</code> variant makes sense to me. Rustc gives an empty string as target env by default.</p>



<a name="273842775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273842775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273842775">(Mar 02 2022 at 17:19)</a>:</h4>
<p>Rustc doesn't skip the <code>target_env</code> cfg when it is empty.</p>



<a name="273847517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273847517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273847517">(Mar 02 2022 at 17:45)</a>:</h4>
<p>I am nearly done with implementing auto-generation, actually. I think all that's left for a new <code>platforms</code> release is getting the data written to the appropriate file instead of stdout and updating the docs.</p>



<a name="273848630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273848630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273848630">(Mar 02 2022 at 17:52)</a>:</h4>
<p>if you're making other breaking changes <code>Env::None</code> is fine</p>



<a name="273849950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/273849950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#273849950">(Mar 02 2022 at 18:00)</a>:</h4>
<p>I am marking structs <code>#[non_exhaustive]</code> and adding fields, so yes</p>



<a name="274119026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274119026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274119026">(Mar 04 2022 at 12:08)</a>:</h4>
<p>Ok, so. I have this <code>target_pointer_width</code> field that I'd like to expose. I'm doing that as an enum, for consistency with the rest of the crate (and also because I don't have to write any special auto-generation). <br>
<code>Bits::64</code> doesn't work because enum variants must start with a letter, not a string.<br>
<code>Bits::SixtyFour</code> is just unnecessarily verbose.<br>
I don't want users to look up and use the syntax for raw identifiers, to force number into an enum variant.<br>
Any tips on how to proceed?</p>



<a name="274120146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274120146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274120146">(Mar 04 2022 at 12:21)</a>:</h4>
<p><code>Pointer::Width64</code> is also awkward<br>
Unicode lookalikes for letters are cool I guess but cannot be typed, and unicode in source code is certainly going to break something, somewhere</p>



<a name="274122812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274122812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274122812">(Mar 04 2022 at 12:47)</a>:</h4>
<p>target-lexicon uses U16/U32/U64: <a href="https://docs.rs/target-lexicon/latest/target_lexicon/enum.PointerWidth.html">https://docs.rs/target-lexicon/latest/target_lexicon/enum.PointerWidth.html</a></p>



<a name="274122921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274122921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274122921">(Mar 04 2022 at 12:48)</a>:</h4>
<p>Turns out that exists. And I've just spent the last week implementing a generator for the exact same thing <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="274123270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274123270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274123270">(Mar 04 2022 at 12:52)</a>:</h4>
<p>target-lexicon is manually written and has no target tier info.</p>



<a name="274123339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274123339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274123339">(Mar 04 2022 at 12:52)</a>:</h4>
<p>Ah, I see. Then mine is not totally useless, then!</p>



<a name="274123916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274123916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274123916">(Mar 04 2022 at 12:57)</a>:</h4>
<p>I'm gonna ape what <code>target-lexicon</code> does. Thanks for the tip!</p>



<a name="274135294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274135294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274135294">(Mar 04 2022 at 14:22)</a>:</h4>
<p>OK, the auto-generated <code>platforms</code> crate now compiles, and I have checked in the generated code. There are a few things to do still, but it's mostly complete!</p>



<a name="274252127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274252127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274252127">(Mar 05 2022 at 16:30)</a>:</h4>
<p>Alright, I think that what I have now is shippable. PR open: <a href="https://github.com/rustsec/rustsec/pull/516">https://github.com/rustsec/rustsec/pull/516</a></p>



<a name="274533475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274533475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274533475">(Mar 08 2022 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="132721">@Tony Arcieri</span> <code>rustsec</code> CI fails because rustc added new warnings, and we have those treated as errors.<br>
<a href="https://github.com/rustsec/rustsec/pull/516/files#diff-b4db31cd7c46ceeaccc928589774ef80897df397140248a4787c404a729d0d7e">https://github.com/rustsec/rustsec/pull/516/files#diff-b4db31cd7c46ceeaccc928589774ef80897df397140248a4787c404a729d0d7e</a><br>
This warning is legit - the <code>scope</code> is never taken into account when querying the database even though it is set. "Scope" is whether the package is local, from <a href="http://crates.io">crates.io</a>, or a private registry.<br>
How should that be handled? This makes CI look red and might mask some other issues.</p>



<a name="274544431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274544431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274544431">(Mar 08 2022 at 14:02)</a>:</h4>
<p>yeah, there's some work that needs to be done to get the build green again</p>



<a name="274544448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274544448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274544448">(Mar 08 2022 at 14:02)</a>:</h4>
<p>been meaning to look at it but too many other things going on</p>



<a name="274575469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274575469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274575469">(Mar 08 2022 at 17:32)</a>:</h4>
<p>No worries, I have no urgent work being blocked on this</p>



<a name="274598271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/274598271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#274598271">(Mar 08 2022 at 20:02)</a>:</h4>
<p>Ah, and the platform definitions in <code>advisory-db</code> will have to be revised. They are currently not validated against the <code>platforms</code> crate, and a lot of them just deserialize as <code>unknown</code> and then get written to OSV as <code>[ "arm", "unknown", "unknown", "unknown" ]</code> or some such. These will start erroring out. I will take care of adding the check to the linter and revising the db - but again, that's not urgent.</p>



<a name="277055683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/277055683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#277055683">(Mar 29 2022 at 19:43)</a>:</h4>
<p>I have figured out how to encode the target triple at compile time. It seems to be fast and reliable, and works with rustc as old as 1.19. I intend to publish it as a standalone crate.<br>
However, my employer insists on pre-reviewing anything I publish, so it will take a couple of weeks for me to actually publish the code. If that doesn't go through for any reason, I'll just contribute it to the <code>platforms</code> crate.</p>



<a name="277055818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/277055818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#277055818">(Mar 29 2022 at 19:44)</a>:</h4>
<p>I'd appreciate PR review for platforms <code>v3.0</code>, by the way. <a href="https://github.com/rustsec/rustsec/pull/516">https://github.com/rustsec/rustsec/pull/516</a></p>



<a name="277056890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/277056890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tony Arcieri <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#277056890">(Mar 29 2022 at 19:54)</a>:</h4>
<p>yeah sorry meant to do a pass on RustSec stuff this weekend but ended up doing a bunch of RustCrypto PR reviews instead</p>



<a name="277057921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/146229-wg-secure-code/topic/auto-generating%20%60platforms%60%20crate/near/277057921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shnatsel <a href="https://zulip-archive.rust-lang.org/stream/146229-wg-secure-code/topic/auto-generating.20.60platforms.60.20crate.html#277057921">(Mar 29 2022 at 20:03)</a>:</h4>
<p>That's fine, I'm not blocked on this for anything as yet. <br>
I would be if I didn't decide to just fold <code>cargo auditable</code> into Cargo right away, because there is no reasonable way to do this outside Cargo in some cases (e.g. with workspaces, or when building multiple packages)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>