<html>
<head><meta charset="utf-8"><title>ThinBox · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html">ThinBox</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258281073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258281073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258281073">(Oct 19 2021 at 22:13)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="219747">@Simon Sapin</span>, <span class="user-mention" data-user-id="310399">@Mara</span> and I were just talking about adding a ThinBox to <code>std</code> as a nightly only API and I'm looking into implementing it in <a href="https://github.com/rust-lang/rust/pull/90066">https://github.com/rust-lang/rust/pull/90066</a>.</p>
<p>After getting an initial version working I then decided to go back and look for prior art because I am positive I've seen people talking about this before only to realize the place i saw it before was literally in the RFC for ptr metadata, which already has a much nicer version of the same thing I tried writing up and I'm wondering, do you have a full copy of <code>ThinBox</code> written up somewhere?</p>



<a name="258281260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258281260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258281260">(Oct 19 2021 at 22:15)</a>:</h4>
<p>I'm extra excited about this because introducing a new alternate box specifically for handling trait objects serves as a perfect opportunity to fix the <code>Error</code> impl issue with <code>Box</code>, where we can choose to not introduce the unfortunate <code>From&lt;E: Error&gt;</code> impl that <code>Box</code> has and have <code>ThinBox&lt;dyn Error&gt;</code> impl Error and be one pointer wide at the same time</p>



<a name="258282440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258282440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258282440">(Oct 19 2021 at 22:25)</a>:</h4>
<p>Hey Jane, I don’t have more than what’s in the RFC, and that is completely untested since it was written for the pointer metadata that was being proposed and did not exist yet</p>



<a name="258282468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258282468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258282468">(Oct 19 2021 at 22:25)</a>:</h4>
<p>Alright</p>



<a name="258282570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258282570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258282570">(Oct 19 2021 at 22:26)</a>:</h4>
<p>I'm gonna work on implementing it then and use your rfc samples as inspiration, if you have time I'd love any feedback you could give on it</p>



<a name="258283423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283423">(Oct 19 2021 at 22:34)</a>:</h4>
<p>Your PR looks like a good start. I assume you want to add more features like <code>DerefMut</code></p>



<a name="258283428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283428">(Oct 19 2021 at 22:34)</a>:</h4>
<p>I think it may need a <code>PhantomData</code> for dropck</p>



<a name="258283612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283612">(Oct 19 2021 at 22:36)</a>:</h4>
<p>Oh, and handling alloc errors. I like to use <code>NonNull::new(alloc(layout)).unwrap_or_else(|| handle_alloc_error(layout))</code> for that (maybe that should be a convenience method in liballoc some day)</p>



<a name="258283650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283650">(Oct 19 2021 at 22:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258283428">said</a>:</p>
<blockquote>
<p>I think it may need a <code>PhantomData</code> for dropck</p>
</blockquote>
<p>working on adding that right now based on your RFC</p>



<a name="258283823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283823">(Oct 19 2021 at 22:38)</a>:</h4>
<p>… and not calling <code>alloc</code> with a zero-size layout, using <code>NonNull::dangling</code> instead. This can happen if the value is zero size and the metadata is <code>()</code>, which makes using <code>ThinBox</code> in the first place less useful but could still happen</p>



<a name="258283843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283843">(Oct 19 2021 at 22:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258283423">said</a>:</p>
<blockquote>
<p>Your PR looks like a good start. I assume you want to add more features like <code>DerefMut</code></p>
</blockquote>
<p>for sure, I'm not really certain how comprehensive I should make the API in the initial PR. I already have a usecase in mind for this for the error handling project group so I'm planning on using a custom toolchain for that project and integrating it there with only the minimum API needed to make that crate work</p>



<a name="258283888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283888">(Oct 19 2021 at 22:39)</a>:</h4>
<p>Is this a public API of std, eventually to be stabilized?</p>



<a name="258283915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283915">(Oct 19 2021 at 22:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258283823">said</a>:</p>
<blockquote>
<p>… and not calling <code>alloc</code> with a zero-size layout, using <code>NonNull::dangling</code> instead. This can happen if the value is zero size and the metadata is <code>()</code>, which makes using <code>ThinBox</code> in the first place less useful but could still happen</p>
</blockquote>
<p>this is continuing the previous thought as in you would put this check in the helper function?</p>



<a name="258283937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283937">(Oct 19 2021 at 22:39)</a>:</h4>
<p>there are crates in this area if you search for "thin", like <a href="https://crates.io/crates/thin_trait_object">https://crates.io/crates/thin_trait_object</a></p>



<a name="258283939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258283939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258283939">(Oct 19 2021 at 22:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258283888">said</a>:</p>
<blockquote>
<p>Is this a public API of std, eventually to be stabilized?</p>
</blockquote>
<p>yes</p>



<a name="258284021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284021">(Oct 19 2021 at 22:40)</a>:</h4>
<p>(not an endorsement, just picked one that's directly relevant)</p>



<a name="258284035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284035">(Oct 19 2021 at 22:40)</a>:</h4>
<p>cool</p>



<a name="258284056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284056">(Oct 19 2021 at 22:40)</a>:</h4>
<p>I wonder if that one uses the ptr_metadata feature...</p>



<a name="258284113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284113">(Oct 19 2021 at 22:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258283939">said</a>:</p>
<blockquote>
<p>yes</p>
</blockquote>
<p>then I guess it’ll eventually get all the features, but yeah they don’t all need to be in the first PR</p>



<a name="258284312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284312">(Oct 19 2021 at 22:42)</a>:</h4>
<p><a href="https://crates.io/crates/thin_trait_object#user-content-overview">https://crates.io/crates/thin_trait_object#user-content-overview</a></p>
<blockquote>
<p>Trait objects in Rust suffer from several fundamental limitations: […] No way to manually construct a trait object given only a dispatch table and a value, i.e. to create a custom implementation which does not correspond to any type's implementation of the trait.</p>
</blockquote>
<p>I would guess it does not even use <code>dyn Trait</code></p>



<a name="258284410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284410">(Oct 19 2021 at 22:43)</a>:</h4>
<p>how about <a href="https://crates.io/crates/rfc2580">https://crates.io/crates/rfc2580</a></p>



<a name="258284586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284586">(Oct 19 2021 at 22:45)</a>:</h4>
<p>oh that's just the inner pieces</p>



<a name="258284616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284616">(Oct 19 2021 at 22:45)</a>:</h4>
<p>ohey thats from matthieu-m</p>



<a name="258284830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284830">(Oct 19 2021 at 22:47)</a>:</h4>
<p>hmmm, tryng to integrate the <code>trait DynTrait&lt;...&gt; = ...</code> stuff from the RFC with <span class="user-mention" data-user-id="119009">@eddyb</span> 's suggestion to use an extern type for safety isn't going well</p>



<a name="258284832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284832">(Oct 19 2021 at 22:47)</a>:</h4>
<p>lol</p>



<a name="258284908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258284908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258284908">(Oct 19 2021 at 22:48)</a>:</h4>
<p>gonna try coming at this from a diff angle</p>



<a name="258285043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285043">(Oct 19 2021 at 22:49)</a>:</h4>
<p>Looks like <a href="https://crates.io/crates/rfc2580">https://crates.io/crates/rfc2580</a> is from the person arguing in the tracking issue that metadata for slices should not be plain <code>usize</code> but a dedicated struct, and similarly for all types. (I don’t really have an opinion on that.)</p>



<a name="258285148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285148">(Oct 19 2021 at 22:50)</a>:</h4>
<p>ack, will leave that for later consideration then</p>



<a name="258285351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285351">(Oct 19 2021 at 22:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258284586">said</a>:</p>
<blockquote>
<p>oh that's just the inner pieces</p>
</blockquote>
<p>it does have <a href="https://github.com/matthieu-m/rfc2580/blob/master/examples/thin.rs">https://github.com/matthieu-m/rfc2580/blob/master/examples/thin.rs</a></p>



<a name="258285496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285496">(Oct 19 2021 at 22:54)</a>:</h4>
<p>so i guess the diff between that example/my PR's current version and your RFC example version is that your RFC hardcodes <code>DynMetadata</code> and only works with trait objects as the parameter type</p>



<a name="258285543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285543">(Oct 19 2021 at 22:54)</a>:</h4>
<p>whereas matthieu and my versions both work for arbitrary types (though of course mine is busted without the error handling you already mentioned and special handling for ZSTs)</p>



<a name="258285602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285602">(Oct 19 2021 at 22:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258285496">said</a>:</p>
<blockquote>
<p>so i guess the diff between that example/my PR's current version and your RFC example version is that your RFC hardcodes <code>DynMetadata</code> and only works with trait objects as the parameter type</p>
</blockquote>
<p>I’m trying to remember why I did that…</p>



<a name="258285712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285712">(Oct 19 2021 at 22:56)</a>:</h4>
<p>Mine still uses an <code>Unsize</code> bound. I remember being unsatisfied with that since I’m not aware of any plan to move <code>Unsize</code> towards possible stabilization</p>



<a name="258285794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285794">(Oct 19 2021 at 22:57)</a>:</h4>
<p>And I don’t like stable features mentioning unstable things in their signatures, especially maybe-perma-unstable things</p>



<a name="258285834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285834">(Oct 19 2021 at 22:57)</a>:</h4>
<p>seems like this could be one of those areas where we make an exception but I'm also not in a particularly huge rush to stabilize</p>



<a name="258285884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258285884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258285884">(Oct 19 2021 at 22:58)</a>:</h4>
<p>so hopefully a resolution presents itself before then</p>



<a name="258286020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286020">(Oct 19 2021 at 22:59)</a>:</h4>
<p>Oh yeah there’s the thing where the value alignment is unknown until we extract the vtable</p>



<a name="258286029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286029">(Oct 19 2021 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> had a very cursed suggestion of using a closure to let the user handle the coercion which is 99% shitpost</p>



<a name="258286032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286032">(Oct 19 2021 at 22:59)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=34aed1021d59c720753a8217ff9ba2e5">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=34aed1021d59c720753a8217ff9ba2e5</a></p>



<a name="258286061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286061">(Oct 19 2021 at 22:59)</a>:</h4>
<p>I think that’s why my <code>ThinBox</code> is limited to trait objects</p>



<a name="258286151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286151">(Oct 19 2021 at 23:00)</a>:</h4>
<p>so I can use <code>DynMetadata::align_of</code></p>



<a name="258286238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286238">(Oct 19 2021 at 23:00)</a>:</h4>
<p>Also, my first version took a Box&lt;T&gt; as an input for the constructor and then moved the data around, though that version was also bad and used double indirection still so maybe not even relevant</p>



<a name="258286294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286294">(Oct 19 2021 at 23:01)</a>:</h4>
<p>so we could theoretically rely on Box for the unsizing as part of the initial stable interface</p>



<a name="258286296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286296">(Oct 19 2021 at 23:01)</a>:</h4>
<p>/shrug</p>



<a name="258286332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286332">(Oct 19 2021 at 23:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258286020">said</a>:</p>
<blockquote>
<p>Oh yeah there’s the thing where the value alignment is unknown until we extract the vtable</p>
</blockquote>
<p>can you elaborate on how this is an issue</p>



<a name="258286420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286420">(Oct 19 2021 at 23:02)</a>:</h4>
<p>eddyb mentioned something about needing to test it for #[repr(align(1024))] sizes and using an extern type to help with safety that may have also been related to alignment, but I didn't really understand the issue at the time they mentioned this</p>



<a name="258286463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286463">(Oct 19 2021 at 23:02)</a>:</h4>
<p>If I have <code>#[repr(align(32))] struct X;</code>, then <code>WithMeta&lt;X&gt;::value</code> is at offset 32</p>



<a name="258286538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286538">(Oct 19 2021 at 23:03)</a>:</h4>
<p>ooooh</p>



<a name="258286569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286569">(Oct 19 2021 at 23:03)</a>:</h4>
<p>does that happen automatically or do we need to handle that?</p>



<a name="258286697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286697">(Oct 19 2021 at 23:04)</a>:</h4>
<p>it happens automatically when creating a <code>WithMeta&lt;X&gt;</code> with a concrete <code>X</code></p>



<a name="258286759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286759">(Oct 19 2021 at 23:05)</a>:</h4>
<p>but later when dereferencing <code>ThinBox&lt;dyn SomeTrait&gt;</code> the concrete <code>X</code> is type-erased</p>



<a name="258286835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286835">(Oct 19 2021 at 23:06)</a>:</h4>
<p>I wonder how <code>as_ref</code> in your PR works</p>



<a name="258286843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286843">(Oct 19 2021 at 23:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258286835">said</a>:</p>
<blockquote>
<p>I wonder how <code>as_ref</code> in your PR works</p>
</blockquote>
<p>big same</p>



<a name="258286861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286861">(Oct 19 2021 at 23:06)</a>:</h4>
<p>because it sure seems to, even in the align(1024) test, lol</p>



<a name="258286931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286931">(Oct 19 2021 at 23:07)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/90066/files#diff-cbeae90e5072b4f07b0eef276acd341f96b0ca9596ecf47a209d655ffd44a0beR12-R17">https://github.com/rust-lang/rust/pull/90066/files#diff-cbeae90e5072b4f07b0eef276acd341f96b0ca9596ecf47a209d655ffd44a0beR12-R17</a> is confusing since the two variables named <code>T</code> don’t match</p>



<a name="258286935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286935">(Oct 19 2021 at 23:07)</a>:</h4>
<p>does the <code>Metadata</code> include the padding perhaps?</p>



<a name="258286962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286962">(Oct 19 2021 at 23:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258286931">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/rust/pull/90066/files#diff-cbeae90e5072b4f07b0eef276acd341f96b0ca9596ecf47a209d655ffd44a0beR12-R17">https://github.com/rust-lang/rust/pull/90066/files#diff-cbeae90e5072b4f07b0eef276acd341f96b0ca9596ecf47a209d655ffd44a0beR12-R17</a> is confusing since the two variables named <code>T</code> don’t match</p>
</blockquote>
<p>sorry about that <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="258286971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258286971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258286971">(Oct 19 2021 at 23:07)</a>:</h4>
<p>im cleaning that up to use <code>Dyn</code> the way your examples do</p>



<a name="258287127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287127">(Oct 19 2021 at 23:09)</a>:</h4>
<p>same later with <code>ThinBox&lt;U&gt;</code> in one impl vs <code>ThinBox&lt;T&gt;</code> in the next</p>



<a name="258287142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287142">(Oct 19 2021 at 23:09)</a>:</h4>
<p>:&lt;</p>



<a name="258287159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287159">(Oct 19 2021 at 23:09)</a>:</h4>
<p>gimmi a sec and I'll push a more consistent version</p>



<a name="258287161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287161">(Oct 19 2021 at 23:09)</a>:</h4>
<p>actually</p>



<a name="258287164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287164">(Oct 19 2021 at 23:09)</a>:</h4>
<p>i can just push it now</p>



<a name="258287171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287171">(Oct 19 2021 at 23:09)</a>:</h4>
<p>not done testing locally but I think its fine</p>



<a name="258287227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287227">(Oct 19 2021 at 23:10)</a>:</h4>
<p>and I also wanted to integrate NonNull but I can do that after</p>



<a name="258287272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287272">(Oct 19 2021 at 23:10)</a>:</h4>
<p>pushed</p>



<a name="258287411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287411">(Oct 19 2021 at 23:11)</a>:</h4>
<p>try making the test with <code>align(1024)</code> use a non-ZST</p>



<a name="258287423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287423">(Oct 19 2021 at 23:11)</a>:</h4>
<p>and print the value in <code>Display</code>?</p>



<a name="258287483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287483">(Oct 19 2021 at 23:12)</a>:</h4>
<p>I would guess <code>as_ref</code> computes the wrong pointer</p>



<a name="258287685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287685">(Oct 19 2021 at 23:14)</a>:</h4>
<p>ack, testing that now</p>



<a name="258287841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287841">(Oct 19 2021 at 23:15)</a>:</h4>
<p>It uses <code>&amp;inner.value</code> which accesses a field of the <code>struct { Meta, ErasedExtern }</code> which may have different layout than <code>struct { Meta, ConcreteType }</code></p>



<a name="258287915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258287915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258287915">(Oct 19 2021 at 23:15)</a>:</h4>
<p>makes sense</p>



<a name="258288040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288040">(Oct 19 2021 at 23:16)</a>:</h4>
<p>oops I meant to sleep an hour ago <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> bye</p>



<a name="258288057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288057">(Oct 19 2021 at 23:16)</a>:</h4>
<p>hehe, sorry about that and gn and thank you!</p>



<a name="258288485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288485">(Oct 19 2021 at 23:20)</a>:</h4>
<p>Well I wouldn’t sleep if I kept wondering without checking</p>



<a name="258288537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288537">(Oct 19 2021 at 23:21)</a>:</h4>
<p>hmm?</p>



<a name="258288545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288545">(Oct 19 2021 at 23:21)</a>:</h4>
<p><a href="https://github.com/matthieu-m/rfc2580/blob/b58d1d3cba0d4b5e859d3617ea2d0943aaa31329/examples/thin.rs#L124-L130">https://github.com/matthieu-m/rfc2580/blob/b58d1d3cba0d4b5e859d3617ea2d0943aaa31329/examples/thin.rs#L124-L130</a> stores a pointer to the value and applies negative offset to extract the metadata</p>



<a name="258288565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288565">(Oct 19 2021 at 23:21)</a>:</h4>
<p>which is interesting, but afaict still ignores alignment</p>



<a name="258288591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288591">(Oct 19 2021 at 23:21)</a>:</h4>
<p><span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="258288668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288668">(Oct 19 2021 at 23:22)</a>:</h4>
<p>ah, thats what they meant by it using a middle pointer</p>



<a name="258288687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288687">(Oct 19 2021 at 23:22)</a>:</h4>
<div class="codehilite" data-code-language="----"><pre><span></span><code>error: test run failed!
status: exit status: 101
command: "/home/jlusby/git/rust-lang/rust/build/x86_64-unknown-linux-gnu/test/ui/box/thin_align/a"
stdout:
------------------------------------------

------------------------------------------
stderr:
------------------------------------------
thread 'main' panicked at 'assertion failed: `(left == right)`
  left: `"Foo error!"`,
 right: `""`', /home/jlusby/git/rust-lang/rust/src/test/ui/box/thin_align.rs:14:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="258288689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288689">(Oct 19 2021 at 23:22)</a>:</h4>
<p>boom</p>



<a name="258288702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288702">(Oct 19 2021 at 23:22)</a>:</h4>
<p>prophecy fulfilled</p>



<a name="258288799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288799">(Oct 19 2021 at 23:23)</a>:</h4>
<p>wait it doesn’t ignore alignment… but instead writes metadata at the <em>end</em> of the area with potential padding</p>



<a name="258288951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258288951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258288951">(Oct 19 2021 at 23:25)</a>:</h4>
<p>That’s really interesting and clever. It removes the need for a <code>std::mem::align_of_for_meta&lt;T&gt;(meta: &lt;T as Pointee&gt;::Metadata) -&gt; usize</code> intrinsic that I thought was needed to generalize my <code>ThinBox</code></p>



<a name="258289095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289095">(Oct 19 2021 at 23:27)</a>:</h4>
<p>Looks like matthieu-m has thought a lot about all this so their input would be valuable</p>



<a name="258289140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289140">(Oct 19 2021 at 23:27)</a>:</h4>
<p>I just CC'ed them on the PR</p>



<a name="258289198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289198">(Oct 19 2021 at 23:28)</a>:</h4>
<p>not sure if they're on the zulip though since there doesn't seem to be an @ matthieu-m on here</p>



<a name="258289210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289210">(Oct 19 2021 at 23:28)</a>:</h4>
<p>… or copy-paste <a href="https://github.com/matthieu-m/rfc2580/blob/master/examples/thin.rs">https://github.com/matthieu-m/rfc2580/blob/master/examples/thin.rs</a> and adapt it to use std’s <code>Pointee</code></p>



<a name="258289224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289224">(Oct 19 2021 at 23:28)</a>:</h4>
<p>How would ThinBox interact with trait upcasting?</p>



<a name="258289230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289230">(Oct 19 2021 at 23:28)</a>:</h4>
<p>I imagine that'll be impossible</p>



<a name="258289244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289244">(Oct 19 2021 at 23:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258289210">said</a>:</p>
<blockquote>
<p>… or copy-paste <a href="https://github.com/matthieu-m/rfc2580/blob/master/examples/thin.rs">https://github.com/matthieu-m/rfc2580/blob/master/examples/thin.rs</a> and adapt it to use std’s <code>Pointee</code></p>
</blockquote>
<p>definitely seems like an attractive path forward, though I would want to talk with them first before doing that</p>



<a name="258289253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289253">(Oct 19 2021 at 23:29)</a>:</h4>
<p>sure</p>



<a name="258289294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289294">(Oct 19 2021 at 23:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258289224">said</a>:</p>
<blockquote>
<p>How would ThinBox interact with trait upcasting?</p>
</blockquote>
<p>presumably you can get a &amp;dyn Trait out of it and use whatever upcasting machinery gets built into rust for regular trait objects</p>



<a name="258289302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289302">(Oct 19 2021 at 23:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258289224">said</a>:</p>
<blockquote>
<p>How would ThinBox interact with trait upcasting?</p>
</blockquote>
<p>You can dereferenc <code>ThinBox</code> to get <code>&amp;dyn Trait</code> or <code>&amp;mut dyn Trait</code> and upcasting <em>that</em> should Just Work</p>



<a name="258289303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289303">(Oct 19 2021 at 23:29)</a>:</h4>
<p>not sure about upcasting from a ThinBox to another</p>



<a name="258289378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289378">(Oct 19 2021 at 23:30)</a>:</h4>
<p>I'd probably just finish the MVP of thinbox and leave figuring out finer integrations like that to people working on trait upcasting itself</p>



<a name="258289409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289409">(Oct 19 2021 at 23:30)</a>:</h4>
<p>for owned upcasting, I imagine <code>ThinkBox</code> would need an API that consumes a boxed values and overwrites the metadata</p>



<a name="258289411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289411">(Oct 19 2021 at 23:30)</a>:</h4>
<p>as far as the error trait is concerned it would already work with trait upcasting which is the main place I end up wanting it, lol</p>



<a name="258289426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289426">(Oct 19 2021 at 23:31)</a>:</h4>
<p>thanks to generic member access (when that lands)</p>



<a name="258289597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289597">(Oct 19 2021 at 23:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258289426">said</a>:</p>
<blockquote>
<p>thanks to generic member access (when that lands)</p>
</blockquote>
<p>Is that <a href="https://github.com/rust-lang/rfcs/pull/2895">https://github.com/rust-lang/rfcs/pull/2895</a> ? Does it mean adding a <a href="https://crates.io/crates/anymap">https://crates.io/crates/anymap</a> to errors?</p>



<a name="258289628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289628">(Oct 19 2021 at 23:33)</a>:</h4>
<p>(I’ve only skimmed the summary)</p>



<a name="258289648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289648">(Oct 19 2021 at 23:33)</a>:</h4>
<p>anyway, bye :)</p>



<a name="258289771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289771">(Oct 19 2021 at 23:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258289597">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258289426">said</a>:</p>
<blockquote>
<p>thanks to generic member access (when that lands)</p>
</blockquote>
<p>Is that <a href="https://github.com/rust-lang/rfcs/pull/2895">https://github.com/rust-lang/rfcs/pull/2895</a> ? Does it mean adding a <a href="https://crates.io/crates/anymap">https://crates.io/crates/anymap</a> to errors?</p>
</blockquote>
<p>Thats the right RFC, and kinda. It's more like adding the interface to the trait, but the storage is entirely custom to each type, and everything has to be opt in</p>



<a name="258289778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289778">(Oct 19 2021 at 23:35)</a>:</h4>
<p>so for trait upcasting you would be doing something like</p>



<a name="258289915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289915">(Oct 19 2021 at 23:36)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">provide_context</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">request</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">request</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">provide_ref</span>::<span class="o">&lt;&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Serialize</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258289967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258289967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258289967">(Oct 19 2021 at 23:37)</a>:</h4>
<p>then you could use <code>error.context_ref::&lt;&amp;dyn Serialize&gt;()</code> on an error trait object to upcast it to a serialize trait object</p>



<a name="258321145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258321145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258321145">(Oct 20 2021 at 07:00)</a>:</h4>
<p>I’m glad to learn a <code>align_of_for_meta</code> intrinsic isn’t necessary for a fully general <code>ThinBox</code> but it could still be useful for other niche use cases such as a <code>Vec</code>-like container that stores heterogeneously-sized values in contiguous memory</p>



<a name="258321189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258321189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258321189">(Oct 20 2021 at 07:01)</a>:</h4>
<p>Together with <code>size_of_for_meta</code> it could even replace the corresponding <code>DynMetadata</code> methods</p>



<a name="258332032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258332032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258332032">(Oct 20 2021 at 08:41)</a>:</h4>
<p>for the alignment issue you could reuse <code>Rc::try_allocate_for_layout</code> (<a href="https://github.com/rust-lang/rust/issues/54922">#54922</a>).</p>



<a name="258495022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258495022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Herr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258495022">(Oct 21 2021 at 06:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258321145">said</a>:</p>
<blockquote>
<p>I’m glad to learn a <code>align_of_for_meta</code> intrinsic isn’t necessary for a fully general <code>ThinBox</code> but it could still be useful for other niche use cases such as a <code>Vec</code>-like container that stores heterogeneously-sized values in contiguous memory</p>
</blockquote>
<p>What does fully general mean here?</p>



<a name="258496090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258496090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Herr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258496090">(Oct 21 2021 at 06:53)</a>:</h4>
<p>I played around with a toy implementation that tries to avoid doing its own allocation and alignment stuff and just uses regular boxes, but I probably can't make that go as far as From&lt;&amp;[T]&gt;. matthieu's thinbox seems really fancy.</p>



<a name="258564865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258564865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258564865">(Oct 21 2021 at 15:18)</a>:</h4>
<p>Fully general means for any <code>T: ?Sized</code> type, as opposed to only trait objects with <code>T: Pointee&lt;Metadata=DynMetadata&lt;T&gt;&gt;</code></p>



<a name="258565079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258565079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258565079">(Oct 21 2021 at 15:20)</a>:</h4>
<p>The <code>ThinBox</code> example in the RFC <a href="https://rust-lang.github.io/rfcs/2580-ptr-meta.html#guide-level-explanation">https://rust-lang.github.io/rfcs/2580-ptr-meta.html#guide-level-explanation</a> does this in order to be able to use <code>DynMetadata::align_of</code></p>



<a name="258565236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258565236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258565236">(Oct 21 2021 at 15:21)</a>:</h4>
<p><code>DynMetadata::align_of</code> is like <code>mem::align_of_val</code> except it doesn’t need a data pointer, which is important because that’s how that example code computes the data pointer</p>



<a name="258565340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258565340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258565340">(Oct 21 2021 at 15:21)</a>:</h4>
<p>Instead, <a href="https://crates.io/crates/rfc2580">https://crates.io/crates/rfc2580</a> keeps a pointer to the data in the "middle" of the allocation and uses a negative offset to find the metadata</p>



<a name="258565391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258565391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Herr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258565391">(Oct 21 2021 at 15:21)</a>:</h4>
<p>right</p>



<a name="258565917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258565917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Herr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258565917">(Oct 21 2021 at 15:24)</a>:</h4>
<p>i tried boxing a struct { metadata, T } where the metadata is that of the struct and not T (though i guess in practice it's identical), and then I can from_raw_parts a wide pointer to the struct and that knows how to get the T</p>



<a name="258825359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258825359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258825359">(Oct 23 2021 at 14:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/ThinBox/near/258565236">said</a>:</p>
<blockquote>
<p><code>DynMetadata::align_of</code> is like <code>mem::align_of_val</code> except it doesn’t need a data pointer, which is important because that’s how that example code computes the data pointer</p>
</blockquote>
<p>I wonder if there are cases where align can change based on the data pointer? Maybe we could just add a bound to the <code>Pointee</code> so <code>::Metadata</code> always provides <code>align_of</code>? (btw, why is it <code>align_of</code> and not <code>align</code>? it seems weird to add <code>of</code> and not provide the thing of which align is asked...)</p>



<a name="258834983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258834983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258834983">(Oct 23 2021 at 17:50)</a>:</h4>
<p>the <code>align_of_val_raw(_)</code> of all <em>regular</em> DST <code>T</code> in Rust so far can be derived from the type <code>T</code> itself and the value of <code>metadata(_)</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">align_of_val_raw</span>::<span class="o">&lt;</span><span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="n">align_of_val_raw</span>::<span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">metadata</span><span class="p">(</span><span class="n">p</span><span class="p">).</span><span class="n">align_of</span><span class="p">();</span><span class="w"></span>
<span class="n">align_of_val_raw</span>::<span class="o">&lt;</span><span class="n">extern_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="cm">/* unspecified, may panic may abort may return 1 */</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>in theory, if we introduce an <em>inlined</em> DST such as <code>Thin&lt;dyn Trait&gt; = (DynMetadata, dyn Trait)</code> (so that <code>type ThinBox&lt;dyn Trait&gt; = Box&lt;Thin&lt;dyn Trait&gt;&gt;</code>), its alignment will be <code>max(align_of::&lt;DynMetadata&gt;(), self.0.align_of())</code>, i.e. the alignment depends on the <em>content</em> of the data pointer.</p>
<p>this makes it impossible to implement a safe <code>align_of_val_raw</code>.  </p>
<p>it is also impossible to use inlined DST as a struct tail e.g. <code>(u8, Thin&lt;dyn Trait&gt;)</code> due to the cyclic dependency between "reading <code>self.1</code> to calculate the alignment" ↔ "getting the alignment to compute the offset of <code>self.1</code> to read the content".</p>
<p>imo alignment must never rely on the data pointer, and we shouldn't support <code>Thin&lt;X&gt;</code> without an explicit data-independent alignment.</p>
<hr>
<blockquote>
<p>Maybe we could just add a bound to the <code>Pointee</code> so <code>::Metadata</code> always provides <code>align_of</code>?</p>
</blockquote>
<p>that said, i don't like this idea very much in current state since it would pollute <code>usize</code> and <code>()</code> (<code>5_usize.align_of()</code>?? though in reality it requires FQN <code>Metadata::&lt;[u8]&gt;::align_of(5)</code>).</p>



<a name="258836034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/ThinBox/near/258836034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/ThinBox.html#258836034">(Oct 23 2021 at 18:15)</a>:</h4>
<blockquote>
<p>that said, i don't like this idea very much in current state since it would pollute <code>usize</code> and <code>()</code> (<code>5_usize.align_of()</code>?? though in reality it requires FQN <code>Metadata::&lt;[u8]&gt;::align_of(5))</code>.</p>
</blockquote>
<p>This would be easier if <code>Metadata</code> would always be a newtype :)<br>
<code>SizedMetadata&lt;T&gt;</code>, <code>SliceMetadata&lt;T&gt;</code>,  <code>DynMetadata&lt;T: ?Sized&gt;</code>...</p>
<p>Then implementing a new trait shouldn't cause any problems.</p>
<p>Because otherwise we'd need a trait like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">MetadataOf</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="n">this</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MetadataOf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="n">this</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span>::<span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MetadataOf</span><span class="o">&lt;</span><span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="n">this</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span>::<span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// etc</span>
</code></pre></div>
<p>Since <code>()</code> and <code>usize</code> don't mention <code>T</code>.</p>
<p>With newtypes we doth don't pollute the standard commonly used types and the trait may be simpler:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Metadata</span>: <span class="cm">/* we can move all the trait bounds here, from Pointee::Metadata */</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SizedMetadata</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span>::<span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SliceMetadata</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span>::<span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// etc</span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>