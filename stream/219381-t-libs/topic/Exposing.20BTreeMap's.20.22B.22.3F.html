<html>
<head><meta charset="utf-8"><title>Exposing BTreeMap&#x27;s &quot;B&quot;? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html">Exposing BTreeMap&#x27;s &quot;B&quot;?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276891211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891211">(Mar 28 2022 at 15:34)</a>:</h4>
<p>If I'm not mistaken, const generics have <em>actually</em> gotten far enough that we could consider making BTreeMap&lt;K, V&gt; into <code>BTreeMap&lt;K, V, const B: usize = 6&gt;</code> or whatever? And then a user could override the default?</p>
<p>This was always the dream/meme for BTreeMap. I don't know how default inference or backcompat on this stuff is these days, but at worst it seems like we could play typedef games to hide it but have like RealBTreeMap for people that want to mess with it?</p>



<a name="276891506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891506">(Mar 28 2022 at 15:37)</a>:</h4>
<p>from the compiler/cg side that seems fine, if we add allocator support to it we would end up with <code>BTreeMap&lt;K, V, const B: usize = 6, A: Allocator = DefaultAllocator&gt;</code> which seems like the right order to me</p>



<a name="276891667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891667">(Mar 28 2022 at 15:38)</a>:</h4>
<p>a major issue is that methods on <code>BTreeMap</code> have to also keep the default, so we would have to add <code>BTreeMap::new_with_b</code> or whatever</p>



<a name="276891687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891687">(Mar 28 2022 at 15:38)</a>:</h4>
<p>Do we accept <code>_</code> for const generic arguments?  So that someone who doesn't care can still use <code>BTreeMap&lt;K, V, _, SpecialAlloc&gt;</code>?</p>



<a name="276891735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891735">(Mar 28 2022 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/Exposing.20BTreeMap's.20.22B.22.3F/near/276891687">said</a>:</p>
<blockquote>
<p>Do we accept <code>_</code> for const generic arguments?  So that someone who doesn't care can still use <code>BTreeMap&lt;K, V, _, SpecialAlloc&gt;</code>?</p>
</blockquote>
<p>50/50</p>



<a name="276891757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891757">(Mar 28 2022 at 15:38)</a>:</h4>
<p>with a feature gate</p>



<a name="276891797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276891797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276891797">(Mar 28 2022 at 15:39)</a>:</h4>
<p>the current impl works as it should afaik</p>



<a name="276892023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276892023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276892023">(Mar 28 2022 at 15:40)</a>:</h4>
<p>but I am not happy with it cause it makes hir visitors a bit more fragile. With that feature we now have two ways to represent <code>_</code> for types in the hir, both as <code>hir::TyKind::Infer</code> and <code>hir::GenericArg::Infer</code>. If any hir visitor were to care for that, it would probably miss the generic arg representation by accident</p>



<a name="276892377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276892377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276892377">(Mar 28 2022 at 15:43)</a>:</h4>
<p>also, <code>BTreeMap&lt;K, V,  _, MyAlloc&gt;</code> drops the default for <code>B</code> which might be annoying</p>



<a name="276892482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276892482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276892482">(Mar 28 2022 at 15:44)</a>:</h4>
<p>we should just add a <code>default</code> generic argument which either uses the default for that generic parameter or causes an error <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span></p>



<a name="276892521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276892521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276892521">(Mar 28 2022 at 15:44)</a>:</h4>
<p><code>BTreeMap&lt;K, V, default, MyAlloc&gt;</code> :3</p>



<a name="276892643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276892643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276892643">(Mar 28 2022 at 15:45)</a>:</h4>
<p>Oh, right, <code>_</code> is inferred, not "use the default".  We could probably make <code>BTreeMap&lt;K, V, =, MyAlloc&gt;</code> work for that...</p>
<p>Scope creep: it could also be something like <code>BTreeMap&lt;K, V, Strategy = LinearScan&lt;6&gt;, Allocator = DefaultAllocator&gt;</code>.</p>



<a name="276894752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276894752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276894752">(Mar 28 2022 at 16:01)</a>:</h4>
<p>please no full STL/Boost</p>



<a name="276894883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/276894883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#276894883">(Mar 28 2022 at 16:02)</a>:</h4>
<p>"statically" branching on B to choose the strategy internally is plenty</p>



<a name="277039037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277039037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277039037">(Mar 29 2022 at 17:25)</a>:</h4>
<blockquote>
<p><code>_</code> is inferred, not "use the default"</p>
</blockquote>
<p>well, I'd love it if <code>_</code> could be extended to mean "infer this, but use the default as a fallback" :)</p>



<a name="277059011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277059011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim McNamara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277059011">(Mar 29 2022 at 20:13)</a>:</h4>
<p>Exposing B would be a big win, in my view.</p>



<a name="277066744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277066744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277066744">(Mar 29 2022 at 21:26)</a>:</h4>
<p>Can we have something like <code>const B: usize = 4096 / mem::size_of::&lt;T&gt;</code> yet?</p>



<a name="277068227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277068227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277068227">(Mar 29 2022 at 21:41)</a>:</h4>
<p>are you targeting page size there?</p>



<a name="277070365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277070365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277070365">(Mar 29 2022 at 22:02)</a>:</h4>
<p>Yeah but that's just a guess, I haven't benchmarked or anything</p>



<a name="277071172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277071172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277071172">(Mar 29 2022 at 22:12)</a>:</h4>
<p>ok -- the specific effect of <code>B</code> is more complicated than that, but it could be worth experimenting</p>



<a name="277196796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Exposing%20BTreeMap%27s%20%22B%22%3F/near/277196796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Exposing.20BTreeMap&#x27;s.20.22B.22.3F.html#277196796">(Mar 30 2022 at 19:48)</a>:</h4>
<p>yeah back in the day "8" or whatever we picked was at least based on some micro-benchmarking. I believe the kinds of conventional logic I applied in my very old article about BTreeMap is... flawed. In particular, we eventually learned that the "conventional wisdom" of never using parent pointers in a BTree (because this would require you to access-to-modify the child whenever you move it around) actually turned out to be <em>false</em> in the context of a Not For Actual Filesystems datastructure, because the relative costs of "touch another node" and "maintain a stack of the path you took" are <em>WAY</em> different</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>