<html>
<head><meta charset="utf-8"><title>#[rustc_layout_scalar_valid_range_start] · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html">#[rustc_layout_scalar_valid_range_start]</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="247288849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247288849" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247288849">(Jul 27 2021 at 02:53)</a>:</h4>
<p>The <code>#[rustc_layout_scalar_valid_range_start]</code> and <code>#[rustc_layout_scalar_valid_range_end]</code> attributes clearly state that they will never be stable. Is there any reason these attributes couldn't be exposed to end users in some form (naturally under a different name)? It looks like the necessary safety checks are already in place.</p>



<a name="247288936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247288936" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247288936">(Jul 27 2021 at 02:54)</a>:</h4>
<p>I'd like to take advantage of them for the <code>deranged</code> crate, which provides range-bound integers. This would need adapting the attribute to accept any const value (deranged uses const generics) instead of just literals, but I'd be willing to give it a shot if there's a reasonable path forwards on this.</p>



<a name="247298697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247298697" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247298697">(Jul 27 2021 at 06:33)</a>:</h4>
<p>If users do access it as an attribute that would be more T-lang than T-libs.</p>
<p>But yeah, users should be able to use this functionality in some way.</p>



<a name="247304104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247304104" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247304104">(Jul 27 2021 at 07:56)</a>:</h4>
<p>Would it be better to expose this as a struct with const generics (like <code>NonZero</code>) rather than exposing the attributes directly?</p>



<a name="247304529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247304529" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247304529">(Jul 27 2021 at 08:01)</a>:</h4>
<p>If it were generic in some magical way that supported only scalar values where you can set the range, then sure. However, that's currently so far off from what const generics supports that if you try something like it you're not even told about a feature you could maybe turn on.</p>



<a name="247304623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247304623" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247304623">(Jul 27 2021 at 08:02)</a>:</h4>
<p>I mean that is <em>basically</em> my intended use case (ranged integers with niche value optimization). The problem with const generics is it requires a concrete type (and i128 and u128 are both reasonable to desire)</p>



<a name="247304748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247304748" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247304748">(Jul 27 2021 at 08:03)</a>:</h4>
<p>We've got X many integer types already, and C has a proposal for generic integers, so Rust will need to get moving and have them too at some point, at which point it will be totally unreasonable to offer one bounded type per integer type.</p>



<a name="247305016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247305016" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247305016">(Jul 27 2021 at 08:06)</a>:</h4>
<p>That's what I've already done (deranged crate), it's just missing niche value optimization. In an ideal world it wouldn't be necessary to manually declare the backing type (even if it can be done with a macro), but that would require compiler integration because of the aforementioned issue with concrete types. afaik the compiler uses bigint internally for things like this</p>



<a name="247305077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247305077" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247305077">(Jul 27 2021 at 08:07)</a>:</h4>
<p>Just trying to get one step closer to having native-like ranged integers</p>



<a name="247305086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247305086" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247305086">(Jul 27 2021 at 08:07)</a>:</h4>
<blockquote>
<p>I'd like to take advantage of them for the <code>deranged</code> crate, which provides range-bound integers.</p>
</blockquote>
<p>Hey, you <a href="https://docs.rs/bounded-integer">stole my idea</a> :P.</p>



<a name="247305200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247305200" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247305200">(Jul 27 2021 at 08:08)</a>:</h4>
<p>oh well <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="247305905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247305905" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247305905">(Jul 27 2021 at 08:18)</a>:</h4>
<p><code>range_start</code> and <code>range_end</code> couldn't express something like <code>char</code> though which has a gap in its valid range for the surrogates.</p>



<a name="247306046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247306046" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247306046">(Jul 27 2021 at 08:20)</a>:</h4>
<p>Yes, and that's been the subject of many discussions regarding how to best permit for arbitrary niche values. I think it's worth noting that even just start/end bounds provides for a very large number of niches (far more than the typical use case) in most situations.</p>



<a name="247306355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247306355" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247306355">(Jul 27 2021 at 08:24)</a>:</h4>
<p>and it doesn't work for alignment gaps either</p>



<a name="247307308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247307308" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247307308">(Jul 27 2021 at 08:35)</a>:</h4>
<p>I'd honestly be fine if this were limited to newtypes. It seems like the most likely use-case.</p>



<a name="247318226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318226" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318226">(Jul 27 2021 at 10:58)</a>:</h4>
<p>ftr, the limitation to range is a pragmatic implementation choice. taking advantage of other "shapes" of niches would make <code>enum</code> encoding/decoding more expensive, or at the very least it would require the compiler to more expensively track every layout's available niches - as-is, it's always just two integers</p>



<a name="247318369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318369" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318369">(Jul 27 2021 at 10:59)</a>:</h4>
<p>also, you only need unsigned integers (e.g. <code>u128</code>) to express the validity range: it's a "wraparound" range, meaning <code>start &gt; end</code> actually makes sense, and lets you do negative ranges like for an <code>u8</code>, the range <code>0xfe..=0x02</code> is the equivalent to the <code>-2..=2</code> range on <code>i8</code></p>



<a name="247318508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318508" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318508">(Jul 27 2021 at 11:00)</a>:</h4>
<p>So... On this topic, I have had <del>awesome</del> horrible ideas. Instead of inventing more and more fine grained systems for layout stuff (bit fields, field range restrictions, ...), we add procedural types to Rust. Right now we have declarative types. You define the type and the layout is autogenerated by the compiler. Just like we added procedural macros on top of declarative macros, we will add a concept <code>type Foo = const { ... };</code> where the <code>...</code> is const code that generates arbitrarily complex instances of something similar to <code>ty::Layout</code> in the compiler. So you both generate the type representation as well as the layout of that representation.</p>



<a name="247318683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318683" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318683">(Jul 27 2021 at 11:02)</a>:</h4>
<p>whether we want to expose the wraparound range to users is another question, so it's possible that for now we'd have something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">RangedU16</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">FIRST</span>: <span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">LAST</span>: <span class="kt">u16</span><span class="o">&gt;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">()</span>: <span class="nc">IsTrue</span><span class="o">&lt;</span><span class="p">{</span><span class="n">FIRST</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">LAST</span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">inner</span>: <span class="kt">u16</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="247318743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318743" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318743">(Jul 27 2021 at 11:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247318508">said</a>:</p>
<blockquote>
<p>So... On this topic, I have had <del>awesome</del> horrible ideas. Instead of inventing more and more fine grained systems for layout stuff (bit fields, field range restrictions, ...), we add procedural types to Rust. Right now we have declarative types. You define the type and the layout is autogenerated by the compiler. Just like we added procedural macros on top of declarative macros, we will add a concept <code>type Foo = const { ... };</code> where the <code>...</code> is const code that generates arbitrarily complex instances of something similar to <code>ty::Layout</code> in the compiler. So you both generate the type representation as well as the layout of that representation.</p>
</blockquote>
<p>yeah... that's not happening without dependent types :P</p>



<a name="247318771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318771" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318771">(Jul 27 2021 at 11:03)</a>:</h4>
<p>you need <em>a lot</em> of infrastructure to make that kind of thing <em>remotely</em> sane</p>



<a name="247318773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318773" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318773">(Jul 27 2021 at 11:03)</a>:</h4>
<p>whaat, why?</p>



<a name="247318784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318784">(Jul 27 2021 at 11:03)</a>:</h4>
<p>who said anything about sane?</p>



<a name="247318800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318800" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318800">(Jul 27 2021 at 11:03)</a>:</h4>
<p>idk, having a sound language is nice? :P</p>



<a name="247318808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318808" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318808">(Jul 27 2021 at 11:03)</a>:</h4>
<p><code>type Foo = const unsafe { ... };</code></p>



<a name="247318953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247318953" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247318953">(Jul 27 2021 at 11:04)</a>:</h4>
<p>Why would it return a <code>Layout</code>? Given enough imagination it could <em>just</em> be a function that checks if the value belongs to the type :P</p>



<a name="247319647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247319647" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247319647">(Jul 27 2021 at 11:13)</a>:</h4>
<p>at most I could see some kind of very limited <code>unsafe fn</code> encode/decode, e.g. of the high-level discriminant value of an <code>enum</code> into/from an array of bytes. but then you also need the variant data. maybe it could be done with attributes on fields and that could be checked but that's pretty limited (<code>#[repr(align(N))]</code> is also pretty limited tbh)</p>



<a name="247496084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247496084" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247496084">(Jul 28 2021 at 18:13)</a>:</h4>
<p>Just echoing that I would also love the valid range feature because it would be useful for some optimisations (I made a topic about always positive signed integers before.), and for modelling ASN.1 integers which can be arbitrarily constrained.</p>



<a name="247498223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247498223" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247498223">(Jul 28 2021 at 18:30)</a>:</h4>
<p>I remember a long time ago we had a discussion about stabilizing this in some form.</p>



<a name="247498341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247498341" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247498341">(Jul 28 2021 at 18:31)</a>:</h4>
<p>If we're going to stabilize it, I'd love to be able to ensure that users can write values that aren't just unsigned, and <em>ideally</em> reference compile-time constants (e.g. <code>i32::MAX</code>).</p>



<a name="247499407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247499407" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247499407">(Jul 28 2021 at 18:39)</a>:</h4>
<p>I would like having this via const generics, so some sort of <code>struct Ranged&lt;T: SomeTraitBound, const MIN: T, const MAX: T&gt;(T);</code> that we can extend in the future with more types that implement <code>SomeTraitBound</code></p>



<a name="247501123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247501123" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247501123">(Jul 28 2021 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247498341">said</a>:</p>
<blockquote>
<p>If we're going to stabilize it, I'd love to be able to ensure that users can write values that aren't just unsigned, and <em>ideally</em> reference compile-time constants (e.g. <code>i32::MAX</code>).</p>
</blockquote>
<p>if we can do <code>MIN &lt;= MAX</code> bounds, then the bounds for e.g. <code>RangedI32</code> would be typed as <code>i32</code>, and "wraparound range" would be limited to being an implementation detail</p>



<a name="247502541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247502541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247502541">(Jul 28 2021 at 19:01)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> I'd love to use const generics, but I don't want to force people to use those types <em>in place of</em> the types they would have written.</p>



<a name="247502570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247502570" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247502570">(Jul 28 2021 at 19:01)</a>:</h4>
<p>That would force an API break for existing code, for instance.</p>



<a name="247502628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247502628" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247502628">(Jul 28 2021 at 19:02)</a>:</h4>
<p>It should be possible to write <code>struct MyType(i32)</code> and add min/max bounds to that without changing the <code>i32</code> to something like <code>Ranged&lt;...&gt;</code>.</p>



<a name="247503487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247503487" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247503487">(Jul 28 2021 at 19:08)</a>:</h4>
<p>it would already be a breaking change, as it would become unsafe to access the <code>i32</code></p>



<a name="247503507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247503507" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247503507">(Jul 28 2021 at 19:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247498341">said</a>:</p>
<blockquote>
<p><em>ideally</em> reference compile-time constants (e.g. <code>i32::MAX</code>).</p>
</blockquote>
<p>That's something I mentioned at the top of this thread — I'd be willing to at least investigate what would be necessary to permit arbitrary const values in this position.</p>



<a name="247503556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247503556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247503556">(Jul 28 2021 at 19:09)</a>:</h4>
<p>I may be missing something here, I am strictly thinking about how <code>rustc_layout_scalar_valid_range_start</code> works</p>



<a name="247503656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247503656" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247503656">(Jul 28 2021 at 19:09)</a>:</h4>
<p><em>Accessing</em> is safe, but any assignment (including construction) is unsafe from what I can see.</p>



<a name="247503819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247503819" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247503819">(Jul 28 2021 at 19:11)</a>:</h4>
<p>It may be worthwhile, at least at first, to restrict the attributes to newtypes around integers, as I'm pretty sure it's permitted on things like arrays internally.</p>



<a name="247503833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247503833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247503833">(Jul 28 2021 at 19:11)</a>:</h4>
<p>and newtypes would cover most use cases</p>



<a name="247504042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504042" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504042">(Jul 28 2021 at 19:12)</a>:</h4>
<p>I see <code>Ranged</code> occupying a similar role to <code>UnsafeCell</code>, communicating the low-level details to the compiler, while you'll probably newtype that into your own specific thing</p>



<a name="247504167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504167">(Jul 28 2021 at 19:13)</a>:</h4>
<p>On the contrary I'd prefer it be quite widespread in APIs that would otherwise perform validation on parameters.</p>



<a name="247504296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504296" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504296">(Jul 28 2021 at 19:14)</a>:</h4>
<p>possibly these are two separate APIs?</p>



<a name="247504418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504418" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504418">(Jul 28 2021 at 19:15)</a>:</h4>
<p>The other reason I'm concerned about <code>Ranged</code> is that like <code>NonZero</code> types, it can be rather inconvenient to use, sufficiently so that sometimes even when something can't be zero people still use the unconstrained type.</p>



<a name="247504519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504519" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504519">(Jul 28 2021 at 19:16)</a>:</h4>
<p>With a newtype, you can just <code>.0</code> to get the inner type out, and then do normal operators like <code>+</code> or <code>*</code>.</p>



<a name="247504556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504556">(Jul 28 2021 at 19:16)</a>:</h4>
<p>but it needs to be unsafe to change <code>.0</code></p>



<a name="247504581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504581" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504581">(Jul 28 2021 at 19:16)</a>:</h4>
<p>already is from what I can tell</p>



<a name="247504601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504601" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504601">(Jul 28 2021 at 19:17)</a>:</h4>
<p>when using the attributes</p>



<a name="247504665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504665">(Jul 28 2021 at 19:17)</a>:</h4>
<p>ah, ok</p>



<a name="247504942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247504942" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247504942">(Jul 28 2021 at 19:20)</a>:</h4>
<p>If we go down the road of having a <code>Ranged</code> type, there would need to be some sort of compiler integration to permit the user to not care about the backing type (a problem deranged has)</p>



<a name="247509242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247509242" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247509242">(Jul 28 2021 at 19:56)</a>:</h4>
<p>Couldn't it have the type <code>Ranged&lt;T: Number, const LO: T, const HI: T&gt;</code> for some <code>Number</code> trait? That's not within <code>min_const_generics</code> but that never seems to stop std</p>



<a name="247509287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247509287" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> XAMPPRocky <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247509287">(Jul 28 2021 at 19:57)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I would consider the <code>NonZero</code> inconvenience to be something that’s worth addressing as it’s own thing. You should be able to create newtypes that are drop-in replacements for the integer types (with the exception of being able to use <code>as</code>).</p>



<a name="247509311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247509311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247509311">(Jul 28 2021 at 19:57)</a>:</h4>
<p>Or just <code>RangedU8</code>, <code>RangedU16</code> etc</p>



<a name="247509341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247509341" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247509341">(Jul 28 2021 at 19:57)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> in theory, yes. As you've noted we'd need full <code>const_generics</code> for that.</p>



<a name="247509405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247509405" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247509405">(Jul 28 2021 at 19:58)</a>:</h4>
<p>Having <code>RangedU8</code> is precisely what deranged does, and it's not exactly convenient.</p>



<a name="247510877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247510877" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247510877">(Jul 28 2021 at 20:10)</a>:</h4>
<p>This seems to interact at least a little with the "better literals" story that has been lurking in the background for a while.</p>



<a name="247511096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247511096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247511096">(Jul 28 2021 at 20:12)</a>:</h4>
<p>Ideally we'd someday be able to write</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">k</span>: <span class="nc">NonZeroUsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">RangedI32</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// or bikeshed the type name here, the point is that "6" becomes a valid instance.</span>
</code></pre></div>



<a name="247511201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247511201" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247511201">(Jul 28 2021 at 20:12)</a>:</h4>
<p>Having language/syntactical integration with ranged/nonzero integers would be ideal, but when I brought it up before it was desired to have some experimentation in crates first. Both myself and <span class="user-mention" data-user-id="360486">@Kestrer</span> have created crates that do this with extremely similar APIs.</p>



<a name="247511659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247511659" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247511659">(Jul 28 2021 at 20:17)</a>:</h4>
<p>I'm not clear on what whoever asked for that wanted the crates to experiment about, since crates can't just decide for themselves that literals mean new things.</p>



<a name="247511826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247511826" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247511826">(Jul 28 2021 at 20:18)</a>:</h4>
<p>I think there <em>is</em> value in being able to have the equivalent of a u7 or u24, or an integer that can only be 1-5 but nothing else. But I don't think that should be a gate on the ability to enable the incredibly useful niche optimization.</p>



<a name="247511875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247511875" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247511875">(Jul 28 2021 at 20:18)</a>:</h4>
<p>It might make sense to have <code>Ranged</code>. But I don't want that to be the <em>only</em> way to get at the niche-defining attributes.</p>



<a name="247512152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247512152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247512152">(Jul 28 2021 at 20:21)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> it was more regarding the API itself, not the custom literals. But the API seems quite straightforward imo</p>



<a name="247512158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247512158" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247512158">(Jul 28 2021 at 20:21)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>  Currently these attributes <em>happen to</em> work on integer newtypes, so they're applied at the struct level. If you don't want it locked to a particular type, are you suggesting that valid range attributes be allowed on single fields within a struct?</p>



<a name="247512282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247512282" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247512282">(Jul 28 2021 at 20:22)</a>:</h4>
<p><em>Personally</em> I'd be fine with just having a <code>Ranged</code> type, but I would imagine there's use cases for the <code>valid_range_*</code> attributes.</p>



<a name="247512570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247512570" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247512570">(Jul 28 2021 at 20:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247512158">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span>  Currently these attributes <em>happen to</em> work on integer newtypes, so they're applied at the struct level. If you don't want it locked to a particular type, are you suggesting that valid range attributes be allowed on single fields within a struct?</p>
</blockquote>
<p>Long-term, I'd ideally love to have them apply to fields, but if that's problematic or difficult, I'd also be fine with saying they only apply to one-field (or one-non-ZST-field) types.</p>



<a name="247512993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247512993" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247512993">(Jul 28 2021 at 20:29)</a>:</h4>
<p>if they do only apply to one-field structs that seems to be so close to just having a Ranged type that it's fine, isn't it?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[valid_range(3, 7)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ExampleA</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ExampleB</span><span class="p">(</span><span class="n">Ranged</span><span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="247513142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513142" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513142">(Jul 28 2021 at 20:30)</a>:</h4>
<p>if you can put a range on any field within a struct that would be significantly different of course</p>



<a name="247513152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513152">(Jul 28 2021 at 20:30)</a>:</h4>
<p>With ExampleA, I can pass <code>some_a.0</code> to something expecting a <code>u32</code>, or do <code>some_a.0 &lt;&lt; 3 | 1</code> to construct a bitfield.</p>



<a name="247513166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513166" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513166">(Jul 28 2021 at 20:30)</a>:</h4>
<p>I can't do that with ExampleB.</p>



<a name="247513221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513221" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513221">(Jul 28 2021 at 20:30)</a>:</h4>
<p>With ExampleB, I'd expect to see a <em>lot</em> of <code>u32::from</code> calls in my code...</p>



<a name="247513273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513273" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513273">(Jul 28 2021 at 20:31)</a>:</h4>
<p>(Or in practice I'd probably provide an <code>.as_u32()</code> method for simple postfix syntax.)</p>



<a name="247513286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513286" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513286">(Jul 28 2021 at 20:31)</a>:</h4>
<p>Wouldn't it just be something like <code>b.0.get()</code>?</p>



<a name="247513312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513312" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513312">(Jul 28 2021 at 20:31)</a>:</h4>
<p>yeah, a postfix call</p>



<a name="247513486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513486" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513486">(Jul 28 2021 at 20:33)</a>:</h4>
<p>That would certainly help.</p>



<a name="247513623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513623" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513623">(Jul 28 2021 at 20:34)</a>:</h4>
<p>So in my mind what this comes down to is that: right now if you name a field you can read or write it. If there's "the same type but with a range on it" then sometimes you'll name a field but not be able write to it, or the write will implicitly have a check that can panic or something.</p>



<a name="247513680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247513680" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247513680">(Jul 28 2021 at 20:35)</a>:</h4>
<p>(assuming isn't not through a shared reference, yada yada, i think you probably know what i mean)</p>



<a name="247514110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247514110" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247514110">(Jul 28 2021 at 20:38)</a>:</h4>
<p>one answer to this would be to allow an implicit one-way conversion so that Ranged&lt;Number&gt; will implicitly convert to Number as necessary, so that it can still participate in math expressions without too much cruft</p>



<a name="247514285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247514285" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247514285">(Jul 28 2021 at 20:40)</a>:</h4>
<p>I don't think we want to add any more <em>implicit</em> coercions. <code>.get()</code> seems reasonable enough to make it easy to do math and similar on these.</p>



<a name="247514411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247514411" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247514411">(Jul 28 2021 at 20:41)</a>:</h4>
<p>(It's not <em>quite</em> as convenient as <code>.0</code>, but it seems good enough.)</p>



<a name="247514432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247514432" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247514432">(Jul 28 2021 at 20:41)</a>:</h4>
<p>That is what the non-zero types use already, and it mostly works</p>



<a name="247514661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247514661" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247514661">(Jul 28 2021 at 20:43)</a>:</h4>
<p>and if we want better literal support, that's a discussion so big that we should start it yesterday and it might be ready for the 2027 edition</p>



<a name="247515094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247515094" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247515094">(Jul 28 2021 at 20:46)</a>:</h4>
<p>I don't think there's anything that would actually preclude literals for compiler-provided types being introduced in a normal release, unless I'm missing something?</p>



<a name="247515126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247515126" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247515126">(Jul 28 2021 at 20:46)</a>:</h4>
<p>*numeric literals</p>



<a name="247516103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247516103" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247516103">(Jul 28 2021 at 20:55)</a>:</h4>
<p>From a strict syntax standpoint, it basically falls into the "allowing a program that wasn't valid before" bucket.</p>
<p>but from a bikeshed standpoint</p>



<a name="247516332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247516332" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247516332">(Jul 28 2021 at 20:57)</a>:</h4>
<p>which is allowed, no?</p>



<a name="247516474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247516474" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247516474">(Jul 28 2021 at 20:58)</a>:</h4>
<p>yeah, allowing additional programs that weren't valid before is generally allowed. (unless you really upset previous assumptions, like allowing Drop on Copy types)</p>



<a name="247516580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247516580" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247516580">(Jul 28 2021 at 20:59)</a>:</h4>
<p>there's edge cases (such as automatic formatting captures), but this wouldn't be one of them in any way i can think.</p>



<a name="247585137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247585137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247585137">(Jul 29 2021 at 13:47)</a>:</h4>
<p>Note that we can "just" make the field of <code>NonZero</code>public. Then you get the <code>.0</code> field access convenience, but writing is unsafe</p>



<a name="247589251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247589251" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> krdln <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247589251">(Jul 29 2021 at 14:19)</a>:</h4>
<p>read-only-public would be perfect for such fields, I guess (<a href="https://internals.rust-lang.org/t/pre-rfc-read-only-visibility/11280">https://internals.rust-lang.org/t/pre-rfc-read-only-visibility/11280</a>)</p>



<a name="247625373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247625373" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247625373">(Jul 29 2021 at 18:51)</a>:</h4>
<p>Opened an issue for read-only-public fields since I couldn't find one: <a href="https://github.com/rust-lang/rfcs/issues/3157">https://github.com/rust-lang/rfcs/issues/3157</a></p>



<a name="247823448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247823448" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247823448">(Jul 31 2021 at 20:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247288849">said</a>:</p>
<blockquote>
<p>Is there any reason these attributes couldn't be exposed to end users in some form (naturally under a different name)?</p>
</blockquote>
<p>Personally I'm not a fan of the two-attributes form.  Ideally I'd like to see it as something that integrates better with const generics -- that seems like an obvious desire to use with this, but I'm never a fan of putting locals or paths into attributes since scoping and name lookup and types and autocomplete and such are all weird.</p>
<p>Now that const generics exist, I'd be tempted to move this away from attributes and into "real" types.  So we could have <code>I32&lt;4, i32::MAX&gt;</code> or similar.</p>
<p>(The attributes don't seem to make sense on things like structs anyway.)</p>



<a name="247823510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247823510" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247823510">(Jul 31 2021 at 20:51)</a>:</h4>
<p>Possibly way overkill: <code>type u16 = U16&lt;0, 65535&gt;;</code></p>
<p>And allow subtyping.</p>



<a name="247878704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247878704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247878704">(Aug 01 2021 at 21:47)</a>:</h4>
<p>I'd prefer that as well to be honest. I should probably write a pre-RFC at some point.</p>



<a name="247878754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247878754" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247878754">(Aug 01 2021 at 21:48)</a>:</h4>
<p>It could use the attributes internally. That would just mean accepting any const value as opposed to literals only for the attribute.</p>



<a name="247910939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247910939" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247910939">(Aug 02 2021 at 11:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247823510">said</a>:</p>
<blockquote>
<p>Possibly way overkill: <code>type u16 = U16&lt;0, 65535&gt;;</code></p>
</blockquote>
<p>yes please</p>



<a name="247910972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247910972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247910972">(Aug 02 2021 at 11:34)</a>:</h4>
<p>you get into bootstrap problems with that, but hell it would be cool</p>



<a name="247911000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247911000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247911000">(Aug 02 2021 at 11:34)</a>:</h4>
<p>like we'd need "user defined" literals first</p>



<a name="247911034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247911034" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247911034">(Aug 02 2021 at 11:35)</a>:</h4>
<p>and defining the range would be super weird, as you'd be defining it in terms of itself</p>



<a name="247911046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247911046" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247911046">(Aug 02 2021 at 11:35)</a>:</h4>
<p>but the builtin integers being well <em>builtin</em> can make this work out without cycle errors</p>



<a name="247911216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247911216" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247911216">(Aug 02 2021 at 11:37)</a>:</h4>
<p>Seems similar to « Add for u16 » being implemented with « + », built in types solve that</p>



<a name="247932001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247932001" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247932001">(Aug 02 2021 at 15:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247823510">said</a>:</p>
<blockquote>
<p>Possibly way overkill: <code>type u16 = U16&lt;0, 65535&gt;;</code></p>
</blockquote>
<p>Possibly way way overkill: <code>type u16 = FixedSizeNumeric&lt;2, UNSIGNED, 0..=65535&gt;;</code></p>



<a name="247938833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247938833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247938833">(Aug 02 2021 at 16:27)</a>:</h4>
<p>what's the 2?</p>



<a name="247938890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247938890" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247938890">(Aug 02 2021 at 16:28)</a>:</h4>
<p>2 bytes?</p>



<a name="247945025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247945025" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247945025">(Aug 02 2021 at 17:20)</a>:</h4>
<p>You can't make <code>FixedSizeNumeric&lt;2, UNSIGNED, 0..=9&gt;</code> be the same type as <code>FixedSizeNumeric&lt;2, UNSIGNED, 0..10&gt;</code> though</p>



<a name="247946475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247946475" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247946475">(Aug 02 2021 at 17:32)</a>:</h4>
<p>we could add a normalization trait that normalizes the type to a single representation</p>



<a name="247946592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247946592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247946592">(Aug 02 2021 at 17:33)</a>:</h4>
<p>and yet it wouldn't work for char</p>



<a name="247946871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247946871" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247946871">(Aug 02 2021 at 17:35)</a>:</h4>
<p>sure, but we don't need to support <em>every</em> use case from the get go</p>



<a name="247946919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247946919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247946919">(Aug 02 2021 at 17:36)</a>:</h4>
<p>even if we had an all powerful feature later, we'd want a convenient easy API in the spirit of <code>U16&lt;10, 20&gt;</code></p>



<a name="247946948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247946948" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247946948">(Aug 02 2021 at 17:36)</a>:</h4>
<p>and we can always rewrite those in the more powerful API later if/when that comes</p>



<a name="247950155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247950155" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247950155">(Aug 02 2021 at 18:03)</a>:</h4>
<p>I don't think I've seen anyone mention what should happen when the number exceeds its range. for <code>let x: U16&lt;10, 20&gt; = 15;</code>, what does <code>x + x</code> do? normal overflow rules, where it panics in debug and "wraps" (i.e. just proceeds) in release?</p>



<a name="247950258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247950258" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247950258">(Aug 02 2021 at 18:04)</a>:</h4>
<p>or are people actually proposing full-fledged dependent types, where an operation like this would refuse to compile?</p>



<a name="247954592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247954592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247954592">(Aug 02 2021 at 18:44)</a>:</h4>
<p>I would expect that to be treated the same as 250u8 + 250u8.</p>



<a name="247954634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247954634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247954634">(Aug 02 2021 at 18:45)</a>:</h4>
<p>Runtime overflow. Optional compile-time warning <em>if</em> the compiler happens to detect it statically, but no guarantees.</p>



<a name="247959970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247959970" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247959970">(Aug 02 2021 at 19:27)</a>:</h4>
<p>yeah it would just overflow and wrap around</p>



<a name="247960098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247960098" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247960098">(Aug 02 2021 at 19:28)</a>:</h4>
<p>these weird types aren't gonna be the slightest bit efficient, but you go get what you asked for at least.</p>



<a name="247961354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961354" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961354">(Aug 02 2021 at 19:37)</a>:</h4>
<p>with these semantics I don't see why they would be any more or less efficient than the normal numeric types, unless you were expecting that <code>U64&lt;999_999_999_998, 999_999_999_999&gt;</code> would only take up a single byte or something</p>



<a name="247961555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961555" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961555">(Aug 02 2021 at 19:38)</a>:</h4>
<p>figuring out how to do wraparound correctly for <code>100</code> when the type is valid only for <code>37..42</code> seems like some messy modular arithmetic</p>



<a name="247961622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961622" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961622">(Aug 02 2021 at 19:39)</a>:</h4>
<p>not sure exactly what wraparound means when the type is <code>37..37</code> though</p>



<a name="247961625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961625" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961625">(Aug 02 2021 at 19:39)</a>:</h4>
<p>I don't think it should literally wrap around, I think it should just... do it. if you have <code>x: U16&lt;10, 20&gt; = 15</code>, then <code>x + x</code> is 30, not 20</p>



<a name="247961699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961699" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961699">(Aug 02 2021 at 19:40)</a>:</h4>
<p>but that is type incorrect</p>



<a name="247961713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961713" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961713">(Aug 02 2021 at 19:40)</a>:</h4>
<p>that would be like having a bool that has 3 in it</p>



<a name="247961740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961740" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961740">(Aug 02 2021 at 19:40)</a>:</h4>
<p>oh right, you wanted to use these for niches</p>



<a name="247961807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961807" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961807">(Aug 02 2021 at 19:41)</a>:</h4>
<p>also I think it would be 10, not 20</p>



<a name="247961813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961813" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961813">(Aug 02 2021 at 19:41)</a>:</h4>
<p>might as well just saturate at that point and avoid wrapping :P</p>



<a name="247961993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247961993" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247961993">(Aug 02 2021 at 19:42)</a>:</h4>
<p>I can't imagine anyone wanting such bizarre wrapping types in the general case</p>



<a name="247962083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247962083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247962083">(Aug 02 2021 at 19:43)</a>:</h4>
<p>actually I think they should just not have <code>+</code></p>



<a name="247962117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247962117" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247962117">(Aug 02 2021 at 19:43)</a>:</h4>
<p>and only provide checked_add?</p>



<a name="247962276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247962276" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247962276">(Aug 02 2021 at 19:45)</a>:</h4>
<p>adding a regular integer would make sense with either checked add or panic add</p>



<a name="247962353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247962353" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247962353">(Aug 02 2021 at 19:45)</a>:</h4>
<p>adding two bounded integers seems like a place you want fancy dependent types</p>



<a name="247962489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247962489" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247962489">(Aug 02 2021 at 19:46)</a>:</h4>
<p>as in <code>x + y: U16&lt;A + B, C + D&gt;</code> where <code>x: U16&lt;A, C&gt;</code> and <code>y: U16&lt;B, D&gt;</code></p>



<a name="247962505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247962505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247962505">(Aug 02 2021 at 19:46)</a>:</h4>
<p>lots of issues there though</p>



<a name="247963191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247963191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247963191">(Aug 02 2021 at 19:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247961622">said</a>:</p>
<blockquote>
<p>not sure exactly what wraparound means when the type is <code>37..37</code> though</p>
</blockquote>
<p>I'd say a type with a range of <code>37..37</code> should just be an uninhabited type, like <code>!</code> or an <code>enum</code> with no variants.</p>



<a name="247963493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247963493" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247963493">(Aug 02 2021 at 19:55)</a>:</h4>
<p>I think a good idea might be to initially just not implement <code>Add</code> for bounded-integer types, we can add implementations later once const generics are good enough to give the result type we want.</p>



<a name="247963606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247963606" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247963606">(Aug 02 2021 at 19:56)</a>:</h4>
<p>similar to what happened with the non-zero types.</p>



<a name="247963687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247963687" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247963687">(Aug 02 2021 at 19:57)</a>:</h4>
<p>looking at the deranged crate mentioned by OP, it doesn't impl Add for its types</p>



<a name="247964441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247964441" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247964441">(Aug 02 2021 at 20:03)</a>:</h4>
<p>we might be getting off-topic, if the goal is to stabilize something that lets users specify their own niches, are there any types besides numerics that would want to use this? if so, then only providing ranged numeric types might not be enough</p>



<a name="247964557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247964557" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247964557">(Aug 02 2021 at 20:04)</a>:</h4>
<p>For composite objects I think you can usually express any niches in terms of niches on the fields</p>



<a name="247964620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247964620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247964620">(Aug 02 2021 at 20:05)</a>:</h4>
<p>so I think it does actually just boil down to bounded integral types, unless you want to consider other kinds of predicates like even integers</p>



<a name="247965420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247965420" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247965420">(Aug 02 2021 at 20:12)</a>:</h4>
<p>if eddyb thinks that supporting non-contiguous niche ranges isn't worth it, then that's good enough for me :P</p>



<a name="247969930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247969930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247969930">(Aug 02 2021 at 20:51)</a>:</h4>
<p>supporting things like even integers will be useful since it lets us express <code>(&amp;u16, i1)</code> all packed into one <code>usize</code>, since <code>&amp;u16</code> is known to be even and the <code>i1</code> can be stored in the lowest bit.</p>



<a name="247971709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247971709" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247971709">(Aug 02 2021 at 21:08)</a>:</h4>
<p>I think ranged integers are on-topic, tho the topic name could probably be changed. deranged intentionally does not implement <code>Add</code> and other arithmetic operations. With full const generics, I'd like to have the min and max added (and likewise for <code>Sub</code>, <code>Mul</code>, and <code>Div</code>). imo the bigger problem would be figuring out inter-conversions, like <code>int&lt;200, 250&gt; + int&lt;200, 250&gt;</code> would have to convert from <code>u8 + u8</code> to a <code>u16</code> internally.</p>



<a name="247976895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247976895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247976895">(Aug 02 2021 at 21:59)</a>:</h4>
<blockquote>
<p>since &amp;u16 is known to be even</p>
</blockquote>
<p>Well yeah, but that should be implemented in the compiler, so it doesn't need a special even-integers type.</p>



<a name="247979220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247979220" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247979220">(Aug 02 2021 at 22:29)</a>:</h4>
<blockquote>
<p>supporting things like even integers will be useful since it lets us express <code>(&amp;u16, i1)</code> all packed into one <code>usize</code>, since <code>&amp;u16</code> is known to be even and the <code>i1</code> can be stored in the lowest bit.</p>
</blockquote>
<p>Not necessarily. IIRC, rust uses the abi mandated alignment, which could be 1 on some platform. There isn't any requirement I've seen that scalar types have alignment match their size. Also that can't be packed anyways, since you can read and write the &amp;u16 via references.</p>



<a name="247979233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247979233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247979233">(Aug 02 2021 at 22:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247976895">said</a>:</p>
<blockquote>
<blockquote>
<p>since &amp;u16 is known to be even</p>
</blockquote>
<p>Well yeah, but that should be implemented in the compiler, so it doesn't need a special even-integers type.</p>
</blockquote>
<p>I guess I meant known-even integers would be useful for things like where <code>a: &amp;u16</code>: <code>a as *const u16 as EvenUsize</code>, except that the type should be more general than <code>EvenUsize</code></p>



<a name="247979382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/247979382" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247979382">(Aug 02 2021 at 22:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D/near/247979220">said</a>:</p>
<blockquote>
<blockquote>
<p>supporting things like even integers will be useful since it lets us express <code>(&amp;u16, i1)</code> all packed into one <code>usize</code>, since <code>&amp;u16</code> is known to be even and the <code>i1</code> can be stored in the lowest bit.</p>
</blockquote>
<p>Not necessarily. IIRC, rust uses the abi mandated alignment, which could be 1 on some platform. There isn't any requirement I've seen that scalar types have alignment match their size. Also that can't be packed anyways, since you can read and write the &amp;u16 via references.</p>
</blockquote>
<p>that can be fixed with <code>#[bitpacked] struct S&lt;'a&gt;(&amp;'a u16, i1)</code> on all normal platforms where <code>u16</code> has alignment 2</p>



<a name="248242626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/248242626" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#248242626">(Aug 03 2021 at 16:07)</a>:</h4>
<p>I don't find the "all even numbers" example compelling. Ranged integers are useful for correctness, and enabling niche optimizations is a nice cherry on top, but I don't think we should go around packing integers like that. If libraries want to do so, then they can build that on top of ranged integers</p>



<a name="248262459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/248262459" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#248262459">(Aug 03 2021 at 18:47)</a>:</h4>
<p>Several libraries (including LLVM and clang) have the previously mentioned packing extra things into the pointer's LSB bits optimization, since it saves a bunch of space (50% in some cases). If one were to try to express the ranges needed for an integer with LSB bits that are zero, basically anything larger than <code>u8</code> would be prohibitively expensive in compile time since a <code>u32</code> with the lower 3 bits set to zero would need 536870912 separate ranges to express, hence why I think the compiler should eventually provide more efficient support for that.</p>



<a name="248269222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/248269222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#248269222">(Aug 03 2021 at 19:37)</a>:</h4>
<p>that has to be a separate feature from what we're considering here, a library can't store arbitrary data in a niche</p>



<a name="248349280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%23%5Brustc_layout_scalar_valid_range_start%5D/near/248349280" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#248349280">(Aug 04 2021 at 13:27)</a>:</h4>
<p>yea, niches for ranges and niches for specific bit masks seem like two separate features that could get their own support each</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>