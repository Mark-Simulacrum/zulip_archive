<html>
<head><meta charset="utf-8"><title>std::thread::available_concurrency · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html">std::thread::available_concurrency</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255115631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255115631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255115631">(Sep 27 2021 at 20:34)</a>:</h4>
<p>I submitted a pull request to implement <code>std::thread::available_concurrency</code> using <code>sched_getaffinity</code> on Linux, which handles the case where the process doesn't have access to all CPUs, such as when limited via <code>taskset</code> or similar.</p>
<p>Once that goes in, I <em>think</em> that should clear the path for stabilizing <code>available_concurrency</code>. Any objections to proposing stabilization at that point?</p>



<a name="255115710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255115710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255115710">(Sep 27 2021 at 20:35)</a>:</h4>
<p>I'm aware that there's also a request to support cgroup-based CPU limiting. I think that's potentially useful to add, but I personally think it'd be OK to allow that to happen in parallel (no pun intended), rather than waiting for an implementation.</p>



<a name="255119872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255119872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255119872">(Sep 27 2021 at 21:04)</a>:</h4>
<p>Well, the cgroup limitations are important for containers, more so than affinity masks.</p>



<a name="255120785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255120785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255120785">(Sep 27 2021 at 21:11)</a>:</h4>
<p>So it's an improvement, but it's not clear how this paves the way to stabilization more than adding the cgroup part would.</p>
<p>Of course we could say that neither is critical to stabilization and the process could have been started previously.</p>



<a name="255157170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255157170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255157170">(Sep 28 2021 at 03:50)</a>:</h4>
<p>sched_getaffinity doesn't just handle thread affinity; it also covers cpusets.</p>



<a name="255157248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255157248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255157248">(Sep 28 2021 at 03:50)</a>:</h4>
<p>So <em>as far as I know</em> it covers the kind of container restriction that restricts the use of CPUs.</p>



<a name="255157282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255157282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255157282">(Sep 28 2021 at 03:51)</a>:</h4>
<p>It doesn't cover bandwidth-based restriction, but it covers cpuset-based restriction.</p>



<a name="255278289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/255278289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#255278289">(Sep 28 2021 at 18:55)</a>:</h4>
<p>Well, at least with k8s cfs quotas are the default for CPU allocation. Affinity-based limits are a beta feature.</p>



<a name="257175561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/257175561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#257175561">(Oct 12 2021 at 09:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency/near/255115631">said</a>:</p>
<blockquote>
<p>Once that goes in, I <em>think</em> that should clear the path for stabilizing <code>available_concurrency</code>. Any objections to proposing stabilization at that point?</p>
</blockquote>
<p>I think that makes sense! - I've submitted a patch to update the docs so we're ready to stabilize (+ we merged the naming change), and think if your patch lands as well, we'll be in a really good spot to stabilize.</p>



<a name="257175672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/257175672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#257175672">(Oct 12 2021 at 09:44)</a>:</h4>
<p>The one thing missing that we may want to address after that, is adding support for CPU limits on Windows - but that doesn't seem like it should be a blocker for stabilizing the API as long as we document that limitations exist.</p>



<a name="257176999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/257176999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#257176999">(Oct 12 2021 at 09:55)</a>:</h4>
<p>Yeah, I think we should have a <em>very</em> careful caveat comment, stating that it's useful as a default value for the amount of parallel jobs to run, but that there are many system-specific things it may not take into account, that some applications will want more specialized functionality, and that most applications should provide a means for the user to override the value.</p>



<a name="257181817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/257181817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#257181817">(Oct 12 2021 at 10:39)</a>:</h4>
<p>I just posted a bunch of comments and suggestions on <a href="https://github.com/rust-lang/rust/pull/89670/">https://github.com/rust-lang/rust/pull/89670/</a> .</p>



<a name="257181835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/257181835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#257181835">(Oct 12 2021 at 10:39)</a>:</h4>
<p>I think with all of those integrated, we'd have sufficient caveats without being overly specific.</p>



<a name="257563285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3Aavailable_concurrency/near/257563285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3Aavailable_concurrency.html#257563285">(Oct 14 2021 at 16:22)</a>:</h4>
<p>Yay, my PR has been merged! -- I believe we just need to merge <a href="https://github.com/rust-lang/rust/pull/89310">https://github.com/rust-lang/rust/pull/89310</a> next and then this should be ready to propose for stabilization?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>