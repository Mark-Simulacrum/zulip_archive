<html>
<head><meta charset="utf-8"><title>std::fs::rename_noreplace? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html">std::fs::rename_noreplace?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261420177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261420177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261420177">(Nov 14 2021 at 14:26)</a>:</h4>
<p>As far as I can see the standard library currently has no way of renaming a file such that if the destination already exists, the operation fails. Note that checking if the destination exists before renaming is unsatisfactory due to race conditions.</p>
<p>I believe we could support this on Linux using <code>renameat2</code> with <code>RENAME_NOREPLACE</code> and on Windows as we do now using <code>MoveFileExW</code>, just without specifying <code>MOVEFILE_REPLACE_EXISTING</code>.</p>



<a name="261420903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261420903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261420903">(Nov 14 2021 at 14:38)</a>:</h4>
<p>windows and linux support isn't sufficient though, afaik the BSDs don't have support for that</p>



<a name="261424905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261424905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261424905">(Nov 14 2021 at 16:14)</a>:</h4>
<p>On BSD we could do the equivalent of <code>std::fs::hard_link(src, dst)?; std::fs::remove_file(src)?;</code> maybe? It is not quite atomic because we could lose permissions to remove the src file after the creation of the hard link</p>



<a name="261425066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261425066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261425066">(Nov 14 2021 at 16:18)</a>:</h4>
<p>src could also be replaced between hardlink and remove_file</p>



<a name="261425082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261425082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261425082">(Nov 14 2021 at 16:19)</a>:</h4>
<p>Which I would think is a larger concern than the file sticking arround.</p>



<a name="261425108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261425108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261425108">(Nov 14 2021 at 16:19)</a>:</h4>
<p>(Also, hard_link doesn't work accross filesystems, but I presume rename does)</p>



<a name="261425266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261425266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261425266">(Nov 14 2021 at 16:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F/near/261425108">said</a>:</p>
<blockquote>
<p>(Also, hard_link doesn't work accross filesystems, but I presume rename does)</p>
</blockquote>
<p>rename(2) works only if source and destination are on the same filesystem.</p>



<a name="261425405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261425405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261425405">(Nov 14 2021 at 16:27)</a>:</h4>
<p>Ah, nvm then. My point about potentially deleting a replacement stands, though.</p>



<a name="261426614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261426614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261426614">(Nov 14 2021 at 16:53)</a>:</h4>
<p><code>link</code> does not replace the destination</p>



<a name="261426666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261426666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261426666">(Nov 14 2021 at 16:54)</a>:</h4>
<p>also, not all filesystems support hardlinks</p>



<a name="261431191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261431191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261431191">(Nov 14 2021 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F/near/261420903">said</a>:</p>
<blockquote>
<p>windows and linux support isn't sufficient though, afaik the BSDs don't have support for that</p>
</blockquote>
<p>Supporting it for those platforms thanks to the platform-specific extension traits would already be a start, wouldn't it?</p>



<a name="261431263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261431263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261431263">(Nov 14 2021 at 18:24)</a>:</h4>
<p>Not all filesystems support <code>RENAME_NOREPLACE</code> either</p>



<a name="261436683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261436683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261436683">(Nov 14 2021 at 20:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F/near/261431191">said</a>:</p>
<blockquote>
<p>Supporting it for those platforms thanks to the platform-specific extension traits would already be a start, wouldn't it?</p>
</blockquote>
<p>Then we'd have the same method on different traits and people would have to import them with separate cfg's which means it's not a great abstraction</p>



<a name="261480978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261480978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261480978">(Nov 15 2021 at 10:40)</a>:</h4>
<p>What about adding it anyway (as <code>std::fs::rename_noreplace</code>, not platform-specific names), returning an error with <code>ErrorKind::Unsupported</code> on platforms that don't support it (yet)? Then we can slowly add implementations for platforms as support becomes available, and we're not limited to compile-time platform support detection either (e.g. if the operation is only supported on a certain filesystem).</p>



<a name="261481684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261481684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261481684">(Nov 15 2021 at 10:48)</a>:</h4>
<p>well, and what would users do on error? implement a fallback? then we might as well put the fallback in the standard library and put a warning on it that it's not atomic on all systems.</p>



<a name="261483783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261483783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261483783">(Nov 15 2021 at 11:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F/near/261481684">said</a>:</p>
<blockquote>
<p>well, and what would users do on error? implement a fallback? then we might as well put the fallback in the standard library and put a warning on it that it's not atomic on all systems.</p>
</blockquote>
<p>I don't agree. Some users might be okay with a non-atomic fallback, other users might want to bubble up the error/or fail entirely if atomicity can't be guaranteed. With an error the choice is theirs.</p>



<a name="261484450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261484450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261484450">(Nov 15 2021 at 11:19)</a>:</h4>
<p>E.g.:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">std</span>::<span class="n">fs</span>::<span class="n">rename_noreplace</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">).</span><span class="n">or_else</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span>::<span class="n">ErrorKind</span>::<span class="n">Unsupported</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dst</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">io</span>::<span class="n">Error</span>::<span class="n">new</span><span class="p">(</span><span class="n">io</span>::<span class="n">ErrorKind</span>::<span class="n">AlreadyExists</span><span class="p">,</span><span class="w"> </span><span class="s">"rename_noreplace"</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">rename</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>



<a name="261484757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261484757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261484757">(Nov 15 2021 at 11:23)</a>:</h4>
<p>What could be possible is to add a boolean flag, so it's <code>std::fs::rename_noreplace(src: &amp;Path, dst: &amp;Path, require_atomic: bool)</code> and <code>std::fs::rename_noreplace(src, dst, false)</code> gives you the above behavior whereas <code>std::fs::rename_noreplace(src, dst, true)</code> would return the error.</p>



<a name="261484844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261484844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261484844">(Nov 15 2021 at 11:24)</a>:</h4>
<p>(or two functions)</p>



<a name="261506639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Afs%3A%3Arename_noreplace%3F/near/261506639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Afs.3A.3Arename_noreplace.3F.html#261506639">(Nov 15 2021 at 14:52)</a>:</h4>
<p>That feels like an awkward interface, especially for the hopeful future case where users can count on it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>