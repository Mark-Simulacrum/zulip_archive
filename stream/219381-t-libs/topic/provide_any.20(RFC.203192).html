<html>
<head><meta charset="utf-8"><title>provide_any (RFC 3192) · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html">provide_any (RFC 3192)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260970184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260970184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260970184">(Nov 10 2021 at 10:27)</a>:</h4>
<p><a href="https://github.com/rust-lang/rfcs/pull/3192">https://github.com/rust-lang/rfcs/pull/3192</a></p>
<p>Hi libs team (and libs-interested folk), I posted this RFC last week. It proposes adding a new module to libcore for adding type-driven access to data in trait objects. It is somewhat related to the any module in that it is a dynamic/reflective capability. The motivation is for retrieving context from Error objects and is part of the Error WG's roadmap. It is fairly high priority for the Error WG, so I would be very grateful if people could take a look!</p>



<a name="260970255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260970255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260970255">(Nov 10 2021 at 10:28)</a>:</h4>
<p>I'm happy to discuss here or on the RFC. Or, if anyone is interested, I'm happy to have a call to discuss things in depth</p>



<a name="260974687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260974687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260974687">(Nov 10 2021 at 11:10)</a>:</h4>
<p>I've nominated it for discussion. (That doesn't guarantee we'll get to it this week.)</p>



<a name="260975457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260975457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260975457">(Nov 10 2021 at 11:18)</a>:</h4>
<p>Thanks!</p>



<a name="260976219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260976219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260976219">(Nov 10 2021 at 11:26)</a>:</h4>
<p>So, the fully general answer for "I want to provide a field of type T but the type is already doing so" is "wrap it in a newtype"?</p>



<a name="260978052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260978052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260978052">(Nov 10 2021 at 11:44)</a>:</h4>
<p>yes</p>



<a name="260990299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260990299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260990299">(Nov 10 2021 at 13:44)</a>:</h4>
<p>Or use a different tag type I think</p>



<a name="260990330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260990330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260990330">(Nov 10 2021 at 13:44)</a>:</h4>
<p>Tho not sure if that is exposed atm</p>



<a name="260991778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/260991778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#260991778">(Nov 10 2021 at 13:56)</a>:</h4>
<p>It is exposed and users could do that</p>



<a name="261022751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261022751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261022751">(Nov 10 2021 at 17:20)</a>:</h4>
<p>Interesting API; having a "single <code>Error</code> API addition to rule them all" seems very appealing indeed <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<p>Some remarks:</p>
<p>Given the complexity of non-<code>'static</code>-<code>Any </code> erasure (many programmers may not be well acquainted with the pattern), I'd suggest some intro or dedicated blog post to the matter, similar to how Niko wrote all those blog posts regarding <code>async fn</code> in traits. I've personally made the effort to "reduce" that pattern down to a file, and to try and rename stuff for, I hope, maximal clarity: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=501cada82665f147615b504bccac14dd">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=501cada82665f147615b504bccac14dd</a></p>
<hr>
<p>I do think think that the example ought to show usage of newtypes right away; otherwise the risk of conflicts would be too big ( and it would have the tangential benefit of "naming" the fields that we are querying):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">lib</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[derive(::ref_cast::RefCast)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[repr(transparent)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Context</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">provide_context</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Requisition</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">req</span><span class="w"> </span><span class="p">.</span><span class="n">provide_ref</span>::<span class="o">&lt;</span><span class="w"> </span><span class="n">lib</span>::<span class="n">Context</span><span class="o">&lt;</span><span class="n">Backtrace</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="p">(</span><span class="n">RefCast</span>::<span class="n">ref_cast</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">backtrace</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">provide_ref</span>::<span class="o">&lt;</span><span class="w"> </span><span class="n">lib</span>::<span class="n">Context</span><span class="o">&lt;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="p">(</span><span class="n">RefCast</span>::<span class="n">ref_cast</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">suggestion</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>although it is a bit cumbersome. Taking <span class="user-mention" data-user-id="220273">@Jane Lusby [she/her]</span>'s suggestion, it would be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">lib</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">static_ty_constructors</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">Ref</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="bp">Self</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">lt</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">provide_context</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Requisition</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">req</span><span class="w"> </span><span class="p">.</span><span class="n">provide</span>::<span class="o">&lt;</span><span class="w"> </span><span class="n">lib</span>::<span class="n">Ref</span><span class="o">&lt;</span><span class="n">Backtrace</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">backtrace</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">provide</span>::<span class="o">&lt;</span><span class="w"> </span><span class="n">lib</span>::<span class="n">Ref</span><span class="o">&lt;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">suggestion</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It's a bit better, but both cases are a bit too cumbersome / complex for downstream users, although I guess either case could be handled by a lib-provided <code>provide_context</code> macro?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">provide_context</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Requisition</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lib</span>::<span class="n">provide_context</span><span class="o">!</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">Backtrace</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">backtrace</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">suggestion</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>So even though newtypes would solve conflicts in a robust fashion, as well as provide a way to name these things, I think a more intuitive API would be to just provide names altogether, assuming generic <code>const &amp;str</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">provide_context</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Requisition</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">req</span><span class="w"> </span><span class="p">.</span><span class="n">provide_ref</span>::<span class="o">&lt;</span><span class="n">Backtrace</span><span class="p">,</span><span class="w"> </span><span class="s">"lib::backtrace"</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">backtrace</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">provide_ref</span>::<span class="o">&lt;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="s">"lib::suggestion"</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">suggestion</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="261243895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261243895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261243895">(Nov 12 2021 at 12:16)</a>:</h4>
<p>Maybe i ask a perhaps naive question about <code>Error</code> and <code>backtrace</code>.   If the <code>Backtrace</code> type was a extern type defined in "C", the <code>Error</code>-in-<code>core</code> problem is immediately solved, right?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">downstream</span><span class="w"> </span><span class="k">type</span> <span class="nc">Backtrace</span><span class="p">;</span><span class="w">   </span><span class="c1">// fictional syntax;</span>

<span class="k">trait</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">fn</span> <span class="nf">backtrace</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">Backtrace</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>just like in C++:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="c1">/// core.h</span>

<span class="k">class</span> <span class="nc">Backtrace</span><span class="p">;</span><span class="w"></span>

<span class="k">class</span> <span class="nc">IError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IError</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="k">virtual</span><span class="w"> </span><span class="n">Backtrace</span><span class="o">*</span><span class="w"> </span><span class="nf">get_backtrace</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I mean, i'm a little confused, what's exactly stopping us from allowing declaring an existential type that will be defined in a downstream crate?</p>



<a name="261244104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261244104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261244104">(Nov 12 2021 at 12:19)</a>:</h4>
<p>Language support</p>



<a name="261244305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261244305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261244305">(Nov 12 2021 at 12:21)</a>:</h4>
<p>We could do that but what would the advantage be? You'd still have to provide the implemention when in no_std and as far as I can tell it would be no different in practice to the backtrace in core RFC</p>



<a name="261244690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261244690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261244690">(Nov 12 2021 at 12:25)</a>:</h4>
<p>When providing implementation, if one don't have/need <code>alloc</code>, they can just implement <code>backtrace</code> fn with <code>{ None }</code>. After far as i can tell, there's no need for <code>Backtrace</code>'s layout or other information if we know that it's <code>Sized</code> (somehow) here.</p>



<a name="261244830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261244830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261244830">(Nov 12 2021 at 12:26)</a>:</h4>
<p>How would Backtrace::capture work?</p>



<a name="261244936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261244936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261244936">(Nov 12 2021 at 12:27)</a>:</h4>
<p>Also to be clear, I'm not against this idea I just don't know how to make it work and my current impression is that it's not worth it since we know we want generic member access either way</p>



<a name="261245233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245233">(Nov 12 2021 at 12:31)</a>:</h4>
<p>Sure, i'm not against generic member access as a functionality. Just not sure if it's something that's better opt-in than living in core :)</p>



<a name="261245399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245399">(Nov 12 2021 at 12:33)</a>:</h4>
<p>And i know <a href="https://github.com/tokio-rs/valuable">https://github.com/tokio-rs/valuable</a>  provides another approach for accessing members.</p>



<a name="261245491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245491">(Nov 12 2021 at 12:34)</a>:</h4>
<p>How would it integrate with the error trait without being in core?</p>



<a name="261245599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245599">(Nov 12 2021 at 12:35)</a>:</h4>
<p>Maybe by defining another trait with error trait as super trait?</p>



<a name="261245727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245727">(Nov 12 2021 at 12:37)</a>:</h4>
<p>That can't work as shown by the Fail trait from the failure crate, it would require that everyone switched to the new trait</p>



<a name="261245776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245776">(Nov 12 2021 at 12:37)</a>:</h4>
<p>Also it would have to implement its own source method that returns the super trait to be able to report context from sources</p>



<a name="261245890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261245890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261245890">(Nov 12 2021 at 12:38)</a>:</h4>
<p>Tho technically that could be avoided by using the generic member access method from the new trait to supercede the source method, but this would be incredibly hard (probably impossible) to coordinate across the ecosystem</p>



<a name="261246005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246005">(Nov 12 2021 at 12:39)</a>:</h4>
<p>I'd love to see a proposal based on valuable though</p>



<a name="261246130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246130">(Nov 12 2021 at 12:41)</a>:</h4>
<p>I've taken a look at it but my assumption is that it's more focused on letting the callee inform the caller of which data it has so that it can basically push information into logging and other systems. Whereas generic number access is more pull-based where the reporter grabs out the context it believes is relevant when creating an error report</p>



<a name="261246386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246386">(Nov 12 2021 at 12:43)</a>:</h4>
<p>i think the central difference is that, whether the caller learn information from the callee, or the caller making assumptions based on outband knowledge (an error maybe has a backtrace, etc)</p>



<a name="261246742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246742">(Nov 12 2021 at 12:46)</a>:</h4>
<p>And maybe an error has two backtraces... now which?</p>



<a name="261246844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246844">(Nov 12 2021 at 12:47)</a>:</h4>
<p>If anything that seems like an argument for generic member access since you can return a &amp;[Backtrace] or use a different tag type for each one, whereas fn backtrace is far more restrictive</p>



<a name="261246863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246863">(Nov 12 2021 at 12:47)</a>:</h4>
<p>Or an iterator</p>



<a name="261246932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246932">(Nov 12 2021 at 12:48)</a>:</h4>
<p>Or some specific trait wrapper, whatever makes sense for your application</p>



<a name="261246991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261246991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261246991">(Nov 12 2021 at 12:48)</a>:</h4>
<p>Though I have trouble imagining an error where a single error in the chain would store multiple Backtraces. Do you have an example scenario in mind?</p>



<a name="261247158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261247158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261247158">(Nov 12 2021 at 12:50)</a>:</h4>
<p>Sure, imagine parallel rustc collects 10 ICEs (definitely impossible) from a single run. Now here's an error report with 10 backtraces.</p>



<a name="261247230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261247230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261247230">(Nov 12 2021 at 12:51)</a>:</h4>
<p>That sounds more like a report with 10 source errors to me</p>



<a name="261247672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261247672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261247672">(Nov 12 2021 at 12:55)</a>:</h4>
<p>Maybe. Now this is semantic inspection without schema but with lots of singletons (identified by typetags), without any support for enums, arrays, maps and other reprs. I feel there's something not entirely correct with this approach.</p>



<a name="261251441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261251441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261251441">(Nov 12 2021 at 13:29)</a>:</h4>
<blockquote>
<p>I mean, i'm a little confused, what's exactly stopping us from allowing declaring an existential type that will be defined in a downstream crate?</p>
</blockquote>
<p>It would break if there were multiple downstream crates defining that type. so you'd need to define exactly which crate will define that type. but then you basically need to depend on a downstream crate, which introduces a cycle.</p>
<p>a general way for downstream crates to plug implementations into upstream crates would be super useful for many things though. right now we only have that for panic handling and allocation basically (and the <code>main</code> funciton, depending how you look at it), each with their own specific mechanism. it could be used for many more things, such as providing os/platform-specific parts of <code>std</code> through a separate crate. definitely not going to be easy to design this though.</p>
<p>your C++ example isn't easily transferrable to Rust, because if two translation units would have their own version of <code>struct Backtrace</code>, <code>IError</code> in the header would still compile fine, resulting in all kind of unsoundness when one of those <code>Backtrace</code> structs gets interpreted as the other.</p>



<a name="261252493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261252493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261252493">(Nov 12 2021 at 13:37)</a>:</h4>
<p>is downstream even the right place for that? it could be a dependency-shaped hole in a crate that needs to be filled before you can build anything depending on it</p>



<a name="261252712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261252712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261252712">(Nov 12 2021 at 13:38)</a>:</h4>
<p>sure, whether you would call it 'up' or 'down' depends on your definitions i suppose. but it's not something that the crate 'with the hole' defines as a dependency by itself. something else ('downstream') will have to fill that hole.</p>



<a name="261253201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261253201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261253201">(Nov 12 2021 at 13:42)</a>:</h4>
<p>well, a depenceny hole could be filled by cargo by inserting it before building core (so assuming Zbuild-std). that might require less compiler magic.</p>



<a name="261253311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261253311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261253311">(Nov 12 2021 at 13:43)</a>:</h4>
<p>sure, but there are also many downsides to that approach. but let's not derail the provide_any discussion.</p>



<a name="261255647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/provide_any%20%28RFC%203192%29/near/261255647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/provide_any.20(RFC.203192).html#261255647">(Nov 12 2021 at 14:01)</a>:</h4>
<p>I think there's an extern trait rfc that more or less proposed this kind of mechanism that I really liked</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>