<html>
<head><meta charset="utf-8"><title>Eliding clones into copies · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html">Eliding clones into copies</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262099159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262099159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262099159">(Nov 19 2021 at 17:27)</a>:</h4>
<p>Further to <a href="https://www.reddit.com/r/rust/comments/qwfo33/comment/hl5bwg4/">this comment on the Rust subreddit</a>, I found <a href="https://github.com/rust-lang/rust/pull/81854">the PR that specialized <code>clone_from_slice</code> for <code>T: Copy</code></a> but it doesn't explain its motivation.  Is it  always valid to elide clones into copies (cloning may have side effects) and, if so, should that be more clearly documented?  cc <span class="user-mention" data-user-id="330154">@The 8472</span> (PR author).</p>



<a name="262100960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262100960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262100960">(Nov 19 2021 at 17:39)</a>:</h4>
<p><a href="https://rust-lang.github.io/rfcs/1521-copy-clone-semantics.html">https://rust-lang.github.io/rfcs/1521-copy-clone-semantics.html</a></p>



<a name="262104765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262104765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262104765">(Nov 19 2021 at 18:03)</a>:</h4>
<p>I do think it's kinda odd that <code>vec![x].clone().pop().unwrap()</code> is allowed to just be a Copy and not call the clone, but <code>x.clone()</code> isn't.  There was some conversation about that on IRLO recently: <a href="https://internals.rust-lang.org/t/associativity-commutivity-etc-for-standard-operators/15251/31?u=scottmcm">https://internals.rust-lang.org/t/associativity-commutivity-etc-for-standard-operators/15251/31?u=scottmcm</a></p>



<a name="262106257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262106257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262106257">(Nov 19 2021 at 18:14)</a>:</h4>
<p>Hm.  It seems some official clarification may be required.  I guess there isn't a process for amending approved RFCs?  So would clarification require a further RFC?</p>



<a name="262109348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262109348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262109348">(Nov 19 2021 at 18:37)</a>:</h4>
<p>It's not really about which specific call but who does the substitution. the compiler isn't allowed to replace it but the library is.</p>



<a name="262109406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262109406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262109406">(Nov 19 2021 at 18:37)</a>:</h4>
<p>So a library can replace a <code>.clone()</code> (maybe in some generic code for example) with a copy. That's pretty much what many vec specializations do.</p>



<a name="262109657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262109657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262109657">(Nov 19 2021 at 18:39)</a>:</h4>
<p>But I don't find that 100% clear from the docs or RFC.  To my reading the RFC says "these are the language semantics, so a compiler can make this optimization".   Hence the confusion in the current Reddit discussion, and the earlier IRLO one.</p>



<a name="262113825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262113825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262113825">(Nov 19 2021 at 19:05)</a>:</h4>
<p>Hrm, true. I guess the RFC could be amended, clarifications shouldn't take much ceremony. I don't think it makes that much practical difference. Even if we think the compiler would theoretically be allowed to do it it currently doesn't anyway, while std does make copious use of that license.</p>



<a name="262113962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262113962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262113962">(Nov 19 2021 at 19:06)</a>:</h4>
<p>So the primary difference is only whether <em>direct</em> calls to <code>.clone()</code> execute side-effects. As soon as you pass it off to something else that says it'll clone then it may not.</p>



<a name="262120401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262120401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262120401">(Nov 19 2021 at 19:50)</a>:</h4>
<p>Unless the compiler <em>is</em> allowed to perform this optimization (and I'm minded to agree that it <em>isn't</em>, or at least <em>shouldn't be</em>), should RFC 1521 even exist at all?  After all, in that case and as you say, this is neither a language nor compiler issue: it's "just" a library one—so shouldn't it just be documented on each relevant library method?  E.g. <code>clone_from_slice</code> would explicitly document that it will use copy instead of clone if <code>T: Copy</code>.</p>



<a name="262122232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262122232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262122232">(Nov 19 2021 at 20:03)</a>:</h4>
<p>Perhaps the RFC gives permission to do it retroactively, even if it could be considered a behaviour-breaking change.</p>
<p>(See how I just specialized it for arrays last week.)</p>



<a name="262122247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262122247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262122247">(Nov 19 2021 at 20:03)</a>:</h4>
<p>It's not specific to <code>clone_from_slice</code>. The standard library does that kind of optimization in an expanding set of operations.</p>



<a name="262122418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262122418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262122418">(Nov 19 2021 at 20:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies/near/262122247">said</a>:</p>
<blockquote>
<p>It's not specific to <code>clone_from_slice</code>. The standard library does that kind of optimization in an expanding set of operations.</p>
</blockquote>
<p>Sure, I get that.  But the point remains: this is an implementation decision of each library function and not a wider language/compiler specification.</p>



<a name="262122632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262122632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262122632">(Nov 19 2021 at 20:06)</a>:</h4>
<p>libs design gets RFCs too since it practically affects a lot of code. slices are pretty fundamental, even if its implemented methods aren't provided by the compiler itself.</p>



<a name="262122708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262122708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262122708">(Nov 19 2021 at 20:07)</a>:</h4>
<p>So the RFC basically says we reserve the right to do this anywhere.</p>



<a name="262122870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262122870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262122870">(Nov 19 2021 at 20:08)</a>:</h4>
<p>Okay, fair.  So then maybe the RFC just needs to be clarified as being explicitly a libs one and not a wider language one?  ¯\_(ツ)_/¯</p>



<a name="262123000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262123000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262123000">(Nov 19 2021 at 20:09)</a>:</h4>
<p>yeah, just make a PR, I think clarifications don't need much ceremony</p>



<a name="262127225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Eliding%20clones%20into%20copies/near/262127225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Eliding.20clones.20into.20copies.html#262127225">(Nov 19 2021 at 20:44)</a>:</h4>
<p>Thanks.   I've opened <a href="https://github.com/rust-lang/rfcs/pull/3197">https://github.com/rust-lang/rfcs/pull/3197</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>