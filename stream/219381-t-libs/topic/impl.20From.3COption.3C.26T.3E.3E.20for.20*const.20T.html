<html>
<head><meta charset="utf-8"><title>impl From&lt;Option&lt;&amp;T&gt;&gt; for *const T · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html">impl From&lt;Option&lt;&amp;T&gt;&gt; for *const T</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270651914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270651914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270651914">(Feb 04 2022 at 00:56)</a>:</h4>
<p>I wasn't able to find a built-in way to simply and safely convert from <code>Option&lt;&amp;T&gt;</code> to <code>*const T</code> (where <code>None</code> becomes null). This is functionally a transmute, but it surprised me that there's no <code>Option&lt;&amp;T&gt;::as_ptr</code> or other safe one-liner, and that I either needed to transmute or invoke <code>core::ptr::null</code> manually.</p>



<a name="270652070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270652070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270652070">(Feb 04 2022 at 00:58)</a>:</h4>
<p>Would it make sense for the stdlib to <code>impl&lt;T: ?Sized&gt; From&lt;Option&lt;&amp;T&gt;&gt; for *const T</code> and <code>impl&lt;T: ?Sized&gt; From&lt;Option&lt;&amp;mut T&gt;&gt; for *mut T</code>? There could also be associated <code>as_ptr</code> and <code>as_mut_ptr</code> for <code>Option&lt;&amp;T&gt;</code> and <code>Option&lt;&amp;mut T&gt;</code></p>



<a name="270652273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270652273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270652273">(Feb 04 2022 at 01:00)</a>:</h4>
<p>Having a <code>From</code> implementation sounds reasonable. Not sure how I feel about a method.</p>



<a name="270652521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270652521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270652521">(Feb 04 2022 at 01:03)</a>:</h4>
<p>True, it would be confusing especially considering <code>as_ref</code> converts from <code>&amp;Option&lt;T&gt;</code> to <code>Option&lt;&amp;T&gt;</code> and <code>as_ptr</code> would do something entirely different.</p>



<a name="270652689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270652689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270652689">(Feb 04 2022 at 01:05)</a>:</h4>
<p>Is this a small enough thing that I could just send a PR with the code changes?</p>



<a name="270652697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270652697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270652697">(Feb 04 2022 at 01:05)</a>:</h4>
<p>(the <code>From</code> impls)</p>



<a name="270653366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653366">(Feb 04 2022 at 01:14)</a>:</h4>
<p><code>T: ?Sized</code> is the trick though -- what metadata do you use for that pointer?</p>



<a name="270653394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653394">(Feb 04 2022 at 01:14)</a>:</h4>
<p>isn't this <code>core::ptr::as_ref</code>?</p>



<a name="270653419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653419">(Feb 04 2022 at 01:15)</a>:</h4>
<p>I don't think you can just use <code>transmute</code>, because that metadata is probably in the uninit padding of <code>None</code></p>



<a name="270653444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653444">(Feb 04 2022 at 01:15)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> this is the other direction</p>



<a name="270653665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653665">(Feb 04 2022 at 01:18)</a>:</h4>
<p>Isn't the metadata irrelevant here? <code>Option&lt;&amp;T&gt;</code> has the same representation as <code>*const T</code>, even for <code>T: ?Sized</code>. <del>https://doc.rust-lang.org/std/option/index.html#representation</del> less confident about my source</p>



<a name="270653709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653709">(Feb 04 2022 at 01:18)</a>:</h4>
<p>oh interesting. This is the obvious implementation and it fails at <code>std::ptr::null</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">to_ptr</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span>: <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270653726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653726">(Feb 04 2022 at 01:19)</a>:</h4>
<p>are there no null wide pointers?</p>



<a name="270653855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653855">(Feb 04 2022 at 01:20)</a>:</h4>
<p>There are null wide pointers, the data component has no restriction. But <code>null()</code> doesn't know how to propagate possible metadata from the <code>&amp;T</code></p>



<a name="270653898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653898">(Feb 04 2022 at 01:21)</a>:</h4>
<p>Though if it is <code>None</code>, there's no metadata to read. Whatever's there should be fine to put in though?</p>



<a name="270653934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270653934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270653934">(Feb 04 2022 at 01:21)</a>:</h4>
<p>Assuming wide raw pointers truly have no restriction on their bits, which still seems to be contentious</p>



<a name="270654029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654029">(Feb 04 2022 at 01:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="400643">Alyssa Haroldsen [she]</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T/near/270653855">said</a>:</p>
<blockquote>
<p>There are null wide pointers, the data component has no restriction.</p>
</blockquote>
<p>Is it possible to create one in safe code?</p>



<a name="270654103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654103">(Feb 04 2022 at 01:23)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> <code>core::ptr::slice_from_raw_parts(core::ptr::null(), 0)</code></p>



<a name="270654246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654246">(Feb 04 2022 at 01:24)</a>:</h4>
<p>that's for a slice though, not a dyn pointer. I can believe it for slices but dyn metadata can't just be 0 (or at least it is not decided yet whether this is alright)</p>



<a name="270654273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654273">(Feb 04 2022 at 01:25)</a>:</h4>
<p>A slice is a DST?</p>



<a name="270654292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654292">(Feb 04 2022 at 01:25)</a>:</h4>
<p>sorry, should clarify</p>



<a name="270654366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654366">(Feb 04 2022 at 01:26)</a>:</h4>
<p>Yeah dyn pointer is where it's weird</p>



<a name="270654393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654393">(Feb 04 2022 at 01:27)</a>:</h4>
<p>I need to get back to the raw pointer metadata API Github thread to argue that restrictions on the metadata component of raw pointers are a bad idea and we shouldn't do that, as it violates the entire spirit of raw pointers</p>



<a name="270654606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654606">(Feb 04 2022 at 01:29)</a>:</h4>
<p>I think it makes sense to require valid metadata, but it is also reasonable to allow <code>(0, 0)</code> specifically as a valid <code>*const dyn Trait</code></p>



<a name="270654653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654653">(Feb 04 2022 at 01:29)</a>:</h4>
<p>I'm not sure why it makes sense to require anything of raw pointers</p>



<a name="270654656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654656">(Feb 04 2022 at 01:30)</a>:</h4>
<p>That's why they're raw</p>



<a name="270654743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654743">(Feb 04 2022 at 01:31)</a>:</h4>
<p>there is no language level access to the metadata, no way to create them outside the approved mechanisms that always produce valid metadata</p>



<a name="270654767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654767">(Feb 04 2022 at 01:31)</a>:</h4>
<p>if there was a way to hand roll vtables I might agree with you but it is explicitly off limits in current rust</p>



<a name="270654828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654828">(Feb 04 2022 at 01:32)</a>:</h4>
<p>No language level access _yet_, it's nightly-only because this is still an argument</p>



<a name="270654849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654849">(Feb 04 2022 at 01:32)</a>:</h4>
<p>no, AFAIK there is no nightly access either</p>



<a name="270654855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654855">(Feb 04 2022 at 01:32)</a>:</h4>
<p>Plus I can always transmute a raw pointer</p>



<a name="270654861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654861">(Feb 04 2022 at 01:32)</a>:</h4>
<p><code>Pointee::Metadata</code> still treats the metadata opaquely</p>



<a name="270654869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654869">(Feb 04 2022 at 01:32)</a>:</h4>
<p>yeah but that doesn't make it non-UB</p>



<a name="270654941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270654941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270654941">(Feb 04 2022 at 01:33)</a>:</h4>
<p>My argument is that raw pointers specifically exist to have no invariants, and have those invariants asserted through <code>unsafe</code>. Accessing dyn metadata of a wide raw pointer should be unsafe, just like dereferencing it would be.</p>



<a name="270655019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655019">(Feb 04 2022 at 01:34)</a>:</h4>
<p>But that's only because dyn metadata has an invariant - it has to be a valid vtable. There is no such requirement on the metadata of slices, since all possible bits are valid</p>



<a name="270655044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655044">(Feb 04 2022 at 01:34)</a>:</h4>
<p>except <code>uninit</code></p>



<a name="270655061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655061">(Feb 04 2022 at 01:35)</a>:</h4>
<p>Yes, except that :)</p>



<a name="270655078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655078">(Feb 04 2022 at 01:35)</a>:</h4>
<p>All possible initialized bits are valid</p>



<a name="270655168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655168">(Feb 04 2022 at 01:36)</a>:</h4>
<p>so <code>std::ptr::null_slice()</code> could be a thing, but general <code>null</code> seems open</p>



<a name="270655277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655277">(Feb 04 2022 at 01:37)</a>:</h4>
<p>Anyways, I'm fine deferring <code>T: ?Sized</code> for this impl until the metadata problem is hashed out. Would it be small enough to just upload a PR? It would be my first Rust code contribution <span aria-label="happy" class="emoji emoji-1f600" role="img" title="happy">:happy:</span></p>



<a name="270655351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655351">(Feb 04 2022 at 01:37)</a>:</h4>
<p>Yes, you can just open a PR :)</p>



<a name="270655377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270655377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270655377">(Feb 04 2022 at 01:37)</a>:</h4>
<p>There's not a problem adding <code>?Sized</code> to a trait impl after the fact, right?</p>



<a name="270656918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270656918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270656918">(Feb 04 2022 at 01:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="400643">Alyssa Haroldsen [she]</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T/near/270653934">said</a>:</p>
<blockquote>
<p>Assuming wide raw pointers truly have no restriction on their bits, which still seems to be contentious</p>
</blockquote>
<p><del>I believe you can safely get the size of a wide pointer.</del> Just checked. I stand corrected for trait objects</p>



<a name="270657056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270657056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270657056">(Feb 04 2022 at 01:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T/near/270656918">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="400643">Alyssa Haroldsen [she]</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T/near/270653934">said</a>:</p>
<blockquote>
<p>Assuming wide raw pointers truly have no restriction on their bits, which still seems to be contentious</p>
</blockquote>
<p>I believe you can safely get the size of a wide pointer.</p>
</blockquote>
<p>Meaning, the length component of a <code>*const [T]</code>? Yes.</p>



<a name="270657827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270657827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270657827">(Feb 04 2022 at 02:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="400643">Alyssa Haroldsen [she]</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T/near/270655377">said</a>:</p>
<blockquote>
<p>There's not a problem adding <code>?Sized</code> to a trait impl after the fact, right?</p>
</blockquote>
<p>that can be a problem, if coherence allowed downstream to write specific types in place of your <code>T</code>, but they can't here because neither <code>Option</code> nor <code>*const _</code> are fundamental</p>



<a name="270658522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270658522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270658522">(Feb 04 2022 at 02:10)</a>:</h4>
<p>So do I mark the impl as unstable first then?</p>



<a name="270658552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270658552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270658552">(Feb 04 2022 at 02:11)</a>:</h4>
<p>Aren't trait impls usually insta-stable?</p>



<a name="270658569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270658569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270658569">(Feb 04 2022 at 02:11)</a>:</h4>
<p>What to I put it as stable since?</p>



<a name="270658671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270658671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270658671">(Feb 04 2022 at 02:12)</a>:</h4>
<p>and do I create an always-stable feature?</p>



<a name="270659051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270659051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270659051">(Feb 04 2022 at 02:17)</a>:</h4>
<p>I see the versions listed on forge, I assume I should put 1.60 since that's the current nightly. I also noticed this'll need FCP before merging, which is fine. Though I'm still not sure what to put for <code>feature = </code></p>



<a name="270659161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270659161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270659161">(Feb 04 2022 at 02:18)</a>:</h4>
<p>make up a unique feature name, and mark stable on the current nightly version</p>



<a name="270659197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270659197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270659197">(Feb 04 2022 at 02:19)</a>:</h4>
<p>something like <code>pointer_from_option_ref</code></p>



<a name="270659318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3C%26T%3E%3E%20for%20%2Aconst%20T/near/270659318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alyssa Haroldsen [she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3C.26T.3E.3E.20for.20*const.20T.html#270659318">(Feb 04 2022 at 02:20)</a>:</h4>
<p>Got it. I'll also be marking it <code>const</code> and adding <code>#[rustc_const_unstable(feature = "const_convert", issue = "88674")]</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>