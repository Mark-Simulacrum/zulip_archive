<html>
<head><meta charset="utf-8"><title>core::ptr::eq documentation for trait objects · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/core.3A.3Aptr.3A.3Aeq.20documentation.20for.20trait.20objects.html">core::ptr::eq documentation for trait objects</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273027035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/core%3A%3Aptr%3A%3Aeq%20documentation%20for%20trait%20objects/near/273027035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zachary Sample <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/core.3A.3Aptr.3A.3Aeq.20documentation.20for.20trait.20objects.html#273027035">(Feb 23 2022 at 23:32)</a>:</h4>
<p>(moved from t-lang/doc)</p>
<p><code>std::ptr::eq</code> claims that it compares <code>*const dyn Trait</code> by address and implementation,</p>
<blockquote>
<p>Compares raw pointers for equality.<br>
...<br>
Traits are also compared by their implementation.</p>
</blockquote>
<p>but this is not always correct (it may have false negatives (I don't know if it can have false positives; it was mentioned in the t-lang/doc topic that it might))</p>
<p>Since vtables are not guaranteed to be unique, two <code>*const dyn Trait</code> that point to the same address, with the same type, may compare unequal if the vtable pointers are different (despite them containing the same functions (they may contain different compilations of the same function))</p>
<p>Example: <a href="https://rust.godbolt.org/z/dhM3v9nz7">https://rust.godbolt.org/z/dhM3v9nz7</a> (prints <code>false</code> despite <code>y</code> and <code>z</code> both being <code>&amp;dyn T</code> references to <code>x: i32</code>).</p>
<p>Should the the documentation for <code>std::ptr::eq</code> be changed? For example to something like </p>
<blockquote>
<p>Traits are also compared by their implementation <strong>on a best-effort basis (i.e. two pointers to different locations will never compare equal, but two pointers to the same location may or may not compare equal)</strong></p>
</blockquote>
<p>or </p>
<blockquote>
<p>Traits are also compared by their <del>implementation</del> <strong>vtable pointer (i.e. two pointers to the same location and type may not compare equal,</strong> <strong><em>(but no two pointers two different types or locations will compare equal (?))</em></strong> <strong>)</strong></p>
</blockquote>
<p>?</p>
<p>(I think this could also be resolved by ensuring that vtable pointers are unique per (type minus lifetimes, trait) pair, but that would be a much bigger change than just documentation.)</p>



<a name="274255022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/core%3A%3Aptr%3A%3Aeq%20documentation%20for%20trait%20objects/near/274255022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/core.3A.3Aptr.3A.3Aeq.20documentation.20for.20trait.20objects.html#274255022">(Mar 05 2022 at 17:26)</a>:</h4>
<p>important comment by <span class="user-mention" data-user-id="352985">@tm</span> </p>
<blockquote>
<p>AFAIK, the current code generation allows to for comparison to have both false positives and false negatives, since methods can be merged together, and subsequently complete vtable for different types could be merged as well.</p>
</blockquote>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>