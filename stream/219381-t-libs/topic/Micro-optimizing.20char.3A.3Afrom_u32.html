<html>
<head><meta charset="utf-8"><title>Micro-optimizing char::from_u32 · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html">Micro-optimizing char::from_u32</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272146171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272146171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272146171">(Feb 16 2022 at 17:13)</a>:</h4>
<p><code>char::from_u32</code> currently checks <code>(i &gt; char::MAX) || (i &gt;= 0xD800 &amp;&amp; i &lt;= 0xDFFF)</code>. This could be done with fewer instructions as <code>(i ^ 0xffff2000) + 2048 &lt;= 0xffef07ff</code>. Does this seem worthwhile? Is <code>char::from_u32</code> an important building block somewhere?</p>



<a name="272146565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272146565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272146565">(Feb 16 2022 at 17:15)</a>:</h4>
<p>I think it could be worthwhile to optimize it a bit.</p>



<a name="272148129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272148129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272148129">(Feb 16 2022 at 17:25)</a>:</h4>
<p>we'll need heavy comments to explain what's going on there</p>



<a name="272148213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272148213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272148213">(Feb 16 2022 at 17:25)</a>:</h4>
<p>why put the <code>+ 2048</code> on the left instead of subtracting it from the right value?</p>



<a name="272148934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272148934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272148934">(Feb 16 2022 at 17:30)</a>:</h4>
<p>I think it's definitely worth optimizing.</p>



<a name="272149788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272149788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272149788">(Feb 16 2022 at 17:35)</a>:</h4>
<p>Well it should be a wrapping_add so the <code>+ 2048</code> can't be moved to the other side. And unfortunately it's kinda hard to explain, I don't have any short explanation, maybe someone else has :-)</p>



<a name="272150047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272150047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272150047">(Feb 16 2022 at 17:37)</a>:</h4>
<p>"hard to explain" is all the more reason that it <em>needs</em> to be explained :)</p>



<a name="272150876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272150876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272150876">(Feb 16 2022 at 17:42)</a>:</h4>
<p>I don't think the explanation needs to be short, fwiw</p>



<a name="272153820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272153820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272153820">(Feb 16 2022 at 18:01)</a>:</h4>
<p>We have some other many-line comments explaining bit twiddling around string and int operations</p>



<a name="272154076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272154076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272154076">(Feb 16 2022 at 18:02)</a>:</h4>
<p>FWIW I think it would be easier to understand if written as <code>(i ^ !0xDFFF).wrapping_add(0x800) &lt;= !0x10F800</code></p>



<a name="272154367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272154367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272154367">(Feb 16 2022 at 18:04)</a>:</h4>
<p>the right hand constant <code>!0x10F800</code> can also be written as <code>u32::MAX - char::MAX as u32</code></p>



<a name="272154488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272154488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272154488">(Feb 16 2022 at 18:04)</a>:</h4>
<p>oh, that definitely helps me! it's still not <em>obvious</em>, but at least the connection to the surrogate range and MAX is there.</p>



<a name="272155552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272155552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272155552">(Feb 16 2022 at 18:11)</a>:</h4>
<p>Is this a generalizable pattern?  Because part of me says that this transformation should be something that LLVM does, like how (IIRC) it knows about things like <code>a &lt; x &lt; b</code> into <code>(x - a) ULT (b-a)</code>...</p>



<a name="272155998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272155998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272155998">(Feb 16 2022 at 18:13)</a>:</h4>
<p>I'm still working through it, but there is a bit more to it than just that. That explains the <code>value + const &lt; const</code> part but not the XOR, which is doing something like reversing the entire range in chunks</p>



<a name="272157418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272157418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272157418">(Feb 16 2022 at 18:24)</a>:</h4>
<p>basically there are two ranges of interest, <code>0xD800..=0xDFFF</code> and <code>0x110000..</code>. The XOR inverts everything but the significant bits of that first range, placing it at the top, while the second range ends up at the bottom. Then the wrapping add puts us into one contiguous range, ready for a single comparison.</p>



<a name="272158271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272158271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272158271">(Feb 16 2022 at 18:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32/near/272154367">said</a>:</p>
<blockquote>
<p>the right hand constant <code>!0x10F800</code> can also be written as <code>u32::MAX - char::MAX as u32</code></p>
</blockquote>
<p>it's also <code>+ 0x800</code> to include the surrogate range</p>



<a name="272159419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272159419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272159419">(Feb 16 2022 at 18:39)</a>:</h4>
<p>It's also possible to do without the inversion of the whole range: <code>(i ^ 0xDFFF).wrapping_sub(0x800) &gt;= 0x10F800</code> generates approximately equivalent machine code (same number and strength of instructions) and is IMO a little easier to think about</p>



<a name="272159980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272159980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272159980">(Feb 16 2022 at 18:44)</a>:</h4>
<p>you can also use <code>0xD800</code> instead of <code>0xDFFF</code> in the XOR. <code>(i ^ 0xD800).wrapping_sub(0x800) &gt; 0x10FFFF - 0x800</code> is the most perspicuous version I can find</p>



<a name="272161780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272161780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272161780">(Feb 16 2022 at 18:59)</a>:</h4>
<p>the wrapping sub looks like this would be more readable in i32</p>



<a name="272161824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272161824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272161824">(Feb 16 2022 at 18:59)</a>:</h4>
<p>no, it's an unsigned less than</p>



<a name="272161976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272161976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272161976">(Feb 16 2022 at 19:00)</a>:</h4>
<p>if you tried to do the same trick on <code>i32</code> you would still need <code>wrapping_sub</code>, and <code>i32::MAX</code> would get involved as well</p>



<a name="272162338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272162338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272162338">(Feb 16 2022 at 19:02)</a>:</h4>
<p>Here's a shot at an explainer:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">is_bad_char</span><span class="p">(</span><span class="n">i</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This is an optimized version of the check</span>
<span class="w">    </span><span class="c1">// i &gt;= 0x110000 || (i &gt;= 0xD800 &amp;&amp; i &lt; 0xE000).</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// The XOR with 0xD800 permutes the ranges such that 0xD800..0xE000 is</span>
<span class="w">    </span><span class="c1">// mapped to 0x0000..0x0800, while keeping all the high bits outside 0xFFFF the same.</span>
<span class="w">    </span><span class="c1">// In particular, numbers &gt;= 0x110000 stay in this range.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// Subtracting 0x800 causes 0x0000..0x0800 to wrap, meaning that a single</span>
<span class="w">    </span><span class="c1">// unsigned comparison against 0x110000 - 0x800 will detect both the wrapped</span>
<span class="w">    </span><span class="c1">// surrogate range as well as the numbers originally larger than 0x110000.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0xD800</span><span class="p">).</span><span class="n">wrapping_sub</span><span class="p">(</span><span class="mh">0x800</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x110000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x800</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272162580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272162580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272162580">(Feb 16 2022 at 19:04)</a>:</h4>
<p>I decided to use only multiples of 0x800 in the description, instead of using numbers one less than a multiple of 0x800 in some places. This makes the bit tricks a little easier to follow, but weakens the connection to <code>char::MAX</code> and the surrogate range (depending on how it is presented)</p>



<a name="272162903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272162903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272162903">(Feb 16 2022 at 19:06)</a>:</h4>
<p>"swapped with" might be easier to understand than "mapped to"</p>



<a name="272163203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272163203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272163203">(Feb 16 2022 at 19:09)</a>:</h4>
<p>That kind of sounds like nothing else is being swapped though, when this is really swapping lots of things</p>



<a name="272163272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272163272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272163272">(Feb 16 2022 at 19:09)</a>:</h4>
<p>It might be my math brain, but I didn't intend to claim it was a swap, simply a permutation that puts <code>0xD800..0xE000</code> -&gt; <code>0x0000..0x0800</code> and puts <code>0x0000..0x0800</code> somewhere else</p>



<a name="272163378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272163378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272163378">(Feb 16 2022 at 19:10)</a>:</h4>
<p>and it's not really relevant where the original 0-based range ends up</p>



<a name="272166133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272166133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272166133">(Feb 16 2022 at 19:29)</a>:</h4>
<p>It is relevant that the original 0-based range doesn't end up at &gt;= 0x110000.</p>



<a name="272166292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272166292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272166292">(Feb 16 2022 at 19:30)</a>:</h4>
<p>in some cases, it's more optimal to use the original code: <code>(i &gt; MAX as u32) || (i &gt;= 0xD800 &amp;&amp; i &lt;= 0xDFFF)</code> because it can be executed in 2 cycles if a cpu has a ternary logic operator (as we're working on adding to OpenPower as part of Libre-SOC, x86 also has that as the <a href="https://www.felixcloutier.com/x86/vpternlogd:vpternlogq"><code>vpternlogd</code> instruction</a>), allowing it to do <code>a | (b &amp; c)</code> in one operation:<br>
all 3 comparison instructions are run in parallel in the first clock cycle, then the results are all combined with the ternary operator in the second clock cycle.</p>



<a name="272167466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272167466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272167466">(Feb 16 2022 at 19:38)</a>:</h4>
<p>libstd is probably not going to be compiled with <code>-Ctarget-feature=+avx512f,+avx512vl</code> most of the time, so i think this optimization is still worth doing, since it benefits most users. I also think that the case where this operation will be vectorized is pretty small</p>



<a name="272167474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272167474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272167474">(Feb 16 2022 at 19:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437892">Falk Hüffner</span> <a href="#narrow/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32/near/272146171">said</a>:</p>
<blockquote>
<p>Is <code>char::from_u32</code> an important building block somewhere?</p>
</blockquote>
<p>I think it's probably not all that common, since things tend to deal in UTF-8 directly.  For example, <code>from_utf8</code> just checks for valid UTF-8 sequences instead of decoding to <code>u32</code> and checking that: <a href="https://github.com/rust-lang/rust/blob/cc946fcd326f7d85d4af096efdc73538622568e9/library/core/src/str/validations.rs#L171-L182">https://github.com/rust-lang/rust/blob/cc946fcd326f7d85d4af096efdc73538622568e9/library/core/src/str/validations.rs#L171-L182</a></p>



<a name="272168541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272168541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272168541">(Feb 16 2022 at 19:45)</a>:</h4>
<p>fwiw, this would also affect <code>TryFrom&lt;u32&gt; for char</code>, which is more annoying to find actual uses</p>



<a name="272173923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272173923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272173923">(Feb 16 2022 at 20:29)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> this looks really nice, would you be interested in sending a pull request? (The code is in <code>library/core/src/char/convert.rs</code> <code>char_try_from_u32</code>)</p>



<a name="272174137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272174137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272174137">(Feb 16 2022 at 20:31)</a>:</h4>
<p>About adding this to llvm: It seems like the right thing to do but from what I understand, it's quite hard to introduce such optimizations since we have to define this as the canonical form of this kind of comparison, and then various other optimizations have to deal with comparisons possibly being in this form and unwrap it again to see if other transformations apply.</p>



<a name="272340817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272340817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272340817">(Feb 17 2022 at 23:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32/near/272167466">said</a>:</p>
<blockquote>
<p>libstd is probably not going to be compiled with <code>-Ctarget-feature=+avx512f,+avx512vl</code> most of the time, so i think this optimization is still worth doing, since it benefits most users. I also think that the case where this operation will be vectorized is pretty small</p>
</blockquote>
<p>It does suggest this sort of optimization is better suited for LLVM though, which has the knowledge necessary to pick the best implementation.</p>



<a name="272341042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272341042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272341042">(Feb 17 2022 at 23:50)</a>:</h4>
<p>I mean, even if the &amp; and | are a single operation, it's still <code>[xor, sub, compare]</code> vs <code>[3 compares, ternary]</code> (which can perhaps be simplified a bit further). but it's not clear to me that this is actually a case where it wouldn't be faster with the change everywhere.</p>



<a name="272343782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272343782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272343782">(Feb 18 2022 at 00:23)</a>:</h4>
<p>The three comparisons could all be executed in a single instruction with SIMD or executed on different execution units (how many of them there are is yet another that's only known to codegen backend) for execution and retire in the same cycle. xor sub compare approach imposes a linear register dependency requiring each prior instruction to retire before the next one can be executed. OTOH there's something to be said about xor sub compare being straightforward to autovectorize when dealing with data in an array. And the potential perf benefit of the ternary cmp will be very minor (fractional parts of a cycle on modern designs) suggests there's little reason to not make this change in libstd.</p>



<a name="272358841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272358841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272358841">(Feb 18 2022 at 04:16)</a>:</h4>
<p>Yeah, I suppose that might come into play. I feel like in practice this sort of thing tends to come out being beneficial most of the time (those execution units often have other work to do, i suppose). It's also a lot better in debug builds: <a href="https://godbolt.org/z/dTbEo5vW5">https://godbolt.org/z/dTbEo5vW5</a> (I guess this doesnt really matter for std, though).</p>



<a name="272359538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Micro-optimizing%20char%3A%3Afrom_u32/near/272359538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32.html#272359538">(Feb 18 2022 at 04:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437892">Falk Hüffner</span> <a href="#narrow/stream/219381-t-libs/topic/Micro-optimizing.20char.3A.3Afrom_u32/near/272173923">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> this looks really nice, would you be interested in sending a pull request? (The code is in <code>library/core/src/char/convert.rs</code> <code>char_try_from_u32</code>)</p>
</blockquote>
<p>This has been submitted as <a href="https://github.com/rust-lang/rust/issues/94112">#94112</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>