<html>
<head><meta charset="utf-8"><title>Better and safer ergonomics for T::with_capacity or raw a... · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html">Better and safer ergonomics for T::with_capacity or raw a...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275230713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275230713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Ronacher <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275230713">(Mar 14 2022 at 12:52)</a>:</h4>
<p>We had quite a few instances of unsafe use of Vec::with_capacity over the last few years where untrusted user input is passed to it (same with other types). The idea came up if there could be a clippy lint for it, but it’s tricky with the API today. Which got me thinking if there could be an intrinsic or helper to mark a usize as “safe” for capacity reservations.</p>



<a name="275230824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275230824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Ronacher <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275230824">(Mar 14 2022 at 12:53)</a>:</h4>
<p>Eg <code>Vec::with_capacity(trusted_capacity(x))</code></p>



<a name="275230946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275230946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Ronacher <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275230946">(Mar 14 2022 at 12:54)</a>:</h4>
<p>That way an untrusted capacity could be linted against and a change to <code>x.min(MAX_SENSIBLE_CAPACITY)</code> could be proposed</p>



<a name="275236657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275236657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275236657">(Mar 14 2022 at 13:42)</a>:</h4>
<p>What do you mean by "unsafe use"? <code>Vec::with_capacity</code> isn't an <code>unsafe fn</code></p>



<a name="275238176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275238176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275238176">(Mar 14 2022 at 13:53)</a>:</h4>
<p>a fallable version, <code>try_with_capacity</code>, would perhaps be appropriate, but users can make that themselves if they want.</p>



<a name="275238865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275238865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275238865">(Mar 14 2022 at 13:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E/near/275236657">said</a>:</p>
<blockquote>
<p>What do you mean by "unsafe use"? <code>Vec::with_capacity</code> isn't an <code>unsafe fn</code></p>
</blockquote>
<p>My interpretation was if you blindly trusted a <code>Content-Length</code> header for instance and ended up trying to allocate many gigabytes when handling a HTTP request. It's not _unsafe_ but it can bring down your application (and can be used in an attack to bring down an entire service)</p>



<a name="275239153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275239153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275239153">(Mar 14 2022 at 14:00)</a>:</h4>
<p>And the solution presented to find a way to lint these allocation APIs in order to not allocate such large amounts unless you could somehow prove that you've checked the number isn't ridiculously large</p>



<a name="275245119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275245119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275245119">(Mar 14 2022 at 14:42)</a>:</h4>
<p>Ah, I think I too misread Armin's text at first.</p>
<p>@5225225 isn't in here, but I've done a _bit_ of fuzzing with them and I can confirm that passing untrusted data to <code>Vec::with_capacity</code> is a huge source of panics/DoS issues in the Rust ecosystem generally.</p>



<a name="275245571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275245571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275245571">(Mar 14 2022 at 14:45)</a>:</h4>
<p>The <code>trust-dns</code> crates do something interesting which may be related <a href="https://github.com/bluejekyll/trust-dns/blob/dc5c414ec0553af8a65441d0c747fb8e9f8e174e/crates/proto/src/serialize/binary/restrict.rs">https://github.com/bluejekyll/trust-dns/blob/dc5c414ec0553af8a65441d0c747fb8e9f8e174e/crates/proto/src/serialize/binary/restrict.rs</a></p>
<p>Usage looks like this: <a href="https://github.com/bluejekyll/trust-dns/blob/dc5c414ec0553af8a65441d0c747fb8e9f8e174e/crates/proto/src/rr/domain/name.rs#L1155">https://github.com/bluejekyll/trust-dns/blob/dc5c414ec0553af8a65441d0c747fb8e9f8e174e/crates/proto/src/rr/domain/name.rs#L1155</a></p>



<a name="275249601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275249601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Ronacher <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275249601">(Mar 14 2022 at 15:11)</a>:</h4>
<p>Yep. Unsafe in the sense of causing large or failing allocations because of accidentally trusting user input. Common issue are things like parsers or deserializers</p>



<a name="275298570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275298570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275298570">(Mar 14 2022 at 21:09)</a>:</h4>
<p>I think it's important not to call "allocating too much memory" as "unsafe", since obviously safe code can trivially do it.</p>
<p>Maybe "tainted", to borrow a term from perl? <a href="https://stackoverflow.com/questions/2228457/is-perls-taint-mode-useful">https://stackoverflow.com/questions/2228457/is-perls-taint-mode-useful</a></p>



<a name="275299105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275299105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275299105">(Mar 14 2022 at 21:14)</a>:</h4>
<p>maybe just "vulnerable", since rust projects do issue CVEs for DoS attacks</p>



<a name="275310622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Better%20and%20safer%20ergonomics%20for%20T%3A%3Awith_capacity%20or%20raw%20a.../near/275310622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Ronacher <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Better.20and.20safer.20ergonomics.20for.20T.3A.3Awith_capacity.20or.20raw.20a.2E.2E.2E.html#275310622">(Mar 14 2022 at 23:13)</a>:</h4>
<p>I regret the use of the word "unsafe" :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>