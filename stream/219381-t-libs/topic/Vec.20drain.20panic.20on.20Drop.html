<html>
<head><meta charset="utf-8"><title>Vec drain panic on Drop · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html">Vec drain panic on Drop</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251751476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251751476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251751476">(Sep 02 2021 at 17:18)</a>:</h4>
<p>I am implementing a <code>Vec</code> variant, and I am using the <code>Vec</code> test cases to help verify my implementation. While doing so I found an inconsistency in the stdlib that I find very frustrating, and which is arguably incorrect.</p>
<p><code>dedup</code>, <code>retain</code> and <code>drain_filter</code> are all consistent in that, should a panic occur on <code>Drop</code>, they stop their operation and return. You can see this here: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=24015265da2a3b5d439cfad25d20930a">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=24015265da2a3b5d439cfad25d20930a</a></p>
<p><code>drain</code> (and <code>filter</code> since it uses <code>drain</code> internally) on the other hand, does something quite worrying, in my opinion. When it encounters a panic in a <code>Drop</code> impl, <em>it explicitly continues on, dropping more elements</em>. This means that should another <code>Drop</code> panic, we get a hard abort. The problematic lines are 111-113: <a href="https://doc.rust-lang.org/stable/src/alloc/vec/drain.rs.html#111">https://doc.rust-lang.org/stable/src/alloc/vec/drain.rs.html#111</a><br>
You can see the abort happening here: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=9fd99600d3b2c7ef418a9322faad9f4f">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=9fd99600d3b2c7ef418a9322faad9f4f</a></p>
<p>Note that none of the above is actually specified in the docs, which is another possible shortcoming.</p>



<a name="251753545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251753545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251753545">(Sep 02 2021 at 17:31)</a>:</h4>
<p>looks like that behaviour was introduced in <a href="https://github.com/rust-lang/rust/pull/67290">https://github.com/rust-lang/rust/pull/67290</a></p>



<a name="251753573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251753573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251753573">(Sep 02 2021 at 17:31)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="211727">@Jonas Schievink  [he/him]</span></p>



<a name="251753818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251753818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251753818">(Sep 02 2021 at 17:32)</a>:</h4>
<p>the alternative is to leak the items</p>



<a name="251753956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251753956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251753956">(Sep 02 2021 at 17:33)</a>:</h4>
<p>dedup and retain should defer the drop of the remaining items to the drop of the original <code>Vec</code> if I'm not mistaken</p>



<a name="251754120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251754120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251754120">(Sep 02 2021 at 17:34)</a>:</h4>
<p>yeah, aborting if more than one drop panics doesn't seem unreasonable.</p>



<a name="251754909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251754909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251754909">(Sep 02 2021 at 17:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251753818">said</a>:</p>
<blockquote>
<p>the alternative is to leak the items</p>
</blockquote>
<p>That is not true, the <code>drain</code> could simply be stopped midway through similar to how <code>.retain(|_| false)</code> stops on panic. No items are leaked - they stay in the <code>Vec</code>, as the above playground demonstrates.</p>



<a name="251756234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251756234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251756234">(Sep 02 2021 at 17:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251753956">said</a>:</p>
<blockquote>
<p>dedup and retain should defer the drop of the remaining items to the drop of the original <code>Vec</code> if I'm not mistaken</p>
</blockquote>
<p>I don't see why <code>drain</code> would be any different.</p>



<a name="251759595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251759595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251759595">(Sep 02 2021 at 18:08)</a>:</h4>
<p>the point is that regardless of what it does exactly, either it has to leak the remaining items or run their destructors (either immediately or when the <code>Vec</code> itself is dropped)</p>



<a name="251759776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251759776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251759776">(Sep 02 2021 at 18:09)</a>:</h4>
<p>since drain normally drops the drained items when the <code>Drain</code> is dropped, it makes sense to keep that behavior in the presence of panics</p>



<a name="251759800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251759800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251759800">(Sep 02 2021 at 18:09)</a>:</h4>
<p>this is even documented <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.drain">https://doc.rust-lang.org/std/vec/struct.Vec.html#method.drain</a></p>



<a name="251760541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251760541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251760541">(Sep 02 2021 at 18:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251759595">said</a>:</p>
<blockquote>
<p>the point is that regardless of what it does exactly, either it has to leak the remaining items or run their destructors (either immediately or when the <code>Vec</code> itself is dropped)</p>
</blockquote>
<p>I really don't think this is true. <code>Drain</code> can be dropped without the <code>Vec</code> it references ever being dropped. It's completely unrelated, similar to how calling <code>retain</code> does not mean the <code>Vec</code> is being dropped anytime soon. Leaving the unprocessed items in the <code>Vec</code> is not leaking at all.</p>



<a name="251760953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251760953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251760953">(Sep 02 2021 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251759776">said</a>:</p>
<blockquote>
<p>since drain normally drops the drained items when the <code>Drain</code> is dropped, it makes sense to keep that behavior in the presence of panics</p>
</blockquote>
<p>And <code>retain(|_| false)</code> normally removes all elements, yet it does not keep that behavior in the presence of panics. Nor does <code>drain_filter</code>.</p>



<a name="251761604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251761604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251761604">(Sep 02 2021 at 18:19)</a>:</h4>
<p>Yes, not in the presence of <code>catch_unwind</code></p>



<a name="251762083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251762083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251762083">(Sep 02 2021 at 18:22)</a>:</h4>
<p><code>retain</code> and <code>drain_filter</code> also don't document what they do when dropped though</p>



<a name="251762258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251762258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251762258">(Sep 02 2021 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251762083">said</a>:</p>
<blockquote>
<p><code>retain</code> and <code>drain_filter</code> also don't document what they do when dropped though</p>
</blockquote>
<p>I think you might be confusing the drop of the <code>Drain</code> iterator with the drops of the elements contained within the <code>Vec</code> itself. <code>retain</code> doesn't return anything - it just directly operates on the <code>Vec</code>. <code>Drain</code> only specifies what it does when dropped because it is a lazy iterator that consumes itself on drop. For the purposes of this issue we can assume that <code>Drain</code> is always immediately dropped, so <code>v.drain(a..b);</code>.</p>



<a name="251762630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251762630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251762630">(Sep 02 2021 at 18:25)</a>:</h4>
<p>right</p>



<a name="251763087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763087">(Sep 02 2021 at 18:28)</a>:</h4>
<p>To give an analogy of how <em>strange</em> the behavior of <code>drain</code> is, it is as if <code>vec.extend(it)</code> would continue to consume iterator <code>it</code> and appending it to <code>vec</code> even after a call to <code>it.next()</code> caused a panic, instead of just stopping the extension and returning the <code>Vec</code> as it is right now.</p>



<a name="251763279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763279">(Sep 02 2021 at 18:29)</a>:</h4>
<p>continuing to drop elements after one drop panics matches what <code>drop_in_place</code> does for slices, and also how drops generally work though</p>



<a name="251763436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763436">(Sep 02 2021 at 18:30)</a>:</h4>
<p>not saying that this is the ideal behavior, but it is pretty pervasive throughout the language</p>



<a name="251763532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763532">(Sep 02 2021 at 18:31)</a>:</h4>
<p>But we aren't <code>Drop</code>ping the vector! We are draining (a portion of) the vector. The issue is obfuscated because, yes, we are in the <code>Drop</code> function of <code>Drain</code>, but that's just <em>when</em> drain performs the bulk of its operation, by necessity, not the logical operation we're performing.</p>



<a name="251763747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763747">(Sep 02 2021 at 18:32)</a>:</h4>
<p>It's essentially dropping a subslice of the vector</p>



<a name="251763773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763773">(Sep 02 2021 at 18:32)</a>:</h4>
<p>So the behaviour is correct IMO</p>



<a name="251763825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763825">(Sep 02 2021 at 18:32)</a>:</h4>
<p>I have a PR open for drain that updated the behavior to use drop_in_place which afaik does the right thing. <a href="https://github.com/rust-lang/rust/issues/85157">#85157</a></p>



<a name="251763949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251763949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251763949">(Sep 02 2021 at 18:33)</a>:</h4>
<p>that should match the current behavior, since the tests aren't failing</p>



<a name="251764512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251764512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251764512">(Sep 02 2021 at 18:37)</a>:</h4>
<p>I don't think the behavior is correct because it is a divergence from every other operation on <code>Vec</code> that has exception-safety behavior.</p>



<a name="251766016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251766016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251766016">(Sep 02 2021 at 18:47)</a>:</h4>
<p>Note that <code>Vec::drop</code> and <code>ptr::drop_in_place</code> continue dropping (at the risk of an abort) because they <em>have to</em>. Their hand is forced.</p>
<p>That is not true for <code>Drain</code> at all.</p>



<a name="251766435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251766435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251766435">(Sep 02 2021 at 18:49)</a>:</h4>
<p><code>Drain</code> is documented to remove all drained elements from the vector on drop</p>



<a name="251766642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251766642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251766642">(Sep 02 2021 at 18:51)</a>:</h4>
<p><code>retain(f)</code> is documented to remove all values for which <code>f</code> returns <code>false</code> when called, not sure why that matters. Neither specifies what happens on a drop panic.</p>



<a name="251767767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251767767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251767767">(Sep 02 2021 at 18:57)</a>:</h4>
<p>Well, a panic runs destructors</p>



<a name="251770403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251770403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251770403">(Sep 02 2021 at 19:13)</a>:</h4>
<p>We're <em>already</em> running the destructor of <code>Drain</code> when this occurs. <code>Drain</code> is just very strange in that it performs its operation when dropped.</p>



<a name="251770899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251770899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251770899">(Sep 02 2021 at 19:17)</a>:</h4>
<p>okay, but this still matches the behavior of <code>drop_in_place</code> and <code>Vec</code>'s own drop impl, and other containers</p>



<a name="251771464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251771464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251771464">(Sep 02 2021 at 19:20)</a>:</h4>
<p>I really don't agree, because in those functions the alternative would be leaking, whereas if <code>Drain</code> simply stops nothing is leaked.</p>



<a name="251772811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251772811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> orlp <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251772811">(Sep 02 2021 at 19:30)</a>:</h4>
<p>As another example: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=95b09ce8a094fc9fbf6d41b4033654ae">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=95b09ce8a094fc9fbf6d41b4033654ae</a><br>
If you replace the <code>v.retain(|_| false);</code> with <code>v.drain(..);</code> you get a hard abort instead of panic, because suddenly drops are happening in another order.</p>



<a name="251897996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251897996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251897996">(Sep 03 2021 at 15:28)</a>:</h4>
<p>My take is always that panics in drop are a huge antipattern that should never been allowed.</p>



<a name="251898435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251898435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251898435">(Sep 03 2021 at 15:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251897996">said</a>:</p>
<blockquote>
<p>My take is always that panics in drop are a huge antipattern that should never been allowed.</p>
</blockquote>
<p>Agree. But I guess it's too late to change.</p>



<a name="251898543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251898543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251898543">(Sep 03 2021 at 15:31)</a>:</h4>
<p>Maybe we could add an unstable flag that treats all drop as nounwind, but I am not sure if it's useful.</p>



<a name="251898569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251898569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251898569">(Sep 03 2021 at 15:31)</a>:</h4>
<p>It's going to be the new billion dollar mistake everybody references in their style guides and/or denies the relevant lint in all their codebases.</p>



<a name="251901055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251901055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251901055">(Sep 03 2021 at 15:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251898435">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop/near/251897996">said</a>:</p>
<blockquote>
<p>My take is always that panics in drop are a huge antipattern that should never been allowed.</p>
</blockquote>
<p>Agree. But I guess it's too late to change.</p>
</blockquote>
<p>I don't think it is. I filed <a href="https://github.com/rust-lang/lang-team/issues/97">https://github.com/rust-lang/lang-team/issues/97</a> in the hopes of eventually making a transition there. I don't currently have time to pursue it, but if someone were inclined to pick it up and champion it, I'd support it from the lang team side.</p>



<a name="251920227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251920227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251920227">(Sep 03 2021 at 18:03)</a>:</h4>
<p>Well, at the very least the edition mechanism is not all that suitable for phasing this out. Any type from rust2015-21 would still be able to unwind from drop and everything would need to account for this possibility.</p>



<a name="251920376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251920376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251920376">(Sep 03 2021 at 18:04)</a>:</h4>
<p>we might be able to entirely remove this support, arguing that its almost impossible to use correctly, potentially also introducing flags such as <code>--panic-in-drop=abort</code> or some such.</p>



<a name="251920564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251920564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251920564">(Sep 03 2021 at 18:05)</a>:</h4>
<p>I would really love to see that become an option, then a default as soon as possible.</p>



<a name="251920716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251920716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251920716">(Sep 03 2021 at 18:06)</a>:</h4>
<p>i think there are some libraries that use panic-on-drop on purpose. like an automatic-throw-at-the-end-of-the-scope thing. not sure how common or important that is</p>



<a name="251921246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251921246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251921246">(Sep 03 2021 at 18:10)</a>:</h4>
<p>Ah, I did indeed do similar things at least once before</p>



<a name="251921457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251921457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251921457">(Sep 03 2021 at 18:12)</a>:</h4>
<p>It's a way to mimic linear type with affine type system. Essentially <code>panic</code> upon drop, and <code>forget</code> when it's being used.</p>



<a name="251921491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251921491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251921491">(Sep 03 2021 at 18:12)</a>:</h4>
<p>in those cases it might be okay if it's an abort instead of an unwind</p>



<a name="251922088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251922088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251922088">(Sep 03 2021 at 18:17)</a>:</h4>
<p>I have a feeling that unwind is better in this case than abort, if these types are not used in collections but on stack</p>



<a name="251922137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251922137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251922137">(Sep 03 2021 at 18:17)</a>:</h4>
<p>But I don't have a solid justification</p>



<a name="251981689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Vec%20drain%20panic%20on%20Drop/near/251981689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Vec.20drain.20panic.20on.20Drop.html#251981689">(Sep 04 2021 at 07:45)</a>:</h4>
<p>Given that the users can always use abort unwinding scheme already it can't be a soundness related invariant at least.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>