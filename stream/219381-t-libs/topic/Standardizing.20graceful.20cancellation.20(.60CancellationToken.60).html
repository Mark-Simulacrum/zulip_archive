<html>
<head><meta charset="utf-8"><title>Standardizing graceful cancellation (`CancellationToken`) · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html">Standardizing graceful cancellation (`CancellationToken`)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267319942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267319942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267319942">(Jan 08 2022 at 22:34)</a>:</h4>
<p>Hi everyone. I'm wondering what the feelings about this group are around standarizing a minimum amount of tools for supporting graceful cancellation, like a <code>CancellationToken</code> or <code>StopToken</code>. While these can obviously be implemented as libraries, I feel like it would help to maximize interoperability between libraries if a minimal interface is standardized, so that any library can react to any kind of cancellation requests from something else.</p>
<p>I thought a lot about how to implement graceful cancellation within the efforts to support <a href="https://github.com/tokio-rs/tokio/issues/1879">structured concurrency</a> for tokio as well as later <a href="https://rust-lang.github.io/wg-async-foundations/vision/shiny_future/users_manual.html#scopes">within the async working group</a>.<br>
In the meantime I've came up with the conclusion that it should be possible to build a single slim interface which allows to handle graceful cancellation for both synchronous as well as asynchronous applications. I've written a bit earlier on about this in <a href="https://gist.github.com/Matthias247/354941ebcc4d2270d07ff0c6bf066c64">A case for CancellationTokens</a>.</p>
<p>Now half a year later I finally found some time to prototype this, and placed the results in the <a href="https://github.com/Matthias247/min_cancel_token">min-cancel-token</a> crate. I'm rather happy with this, and think it might be a good starting point for how a core/std CancellationToken could look like.<br>
Overall this repo contains 3 parts:</p>
<ol>
<li>The <code>CancellationToken</code> trait which allows libraries to detect cancellation and handle it. It's designed as a <code>dyn Trait</code> to maximize interoperability. It implements 2 functionst: Getting an error if cancellation is requested, and allowing to attach a callback that is invoked on cancellation. This mostly follows the C++ StopToken design. This is probably the minimal thing that can be standardized to improve interoperability in terms of handling graceful cancellation. In contrast to the C++ design, there is no implementation associated with it - which makes it <code>core</code> compatible. To allow implementing some parts of it with type erasure, a similar design as with <code>Waker</code>s  is used.</li>
<li>Helper functions to set and utilize a thread-local <code>CancellationToken</code>. If those would be standardized, there would be no need to pass the references around - but it would also work without. An alternative is certainly <span class="user-mention" data-user-id="116883">@tmandry</span> 's proposal about contexts, but I feel like that might be a bigger effort.</li>
<li>A concrete implementation of a <code>CancellationToken</code> and <code>CancellationTokenSource</code>. Could live in <code>std</code> - but probably also in an external library. Embedded systems or async runtimes can have their own implementations, which better fit their needs.</li>
</ol>
<p>Obviously the implementation is this repo is neither polished nor probably 100% correct - and I also don't care a lot on how things are named.<br>
For now I'm mostly interested to get feedback on whether there would be any support to further pursue this.</p>
<p>Any thoughts?</p>
<p>Also <span class="user-mention" data-user-id="133169">@matklad</span> and <span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span>  - since I know you also looked at this.</p>



<a name="267320172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267320172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267320172">(Jan 08 2022 at 22:40)</a>:</h4>
<p>I'm out of office until Monday, but can take a closer look next week. From a glance I feel like having some examples on the package would be helpful for me to get a better sense of how it's intended to be used.</p>
<p>Here's the latest iteration on <code>stop_token</code>: <a href="https://docs.rs/stop-token/latest/stop_token">https://docs.rs/stop-token/latest/stop_token</a>. It now also handles timeout based cancellation shorthands, though I'm not super sure on whether making it this generic ends up being worth it.</p>



<a name="267320342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267320342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267320342">(Jan 08 2022 at 22:44)</a>:</h4>
<p>The unit-tests contain some basic examples. Including on e.g. how to <code>.await</code> a stop signal. There could however definitely be more examples :)</p>



<a name="267321290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267321290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267321290">(Jan 08 2022 at 23:05)</a>:</h4>
<p>This reminds me: I still need to write the follow-up to my async cancellation post, specifically on stop-token. It's not been a priority for the WG, so I haven't made any time for it. If we think cancellation tokens  should be a priority for the async foundations working group, I could get around to it. But I am a bit worried about spreading ourselves a bit too thin again.</p>
<p>Something related I've been thinking about is the relationship between stop tokens and other form of deadlines / temporal actions. Posted a few of my notes here: <a href="https://github.com/async-rs/stop-token/issues/14">https://github.com/async-rs/stop-token/issues/14</a>, but I've got a hunch we should be considering cancellation/stop tokens as part of a broader design.</p>



<a name="267321396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267321396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267321396">(Jan 08 2022 at 23:07)</a>:</h4>
<p>(I'm doing a poor note not thinking about work stuff, haha. I should probably log off)</p>



<a name="267321983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267321983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267321983">(Jan 08 2022 at 23:16)</a>:</h4>
<p>Just consider yourself lucky that you get any time at work to think about those things</p>



<a name="267324039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267324039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267324039">(Jan 09 2022 at 00:04)</a>:</h4>
<p>Anyway - no need to hurry. This idea is already pending for 2 years since the first version of CancellationToken was implemented. And thanks for looking at it.</p>



<a name="267328081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267328081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antonio Yang <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267328081">(Jan 09 2022 at 01:40)</a>:</h4>
<p>Hi there,<br>
I want to change the presentation of the ignored test case in the summary of <code>cargo test</code>, and this will modify <code>TestDesc</code>.</p>
<p>Here is the proposal.  <br>
<a href="https://github.com/rust-lang/rfcs/pull/3217">https://github.com/rust-lang/rfcs/pull/3217</a><br>
May I just work on this?  </p>
<p>Because the RFC may not be requirement before PR.  Thanks for your time for reading these.</p>



<a name="267423649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267423649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267423649">(Jan 10 2022 at 10:59)</a>:</h4>
<p>I think cancellation is an important topic and we probably want std support at some point, however, I don't think now is the right time to consider it - primarily because the async WG doesn't have the bandwidth and there are a lot of other async issues which are higher priority at the moment. In the meantime, I think work can continue in the wild. If there is community consensus on an approach, that makes standardisation much easier!</p>



<a name="267821091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267821091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267821091">(Jan 13 2022 at 03:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264629">Antonio Yang</span> has marked this topic as resolved.</p>



<a name="267821093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Standardizing%20graceful%20cancellation%20%28%60CancellationToken%60%29/near/267821093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Standardizing.20graceful.20cancellation.20(.60CancellationToken.60).html#267821093">(Jan 13 2022 at 03:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264629">Antonio Yang</span> has marked this topic as unresolved.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>