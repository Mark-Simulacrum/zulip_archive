<html>
<head><meta charset="utf-8"><title>implementing Deref/DerefMut for [T; N] · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html">implementing Deref/DerefMut for [T; N]</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267211653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267211653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267211653">(Jan 07 2022 at 16:46)</a>:</h4>
<p>I was debugging an ICE in <a href="https://github.com/rust-lang/rust/issues/92637">#92637</a>, and I found that the ICE was due to some special-case autoderef logic hard-coded for arrays in rustc_typeck. The original solution I thought up to fix the ICE works (the second half of <a href="https://github.com/rust-lang/rust/issues/92640">#92640</a>), but I found that it's actually a much simpler fix if I just impl <code>Deref</code> for <code>[T; N]</code> in the standard library. </p>
<p>Is there a reason why we currently don't have that impl right now?</p>



<a name="267211986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267211986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267211986">(Jan 07 2022 at 16:49)</a>:</h4>
<p>not that i know, assume that this is a leftover from pre const generics times</p>



<a name="267212038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212038">(Jan 07 2022 at 16:49)</a>:</h4>
<p>I tried to implement it just for fun, to see if it would fix the issue, and the only roadblock I hit was that there were some regressions in const evaluation, since the <code>Deref</code> impl is not const. Maybe we can just fix that/make <code>&lt;[T; N] as Deref&gt;::deref</code> const? e.g. <code>[1, 2, 3].len()</code> fails with the change applied.</p>



<a name="267212067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212067">(Jan 07 2022 at 16:49)</a>:</h4>
<p>ah</p>



<a name="267212232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212232">(Jan 07 2022 at 16:50)</a>:</h4>
<p>that should be fixed during mir building afaik</p>



<a name="267212276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212276">(Jan 07 2022 at 16:51)</a>:</h4>
<p>at the same place where we change <code>1 + 2</code> from a call to <code>Add::add</code> to builtin addition</p>



<a name="267212339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212339">(Jan 07 2022 at 16:51)</a>:</h4>
<p>can check where that would be, either when constructing the thir or the mir, not sure</p>



<a name="267212420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212420">(Jan 07 2022 at 16:52)</a>:</h4>
<p>in that case, I'd be interested in implementing the change <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="267212680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212680">(Jan 07 2022 at 16:54)</a>:</h4>
<p>probably somewhere here? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> <a href="https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L331-L339">https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L331-L339</a></p>



<a name="267212880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212880">(Jan 07 2022 at 16:56)</a>:</h4>
<p>or here <a href="https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L122-L146">https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L122-L146</a></p>



<a name="267212972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212972">(Jan 07 2022 at 16:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="426609">Michael Goulet</span> <a href="#narrow/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D/near/267212420">said</a>:</p>
<blockquote>
<p>in that case, I'd be interested in implementing the change <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>
</blockquote>
<p>if you're stuck somewhere while implementing this, don't hesitate to ask (if you do it on zulip please ping me though)</p>



<a name="267212994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267212994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267212994">(Jan 07 2022 at 16:56)</a>:</h4>
<p>yup, I was just looking at the adjustment code in MIR.</p>



<a name="267213005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267213005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267213005">(Jan 07 2022 at 16:57)</a>:</h4>
<p>cool, thanks!</p>



<a name="267317098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267317098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267317098">(Jan 08 2022 at 21:33)</a>:</h4>
<p>Funny timing, this just came up in the community discord. Hopefully this will make <a href="https://github.com/rust-lang/rust/issues/62992">#62992</a> easy to fix as well, which is extra cool because that's a fairly easy beginner trap</p>



<a name="267317835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/implementing%20Deref/DerefMut%20for%20%5BT%3B%20N%5D/near/267317835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D.html#267317835">(Jan 08 2022 at 21:51)</a>:</h4>
<p>I put up this in a PR <a href="https://github.com/rust-lang/rust/issues/92652">#92652</a> and seems like implementing Deref(,Mut) for array will require some t-lang discussion at least. Thanks for linking that issue though, I'll keep it in mind.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>