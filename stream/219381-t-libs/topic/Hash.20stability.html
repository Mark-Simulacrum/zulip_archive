<html>
<head><meta charset="utf-8"><title>Hash stability · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html">Hash stability</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269326529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269326529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269326529">(Jan 25 2022 at 21:22)</a>:</h4>
<p>Is the output of <code>Hash</code> (both derived impls and the manual impls in <code>std</code>) guaranteed to be stable across compilations? I assume it may differ across different Rust versions, but I hope it's at least stable across compilations using the same compiler and stdlib.</p>



<a name="269326988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269326988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269326988">(Jan 25 2022 at 21:25)</a>:</h4>
<p>Not if you use a hashing state with randomization :-)</p>



<a name="269327243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269327243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269327243">(Jan 25 2022 at 21:27)</a>:</h4>
<blockquote>
<p>For each instance of BuildHasher, the Hashers created by build_hasher should be identical. That is, if the same stream of bytes is fed into each hasher, the same output will also be generated.<br>
<a href="https://doc.rust-lang.org/std/hash/trait.BuildHasher.html"><code>BuildHasher</code></a></p>
</blockquote>



<a name="269327505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269327505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269327505">(Jan 25 2022 at 21:28)</a>:</h4>
<p>Ah, good to know, thanks!</p>



<a name="269327716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269327716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269327716">(Jan 25 2022 at 21:30)</a>:</h4>
<p>or are you asking the other way; if this is a valid implementation of <code>Hash</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">X</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">core</span>::<span class="n">hash</span>::<span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">hash</span><span class="o">&lt;</span><span class="n">H</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">H</span>: <span class="nc">core</span>::<span class="n">hash</span>::<span class="n">Hasher</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">write_u8</span><span class="p">(</span><span class="n">rand</span>::<span class="n">random</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="269328547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269328547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269328547">(Jan 25 2022 at 21:37)</a>:</h4>
<p>It's also not stable across targets, Noah.  Even with the same compiler version and same code, different <code>usize</code> widths can affect the resulting value, as can different byte orders.</p>
<p>For anything that you're using across multiple processes, I'd suggest making a different trait.</p>



<a name="269328776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269328776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269328776">(Jan 25 2022 at 21:39)</a>:</h4>
<p>I'm asking from the point of view of storing hash results on disk, so it sounds like it should work :)</p>



<a name="269328799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269328799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269328799">(Jan 25 2022 at 21:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/Hash.20stability/near/269328547">said</a>:</p>
<blockquote>
<p>It's also not stable across targets, Noah.  Even with the same compiler version and same code, different <code>usize</code> widths can affect the resulting value, as can different byte orders.</p>
<p>For anything that you're using across multiple processes, I'd suggest making a different trait.</p>
</blockquote>
<p>Ah, that makes sense!</p>



<a name="269332887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269332887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269332887">(Jan 25 2022 at 22:13)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/std/hash/trait.Hash.html#portability">https://doc.rust-lang.org/nightly/std/hash/trait.Hash.html#portability</a></p>



<a name="269482599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269482599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269482599">(Jan 26 2022 at 21:09)</a>:</h4>
<p>That says it's not stable across compiler versions, but it would be stable <em>within</em> the same compiler version, right?</p>



<a name="269483996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269483996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269483996">(Jan 26 2022 at 21:19)</a>:</h4>
<p>If you could link two executables to each other and the types would be compatible then yeah. There could be some cases where incompatible compile results also hash differently, e.g. if layout is optimized by PGO and we just feed the raw memory representation of a type to a hasher.</p>



<a name="269484410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269484410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269484410">(Jan 26 2022 at 21:22)</a>:</h4>
<p>I mean I'm not aware of any such thing existing today, but they might in the future.</p>



<a name="269484451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269484451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269484451">(Jan 26 2022 at 21:23)</a>:</h4>
<p>In my particular use case, I just want to make sure that running the same executable twice won't have different <code>Hash</code> behavior, ignoring hashers with random state</p>



<a name="269484640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269484640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269484640">(Jan 26 2022 at 21:24)</a>:</h4>
<p>Hrm, something could be hashing global state? Like pointers of a static or something?</p>



<a name="269484739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269484739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269484739">(Jan 26 2022 at 21:25)</a>:</h4>
<p>Do you mean in <code>std</code> or in my code?</p>



<a name="269484888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269484888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269484888">(Jan 26 2022 at 21:26)</a>:</h4>
<p>uhh, don't pointers implement Hash? so if someone hashes function pointers they could change due to ASLR?</p>



<a name="269485351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269485351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269485351">(Jan 26 2022 at 21:29)</a>:</h4>
<p>It appears so...</p>



<a name="269485360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269485360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269485360">(Jan 26 2022 at 21:29)</a>:</h4>
<p>I guess I'll just have to define my own Hash trait and derive</p>



<a name="269485478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20stability/near/269485478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20stability.html#269485478">(Jan 26 2022 at 21:30)</a>:</h4>
<p>Thanks for your help with this :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>