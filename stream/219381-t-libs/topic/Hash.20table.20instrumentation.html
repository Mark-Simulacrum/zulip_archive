<html>
<head><meta charset="utf-8"><title>Hash table instrumentation · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html">Hash table instrumentation</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265955341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265955341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265955341">(Dec 23 2021 at 21:35)</a>:</h4>
<p>I have been doing some instrumentation of hash table use within rustc.</p>
<p>When compiling <code>std</code>, here are the frequencies of length+capacity combinations when tables are dropped:</p>
<div class="codehilite"><pre><span></span><code>41644590 counts:
(  1) 38525290 (92.5%, 92.5%): 0 0
(  2)  1506303 ( 3.6%, 96.1%): 1 3
(  3)   564473 ( 1.4%, 97.5%): 2 3
(  4)   244728 ( 0.6%, 98.1%): 0 3
(  5)   173150 ( 0.4%, 98.5%): 3 3
(  6)   108308 ( 0.3%, 98.7%): 4 7
(  7)    60820 ( 0.1%, 98.9%): 5 7
(  8)    51134 ( 0.1%, 99.0%): 0 7
(  9)    46309 ( 0.1%, 99.1%): 6 7
( 10)    37448 ( 0.1%, 99.2%): 7 7
( 11)    31143 ( 0.1%, 99.3%): 9 14
( 12)    28999 ( 0.1%, 99.4%): 8 14
( 13)    26947 ( 0.1%, 99.4%): 10 14
( 14)    26793 ( 0.1%, 99.5%): 0 14
( 15)    24586 ( 0.1%, 99.5%): 11 14
( 16)    19417 ( 0.0%, 99.6%): 12 14
( 17)    13869 ( 0.0%, 99.6%): 13 14
( 18)    11418 ( 0.0%, 99.7%): 14 14
( 19)     9303 ( 0.0%, 99.7%): 15 28
( 20)     9259 ( 0.0%, 99.7%): 0 28
</code></pre></div>



<a name="265955421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265955421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265955421">(Dec 23 2021 at 21:36)</a>:</h4>
<p>92.5% of created hash tables never have anything inserted into them! A few years ago I made sure empty hash tables didn't allocate, no wonder that was a win.</p>



<a name="265955589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265955589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265955589">(Dec 23 2021 at 21:39)</a>:</h4>
<p>Beyond that, most tables are tiny, which is interesting. I recently tried changing hashbrown so the minimum hash table capacity was bigger (I tried both 7 and 14). It was a small speed win (1-2% on some benchmarks) but increased heap usage by 5-10%. This explains why!</p>



<a name="265955677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265955677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265955677">(Dec 23 2021 at 21:41)</a>:</h4>
<p>Also for compiling <code>std</code>, here are frequencies of length+capacity combinations when tables are looked up (I instrumented <code>RawTable::find</code>, which I think every lookup goes through):</p>
<div class="codehilite"><pre><span></span><code>221109668 counts:
(  1) 19818913 ( 9.0%,  9.0%): 0 0
(  2) 19692341 ( 8.9%, 17.9%): 1 3
(  3)  7409283 ( 3.4%, 21.2%): 36019 57344
(  4)  5395463 ( 2.4%, 23.7%): 0 3
(  5)  3582184 ( 1.6%, 25.3%): 2 3
(  6)  3474142 ( 1.6%, 26.9%): 25916 28672
(  7)  2189300 ( 1.0%, 27.8%): 60382 114688
(  8)  1872733 ( 0.8%, 28.7%): 3 3
(  9)  1795835 ( 0.8%, 29.5%): 4 7
( 10)  1616795 ( 0.7%, 30.2%): 8991 14336
( 11)  1533138 ( 0.7%, 30.9%): 8497 14336
( 12)  1513901 ( 0.7%, 31.6%): 8806 14336
( 13)  1357577 ( 0.6%, 32.2%): 5 7
( 14)  1259535 ( 0.6%, 32.8%): 6 7
( 15)  1211176 ( 0.5%, 33.3%): 4804 7168
( 16)  1129427 ( 0.5%, 33.9%): 7 7
( 17)  1050352 ( 0.5%, 34.3%): 8 14
( 18)  1033771 ( 0.5%, 34.8%): 981 1792
( 19)   912617 ( 0.4%, 35.2%): 9 14
( 20)   857619 ( 0.4%, 35.6%): 10 14
</code></pre></div>



<a name="265955757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265955757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265955757">(Dec 23 2021 at 21:42)</a>:</h4>
<p>Bigger tables are better represented, which is unsurprising. What <em>is</em> surprising is that &gt; 10% of all lookups are on empty tables! (With either capacity=0 or capacity=3)</p>



<a name="265955826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265955826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265955826">(Dec 23 2021 at 21:43)</a>:</h4>
<p>I wonder what fraction of those are non-inserting lookups, where we could short-circuit things by just saying "if table is empty, lookup fails"</p>



<a name="265956163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265956163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265956163">(Dec 23 2021 at 21:48)</a>:</h4>
<p>I recently looked at hashbrown and iirc Inserts go through <code>find_insert_slot</code>, not <code>find</code></p>



<a name="265956201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265956201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265956201">(Dec 23 2021 at 21:49)</a>:</h4>
<p>Wait no, inserts <em>also</em> go through <code>find</code> to check if the value exists, but then call <code>find_insert_slot</code> separately if it doesn't exist.</p>



<a name="265956454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265956454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265956454">(Dec 23 2021 at 21:53)</a>:</h4>
<p>I should instrument the outer functions in HashMap that don't modify. I think that's <code>get</code>, <code>get_key_value</code>, <code>contains_key</code>, <code>get_mut</code></p>



<a name="265956721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265956721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265956721">(Dec 23 2021 at 21:57)</a>:</h4>
<p>They all route through <code>get_inner</code> or <code>get_inner_mut</code></p>



<a name="265957035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265957035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265957035">(Dec 23 2021 at 22:01)</a>:</h4>
<p>All the <code>HashSet</code> sets route through <code>HashMap</code></p>



<a name="265959384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959384">(Dec 23 2021 at 22:31)</a>:</h4>
<p>Here are the stats for compiling <code>std</code>, just instrumenting <code>HashMap::get_inner{,_mut}</code>:</p>
<div class="codehilite"><pre><span></span><code>80448733 counts:
(  1) 26907948 (33.4%, 33.4%): 0 0
(  2)  3051386 ( 3.8%, 37.2%): 1 3
(  3)  2209185 ( 2.7%, 40.0%): 2 3
(  4)  2158504 ( 2.7%, 42.7%): 60382 114688
(  5)  1287894 ( 1.6%, 44.3%): 3821 7168
(  6)  1046516 ( 1.3%, 45.6%): 3 3
(  7)  1011106 ( 1.3%, 46.8%): 4 7
(  8)   741962 ( 0.9%, 47.8%): 5 7
(  9)   728143 ( 0.9%, 48.7%): 6 7
( 10)   684762 ( 0.9%, 49.5%): 7 7
</code></pre></div>



<a name="265959404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959404">(Dec 23 2021 at 22:31)</a>:</h4>
<p>Do you have any stats for approximately how much non-codegen time is spent in hash table code, total?</p>



<a name="265959406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959406">(Dec 23 2021 at 22:31)</a>:</h4>
<p>One third of all lookups are on empty tables! And the code currently hashes the input unnecessarily, if I I'm reading the code correctly</p>



<a name="265959454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959454">(Dec 23 2021 at 22:32)</a>:</h4>
<p>Whoa! That's an awesome find!</p>



<a name="265959457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959457">(Dec 23 2021 at 22:32)</a>:</h4>
<p>one sec</p>



<a name="265959555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959555">(Dec 23 2021 at 22:34)</a>:</h4>
<p>I don't have good numbers, but I think it's at least a few percent</p>



<a name="265959575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959575">(Dec 23 2021 at 22:34)</a>:</h4>
<p>I'll just try adding a "if is_empty, fail quickly" test to those functions, see what happens, perf-wise</p>



<a name="265959620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959620">(Dec 23 2021 at 22:35)</a>:</h4>
<p>Hashing and hash tables are always one of the bigger things when you look at a bottom-up profile</p>



<a name="265959701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959701">(Dec 23 2021 at 22:36)</a>:</h4>
<p>There also are some uses that use raw tables/raw entries directly</p>



<a name="265959707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265959707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265959707">(Dec 23 2021 at 22:36)</a>:</h4>
<p>I'm really surprised that empty check is not already there. We do that in <code>indexmap</code>, but I thought we cribbed that from somewhere.</p>



<a name="265960282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265960282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265960282">(Dec 23 2021 at 22:46)</a>:</h4>
<p>@cuviper: I see that <a href="https://github.com/bluss/indexmap/blob/master/src/map.rs#L443-L453">here</a>. Yeah, hashbrown doesn't have that check</p>



<a name="265960464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265960464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265960464">(Dec 23 2021 at 22:50)</a>:</h4>
<p>Could also try skipping the hash calculation for a 1-element table (just using <code>Eq</code>), as an additional thing after the "wait it's empty" experiment.</p>



<a name="265961021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961021">(Dec 23 2021 at 23:00)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> What are the two numbers at the end of your stats lines? What is the 60382 114688 at the end of line 4?</p>



<a name="265961043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961043">(Dec 23 2021 at 23:00)</a>:</h4>
<p>Oh, length/capacity?</p>



<a name="265961053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961053">(Dec 23 2021 at 23:01)</a>:</h4>
<p>yes</p>



<a name="265961091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961091">(Dec 23 2021 at 23:01)</a>:</h4>
<p>So, 2.7% of lookups were in a table(s) with len=60382, cap=114688</p>



<a name="265961092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961092">(Dec 23 2021 at 23:01)</a>:</h4>
<p>So, there are a <em>bunch</em> of hash tables that all use that size? 2.7%?</p>



<a name="265961097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961097">(Dec 23 2021 at 23:01)</a>:</h4>
<p>Probably a single table that is looked up many times</p>



<a name="265961098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961098">(Dec 23 2021 at 23:01)</a>:</h4>
<p>Oh, it's all one hash table and 2.7% of <em>lookups</em>.</p>



<a name="265961142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961142">(Dec 23 2021 at 23:02)</a>:</h4>
<p>It could be multiple tables, but for that len/cap combination it's probably not</p>



<a name="265961153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961153">(Dec 23 2021 at 23:02)</a>:</h4>
<p>Do you have any easy way to check if there are hash table lengths (not capacities) above (say) 1024 that are duplicated?</p>



<a name="265961185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961185">(Dec 23 2021 at 23:02)</a>:</h4>
<p>I can imagine that there may be more than one hash table in the compiler of the same size, if it's information proportional to the same thing.</p>



<a name="265961191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961191">(Dec 23 2021 at 23:02)</a>:</h4>
<p>(when compiling the same code)</p>



<a name="265961203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961203">(Dec 23 2021 at 23:03)</a>:</h4>
<p>I could add a unique table ID to the output line. What question are you trying to answer?</p>



<a name="265961292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961292">(Dec 23 2021 at 23:04)</a>:</h4>
<p>Rationale: if those tables grow at around the same time in execution, we could keep a 2-3 entry cache of "specific large sizes that might get repeated", and if we see a table grow to about that size, we could pick a capacity accordingly and we'd be more likely to nail the ideal capacity.</p>



<a name="265961318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961318">(Dec 23 2021 at 23:04)</a>:</h4>
<p>"I'm about to double a table from 8192 to 16384. Turns out recently I saw a table that needed 16400 entries. Why don't I overshoot a bit?"</p>



<a name="265961365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265961365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265961365">(Dec 23 2021 at 23:05)</a>:</h4>
<p>(Which would avoid ending up with a length/capacity of 16400/32768.)</p>



<a name="265962300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265962300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265962300">(Dec 23 2021 at 23:22)</a>:</h4>
<p>Sounds... bespoke <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="265962393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/265962393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#265962393">(Dec 23 2021 at 23:24)</a>:</h4>
<p>Adding the is_empty check is a small but clear win for rustc, in terms of instruction counts:</p>
<div class="codehilite"><pre><span></span><code>unused-warnings check   incr-full   -1.36%  6.80x
externs check   incr-full   -1.03%  5.14x
many-assoc-items check  incr-full   -0.97%  4.84x
tuple-stress check  full    -0.77%  3.87x
tuple-stress check  incr-full   -0.74%  3.72x
inflate check   incr-unchanged  -0.73%  3.64x
tuple-stress check  incr-patched: new row   -0.70%  3.48x
keccak check    incr-unchanged  -0.68%  3.40x
derive check    incr-full   -0.66%  3.32x
match-stress-exhaustive_patterns check  incr-full   -0.66%  3.30x
match-stress-enum check     incr-unchanged  -0.64%  3.18x
wf-projection-stress-65510 check    incr-full   -0.56%  2.80x
futures check   incr-full   -0.56%  2.78x
tokio-webpush-simple check  incr-full   -0.53%  2.66x
clap-rs check   incr-unchanged  -0.53%  2.64x
stm32f4 check   incr-full   -0.53%  2.63x
issue-88862 check   incr-full   -0.52%  2.59x
derive check    incr-unchanged  -0.49%  2.46x
regex check     incr-full   -0.49%  2.45x
syn check   incr-full   -0.49%  2.44x
unused-warnings check   incr-unchanged  -0.49%  2.43x
ripgrep check   incr-full   -0.48%  2.40x
encoding check  incr-full   -0.48%  2.38x
issue-58319 check   incr-full   -0.47%  2.36x
webrender-wrench check  incr-full   -0.45%  2.25x
match-stress-exhaustive_patterns check  full    -0.45%  2.25x
regression-31157 check  incr-full   -0.45%  2.23x
hyper-2 check   incr-full   -0.44%  2.21x
externs check   incr-unchanged  -0.43%  2.17x
clap-rs check   incr-patched: println   -0.43%  2.13x
stm32f4 check   incr-unchanged  -0.42%  2.12x
match-stress-exhaustive_patterns check  incr-unchanged  -0.42%  2.12x
unused-warnings check   incr-patched: dummy fn  -0.42%  2.11x
webrender check     incr-full   -0.42%  2.10x
wf-projection-stress-65510 check    incr-unchanged  -0.42%  2.08x
issue-46449 check   incr-full   -0.41%  2.04x
ucd check   incr-unchanged  -0.41%  2.03x
clap-rs check   incr-full   -0.40%  1.98x
repro_crate check   incr-full   -0.39%  1.96x
piston-image check  incr-full   -0.37%  1.87x
unicode_normalization check     incr-full   -0.37%  1.85x
repro_crate check   full    -0.37%  1.85x
repro_crate check   incr-unchanged  -0.34%  1.68x
coercions check     full    -0.33%  1.67x
derive check    full    -0.33%  1.65x
unicode_normalization check     full    -0.33%  1.64x
coercions check     incr-full   -0.32%  1.61x
unicode_normalization check     incr-patched: println   -0.31%  1.56x
serde check     incr-full   -0.31%  1.56x
</code></pre></div>



<a name="266003204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/266003204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#266003204">(Dec 24 2021 at 13:48)</a>:</h4>
<p>Shame we don't have a perf suite for a broader set of rust programs.</p>



<a name="266014916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/266014916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#266014916">(Dec 24 2021 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Hash.20table.20instrumentation/near/265961365">said</a>:</p>
<blockquote>
<p>(Which would avoid ending up with a length/capacity of 16400/32768.)</p>
</blockquote>
<p>Isn't the capacity of an hashtable always a power of 2? (The actual capacity allocated, not the one shown with <code>.capacity()</code>)</p>



<a name="266059863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/266059863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#266059863">(Dec 25 2021 at 13:40)</a>:</h4>
<p>with_capacity constructor allows for non-power-of-two capacities.</p>



<a name="266059902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/266059902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#266059902">(Dec 25 2021 at 13:41)</a>:</h4>
<p>(thats true for both the rust view and allocator view of allocation size)</p>



<a name="266061035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Hash%20table%20instrumentation/near/266061035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Hash.20table.20instrumentation.html#266061035">(Dec 25 2021 at 14:12)</a>:</h4>
<p>The raw table capacity is forced to be a power of 2 so the hash can be simply bitmasked to get the index. Your requested capacity is rounded up to 7/8 of a power of 2 for the maximum load factor.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>