<html>
<head><meta charset="utf-8"><title>impl From&lt;Option&lt;NonZeroU64&gt; for u64 · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html">impl From&lt;Option&lt;NonZeroU64&gt; for u64</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255100863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255100863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255100863">(Sep 27 2021 at 18:54)</a>:</h4>
<p>I'd like to add impls like <code>impl From&lt;Option&lt;NonZeroU64&gt;&gt; for u64</code>, translating None to 0. It's a little annoying to write that normally, requiring something like <code>opt_nonzero.map_or(0, u64::from)</code>. Since trait impls are insta-stable, I wanted to confirm if others on libs-api think this seems reasonable.</p>



<a name="255102111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255102111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255102111">(Sep 27 2021 at 19:01)</a>:</h4>
<p>While I'm not on the libs-api team, this impl would seem to rely on the internal representation quite a bit. Even though it's guaranteed, it seems somewhat surprising that such an impl would exist.</p>



<a name="255102451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255102451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255102451">(Sep 27 2021 at 19:03)</a>:</h4>
<p>the implementation detail and the semantics are separate. it could be implemented as a simple <code>match</code> statement</p>



<a name="255102750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255102750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255102750">(Sep 27 2021 at 19:05)</a>:</h4>
<p>Either way I still find it somewhat surprising. The <em>reason</em> for the impl at least appears to be over the internal representation.</p>



<a name="255102847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255102847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255102847">(Sep 27 2021 at 19:06)</a>:</h4>
<p>it's the inverse of NonZeroU64::new</p>



<a name="255102926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255102926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255102926">(Sep 27 2021 at 19:06)</a>:</h4>
<p>hm. it's a shame that a method on <code>Option&lt;NonZeroU64&gt;</code> would appear on the <code>Option</code> page in the docs, not on the <code>NonZeroU64</code> page.</p>



<a name="255102965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255102965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255102965">(Sep 27 2021 at 19:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255102111">said</a>:</p>
<blockquote>
<p>While I'm not on the libs-api team, this impl would seem to rely on the internal representation quite a bit. Even though it's guaranteed, it seems somewhat surprising that such an impl would exist.</p>
</blockquote>
<p>I have no intention of relying on the internal representation in the impl.</p>



<a name="255103003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103003">(Sep 27 2021 at 19:07)</a>:</h4>
<p>I'm hoping the compiler will be smart enough to turn the implementation into a no-op.</p>



<a name="255103076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103076">(Sep 27 2021 at 19:07)</a>:</h4>
<p>My proposed implementation looks like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="cp">#[stable(feature = </span><span class="s">"from_option_nonzero"</span><span class="cp">, since = </span><span class="s">"1.57.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">            </span><span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="cp">$Ty</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="cp">$Int</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="cp">#[doc = concat!(</span><span class="s">"Converts an `Option&lt;"</span><span class="cp">, stringify!($Ty), </span><span class="s">"&gt;` into an `"</span><span class="cp">, stringify!($Int), </span><span class="s">"`"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">                </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">                </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">opt_nonzero</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="cp">$Ty</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">opt_nonzero</span><span class="p">.</span><span class="n">map_or</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">nonzero</span><span class="o">|</span><span class="w"> </span><span class="n">nonzero</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="255103251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103251">(Sep 27 2021 at 19:09)</a>:</h4>
<p>i'm a bit worried that both <code>Option&lt;NonZeroU64&gt;</code> and <code>NonZeroU64</code> can then be <code>.into()</code>'d into a <code>u64</code>. if someone is using <code>.into()</code> instead of <code>.get()</code>, changing the type of something to an Option would silently keep working and introduce a 0 where there probably shouldn't be one.</p>



<a name="255103319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103319">(Sep 27 2021 at 19:09)</a>:</h4>
<p>I suppose what I'm saying is it doesn't seem like <code>Option</code> should be used to represent the niche semantically.</p>



<a name="255103475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103475">(Sep 27 2021 at 19:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255103251">said</a>:</p>
<blockquote>
<p>i'm a bit worried that both <code>Option&lt;NonZeroU64&gt;</code> and <code>NonZeroU64</code> can then be <code>.into()</code>'d into a <code>u64</code>. if someone is using <code>.into()</code> instead of <code>.get()</code>, changing the type of something to an Option would silently keep working and introduce a 0 where there probably shouldn't be one.</p>
</blockquote>
<p>That thought occurred to me as well. The flip side is, if you're converting to u64, which allows zeroes, presumably you're doing that for a reason, rather than just passing NonZeroU64 onwards.</p>



<a name="255103483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103483">(Sep 27 2021 at 19:10)</a>:</h4>
<p>But Option is a pretty central example for that.</p>



<a name="255103557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103557">(Sep 27 2021 at 19:11)</a>:</h4>
<p>if I may invoke slippery-slope, would you also do <code>Option&lt;NonNull&lt;T&gt;&gt;</code> to <code>*mut T</code>? or <code>Option&lt;&amp;T&gt;</code> to <code>*const T</code>? or any other cases where FFI already guarantees pseudo-transparent options?</p>



<a name="255103567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103567">(Sep 27 2021 at 19:11)</a>:</h4>
<p>(not that this is about FFI)</p>



<a name="255103602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103602">(Sep 27 2021 at 19:11)</a>:</h4>
<blockquote>
<p>That thought occurred to me as well. The flip side is, if you're converting to u64, which allows zeroes, presumably you're doing that for a reason, rather than just passing NonZeroU64 onwards.</p>
</blockquote>
<p>It's pretty common to have operations on a regular u64 (or u32/i32/...) that will panic or are UB when the value is zero. e.g. passing a u64 to a FFI function, or dividing by a u64, etc.</p>



<a name="255103620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103620">(Sep 27 2021 at 19:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255103483">said</a>:</p>
<blockquote>
<p>But Option is a pretty central example for that.</p>
</blockquote>
<p>How so?</p>



<a name="255103622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103622">(Sep 27 2021 at 19:11)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> I didn't plan to write those impls, but I see nothing wrong with having those impls as well.</p>



<a name="255103717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103717">(Sep 27 2021 at 19:12)</a>:</h4>
<p>For what it's worth, safe-transmute will allow this once implemented, we'd just be giving people are more obvious way to do it</p>



<a name="255103756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103756">(Sep 27 2021 at 19:12)</a>:</h4>
<p>Yeah, I don't think this is appropriate. Option is for the absence of something, using <code>into()</code> would essentially always assert the presence of it.</p>



<a name="255103759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103759">(Sep 27 2021 at 19:12)</a>:</h4>
<p><code>.or_zero()</code>, <code>.or_null()</code> etc. would be nicer to read. but it's a bit annoying that they all end up on the <code>Option&lt;T&gt;</code> type for many different <code>T</code></p>



<a name="255103854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103854">(Sep 27 2021 at 19:13)</a>:</h4>
<p>it doesn't end up on the u64 page?</p>



<a name="255103882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103882">(Sep 27 2021 at 19:13)</a>:</h4>
<p>Yeah, I wouldn't be opposed to <code>.get_or_zero()</code> or similar</p>



<a name="255103904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103904">(Sep 27 2021 at 19:13)</a>:</h4>
<p>And yes, an alternate API would be appropriate.</p>



<a name="255103911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103911">(Sep 27 2021 at 19:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255103620">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255103483">said</a>:</p>
<blockquote>
<p>But Option is a pretty central example for that.</p>
</blockquote>
<p>How so?</p>
</blockquote>
<p>In fact Option is the <em>only</em> type for which we have normative guarantees about niche optimizations. All other types that have them are still in the "would be nice if that were part of the spec too" stage.</p>



<a name="255103912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103912">(Sep 27 2021 at 19:14)</a>:</h4>
<p>just like <code>vec.len()</code> doesn't appear on the <code>usize</code> page. nope</p>



<a name="255103935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255103935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255103935">(Sep 27 2021 at 19:14)</a>:</h4>
<p><span class="user-mention" data-user-id="310399">@Mara</span> That's an interesting idea. Seems a little annoying to have to use a special-case method, though.</p>



<a name="255104004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104004">(Sep 27 2021 at 19:14)</a>:</h4>
<p>oh, <code>impl From&lt;u16&gt; for u64</code> is on the u64 page though</p>



<a name="255104018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104018">(Sep 27 2021 at 19:14)</a>:</h4>
<p>sure. because Self is u64 there.</p>



<a name="255104069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104069">(Sep 27 2021 at 19:15)</a>:</h4>
<p>but in <code>impl From&lt;Option&lt;NonZeroU64&gt;&gt; for u64</code>, isn't Self also still u64?</p>



<a name="255104099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104099">(Sep 27 2021 at 19:15)</a>:</h4>
<p>i'm talking about a method like <code>.or_zero()</code></p>



<a name="255104107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104107">(Sep 27 2021 at 19:15)</a>:</h4>
<p>oh oh ohhhhhh</p>



<a name="255104111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104111">(Sep 27 2021 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> Is niche value optimization not guaranteed for Option-like enums? It's not specific to <code>Option</code> as far as I knew.</p>



<a name="255104227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104227">(Sep 27 2021 at 19:16)</a>:</h4>
<p>&lt;dryly&gt; FromOption</p>



<a name="255104332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104332">(Sep 27 2021 at 19:16)</a>:</h4>
<p>8472 is correct, technically it's not guaranteed right now for Option-like enums, just Option itself</p>



<a name="255104746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104746">(Sep 27 2021 at 19:19)</a>:</h4>
<p>It just <em>feels</em> wrong. Safe transmute feels like the way to go here, as you'd effectively be declaring that you are aware of the niche value optimization and wish to take advantage of it.</p>



<a name="255104904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255104904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255104904">(Sep 27 2021 at 19:20)</a>:</h4>
<p>I don't object to waiting for safe transmute, if the general consensus is that the <code>From</code> impl would be too error-prone.</p>



<a name="255105051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255105051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255105051">(Sep 27 2021 at 19:21)</a>:</h4>
<p>I don't personally think this is tied to the niche optimization or the internal representation. But I do understand the objection that people might invoke this via <code>.into()</code> accidentally when they expected to process the <code>None</code> first.</p>



<a name="255105584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255105584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255105584">(Sep 27 2021 at 19:25)</a>:</h4>
<p>We already have <code>NonZero*::new</code> to do this in the opposite direction, to convert 0 to None. having the opposite is useful. but i'm a bit worried that a <code>From</code> impl is too subtle. also because we'd have to directly stabilize it, without the chance to first try it out as unstable to see how it goes</p>



<a name="255107565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255107565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255107565">(Sep 27 2021 at 19:38)</a>:</h4>
<p>Yeah, the method should exist, it just likely has the wrong semantics.<br>
It feels too much like<br>
take a hypothetical ExitCode type (may (not) exist), and ExitErr, which internally is a NonZero because if it's 0 it's success.<br>
i.e. We're Unix now.<br>
It feels too much like it risks a translation of<br>
ExitCode -&gt; Option&lt;ExitErr&gt; -&gt; ExitErr -&gt; Option&lt;ExitErr&gt; -&gt; ExitCode<br>
suddenly becoming simplified to omit the middle two steps.</p>



<a name="255107726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255107726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255107726">(Sep 27 2021 at 19:39)</a>:</h4>
<p>I agree that having a way to go from an Option&lt;NonZeroU64&gt; to a u64 would be useful but also don't think the From impl would be the right way to do it. IMO the None here isn't semantically equivalent to a 0 even if they're represented the same way, I can imagine in many cases users would want to default to <code>1</code> or some other non-zero number, and introducing a zero on accident would cause issues</p>



<a name="255108610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255108610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255108610">(Sep 27 2021 at 19:45)</a>:</h4>
<p>in the hypothetical where it is 5 steps, you "know" from the trip through ExitErr that you have a 1+ value, and you might write code based on that assumption, which is wrong if it gets simplified too readily. You have <strong>eliminated</strong> the possibility which is exactly what such a type transition is for.</p>
<p>And the Option might exist because you are performing a transformation in the program which unites two paths with disjoint control flow: the 3-step path and the 5-step path exist simultaneously, and you may reason based on this number's value on which branch you took.</p>



<a name="255109347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255109347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255109347">(Sep 27 2021 at 19:50)</a>:</h4>
<p>I am not recommending anyone write code like this, I am just saying that mixing type and value-oriented reasoning in surprising ways and hinging control flow on it is very easy for programmers and I would call such a function<code>maybe_zero</code> just to hammer home the point. &lt;_&lt;</p>



<a name="255109818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255109818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255109818">(Sep 27 2021 at 19:53)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/process/struct.ExitStatusError.html">https://doc.rust-lang.org/std/process/struct.ExitStatusError.html</a> oh it does exist.<br>
<a href="https://doc.rust-lang.org/std/process/struct.ExitStatus.html#method.code">https://doc.rust-lang.org/std/process/struct.ExitStatus.html#method.code</a> and ExitStatus does return Option&lt;i32&gt; if you ask it what the code is because the None case represents sigterm. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="255203406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255203406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255203406">(Sep 28 2021 at 11:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255105584">said</a>:</p>
<blockquote>
<p>We already have <code>NonZero*::new</code> to do this in the opposite direction, to convert 0 to None. having the opposite of that is useful too. but i'm a bit worried that a <code>From</code> impl is too subtle.</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">v</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">NonZeroU64</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">v</span><span class="p">.</span><span class="n">map_or</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">nonzero</span><span class="o">|</span><span class="w"> </span><span class="n">nonzero</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>:&gt;</p>



<a name="255248247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255248247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255248247">(Sep 28 2021 at 16:41)</a>:</h4>
<p>hah.</p>



<a name="255526138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255526138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255526138">(Sep 30 2021 at 06:50)</a>:</h4>
<p>It’s the same behavior in the end but to me the "intent" of <code>NonZeroU64::new</code> is not to convert zero to None but more like: do a fallible conversion that would return something like <code>Result&lt;_, NonZeroFromZeroError&gt;</code> but since the error type is zero-size and has no interesting method we cut a corner and used <code>Option&lt;_&gt;</code> to represent that result. In hindsight maybe it should really have been a <code>Result</code></p>



<a name="255570208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255570208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255570208">(Sep 30 2021 at 13:06)</a>:</h4>
<p>I agree with the general sentiment that a whole <code>From</code> impl on <code>Option</code> seems to be too broad. Since such a method would belong to <code>Option</code>, it would be nice to find a more general alternative. In this case, it seems to be a <code>.map_into_or()</code> operation of sorts, which could be shortened, modulo bikeshed, to <code>.into_or()</code>. The resulting adapter remains too niche imho (if <code>.unwrap_or_default()</code> is to be deprecated in favor of <code>.unwrap_or_else(&lt;_&gt;::default)</code>, the following addition seems to go in the opposite direction). What about an extension trait for the current needs, and see how often you reach out for such a helper?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[extension_trait]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OptionIntoOr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">into_or</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">else_</span>: <span class="nc">U</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span>: <span class="nb">Into</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">map_or</span><span class="p">(</span><span class="n">else_</span><span class="p">,</span><span class="w"> </span><span class="nb">Into</span>::<span class="n">into</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">opt_nonzero</span><span class="p">.</span><span class="n">into_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="255573090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255573090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255573090">(Sep 30 2021 at 13:26)</a>:</h4>
<blockquote>
<p>I agree with the general sentiment that a whole From impl on Option seems to be too broad</p>
</blockquote>
<p>It wouldn't really be <em>on</em> option though since it's an impl for <code>u64</code>. Where stuff shows up in rustdoc is mostly an issue of rustdoc not knowing which part of a trait impl is the most significant one.</p>



<a name="255574683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255574683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255574683">(Sep 30 2021 at 13:35)</a>:</h4>
<p>yeah you'd call it as <code>u64::from(opt_nz)</code></p>



<a name="255581646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255581646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255581646">(Sep 30 2021 at 14:17)</a>:</h4>
<p>Slight distraction: particularly in std, and for blanket impls in std, it would be nice if e.g. <code>Into</code> impls showed up on the relevant rustdoc pages... i.e. that the <code>From</code> being on one page leads to the <code>Into</code> being on the other type</p>



<a name="255585490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255585490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255585490">(Sep 30 2021 at 14:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64/near/255573090">said</a>:</p>
<blockquote>
<blockquote>
<p>I agree with the general sentiment that a whole From impl on Option seems to be too broad</p>
</blockquote>
<p>It wouldn't really be <em>on</em> option though since it's an impl for <code>u64</code>. Where stuff shows up in rustdoc is mostly an issue of rustdoc not knowing which part of a trait impl is the most significant one.</p>
</blockquote>
<p>To clarify, there are <em>two</em> points here:</p>
<ul>
<li>
<p>One is the initial proposal of a <code>From&lt;Opt&lt;NZUn&gt;&gt;</code> for <code>un</code>; which is based off an implicit unwrap which "arbitrarily" assigns <code>0</code> to <code>None</code>. Not only can it be mixed up with <code>From&lt;NZUn&gt; for un</code>, but having a <code>From</code> impl which altogether performs unwrap can be deemed a bit too terse.</p>
</li>
<li>
<p>So there is a second idea floating around of adding some method to <code>Opt&lt;NZUn&gt;</code>, such as <code>.get_or(0)</code>. This seems way more reasonable already, but has a documentation issue which imho is just a symptom of a deeper design issue: such a method would show up on the docs for <code>Option</code> rather than the docs for <code>NZUn</code>; hence my suggesting a <em>broader</em> API, <code>into_or</code> (modulo name bikeshedding), which is the one thing that could qualify as an API addition for <code>Option</code>.</p>
</li>
</ul>
<p>I could live with the simpler <code>.get_or</code>, though; but I remain a bit skeptical of the <code>From</code> approach.</p>



<a name="255590374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255590374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255590374">(Sep 30 2021 at 15:07)</a>:</h4>
<blockquote>
<p>but having a From impl which altogether performs unwrap can be deemed a bit too terse.</p>
</blockquote>
<p>For the general case I would agree. But for <code>Option&lt;NonZero*&gt;</code> it doesn't seem that bad considering it's the opposite of what <code>::new</code> already does.</p>
<blockquote>
<p>But has a documentation issue which imho is just a symptom of a deeper design issue: such a method would show up on the docs for Option rather than the docs for NZUn</p>
</blockquote>
<p>Instead we could improve the docs. We have other cases where such confusion happens. E.g. <code>impl&lt;T&gt; *const [T]</code>  should probably show up in the slice docs instead of the pointer docs. Similar with some <code>MaybeUninit</code> APIs being scattered over several types.<br>
Maybe an attribute that tells rustdoc which the most important type in an impl is would help.</p>



<a name="255680613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/impl%20From%3COption%3CNonZeroU64%3E%20for%20u64/near/255680613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/impl.20From.3COption.3CNonZeroU64.3E.20for.20u64.html#255680613">(Oct 01 2021 at 02:31)</a>:</h4>
<p>I agree with Simon and Jane on this, I think.</p>
<p>The piece I'll add here is that I think the <code>From</code> proposed here extends poorly to other potential <code>From</code>/<code>TryFrom</code>s.  If we ever have <code>NonZeroU32: TryFrom&lt;u64&gt;</code> -- which I think is reasonable same as we have <code>NonZeroU32: TryFrom&lt;NonZeroU64&gt;</code> -- then it loses the "0 turns into None" property of the current <code>NonZeroU32: TryFrom&lt;u32&gt;</code>.  And having <code>u64: From&lt;Option&lt;NonZeroU32&gt;&gt;</code> turn <code>None</code> into <code>0</code> doesn't seem as justifiable as it might be for <code>u32: From&lt;Option&lt;NonZeroU32&gt;&gt;</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>