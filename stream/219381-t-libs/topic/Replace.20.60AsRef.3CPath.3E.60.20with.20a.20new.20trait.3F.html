<html>
<head><meta charset="utf-8"><title>Replace `AsRef&lt;Path&gt;` with a new trait? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html">Replace `AsRef&lt;Path&gt;` with a new trait?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274782794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274782794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274782794">(Mar 10 2022 at 02:42)</a>:</h4>
<p>What if  we introduced a new trait to be used in arguments as a drop-in replacement for <code>AsRef&lt;Path&gt;</code>. Would something break?</p>
<p>For example, if the signature of <a href="https://doc.rust-lang.org/std/fs/struct.File.html#method.open"><code>File::open</code></a> was changed to this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">open</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nc">IntoPlatformPath</span><span class="o">&gt;</span><span class="p">(</span><span class="n">path</span>: <span class="nc">P</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>And <code>IntoPlatformPath</code> is implemented for all <code>AsRef&lt;Path&gt;</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">IntoPlatformPath</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">P</span><span class="w"></span>
</code></pre></div>



<a name="274785442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274785442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274785442">(Mar 10 2022 at 03:31)</a>:</h4>
<p>What would be the advantage? Special cases for native UTF-16 paths?</p>



<a name="274785600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274785600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274785600">(Mar 10 2022 at 03:34)</a>:</h4>
<p>Yeah, I was thinking it might be a way to directly pass in UTF-16 paths or null terminated C strings (depending on the platform). I'm not quite sure if it's a good idea but I did want to understand the available design space. I.e. what we can change and what we can't.</p>



<a name="274791532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274791532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274791532">(Mar 10 2022 at 05:22)</a>:</h4>
<p>I <em>think</em> that wouldn't be breaking?</p>



<a name="274791556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274791556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274791556">(Mar 10 2022 at 05:22)</a>:</h4>
<p>Not sure how easily you could take advantage of it, given constraints on OsString.</p>



<a name="274791574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274791574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274791574">(Mar 10 2022 at 05:23)</a>:</h4>
<p>You would need a completely different type.</p>



<a name="274791588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274791588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274791588">(Mar 10 2022 at 05:23)</a>:</h4>
<p>Something would have to produce that type.</p>



<a name="274794891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274794891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274794891">(Mar 10 2022 at 06:18)</a>:</h4>
<p>Well with the caveat that I'm just very roughly sketching at the moment, I was thinking something along these lines:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// OS specific.</span>
<span class="k">type</span> <span class="nc">RawPlatformStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u16</span><span class="p">;</span><span class="w"></span>
<span class="sd">/// Safety: Must always return a valid RawPlatformStr.</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">AsRawPlatformStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">RawPlatformStr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">len</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="sd">/// Conversion trait.</span>
<span class="k">trait</span><span class="w"> </span><span class="n">ToPlatformString</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">PlatformString</span>: <span class="nc">AsRawPlatformStr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">to_platform_str</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">PlatformString</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// This could be a user defined type.</span>
<span class="cp">#[derive(Copy, Clone)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyPlatformStr</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">[</span><span class="kt">u16</span><span class="p">]);</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyPlatformStr</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="p">[</span><span class="kt">u16</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">last</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="bp">Self</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">AsRawPlatformStr</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyPlatformStr</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">RawPlatformStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">len</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">len</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">ToPlatformString</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyPlatformStr</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">PlatformString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">to_platform_str</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">PlatformString</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="bp">self</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// An internal std type.</span>
<span class="k">struct</span> <span class="nc">OwnedPlatformString</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u16</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">AsRawPlatformStr</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OwnedPlatformString</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">RawPlatformStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">len</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">len</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ToPlatformString</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">PlatformString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OwnedPlatformString</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">to_platform_str</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">PlatformString</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">OwnedPlatformString</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">as_os_str</span><span class="p">().</span><span class="n">encode_wide</span><span class="p">().</span><span class="n">chain</span><span class="p">([</span><span class="mi">0</span><span class="p">]).</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274801745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274801745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274801745">(Mar 10 2022 at 08:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="260325">Chris Denton</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/274782794">said</a>:</p>
<blockquote>
<p>And <code>IntoPlatformPath</code> is implemented for all <code>AsRef&lt;Path&gt;</code></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">P</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">IntoPlatformPath</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">P</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>I think that if you have that, you need negative impls in coherence to not overlap with the blanket if you ever want to implement it.</p>



<a name="274859844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274859844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274859844">(Mar 10 2022 at 16:30)</a>:</h4>
<blockquote>
<p>What if  we introduced a new trait to be used in arguments as a drop-in replacement for <code>AsRef&lt;Path&gt;</code>.</p>
</blockquote>
<p><span class="user-mention" data-user-id="260325">@Chris Denton</span> I was thinking about the exact same thing the other day. Would be nice if we can eventually provide a 'true' 'OsString' (with a different name), that actually stores a nul-terminated and on windows UCS-2/UTF-16 string.</p>



<a name="274860216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274860216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274860216">(Mar 10 2022 at 16:33)</a>:</h4>
<p><span class="user-mention" data-user-id="260325">@Chris Denton</span> iirc, in <code>std::sys</code> we have a slightly different api. something like <code>with_os_str(s, |x| { ... })</code>. that way, <code>x</code> can borrow from a local variable (on the stack) from <code>with_os_str</code>, which can be useful to avoid heap allocations for paths until a certain length.</p>



<a name="274892917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274892917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274892917">(Mar 10 2022 at 20:49)</a>:</h4>
<p>Yeah, using a closure looks like a good design. In any case I wasn't meaning to design a new API right this minute <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span>. But I did want to check in to see if this was a future possibility.</p>



<a name="274895591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274895591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274895591">(Mar 10 2022 at 21:13)</a>:</h4>
<p>I would rather see that we eventually switch fron the W variants to the A variants of win32 api's once UTF-8 is supported by them on all supported windows targets by setting the code page to utf-8: <a href="https://docs.microsoft.com/en-us/windows/apps/design/globalizing/use-utf8-code-page">https://docs.microsoft.com/en-us/windows/apps/design/globalizing/use-utf8-code-page</a></p>



<a name="274897365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274897365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274897365">(Mar 10 2022 at 21:29)</a>:</h4>
<p>That would mean no longer supporting broken Unicode (the <code>A</code> functions do a lossy conversion). Which may be ok but would be a change from how Rust currently works. It's also hard to enforce UTF-8 when Rust is used in a DLL rather than an exe because as far as I'm aware the setting is per process rather than per module.</p>
<p>And on all platforms there's still the issue of appending the null terminator, which requires an allocation (or at least copying the string to a stack buffer).</p>



<a name="274907015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274907015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274907015">(Mar 10 2022 at 22:49)</a>:</h4>
<p>Yeah the A functions are not great</p>



<a name="274907085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274907085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274907085">(Mar 10 2022 at 22:49)</a>:</h4>
<blockquote>
<p>And on all platforms there's still the issue of appending the null terminator, which requires an allocation (or at least copying the string to a stack buffer).</p>
</blockquote>
<p>This part is "easily" fixable with the type system</p>



<a name="274907852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274907852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274907852">(Mar 10 2022 at 22:56)</a>:</h4>
<p>Easily?</p>



<a name="274908405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274908405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274908405">(Mar 10 2022 at 23:01)</a>:</h4>
<p>What about using A where possible and falling back to W for incorrect UTF-16?</p>



<a name="274908749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274908749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274908749">(Mar 10 2022 at 23:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="260325">Chris Denton</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/274897365">said</a>:</p>
<blockquote>
<p>That would mean no longer supporting broken Unicode (the <code>A</code> functions do a lossy conversion). Which may be ok but would be a change from how Rust currently works. It's also hard to enforce UTF-8 when Rust is used in a DLL rather than an exe because as far as I'm aware the setting is per process rather than per module.</p>
<p>And on all platforms there's still the issue of appending the null terminator, which requires an allocation (or at least copying the string to a stack buffer).</p>
</blockquote>
<p>I think once all supported Windows targets support UTF-8 in the A functions, we could reasonably make such a transition. I don't think it'd be impossible.</p>



<a name="274910141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274910141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274910141">(Mar 10 2022 at 23:20)</a>:</h4>
<blockquote>
<p>What about using A where possible and falling back to W for incorrect UTF-16?</p>
</blockquote>
<p>I mean, maybe. We'd ideally need to avoid doing a Unicode check on every use though.</p>



<a name="274910154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274910154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274910154">(Mar 10 2022 at 23:20)</a>:</h4>
<blockquote>
<p>I think once all supported Windows targets support UTF-8 in the A functions, we could reasonably make such a transition. I don't think it'd be impossible.</p>
</blockquote>
<p>Hm, in that case why can't we do lossy conversions now?</p>



<a name="274914171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274914171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274914171">(Mar 11 2022 at 00:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="260325">Chris Denton</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/274907852">said</a>:</p>
<blockquote>
<p>Easily?</p>
</blockquote>
<p>"Easily" as in "you <em>just</em> need to make a separate set of string types that correctly does what you want".</p>



<a name="274916603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274916603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274916603">(Mar 11 2022 at 00:32)</a>:</h4>
<p>What about rust cdylibs using std? I think those can't control the manifest/utf8 codepage</p>



<a name="274917055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274917055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274917055">(Mar 11 2022 at 00:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/274914171">said</a>:</p>
<blockquote>
<p>"Easily" as in "you <em>just</em> need to make a separate set of string types that correctly does what you want".</p>
</blockquote>
<p><em>cough</em> <a href="https://docs.rs/abistr/0.2.0-rc1/abistr/index.html">abistr</a> <em>cough</em> &lt;/self-plug&gt;</p>



<a name="274919173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274919173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274919173">(Mar 11 2022 at 01:05)</a>:</h4>
<p>Just to continue expounding on prior art:</p>
<ul>
<li><code>AsRawPlatformStr</code> ~ <a href="https://docs.rs/abistr/0.2.0-rc1/abistr/trait.AsCStr.html"><code>abistr::AsCStr</code></a>, although I skip <code>len</code></li>
<li><code>ToPlatformString</code> ~ <a href="https://docs.rs/abistr/0.2.0-rc1/abistr/trait.TryIntoAsCStr.html"><code>abistr::TryIntoAsCStr</code></a></li>
<li><code>MyPlatformStr</code> ~ <code>std::ffi::CStr</code>, <a href="https://docs.rs/widestring/latest/widestring/ucstr/type.U16CStr.html"><code>widestring::U{16,32}CStr</code></a>, <a href="https://docs.rs/abistr/0.2.0-rc1/abistr/struct.CStrPtr.html"><code>abistr::CStrPtr</code></a>, <a href="https://docs.rs/abistr/0.2.0-rc1/abistr/struct.CStrNonNull.html"><code>abistr::CStrNonNull</code></a></li>
<li><code>OwnedPlatformString</code> ~ <code>std::ffi::CString</code>, <a href="https://docs.rs/widestring/latest/widestring/ucstring/type.U16CString.html"><code>widestring::U{16,32}CString</code></a>, <a href="https://docs.rs/abistr/0.2.0-rc1/abistr/struct.CStrBuf.html"><code>abistr::CStrBuf</code></a></li>
</ul>



<a name="274919292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/274919292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#274919292">(Mar 11 2022 at 01:06)</a>:</h4>
<p>I've considered adding <code>abistr::*CPath*</code> variations but haven't bothered to actually go through with that yet</p>



<a name="275115766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275115766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275115766">(Mar 12 2022 at 20:31)</a>:</h4>
<p>@bjorn3: Throwing in the (very little) I know, AFAIK the <code>A</code> variants of Windows APIs aren't zero-cost -- from <a href="https://docs.microsoft.com/en-us/windows/win32/learnwin32/working-with-strings">MSDN docs</a> (emphasis mine):</p>
<blockquote>
<p>Internally, the ANSI version translates the string to Unicode. ...</p>
<p>...</p>
<p>New applications should always call the Unicode versions. Many world languages require Unicode. If you use ANSI strings, it will be impossible to localize your application. <strong>The ANSI versions are also less efficient, because the operating system must convert the ANSI strings to Unicode at run time.</strong></p>
</blockquote>



<a name="275118813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275118813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275118813">(Mar 12 2022 at 21:49)</a>:</h4>
<p>Given that, I'm fairly confident that switching to all the A functions would be a big step backwards.</p>



<a name="275119064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275119064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275119064">(Mar 12 2022 at 21:56)</a>:</h4>
<p>I'm wondering to what extent that continues to be true, and to what extent that might change in the future, given the continued movement of Windows 10/11 towards compatibility.</p>



<a name="275119073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275119073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275119073">(Mar 12 2022 at 21:57)</a>:</h4>
<p>Also, the quoted text there does not seem to take into account the current version of the ANSI APIs that operate in terms of UTF-8.</p>



<a name="275119077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275119077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275119077">(Mar 12 2022 at 21:57)</a>:</h4>
<p>It seems to be talking only about ANSI as though it is not UTF-8.</p>



<a name="275120272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275120272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275120272">(Mar 12 2022 at 22:30)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>: I doubt that Windows would change its native string encodings without serious discussion and advertisement of intent -- there's some nontrivial performance concerns around that, esp. for non-Latin languages. I think it's an interesting idea, but there <em>are</em> a lot of stakeholders to engage with a change like that.</p>
<p>It seems like the code page setting for UTF-8 changes what the conversion to UTF-16LE converts from (instead of ANSI), rather than avoiding conversion. From <span class="user-mention" data-user-id="133247">@bjorn3</span>'s <a href="https://docs.microsoft.com/en-us/windows/apps/design/globalizing/use-utf8-code-page">link about using UTF-8</a> (again, emphasis mine):</p>
<blockquote>
<h2>-A vs. -W APIs</h2>
<p>Win32 APIs often support both -A and -W variants.</p>
<p>-A variants recognize the ANSI code page configured on the system and support <code>char*</code>, while -W variants operate in UTF-16 and support <code>WCHAR</code>. </p>
<p>Until recently, Windows has emphasized "Unicode" -W variants over -A APIs. However, recent releases have used the ANSI code page and -A APIs as a means to introduce UTF-8 support to apps. If the ANSI code page is configured for UTF-8, -A APIs operate in UTF-8. This model has the benefit of supporting existing code built with -A APIs without any code changes. </p>
<h2>Code page conversion</h2>
<p><strong>As Windows operates natively in UTF-16 (<code>WCHAR</code>), you might need to convert UTF-8 data to UTF-16 (or vice versa) to interoperate with Windows APIs.</strong></p>
<p>...</p>
</blockquote>



<a name="275121046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275121046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275121046">(Mar 12 2022 at 22:55)</a>:</h4>
<p>(Also of note is that some parts of User32 (which the stdlib likely doesn't interact with, but might) will remember if your program uses the A or W variant and then other functions that don't even have A/W variants will still be affected by your previous choice.)</p>



<a name="275121481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275121481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275121481">(Mar 12 2022 at 23:06)</a>:</h4>
<p>Oh, dear. That sounds rife with problems when it comes to different modules!</p>



<a name="275124570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275124570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275124570">(Mar 13 2022 at 00:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/275121046">said</a>:</p>
<blockquote>
<p>(Also of note is that some parts of User32 (which the stdlib likely doesn't interact with, but might) will remember if your program uses the A or W variant and then other functions that don't even have A/W variants will still be affected by your previous choice.)</p>
</blockquote>
<p>Details on that, if you have them?</p>



<a name="275129555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275129555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275129555">(Mar 13 2022 at 03:01)</a>:</h4>
<p>Fundamentally I don't see what the difference is between doing a lossy conversion implicitly and doing it explicitly. The arguments for and against are the same either way.</p>
<p>If lossy conversion is OK then we can do that today. No need to wait or mess about detecting the code page. If lossy conversion is not OK today then I'm not sure what changes by making that conversion implicit?</p>



<a name="275130219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275130219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275130219">(Mar 13 2022 at 03:19)</a>:</h4>
<p>WRT implicitness vs. explicitness here, I don't have a strong opinion on which option to take, but I do think it'd be helpful to clarify with alternate terminology a la @withoutboats' <a href="https://boats.gitlab.io/blog/post/2017-12-27-things-explicit-is-not/">"Not Explicit" blog post</a>.</p>



<a name="275130792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275130792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275130792">(Mar 13 2022 at 03:35)</a>:</h4>
<p>By "implicit" I simply mean that the OS calls the equivalent of String::from_utf16_lossy for us. Whereas by "explicit" I mean that the stdlib implementation has to actually type out String::from_utf16_lossy itself.</p>



<a name="275130845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275130845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275130845">(Mar 13 2022 at 03:37)</a>:</h4>
<p>I do not currently see any real difference between the two.</p>



<a name="275131644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275131644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275131644">(Mar 13 2022 at 04:00)</a>:</h4>
<p>IMO that would fit under the "Explicit is not local" section in the blog post. IIUC you're effectively stating that you don't see _local_ indicators of encoding conversion as valuable as something else. Sounds like a valid opinion to me.</p>
<p>Is that to avoid being burdensome for <code>std</code> maintainers specifically?</p>
<p>When you say "no difference", do you mean for <code>std</code> maintainers, for users of <code>std</code>, both, or some other audience(s)?</p>



<a name="275132090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275132090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275132090">(Mar 13 2022 at 04:10)</a>:</h4>
<p>I mean in effect. Doing a lossy conversion has the same effect however it is done.</p>



<a name="275132167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275132167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275132167">(Mar 13 2022 at 04:12)</a>:</h4>
<p>Currently we do not do lossy conversions so switching to lossy has an effect. But how that change is implemented does not, IMHO.</p>



<a name="275133529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275133529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275133529">(Mar 13 2022 at 04:53)</a>:</h4>
<p>does windows actually use WTF-8? if you have a file with an unpaired surrogate as the name, do the *A APIs just return an error?</p>



<a name="275133605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275133605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275133605">(Mar 13 2022 at 04:55)</a>:</h4>
<p>No they do a lossy conversion to/from UTF-16</p>



<a name="275140722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275140722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275140722">(Mar 13 2022 at 08:08)</a>:</h4>
<p>How specifically do they do that, though?  Windows usually takes WTF-16, not actually UTF-16, because its UCS2 history means it doesn't enforce surrogate pairing.</p>



<a name="275157468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275157468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275157468">(Mar 13 2022 at 14:35)</a>:</h4>
<p>I'm curious about that as well; how does Windows handle bad UTF-16 internally? Does it just not do any validation?</p>



<a name="275159812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275159812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275159812">(Mar 13 2022 at 15:21)</a>:</h4>
<p>Yes, it doesn't do any validation. The whole UCS-2 thing is a bit of a red herring in this. It's UTF-16 but the kernel itself doesn't do checks. It didn't check for valid UCS-2 either back when that was a thing.</p>



<a name="275185927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275185927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275185927">(Mar 14 2022 at 01:29)</a>:</h4>
<p>Yes, you are strongly encouraged to only <em>give</em> UTF-16 to Windows, but at the same time be ready to <em>take</em> any sequence of <code>u16</code> data. In some cases you need to just keep that value and pass it back at the correct time (eg: a file name) and so it doesn't really matter that it's not well formed UTF-16 data anyway. If you need to display it to the user, unfortunately "that's your problem", because if you replace the bad <code>u16</code> pairs with the unknown character (for example) then you're not showing them the actual file name that had the problem. Then again one might also call that a rare enough occurrence that you just don't worry about it.</p>



<a name="275186117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275186117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275186117">(Mar 14 2022 at 01:34)</a>:</h4>
<p>Yeah, to be clear I'm not meaning to argue for or against making a change here, just to make it clear that using the <code>A</code> functions (with the UTF-8 code page) isn't a silver bullet. It's no different from doing lossy conversions using the <code>W</code> functions.</p>
<p>Personally I've gone back and forth on the UTF-8 issue myself. On the one hand it would certainly make life easier for everyone if we only used valid unicode. On the other hand, it would mean someone could (if they misused the <code>W</code> apis) create a file that the Rust stdlib can't open. On the third hand, it is fairly common for software to be unable to handle such paths. Especially cross platform software.</p>



<a name="275187735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275187735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275187735">(Mar 14 2022 at 02:17)</a>:</h4>
<p>It's also fairly common for software to have UB, but we try our best to rise above that ;3</p>



<a name="275187799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275187799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275187799">(Mar 14 2022 at 02:18)</a>:</h4>
<p>ha, true.</p>



<a name="275187826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275187826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275187826">(Mar 14 2022 at 02:20)</a>:</h4>
<p>We just need another string type for properly supported utf16. Because rust doesn't have enough string types in its standard library.</p>



<a name="275188309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275188309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275188309">(Mar 14 2022 at 02:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/275124570">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/275121046">said</a>:</p>
<blockquote>
<p>(Also of note is that some parts of User32 (which the stdlib likely doesn't interact with, but might) will remember if your program uses the A or W variant and then other functions that don't even have A/W variants will still be affected by your previous choice.)</p>
</blockquote>
<p>Details on that, if you have them?</p>
</blockquote>
<p>The most obvious sign of this is the existence of <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-iswindowunicode"><code>IsWindowUnicode</code></a>, and the fact that interacting with HWNDs with a mixture of *A and *W fns is a recipe for pain and suffering and corruption</p>



<a name="275188579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275188579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275188579">(Mar 14 2022 at 02:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/275140722">said</a>:</p>
<blockquote>
<p>How specifically do they do that, though?  Windows usually takes WTF-16, not actually UTF-16, because its UCS2 history means it doesn't enforce surrogate pairing.</p>
</blockquote>
<p>Varies by API and OS version.  Internally, windows will be heavily leaning on:<br>
<a href="https://docs.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-multibytetowidechar"><code>MultiByteToWideChar</code></a><br>
<a href="https://docs.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-widechartomultibyte"><code>WideCharToMultiByte</code></a><br>
both of which have flags which let you opt-in to conversion errors instead of <code>U+FFFD</code> placeholders:<br>
<code>MB_ERR_INVALID_CHARS</code><br>
<code>WC_ERR_INVALID_CHARS</code><br>
which when used, will result in failing with:<br>
<code>ERROR_NO_UNICODE_TRANSLATION</code><br>
note from the errata of those functions that on e.g. 2k/XP, MultiByteToWideChar can simply <em>drop</em> the invalid codepoints without placeholders if you're not using the flag.</p>



<a name="275188639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275188639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275188639">(Mar 14 2022 at 02:38)</a>:</h4>
<p>also, <code>WC_ERR_INVALID_CHARS</code>:</p>
<blockquote>
<p>... only applies when CodePage is specified as CP_UTF8 or 54936. It cannot be used with other code page values.</p>
</blockquote>



<a name="275188660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275188660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275188660">(Mar 14 2022 at 02:39)</a>:</h4>
<p>On the plus side, <code>U+FFFD</code> is the same replacement character that Rust uses, so at least that would line up</p>



<a name="275189121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275189121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275189121">(Mar 14 2022 at 02:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F/near/275187826">said</a>:</p>
<blockquote>
<p>We just need another string type for properly supported utf16. Because rust doesn't have enough string types in its standard library.</p>
</blockquote>
<p>If I needed an existing type today, <a href="https://docs.rs/widestring/latest/widestring/ucstring/struct.UCString.html"><code>widestring::U16CString</code></a>.  When I checked out 0.4.x the handling of <code>\0</code>s was a bit muddled, but my issue about that was mentioned in refactoring and then closed, and 0.5.x is out, so I should revisit the crate to refresh my opinion on that... &lt;<a href="https://github.com/starkat99/widestring-rs/issues/18">https://github.com/starkat99/widestring-rs/issues/18</a>&gt;</p>



<a name="275189377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275189377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275189377">(Mar 14 2022 at 02:57)</a>:</h4>
<p>Just do <code>BasicStr</code>/<code>BasicString</code>/<code>BasicCStr</code>/<code>BasicCString</code> at this point.</p>



<a name="275191003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275191003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275191003">(Mar 14 2022 at 03:37)</a>:</h4>
<p>For the lowest hanging fruit to misinterpret your window text by mixing A and W fns without a single compile-time type error:</p>
<ul>
<li><code>RegisterClassExW</code> a class that uses <code>DefWindowProcA</code> by default or as a fallback</li>
<li><code>CreateWindowEx{A,W}</code> or <code>SetWindowText{A,W}</code> will (re-)encode the window title as UTF16 to match the hwnd/class.</li>
<li><code>DefWindowProcA</code> will try to read the window title as UTF8 (despited the passed hwnd being 'unicode'), likely truncating the title after the first character.</li>
</ul>



<a name="275191152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Replace%20%60AsRef%3CPath%3E%60%20with%20a%20new%20trait%3F/near/275191152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MaulingMonkey <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Replace.20.60AsRef.3CPath.3E.60.20with.20a.20new.20trait.3F.html#275191152">(Mar 14 2022 at 03:41)</a>:</h4>
<p>Additionally, note that <code>GetMessage{A,W}</code> and <code>DispatchMessage{A,W}</code>, despite being differentiated into ANSI vs UNICODE, will handle messages like <code>WM_SETTEXT</code> and <code>WM_GETTEXT</code> bearing strings or target buffers as their <code>lparams</code> which will be encoded based on their target hwnd class unicodeishness, which isn't necessairly the same as the encoding the function name would imply</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>