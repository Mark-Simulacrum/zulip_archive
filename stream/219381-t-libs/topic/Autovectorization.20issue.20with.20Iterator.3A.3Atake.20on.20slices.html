<html>
<head><meta charset="utf-8"><title>Autovectorization issue with Iterator::take on slices · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html">Autovectorization issue with Iterator::take on slices</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266196838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266196838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Redzic <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266196838">(Dec 27 2021 at 19:07)</a>:</h4>
<p>Currently there is an issue where <code>Iterator::take(size)</code> on slices is not autovectorized, when it is when indexed using <code>[..size]</code> (for example: <a href="https://godbolt.org/z/hqz6jMh33">https://godbolt.org/z/hqz6jMh33</a>)</p>
<p>How would one go about fixing this issue?</p>



<a name="266197536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266197536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266197536">(Dec 27 2021 at 19:18)</a>:</h4>
<p>try replacing <code>for ... in iter</code> with <code>iter.for_each</code></p>



<a name="266197820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266197820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Redzic <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266197820">(Dec 27 2021 at 19:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices/near/266197536">said</a>:</p>
<blockquote>
<p>try replacing <code>for ... in iter</code> with <code>iter.for_each</code></p>
</blockquote>
<p>Looks like that does cause it to autovectorize it (<a href="https://godbolt.org/z/1h4a5qnG9">https://godbolt.org/z/1h4a5qnG9</a>), however it seems like the loop is not unrolled as much as compared to <code>[..size]</code>. Shouldn't the same code be generated for all 3 versions?</p>



<a name="266198494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266198494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266198494">(Dec 27 2021 at 19:29)</a>:</h4>
<p>It would be nice if that were the case but iterator performance is heavily dependent on llvm optimizations and the IR generated by iterators is more complicated than direct slice accesses and sometimes the optimizer doesn't recognize the code patterns.<br>
Part of the purpose of <code>for_each</code> is that should be easier to optimize. If that still performs significantly worse in benchmarks that might be worth filing an issue.</p>



<a name="266247080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266247080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266247080">(Dec 28 2021 at 10:15)</a>:</h4>
<p>I could see a specialization on <code>Take</code> where <code>I: TrustedRandomAccessNoCoerce</code> or something like that</p>



<a name="266247151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266247151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266247151">(Dec 28 2021 at 10:16)</a>:</h4>
<p>Essentially computing the minimum between <code>I</code>'s length and the max length given to <code>Take</code> when <code>Take</code> is created</p>



<a name="266247275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266247275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266247275">(Dec 28 2021 at 10:18)</a>:</h4>
<p>Another possible optimization (but this might make things worse) is specializing <code>Take::fold</code> and friends on <code>I: ExactSizeIterator</code>, skipping <code>Take</code>'s checks if <code>I</code>'s size is smaller than <code>Take</code>'s max length, though this might result in <code>Take</code> yielding more items if <code>I</code> misbehaves</p>



<a name="266259888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/266259888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#266259888">(Dec 28 2021 at 13:39)</a>:</h4>
<p>ESI can't be used for specialization, only TrustedLen and TRA</p>



<a name="267502055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Autovectorization%20issue%20with%20Iterator%3A%3Atake%20on%20slices/near/267502055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices.html#267502055">(Jan 10 2022 at 21:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="422686">Redzic</span> <a href="#narrow/stream/219381-t-libs/topic/Autovectorization.20issue.20with.20Iterator.3A.3Atake.20on.20slices/near/266197820">said</a>:</p>
<blockquote>
<p>Shouldn't the same code be generated for all 3 versions?</p>
</blockquote>
<p>See &lt;<a href="https://medium.com/@veedrac/rust-is-slow-and-i-am-the-cure-32facc0fdcb">https://medium.com/@veedrac/rust-is-slow-and-i-am-the-cure-32facc0fdcb</a>&gt; for the usual reading material about the problem.</p>
<p>TLDR: internal iteration is just easier to optimize, so sometimes this happens.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>