<html>
<head><meta charset="utf-8"><title>How essential is the compile-time check for empty arrays? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html">How essential is the compile-time check for empty arrays?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="236721016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236721016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236721016">(Apr 29 2021 at 18:18)</a>:</h4>
<p>I've <a href="https://users.rust-lang.org/t/u16-slice-to-u8-iterator/59078/11?u=scottmcm">twice</a> <a href="https://github.com/bevyengine/bevy/pull/1966#discussion_r616169211">recently</a> seen people misusing <code>align_to</code> since it's the "easiest" way to turn slices into slices of different-sized elements.</p>
<p>I'd love to be able to suggest <a href="https://doc.rust-lang.org/nightly/std/primitive.slice.html#method.as_chunks"><code>as_chunks</code></a> instead, but it's unstable.  I'd normally just send a stabilization PR and ask for an FCP, but the <a href="https://github.com/rust-lang/rust/issues/74985#issue-670131723">tracking issue</a> says that it's currently blocked on a compile-time check for N==0, since it can't elegantly meet its postcondition in that case.</p>
<p>It seems like that's a long way off from being fixable, though.  Any thoughts on how essential that is, vs just doing the runtime <code>panic</code> it does today?  I'd certainly <em>rather</em> it not compile, but it's not like it's a subtle problem that is likely to slip past notice without the compiler error, nor is it something that causes perf problems.  So I'm tempted to say I'd rather have it stable with the panic than wait for <code>where N &gt; 0</code> to be allowed...</p>



<a name="236722386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236722386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236722386">(Apr 29 2021 at 18:28)</a>:</h4>
<blockquote>
<p>It seems like that's a long way off from being fixable, though.</p>
</blockquote>
<p>I personally think that using a compile time check is worth it here and in general would prefer to not stabilize this with a runtime check if we're going to  later add methods with compile time checks</p>



<a name="236722430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236722430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236722430">(Apr 29 2021 at 18:28)</a>:</h4>
<p>now, while we're a long time off from const wf bounds</p>



<a name="236722459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236722459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236722459">(Apr 29 2021 at 18:29)</a>:</h4>
<p>we are exactly 0 days off from being able to implement this as a fairly innocent hack</p>



<a name="236723098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236723098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236723098">(Apr 29 2021 at 18:33)</a>:</h4>
<p>add an attribute <code>#[rustc_non_zero_const_param(integer)]</code> which</p>



<a name="236723131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236723131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236723131">(Apr 29 2021 at 18:33)</a>:</h4>
<ul>
<li>requires const arguments instantiating the parameter to be fully concrete</li>
</ul>



<a name="236723155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236723155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236723155">(Apr 29 2021 at 18:33)</a>:</h4>
<ul>
<li>and causes an error if the argument is equal to 0</li>
</ul>



<a name="236723433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236723433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236723433">(Apr 29 2021 at 18:35)</a>:</h4>
<p>this would prevent users from using <code>as_chunks</code> with a generic <code>N</code> until we've either decided that this doesn't has to be a compile time bound or const wf bounds are close enough to stable</p>



<a name="236723480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236723480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236723480">(Apr 29 2021 at 18:35)</a>:</h4>
<p>which imo is a good way to postpone this decision while still getting most of the benefits of having this method on stable</p>



<a name="236724241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236724241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236724241">(Apr 29 2021 at 18:40)</a>:</h4>
<p>if this is desirable i can either implement this in the <em>fairly near</em>(a few weeks) future or mentor immediately if someone is interested in working on this</p>



<a name="236728783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236728783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236728783">(Apr 29 2021 at 19:11)</a>:</h4>
<p>Another option is to make this a deny-by-default lint, which is less hacky but doesn't prevent generic parameters</p>



<a name="236728864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236728864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236728864">(Apr 29 2021 at 19:12)</a>:</h4>
<p>(And of course, means that make it a hard error isn't backwards compatible, which might be unsatisfactory)</p>



<a name="236732868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236732868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236732868">(Apr 29 2021 at 19:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F/near/236728864">said</a>:</p>
<blockquote>
<p>(And of course, means that make it a hard error isn't backwards compatible, which might be unsatisfactory)</p>
</blockquote>
<p>yeah, while i except us to not necessarily end up with erroring here in the end, i do want to keep that option</p>



<a name="236746179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236746179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236746179">(Apr 29 2021 at 21:07)</a>:</h4>
<p>I'd be willing to make an attempt at this.  It's been a while since I added an attribute, though, so some pointers to where I should put these things and how I should check it would be appreciated.</p>



<a name="236751861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236751861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236751861">(Apr 29 2021 at 21:39)</a>:</h4>
<p>you could look at my recent <code>rustc_skip_array_during_method_dispatch</code>: <a href="https://github.com/rust-lang/rust/pull/84147/commits/b79af2fcde91abeae805c2dbccfdbf7114bfd47b">https://github.com/rust-lang/rust/pull/84147/commits/b79af2fcde91abeae805c2dbccfdbf7114bfd47b</a></p>



<a name="236751895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236751895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236751895">(Apr 29 2021 at 21:39)</a>:</h4>
<p>most of that boiler-plate is for the stored metadata though, not the attribute itself</p>



<a name="236761012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236761012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236761012">(Apr 29 2021 at 23:07)</a>:</h4>
<p>You could also use the <code>static_assert!</code> hack that stdarch is using. The error message is pretty bad though.</p>



<a name="236761065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236761065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236761065">(Apr 29 2021 at 23:07)</a>:</h4>
<p><a href="https://github.com/rust-lang/stdarch/blob/6cec76beed3d1d27c1b88826a0e5d8142f836d66/crates/core_arch/src/macros.rs#L69">https://github.com/rust-lang/stdarch/blob/6cec76beed3d1d27c1b88826a0e5d8142f836d66/crates/core_arch/src/macros.rs#L69</a></p>



<a name="236814312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236814312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236814312">(Apr 30 2021 at 10:27)</a>:</h4>
<p>that one also doesn't apply for <code>cargo check</code> though <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> as the errors happen during mono item collection</p>



<a name="236814440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236814440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236814440">(Apr 30 2021 at 10:28)</a>:</h4>
<p>it might have been sensible to use the same hack for stdarch <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> might not be possible though</p>



<a name="236814520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236814520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236814520">(Apr 30 2021 at 10:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F/near/236746179">said</a>:</p>
<blockquote>
<p>I'd be willing to make an attempt at this.  It's been a while since I added an attribute, though, so some pointers to where I should put these things and how I should check it would be appreciated.</p>
</blockquote>
<p>so i except this to be very similar to <code>rustc_args_required_const</code>, except that the actual error reporting should probably happen somewhere else</p>



<a name="236815472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236815472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236815472">(Apr 30 2021 at 10:38)</a>:</h4>
<p>it probably makes sense to reuse <code>rustc_passes::intrinsicck</code>, though the name is incorrect here <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="236816364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236816364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236816364">(Apr 30 2021 at 10:46)</a>:</h4>
<p>I think we could change the  <code>ExprVisitor</code>+ <code>ItemVisitor</code> combination to be generic over the behavior of the <code>ExprVisitor</code> and add a new pass reusing that impl.</p>
<p>We probably want to start with only allowing that attribute on methods and functions. This means we only have to check <code>hir::ExprKind::Path</code> and <code>hir::ExprKind::MethodCall</code> afaik</p>



<a name="236832750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236832750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236832750">(Apr 30 2021 at 13:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F/near/236814440">said</a>:</p>
<blockquote>
<p>it might have been sensible to use the same hack for stdarch <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> might not be possible though</p>
</blockquote>
<p>The stdarch changes still haven't been merged yet, so it's still possible to change.</p>



<a name="236846068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236846068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236846068">(Apr 30 2021 at 14:51)</a>:</h4>
<p>hmm <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> i guess the question is whether is stdarch fine with not allowing const params as arguments?</p>



<a name="236846102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/236846102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#236846102">(Apr 30 2021 at 14:51)</a>:</h4>
<p>also not too sure what's the best way to extend this attribute to accept more complex conditions than just =! 0</p>



<a name="248387761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/248387761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#248387761">(Aug 04 2021 at 18:20)</a>:</h4>
<p>so, i did implement the attribute for functions and methods: <a href="https://github.com/lcnr/rust/commit/f99922d91ee19022a636d3cf53559771ae14f1c0">https://github.com/lcnr/rust/commit/f99922d91ee19022a636d3cf53559771ae14f1c0</a></p>



<a name="248387965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/248387965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#248387965">(Aug 04 2021 at 18:22)</a>:</h4>
<p>i still have to figure out a way to extend this to types as well, to prevent users from writing <code>ArrayChunks&lt;0&gt;</code> or something. I could move all of this to wf and verify it while typechecking, but that seems kinda ugly <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="248387991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/248387991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#248387991">(Aug 04 2021 at 18:22)</a>:</h4>
<p>going to open a thread about that in <code>t-compiler</code></p>



<a name="248388485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/248388485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#248388485">(Aug 04 2021 at 18:26)</a>:</h4>
<p>cross ref <a href="#narrow/stream/131828-t-compiler/topic/checking.20generic.20arg.20!.3D.200/near/248388441">https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/checking.20generic.20arg.20!.3D.200/near/248388441</a></p>



<a name="249010429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/249010429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#249010429">(Aug 10 2021 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F/near/248387965">said</a>:</p>
<blockquote>
<p>i still have to figure out a way to extend this to types as well</p>
</blockquote>
<p>Ooh, thanks for making this!  The <code>.as_chunks()</code> calls just return slices of arrays, so they don't need the check for types, so I'll make a task for me to try out the attribute on the method and see what libs-api thinks about maybe stabilizing.</p>



<a name="249937316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/249937316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#249937316">(Aug 19 2021 at 03:19)</a>:</h4>
<p>It's probably been discussed at some point, but would it make more sense to implement <code>#[rustc_generic_arg_non_zero]</code>as a trait bound?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">as_chunks_mut</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="cm">/* snip */</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">()</span>: <span class="nc">NonZero</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">NonZero</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="c1">// NonZero&lt;N&gt; is sealed, with impls generated by compiler magic, but equivalent to the following:</span>
<span class="k">impl</span><span class="w"> </span><span class="n">NonZero</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">NonZero</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">NonZero</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="k">impl</span><span class="w"> </span><span class="n">NonZero</span><span class="o">&lt;</span><span class="p">{</span><span class="kt">usize</span>::<span class="n">MAX</span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>Having a trait seems like it might provide slightly better internal consistency than "this function can't be called with this specific argument due to magic", and maybe it could be compatibly replaced with a <code>where N != 0</code> bound on the method in the future, if the same <code>N != 0</code> bound is also added to the <code>NonZero</code> trait.</p>



<a name="249937680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/249937680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#249937680">(Aug 19 2021 at 03:26)</a>:</h4>
<p>It could result in some user code referencing <code>NonZero</code> in its own generic bounds (e.g. in order to pass an argument through to <code>as_chunks_mut</code>), but that seems like it wouldn't be that bad? Especially if those generics are actually required to be non-zero, and there is a compatible migration path to the cleaner version <code>where N != 0</code> when/if full const generics ship.</p>



<a name="249938729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/249938729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#249938729">(Aug 19 2021 at 03:49)</a>:</h4>
<p>I think that since it's just a hack, the attribute is fine.  I definitely wouldn't want to stabilize it that way, but I got no impression that that would be the plan.</p>
<p>(I'm not sure it's worth making a maybe-slightly-better hack.  Might be fine to just wait for the "real" solution.)</p>



<a name="249939993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/249939993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#249939993">(Aug 19 2021 at 04:15)</a>:</h4>
<p>I have no real objection to the hack (being able to call the method with generic parameters is nice, but not being able to do so is still better than nothing). That said, it seems like this hasn't been making much progress and I wondered if that was due to a lack of consensus as a result of how hacky the approach is.</p>



<a name="249940318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/249940318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#249940318">(Aug 19 2021 at 04:23)</a>:</h4>
<p>Re. "I definitely wouldn't want to stabilize it that way" -- to be clear, I am trying to figure out how it could be stabilized (before full const generics is available).</p>



<a name="250007648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250007648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250007648">(Aug 19 2021 at 16:04)</a>:</h4>
<p>Could that type be used to help <code>Default</code> impl for arrays as well?</p>



<a name="250053725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250053725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250053725">(Aug 19 2021 at 21:48)</a>:</h4>
<p>It seems like it possibly could, if the compiler magic used to implement <code>NonZero</code> was smart enough to notice that it doesn't overlap with 0.</p>
<p>There's probably a separate concern in that "traits on the unit type" is clearly not the ideal way to have bounds on const generics, and if it becomes widespread, it could result in a messier ecosystem than if we just waited for actual first-class bounds. On the other hand, maybe it's better than the workaround in which everyone skips the bounds entirely and pushes the errors all the way to runtime.</p>



<a name="250054067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250054067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250054067">(Aug 19 2021 at 21:52)</a>:</h4>
<p>For instance, if someone asked why we have a magic <code>NonZero</code> trait but not a <code>GreaterThanFive</code> trait, I'm not sure I would have a compelling answer</p>



<a name="250055592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250055592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250055592">(Aug 19 2021 at 22:08)</a>:</h4>
<p>Well, it could be instead, say, <code>LengthNotZero</code> trait for <code>[T; N]</code>, just like we previously do for <code>LengthAtMost32</code></p>



<a name="250055975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250055975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250055975">(Aug 19 2021 at 22:13)</a>:</h4>
<p><code>LengthAtMost32</code> isn't ever going to be stable though, IIUC</p>



<a name="250056022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250056022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250056022">(Aug 19 2021 at 22:13)</a>:</h4>
<p>Well, it's gone already. I am replying to the "traits on the unit type" thing</p>



<a name="250324205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250324205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250324205">(Aug 23 2021 at 08:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="392468">Teddy Katz</span> <a href="#narrow/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F/near/250054067">said</a>:</p>
<blockquote>
<p>For instance, if someone asked why we have a magic <code>NonZero</code> trait but not a <code>GreaterThanFive</code> trait, I'm not sure I would have a compelling answer</p>
</blockquote>
<p>Probably the same reason we have a <code>NonZeroU32</code> type <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.23.5Brustc_layout_scalar_valid_range_start.5D.html#247823448">but not</a> a <code>GreaterThanFiveU32</code> type :P</p>



<a name="250341754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250341754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250341754">(Aug 23 2021 at 12:05)</a>:</h4>
<p>We do have a NonMinusOneI32 type on unix though (<code>File</code> ^^)</p>



<a name="250343381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250343381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250343381">(Aug 23 2021 at 12:22)</a>:</h4>
<p><code>&amp;u16 as *const u16 as usize</code> technically is an <code>EvenUsize</code> <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="250344086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250344086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250344086">(Aug 23 2021 at 12:28)</a>:</h4>
<p>Actually a wrapper <code>Aligned&lt;T&gt;(*mut T)</code> with that property might be quite useful.<br>
Especially for re-using the bits. For real performance gains, however, the problems plaguing NonZero* would need to be addressed.<br>
Afaik there is some issue where llvm only realizes the bit properties when it loads from a pointer, not when passed by value?</p>



<a name="250535560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250535560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250535560">(Aug 24 2021 at 19:25)</a>:</h4>
<p>I guess the difference between a <code>GreaterThanFive&lt;const N: usize&gt;</code> trait and a <code>GreaterThanFiveUSize</code> type is that the latter is implementable in user code on stable right now, but the former isn't, unless your code includes (2**64 - 6) individual impls. In other words, having <code>NonZeroUSize</code> in the standard library doesn't inherently grant any new capabilities, whereas a <code>NonZero&lt;const N: usize&gt;</code> trait would, which calls for more caution when adding it.</p>



<a name="250535858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/250535858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#250535858">(Aug 24 2021 at 19:28)</a>:</h4>
<p>That said, if a <code>NonZero</code> trait could get stabilized before <code>const_evaluatable_checked</code> despite this, I wouldn't complain.</p>



<a name="263802759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263802759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263802759">(Dec 06 2021 at 02:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F/near/248387761">said</a>:</p>
<blockquote>
<p>so, i did implement the attribute for functions and methods: <a href="https://github.com/lcnr/rust/commit/f99922d91ee19022a636d3cf53559771ae14f1c0">https://github.com/lcnr/rust/commit/f99922d91ee19022a636d3cf53559771ae14f1c0</a></p>
</blockquote>
<p>Hi, <span class="user-mention" data-user-id="216206">@lcnr</span>!  I'm still interested in this attribute, and don't need the type version.  (Since I'm more interested in <code>.as_chunks</code> than <code>ArrayChunks</code>.)</p>
<p>It looks like it didn't get checked in?  Is it in a place where I could try to pick it up and get it merged?</p>



<a name="263823996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263823996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263823996">(Dec 06 2021 at 09:15)</a>:</h4>
<p>i think that should be mostly ready for for merge <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> don't 100% remember</p>



<a name="263919582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263919582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263919582">(Dec 06 2021 at 20:23)</a>:</h4>
<p>Could we use post-mono checking for this?</p>



<a name="263919971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263919971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263919971">(Dec 06 2021 at 20:26)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">AssertNonZero</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AssertNonZero</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VAL</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">assert!</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">array</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AssertNonZero</span>::<span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span>::<span class="n">VAL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">array</span>::<span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">array</span>::<span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">//^~ ERROR</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="263923182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263923182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263923182">(Dec 06 2021 at 20:56)</a>:</h4>
<p>Wow, that even works on stable.  I had no idea.</p>



<a name="263923480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263923480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263923480">(Dec 06 2021 at 20:58)</a>:</h4>
<p>Panic in const context was just stabilized.</p>



<a name="263929248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263929248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263929248">(Dec 06 2021 at 21:46)</a>:</h4>
<p>post-monomorphization errors will not trigger easily for code coming from dependencies though, and it seems likely that a check build would not trigger the PME for the <code>array::&lt;0&gt;()</code> call if it were in a different crate (which seems problematic for libcore), while a build involving codegen would indeed fail with the PME</p>



<a name="263929735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263929735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263929735">(Dec 06 2021 at 21:51)</a>:</h4>
<p>Post-mono also means this couldn't become a <code>where N != 0</code> bound in future, right?  Since that would break stuff that wrote it but didn't mono it?</p>



<a name="263931671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/263931671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#263931671">(Dec 06 2021 at 22:07)</a>:</h4>
<p>I would believe so. your + lcnr's <code>rustc_generic_arg_non_zero</code> would fare better in that regard at least</p>



<a name="264500793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/How%20essential%20is%20the%20compile-time%20check%20for%20empty%20arrays%3F/near/264500793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/How.20essential.20is.20the.20compile-time.20check.20for.20empty.20arrays.3F.html#264500793">(Dec 10 2021 at 20:04)</a>:</h4>
<p>Similar patterns work for quite a lot of compile time properties on stable. Including, but not limited, testing a pair of types for equal layout (permitting reusing Vec and Box storage), testing for zero-sized types, asserting trivial drop, working around not being allowed to use trait bounds in const-impl for 'empty' marker traits like Zeroable/Pod/etc., probably some stuff I forgot. And, unilke <code>where</code>, it is not infectious. There's a trade-off in post-monomorphization errors but it is truly a tradeoff in that it has upsides. Should the pattern be endorsed or not?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>