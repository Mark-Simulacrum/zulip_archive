<html>
<head><meta charset="utf-8"><title>Read::buf_read signature · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html">Read::buf_read signature</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274099472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274099472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274099472">(Mar 04 2022 at 09:06)</a>:</h4>
<p>Split off from <a href="#narrow/stream/219381-t-libs/topic/ReadBuf.20API/near/273965148">https://rust-lang.zulipchat.com/#narrow/stream/219381-t-libs/topic/ReadBuf.20API/near/273965148</a></p>



<a name="274099518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274099518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274099518">(Mar 04 2022 at 09:06)</a>:</h4>
<p>Open question: <a href="https://github.com/rust-lang/rfcs/pull/2930#issuecomment-688933597">https://github.com/rust-lang/rfcs/pull/2930#issuecomment-688933597</a></p>



<a name="274099825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274099825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274099825">(Mar 04 2022 at 09:09)</a>:</h4>
<p>Which I think comes down to should the buffer type be <code>&amp;mut ReadBuf</code> or <code>ReadBufRef</code>. The latter prevents the callee swapping out the buffer for a different one, but requires an extra type, and makes for slightly more boilerplate to set up the buffer</p>



<a name="274100024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274100024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274100024">(Mar 04 2022 at 09:11)</a>:</h4>
<p>The motivation (aiui) is that if the implementation is malicious and the caller keeps the initialised length across the call, then they might accidentally access uninitialised memory.</p>



<a name="274100506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274100506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274100506">(Mar 04 2022 at 09:16)</a>:</h4>
<p>To me, this seems unlikely. The fact that the caller is passing a &amp;mut reference in to the read call means they shouldn't rely on a property of the <br>
buffer from before the call, rather they should interact with the buffer using only its methods and state after the call. Furthermore, this problem only arises if the implementation of read is actively malicious, and I think in general we do not try to protect against such a case (it seems impossible to do so since a malicious impl could always just use unsafe code to do whatever they want).</p>



<a name="274101276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274101276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274101276">(Mar 04 2022 at 09:22)</a>:</h4>
<p>This protects against accidental errors and potential unsound usage.<br>
These two arguments are in my opinion more than enough compared to the disadvantages.</p>



<a name="274101884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274101884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274101884">(Mar 04 2022 at 09:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274101276">said</a>:</p>
<blockquote>
<p>This protects against accidental errors and potential unsound usage.</p>
</blockquote>
<p>AIUI, there is no actual unsoundness, just a footgun which is fairly easy to avoid (i.e., its only a footgun if you assume a mutable reference will not in fact be mutated which IMO is an unreasonable assumption). And it doesn't protect against accidental errors, only deliberate ones, again AIUI.</p>



<a name="274103018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103018">(Mar 04 2022 at 09:35)</a>:</h4>
<p>The unsoudness I was referring is in the consumer not in the implementation of a <code>read_buf</code>, which would be painful and difficult to debug.<br>
You could have a method that does some things with a <code>&amp;mut ReadBuf</code> then accidentally replacing the buffer maybe with a opaque macro; there are may cases where it could append accidentally.</p>



<a name="274103240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103240">(Mar 04 2022 at 09:36)</a>:</h4>
<p>Btw <a href="https://github.com/rust-lang/rust/issues/93305">https://github.com/rust-lang/rust/issues/93305</a> reports it as unsound.</p>



<a name="274103245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103245">(Mar 04 2022 at 09:37)</a>:</h4>
<p>Yeah, I understand the unsoundness is in the consumer, but I don't think it is actually unsound :-)  Could you give an example of how you think an issue could occur?</p>



<a name="274103558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103558">(Mar 04 2022 at 09:39)</a>:</h4>
<p>Reasoning it out:<br>
In general, anytime entirely safe code can cause the invocation of UB, that's a soundness bug.<br>
This includes if the safe code can cause unsafe code to invoke UB.<br>
Thus, unsafe code can't rely on assumptions that safe code won't do a thing that it's capable of doing, if violating those assumptions would lead to UB.</p>



<a name="274103626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103626">(Mar 04 2022 at 09:40)</a>:</h4>
<p>In this case, entirely safe code can cause the reading of uninitialized memory.</p>



<a name="274103632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103632">(Mar 04 2022 at 09:40)</a>:</h4>
<p>Well I guess it depends if you consider accessing uninit memory as unsound. If that's the case the issue as an example.</p>



<a name="274103687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274103687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274103687">(Mar 04 2022 at 09:41)</a>:</h4>
<p>That's leaving aside that I personally <em>do</em> think that reading uninitialized memory shouldn't be undefined behavior, but...yes, exactly. If you <em>do</em> consider that UB, which our current definitions do, then read_buf is unsound with just <code>&amp;mut ReadBuf</code>.</p>



<a name="274104247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104247">(Mar 04 2022 at 09:45)</a>:</h4>
<p>I think there is a missing step in that reasoning in that it is only unsound if the programmer doesn't make a mistake, like if I write <code>unsafe { buf.set_len(42); }</code> that is not unsoundness its just a mistake</p>



<a name="274104373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104373">(Mar 04 2022 at 09:46)</a>:</h4>
<p>In this case it is the same thing, the programmer is assuming that the underlying buffer and the read buf are the same, which is not guaranteed after passing a &amp;mut ref to the read buf to another function</p>



<a name="274104438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104438">(Mar 04 2022 at 09:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104247">said</a>:</p>
<blockquote>
<p>I think there is a missing step in that reasoning in that it is only unsound if the programmer doesn't make a mistake, like if I write <code>unsafe { buf.set_len(42); }</code> that is not unsoundness its just a mistake</p>
</blockquote>
<p>It's still unsoundness if you provide a safe interface that can result in calling set_len incorrectly.</p>



<a name="274104444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104444">(Mar 04 2022 at 09:47)</a>:</h4>
<p>So this is a programming mistake, not unsoundess. The question is whether the programming mistake is a reasonable one. It kind of is, so this is a footgun</p>



<a name="274104595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104595">(Mar 04 2022 at 09:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104438">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104247">said</a>:</p>
<blockquote>
<p>I think there is a missing step in that reasoning in that it is only unsound if the programmer doesn't make a mistake, like if I write <code>unsafe { buf.set_len(42); }</code> that is not unsoundness its just a mistake</p>
</blockquote>
<p>It's still unsoundness if you provide a safe interface that can result in calling set_len incorrectly.</p>
</blockquote>
<p>I don't follow. <code>set_len</code> is unsafe, setting it incorrectly is easy, just set it to something wrong. In this case, it is being set to something that is not guaranteed by the API in any way</p>



<a name="274104620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104620">(Mar 04 2022 at 09:49)</a>:</h4>
<p>It's just as wrong as setting it to 42</p>



<a name="274104954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274104954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274104954">(Mar 04 2022 at 09:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104595">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104438">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104247">said</a>:</p>
<blockquote>
<p>I think there is a missing step in that reasoning in that it is only unsound if the programmer doesn't make a mistake, like if I write <code>unsafe { buf.set_len(42); }</code> that is not unsoundness its just a mistake</p>
</blockquote>
<p>It's still unsoundness if you provide a safe interface that can result in calling set_len incorrectly.</p>
</blockquote>
<p>I don't follow. <code>set_len</code> is unsafe, setting it incorrectly is easy, just set it to something wrong.</p>
</blockquote>
<p>Since <code>set_len</code> is <code>unsafe</code>, you normally can't call it except from <code>unsafe</code> code. Calling it incorrectly in unsafe code isn't automatically a soundness issue, but calling it incorrectly in unsafe code with a safe interface is unsound.</p>



<a name="274105172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105172">(Mar 04 2022 at 09:54)</a>:</h4>
<p>Sure, so in the case of the issue, using <code>io::copy_to</code> is unsound, but that is due to an error with the implementation, not because the API of BufReader or buf_read is unsound, that is just a footgun that led to the unsoundness</p>



<a name="274105322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105322">(Mar 04 2022 at 09:55)</a>:</h4>
<p>I think I'm confused about the distinction you're making. But in any case, it sounds like you're still agreeing that it's a footgun.</p>



<a name="274105364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105364">(Mar 04 2022 at 09:55)</a>:</h4>
<p>And I don't think we want people to have to go out of their way to avoid that footgun.</p>



<a name="274105384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105384">(Mar 04 2022 at 09:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104373">said</a>:</p>
<blockquote>
<p>In this case it is the same thing, the programmer is assuming that the underlying buffer and the read buf are the same, which is not guaranteed after passing a &amp;mut ref to the read buf to another function</p>
</blockquote>
<p>That's the problem, it's not guaranteed but it should be!</p>



<a name="274105532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105532">(Mar 04 2022 at 09:57)</a>:</h4>
<p>So, the distinction I'm making is that the signature of Read::buf_read is not a soundness problem, it is potentially a footgun, but I think it is an important distinction because we <em>must</em> fix unsoundness, fixing footguns is a tradeoff question</p>



<a name="274105761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105761">(Mar 04 2022 at 09:58)</a>:</h4>
<p>I don't think I'm suggesting that <code>ReadBuf</code> or <code>read_buf</code> is unsound. I'm suggesting that the usage in <code>io::copy</code> seems to make <code>io::copy</code> unsound, and that what we'd have to do to fix that we shouldn't have to do.</p>



<a name="274105828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274105828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274105828">(Mar 04 2022 at 09:59)</a>:</h4>
<p>And I expect others to make exactly the same "mistake".</p>



<a name="274106027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274106027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274106027">(Mar 04 2022 at 10:00)</a>:</h4>
<p>And it is only a footgun in the presence of actively malicious code. If we change from <code>&amp;mut ReadBuf</code> to <code>ReadBufRef</code>,  a malicious read impl could still cause an error by transmuting the ReadBuf and just setting the init length to something untrue.</p>



<a name="274106282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274106282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274106282">(Mar 04 2022 at 10:01)</a>:</h4>
<p><code>transmute</code> is unsafe, and it's not unsound to rely on people not doing incorrect things in unsafe code.</p>



<a name="274106472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274106472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274106472">(Mar 04 2022 at 10:03)</a>:</h4>
<p><code>ReadBufRef</code> means it's no longer possible (as far as we know) to write <em>safe</em> code that violates the assumptions of unsafe code in callers that leads to UB.</p>



<a name="274106858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274106858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274106858">(Mar 04 2022 at 10:06)</a>:</h4>
<p>So, I'm not sure I understand the constraints on what is acceptable. Lets ignore copy_to for now because that is just a bug and we all agree it needs to be fixed. For buf_read, there is the caller and the implementer. It seems that there is only an issue if the caller makes a logic error (assuming something mutable is in fact immutable) and if the implementer is being actively malicious. Currently they can be actively malicious with only safe code, by changing to BufReadRef we eliminate the possibility of the caller making the logic error. And now to cause an error the malicious implementer must use unsafe code in their impl. This seems to me like a technicality since the presence of unsafe code in an IO method  is totally expected, so a simple audit of safe vs unsafe will not suffice.</p>



<a name="274107077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107077">(Mar 04 2022 at 10:08)</a>:</h4>
<p>We don't currently treat unsoundness as having an "except for malicious code" exception. Many soundness bugs in the past have effectively required malicious safe code to exploit. We still treated them as soundness bugs.</p>



<a name="274107150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107150">(Mar 04 2022 at 10:09)</a>:</h4>
<p>And while yes, it's an error to assume the whole buffer can't be replaced, validating that assumption seems like a pain.</p>



<a name="274107184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107184">(Mar 04 2022 at 10:09)</a>:</h4>
<p>Right, so this is where the soundness/footgun distinction is important. We should fix copy because that is unsoundness, I'm not sure we should fix buf_read since that is not unsound</p>



<a name="274107307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107307">(Mar 04 2022 at 10:10)</a>:</h4>
<p>What would the fix to copy look like if we <em>don't</em> fix <code>read_buf</code>?</p>



<a name="274107421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107421">(Mar 04 2022 at 10:11)</a>:</h4>
<p>(Also, aside, you keep writing <code>buf_read</code>, and I'm wondering if that's a typo or if there's some proposal I'm not aware of to change the name?)</p>



<a name="274107488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107488">(Mar 04 2022 at 10:12)</a>:</h4>
<p>We have several unsoundness bugs that have no accidental occurrences. Simply declaring them as "footgun, not unsound" seems very problematic to me. Introducing a new one in full knowledge of that even more so</p>



<a name="274107633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107633">(Mar 04 2022 at 10:13)</a>:</h4>
<p>I am fine discussing that point, but it seems independent of the read_buf situation. Can we pull it out to a separate thread in the lang team stream?</p>



<a name="274107636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107636">(Mar 04 2022 at 10:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274106858">said</a>:</p>
<blockquote>
<p>And now to cause an error the malicious implementer must use unsafe code in their impl. This seems to me like a technicality since the presence of unsafe code in an IO method  is totally expected, so a simple audit of safe vs unsafe will not suffice.</p>
</blockquote>
<p>"you can never cause UB via only safe code" is part of Rust's definition of soundness. I don't think that's a technicality.</p>



<a name="274107944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274107944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274107944">(Mar 04 2022 at 10:16)</a>:</h4>
<p>(Related: I'm looking into some automated schemes for detecting unsoundness. If I can't rely on "no unsafe, but UB" as the marker I'm looking for, I don't know what to rely on instead)</p>



<a name="274108181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108181">(Mar 04 2022 at 10:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274107307">said</a>:</p>
<blockquote>
<p>What would the fix to copy look like if we <em>don't</em> fix <code>read_buf</code>?</p>
</blockquote>
<p>In this case, check the buffer hasn't changed. But that is because in copy_to the ReadBuf is not available to the user and when relying on state of the ReadBuf to modify the underlying buffer, it should verify the assumption that it is in fact underlying still. If the user is using read_buf directly, then they can just use the ReadBuf directly without comparing with the original buffer.</p>



<a name="274108213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108213">(Mar 04 2022 at 10:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274107421">said</a>:</p>
<blockquote>
<p>(Also, aside, you keep writing <code>buf_read</code>, and I'm wondering if that's a typo or if there's some proposal I'm not aware of to change the name?)</p>
</blockquote>
<p>No, just a typo, sorry :-)</p>



<a name="274108368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108368">(Mar 04 2022 at 10:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274107633">said</a>:</p>
<blockquote>
<p>I am fine discussing that point, but it seems independent of the read_buf situation. Can we pull it out to a separate thread in the lang team stream?</p>
</blockquote>
<p>I'm not saying that at all. The unsoundness in copy_to should be fixed and is unsoundness not a footgun. The API of BufRead is a contributor to that unsoundness, but not unsound in itself and therefore I think is <em>just a footgun</em>.</p>



<a name="274108472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108472">(Mar 04 2022 at 10:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274107636">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274106858">said</a>:</p>
<blockquote>
<p>And now to cause an error the malicious implementer must use unsafe code in their impl. This seems to me like a technicality since the presence of unsafe code in an IO method  is totally expected, so a simple audit of safe vs unsafe will not suffice.</p>
</blockquote>
<p>"you can never cause UB via only safe code" is part of Rust's definition of soundness. I don't think that's a technicality.</p>
</blockquote>
<p>Right, but that only applies to copy_to, not read_buf. There is no way to cause UB using only safe code and read_buf. copy_to is unsound because it uses unsafe code internally</p>



<a name="274108584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108584">(Mar 04 2022 at 10:22)</a>:</h4>
<p>I agree that <code>read_buf</code> isn't unsound, it's just a footgun that's likely to make more people write unsound code when using it.</p>



<a name="274108615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108615">(Mar 04 2022 at 10:23)</a>:</h4>
<p>And we have a way to completely prevent that.</p>



<a name="274108676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108676">(Mar 04 2022 at 10:23)</a>:</h4>
<p>Ah, ok, I misunderstood</p>



<a name="274108886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108886">(Mar 04 2022 at 10:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274108615">said</a>:</p>
<blockquote>
<p>And we have a way to completely prevent that.</p>
</blockquote>
<p>Right, so I think it is worth considering the tradeoff here of ergonomics vs safety here, bearing in mind that we're helping people avoid writing unsound code, not actually fixing an unsoundness.</p>



<a name="274108953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274108953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274108953">(Mar 04 2022 at 10:26)</a>:</h4>
<p>On a different note: I may be missing something obvious, but I'm wondering if we could <em>just</em> expose <code>ReadBufRef</code> and not <code>ReadBuf</code>.</p>



<a name="274109020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109020">(Mar 04 2022 at 10:27)</a>:</h4>
<p>I think that if the caller wants to access the ReadBuf, then we need both? I guess the ReadBufRef could be cloned?</p>



<a name="274109058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109058">(Mar 04 2022 at 10:27)</a>:</h4>
<p>ReadBuf already holds a reference to a buffer, rather than owning the buffer.<br>
<em>Oh</em>, that's the obvious thing I'm missing, you wouldn't be able to pass it without giving it away.</p>



<a name="274109074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109074">(Mar 04 2022 at 10:27)</a>:</h4>
<p>right</p>



<a name="274109204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109204">(Mar 04 2022 at 10:28)</a>:</h4>
<p>/me wonders how much overhead it'd be to make <code>ReadBuf</code> hold a <code>Cow</code> rather than a reference.</p>



<a name="274109207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109207">(Mar 04 2022 at 10:28)</a>:</h4>
<p>But something like: </p>
<div class="codehilite"><pre><span></span><code>let buf = ReadBufRef::new(...);
reader.read_buf(buf.clone())?;
// use buf
</code></pre></div>
<p>would work</p>



<a name="274109239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109239">(Mar 04 2022 at 10:29)</a>:</h4>
<p>It would, but that clone wouldn't be free.</p>



<a name="274109281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109281">(Mar 04 2022 at 10:29)</a>:</h4>
<p>It would be pretty cheap since it would only clone the ref, not the ReadBuf</p>



<a name="274109342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109342">(Mar 04 2022 at 10:29)</a>:</h4>
<p>I had been assuming, in saying we could just have <code>ReadBufRef</code>, that it would need to have the initialized and filled lengths itself.</p>



<a name="274109573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109573">(Mar 04 2022 at 10:30)</a>:</h4>
<p>If it instead pointed to <code>ReadBuf</code>, that <code>ReadBuf</code> has to live somewhere, and in the absence of the caller holding it, we'd need something like an <code>Rc</code>.</p>



<a name="274109588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109588">(Mar 04 2022 at 10:30)</a>:</h4>
<p>Ah, I was assuming ReadBufRef is just a newtype reference and ReadBuf exists but is not exposed</p>



<a name="274109607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109607">(Mar 04 2022 at 10:30)</a>:</h4>
<p>Yeah, true</p>



<a name="274109640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109640">(Mar 04 2022 at 10:31)</a>:</h4>
<p>I don't see any way to expose only <code>ReadBufRef</code> with zero overhead.</p>



<a name="274109770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274109770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274109770">(Mar 04 2022 at 10:32)</a>:</h4>
<p>Hmm, we'd need custom DSTs or something to make it work nicely</p>



<a name="274110003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110003">(Mar 04 2022 at 10:35)</a>:</h4>
<p>I just had a thought that <em>might</em> make <code>ReadBufRef</code> more usable.</p>



<a name="274110052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110052">(Mar 04 2022 at 10:35)</a>:</h4>
<p>What if <code>ReadBuf</code> had a <code>DerefMut</code> to <code>ReadBufRef</code>, and then all the actual methods were implemented on <code>ReadBufRef</code>, and <code>ReadBuf</code> just has the constructors and nothing else?</p>



<a name="274110163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110163">(Mar 04 2022 at 10:37)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadBuf</span>::<span class="n">uninit</span><span class="p">(</span><span class="o">..</span><span class="p">.);</span><span class="w"></span>
<span class="n">reader</span><span class="p">.</span><span class="n">read_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">filled</span><span class="p">());</span><span class="w"></span>
</code></pre></div>



<a name="274110325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110325">(Mar 04 2022 at 10:38)</a>:</h4>
<p>That is interesting...</p>



<a name="274110354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110354">(Mar 04 2022 at 10:38)</a>:</h4>
<p>Obviously we'd have to drop the <code>Deref</code>/<code>DerefMut</code> to <code>&amp;[u8]</code>, which is a tradeoff.</p>



<a name="274110446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110446">(Mar 04 2022 at 10:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274110354">said</a>:</p>
<blockquote>
<p>Obviously we'd have to drop the <code>Deref</code>/<code>DerefMut</code> to <code>&amp;[u8]</code>, which is a tradeoff.</p>
</blockquote>
<p>That was only a suggestion of mine. Currently there is just a <code>filled</code> method</p>



<a name="274110657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110657">(Mar 04 2022 at 10:41)</a>:</h4>
<p>Hmmm. This would actually make the type of <code>read_buf</code> even less pleasant; <code>&amp;mut buf</code> would get coerced from <code>&amp;mut ReadBuf</code> to <code>&amp;mut ReadBufRef</code>, so <code>read_buf</code> would have to take <code>&amp;mut ReadBufRef</code>. Which is still anti-footgun, because replacing the <code>ReadBufRef</code> doesn't replace the <code>ReadBuf</code>, but it's unnecessarily weird.</p>



<a name="274110745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110745">(Mar 04 2022 at 10:42)</a>:</h4>
<p>It'd <em>work</em>, it's just not necessarily <em>less</em> weird.</p>



<a name="274110953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110953">(Mar 04 2022 at 10:44)</a>:</h4>
<p>It also means there are three pointers to deref to get to the underlying data which seems sub-optimal for perf-sensitive code</p>



<a name="274110989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110989">(Mar 04 2022 at 10:44)</a>:</h4>
<p>Could we go half way to a DST?</p>
<div class="codehilite"><pre><span></span><code>struct ReadBuf&lt;T: ?Sized&gt;(usize, usize, T);
</code></pre></div>
<p>and make the argument of <code>read_buf</code> a <code>ReadBuf&lt;[MaybeUninit&lt;u8&gt;]&gt;</code>. Then we can move a buffer into a ReadBuf, take a mutable reference and unsize it.</p>



<a name="274110993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274110993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274110993">(Mar 04 2022 at 10:44)</a>:</h4>
<p>I don't have a sense of how much worse than two pointers though</p>



<a name="274111086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111086">(Mar 04 2022 at 10:45)</a>:</h4>
<p>we might be able to do bette with a DST impl if we don't mind transmuting in the ctors</p>



<a name="274111180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111180">(Mar 04 2022 at 10:46)</a>:</h4>
<p>but wouldn't that still have the footgun issue?</p>



<a name="274111184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111184">(Mar 04 2022 at 10:46)</a>:</h4>
<p>Better in the API sense? Or with a behaviour change?</p>



<a name="274111196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111196">(Mar 04 2022 at 10:46)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> In general some things get nicer if ReadBuf owns the buffer, but IIRC that wasn't ideal for various performance-sensitive use cases which wanted to read directly into a destination buffer.</p>



<a name="274111237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111237">(Mar 04 2022 at 10:47)</a>:</h4>
<p>We could also use a RefCell rather than pointer maybe? Not sure about the perf tradeoff</p>



<a name="274111242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111242">(Mar 04 2022 at 10:47)</a>:</h4>
<p>You can't replace an unsized thing behind a reference or move out of it... for now, right. Forgot unsized locals</p>



<a name="274111342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111342">(Mar 04 2022 at 10:48)</a>:</h4>
<p>Yea, that's what I was afraid of. Should've read the alternatives section of the RFC, sorry, will do now</p>



<a name="274111406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111406">(Mar 04 2022 at 10:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274110953">said</a>:</p>
<blockquote>
<p>It also means there are three pointers to deref to get to the underlying data which seems sub-optimal for perf-sensitive code</p>
</blockquote>
<p>I never know what degree to assume Rust manages to make references not in practice require an indirection.</p>



<a name="274111426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111426">(Mar 04 2022 at 10:49)</a>:</h4>
<p>I suspect the answer is "not as often as I'd hope".</p>



<a name="274111556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111556">(Mar 04 2022 at 10:50)</a>:</h4>
<p>Yeah, this seems hard to optimise since the caller and callee are likely to be in different crates</p>



<a name="274111586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274111586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274111586">(Mar 04 2022 at 10:50)</a>:</h4>
<p>We can always add custom mir opts for such peephole opts</p>



<a name="274113820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274113820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274113820">(Mar 04 2022 at 11:10)</a>:</h4>
<p>We could put the size fields in Cells and pass a &amp;ReadBuf rather than a &amp;mut ReadBuf?</p>



<a name="274113851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274113851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274113851">(Mar 04 2022 at 11:10)</a>:</h4>
<p>It would mean ReadBuf is no longer Sync, but that doesn't seem too bad</p>



<a name="274113927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274113927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274113927">(Mar 04 2022 at 11:11)</a>:</h4>
<p>Oh no, we do want to modify the buf too, doh</p>



<a name="274114030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274114030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274114030">(Mar 04 2022 at 11:12)</a>:</h4>
<p>Stick the whole thing in a RefCell?</p>



<a name="274114067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274114067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274114067">(Mar 04 2022 at 11:13)</a>:</h4>
<p>I guess then there is runtime overhead</p>



<a name="274114098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274114098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274114098">(Mar 04 2022 at 11:14)</a>:</h4>
<p><code>[Cell&lt;MaybeUninit&lt;u8&gt;&gt;]</code></p>



<a name="274114201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274114201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274114201">(Mar 04 2022 at 11:14)</a>:</h4>
<p>No runtime overhead, but same effect</p>



<a name="274114545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274114545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274114545">(Mar 04 2022 at 11:18)</a>:</h4>
<p>Stepping back, although every step in the argument is logical, it feels weird to me that we are trying to design a buffer abstraction that can defend against a malicious read impl</p>



<a name="274115116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274115116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274115116">(Mar 04 2022 at 11:25)</a>:</h4>
<p>I mean... we already are defending against accidental misuse. The API doesn't get more complex really, you just have a different type.</p>



<a name="274115260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274115260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274115260">(Mar 04 2022 at 11:27)</a>:</h4>
<p>Of all the options we've talked about, I think <code>ReadBufRef</code> still seems like the simplest.</p>



<a name="274126147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274126147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274126147">(Mar 04 2022 at 13:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature/near/274104444">said</a>:</p>
<blockquote>
<p>So this is a programming mistake, not unsoundess. The question is whether the programming mistake is a reasonable one. It kind of is, so this is a footgun</p>
</blockquote>
<p>Yes. <span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span> It is a <em>potential footgun</em> with the following pattern:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MU</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">uninit</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="n">MU</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// …</span>
<span class="kd">let</span><span class="w"> </span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">read_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadBuf</span>::<span class="n">new</span><span class="p">(</span><span class="n">uninit</span><span class="p">);</span><span class="w"></span>
<span class="n">unknown_read_impl</span><span class="p">.</span><span class="n">read_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">read_buf</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">init_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_buf</span><span class="p">.</span><span class="n">initialized</span><span class="p">().</span><span class="n">len</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">init</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// SAFETY: none, the callee cannot be trusted not to have swapped the readbuf</span>
<span class="w">    </span><span class="n">Mu</span>::<span class="n">slice_assume_init_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">uninit</span><span class="p">[</span><span class="o">..</span><span class="w"> </span><span class="n">init_count</span><span class="p">])</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>so this may be <em>surprising</em>, especially if undocumented, and thus can legitimately be deemed <em>a footgun</em>, but it is <strong>not unsound</strong>.</p>
<p>Just wanted to clarify that; this is just a more convoluted version of the "what if the init len was returned by the implementor (<code>Result&lt;usize, …&gt;</code>)" which would also yield a value that couldn't be trusted, lest the trait be <code>unsafe</code>.</p>



<a name="274126925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274126925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274126925">(Mar 04 2022 at 13:21)</a>:</h4>
<p>If <code>ReadBufRef</code> removes this footgun, then I do <em>personally</em> consider that it should be worth featuring, even if the footgun is not unsound <em>per se</em>. The disappointing part would be the code duplication, but I suspect there should be ways to palliate that</p>



<a name="274133078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274133078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274133078">(Mar 04 2022 at 14:05)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
<p>An example</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>Not necessarily the best, but here is a little trait+wrapper-to-make-the-methods-inherent trick to have:</p>
<ul>
<li>a <code>ReadBuf&lt;'buf&gt;</code> type;</li>
<li>as well as a <code>ReadBufRef&lt;'r, 'buf&gt;</code> type;</li>
</ul>
<p>which both feature the same inherent impls thanks to a:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// These impls apply to both [`ReadBuf&lt;'buf&gt;`][`ReadBuf`] and</span>
<span class="sd">/// [`ReadBufRef&lt;'r, 'buf&gt;`][`ReadBufRef`].</span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Kind</span><span class="w"> </span>: <span class="nc">ReadBufLike</span><span class="o">&lt;'</span><span class="na">buf</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ReadBuf</span><span class="o">&lt;'</span><span class="na">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Kind</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>single block of inherent impls.</p>
<p>Implementor-side (only for stdlib maintainers), impls would just start with a <code>self.0.by_mut()</code> to get access to the internal <code>&amp;'r mut actual::ReadBuf&lt;'buf&gt;</code> with which to write the actual logic.</p>
<ul>
<li><a href="https://play.integer32.com/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=c5995f67a13eb8079a40b4a7e506be16">Playground</a></li>
</ul>
</div></div>
<hr>
<p>Another approach, simpler to write, and potentially simpler to read as well, would be to just use macros to manually perform the <code>.by_mut()</code> dispatching. It would also have the advantage of ensure monomorphisation happens as early as possible.</p>



<a name="274316507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274316507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274316507">(Mar 06 2022 at 17:02)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span><br>
<a href="https://twitter.com/casio_juarez/status/1500237036703395841">https://twitter.com/casio_juarez/status/1500237036703395841</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/casio_juarez/status/1500237036703395841"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/425d6703b013a27a415d7da5f0136391225a6dda/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313031363430363139353132373531333038382f63475035417366635f6e6f726d616c2e6a7067"></a><p>Every time somebody talks about documenting things user shouldn't do so that users don't do them, I remember this line for the GIF 89a spec:

"Animation - The Graphics Interchange Format is not intended as a platform for animation, even though it can be done in a limited way."</p><span>- non-controversial display name (@casio_juarez)</span></div></div>



<a name="274575578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Read%3A%3Abuf_read%20signature/near/274575578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Read.3A.3Abuf_read.20signature.html#274575578">(Mar 08 2022 at 17:33)</a>:</h4>
<p>I created <a href="https://github.com/rust-lang/rust/issues/94742">https://github.com/rust-lang/rust/issues/94742</a> to continue discussion.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>