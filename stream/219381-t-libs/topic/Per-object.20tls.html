<html>
<head><meta charset="utf-8"><title>Per-object tls · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html">Per-object tls</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268637158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268637158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268637158">(Jan 20 2022 at 03:38)</a>:</h4>
<p>Thoughts on adding a type like <a href="https://docs.rs/thread_local/latest/thread_local/struct.ThreadLocal.html">https://docs.rs/thread_local/latest/thread_local/struct.ThreadLocal.html</a> to the standard library?</p>



<a name="268637262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268637262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268637262">(Jan 20 2022 at 03:40)</a>:</h4>
<p>It allows for per-object thread local storage:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Collection</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="nc">std</span>::<span class="n">thread</span>::<span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Collection</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// retrieves the `Foo` for the current thread</span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="bp">self</span><span class="p">.</span><span class="n">foo</span><span class="p">.</span><span class="n">get_or_init</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">Foo</span>::<span class="n">new</span><span class="p">())</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268637369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268637369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268637369">(Jan 20 2022 at 03:42)</a>:</h4>
<p>The API is similar to <code>OnceCell</code>... maybe <code>std::lazy::ThreadLocalOnceCell</code> is a better place.</p>



<a name="268637375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268637375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268637375">(Jan 20 2022 at 03:42)</a>:</h4>
<p>The <code>thread-local</code> crate currently hsa 40 million+ downloads.</p>



<a name="268664281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268664281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268664281">(Jan 20 2022 at 09:27)</a>:</h4>
<p>I believe it use O(n) space where n is the highest thread id that tried to access it. In addition I don't think it gets dropped when a thread exists. So for example if you spawn new threads in a loop that access it and then exit you will get an OOM. Or even just spawning an immediately exiting thread in a loop for a while before spawning a new thread acvessing the thread local would OOM.</p>



<a name="268664870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268664870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268664870">(Jan 20 2022 at 09:32)</a>:</h4>
<p>Never mind. Misunderstood the code.</p>



<a name="268719438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Per-object%20tls/near/268719438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Fackler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Per-object.20tls.html#268719438">(Jan 20 2022 at 16:32)</a>:</h4>
<p>Yeah, that library clears up memory when the ThreadLocal drops. In contrast, the thread-local-object crate does the opposite, cleaning up memory when the threads drop but not when the ThreadLocal drops: <a href="https://docs.rs/thread-local-object/latest/thread_local_object/">https://docs.rs/thread-local-object/latest/thread_local_object/</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>