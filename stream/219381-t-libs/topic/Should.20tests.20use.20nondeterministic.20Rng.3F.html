<html>
<head><meta charset="utf-8"><title>Should tests use nondeterministic Rng? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html">Should tests use nondeterministic Rng?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265452980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265452980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265452980">(Dec 19 2021 at 00:59)</a>:</h4>
<p>I just debugged a Miri finding in <code>alloc</code> which was in a test that uses <code>rand::thread_rng()</code>. It was a bit challenging because what I wanted to do was find the borrow tag responsible, then run again with <code>-Zmiri-track-pointer-tag=$TAG</code> but the Rng caused the tag of interest to change between runs.</p>
<p>So that was a minor inconvenience for me, but now I'm wondering... Should there be tests that change behavior from run to run? There are quite a few uses of <code>rand::thread_rng()</code> in both tests and benchmarks.</p>



<a name="265457610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265457610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265457610">(Dec 19 2021 at 03:06)</a>:</h4>
<p>use of nondeterminism in benchmarks is usually an antipattern IMO. it is easy to see why people do it, though.</p>



<a name="265457662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265457662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265457662">(Dec 19 2021 at 03:08)</a>:</h4>
<p>the same probably doesnt really hold for tests (not to the same extent anyway), but i've wanted ways to forcibly seed <code>rand</code> to avoid this stuff doable. i don't think you can though, because if someone accidentally did that in production it would be a security problem</p>



<a name="265457906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265457906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265457906">(Dec 19 2021 at 03:15)</a>:</h4>
<p>You could <code>LD_PRELOAD</code> a replacement for <code>getrandom</code> while running tests.</p>



<a name="265466655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265466655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265466655">(Dec 19 2021 at 07:28)</a>:</h4>
<p>Miri has a -Z flag to use a fixed seed instead of true randomness</p>



<a name="265471371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265471371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265471371">(Dec 19 2021 at 09:41)</a>:</h4>
<p>you could also keep the tests randomized but print the seed so it can be used for reproduction</p>



<a name="265487977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Should%20tests%20use%20nondeterministic%20Rng%3F/near/265487977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Should.20tests.20use.20nondeterministic.20Rng.3F.html#265487977">(Dec 19 2021 at 16:32)</a>:</h4>
<p>Yeah, printing the seed is a pretty good strategy</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>