<html>
<head><meta charset="utf-8"><title>c_void &quot;temporary&quot; hacks · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html">c_void &quot;temporary&quot; hacks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273650386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273650386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273650386">(Mar 01 2022 at 14:40)</a>:</h4>
<p>the definition of <code>ffi::c_void</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// N.B., for LLVM to recognize the void pointer type and by extension</span>
<span class="c1">//     functions like malloc(), we need to have it represented as i8* in</span>
<span class="c1">//     LLVM bitcode. The enum used here ensures this and prevents misuse</span>
<span class="c1">//     of the "raw" type by only having private variants. We need two</span>
<span class="c1">//     variants, because the compiler complains about the repr attribute</span>
<span class="c1">//     otherwise and we need at least one variant as otherwise the enum</span>
<span class="c1">//     would be uninhabited and at least dereferencing such pointers would</span>
<span class="c1">//     be UB.</span>
<span class="cp">#[repr(u8)]</span><span class="w"></span>
<span class="cp">#[stable(feature = </span><span class="s">"core_c_void"</span><span class="cp">, since = </span><span class="s">"1.30.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">c_void</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[unstable(</span>
<span class="cp">        feature = </span><span class="s">"c_void_variant"</span><span class="cp">,</span>
<span class="cp">        reason = </span><span class="s">"temporary implementation detail"</span><span class="cp">,</span>
<span class="cp">        issue = </span><span class="s">"none"</span><span class="cp"></span>
<span class="cp">    )]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[doc(hidden)]</span><span class="w"></span>
<span class="w">    </span><span class="n">__variant1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[unstable(</span>
<span class="cp">        feature = </span><span class="s">"c_void_variant"</span><span class="cp">,</span>
<span class="cp">        reason = </span><span class="s">"temporary implementation detail"</span><span class="cp">,</span>
<span class="cp">        issue = </span><span class="s">"none"</span><span class="cp"></span>
<span class="cp">    )]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[doc(hidden)]</span><span class="w"></span>
<span class="w">    </span><span class="n">__variant2</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The comment gives the reason for the dummy variants, but I'm not sure why they're noted as "temporary implementation details". What is the long-term non-temporary solution?</p>



<a name="273651165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273651165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273651165">(Mar 01 2022 at 14:47)</a>:</h4>
<p>Enum variants can't be made private so they are made unstable here instead.</p>



<a name="273651752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273651752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273651752">(Mar 01 2022 at 14:51)</a>:</h4>
<p>Sure, but what's the temporary aspect? I'm trying to do some archaeology and maybe it looks like people were hoping to someday change the layout of c_void, but I'm not sure what that would be useful for and I'm also not sure how feasible that is</p>



<a name="273653595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273653595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lovelymono <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273653595">(Mar 01 2022 at 15:01)</a>:</h4>
<p>I have a question regarding <code>#[repr(u8)]</code> usage in here -- it looks like it works on enums with only a single variant, doesn't it?</p>



<a name="273653733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273653733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273653733">(Mar 01 2022 at 15:02)</a>:</h4>
<p><code>#[repr(u8)]</code> works just fine with multiple variants.</p>



<a name="273653857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273653857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lovelymono <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273653857">(Mar 01 2022 at 15:03)</a>:</h4>
<p>Yes, but the comment there is</p>
<blockquote>
<p>We need two variants, because the compiler complains about the repr attribute otherwise</p>
</blockquote>
<p>Wouldn't just a single variant be sufficient?</p>



<a name="273659753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273659753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273659753">(Mar 01 2022 at 15:41)</a>:</h4>
<p>I assume the One True Form would be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">c_void</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This isn't obviously an <code>i8*</code> though:</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="nv">%c_void</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="273660152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273660152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273660152">(Mar 01 2022 at 15:44)</a>:</h4>
<p>And it does look like a single variant is fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(u8)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">c_void</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_X</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">_</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_void</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_ZN10playground7example17haf1118224540cb67E</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="nv">%_1</span><span class="p">)</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!12</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>



<a name="273660572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273660572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273660572">(Mar 01 2022 at 15:46)</a>:</h4>
<p>I wonder if the opaque pointer work in LLVM would help here, as hopefully <code>malloc</code> wouldn't be hardcoded to <code>i8*</code> anymore.</p>



<a name="273661034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273661034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273661034">(Mar 01 2022 at 15:49)</a>:</h4>
<p>Shall we at least file an issue for this?</p>



<a name="273661234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273661234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273661234">(Mar 01 2022 at 15:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ git grep &#39;issue = &quot;none&quot;&#39; | wc -l
575
</code></pre></div>
<p>sigh...</p>



<a name="273661490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273661490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273661490">(Mar 01 2022 at 15:52)</a>:</h4>
<p>Many of those are intentionally perma-unstable, and a tracking issue doesn't really make sense for them, IMO, since we would not really entertain a request to stabilize them directly.</p>



<a name="273661674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273661674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273661674">(Mar 01 2022 at 15:53)</a>:</h4>
<p>yes, there are plenty of tests that make use of dummy stability attributes, but it does make it somewhat hard to find places like the above that should have issues but just don't</p>



<a name="273662170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273662170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273662170">(Mar 01 2022 at 15:55)</a>:</h4>
<p>The enum variants above don't seem like they should have issues? Those look permanently unstable to me</p>



<a name="273662220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273662220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273662220">(Mar 01 2022 at 15:56)</a>:</h4>
<p>Maybe a FIXME comment separately should point to an issue, but not the variants.</p>



<a name="273667624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273667624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273667624">(Mar 01 2022 at 16:25)</a>:</h4>
<p>if it's perma unstable, then "temporary implementation detail" is misleading. Just changing the comment to say "perma unstable" would be fine though.</p>



<a name="273670338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273670338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273670338">(Mar 01 2022 at 16:43)</a>:</h4>
<p>temporary things should be expressed through a FIXME and an issue, no?</p>



<a name="273671333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273671333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273671333">(Mar 01 2022 at 16:50)</a>:</h4>
<p>"temporary implementation detail" is ah<br>
aspirational wording</p>



<a name="273678660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273678660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273678660">(Mar 01 2022 at 17:31)</a>:</h4>
<p>why doesn't rustc just treat pointers to <code>()</code> as equivalent to pointers to <code>void</code>, and tell LLVM it's a <code>i8*</code>?</p>



<a name="273682682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273682682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273682682">(Mar 01 2022 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273660572">said</a>:</p>
<blockquote>
<p>I wonder if the opaque pointer work in LLVM would help here, as hopefully <code>malloc</code> wouldn't be hardcoded to <code>i8*</code> anymore.</p>
</blockquote>
<p>This sounds like the real fix to me.  That and hopefully it can become an <code>extern type</code> at some point.</p>



<a name="273712057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273712057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273712057">(Mar 01 2022 at 21:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273678660">said</a>:</p>
<blockquote>
<p>why doesn't rustc just treat pointers to <code>()</code> as equivalent to pointers to <code>void</code>, and tell LLVM it's a <code>i8*</code>?</p>
</blockquote>
<p>In part because <code>()</code> is a ZST and <code>i8</code> isn't.</p>



<a name="273716263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273716263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273716263">(Mar 01 2022 at 21:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273712057">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273678660">said</a>:</p>
<blockquote>
<p>why doesn't rustc just treat pointers to <code>()</code> as equivalent to pointers to <code>void</code>, and tell LLVM it's a <code>i8*</code>?</p>
</blockquote>
<p>In part because <code>()</code> is a ZST and <code>i8</code> isn't.</p>
</blockquote>
<p>hmm, just because we might tell LLVM it's a <code>i8*</code> doesn't mean we can't keep treating it as a ZST, where loads/stores are no-ops so no LLVM instructions are generated. In my opinion, treating <code>*const ()</code> -&gt; <code>i8*</code> as the canonical ABI lowering seems beneficial.</p>



<a name="273718747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273718747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273718747">(Mar 01 2022 at 22:08)</a>:</h4>
<p>In a way it'd almost be good for c_void to be <code>[u8; usize::MAX/4]</code> or something so that any by-value use would end up being an error.</p>
<p>But that's probably not worth doing if we can eventually do it properly with <code>extern type</code>.</p>



<a name="273719174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273719174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273719174">(Mar 01 2022 at 22:11)</a>:</h4>
<p>/me stares at <code>usize::MAX/4</code>. what?</p>



<a name="273730810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273730810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273730810">(Mar 01 2022 at 23:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273719174">said</a>:</p>
<blockquote>
<p>/me stares at <code>usize::MAX/4</code>. what?</p>
</blockquote>
<p>Well-formed, but big enough to likely cause a mono-time error if used by value.</p>



<a name="273730872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273730872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273730872">(Mar 01 2022 at 23:56)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> Ah, I see.</p>



<a name="273736746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273736746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273736746">(Mar 02 2022 at 00:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273730810">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273719174">said</a>:</p>
<blockquote>
<p>/me stares at <code>usize::MAX/4</code>. what?</p>
</blockquote>
<p>Well-formed, but big enough to likely cause a mono-time error if used by value.</p>
</blockquote>
<p>/me allocates one in segmented i86</p>



<a name="273737153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273737153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273737153">(Mar 02 2022 at 01:02)</a>:</h4>
<p>reminds me of huge pointers on borland's compilers for dos...you could have arrays several times bigger than the max size_t iirc</p>



<a name="273737381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273737381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273737381">(Mar 02 2022 at 01:05)</a>:</h4>
<p>Sounds fun. Can't wait to do that in lccc.</p>
<p>But yes, I don't think that making <code>c_void</code> a huge array will rule it out either statically or dynamically everywhere. It should in most places, but segmented 8086 or even IA-32 would be an exception since you could shove it in it's entirely own domain of memory, both as a static or on the stack (since an isolated stack segment could easily give you free reign over the entire address space in the stack if PAE or Long (Compatibility) Mode is in use, or 16-bit protected mode/v8086 mode).</p>



<a name="273738037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738037">(Mar 02 2022 at 01:12)</a>:</h4>
<p>(Or even on an old 8086, or a 286, since you got 20 bits of address space, and 16-bits of address.)</p>



<a name="273738067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738067">(Mar 02 2022 at 01:12)</a>:</h4>
<p>I do think, rather than a hack like that, we should just have a "never allow by-value use of this" attribute that we can use.</p>



<a name="273738088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738088">(Mar 02 2022 at 01:13)</a>:</h4>
<p>Which, in practice, would probably be handled most easily by finishing <code>extern type</code> support.</p>



<a name="273738109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738109">(Mar 02 2022 at 01:13)</a>:</h4>
<p>man a type you can never construct?</p>



<a name="273738115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738115">(Mar 02 2022 at 01:13)</a>:</h4>
<p>a type you can <strong>never</strong> construct, you say???</p>



<a name="273738124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738124">(Mar 02 2022 at 01:13)</a>:</h4>
<p>a type you can <strong>never</strong> construct<strong>!!!</strong></p>



<a name="273738171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738171">(Mar 02 2022 at 01:14)</a>:</h4>
<p>But has size 1, align 1, is ABI compatible with (when used behind a pointer) i8.</p>



<a name="273738174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738174">(Mar 02 2022 at 01:14)</a>:</h4>
<p>/me snrks.</p>



<a name="273738399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738399">(Mar 02 2022 at 01:17)</a>:</h4>
<p>I'd prefer avoiding a guarantee that <code>*const !</code> has the same abi as <code>*const i8</code>, tbh (similar for <code>*const ()</code>). Likewise for <code>*const (u8, !)</code> (of course, if it wasn't a guarantee, I could just be smarter than llvm, and not special-case the signature of <code>malloc</code>).</p>



<a name="273738570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738570">(Mar 02 2022 at 01:19)</a>:</h4>
<p>wait is it actually important that <code>void*</code> have a size and align of 1</p>



<a name="273738650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738650">(Mar 02 2022 at 01:20)</a>:</h4>
<p>Well, the important part (to llvm at least) is that <code>*const c_void</code> has pointer-to-character abi.</p>



<a name="273738860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738860">(Mar 02 2022 at 01:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273738570">said</a>:</p>
<blockquote>
<p>wait is it actually important that <code>void*</code> have a size and align of 1</p>
</blockquote>
<p>Yeah, if people use <code>c_void</code> as a type they expect an alignment of 1, and the ability to offset in terms of bytes. At one point doing math with <code>void *</code> required a C compiler extension, and strictly conforming C had to cast to <code>char *</code> first. I don't know if that is still required, or if standards-compliant C can do math directly on <code>void *</code> now.</p>



<a name="273738900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738900">(Mar 02 2022 at 01:23)</a>:</h4>
<p>It's still a GNU extension to do math on <code>void*</code>.</p>



<a name="273738975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273738975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273738975">(Mar 02 2022 at 01:24)</a>:</h4>
<p>Since pointer arithmetic is defined in terms of elements of an array, and you can't have an array of <code>void</code>.</p>



<a name="273739040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739040">(Mar 02 2022 at 01:24)</a>:</h4>
<p>/me wonders how hard it would be to get that ratified as part of C2x or C2y.</p>



<a name="273739064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739064">(Mar 02 2022 at 01:24)</a>:</h4>
<p>no chance for C23</p>



<a name="273739069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739069">(Mar 02 2022 at 01:24)</a>:</h4>
<p>you are too late.</p>



<a name="273739073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739073">(Mar 02 2022 at 01:24)</a>:</h4>
<p>(It's also a general restriction - you can't do pointer arithmetic on any pointer to an incomplete type, mostly because it requires knowing the size of the type)</p>



<a name="273739133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739133">(Mar 02 2022 at 01:25)</a>:</h4>
<p>Yeah, if C's release schedule is anything like C++'s, C23 is feature frozen. IDK if there even willl be a C2y. So, earliest is probably 2029 (if at all).</p>



<a name="273739637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739637">(Mar 02 2022 at 01:31)</a>:</h4>
<p>C23 got feature frozen <em>very</em> recently, like in the past two weeks or so. There was a whole thing about it on twitter.</p>



<a name="273739667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739667">(Mar 02 2022 at 01:31)</a>:</h4>
<p><em>shrug</em>, not too worried about the timeline of such a change getting into C, given that compilers support it already.</p>



<a name="273739714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739714">(Mar 02 2022 at 01:32)</a>:</h4>
<p>Mostly just thinking that it's a sufficiently widely used extension that it'd be nice to standardize it.</p>



<a name="273739743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739743">(Mar 02 2022 at 01:32)</a>:</h4>
<p>it's not quiiiite "feature frozen" I think, more that all the papers that will be considered are in, everything is hashing out the details.</p>



<a name="273739923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273739923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273739923">(Mar 02 2022 at 01:35)</a>:</h4>
<p>Yes, that's what "feature freeze" is. They've  frozen the set of features that will be in the standard, and aren't accepting new ones. Not necessarily the forms those features take.</p>



<a name="273740393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273740393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273740393">(Mar 02 2022 at 01:40)</a>:</h4>
<p>welllll~ okay.</p>



<a name="273740490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273740490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273740490">(Mar 02 2022 at 01:42)</a>:</h4>
<p>I've heard people use it both ways, tbh. &lt;_&lt; ...and somewhat more importantly, anything accepted as a paper for consideration can still be booted, though I think they are close to settling all of the "go/no-go"s.</p>



<a name="273740843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273740843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273740843">(Mar 02 2022 at 01:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273738860">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273738570">said</a>:</p>
<blockquote>
<p>wait is it actually important that <code>void*</code> have a size and align of 1</p>
</blockquote>
<p>Yeah, if people use <code>c_void</code> as a type they expect an alignment of 1, and the ability to offset in terms of bytes. At one point doing math with <code>void *</code> required a C compiler extension, and strictly conforming C had to cast to <code>char *</code> first. I don't know if that is still required, or if standards-compliant C can do math directly on <code>void *</code> now.</p>
</blockquote>
<p>The alignment of both <code>!</code> and <code>()</code> are 1, fwiw, in spite of them being ZSTs.</p>



<a name="273740989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273740989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273740989">(Mar 02 2022 at 01:50)</a>:</h4>
<p>size has to be a multiple of align, but 0 is a multiple of 1.</p>



<a name="273741066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273741066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273741066">(Mar 02 2022 at 01:51)</a>:</h4>
<p>alignment also needs to be a power of two.</p>



<a name="273741098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273741098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273741098">(Mar 02 2022 at 01:51)</a>:</h4>
<p>2^0 is 1. :D</p>



<a name="273741145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273741145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273741145">(Mar 02 2022 at 01:52)</a>:</h4>
<p>Yep, exactly.</p>



<a name="273741171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273741171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273741171">(Mar 02 2022 at 01:52)</a>:</h4>
<p>(And alignment of <code>0</code> also wouldn't make sense)</p>



<a name="273747942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273747942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273747942">(Mar 02 2022 at 03:08)</a>:</h4>
<p>I recall <span class="user-mention" data-user-id="120791">@RalfJ</span> mentioning a trick like that for making an impossible reference: something with an align of 0 has to have a byte value which is a multiple of zero, and hence zero, but also must not be zero because it's a reference</p>



<a name="273748012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273748012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273748012">(Mar 02 2022 at 03:09)</a>:</h4>
<p>Kind of like your <code>NonZeroU0</code> example</p>



<a name="273753292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273753292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273753292">(Mar 02 2022 at 04:20)</a>:</h4>
<p><code>NonZeroU0</code> is just <code>!</code>, tbh. Just a scalar <code>!</code>.</p>



<a name="273753373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273753373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273753373">(Mar 02 2022 at 04:21)</a>:</h4>
<p>I don't think a type with alignment <code>0</code> could possibly exist, mostly because alignment as a property is always a power of two.</p>



<a name="273753695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273753695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273753695">(Mar 02 2022 at 04:25)</a>:</h4>
<p>Yes, that was my point, a type with alignment zero is a type that can't be pointed to because any valid pointer to it would have to be 0 and hence not valid</p>



<a name="273753906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273753906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273753906">(Mar 02 2022 at 04:28)</a>:</h4>
<p>Obviously 0 is not a power of 2 in the usual interpretation, but it can be interpreted as the limit of 2^n as n approaches infinity in the 2-adic valuation. Put another way, if you left shift 1 by too much you get 0, so 0 acts like an "infinitely large" alignment</p>



<a name="273754388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273754388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273754388">(Mar 02 2022 at 04:34)</a>:</h4>
<p>well, i hope Rust eventually gets something sorta like align = 1/8 aka. bitfields</p>



<a name="273755085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273755085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273755085">(Mar 02 2022 at 04:44)</a>:</h4>
<p>honestly I am fine with just having scalar integers and bitpacking operations.</p>



<a name="273755243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273755243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273755243">(Mar 02 2022 at 04:47)</a>:</h4>
<p>if we get generic integer sizes then we can have a function that takes a u32 and unpacks it into a u10, u10, u10, and u2, operates on them, etc.</p>



<a name="273875607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273875607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273875607">(Mar 02 2022 at 20:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks/near/273747942">said</a>:</p>
<blockquote>
<p>I recall <span class="user-mention silent" data-user-id="120791">RalfJ</span> mentioning a trick like that for making an impossible reference: something with an align of 0 has to have a byte value which is a multiple of zero, and hence zero, but also must not be zero because it's a reference</p>
</blockquote>
<p>FWIW I dont know what you mean^^ I argued <code>&amp;!</code> should be validity-uninhabited but that seems rather orthogonal to the c_void discussion</p>



<a name="273876182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/c_void%20%22temporary%22%20hacks/near/273876182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/c_void.20.22temporary.22.20hacks.html#273876182">(Mar 02 2022 at 21:00)</a>:</h4>
<p>no worries, I'm probably just slowly going insane :) Happens to the best of us</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>