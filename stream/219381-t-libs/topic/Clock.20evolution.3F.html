<html>
<head><meta charset="utf-8"><title>Clock evolution? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html">Clock evolution?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260697302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260697302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Starks <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260697302">(Nov 08 2021 at 18:16)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/88714">https://github.com/rust-lang/rust/pull/88714</a>, which changes <code>std::time::Instant</code> to use CLOCK_BOOTTIME instead of CLOCK_MONOTONIC on Linux, was approved to be merged recently. This means that Instant now will include time spent while the machine is asleep, whereas it did not before.</p>
<p>The discussion for this was scattered between here and a few different issues. If I understand correctly, it seems like the argument that this makes Windows and Linux more consistent, and that embedded and mobile developers found this semantic more useful so it was better to change Linux than to change Windows. (It sounds like maybe it also makes Linux more consistent with other OSes, but I didn't quite follow the details, and I don't have any experience with time outside of Linux and Windows.)</p>
<p>However, std::thread::sleep still uses CLOCK_MONOTONIC on Linux and the equivalent on Windows. So sleep time still won't be accounting for across suspend on Linux or Windows platforms. This is an odd inconsistency, since I think one generally wants to measure elapsed time using the same clock that they are using to express timeouts and delays.</p>
<p>Other languages and environments (Go, Android SDK, libc) seem to be settling on exposing multiple clock sources for both elapsed time and timers, which allows the developer to choose the correct timer based on the behavior they want.</p>
<p>Is there a kind of time vision document or anything describing what the libs team is aiming for here? I'm a little worried that this change to Instant might make further improvements to Rust's time handling more difficult.</p>



<a name="260703849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260703849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260703849">(Nov 08 2021 at 19:07)</a>:</h4>
<p>Can you give an example of how this might make it difficult to improve things in the future? I don't have an opinion on this issue, but it seems that exposing both behaviors would just involve adding one new alternative API for the option that <code>Instant</code> doesn't support, yes?</p>



<a name="260704118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260704118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260704118">(Nov 08 2021 at 19:09)</a>:</h4>
<p>Do you personally have a vision for the future of time handling in std? Because I'm sure people would be interested to hear one :)</p>



<a name="260705559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260705559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260705559">(Nov 08 2021 at 19:21)</a>:</h4>
<p>One possible use of elapsed active time (i.e. excluding hibernation) is for periodic task schedulers so that they get spread out over time. If sleep time causes all timeouts to be met at once then schedules can get crushed into a single time slot instead of spreading out.</p>
<p>And general performance measurements. When you want to count work processed / units of time that the program was actually running.</p>



<a name="260705654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260705654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260705654">(Nov 08 2021 at 19:22)</a>:</h4>
<p>And yeah, those selectable clock-source APIs exist for a reason. A pity that rust didn't learn from that design.</p>



<a name="260707188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260707188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260707188">(Nov 08 2021 at 19:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/Clock.20evolution.3F/near/260705559">said</a>:</p>
<blockquote>
<p>One possible use of elapsed active time (i.e. excluding hibernation) is for periodic task schedulers so that they get spread out over time. If sleep time causes all timeouts to be met at once then schedules can get crushed into a single time slot instead of spreading out.</p>
</blockquote>
<p>That's a good reason why <code>sleep</code> should continue using <code>CLOCK_MONOTONIC</code>.</p>
<blockquote>
<p>And general performance measurements. When you want to count work processed / units of time that the program was actually running.</p>
</blockquote>
<p>That's always going to be fraught with scheduling questions though -- for program-running time you'd be better off with something like <code>getrusage</code></p>



<a name="260708576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260708576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260708576">(Nov 08 2021 at 19:46)</a>:</h4>
<p>Not when you're measuring download speed</p>



<a name="260718033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260718033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260718033">(Nov 08 2021 at 20:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/Clock.20evolution.3F/near/260705654">said</a>:</p>
<blockquote>
<p>And yeah, those selectable clock-source APIs exist for a reason. A pity that rust didn't learn from that design.</p>
</blockquote>
<p>I don't think the current design precludes any better design, if anybody would like to propose one. :P afaik the time module is just the sole remnant of the pre-1.0 desire to have datetime in std, until people realized it was too big of a task for 1.0</p>



<a name="260718513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260718513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260718513">(Nov 08 2021 at 21:02)</a>:</h4>
<p>At least <code>Duration</code> was stabilized after 1.0. We have a deprecated <code>std::thread::sleep_ms</code> function as <code>Duration</code> wasn't stabilized at 1.0 yet.</p>



<a name="260719364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/260719364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#260719364">(Nov 08 2021 at 21:09)</a>:</h4>
<p>sure, Duration is as new as 1.3, but that doesn't mean that the time module wouldn't welcome a broader vision. :) I'm sure people would love to have datetime APIs in std itself, if only datetime APIs were a solved problem</p>



<a name="261231870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/261231870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#261231870">(Nov 12 2021 at 09:59)</a>:</h4>
<p>Methods like <code>sleep_until</code> that take not a duration but the time at which sleep should terminate are fairly common in async ecosystems such as tokio.</p>



<a name="261231902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/261231902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#261231902">(Nov 12 2021 at 09:59)</a>:</h4>
<p>this would be a natural way to support either kind of sleep, I think.</p>



<a name="261232089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Clock%20evolution%3F/near/261232089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Clock.20evolution.3F.html#261232089">(Nov 12 2021 at 10:00)</a>:</h4>
<p>(this makes me wonder if e.g. tokio's implementation actually handles suspends correctly now ^^)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>