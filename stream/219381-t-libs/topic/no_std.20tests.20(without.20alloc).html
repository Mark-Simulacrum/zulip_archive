<html>
<head><meta charset="utf-8"><title>no_std tests (without alloc) · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html">no_std tests (without alloc)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258269087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258269087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258269087">(Oct 19 2021 at 20:46)</a>:</h4>
<p>I'm currently looking into <a href="https://github.com/rust-lang/rfcs/issues/2810">https://github.com/rust-lang/rfcs/issues/2810</a> by copying the <code>catch_unwind</code> implementation into <code>core</code> and removing the use of <code>Box</code>. While adding a test to <code>library/core/tests</code> I was surprised to see that <code>panic_unwind</code> appears to be used, since it depends on <code>alloc</code>.</p>
<p>If <code>library/core/tests</code> depends on <code>alloc</code>, is there a way to write tests for <code>core</code> without depending on <code>alloc</code> (i.e., to replicate someone who's trying to write <code>no_std</code> and no alloc code)?</p>



<a name="258272491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258272491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258272491">(Oct 19 2021 at 21:09)</a>:</h4>
<p><code>src/test/ui/panic-runtime</code> has a bunch of no_std tests</p>



<a name="258277972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258277972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258277972">(Oct 19 2021 at 21:48)</a>:</h4>
<p>All <code>#[test]</code> tests have libstd available as libtest depends on it. The reason libcore tests are in core/tests and not distributed throughout core/ is to make a dependency on libstd/libtest possible I think.</p>



<a name="258278128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258278128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258278128">(Oct 19 2021 at 21:49)</a>:</h4>
<p>How do you want to implement catch_unwind in libcore by the way? It depends on a panic runtime which is only available when you use libstd.</p>



<a name="258290411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258290411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258290411">(Oct 19 2021 at 23:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/219381-t-libs/topic/no_std.20tests.20.28without.20alloc.29/near/258278128">said</a>:</p>
<blockquote>
<p>How do you want to implement catch_unwind in libcore by the way? It depends on a panic runtime which is only available when you use libstd.</p>
</blockquote>
<p>Honestly, I'm not sure: that's part of the reason that I'm making this prototype. I figure that if I can get something working, then that will help illuminate what problems need to be solved and decisions need to be made, and then I can move the discussion on the GitHub issue forward (or create an RFC with a proposal).</p>



<a name="258293037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258293037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258293037">(Oct 20 2021 at 00:12)</a>:</h4>
<p>Also, I may be wrong but it appears that <code>panic_unwind</code> depends on <code>core</code>+<code>alloc</code> not <code>std</code>, so it might be useful to someone in that environment to be able to use <code>catch_unwind</code>. And it <em>should</em> be possible for someone implementing their own panic runtime to provide the functions required to make <code>catch_unwind</code> work if they so desire...</p>



<a name="258334009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258334009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258334009">(Oct 20 2021 at 08:57)</a>:</h4>
<p><code>catch_unwind</code> calls <code>__rust_panic_cleanup</code> from the panic runtime (which is only included when using libstd) and <code>panic_count::decrease()</code> from libstd.</p>



<a name="258387787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258387787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258387787">(Oct 20 2021 at 15:26)</a>:</h4>
<p>It happens that I have implemented a panic runtime, and <code>try</code>/<code>abort</code> are intrinsics that I need (<a href="https://github.com/nbdd0121/unwinding/blob/trunk/src/panicking.rs">https://github.com/nbdd0121/unwinding/blob/trunk/src/panicking.rs</a>). However I am not too worried about it using nightly features, given that <code>lang_items</code> is need for personality function..</p>



<a name="258388243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258388243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258388243">(Oct 20 2021 at 15:29)</a>:</h4>
<p>I thought about a no_std catch_unwind design but really couldn't figure out. Especially since foreign exceptions can only be dealt with the panic runtime. We could define a few more lang_items and require user to define them instead, but that really wouldn't reduce the number of nightly features.</p>



<a name="258422035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258422035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258422035">(Oct 20 2021 at 18:48)</a>:</h4>
<p>We don't guarantee through which mechanism unwinding works in rust. It happens to be implemented using DWARF/SEH in cg_llvm, but other backends (or even cg_llvm) may use different mechanisms if they are easier to implement or faster. Without a unwinding mechanism guarantee, it won't be possible to initiate a stack unwind on stable except through libstd.</p>



<a name="258604181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/no_std%20tests%20%28without%20alloc%29/near/258604181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/no_std.20tests.20(without.20alloc).html#258604181">(Oct 21 2021 at 19:34)</a>:</h4>
<p>FYI, I have a working prototype: <a href="https://github.com/rust-lang/rfcs/issues/2810#issuecomment-948937887">https://github.com/rust-lang/rfcs/issues/2810#issuecomment-948937887</a><br>
It works out-of-the-box for libcore+liballoc environments using one of the existing panic runtimes, and requires custom panic runtimes to implement a single extern function (but only if they use <code>catch_unwind</code>).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>