<html>
<head><meta charset="utf-8"><title>the splittening of libc · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html">the splittening of libc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273704901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273704901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273704901">(Mar 01 2022 at 20:25)</a>:</h4>
<p>a while ago there was a plan to split libc out into multiple crates, one for each supported platform, in pursuit of improving the libc versioning situation by acknowledging the fact that platform APIs aren't stable and we can't avoid breaking changes. <a href="https://github.com/rust-lang/libc/issues/547#issuecomment-576158988">https://github.com/rust-lang/libc/issues/547#issuecomment-576158988</a> . that seems to have stalled, but in the meantime I find myself building a codebase for <code>x86_64-unknown-none</code> that also needs access to libc's <code>x86_64-unknown-linux-gnu</code> items, so if anyone's interested in pursuing the original plan I'm happy to do the labor of splitting out libc into individual platform crates since either way I'll need to do so for linux anyway. is there anyone highly involved in the libc crate these days?</p>



<a name="273705113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273705113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273705113">(Mar 01 2022 at 20:27)</a>:</h4>
<p>I'm invested in the design aspects and would like to help with that discussion. I'd be happy to join whatever meeting ends up happening to discuss it.</p>



<a name="273705241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273705241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273705241">(Mar 01 2022 at 20:28)</a>:</h4>
<p>I'm not sure to what degree we want to omit all of the myriad platform specific APIs from libc and put them in their own crate. But I can imagine some options there.</p>



<a name="273705254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273705254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273705254">(Mar 01 2022 at 20:28)</a>:</h4>
<p>Would it help if the stability markers mechanism that we use in the standard library were also available for use in crates?</p>



<a name="273705654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273705654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273705654">(Mar 01 2022 at 20:31)</a>:</h4>
<p>right, I'd love some guidance design-wise.</p>
<p>regarding stability markers, how would you see them being used? right now I'm just thinking about moving existing items into new crates, not introducing any new unstable items.</p>



<a name="273709072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273709072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273709072">(Mar 01 2022 at 20:58)</a>:</h4>
<p>The people involved in the libc crate are mainly <span class="user-mention" data-user-id="217081">@Yuki Okushi</span> and myself.</p>



<a name="273709128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273709128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273709128">(Mar 01 2022 at 20:59)</a>:</h4>
<p>The problem with the libc crate is that it is used by a <em>huge</em> portion of the ecosystem, which makes even slight breaking changes a non-starter.</p>



<a name="273709269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273709269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273709269">(Mar 01 2022 at 21:00)</a>:</h4>
<p><span class="user-mention" data-user-id="256342">@bstrie</span> What kind of changes do you have in mind for libc exactly?</p>



<a name="273709472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273709472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273709472">(Mar 01 2022 at 21:00)</a>:</h4>
<p>Is it just about splitting things from the linux headers which don't depend on libc into a separate crate?</p>



<a name="273709492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273709492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273709492">(Mar 01 2022 at 21:01)</a>:</h4>
<p>So that you can use them with raw syscalls without libc.</p>



<a name="273711066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273711066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273711066">(Mar 01 2022 at 21:11)</a>:</h4>
<p>yes, the goal is to disentangle the essential bits of libc from the platform-specific bits. I don't foresee any breaking changes, the goal would be to re-export these definitions from libc just as they are (although I think gnzlbg might have had grander designs beyond this that might have <em>someday</em> involved breaking changes)</p>



<a name="273712430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273712430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273712430">(Mar 01 2022 at 21:23)</a>:</h4>
<p>Ah, I see.</p>



<a name="273712499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273712499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273712499">(Mar 01 2022 at 21:23)</a>:</h4>
<p>So, there'd be a <code>libc-core</code> (not trying to bikeshed a name) that <em>only</em> has portable C entry points?</p>



<a name="273712537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273712537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273712537">(Mar 01 2022 at 21:23)</a>:</h4>
<p>And then (say) <code>libc-linux</code> with all the Linux-y bits?</p>



<a name="273712725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273712725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273712725">(Mar 01 2022 at 21:24)</a>:</h4>
<p>And some random target that regularly breaks API compat might be <del>0.1.0</del> <del>0.2.0</del> <del>0.3.0</del> <del>0.4.0</del> 0.5.0, while a stable one wouldn't break API?</p>



<a name="273713022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713022">(Mar 01 2022 at 21:27)</a>:</h4>
<p>yep, that's the idea.</p>



<a name="273713294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713294">(Mar 01 2022 at 21:29)</a>:</h4>
<p>obviously as long as libc still re-exports any of these unstable platform APIs it will suffer the instability that presents, but if I read between the lines I think that some people were proposing that a 0.3 release of libc might only expose the core APIs (which is to say, whatever APIs are required to <em>not</em> cause a second libcpocalypse), while forcing users to explicitly depend on platform-specific crates that might be on major version 200 or what have you</p>



<a name="273713438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713438">(Mar 01 2022 at 21:30)</a>:</h4>
<p>That seems potentially interesting. Especially if we can manage to auto-generate more of the platform-specific bits.</p>



<a name="273713556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713556">(Mar 01 2022 at 21:30)</a>:</h4>
<p>Another approach that was proposed is to get rid of all the manual bindings and just have something that is generated by bindgen from the platform headers.</p>



<a name="273713574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713574">(Mar 01 2022 at 21:30)</a>:</h4>
<p>Exactly.</p>



<a name="273713645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713645">(Mar 01 2022 at 21:31)</a>:</h4>
<p>I would <em>love</em> to see that happen. We'd have to snapshot the latest platform headers and ship those (since we shouldn't depend on what's on the user's system, they might have something older/newer than we support), but it'd be much more maintainable.</p>



<a name="273713820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713820">(Mar 01 2022 at 21:32)</a>:</h4>
<p>keeping in mind that the libc crate is so old that it predates things like unions, so a straightforward generation will result in breaking changes on its own</p>



<a name="273713846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713846">(Mar 01 2022 at 21:32)</a>:</h4>
<p>Oh yea I think we're well into libc 0.3 territory here.</p>



<a name="273713887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713887">(Mar 01 2022 at 21:33)</a>:</h4>
<p>Perhaps this should be prototyped as an external crate first.</p>



<a name="273713975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273713975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273713975">(Mar 01 2022 at 21:33)</a>:</h4>
<p>I also think, before we make any kind of breaking change, we should establish an MSRV policy.</p>



<a name="273714034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714034">(Mar 01 2022 at 21:34)</a>:</h4>
<p>Right now, libc's MSRV policy is "support ALL the Rusts". That's painful.</p>



<a name="273714063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714063">(Mar 01 2022 at 21:34)</a>:</h4>
<p>I think it'd be <em>completely</em> reasonable to say "stable and stable-minus-one, nothing older".</p>



<a name="273714100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714100">(Mar 01 2022 at 21:34)</a>:</h4>
<p>Perhaps we could take some inspiration from Zig for the auto-generated bindings: <a href="https://github.com/ziglang/zig/tree/master/lib/libc">https://github.com/ziglang/zig/tree/master/lib/libc</a></p>



<a name="273714346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714346">(Mar 01 2022 at 21:36)</a>:</h4>
<p>I think all of these concerns would be helped by precisely identifying the core bits of libc, since those would be the foundation of any libc 0.3, and are what any experimental external crate would need to re-export anyway, and could very well be so minimal that an extremely old MSRV might be trivial to achieve</p>



<a name="273714589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714589">(Mar 01 2022 at 21:38)</a>:</h4>
<p>Why couldn't the core bits also be generated from C headers? The only things that are core are the base types which would come from <code>core::ffi</code>.</p>



<a name="273714662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714662">(Mar 01 2022 at 21:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273714346">said</a>:</p>
<blockquote>
<p>I think all of these concerns would be helped by precisely identifying the core bits of libc, since those would be the foundation of any libc 0.3, and are what any experimental external crate would need to re-export anyway, and could very well be so minimal that an extremely old MSRV might be trivial to achieve</p>
</blockquote>
<p>"extremely old MSRV" means no unions, no <code>repr(align)</code>, no <code>repr(packed)</code>, no <code>#[non_exhaustive]</code>...</p>



<a name="273714693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714693">(Mar 01 2022 at 21:38)</a>:</h4>
<p>would that involve moving more things into core::ffi? currently it's just c_void, yeah?</p>



<a name="273714739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714739">(Mar 01 2022 at 21:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273714693">said</a>:</p>
<blockquote>
<p>would that involve moving more things into core::ffi? currently it's just c_void, yeah?</p>
</blockquote>
<p>Yes, and we should absolutely do that.</p>



<a name="273714764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714764">(Mar 01 2022 at 21:39)</a>:</h4>
<p>I'm thinking of sending that PR today, actually.</p>



<a name="273714816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714816">(Mar 01 2022 at 21:39)</a>:</h4>
<p>sounds good to me, maybe the "core" of libc should just be core::ffi :P</p>



<a name="273714826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714826">(Mar 01 2022 at 21:39)</a>:</h4>
<p>I've been holding off because it'd be hard to do with stability markers, but I can just do it <em>without</em> stability markers and FCP it being insta-stable.</p>



<a name="273714910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714910">(Mar 01 2022 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> Thoughts on such a PR?</p>



<a name="273714943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714943">(Mar 01 2022 at 21:40)</a>:</h4>
<p>(with re-export in the existing location)</p>



<a name="273714960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273714960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273714960">(Mar 01 2022 at 21:40)</a>:</h4>
<p>I have a half-finish branch from 2018 which also does that. So yes, I'm in favor.</p>



<a name="273715048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715048">(Mar 01 2022 at 21:41)</a>:</h4>
<p>I'm curious about what you'd need <code>non_exhaustive</code> for with libc</p>



<a name="273715081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715081">(Mar 01 2022 at 21:41)</a>:</h4>
<p>Why would this be insta-stable? It's just typedefs for <code>c_int</code>, etc.</p>



<a name="273715177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715177">(Mar 01 2022 at 21:42)</a>:</h4>
<p>Yeah I'm unclear why a type alias would need to be insta-stable</p>



<a name="273715212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715212">(Mar 01 2022 at 21:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273715081">said</a>:</p>
<blockquote>
<p>Why would this be insta-stable? It's just typedefs for <code>c_int</code>, etc.</p>
</blockquote>
<p>I was assuming we wanted them to be the same types, re-exported.</p>



<a name="273715264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715264">(Mar 01 2022 at 21:43)</a>:</h4>
<p>If we make them visibly type aliases that could work.</p>



<a name="273715281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715281">(Mar 01 2022 at 21:43)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/compare/master...Amanieu:core_ctypes">https://github.com/rust-lang/rust/compare/master...Amanieu:core_ctypes</a></p>



<a name="273715395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715395">(Mar 01 2022 at 21:44)</a>:</h4>
<p>They've always been visibly type aliases and i think it would be an unexpected and unwanted change to make them newtypes or anything of the sort</p>



<a name="273715407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715407">(Mar 01 2022 at 21:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273715395">said</a>:</p>
<blockquote>
<p>They've always been visibly type aliases and i think it would be an unexpected and unwanted change to make them newtypes or anything of the sort</p>
</blockquote>
<p>No, I don't mean newtypes.</p>



<a name="273715424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715424">(Mar 01 2022 at 21:44)</a>:</h4>
<p>I meant, I <em>had</em> been planning to move the type aliases to core and then re-export them all from std.</p>



<a name="273715439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715439">(Mar 01 2022 at 21:44)</a>:</h4>
<p>And re-exports can't have different stability markers.</p>



<a name="273715486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715486">(Mar 01 2022 at 21:45)</a>:</h4>
<p>But it could absolutely work to instead move all the type aliases to core, then make std contain type aliases for the types in core.</p>



<a name="273715505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715505">(Mar 01 2022 at 21:45)</a>:</h4>
<p>And those <em>could</em> have different stability markers, I think.</p>



<a name="273715636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715636">(Mar 01 2022 at 21:46)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> Yeah, that's a much better approach. Thanks!</p>



<a name="273715827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715827">(Mar 01 2022 at 21:47)</a>:</h4>
<p>(feel free to base your PR off my code, I haven't touched it in years)</p>



<a name="273715836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715836">(Mar 01 2022 at 21:47)</a>:</h4>
<p>Haven't we stabilized re-exports in std before core/alloc in the past?</p>



<a name="273715963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273715963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273715963">(Mar 01 2022 at 21:48)</a>:</h4>
<p>I don't recall cases where we've done that, and from a technical perspective we can't do that with just re-exports, it only works if there's some other mechanism in play to allow the stability markers to differ.</p>



<a name="273716735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273716735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273716735">(Mar 01 2022 at 21:54)</a>:</h4>
<p>I was thinking like <code>core::panic</code>, but I guess that was actually a distinct module from <code>std::panic</code>, and actual re-exports within?</p>



<a name="273724373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273724373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273724373">(Mar 01 2022 at 22:57)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> <a href="https://github.com/rust-lang/rust/pull/94503">https://github.com/rust-lang/rust/pull/94503</a></p>



<a name="273724386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273724386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273724386">(Mar 01 2022 at 22:57)</a>:</h4>
<p>(still waiting to see if CI passes)</p>



<a name="273726129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273726129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273726129">(Mar 01 2022 at 23:11)</a>:</h4>
<p>Argh. <code>cfg_if</code> isn't usable from core. :(</p>



<a name="273726746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273726746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273726746">(Mar 01 2022 at 23:19)</a>:</h4>
<p><code>cfg_if</code> really should either be in core or we should add an equivalent language feature. I'm still not sure what such a language feature would look like though.</p>



<a name="273727270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273727270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273727270">(Mar 01 2022 at 23:23)</a>:</h4>
<p>At the moment, I'm <em>tempted</em> to copy-paste the implementation of <code>cfg_if</code> into core and just not export it. :)</p>



<a name="273727365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273727365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273727365">(Mar 01 2022 at 23:24)</a>:</h4>
<p>I'm also tempted to just temporarily revert the patch that used <code>cfg_if</code> in <code>std::os::raw</code>.</p>



<a name="273729052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273729052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273729052">(Mar 01 2022 at 23:39)</a>:</h4>
<p>Incidentally, if the compiler starts evaluating all cfg paths, that extra cost that was mentioned in today's T-lang meeting hits cfg-if the hardest (because it generates big big piles of cfg)</p>



<a name="273767950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273767950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273767950">(Mar 02 2022 at 07:54)</a>:</h4>
<p>my concern with splitting libc (or this plan anyway) is that it will make it more annoying to support cross-platform dev, for example, consider the case where some non-standard function is available on a handful of unix targets. now i need to check each extension libc, and a new OS that has that functionality won't work out of the box until I add another crate dependency.</p>
<p>Also, long term, once we have <code>#[cfg(available(...))]</code>, it'd be nice if <code>#[cfg(available(libc::getloadavg))]</code> or something worked to support "all systems with this API", whereas there's no way to do that cleanly if we split things up</p>



<a name="273768488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273768488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273768488">(Mar 02 2022 at 08:00)</a>:</h4>
<p>cfg available is not correct for this use case. Some OSes may give it a different api or different semantics.</p>



<a name="273770586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273770586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273770586">(Mar 02 2022 at 08:21)</a>:</h4>
<p>It's imperfect in that it's prone to a compile error if they have different types. I suppose in principal they could give it different behavior too, but that's fairly unlikely in practice. It's also no worse than what you'd get in C.</p>



<a name="273797898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273797898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273797898">(Mar 02 2022 at 12:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273767950">said</a>:</p>
<blockquote>
<p>my concern with splitting libc (or this plan anyway) is that it will make it more annoying to support cross-platform dev, for example, consider the case where some non-standard function is available on a handful of unix targets. now i need to check each extension libc, and a new OS that has that functionality won't work out of the box until I add another crate dependency.</p>
<p>Also, long term, once we have <code>#[cfg(available(...))]</code>, it'd be nice if <code>#[cfg(available(libc::getloadavg))]</code> or something worked to support "all systems with this API", whereas there's no way to do that cleanly if we split things up</p>
</blockquote>
<p>libc would also still be hardcoded with platform support. I'd like to see that cease to be a thing.</p>



<a name="273810481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273810481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273810481">(Mar 02 2022 at 13:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273767950">said</a>:</p>
<blockquote>
<p>my concern with splitting libc (or this plan anyway) is that it will make it more annoying to support cross-platform dev, for example, consider the case where some non-standard function is available on a handful of unix targets. now i need to check each extension libc, and a new OS that has that functionality won't work out of the box until I add another crate dependency.</p>
<p>Also, long term, once we have <code>#[cfg(available(...))]</code>, it'd be nice if <code>#[cfg(available(libc::getloadavg))]</code> or something worked to support "all systems with this API", whereas there's no way to do that cleanly if we split things up</p>
</blockquote>
<p>that's an argument in favor of continuing to provide a libc facade that exports all the platform-specific crates, but not an argument against merely having those platform specific crates, which is what my own use case requires, since libc's built-in <code>cfg</code>s mean that  the symbols that I need aren't visible on the target I'm compiling for</p>



<a name="273812240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273812240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273812240">(Mar 02 2022 at 14:10)</a>:</h4>
<p>the crates could still live in the same git repo anyway</p>



<a name="273856500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273856500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273856500">(Mar 02 2022 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273797898">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273767950">said</a>:</p>
<blockquote>
<p>my concern with splitting libc (or this plan anyway) is that it will make it more annoying to support cross-platform dev, for example, consider the case where some non-standard function is available on a handful of unix targets. now i need to check each extension libc, and a new OS that has that functionality won't work out of the box until I add another crate dependency.</p>
<p>Also, long term, once we have <code>#[cfg(available(...))]</code>, it'd be nice if <code>#[cfg(available(libc::getloadavg))]</code> or something worked to support "all systems with this API", whereas there's no way to do that cleanly if we split things up</p>
</blockquote>
<p>libc would also still be hardcoded with platform support. I'd like to see that cease to be a thing.</p>
</blockquote>
<p>That's a policy question that isn't obvious. The <em>downside</em> of not checking platform support in libc is that you would no longer know at compile time if a function is supported on the target you're compiling for.</p>



<a name="273859714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273859714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273859714">(Mar 02 2022 at 19:02)</a>:</h4>
<p>I like that this works at compile time since <code>cargo check --target=blah</code>  is very handy.</p>



<a name="273861660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273861660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273861660">(Mar 02 2022 at 19:15)</a>:</h4>
<p>You can still check without hardcoding, albeit it takes more build time from clean.</p>



<a name="273863947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273863947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273863947">(Mar 02 2022 at 19:31)</a>:</h4>
<p>Hm, I must have misunderstood what you mean. Would I need to have headers installed then?</p>



<a name="273864089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273864089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273864089">(Mar 02 2022 at 19:32)</a>:</h4>
<p>For those checks, yes.</p>



<a name="273864538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273864538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273864538">(Mar 02 2022 at 19:36)</a>:</h4>
<p>not requiring headers is better, if possible (I'm not sure if it's possible here).</p>



<a name="273866466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273866466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273866466">(Mar 02 2022 at 19:50)</a>:</h4>
<p>Would the <code>libc-linux-glibc</code> crate have features corresponding to versions of glibc that introduce new API surface? (Does such a question even make sense?)</p>



<a name="273868807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273868807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273868807">(Mar 02 2022 at 20:05)</a>:</h4>
<p>Right. We should <em>never</em> depend on the installed system's headers and the features of those. Being able to build using libc without having headers available is a great Rust feature we shouldn't abandon.</p>



<a name="273869640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273869640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273869640">(Mar 02 2022 at 20:11)</a>:</h4>
<p>The other side of that, though, is that you can end up with targets being unsupported because they aren't (with no technical reason),</p>



<a name="273870317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870317">(Mar 02 2022 at 20:17)</a>:</h4>
<p>There is a technical reason: because we don't know what they support, and we don't do compile-time detection of platform capabilities because that makes the capabilities depend on the system we build on.</p>



<a name="273870336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870336">(Mar 02 2022 at 20:17)</a>:</h4>
<p>That is absolutely a tradeoff, with positives and negatives in both directions.</p>



<a name="273870424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870424">(Mar 02 2022 at 20:18)</a>:</h4>
<p>In general, I do understand and acknowledge your preference for being able to best-effort a target without having to get support upstream. I don't think that's what we should do in libc or std or rustc, though.</p>



<a name="273870545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870545">(Mar 02 2022 at 20:19)</a>:</h4>
<p>I've dealt with <code>./configure</code> scripts far too many times, and AFAICT Linux distributors systematically override the autodetection by passing explicit <code>--enable-</code> and <code>--disable-</code> flags for everything, to make the build less fragile.</p>



<a name="273870628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870628">(Mar 02 2022 at 20:20)</a>:</h4>
<p>And that's leaving aside the issue that we want to work towards better support for building on a system with new libc and running on a system with old, or vice versa.</p>



<a name="273870673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870673">(Mar 02 2022 at 20:20)</a>:</h4>
<p>Right now you can build on a system with old libc and still build code that calls new functions your headers don't have.</p>



<a name="273870796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273870796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273870796">(Mar 02 2022 at 20:21)</a>:</h4>
<p>Indeed. I like the "if there's no reason why it can't, then it should work" perspective because it minimizes the issues where support is impossible because something somewhere in a dep tree has zero clue a target even exists.</p>



<a name="273871184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273871184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273871184">(Mar 02 2022 at 20:24)</a>:</h4>
<p>FWIW, I <em>do</em> want to move away from hand-written libc bindings to something like bindgen, but I think we should do that by shipping a copy of the newest headers, not by ever using the system headers.</p>



<a name="273873483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273873483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273873483">(Mar 02 2022 at 20:40)</a>:</h4>
<p>I think Zig just ships a huge pile of info to have data on all the libc variations across all their major cross compile targets so that you can always cross compile to anywhere from anywhere. And that's probably fine enough really because it's not a radical amount of extra code for each target (compared to the size of the rest of the toolchain).</p>



<a name="273873592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273873592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273873592">(Mar 02 2022 at 20:41)</a>:</h4>
<p>(I don't know if it's C headers or Zig files or what format exactly)</p>



<a name="273875528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273875528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273875528">(Mar 02 2022 at 20:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/the.20splittening.20of.20libc/near/273873592">said</a>:</p>
<blockquote>
<p>(I don't know if it's C headers or Zig files or what format exactly)</p>
</blockquote>
<p>It's <a href="https://github.com/ziglang/glibc-abi-tool/"><code>.abilist</code></a> files, if this is what you are talking about. IIRC someone came on here not too long ago with a rust parser for these files</p>



<a name="273875709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273875709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273875709">(Mar 02 2022 at 20:58)</a>:</h4>
<p><a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Integrating.20Zig's.20.60abilists.60.20project.20for.20.60glibc.60.20symbols/near/272194000">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Integrating.20Zig's.20.60abilists.60.20project.20for.20.60glibc.60.20symbols/near/272194000</a></p>



<a name="273947384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/273947384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#273947384">(Mar 03 2022 at 09:44)</a>:</h4>
<p>Zig uses both C headers and abilist symbols: the C headers are parsed to get function prototypes and the abilist is used to figure out which symbol to link to.</p>



<a name="274211859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/274211859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#274211859">(Mar 05 2022 at 01:50)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="220097">@Erich Gubler</span> you may be interested in this conversation, or at least its recent turn.</p>



<a name="274266813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/274266813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#274266813">(Mar 05 2022 at 21:51)</a>:</h4>
<p>Heck yes I am, thanks <span class="user-mention" data-user-id="281757">@Jubilee</span>! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="274266889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/the%20splittening%20of%20libc/near/274266889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erich Gubler <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/the.20splittening.20of.20libc.html#274266889">(Mar 05 2022 at 21:53)</a>:</h4>
<p>For context of others, I'm the someone who <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> mentioned wrote an <code>abilists</code> parser.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>