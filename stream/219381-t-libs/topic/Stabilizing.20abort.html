<html>
<head><meta charset="utf-8"><title>Stabilizing abort · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html">Stabilizing abort</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267078814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267078814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267078814">(Jan 06 2022 at 16:11)</a>:</h4>
<p>What's the current blockers for stabilizing <code>core::intrinsics::abort</code> under a stable safe function?</p>
<p>(I seem to remember <span class="user-mention" data-user-id="239881">@Josh Triplett</span>  saying something about LLVM not having trap instructions for all the backend, but maybe I'm misremembering)</p>



<a name="267105027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267105027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267105027">(Jan 06 2022 at 19:45)</a>:</h4>
<p>Assuming that intrinsic works on all our targets, I don't see any reason we couldn't stabilize it.</p>



<a name="267105186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267105186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267105186">(Jan 06 2022 at 19:46)</a>:</h4>
<p>I think we want to confirm that the stabilized version inlines down to a single trap instruction; we should make sure it doesn't become a function call instead.</p>



<a name="267106927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267106927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267106927">(Jan 06 2022 at 20:01)</a>:</h4>
<p>why is a trap instruction a requirement? I could see this possibly being a compiler-builtin call on some targets, just like libm lowering and such.</p>



<a name="267108048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267108048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267108048">(Jan 06 2022 at 20:11)</a>:</h4>
<p>it's currently a call to <code>@llvm.trap</code>:<br>
<a href="https://llvm.org/docs/LangRef.html#llvm-trap-intrinsic">https://llvm.org/docs/LangRef.html#llvm-trap-intrinsic</a></p>
<blockquote>
<p>This intrinsic is lowered to the target dependent trap instruction. If the target does not have a trap instruction, this intrinsic will be lowered to a call of the <code>abort()</code> function.</p>
</blockquote>



<a name="267108432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267108432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267108432">(Jan 06 2022 at 20:14)</a>:</h4>
<p>cg_gcc unconditionally calls <code>abort()</code></p>



<a name="267110888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267110888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267110888">(Jan 06 2022 at 20:36)</a>:</h4>
<p>abort() isn't available on targets without libc.</p>



<a name="267111613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267111613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267111613">(Jan 06 2022 at 20:42)</a>:</h4>
<p>it doesn't <em>have</em> to be from <code>libc</code> -- same situation as stuff like <code>memcpy</code>, no?</p>



<a name="267117427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267117427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267117427">(Jan 06 2022 at 21:29)</a>:</h4>
<p>memcpy is provided by compiler-builtins and can be implemented without os support. abort has to have os support on architectures without trap instruction.</p>



<a name="267118101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267118101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267118101">(Jan 06 2022 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/267117427">said</a>:</p>
<blockquote>
<p>memcpy is provided by compiler-builtins and can be implemented without os support. abort has to have os support on architectures without trap instruction.</p>
</blockquote>
<p>Or architecture support via SIGILLs</p>



<a name="267118114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267118114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267118114">(Jan 06 2022 at 21:36)</a>:</h4>
<p>I mean, technically any kind of illegal opcode handler needs <em>some</em> form of OS support...</p>



<a name="267119050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267119050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267119050">(Jan 06 2022 at 21:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/267106927">said</a>:</p>
<blockquote>
<p>why is a trap instruction a requirement? I could see this possibly being a compiler-builtin call on some targets, just like libm lowering and such.</p>
</blockquote>
<p>I don't think a trap instruction is a requirement; rather, if the target <em>does</em> have a trap instruction, I'd want to avoid the case where <code>core::something::abort</code> compiles to a non-inline call to a function that <em>contains</em> a trap instruction, rather than an inline trap instruction.</p>



<a name="267119261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267119261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267119261">(Jan 06 2022 at 21:48)</a>:</h4>
<p>Why does it matter whether it's inline?</p>



<a name="267120736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267120736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267120736">(Jan 06 2022 at 22:00)</a>:</h4>
<p>A single inline instruction is much smaller than an out-of-line function call, and some programs want to be able to sprinkle aborts <em>everywhere</em>. As an example, the Linux kernel can compile <code>BUG</code> invocations to a single trap instruction, and there are enough of those that the size matters for size optimization.</p>



<a name="267120799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267120799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267120799">(Jan 06 2022 at 22:00)</a>:</h4>
<p>Also, it's a little easier to debug if the trap instruction is inline.</p>



<a name="267120843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267120843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267120843">(Jan 06 2022 at 22:00)</a>:</h4>
<p>(For instance, sometimes you might want to stick a trap instruction somewhere and nop it out at runtime in a debugger.)</p>



<a name="267120943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267120943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267120943">(Jan 06 2022 at 22:01)</a>:</h4>
<p>If this intrinsic compiles to anything <em>more</em> than a trap instruction, then users who want it to become a single trap instruction will instead find it necessary to use (say) <code>asm!("int 3");</code> rather than the intrinsic, and thus invent their own such <code>#[inline(always)]</code> function with a pile of <code>cfg</code>.</p>



<a name="267121980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267121980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267121980">(Jan 06 2022 at 22:11)</a>:</h4>
<p>Single trap instruction does not necessarily mean minimally-represented such instruction, though. To play devil's advocate, the <code>int 3</code> could become <code>cd03</code>, and now we'd still have people hard-coding <code>asm!(".byte 0xcc")</code> to guarantee the one-byte instruction <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> </p>
<p>So I guess the requirement could become something along the lines of: the implementation should strive for "minimal bytecode" on each platform.</p>



<a name="267122895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267122895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267122895">(Jan 06 2022 at 22:17)</a>:</h4>
<p>Fair, though I would expect any decent assembler to generate the shortest representation of any given instruction unless it had a good reason to do otherwise.</p>



<a name="267123205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267123205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267123205">(Jan 06 2022 at 22:20)</a>:</h4>
<p>How would you handle this on a freestanding target such as w65, which has no defined interrupts resulting from code execution (other than <code>brk</code>, which may be used otherwise by the software and cannot be freely used in the general case, or <code>cop</code>, which is mostly for co-processor calls), absent external tools. <br>
The only other option (other than implementing it as <code>s/abort/unreachable/</code>) would be <code>STP</code> to halt execution entirely (although I believe that some instruction sets may not even have something like this), which cannot be handled at all.</p>



<a name="267123546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267123546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267123546">(Jan 06 2022 at 22:24)</a>:</h4>
<p>Obviously, you could require an <code>abort</code> function be providedm but then the same burden is shifted there, and the choice made there may be similarily undesirable.</p>



<a name="267123555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267123555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267123555">(Jan 06 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/267120843">said</a>:</p>
<blockquote>
<p>(For instance, sometimes you might want to stick a trap instruction somewhere and nop it out at runtime in a debugger.)</p>
</blockquote>
<p>that sometimes won't work, because optimizations will remove all instructions after the trap because the compiler sees they are unreachable. replacing the trap with a nop would lead to the program doing something completely different than was in the original source following <code>abort</code></p>



<a name="267126431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267126431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267126431">(Jan 06 2022 at 22:54)</a>:</h4>
<p><code>core::intrinsics::abort()</code> is the most common case that I use <code>#![feature(core_intrinsics)]</code>, it would be good to stabilize.</p>
<blockquote>
<p>The only other option (other than implementing it as s/abort/unreachable/) would be STP</p>
</blockquote>
<p>What's the issue here? To me it seems reasonable to me for a baremetal target to implement aborting in a way that cannot be handled (including halting the processor, or even turning off the machine if that's literally the only option).</p>
<p>That is: IMO it would be wrong for it to go the other way, and try to guarantee that the operation <em>can</em> be handled by somewhere, although generally it will probably invoke some interrupt in practice, where the OS (or whatever is acting like it) would handle it somehow.</p>
<blockquote>
<p>although I believe that some instruction sets may not even have something like this</p>
</blockquote>
<p>Keep in mind that the language already requires aborts happen somehow (double panics, for example) — someone porting rust to <code>#[cfg(target_arch = "the-cpu-which-cannot-be-stopped")]</code> will already have to deal with this in some manner.</p>
<p>That is, unless I'm mistaken, you can already force an abort on such targets — <code>intrinsics::abort</code> allows code would allow code that doesn't want to use the double panic trick for whatever reason (example: signal handlers, code that has detected memory corruption (sounds bad to risk calling the panic handler), ...) to abort directly.</p>
<p>As a very last resort, I guess it would be reasonable for this be an infinite loop on a target that has literally no other options. At least as long as that target is single threaded (I imagine any target with threads has to have some option here).</p>



<a name="267126710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267126710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267126710">(Jan 06 2022 at 22:57)</a>:</h4>
<p>FWIW all the current targets seemed to implement this somehow last time I checked (often something very clever, like jumping to a misaligned instruction)</p>



<a name="267128329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267128329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267128329">(Jan 06 2022 at 23:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/267126431">said</a>:</p>
<blockquote>
<p>Keep in mind that the language already requires aborts happen somehow (double panics, for example) — someone porting rust to <code>#[cfg(target_arch = "the-cpu-which-cannot-be-stopped")]</code> will already have to deal with this in some manner.</p>
</blockquote>
<p>Double panics, unwind into <code>extern "C"</code>, and other aborts related to panic depend on the provided panic hook actually unwinding. IIRC, only <code>panic="immediate-abort"</code> actually forces an abort without consulting the panic hook.</p>



<a name="267268892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267268892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267268892">(Jan 08 2022 at 02:24)</a>:</h4>
<p>Panic hooks only exist with std. Do you mean panic handlers?</p>



<a name="267269176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267269176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267269176">(Jan 08 2022 at 02:32)</a>:</h4>
<p><code>abort</code> is being used when <code>Arc</code>/<code>Rc</code> ref count overflow, so all targets supporting liballoc needs to support aborting. (And I don't think we have any targets <em>not</em> supporting liballoc)</p>



<a name="267280341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267280341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267280341">(Jan 08 2022 at 06:49)</a>:</h4>
<p>There certainly exist no_std targets that can't abort to anywhere but that can allocate via a global allocator.</p>



<a name="267433379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267433379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267433379">(Jan 10 2022 at 12:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/267280341">said</a>:</p>
<blockquote>
<p>There certainly exist no_std targets that can't abort to anywhere but that can allocate via a global allocator.</p>
</blockquote>
<p>Any existing ones? if so how does the Arc/Rc work there? (<a href="https://doc.rust-lang.org/src/alloc/rc.rs.html#2450">https://doc.rust-lang.org/src/alloc/rc.rs.html#2450</a>)</p>



<a name="267453725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267453725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267453725">(Jan 10 2022 at 15:34)</a>:</h4>
<p>Most likely because an <code>abort</code> symbol is provided when LLVM lowers the intrinsic to an <code>abort</code> call.</p>



<a name="267506710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267506710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267506710">(Jan 10 2022 at 21:57)</a>:</h4>
<p>I wonder if we can add a weak <code>abort</code> function to compiler builtins that just calls <code>core::intrinsic::abort()</code></p>



<a name="267506906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267506906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267506906">(Jan 10 2022 at 21:58)</a>:</h4>
<p>So if the target has a trap instruction, it will just contain that; for a target with properly defined <code>abort</code> that gets used because this one is weak; if the target doesn't have trap instruction or an <code>abort</code> function then it becomes an infinite recursion.</p>



<a name="267513100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267513100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267513100">(Jan 10 2022 at 22:50)</a>:</h4>
<p>Weak functions are not universally supported AFAIK.</p>



<a name="267523267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267523267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267523267">(Jan 11 2022 at 00:51)</a>:</h4>
<p>compiler-builtins use <code>#[cfg_attr(not(all(target_os = "windows", target_env = "gnu")), linkage = "weak")]</code> for memcpy/memset etc, so I suppose we could just continue to use that.</p>



<a name="267529396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267529396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267529396">(Jan 11 2022 at 02:28)</a>:</h4>
<p>Is it actually just mingw that doesn't support weak linkage? Any reason why (that's still using COFF like msvc does, IIRC)?</p>



<a name="267530733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267530733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267530733">(Jan 11 2022 at 02:55)</a>:</h4>
<p>Only ELF properly supports weak linkage. It's present only in a very limited form in Mach-O and COFF.</p>



<a name="267530785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267530785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267530785">(Jan 11 2022 at 02:56)</a>:</h4>
<p>Personally I'm be in favor of expanding the set of functions we require in compiler-builtins by providing them as weak functions.</p>



<a name="267656258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267656258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267656258">(Jan 11 2022 at 22:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="249222">Elichai Turkel</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/267433379">said</a>:</p>
<blockquote>
<p>Any existing ones? if so how does the Arc/Rc work there? (<a href="https://doc.rust-lang.org/src/alloc/rc.rs.html#2450">https://doc.rust-lang.org/src/alloc/rc.rs.html#2450</a>)</p>
</blockquote>
<p>I think this is a good point. If <code>intrinsics::abort</code> is the right choice for <code>Rc</code> then it’s also probably the right choice for some non-standard-library crates (in some specific situations). <code>Rc</code> is not that special</p>



<a name="267656980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/267656980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#267656980">(Jan 11 2022 at 22:40)</a>:</h4>
<blockquote>
<p>It's present only in a very limited form in Mach-O </p>
</blockquote>
<p>I mean, sort of. Mach-O supports weak_import/extern_weak, and uses it for essentially every system-provided symbol. The reason "sort of" is just that it doesn't have exactly the same semantics (without more work), although its semantics seem like they'd be usable semantics (it's for externally provided symbol which come through as null if not linked in). Yeah, that's not the exact same, as it doesn't allow directly defaulting the pointer, but is close enough for this.</p>



<a name="269171406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269171406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269171406">(Jan 24 2022 at 20:55)</a>:</h4>
<p>Is there anything I can do here that might help push this forward?<br>
(gather some information on <code>abort</code> uses in stdlib, look into llvm to check which targets <em>dont</em> support the abort intrinsic?)</p>
<p>FYI even libcore uses <code>abort</code>(only called in debug) <a href="https://github.com/rust-lang/rust/blob/master/library/core/src/ptr/mod.rs#L1053">https://github.com/rust-lang/rust/blob/master/library/core/src/ptr/mod.rs#L1053</a></p>



<a name="269179755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269179755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269179755">(Jan 24 2022 at 22:08)</a>:</h4>
<p>One question is which module should we expose <code>abort</code> in? Also I feel like the name <code>trap</code> may be more appropriate: you would normally expect <code>abort</code> to actually abort the process with a <code>SIGABRT</code>.</p>



<a name="269182647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269182647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269182647">(Jan 24 2022 at 22:36)</a>:</h4>
<p>How about <code>core::panic::abort()</code>?</p>



<a name="269211222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269211222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269211222">(Jan 25 2022 at 05:22)</a>:</h4>
<p>Hrm. Putting it under <code>panic</code> seems slightly misleading, since it doesn't actually panic, it does something entirely different (trapping).</p>



<a name="269211226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269211226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269211226">(Jan 25 2022 at 05:23)</a>:</h4>
<p>And in particular people might think it's related to panic=abort.</p>



<a name="269211245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269211245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269211245">(Jan 25 2022 at 05:23)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> Calling it "trap" seems like a great idea to me.</p>



<a name="269217547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269217547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269217547">(Jan 25 2022 at 07:19)</a>:</h4>
<p><code>core::panic::abort</code> should go through the panic handler (with <a href="https://doc.rust-lang.org/nightly/core/panic/struct.PanicInfo.html#method.can_unwind"><code>can_unwind</code></a> = false) so that the panic_handler implementation can select the best way to abort the process.</p>



<a name="269217653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269217653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269217653">(Jan 25 2022 at 07:20)</a>:</h4>
<p>The specific semantics that we want here are different: it's the shortest instruction sequence that causes execution to stop.</p>



<a name="269218519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269218519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269218519">(Jan 25 2022 at 07:33)</a>:</h4>
<p><span class="user-mention" data-user-id="249222">@Elichai Turkel</span> Actually since you brought this up, are you more interested in a <code>trap</code> feature like the current <code>intrinsics::abort</code> or rather in something that goes through the panic handler like I described?</p>



<a name="269219699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269219699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269219699">(Jan 25 2022 at 07:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269218519">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="249222">Elichai Turkel</span> Actually since you brought this up, are you more interested in a <code>trap</code> feature like the current <code>intrinsics::abort</code> or rather in something that goes through the panic handler like I described?</p>
</blockquote>
<p>My use case is a no_std library that does rust-&gt;C-&gt;rust and I need to abort in the inner rust.<br>
If using the panic machinery allows to do this safely then that feels "better" (and might make  it easier to stabilize because new architectures need to provide panic handlers anyway) but the trap one works just as well for my use case :)</p>



<a name="269232106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269232106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269232106">(Jan 25 2022 at 09:50)</a>:</h4>
<p>Many of the times when I've needed intrinsics::abort(), it's been because allocation (and more broadly running arbitrary code) would be unacceptable (either for signal safety reasons, because it's in a handler for detected memory corruption, etc). Going through the panic handler would be unacceptable here.</p>
<p>That's not to say there's no use case for that (although that usecase is somewhat already handled by forcing a double-panic, which both aborts and calls panic handlers IIRC), but I just wanted to voice my support for having something like the current <code>intrinsics::abort()</code>.</p>



<a name="269242655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269242655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269242655">(Jan 25 2022 at 11:22)</a>:</h4>
<p>I think there's 2 different use cases here which deserve separate solutions:</p>



<a name="269242748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269242748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269242748">(Jan 25 2022 at 11:23)</a>:</h4>
<p>1) I want to panic but I don't want to unwind. The solution is to introduce a <code>#[nounwind]</code> attribute on functions to prevent any panics from escaping them. This is already implemented in the compiler with <code>#[rustc_allocator_nounwind]</code>. <code>extern "C"</code> already does this when used with <code>#![feature(c_unwind)]</code>.</p>



<a name="269242915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269242915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269242915">(Jan 25 2022 at 11:25)</a>:</h4>
<p>2) I want to abort execution immediately because my program is in a broken state. The solution is to introduce <code>core::mem::trap</code> which works the same way as the current <code>core::intrinsics::abort</code>. This generates a trapping instruction on targets that support it, and calls <code>abort</code> otherwise. You are responsible for providing an <code>abort</code> function on platforms that require one.</p>



<a name="269297503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269297503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269297503">(Jan 25 2022 at 18:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269217547">said</a>:</p>
<blockquote>
<p><code>core::panic::abort</code> should go through the panic handler (with <a href="https://doc.rust-lang.org/nightly/core/panic/struct.PanicInfo.html#method.can_unwind"><code>can_unwind</code></a> = false) so that the panic_handler implementation can select the best way to abort the process.</p>
</blockquote>
<p>related: <a href="https://github.com/rust-lang/project-error-handling/issues/34">https://github.com/rust-lang/project-error-handling/issues/34</a></p>



<a name="269347329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269347329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269347329">(Jan 26 2022 at 00:36)</a>:</h4>
<p>I too would like to see a <code>core::mem::trap</code> because it's a bummer that the standard library can have a lighter-weight debug assertion than the rest of the ecosystem (we can _technically_ use intrinsics, but there's a spooky warning sign on them).</p>



<a name="269347365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269347365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269347365">(Jan 26 2022 at 00:37)</a>:</h4>
<p>I think that's a somewhat unavoidable step of the standard library development process</p>



<a name="269433385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269433385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269433385">(Jan 26 2022 at 15:53)</a>:</h4>
<p>Well it's avoided by just providing <code>core::mem::trap</code>.</p>



<a name="269461688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269461688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269461688">(Jan 26 2022 at 18:49)</a>:</h4>
<p>FWIW I think <code>abort</code> is a better name than <code>trap</code> which is very jargon-y. This seems like a generally useful function, not just for those who know about CPU exception handling</p>



<a name="269462796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269462796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269462796">(Jan 26 2022 at 18:56)</a>:</h4>
<p>Also, what is the relation to the operation that happens when you <code>panic!</code> when <code>panic=abort</code> is set? If it is the same abort, then I would suggest keeping a consistent name, and conversely if it is a different operation then it should have a different name.</p>



<a name="269463327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269463327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269463327">(Jan 26 2022 at 19:00)</a>:</h4>
<p>I think of <code>core::mem::trap</code> as "oh shit I corrupted my memory, abort <em>now</em>". <code>panic!</code> is quite an involved process since it calls panic hooks, takes locks, prints to stderr, etc.</p>



<a name="269466190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269466190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269466190">(Jan 26 2022 at 19:17)</a>:</h4>
<p>based on that description, would it be correct to say that <code>core::mem::trap</code> is an unsafe function (because we're just doing e.g. <code>ud2</code> and who knows what will happen after that) while <code>core::panic::abort</code> is not (because it goes through a controlled shutdown)?</p>



<a name="269466455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269466455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269466455">(Jan 26 2022 at 19:19)</a>:</h4>
<p>I think <code>trap</code> is safe the same way our aborts on stack overflow are safe, despite not always being particularly graceful.</p>



<a name="269466505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269466505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269466505">(Jan 26 2022 at 19:19)</a>:</h4>
<p><code>core::intrinsics::abort</code> is currently a safe function. I don't see what we'd gain by making an unsafe version that does the same thing</p>



<a name="269466531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269466531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269466531">(Jan 26 2022 at 19:19)</a>:</h4>
<p>And thus it's registering the interrupt handlers that could resume after an invalid instruction that would be <code>unsafe</code>.</p>



<a name="269466550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269466550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269466550">(Jan 26 2022 at 19:20)</a>:</h4>
<p><code>core::arch::crash()</code></p>



<a name="269468711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269468711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269468711">(Jan 26 2022 at 19:34)</a>:</h4>
<p><code>halt_and_catch_fire()</code></p>



<a name="269468930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269468930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269468930">(Jan 26 2022 at 19:35)</a>:</h4>
<p>(joking aside, i honestly think <code>crash</code> is a much clearer and more common term for this kind of thing)</p>



<a name="269469059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269469059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269469059">(Jan 26 2022 at 19:36)</a>:</h4>
<p>I definitely prefer crash over trap</p>



<a name="269469149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269469149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269469149">(Jan 26 2022 at 19:37)</a>:</h4>
<p>which speaking personally is somewhat triggering as terms go, even if the usage here is different from the slur usage</p>



<a name="269469504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269469504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269469504">(Jan 26 2022 at 19:39)</a>:</h4>
<p>I was definitely joking, but an HCF-like instruction might be required to <em>implement</em> this in some contexts, like bare metal with no "process" to  crash</p>



<a name="269470593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269470593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269470593">(Jan 26 2022 at 19:47)</a>:</h4>
<p><code>loop {}</code> should be fine on single-thread machines, no?</p>



<a name="269471157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269471157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269471157">(Jan 26 2022 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> Only if we have no better alternative. Hanging isn't as good as rebooting; you can often recover from a reboot, but not a hang.</p>



<a name="269471178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269471178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269471178">(Jan 26 2022 at 19:51)</a>:</h4>
<p>(though if there's a watchdog they're equivalent)</p>



<a name="269472936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269472936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269472936">(Jan 26 2022 at 20:02)</a>:</h4>
<p>I don't mind <code>crash</code>.</p>



<a name="269473104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269473104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269473104">(Jan 26 2022 at 20:04)</a>:</h4>
<p>For platforms that don't have a trapping instruction, we should just let LLVM emit a call to <code>abort</code> and document it. Leave it to users to handle this however they want.</p>



<a name="269474033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269474033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269474033">(Jan 26 2022 at 20:11)</a>:</h4>
<p>Is it correct to say that <code>core::mem::crash</code>/<code>trap</code>/w/e is "shutdown right now" vs. <code>core::panic::abort</code> which is "Terminate the same way that panicking would"?</p>



<a name="269474457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269474457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269474457">(Jan 26 2022 at 20:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269474033">said</a>:</p>
<blockquote>
<p>Is it correct to say that <code>core::mem::crash</code>/<code>trap</code>/w/e is "shutdown right now" vs. <code>core::panic::abort</code> which is "Terminate the same way that panicking would"?</p>
</blockquote>
<p>That sounds accurate though I'd probably describe it slightly differently. Instead I'd say that <code>core::panic::abort</code> is a panic that does not unwind, <code>core::panic::panic</code> is a panic that may unwind, and <code>core::mem::crash</code> is not a panic. The panic variants are used to represent and report unrecoverable errors, <code>core::mem::crash</code> is used to immediately crash the program, though it doesn't intrinsicly mean it's due to an error (though practically its hard to imagine when else you'd use it).</p>



<a name="269477035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269477035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269477035">(Jan 26 2022 at 20:29)</a>:</h4>
<p>Does <code>core::mem::crash</code> take an exit code / does it have any control over the exit code? Or are these always going to look like abnormal termination externally</p>



<a name="269477500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269477500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269477500">(Jan 26 2022 at 20:32)</a>:</h4>
<p>no, if you want an exit code, use <code>std::process::exit</code></p>



<a name="269480130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269480130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269480130">(Jan 26 2022 at 20:51)</a>:</h4>
<p>it feels like a bit of a menagerie, between panic (which is sometimes an abort), exit, and now crash :P</p>



<a name="269480833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269480833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269480833">(Jan 26 2022 at 20:56)</a>:</h4>
<p>by <code>core::panic::abort</code>, are people talking about the existing <code>std::process::abort</code>, or is this yet another new function?</p>



<a name="269480936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269480936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269480936">(Jan 26 2022 at 20:57)</a>:</h4>
<p>if nothing else it would be nice to see all this terminology become consistent and untuitive</p>



<a name="269482003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482003">(Jan 26 2022 at 21:05)</a>:</h4>
<p>I don't think we need <code>core::panic::abort</code>. All of the use cases for that can be covered by <code>panic!</code> + <code>#[nounwind]</code> on the function containing the panic.</p>



<a name="269482139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482139">(Jan 26 2022 at 21:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269482003">said</a>:</p>
<blockquote>
<p>I don't think we need <code>core::panic::abort</code>. All of the use cases for that can be covered by <code>panic!</code> + <code>#[nounwind]</code> on the function containing the panic.</p>
</blockquote>
<p>that seems fine but if we're going with that recommendation we should probably add an example documenting it so ppl don't keep asking for an aborting panic</p>



<a name="269482177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482177">(Jan 26 2022 at 21:06)</a>:</h4>
<p>though I do wonder if you might have a function where you want some of the panics to unwind and some to abort, but I guess you can just add an inner function in that case</p>



<a name="269482615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482615">(Jan 26 2022 at 21:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269480833">said</a>:</p>
<blockquote>
<p>by <code>core::panic::abort</code>, are people talking about the existing <code>std::process::abort</code>, or is this yet another new function?</p>
</blockquote>
<p>also dang, didn't realize we had this. What would be the difference between this and <code>core::mem::crash</code>?</p>



<a name="269482686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482686">(Jan 26 2022 at 21:10)</a>:</h4>
<p>I've wanted a panic! that doesn't print the default panic message, just exits the process with some exit code, but still unwinds to e.g. close/delete temporary files and run other Drop impls, FWIW.</p>



<a name="269482730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482730">(Jan 26 2022 at 21:10)</a>:</h4>
<p>It can be a pain to pipe that up with results or similar back to <code>main</code>.</p>



<a name="269482758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482758">(Jan 26 2022 at 21:10)</a>:</h4>
<p>i still want to separate the concepts of panics and unwinding</p>



<a name="269482781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482781">(Jan 26 2022 at 21:10)</a>:</h4>
<p><code>std::process::abort</code> calls libc and therefore can't be in core.</p>



<a name="269482835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482835">(Jan 26 2022 at 21:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <code>resume_unwind</code>?</p>



<a name="269482895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482895">(Jan 26 2022 at 21:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269482835">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <code>resume_unwind</code>?</p>
</blockquote>
<p>i hate the idea of recommending people use resume_unwind to begin unwinding when you weren't already unwinding</p>



<a name="269482911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482911">(Jan 26 2022 at 21:11)</a>:</h4>
<p>seems so counterintuitive</p>



<a name="269482941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269482941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269482941">(Jan 26 2022 at 21:11)</a>:</h4>
<p>yeah, I mean, it may "work" I guess, providing it a <code>Box&lt;()&gt;</code> or similar feels so odd though.</p>



<a name="269483002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269483002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269483002">(Jan 26 2022 at 21:12)</a>:</h4>
<p>yea, I don't personally feel satisfied with that as our answer to that problem</p>



<a name="269483144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269483144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269483144">(Jan 26 2022 at 21:13)</a>:</h4>
<p>I feel like mark's usecase would want a <code>std::thread::unwind</code> that doesn't take a payload</p>



<a name="269491933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269491933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269491933">(Jan 26 2022 at 22:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269482781">said</a>:</p>
<blockquote>
<p><code>std::process::abort</code> calls libc and therefore can't be in core.</p>
</blockquote>
<p>Not if you don't try hard enough <span aria-label="sunglasses" class="emoji emoji-1f60e" role="img" title="sunglasses">:sunglasses:</span></p>



<a name="269497702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269497702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269497702">(Jan 26 2022 at 23:17)</a>:</h4>
<p>I like the idea of <code>thread::unwind()</code>, although I'd make it take an optional payload; even if there is overlap with <code>resume_unwind</code>'s <em>current</em> implementation, I could envision a future where resuming could require there for a panic to have already occurred.</p>



<a name="269497707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269497707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269497707">(Jan 26 2022 at 23:17)</a>:</h4>
<p>Btw, does a no-op panic handler hook not achieve something similar right now (modulo toctou)? (I'm on mobile so hard to test, sry <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>)</p>



<a name="269499912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269499912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269499912">(Jan 26 2022 at 23:39)</a>:</h4>
<p>What would catch_unwind on <code>thread::unwind</code> without a payload return?</p>



<a name="269500034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269500034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269500034">(Jan 26 2022 at 23:41)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> I'm curious, what would you want to use the payload for?</p>



<a name="269500137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269500137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269500137">(Jan 26 2022 at 23:42)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I imagine some dummy payload with a zst private type you cant downcast to</p>



<a name="269500287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269500287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269500287">(Jan 26 2022 at 23:43)</a>:</h4>
<p>You could already do that yourself.</p>



<a name="269500944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269500944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269500944">(Jan 26 2022 at 23:52)</a>:</h4>
<p>Yea, I'm just talking about a conceptual separation, since I'd like unwinding to be treated as an implementation detail of panics rather than a synonym.</p>



<a name="269501031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269501031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269501031">(Jan 26 2022 at 23:53)</a>:</h4>
<p>What would <code>thread::unwind</code> do in <code>panic="abort"</code> crates?</p>



<a name="269501301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269501301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269501301">(Jan 26 2022 at 23:56)</a>:</h4>
<p>I have no idea, I imagine either it would still unwind or if panic=abort really means ban unwinding then we might want to deprecate that and replace it with an equivalent flag like --no-unwinding</p>



<a name="269501375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269501375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269501375">(Jan 26 2022 at 23:57)</a>:</h4>
<p>A big point of <code>panic=abort</code> is better codegen, which pretty much needs to mean no unwinding.</p>



<a name="269501496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269501496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269501496">(Jan 26 2022 at 23:58)</a>:</h4>
<p>Also regarding the earlier question about catching thread::unwinds, alternatively I can imagine having panic::catch_unwind only catch panics and have a new thread::catch_unwind that catches both forms of unwinding but doesn't expose the payload in either case.</p>



<a name="269503350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269503350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269503350">(Jan 27 2022 at 00:15)</a>:</h4>
<p>Vaguely related, I'm gonna draft up a model of error handling for rust so we can iteratively work towards a consensus on how all of these APIs should fit together and what our goals are</p>



<a name="269503449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269503449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269503449">(Jan 27 2022 at 00:16)</a>:</h4>
<p>Since I know a lot of ppl think about panics differently from how I do and I wanna know if i just need to document my model better or if I should give up on it</p>



<a name="269509453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269509453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269509453">(Jan 27 2022 at 00:34)</a>:</h4>
<p>panic=abort also avoids needing personality routines period.</p>



<a name="269509474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269509474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269509474">(Jan 27 2022 at 00:34)</a>:</h4>
<p>(Except with C-unwind which is <em>fun</em>)</p>



<a name="269542842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269542842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269542842">(Jan 27 2022 at 09:07)</a>:</h4>
<p>Getting back to the original question, can we stabilize abort? I think the extent of discussion here indicates that there is still design work to be done, so no. Given all these different ways to end a thread/process (I've lost track just reading this thread) I think the topic would benefit from a short write up with a nice table of the different ways to end, their relationships, and any holes in Rust's offerings. I feel like that would clear things up a lot (at least for me :-) )</p>



<a name="269547424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269547424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269547424">(Jan 27 2022 at 09:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269509474">said</a>:</p>
<blockquote>
<p>(Except with C-unwind which is <em>fun</em>)</p>
</blockquote>
<p>And ARM EHABI which requires a personality routine for backtraces.</p>



<a name="269564773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269564773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269564773">(Jan 27 2022 at 12:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269500034">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> I'm curious, what would you want to use the payload for?</p>
</blockquote>
<p>I'm ashamed to only be able to provide an example that polyfills <code>Result</code>s, when using a provided API that doesn't let the user fail (<em>e.g.</em>, visitor APIs). Here is an example:</p>
<ul>
<li><a href="https://github.com/danielhenrymantilla/with_locals.rs/blob/master/src/proc_macros/helpers/macros.rs#L7-L10">Definition</a> of <code>throw!</code></li>
<li><a href="https://github.com/danielhenrymantilla/with_locals.rs/blob/7bcda3beb8018eeeafa68fefac6803bd190a370e/src/proc_macros/handle_let_bindings.rs#L154-L156">Usage</a>.</li>
<li><a href="https://github.com/danielhenrymantilla/with_locals.rs/blob/7bcda3beb8018eeeafa68fefac6803bd190a370e/src/proc_macros/handle_let_bindings.rs#L30-L39">Catch-site / "landing pad"</a></li>
</ul>
<p>Now, it turns out that I didn't do things "that uglily", and that despite the usage of unwinding to "bail early" out of the visiting API, I still used a field inside the visitor to hold the error payload, if any. But another natural implementation would have been to send the error payload through the unwinding mechanism, and to pattern-match against an attempt to downcast such payload: so that's the use case of <code>thread::unwind(Some(…))</code> I have in mind <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="269564779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269564779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269564779">(Jan 27 2022 at 12:26)</a>:</h4>
<p>Meta: should we move the comments relative to unwinding to a new <em>thread</em> (heh)? As <span class="user-mention" data-user-id="256841">@Nick Cameron</span> pointed out, it's become hard to keep track of the <code>abort</code> discussion with this one about unwinding happening concurrently, but the one about unwinding is also an interesting topic!</p>



<a name="269856673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269856673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269856673">(Jan 29 2022 at 11:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/219381-t-libs/topic/Stabilizing.20abort/near/269497702">said</a>:</p>
<blockquote>
<p>I like the idea of <code>thread::unwind()</code>, although I'd make it take an optional payload; even if there is overlap with <code>resume_unwind</code>'s <em>current</em> implementation, I could envision a future where resuming could require there for a panic to have already occurred.</p>
</blockquote>
<p>I don't think so given how unwinding works. If you call <code>resume_unwind</code> then you must have <code>catch_unwind</code> already and from unwinder POV the unwinding has completed. The API also precludes us from adding any extra info (it's just <code>Box&lt;dyn Any + Send&gt;</code> rather than a new type around it).</p>



<a name="269860043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269860043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269860043">(Jan 29 2022 at 12:02)</a>:</h4>
<p>The documentation for <code>resume_unwind</code> says:</p>
<blockquote>
<p>Triggers a panic without invoking the panic hook.</p>
</blockquote>
<p>You can use it with a fresh <code>Box&lt;dyn Any + Send&gt;</code>, it doesn't have to be one returned by <code>catch_unwind</code>.</p>



<a name="269864393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Stabilizing%20abort/near/269864393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Stabilizing.20abort.html#269864393">(Jan 29 2022 at 13:30)</a>:</h4>
<p>In compiletest I switched a <code>panic!()</code> into a <code>resume_unwind</code> on test failure as a backtrace or panic message is completely useless.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>