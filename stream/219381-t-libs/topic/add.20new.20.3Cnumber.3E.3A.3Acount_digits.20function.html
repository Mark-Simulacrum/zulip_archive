<html>
<head><meta charset="utf-8"><title>add new &lt;number&gt;::count_digits function · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html">add new &lt;number&gt;::count_digits function</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257573486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257573486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257573486">(Oct 14 2021 at 17:28)</a>:</h4>
<p>Hello, where do I go from adding a new function to the std and how do I determine whether I should open an RFC on <a href="https://github.com/rust-lang/rfcs/issues">https://github.com/rust-lang/rfcs/issues</a> first or open a tracking issue on &lt;<a href="https://github.com/rust-lang/rust/issues">https://github.com/rust-lang/rust/issues</a>&gt; right away?</p>



<a name="257573936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257573936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257573936">(Oct 14 2021 at 17:31)</a>:</h4>
<p>you probably don't need an RFC</p>



<a name="257573949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257573949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257573949">(Oct 14 2021 at 17:31)</a>:</h4>
<p>And if what I have to do is open a tracking issue, where do I actually describe my feature anyway? I never really see a tracking issue have a descriptive description of what the feature does and why it's supposed to be added.</p>



<a name="257573975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257573975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257573975">(Oct 14 2021 at 17:31)</a>:</h4>
<p>asking about your specific idea here on zulip is a good start</p>



<a name="257573987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257573987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257573987">(Oct 14 2021 at 17:31)</a>:</h4>
<p>there's also this guide: <a href="https://std-dev-guide.rust-lang.org/">https://std-dev-guide.rust-lang.org/</a></p>



<a name="257574017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574017">(Oct 14 2021 at 17:32)</a>:</h4>
<p>Ah</p>



<a name="257574071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574071">(Oct 14 2021 at 17:32)</a>:</h4>
<p>didn't know about that guide! Where have you got that from?</p>



<a name="257574242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574242">(Oct 14 2021 at 17:33)</a>:</h4>
<p>I know it because I'm on the libs team, but I don't know if anything links to it off-hand</p>



<a name="257574282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574282">(Oct 14 2021 at 17:33)</a>:</h4>
<p><a href="https://github.com/rust-lang/libs-team/">https://github.com/rust-lang/libs-team/</a> mentions it</p>



<a name="257574298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574298">(Oct 14 2021 at 17:33)</a>:</h4>
<p>Ah I see</p>



<a name="257574381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574381">(Oct 14 2021 at 17:34)</a>:</h4>
<p>there is also <a href="https://forge.rust-lang.org/libs/index.html">https://forge.rust-lang.org/libs/index.html</a></p>



<a name="257574507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574507">(Oct 14 2021 at 17:35)</a>:</h4>
<p>it's entirely possible that things are inconsistent, but help is welcome!</p>



<a name="257574993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257574993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257574993">(Oct 14 2021 at 17:38)</a>:</h4>
<p>Alright I think I will give it a shot to try getting some opinions on my idea in here first.</p>



<a name="257579168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579168">(Oct 14 2021 at 18:05)</a>:</h4>
<p>Well.<br>
I hope this is a joke. I just spend half an hour writing this down and then I accidentally press some random something and now all my text is gone and undo/redo does nothing</p>



<a name="257579318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579318">(Oct 14 2021 at 18:06)</a>:</h4>
<p>It may be in drafts.</p>



<a name="257579440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579440">(Oct 14 2021 at 18:07)</a>:</h4>
<p>it's not there either sadly...<br>
To keep it short I wanted to add a <code>count_digits</code> that counts the digits of an integer <code>123.count_digits()</code> would be 3. Such a function could be a nicer wrapper for <code>integer.checked_log10().unwrap_or(0) as usize + 1</code>.<br>
I came up with this while working on <a href="https://github.com/rust-lang/rust/pull/89737">https://github.com/rust-lang/rust/pull/89737</a></p>



<a name="257579625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579625">(Oct 14 2021 at 18:08)</a>:</h4>
<p>Apart from better readability my other motivation was that if we provide such a function, the programmer can more easily avoid mistakes like <code>123.to_string().len()</code> to get the length</p>



<a name="257579652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579652">(Oct 14 2021 at 18:08)</a>:</h4>
<p>Because it's very inefficient.</p>



<a name="257579775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579775">(Oct 14 2021 at 18:09)</a>:</h4>
<p>Any thoughts? Maybe this has been discussed in the past?</p>



<a name="257579958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257579958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257579958">(Oct 14 2021 at 18:10)</a>:</h4>
<p>while writing my previous text I also came to the conclusion that <code>log10</code> <em>is</em> the fastest way to get the length of an integer in Rust (I'm 99% sure)</p>



<a name="257580042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257580042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257580042">(Oct 14 2021 at 18:11)</a>:</h4>
<p>yeah i sure wouldn't to_string on it</p>



<a name="257580064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257580064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257580064">(Oct 14 2021 at 18:11)</a>:</h4>
<p>then I also mentioned this <a href="https://stackoverflow.com/questions/1489830/efficient-way-to-determine-number-of-digits-in-an-integer">https://stackoverflow.com/questions/1489830/efficient-way-to-determine-number-of-digits-in-an-integer</a> and <a href="http://graphics.stanford.edu/~seander/bithacks.html#IntegerLog10">http://graphics.stanford.edu/~seander/bithacks.html#IntegerLog10</a><br>
So basically what we already have in here <a href="https://github.com/rust-lang/rust/blob/fe1c942eee3489743d655d81ca89166217db0547/library/core/src/num/int_log10.rs">https://github.com/rust-lang/rust/blob/fe1c942eee3489743d655d81ca89166217db0547/library/core/src/num/int_log10.rs</a> is really good, especially now that it's even branchless</p>



<a name="257580089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257580089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257580089">(Oct 14 2021 at 18:12)</a>:</h4>
<p>i think you'd want the count_digits to take a radix the same as parsing does</p>



<a name="257580268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257580268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257580268">(Oct 14 2021 at 18:13)</a>:</h4>
<p>Oh yeah that sounds good. In addition, counting the length of a float on the other hand is not trivial at all. It is really hard I think so that's actually something where a count_digits could come in really handy.</p>



<a name="257580339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257580339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257580339">(Oct 14 2021 at 18:13)</a>:</h4>
<p>And ultimately this is what we can use to optimize our own float to string too in the std (the PR currently only optimizes int to string conversion)</p>



<a name="257581559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257581559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257581559">(Oct 14 2021 at 18:22)</a>:</h4>
<p>But maybe I'm overthinking it and we don't need this, I don't know.</p>
<p>But to summarize why I think we should have <code>{i8, i16, i32, i64, isize, i128}::count_digits</code> and <code>{u8, u16, u32, u64, usize, u128}::count_digits</code> as well as <code>{f32, f64}::count_digits</code> (they all need separate implementations):</p>
<ol>
<li>Easier to read</li>
<li>Prevent easy to make mistakes when counting integer digits like implementing it inefficiently (those mistakes have been made in the std and the PR corrects them)</li>
<li>Provide a float implementation which is not trivial to implement<br>
Any thoughts?</li>
</ol>



<a name="257581877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257581877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ruster <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257581877">(Oct 14 2021 at 18:24)</a>:</h4>
<p>Like, especially if we do implement a sophisticated float preallocation thing <a href="https://github.com/rust-lang/rust/pull/89737/files#diff-1a13885e89de65916e7e0f9436a79cb2e697e23dcaa1a24e8fb3106d8b89dc7eR2448">here</a> then I think it would make a lot of sense to expose it as a public API as well because it could be used outside that as well</p>



<a name="257589044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257589044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Kugelman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257589044">(Oct 14 2021 at 19:12)</a>:</h4>
<p>What's the use case for a floating point <code>count_digits</code>? When would somebody call it?</p>



<a name="257589672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257589672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257589672">(Oct 14 2021 at 19:16)</a>:</h4>
<p>formatting</p>



<a name="257589695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257589695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Kugelman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257589695">(Oct 14 2021 at 19:17)</a>:</h4>
<p>For the signed integers, is it just digits counted or is there <code>+1</code> for the negative sign?</p>



<a name="257590516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257590516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Kugelman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257590516">(Oct 14 2021 at 19:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Adding.20a.20new.20function.20to.20std/near/257589672">said</a>:</p>
<blockquote>
<p>formatting</p>
</blockquote>
<p>Outside of the standard library itself?</p>



<a name="257593647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257593647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257593647">(Oct 14 2021 at 19:43)</a>:</h4>
<p>there's one or two crates that provide alternative formatting systems that greatly reduce code size for embedded.</p>



<a name="257594938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257594938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257594938">(Oct 14 2021 at 19:53)</a>:</h4>
<p>This may also be useful for TUI crates, since they may need to make adjustments depending on the size of elements</p>



<a name="257665435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257665435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257665435">(Oct 15 2021 at 08:50)</a>:</h4>
<p><span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span> how do you define digit counts for floats like 0.333333333333333314829616256247390992939472198486328125 or 1e+308 or 1e-308 or NaN</p>



<a name="257665871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257665871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257665871">(Oct 15 2021 at 08:54)</a>:</h4>
<p><code>.to_string().len()</code> is a decent way to specify the operation, but it might be a little too tailored to formatting peculiarities</p>



<a name="257666201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257666201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257666201">(Oct 15 2021 at 08:57)</a>:</h4>
<p>For <code>uN</code>, there is mostly only one possible implementation (except for whether <code>0</code> counts as 1 digit or 0). For <code>iN</code>, you may or may not want to count the <code>-</code> sign (but if you want some other behavior it wouldn't be too bad to implement it yourself in terms of the unsigned version). For floats... there is a lot of design space</p>



<a name="257667745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257667745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257667745">(Oct 15 2021 at 09:09)</a>:</h4>
<p>if it's defined to be <code>f.to_string().len()</code> it can't be used for e.g. formatting <code>{:e}</code> output</p>
<p><code>1e308</code> will have 309 digits and <code>1e-308</code> will have 310 "digits".</p>
<p>imo if it is defined for float for formatting it should separate digits before and after the dot, and maybe the exponent as well (<code>4.25e99.count_digits() == (1, 2, 99)</code> perhaps).</p>



<a name="257668426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257668426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257668426">(Oct 15 2021 at 09:15)</a>:</h4>
<p>I think there is an argument for including at least all the options that you can use in a <code>{:..}</code> format arg</p>



<a name="257668749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257668749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257668749">(Oct 15 2021 at 09:18)</a>:</h4>
<p>I remember hearing a talk, I think for MSVC's C++ standard library, about a very elaborate <code>f32::to_string</code> type of function, with the specification that the resulting string is as short as possible while producing the nearest number that would parse and round to the original float</p>



<a name="257668835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257668835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257668835">(Oct 15 2021 at 09:19)</a>:</h4>
<p>so your <code>0.333333333333333314829616256247390992939472198486328125</code> example would probably end up as something like <code>0.33333333</code> for <code>f32</code> and <code>0.33333333333333331</code> for <code>f64</code></p>



<a name="257669589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257669589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257669589">(Oct 15 2021 at 09:26)</a>:</h4>
<p>it is just <code>0.3333333333333333</code> in the default settings, i used <code>{:.160}</code> to get all the binary digits <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span>.</p>



<a name="257669671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257669671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257669671">(Oct 15 2021 at 09:27)</a>:</h4>
<p>iirc Rust's default flt2str is already the elaborated type, just not as fast as <code>ryu</code></p>



<a name="257670409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257670409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257670409">(Oct 15 2021 at 09:34)</a>:</h4>
<p>Here's the talk: <a href="https://youtu.be/4P_kbF0EbZM">https://youtu.be/4P_kbF0EbZM</a></p>
<div class="youtube-video message_inline_image"><a data-id="4P_kbF0EbZM" href="https://youtu.be/4P_kbF0EbZM"><img src="https://uploads.zulipusercontent.net/57b5a0dbde9c4d01e05750ec3d22072efaecbb2b/68747470733a2f2f692e7974696d672e636f6d2f76692f34505f6b62463045625a4d2f64656661756c742e6a7067"></a></div>



<a name="257682443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257682443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257682443">(Oct 15 2021 at 11:27)</a>:</h4>
<p>Length in characters, utf8 bytes, utf16 bytes, or something else?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// log10 + 1 (with log10(0) == 0)</span>
<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dec_len_u8</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mb">0b01_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mb">0b10_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="c1">// + '+'.len_utf8() // format always with sign</span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dec_len_i8</span><span class="p">(</span><span class="n">n</span>: <span class="kt">i8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="kt">u8</span>::<span class="n">BITS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="sc">'-'</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">unsigned_abs</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">sign</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mb">0b01_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mb">0b10_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'-'</span><span class="p">;</span><span class="w"> </span><span class="c1">// ascii</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'−'</span><span class="p">;</span><span class="w"> </span><span class="c1">// '\u{2212}' Real minus</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Ascii vs Unicode Mathematical Alphanumeric Symbols</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'0'</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'𝟎'</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'𝟘'</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'𝟢'</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'𝟬'</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'𝟶'</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"char: {} len: {}"</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">len_utf8</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..=</span><span class="mi">255</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{} {}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dec_len_u8</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">i8</span>::<span class="n">MIN</span><span class="o">..=</span><span class="kt">i8</span>::<span class="n">MAX</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{} {}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dec_len_i8</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="257686374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257686374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257686374">(Oct 15 2021 at 12:02)</a>:</h4>
<p>length in characters, utf-8 bytes and utf16 code units (not bytes!) should all be the same because all the characters used in <code>{u,i,f}N::to_string</code> are ASCII</p>



<a name="257712877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257712877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Kugelman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257712877">(Oct 15 2021 at 15:07)</a>:</h4>
<p>Yeah this is why I asked what the use case is. Without a clear use case it seems likely a floating point method wouldn't do what a caller wants and they would likely just have to write their own. It may give too much precision when they want rounding, or it may round when they want exact representation. They may want to take into account all the formatting options; or not. One could plausibly want either <code>0.33333333</code> or <code>0.333333333333333314829616256247390992939472198486328125</code> -- how do we know which they want? Is that another option?</p>
<p>If the method balloons up and has a half dozen options it starts to lose its shine...</p>
<p>Also, there should be a compelling use case where a person wouldn't simply use <code>fmt::Formatter</code> to create a string with exactly the formatting options they want and then inspect the <code>String</code> output. When would somebody want to count the digits without actually creating a string?</p>



<a name="257713626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257713626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Kugelman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257713626">(Oct 15 2021 at 15:11)</a>:</h4>
<p>If it is useful, perhaps it belongs on <code>Formatter</code> instead of free floating.</p>



<a name="257730084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257730084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257730084">(Oct 15 2021 at 16:57)</a>:</h4>
<p>well one example is that you might want to format directly to an output sink without the allocation. your system might not even <em>have</em> an allocator.</p>



<a name="257734475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257734475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257734475">(Oct 15 2021 at 17:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="449326">John Kugelman</span> <a href="#narrow/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function/near/257712877">said</a>:</p>
<blockquote>
<p>If the method balloons up and has a half dozen options it starts to lose its shine...</p>
</blockquote>
<p>I actually agree with the <code>&lt;charconv&gt;</code> design on this point: there should be a public-but-out-of-the-way function with lots of knobs so that the power users don't have to write it themselves. Float formatting is really gnarly and this is certainly a candidate for std or at least a high quality crate. But default options for the simple case would also make sense, and like I said the obvious choice is whatever <code>to_string</code> does.</p>



<a name="257735420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257735420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257735420">(Oct 15 2021 at 17:33)</a>:</h4>
<p>I think if this includes the sign, and for floats the decimal point and exponent, it should not be named <code>digits</code>.</p>



<a name="257735448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257735448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257735448">(Oct 15 2021 at 17:33)</a>:</h4>
<p><code>chars</code> perhaps.</p>



<a name="257735634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257735634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257735634">(Oct 15 2021 at 17:35)</a>:</h4>
<p><code>len_as_str</code>?</p>



<a name="257738011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257738011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257738011">(Oct 15 2021 at 17:51)</a>:</h4>
<p><code>fmt_len</code></p>



<a name="257738167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257738167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257738167">(Oct 15 2021 at 17:52)</a>:</h4>
<p>actually we could make this an extension of the existing fmt traits so that you can get the length for various kinds of formatting</p>



<a name="257738264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257738264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257738264">(Oct 15 2021 at 17:53)</a>:</h4>
<p>trait BinaryLen: Binary { fn fmt_len(&amp;self) -&gt; usize }</p>



<a name="257738546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257738546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257738546">(Oct 15 2021 at 17:55)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">format_len</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}"</span><span class="p">,</span><span class="w"> </span><span class="mi">12345</span><span class="p">),</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="257739504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257739504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257739504">(Oct 15 2021 at 18:01)</a>:</h4>
<p>option 1,</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">LowerHex</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Formatter</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fmt_len</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Formatter</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">core</span>::<span class="n">result</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">old_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">current_length</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">fmt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">current_length</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_length</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>option 2,</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">LowerHex</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Formatter</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">count_length_only</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="n">increase_length_by</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log16</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// regular code.</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="257742008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257742008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257742008">(Oct 15 2021 at 18:19)</a>:</h4>
<p>Are either of those options no_alloc friendly?</p>



<a name="257742175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257742175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257742175">(Oct 15 2021 at 18:20)</a>:</h4>
<p>you'd need to use some sort of arrayvec and format into that and hope you don't overflow</p>



<a name="257742241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257742241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257742241">(Oct 15 2021 at 18:20)</a>:</h4>
<p>also, i know i suggested it, but that leans towards the "way too many knobs" end of things</p>



<a name="257742878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257742878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257742878">(Oct 15 2021 at 18:25)</a>:</h4>
<p>If we're only calculating the length, why would we need an arrayvec?</p>



<a name="257743131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257743131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257743131">(Oct 15 2021 at 18:26)</a>:</h4>
<p>Given the result, the user might be interested in formatting into an arrayvec or similar, but that's a separate issue. They might be using an alternate formatting library tailored for embedded applications or something</p>



<a name="257744204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257744204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257744204">(Oct 15 2021 at 18:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function/near/257742008">said</a>:</p>
<blockquote>
<p>Are either of those options no_alloc friendly?</p>
</blockquote>
<p>they have to be <code>#[no_alloc]</code> because these <code>fmt</code> impl is in <code>core</code>, not <code>alloc</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="257748218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257748218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257748218">(Oct 15 2021 at 19:03)</a>:</h4>
<blockquote>
<p>If we're only calculating the length, why would we need an arrayvec?</p>
</blockquote>
<p>as far as i know you can't make a Formatter yourself. Only core can do it for you.</p>



<a name="257748360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257748360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257748360">(Oct 15 2021 at 19:04)</a>:</h4>
<p>So if you do need a Formatter to target your fmt call to, then you'd need some sort of dummy target.</p>



<a name="257801735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/257801735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#257801735">(Oct 16 2021 at 04:56)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">hex_len</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">u32</span>::<span class="n">BITS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">leading_zeros</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bin_len</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">u32</span>::<span class="n">BITS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">leading_zeros</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I don't think count_digits() would be very useful for real world workloads outside of naive ascii swar hijinks.</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="c1">// Run js in browser devtools</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="ow">new</span> <span class="nb">Intl</span><span class="p">.</span><span class="nx">NumberFormat</span><span class="p">(</span><span class="s1">'en'</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="o">-</span><span class="mf">500</span><span class="nx">_000</span><span class="p">),</span> <span class="ow">new</span> <span class="nb">Intl</span><span class="p">.</span><span class="nx">NumberFormat</span><span class="p">(</span><span class="s1">'en'</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="o">-</span><span class="mf">500</span><span class="nx">_000</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="ow">new</span> <span class="nb">Intl</span><span class="p">.</span><span class="nx">NumberFormat</span><span class="p">(</span><span class="s1">'en-IN'</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="o">-</span><span class="mf">500</span><span class="nx">_000</span><span class="p">),</span> <span class="ow">new</span> <span class="nb">Intl</span><span class="p">.</span><span class="nx">NumberFormat</span><span class="p">(</span><span class="s1">'en-IN'</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="o">-</span><span class="mf">500</span><span class="nx">_000</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="ow">new</span> <span class="nb">Intl</span><span class="p">.</span><span class="nx">NumberFormat</span><span class="p">(</span><span class="s1">'ar-EG'</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="o">-</span><span class="mf">500</span><span class="nx">_000</span><span class="p">),</span> <span class="ow">new</span> <span class="nb">Intl</span><span class="p">.</span><span class="nx">NumberFormat</span><span class="p">(</span><span class="s1">'ar-EG'</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="o">-</span><span class="mf">500</span><span class="nx">_000</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
</code></pre></div>



<a name="258600386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258600386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258600386">(Oct 21 2021 at 19:06)</a>:</h4>
<blockquote>
<p>I don't think count_digits() would be very useful for real world workloads</p>
</blockquote>
<p>a lot of interchange protocols will use ascii numbers (json for example)</p>



<a name="258600799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258600799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258600799">(Oct 21 2021 at 19:09)</a>:</h4>
<p>well, but json is variable-length so you need a large buffer anyway and can just dump the digits into it</p>



<a name="258605868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258605868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258605868">(Oct 21 2021 at 19:47)</a>:</h4>
<p>fair enough. i think there are real a lot of real world cases where ascii formatting of numebrs is correct/desirable, but mainly when the number is not being displayed to a human</p>



<a name="258606930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258606930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258606930">(Oct 21 2021 at 19:54)</a>:</h4>
<p>maybe if you had a length-prefixed format that still writes out ascii and you want to calculate the length without using an intermediate buffer then it could be useful.</p>



<a name="258607423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258607423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258607423">(Oct 21 2021 at 19:58)</a>:</h4>
<p>I would use such a method. I currently have an extension trait that does just that. <a href="https://github.com/time-rs/time/blob/a28507f4d38e7fa463ccc6486a63c521f9d47b67/src/formatting/mod.rs#L43-L115">https://github.com/time-rs/time/blob/a28507f4d38e7fa463ccc6486a63c521f9d47b67/src/formatting/mod.rs#L43-L115</a></p>



<a name="258615034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258615034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258615034">(Oct 21 2021 at 20:49)</a>:</h4>
<p>I would appreciate such a method as well, to avoid having to carefully fiddle with log10 and figure out if I need to add one.</p>



<a name="258634691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258634691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258634691">(Oct 21 2021 at 23:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function/near/258615034">said</a>:</p>
<blockquote>
<p>figure out if I need to add one.</p>
</blockquote>
<p>The answer is always yes.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mrow><mi>r</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>x</mi></mrow></msub><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>∨</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\log _{radix}(value\vee 1)+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.24196799999999993em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// micro optimizations!</span>
<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">hex_len</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="kt">u8</span>::<span class="n">BITS</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="n">n</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">leading_zeros</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bin_len</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">u8</span>::<span class="n">BITS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">leading_zeros</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dec_len</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mb">0b01_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mb">0b10_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>For small numbers it's better to think in terms of how many usize registers max value needs, for bigger numbers allocate few extra bytes to output buffer.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// 200 byte 00-99 LUT is faster</span>
<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write_u8</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">C1</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="mb">0b11_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">C2</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="mb">0b10_00000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">log10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">C1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">C2</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span>::<span class="n">from_le_bytes</span><span class="p">([</span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="kt">u32</span>::<span class="n">from_ne_bytes</span><span class="p">([</span><span class="sc">b'0'</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">rotate_left</span><span class="p">(</span><span class="n">log10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">log10</span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258712361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/258712361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#258712361">(Oct 22 2021 at 13:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="420380">Bot+</span> <a href="#narrow/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function/near/258634691">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function/near/258615034">said</a>:</p>
<blockquote>
<p>figure out if I need to add one.</p>
</blockquote>
<p>The answer is always yes.</p>
</blockquote>
<p>I realize that, but i use it rarely enough that it requires a moment's extra thought every time.</p>



<a name="260323388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/260323388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#260323388">(Nov 04 2021 at 19:39)</a>:</h4>
<p><code>hex_len</code> of <code>u8</code> can be done simpler: <code>(n &gt;&gt; 4).wrapping_add(31) &gt;&gt; 4</code></p>



<a name="260336191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/260336191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#260336191">(Nov 04 2021 at 21:17)</a>:</h4>
<p>Or <code>let n = n as u32; (n + 0x1f0) &gt;&gt; 8</code></p>



<a name="260341701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/260341701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#260341701">(Nov 04 2021 at 22:11)</a>:</h4>
<p>so is the most general version of this an extension trait for types that can predict their format width, the same as some iterators can predict their iteration count?</p>



<a name="260341829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/add%20new%20%3Cnumber%3E%3A%3Acount_digits%20function/near/260341829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/add.20new.20.3Cnumber.3E.3A.3Acount_digits.20function.html#260341829">(Nov 04 2021 at 22:12)</a>:</h4>
<p>Then it's not just number types and digits, but you could ask any type how many bytes it expects to format</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>