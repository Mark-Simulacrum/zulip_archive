<html>
<head><meta charset="utf-8"><title>assert impl or not impl ¬∑ t-libs ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html">assert impl or not impl</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260352617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260352617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260352617">(Nov 05 2021 at 00:21)</a>:</h4>
<p>What is folks' first reaction to supporting the following in std::assert?</p>
<div class="codehilite"><pre><span></span><code>assert!(impl Send for MyType, &quot;...&quot;);
assert!(impl !Unpin for MyType, &quot;...&quot;);
</code></pre></div>
<p>I have <a href="https://github.com/dtolnay/cxx/blob/ede65e0ce27932009ea3be87ca3a9c6587ced8dd/macro/src/expand.rs#L392-L416">this</a> as the current best known workaround but the error messages are horrible. See <a href="https://github.com/dtolnay/cxx/blob/master/tests/ui/unpin_impl.rs">unpin_impl.rs</a> and <a href="https://github.com/dtolnay/cxx/blob/master/tests/ui/unpin_impl.stderr">unpin_impl.stderr</a>.</p>



<a name="260352987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260352987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260352987">(Nov 05 2021 at 00:27)</a>:</h4>
<p>Feels a little awkward in assert, since I don't think we want to support "getting a bool representing the presence of an impl" -- I think Niko has said that avoiding that kind of testing is good, and it would also hurt polymorphization and similar efforts. But assert_impl or static_assert feel more reasonable to me, and like a big win over today's <code>fn foo&lt;T: Send&gt;() { foo::&lt;SomeType&gt;() }</code>and similar (which ... don't work for negative impls?)</p>



<a name="260353075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353075">(Nov 05 2021 at 00:29)</a>:</h4>
<p>Not exposing a bool for the presence of an impl is exactly the idea behind building this into std::assert only</p>



<a name="260353182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353182">(Nov 05 2021 at 00:30)</a>:</h4>
<p>As opposed to <code>do_whatever_i_want_with(implemented!(Send, MyType))</code></p>



<a name="260353230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353230">(Nov 05 2021 at 00:31)</a>:</h4>
<p>Yeah, I just have a negative reaction to assert taking a not bool off hand, but it may be actually great; certainly in some sense less to teach -- I've never settled on a firm feeling whether rolling capability into assert! vs. having dedicated macros (assert_impl!, static_assert!) for more compile-time rather than run-time asserts is better.</p>



<a name="260353276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353276">(Nov 05 2021 at 00:32)</a>:</h4>
<p>I definitely think it needs to be an "assert" macro of some kind.</p>



<a name="260353383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353383">(Nov 05 2021 at 00:34)</a>:</h4>
<p>I'd be on board with an assert_impl or static_assert</p>



<a name="260353463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353463">(Nov 05 2021 at 00:35)</a>:</h4>
<p>I do think it should have a new name, leaving <code>assert!</code> as a runtime thing</p>



<a name="260353464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353464">(Nov 05 2021 at 00:36)</a>:</h4>
<p>would you use this inside a test just like a regular assert!(), or anywhere including at file/module scope like compile_error!()?</p>



<a name="260353524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353524">(Nov 05 2021 at 00:36)</a>:</h4>
<p>whether it's an overload of a more normal <code>const</code>-<code>bool</code>-y <code>static_assert!</code> is another question</p>



<a name="260353525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353525">(Nov 05 2021 at 00:36)</a>:</h4>
<p>For assert_impl I find <code>assert_impl!(!Unpin for MyType)</code> a little more awkward for not a lot of benefit over making assert recognize <code>impl $trait for $ty</code> as a macro input pattern, but I can understand not want to pack too much different things into assert itself</p>



<a name="260353557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353557">(Nov 05 2021 at 00:37)</a>:</h4>
<p><code>compile_assert!(impl ...);</code></p>



<a name="260353559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353559">(Nov 05 2021 at 00:37)</a>:</h4>
<p>Mara: I'd be writing <code>const _: () = whatever_assert!(...);</code> since assert now works in const</p>



<a name="260353651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353651">(Nov 05 2021 at 00:38)</a>:</h4>
<p>that seems odd to me for an 'impl assert' like this, because there's no runtime version of it.</p>



<a name="260353751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353751">(Nov 05 2021 at 00:40)</a>:</h4>
<div class="codehilite"><pre><span></span><code>macro_rules! static_assert {
    ($($t:tt)*) =&gt; { const _: () = $crate::assert!($($t)*); }; //  \o/
}
</code></pre></div>



<a name="260353778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353778">(Nov 05 2021 at 00:40)</a>:</h4>
<p>SHIP IT</p>



<a name="260353802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353802">(Nov 05 2021 at 00:41)</a>:</h4>
<p>I think static_assert definitely has a lot of name benefits and lets us put other stuff (like guaranteed-compile time asserts) into it, even if they're relatively easy to achieve with an anonymous constant these days</p>



<a name="260353803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353803">(Nov 05 2021 at 00:41)</a>:</h4>
<p>are we doing the c++ thing of calling 17 different concepts 'static'? :p</p>



<a name="260353830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353830">(Nov 05 2021 at 00:41)</a>:</h4>
<p><code>const_assert!</code> works too</p>



<a name="260353994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260353994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260353994">(Nov 05 2021 at 00:44)</a>:</h4>
<p>hmm, the <code>static_assertions</code> crate already calls it that, and also has impl stuff</p>



<a name="260354041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354041">(Nov 05 2021 at 00:45)</a>:</h4>
<p>Yeah the variation in cxx is based on static_assertions::assert_not_impl_any</p>



<a name="260354042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354042">(Nov 05 2021 at 00:45)</a>:</h4>
<p>/me wonders if choosing a different name avoids "breaking" people using #[macro_use] and the like</p>



<a name="260354135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354135">(Nov 05 2021 at 00:46)</a>:</h4>
<p>Sane diagnostics for the user is the motivation for not just keeping it, not because i don't want a dependency on static_assertions or don't want to own the 20 lines of relevant code</p>



<a name="260354159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354159">(Nov 05 2021 at 00:47)</a>:</h4>
<p>i wonder if it might be better to have this as a language feature rather than a macro. syntax for 'this type must impl Send' could be useful for more than just checks/asserts.</p>



<a name="260354180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354180">(Nov 05 2021 at 00:47)</a>:</h4>
<p>there is also <code>static_assert_macro</code> with the <code>static_assert!</code> name, but it doesn't have the same reach</p>



<a name="260354181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354181">(Nov 05 2021 at 00:47)</a>:</h4>
<p>I think the underlying implementation of the macro is probably compiler intrinsic or other magic -- but I'm not sure I can think of a better way to expose it</p>



<a name="260354235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354235">(Nov 05 2021 at 00:48)</a>:</h4>
<p>Yeah compiler intrinsic is what I had in mind</p>



<a name="260354275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354275">(Nov 05 2021 at 00:49)</a>:</h4>
<p>are there any other things than checking trait impls that you'd want to assert on, that are not just const bools?</p>



<a name="260354285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354285">(Nov 05 2021 at 00:49)</a>:</h4>
<p>Probably in practice it's a rustc_ attr on an impl block or something, since I'm not sure there's actually a way to pass in an arbitrary <em>trait</em> to a method otherwise.</p>



<a name="260354382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354382">(Nov 05 2021 at 00:50)</a>:</h4>
<p><code>static_assert!(bool)</code> should be considered first</p>



<a name="260354394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354394">(Nov 05 2021 at 00:51)</a>:</h4>
<p>I expect the impl stuff has a lot more questions</p>



<a name="260354497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354497">(Nov 05 2021 at 00:52)</a>:</h4>
<p><code>compile_error!("..") where T: !Send;</code></p>



<a name="260354538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354538">(Nov 05 2021 at 00:53)</a>:</h4>
<p>for that extra negated logic <del>confusion</del> fun</p>



<a name="260354539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354539">(Nov 05 2021 at 00:53)</a>:</h4>
<p><code>#[cfg&lt;T: !Send&gt;] compile_error!("..");</code></p>



<a name="260354614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354614">(Nov 05 2021 at 00:54)</a>:</h4>
<p><span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="260354678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354678">(Nov 05 2021 at 00:55)</a>:</h4>
<p><code>compile_error!("..." if T: !Send else üëç);</code></p>



<a name="260354734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354734">(Nov 05 2021 at 00:56)</a>:</h4>
<p>oh i like that one</p>



<a name="260354798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354798">(Nov 05 2021 at 00:57)</a>:</h4>
<p>does the <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> lexer support modifiers?</p>



<a name="260354817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354817">(Nov 05 2021 at 00:57)</a>:</h4>
<p>can't tell if serious but it somewhat meshes with <code>std::matches</code>'s guard clause</p>



<a name="260354902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354902">(Nov 05 2021 at 00:58)</a>:</h4>
<p>did I seem serious? oh my...</p>



<a name="260354930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354930">(Nov 05 2021 at 00:59)</a>:</h4>
<p>Nope, Mara did</p>



<a name="260354963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354963">(Nov 05 2021 at 00:59)</a>:</h4>
<p>ah</p>



<a name="260354967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354967">(Nov 05 2021 at 00:59)</a>:</h4>
<p>oh, nothing i say after midnight is serious</p>



<a name="260354971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260354971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260354971">(Nov 05 2021 at 00:59)</a>:</h4>
<p>i should go to sleep <span aria-label="zzz" class="emoji emoji-1f4a4" role="img" title="zzz">:zzz:</span></p>



<a name="260355039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260355039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260355039">(Nov 05 2021 at 01:00)</a>:</h4>
<p>Sounds good. I'll think about a proposal -- thanks all</p>



<a name="260374756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260374756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260374756">(Nov 05 2021 at 07:59)</a>:</h4>
<p>I prefer using the bounds syntax rather than the impl syntax - since we are testing if there is a transitive implementation not a direct one</p>



<a name="260413771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260413771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260413771">(Nov 05 2021 at 14:41)</a>:</h4>
<p>Late to the party here, but: <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> for having an <code>assert_impls!(Trait for Type, "...")</code> or similar.</p>



<a name="260532524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260532524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260532524">(Nov 06 2021 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119235">David Tolnay</span> <a href="#narrow/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl/near/260353751">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>macro_rules! static_assert {
    ($($t:tt)*) =&gt; { const _: () = $crate::assert!($($t)*); }; //  \o/
}
</code></pre></div><br>
</p>
</blockquote>
<p>Or just write <code>const { assert!() }</code>.</p>



<a name="260544743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260544743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260544743">(Nov 07 2021 at 00:31)</a>:</h4>
<p>Nobody has mentioned this here afaik...is the intent to have the static assertion be inside of a method or not? Either way seems reasonable, but it would affect various ideas.</p>



<a name="260558004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260558004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260558004">(Nov 07 2021 at 06:44)</a>:</h4>
<p>With the name static, that implies it has item context to me.</p>



<a name="260571814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260571814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260571814">(Nov 07 2021 at 12:45)</a>:</h4>
<p>If it can be outside a method, then it can be inside a method too, not vice versa though obviously</p>



<a name="260574690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/assert%20impl%20or%20not%20impl/near/260574690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl.html#260574690">(Nov 07 2021 at 13:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/assert.20impl.20or.20not.20impl/near/260353803">said</a>:</p>
<blockquote>
<p>are we doing the c++ thing of calling 17 different concepts 'static'? <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>
</blockquote>
<p>This. In Rust parlance it would be a <code>compile_time</code> or <code>const</code> assertion, if anything, rather than a <code>static</code> one, since there is no <code>static</code> storage involved anywhere <span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span> </p>
<hr>
<p>Other than that I agree with the sentiment that, at least for "assert not impl", we do have a serious lack of decent diagnostics, here.</p>
<p>And what about generic contexts? <em>e.g.</em>, <code>const</code>-asserting that <code>MyWrapper&lt;T&gt; : !Unpin</code> for any choice of <code>T</code>. On the one hand, such an assertion is a legitimate thing to want to write. But on the other hand, I'm afraid that many implementations of <code>assert_not_impl</code>, at least those on stable Rust, would be unable to yield an unambiguous answer. Take, for instance, the current implementation of <code>assert_not_impl</code>. It <em>correctly</em> refuses to handle generic types ( <span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span>), since, <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=ab35e700266a423ea013455cf0ee6222">if it did, it wouldn't necessarily yield the expected result</a>. The core issue here is that besides <code>T : Trait</code> and <code>T : !Trait</code>, we may have a <code>T : ?Trait</code> situation, which is a mathematical / quantification-related property that may not be obvious for all the Rust programmers.</p>
<ul>
<li>This is yet another reason to have an officially blessed macro (with potential <code>lang</code>-magic support if needs be), which would be able to error on the weak <code>T : ?Trait</code> case.</li>
</ul>
<p>But once such a macro is officially blessed, what about semver (~coherence)? A key design of Rust is that implementing a new trait for a type must not be a breaking change; but if downstream users were able to use a stdlib macro to assert that a certain trait not be implemented for that type, then such an addition would be breaking!</p>
<ul>
<li>This may, however, be handled by the aforementioned "erroring on the weak <code>T : ?Trait</code> case", since coherence would correctly assume that <code>NonLocalTy : ?NonLocalTrait</code> whenever <code>NonLocalTy : NonLocalTrait</code> does not hold, right? And so, for upstream crates, only an explicit <code>impl !Trait for Ty {}</code> would be able to allow downstream crates to get the desired <code>NonLocalTy : !NonLocalTrait</code> semantics off which such an assertion macro could work, right?</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>