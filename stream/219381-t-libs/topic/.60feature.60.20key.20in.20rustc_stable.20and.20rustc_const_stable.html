<html>
<head><meta charset="utf-8"><title>`feature` key in rustc_stable and rustc_const_stable · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html">`feature` key in rustc_stable and rustc_const_stable</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251692269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692269">(Sep 02 2021 at 10:03)</a>:</h4>
<p>Hi! I was previously confused when stabilization PRs for library features would change a <code>rustc_unstable</code> / <code>rustc_const_unstable</code> to the corresponding stable attribute while changing the <code>feature</code> (flag) key. I found out this is the current standard procedure when a feature is partially stabilized, but to me it seems like this just makes the <code>feature</code> key in <code>rustc_stable</code> / <code>rustc_const_stable</code> useless by having it sometimes refer to the actual feature you would have previously used, sometimes to a feature flag that never really existed.</p>



<a name="251692397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692397">(Sep 02 2021 at 10:04)</a>:</h4>
<p>yeah, unstable features get renamed sometimes. so when something is partially st abilized, that is effectively an unstable feature rename followed by a stabilization of that, at once.</p>



<a name="251692455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692455">(Sep 02 2021 at 10:05)</a>:</h4>
<p>Thus I looked into why this is even needed on the stable attributes by changing the code around so it is no longer needed. It didn't even take long to get that to compile, but ran into lots of runtime errors (seems like it's because the on-disk representation of those attributes changed)</p>



<a name="251692475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692475">(Sep 02 2021 at 10:05)</a>:</h4>
<p>it's only for the diagnostic that tells you the feature is stable, and you no longer need to enable it. but that doesn't work as well across renames and partial stabilizations, but that's okay.</p>



<a name="251692574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692574">(Sep 02 2021 at 10:06)</a>:</h4>
<p>e.g.</p>
<div class="codehilite"><pre><span></span><code>warning: the feature `array_map` has been stable since 1.55.0 and no longer requires an attribute to enable
 --&gt; src/main.rs:1:12
  |
1 | #![feature(array_map)]
  |            ^^^^^^^^^
  |
  = note: `#[warn(stable_features)]` on by default
</code></pre></div>



<a name="251692664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692664">(Sep 02 2021 at 10:07)</a>:</h4>
<p>Okay, but everything compiles after my changes, where do I need to look for the code that is responsible for that error message?</p>



<a name="251692684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692684">(Sep 02 2021 at 10:07)</a>:</h4>
<p>I would like to make it possible to omit the feature key in these situations</p>



<a name="251692827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692827">(Sep 02 2021 at 10:09)</a>:</h4>
<p>It just results in lots of declarations of stable features that were never unstable..</p>



<a name="251692966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251692966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251692966">(Sep 02 2021 at 10:10)</a>:</h4>
<p>I'm pretty sure there's a decent amount of entries in the <a href="http://caniuse.rs">caniuse.rs</a> "database" (I maintain that site) that have "wrong" feature flag entries because I took the "stabilized name", where now I think I should have used the previous name because the stable one is not useful in any way</p>



<a name="251693778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251693778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251693778">(Sep 02 2021 at 10:19)</a>:</h4>
<p>looks like <code>src/test/ui/stable-features.rs</code> should also test library features like <code>array_map</code>.</p>



<a name="251693852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251693852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251693852">(Sep 02 2021 at 10:20)</a>:</h4>
<p>though i guess <code>rust1</code> is already a library feature. did that test not fail for you?</p>



<a name="251694187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251694187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251694187">(Sep 02 2021 at 10:24)</a>:</h4>
<p>I did not get to tests</p>



<a name="251694220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251694220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251694220">(Sep 02 2021 at 10:24)</a>:</h4>
<p>I get lots of error like this one:</p>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: unexpected panic

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.55.0-beta.1 (739f8f0a8 2021-07-28) running on x86_64-unknown-linux-gnu

note: compiler flags: -Z macro-backtrace -Z tls-model=initial-exec -Z unstable-options -Z binary-dep-depinfo -C opt-level=3 -C embed-bitcode=no -C debuginfo=0 -C incremental -C link-args=-Wl,-rpath,$ORIGIN/../lib -C llvm-args=-import-instr-limit=10 --crate-type lib

note: some of the compiler flags provided by cargo are hidden

query stack during panic:
#0 [predicates_of] computing predicates of `html::render::context::Context`
#1 [check_item_well_formed] checking that `html::format::print_generic_bounds` is well-formed
#2 [analysis] running analysis passes on this crate
end of query stack
thread &#39;rustc&#39; panicked at &#39;no entry found for key&#39;, compiler/rustc_query_impl/src/on_disk_cache.rs:175:20
stack backtrace:
   0: rust_begin_unwind
             at /rustc/739f8f0a8d728054a60a37fb29517e9e7cc2365a/library/std/src/panicking.rs:515:5
   1: core::panicking::panic_fmt
             at /rustc/739f8f0a8d728054a60a37fb29517e9e7cc2365a/library/core/src/panicking.rs:92:14
   2: core::option::expect_failed
             at /rustc/739f8f0a8d728054a60a37fb29517e9e7cc2365a/library/core/src/option.rs:1578:5
   3: rustc_query_impl::on_disk_cache::CacheDecoder::file_index_to_file
   4: rustc_query_impl::on_disk_cache::&lt;impl rustc_serialize::serialize::Decodable&lt;rustc_query_impl::on_disk_cache::CacheDecoder&gt; for rustc_span::span_encoding::Span&gt;::decode
   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold
   6: &lt;alloc::vec::Vec&lt;T&gt; as alloc::vec::spec_from_iter::SpecFromIter&lt;T,I&gt;&gt;::from_iter
   7: &lt;[(rustc_middle::ty::Predicate,rustc_span::span_encoding::Span)] as rustc_middle::ty::codec::RefDecodable&lt;D&gt;&gt;::decode
   8: rustc_query_impl::on_disk_cache::OnDiskCache::try_load_query_result
   9: rustc_query_impl::plumbing::&lt;impl rustc_query_system::query::config::QueryDescription&lt;rustc_query_impl::plumbing::QueryCtxt&gt; for rustc_query_impl::queries::predicates_of&gt;::try_load_from_disk
  10: rustc_query_system::query::plumbing::load_from_disk_and_cache_in_memory
  11: rustc_query_system::query::plumbing::get_query_impl
  12: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::predicates_of
  13: rustc_ty_utils::ty::param_env
  14: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl
  15: rustc_data_structures::stack::ensure_sufficient_stack
  16: rustc_query_system::query::plumbing::force_query_with_job
  17: rustc_query_system::query::plumbing::get_query_impl
  18: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::param_env
  19: rustc_typeck::check::wfcheck::for_id
  20: rustc_typeck::check::wfcheck::check_item_well_formed
  21: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl
  22: rustc_data_structures::stack::ensure_sufficient_stack
  23: rustc_query_system::query::plumbing::force_query_with_job
  24: rustc_query_system::query::plumbing::get_query_impl
  25: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::check_item_well_formed
  26: &lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor as rustc_hir::intravisit::Visitor&gt;::visit_item
  27: rustc_data_structures::sync::par_for_each_in
  28: rustc_hir::hir::Crate::par_visit_all_item_likes
  29: rustc_session::session::Session::track_errors
  30: rustc_typeck::check_crate
  31: rustc_interface::passes::analysis
  32: rustc_middle::dep_graph::&lt;impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind&gt;::with_deps
  33: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl
  34: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_eval_always_task
  35: rustc_data_structures::stack::ensure_sufficient_stack
  36: rustc_query_system::query::plumbing::force_query_with_job
  37: rustc_query_system::query::plumbing::get_query_impl
  38: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::analysis
  39: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
  40: rustc_span::with_source_map
  41: rustc_interface::interface::create_compiler_and_run
  42: scoped_tls::ScopedKey&lt;T&gt;::set
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</code></pre></div>



<a name="251700407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/251700407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#251700407">(Sep 02 2021 at 11:29)</a>:</h4>
<p>I opened a PR for this: <a href="https://github.com/rust-lang/rust/pull/88588">https://github.com/rust-lang/rust/pull/88588</a></p>



<a name="252561849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/252561849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#252561849">(Sep 09 2021 at 02:25)</a>:</h4>
<p>are you reusing the stage1 cache or something? don't do that - try <code>rm -r build/stage1*/$TARGET/incremental</code></p>



<a name="252561861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/252561861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#252561861">(Sep 09 2021 at 02:25)</a>:</h4>
<p>oh no, this is a panic from the beta compiler, that is weird</p>



<a name="256379108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/256379108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#256379108">(Oct 06 2021 at 08:57)</a>:</h4>
<p>Bump! <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> suggested I revive this thread because the PR wasn't as uncontroversial as I had hoped.</p>



<a name="256379369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60feature%60%20key%20in%20rustc_stable%20and%20rustc_const_stable/near/256379369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60feature.60.20key.20in.20rustc_stable.20and.20rustc_const_stable.html#256379369">(Oct 06 2021 at 08:59)</a>:</h4>
<p>Should I copy over the comments from the PR? Discussion (really just one msg from <span class="user-mention" data-user-id="310399">@Mara</span>, two replies by myself) starts <a href="https://github.com/rust-lang/rust/pull/88588#issuecomment-911573951">here</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>