<html>
<head><meta charset="utf-8"><title>drain filters (tracking issue) · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html">drain filters (tracking issue)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273272775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273272775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273272775">(Feb 25 2022 at 19:16)</a>:</h4>
<p>what's the status of <a href="https://github.com/rust-lang/rust/issues/43244">https://github.com/rust-lang/rust/issues/43244</a> ? One of the concerns is the naming of the methods which I don't see much objection to (off late at least) to, so i guess we can finalise if it is fine to keep the name as is?</p>



<a name="273275299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275299">(Feb 25 2022 at 19:38)</a>:</h4>
<p>I think the drain-on-drop behavior evaluating user closures is a bigger issue.</p>



<a name="273275554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275554">(Feb 25 2022 at 19:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273275299">said</a>:</p>
<blockquote>
<p>I think the drain-on-drop behavior evaluating user closures is a bigger issue.</p>
</blockquote>
<p>is this mitigated by <a href="https://github.com/rust-lang/lang-team/issues/97">https://github.com/rust-lang/lang-team/issues/97</a>?</p>



<a name="273275575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275575">(Feb 25 2022 at 19:41)</a>:</h4>
<p>"Never allow unwinding from Drop impls"</p>



<a name="273275585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275585">(Feb 25 2022 at 19:41)</a>:</h4>
<p>or does the fact that it would abort just make it worse</p>



<a name="273275596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275596">(Feb 25 2022 at 19:41)</a>:</h4>
<p>Makes it worse. <a href="https://github.com/rust-lang/rust/issues/43244#issuecomment-975957123">https://github.com/rust-lang/rust/issues/43244#issuecomment-975957123</a></p>



<a name="273275767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275767">(Feb 25 2022 at 19:43)</a>:</h4>
<p><em>grumbles about linear types</em></p>



<a name="273275901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273275901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273275901">(Feb 25 2022 at 19:44)</a>:</h4>
<p>part of me wishes we could take the accelerationist approach and just make the drop impl abort unconditionally and force ppl to go through iteration to defuse the drop bomb but i know that won't work in practice</p>



<a name="273276128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273276128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273276128">(Feb 25 2022 at 19:46)</a>:</h4>
<p>the drain APIs all seem so tragic, between this and the pre-pooping your pants stuff for dealing with leaks, makes me wonder if that's not a sign that these APIs are fundamentally flawed and just don't fit well into rust's ownership model.</p>



<a name="273276373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273276373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273276373">(Feb 25 2022 at 19:48)</a>:</h4>
<p><code>drain</code> isn't <em>too</em> terrible. the cleanup is a bit gnarly, but at least it doesn't run user code other than <code>drop</code>, which is normal for owning iterators. <code>drain_filter</code> is worse.</p>



<a name="273276712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273276712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273276712">(Feb 25 2022 at 19:52)</a>:</h4>
<p>yea that's fair, leaking a draining iterator is admittedly not a common issue</p>



<a name="273278666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273278666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273278666">(Feb 25 2022 at 20:09)</a>:</h4>
<blockquote>
<p>Should drain_filter accept a Range argument?</p>
</blockquote>
<p>This would also be useful. Otherwise there are cases that are served by neither method and we'd need a <code>drain_filter_range</code> later.</p>



<a name="273278918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273278918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273278918">(Feb 25 2022 at 20:12)</a>:</h4>
<p>Is there a survey somewhere of how often someone really needs the items <em>as an iterator</em> from this?  I wonder how much of it could be done with, say, a <code>retain_filter_map</code> kind of API instead that doesn't use the iterator structure.</p>



<a name="273279035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279035">(Feb 25 2022 at 20:13)</a>:</h4>
<p>What would the map part do?</p>



<a name="273279036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279036">(Feb 25 2022 at 20:13)</a>:</h4>
<p>I have in the past used <code>drain</code> as an iterator (though not <code>drain_filter</code> as it's nightly only).</p>



<a name="273279234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279234">(Feb 25 2022 at 20:15)</a>:</h4>
<p>something like <code>fn filter_map(&amp;mut self, r: impl RangeBounds&lt;usize&gt;, f: impl FnMut(T) -&gt; Option&lt;T&gt;)</code>, so that you could keep things, change things, or remove things, but there's no iterator involved to cause <code>Drop</code> complications</p>



<a name="273279574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279574">(Feb 25 2022 at 20:18)</a>:</h4>
<p>There are some uses of <code>drain_filter</code> in the compiler. Most of them <code>collect</code> the resulting iterator into a <code>Vec</code>.</p>



<a name="273279654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279654">(Feb 25 2022 at 20:19)</a>:</h4>
<p>The other 2 cases seem like they could have been implemented using plain <code>retain</code> instead.</p>



<a name="273279844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279844">(Feb 25 2022 at 20:21)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> retain_mut already allows changing things. It lacks the range part though.</p>



<a name="273279959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279959">(Feb 25 2022 at 20:22)</a>:</h4>
<p><code>retain_mut</code> is still unstable, so we could enhance it.</p>



<a name="273279982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279982">(Feb 25 2022 at 20:23)</a>:</h4>
<p>I'll note that in the tracking issue.</p>



<a name="273279986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273279986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273279986">(Feb 25 2022 at 20:23)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> But it doesn't give ownership.  <code>retain_filter_map</code> lets you do owning things.</p>



<a name="273280124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273280124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273280124">(Feb 25 2022 at 20:24)</a>:</h4>
<p>moving things back in and out has its own costs, unless the compiler is smart enough to elide them</p>



<a name="273280174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273280174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273280174">(Feb 25 2022 at 20:24)</a>:</h4>
<p>or rather, there's an optimization in <code>retain</code> that skips moving things as long as everything has been retained.</p>



<a name="273281081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273281081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273281081">(Feb 25 2022 at 20:32)</a>:</h4>
<p><code>retain_mut</code> is in FCP, added a comment anyway. <a href="https://github.com/rust-lang/rust/issues/90829#issuecomment-1051234859">https://github.com/rust-lang/rust/issues/90829#issuecomment-1051234859</a></p>



<a name="273281373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273281373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273281373">(Feb 25 2022 at 20:35)</a>:</h4>
<p>It does seem a little sad that it looks pretty likely we'll end up with at least 3 different functions for basically one operation (retain, retain_mut, and drain_filter in the future, at minimum)</p>



<a name="273281429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273281429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273281429">(Feb 25 2022 at 20:35)</a>:</h4>
<p>But yes, moving doesn't always optimize out.  I don't know if it would in this case, but you can see in &lt;<a href="https://github.com/rust-lang/rust/issues/76725">https://github.com/rust-lang/rust/issues/76725</a>&gt; that threading an object through a fold can be slower than just using <code>for_each</code>+<code>FnMut</code>.</p>



<a name="273281777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273281777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273281777">(Feb 25 2022 at 20:37)</a>:</h4>
<p>I could also just see us having <code>retain</code>, <code>retain_mut</code>, and <code>retain_map</code> in future.  We have plenty of things with all three versions.  (Though of course one of them is a bit unfortunate in this specific case.)</p>



<a name="273282334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273282334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273282334">(Feb 25 2022 at 20:40)</a>:</h4>
<p>Is the breakage really that widespread from just making retain take <code>FnMut(&amp;mut T) -&gt; bool</code>? (It feels like coercing <code>FnMut(&amp;T) -&gt; bool</code> to the <code>&amp;mut</code> version should be something the compiler could just do ...)</p>



<a name="273282441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273282441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273282441">(Feb 25 2022 at 20:41)</a>:</h4>
<p>I remember trying that years ago: it was enough to cause rustc to fail to build.</p>



<a name="273282519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273282519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273282519">(Feb 25 2022 at 20:42)</a>:</h4>
<p>oof</p>



<a name="273282562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273282562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273282562">(Feb 25 2022 at 20:42)</a>:</h4>
<p>It's basically due to people writing closures in the form <code>iter.retain(|&amp;x| { ... })</code> which breaks when the argument type is changed to <code>&amp;mut T</code>.</p>



<a name="273282666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273282666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273282666">(Feb 25 2022 at 20:43)</a>:</h4>
<p>I don't think the fold case is the best example. iterators and from_iter impls are full of different code paths that may just optimize differently, that does not necessarily mean that it's the moving that confuses the optimizer, could also be other things.<br>
Also, <code>fold_mut</code> wouldn't have been needed in that case, there's <code>scan</code> that provides a mutable state. Nobody remembers <code>scan</code>.</p>



<a name="273282869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273282869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273282869">(Feb 25 2022 at 20:45)</a>:</h4>
<p>IMO it should be tested whether a <code>retain_map</code> would experience any slowdown so that having <code>retain_mut</code> remains worthwhile.</p>



<a name="273283070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273283070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273283070">(Feb 25 2022 at 20:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273282562">said</a>:</p>
<blockquote>
<p>It's basically due to people writing closures in the form <code>iter.retain(|&amp;x| { ... })</code> which breaks when the argument type is changed to <code>&amp;mut T</code>.</p>
</blockquote>
<p>I wonder how hard it would be to allow matching a <code>&amp;mut</code> with a pattern of <code>&amp;x</code>? That <em>seems</em> valid.</p>



<a name="273283122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273283122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273283122">(Feb 25 2022 at 20:48)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> (suggestions welcome for who else to CC)</p>



<a name="273284597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273284597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273284597">(Feb 25 2022 at 21:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273275299">said</a>:</p>
<blockquote>
<p>I think the drain-on-drop behavior evaluating user closures is a bigger issue.</p>
</blockquote>
<p>yeh definitely,  but at least wantd to get the name concern out of the way since I don't see any recent discussion about it</p>



<a name="273285339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273285339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273285339">(Feb 25 2022 at 21:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273283070">said</a>:</p>
<blockquote>
<p>I wonder how hard it would be to allow matching a <code>&amp;mut</code> with a pattern of <code>&amp;x</code>? That <em>seems</em> valid.</p>
</blockquote>
<p>I think it's a long tail of similar things.  <code>iter.retain(Vec::is_empty);</code> breaks if the closure wants <code>&amp;mut</code>, because we don't have function-to-function coercions, for example.  (Though I'd like those too.)</p>



<a name="273285710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273285710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273285710">(Feb 25 2022 at 21:14)</a>:</h4>
<p>Hack: take <code>impl FnMutOnRefOrRefMut</code></p>



<a name="273285770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273285770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273285770">(Feb 25 2022 at 21:15)</a>:</h4>
<p>But such a trait would have to prove that only one <code>FnMut</code> applies</p>



<a name="273290860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273290860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273290860">(Feb 25 2022 at 22:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273276128">said</a>:</p>
<blockquote>
<p>the drain APIs all seem so tragic, between this and the pre-pooping your pants stuff for dealing with leaks, makes me wonder if that's not a sign that these APIs are fundamentally flawed and just don't fit well into rust's ownership model.</p>
</blockquote>
<p>Don't mean to beat a dead horse here, but just anecdotally: The first time I used the <code>drain</code>-like APIs, I was surprised to find out that things I did not consume from the iterator would be dropped and removed anyway. This felt contrary to the typical "lazy" design of iterators. Obviously nothing we can do about it now (and changing this for new APIs seems too confusing to do anyone any good), but just as a point of interest</p>



<a name="273292226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273292226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273292226">(Feb 25 2022 at 22:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273285339">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273283070">said</a>:</p>
<blockquote>
<p>I wonder how hard it would be to allow matching a <code>&amp;mut</code> with a pattern of <code>&amp;x</code>? That <em>seems</em> valid.</p>
</blockquote>
<p>I think it's a long tail of similar things.  <code>iter.retain(Vec::is_empty);</code> breaks if the closure wants <code>&amp;mut</code>, because we don't have function-to-function coercions, for example.  (Though I'd like those too.)</p>
</blockquote>
<p>I'm curious how long a tail it actually is. Coercing functions with <code>&amp;T</code> in their signatures to functions with <code>&amp;mut T</code> in their signatures seems like a natural extension.</p>



<a name="273297985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273297985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273297985">(Feb 25 2022 at 23:15)</a>:</h4>
<p>I guess it also depends how people want to weigh technically-breaking vs nobody-does-that.  Because of course it could be <code>.retain(MyTrait::true_for_mut_ref_but_false_for_shared_ref)</code>.</p>



<a name="273303138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273303138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273303138">(Feb 26 2022 at 00:16)</a>:</h4>
<p>I think it just raises the bar on how strongly justified it has to be</p>



<a name="273304708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273304708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273304708">(Feb 26 2022 at 00:41)</a>:</h4>
<p>Generally speaking, we seem to value "actually not breaking" much higher, and place relatively little value on "technically breaking but nobody notices in practice".</p>



<a name="273304916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273304916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273304916">(Feb 26 2022 at 00:45)</a>:</h4>
<p>would be nice to add a summary to the tracking issue</p>



<a name="273305042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273305042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273305042">(Feb 26 2022 at 00:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273304708">said</a>:</p>
<blockquote>
<p>Generally speaking, we seem to value "actually not breaking" much higher, and place relatively little value on "technically breaking but nobody notices in practice".</p>
</blockquote>
<p>yes, especially as the amount of non-oss rust code grows (and i suspect its getting higher, just measuring from how the disparity between crate downloads and dependents in my own crates has grown), we're getting to the point where we can't trust crater to show us the extent of the issues as much as we once could.</p>



<a name="273305364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273305364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273305364">(Feb 26 2022 at 00:52)</a>:</h4>
<p><span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span> I don't want to treat crater <em>alone</em> as a measure of "nobody does this". I think we should start with some prior for how plausible something seems to do, and then use crater as experimental evidence to update that estimation.</p>



<a name="273305534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273305534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273305534">(Feb 26 2022 at 00:55)</a>:</h4>
<p>I swear I talked to <span class="user-mention" data-user-id="224872">@rylev</span> or someone at rustconf years ago about crater for closed source projects</p>



<a name="273305610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273305610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273305610">(Feb 26 2022 at 00:56)</a>:</h4>
<p>And some sort of system for running your own subset of a crater run internally then submitting the results back to the community</p>



<a name="273305761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273305761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273305761">(Feb 26 2022 at 00:59)</a>:</h4>
<p>yeah it was also discussed at the "enterprise rust unconference" the day before rustconf a few years ago. so it's definitely a thing we've had in mind for a while, although i'm unsure anything ever came of it (i think not).</p>



<a name="273306100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273306100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273306100">(Feb 26 2022 at 01:02)</a>:</h4>
<p>Maybe a good project to throw at one of the big companies using rust looking for where to put their money</p>



<a name="273338699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273338699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273338699">(Feb 26 2022 at 12:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273275767">said</a>:</p>
<blockquote>
<p><em>grumbles about linear types</em></p>
</blockquote>
<p>Since scoped APIs are incredibly handy to mock linear types, I wonder if that's not a part that could deserve more attention to be generally improved?</p>
<ul>
<li><em>e.g.</em>, if we were able to be generic over the <em>effect</em>, at least the <em>async</em> effect, while also being able to feature unboxed <code>async</code> closures with the right signature (possible with TAIT), then continuation-based APIs could be made a bit better, especially for <code>async</code> (where they're so bad right now);</li>
</ul>
<p>Anyhow, whenever drop becomes too problematic, I agree that it then looks like an API issue, and scoped APIs have been so nice for that.</p>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/drain.20filters.20.28tracking.20issue.29/near/273279234">said</a>:</p>
<blockquote>
<p>something like <code>fn filter_map(&amp;mut self, r: impl RangeBounds&lt;usize&gt;, f: impl FnMut(T) -&gt; Option&lt;T&gt;)</code>, so that you could keep things, change things, or remove things, but there's no iterator involved to cause <code>Drop</code> complications</p>
</blockquote>
<p>is one such example of a scoped API, but maybe there could be other designs.</p>
<p>All I'm saying is these things could deserve more exploration <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="273347325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273347325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273347325">(Feb 26 2022 at 15:36)</a>:</h4>
<p>Ah interesting, so you're suggesting a drain api like <code>fn drain(&amp;mut self, f: impl FnMut(Drain) -&gt; Drain)</code></p>



<a name="273347365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/drain%20filters%20%28tracking%20issue%29/near/273347365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/drain.20filters.20(tracking.20issue).html#273347365">(Feb 26 2022 at 15:38)</a>:</h4>
<p>That would solve the problem of the user provided closures running in drop</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>