<html>
<head><meta charset="utf-8"><title>`c_enum` for ffi · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html">`c_enum` for ffi</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273591189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273591189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273591189">(Mar 01 2022 at 04:55)</a>:</h4>
<p>It's currently a little cumbersome to deal with c defined enums. I wonder if it's a good idea to have a <code>c_enum</code> macro for transpiling </p>
<div class="codehilite"><pre><span></span><code>enum A {
    X = 0,
    Y = 1,
    Z = 2,
}
</code></pre></div>
<p>to</p>
<div class="codehilite"><pre><span></span><code>struct A(u8);
impl A {
    const X: A = A(0);
    const Y: A = A(1);
    const Z: A = A(2);
}
</code></pre></div>
<p>or something.</p>



<a name="273592202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273592202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273592202">(Mar 01 2022 at 05:07)</a>:</h4>
<p><a href="https://github.com/Lokathor/sola_kesto/blob/main/src/macros.rs#L172">https://github.com/Lokathor/sola_kesto/blob/main/src/macros.rs#L172</a></p>
<p>like some sort of "foreign enum" macro? ;3</p>



<a name="273592424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273592424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273592424">(Mar 01 2022 at 05:11)</a>:</h4>
<p>It can work surprisingly well with just a <code>macro_rules</code> macro: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=c12edf15aa6b6e143e6cc28c1d990061">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=c12edf15aa6b6e143e6cc28c1d990061</a></p>
<p>It wouldn't even need the explicit variant values with a bit more macro-foo.</p>



<a name="273593180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273593180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273593180">(Mar 01 2022 at 05:24)</a>:</h4>
<p>scott don't forget the fancy debug impl!</p>



<a name="273628871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273628871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273628871">(Mar 01 2022 at 11:56)</a>:</h4>
<p>I have a crate for this:<br>
<a href="https://lib.rs/fake-enum">https://lib.rs/fake-enum</a></p>



<a name="273631662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273631662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273631662">(Mar 01 2022 at 12:22)</a>:</h4>
<blockquote>
<p>It wouldn't even need the explicit variant values with a bit more macro-foo.</p>
</blockquote>
<p>Isn’t that “counting in a macro”, which is notoriously hard?</p>



<a name="273631757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273631757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273631757">(Mar 01 2022 at 12:23)</a>:</h4>
<p>or would you just let the normal discriminant values be added by the compiler￼?</p>



<a name="273682201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273682201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273682201">(Mar 01 2022 at 17:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi/near/273631662">said</a>:</p>
<blockquote>
<p>Isn’t that “counting in a macro”, which is notoriously hard?</p>
</blockquote>
<p>It's legal to define the discriminants using expressions, like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>so some sort of accumulator could probably do it.  (If it <em>had</em> to be <code>C = 2</code> with a literal then yes, it would be at least very hard, AFAIK.)</p>
<p>Though TBH if I was doing this I'd probably require the discriminants as a feature, since if you don't need to know what they are or don't care if they accidentally change than you probably don't need them to be c-enum-style.</p>



<a name="273682311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273682311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273682311">(Mar 01 2022 at 17:53)</a>:</h4>
<p>That's how you get quadratic behavior.</p>



<a name="273682415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273682415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273682415">(Mar 01 2022 at 17:54)</a>:</h4>
<p>well if you're trying to make an enum to work with FFI you <em>almost always</em> want to specify the specific value of each variant anyway</p>



<a name="273682738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273682738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273682738">(Mar 01 2022 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi/near/273682311">said</a>:</p>
<blockquote>
<p>That's how you get quadratic behavior.</p>
</blockquote>
<p>I mean, you can do <a href="https://github.com/rust-lang/rust/blob/f0c4da49983aa699f715caf681e3154b445fb60b/compiler/rustc_serialize/src/serialize.rs#L480-L491">https://github.com/rust-lang/rust/blob/f0c4da49983aa699f715caf681e3154b445fb60b/compiler/rustc_serialize/src/serialize.rs#L480-L491</a> presumably?</p>



<a name="273682892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60c_enum%60%20for%20ffi/near/273682892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60c_enum.60.20for.20ffi.html#273682892">(Mar 01 2022 at 17:56)</a>:</h4>
<p>And eventually just use <a href="https://github.com/rust-lang/rfcs/pull/3086">https://github.com/rust-lang/rfcs/pull/3086</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>