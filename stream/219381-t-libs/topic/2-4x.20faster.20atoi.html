<html>
<head><meta charset="utf-8"><title>2-4x faster atoi · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html">2-4x faster atoi</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259487215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/2-4x%20faster%20atoi/near/259487215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html#259487215">(Oct 29 2021 at 06:25)</a>:</h4>
<p>64-bit swar and 128-bit simd ported to Rust. <br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=e4fdad72945aac0285b48ec3146dbdff">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=e4fdad72945aac0285b48ec3146dbdff</a></p>



<a name="259720793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/2-4x%20faster%20atoi/near/259720793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html#259720793">(Oct 30 2021 at 09:31)</a>:</h4>
<p>Very nice!</p>



<a name="259762406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/2-4x%20faster%20atoi/near/259762406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html#259762406">(Oct 31 2021 at 01:49)</a>:</h4>
<p>Tested out core_simd but couldn't figure out how to _mm_madd with current api.<br>
<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=a7d4ad624f3379b040b32c4548ba2ce7">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=a7d4ad624f3379b040b32c4548ba2ce7</a></p>



<a name="259798323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/2-4x%20faster%20atoi/near/259798323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html#259798323">(Oct 31 2021 at 17:19)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=bf8ae125a570754bbed900045f8a94eb">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=bf8ae125a570754bbed900045f8a94eb</a><br>
Changes: made core_simd work with "swizzle" workarounds and added forbid(unsafe_code)</p>
<p>If someone could bench this on non-x86 that would be great.</p>



<a name="259798762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/2-4x%20faster%20atoi/near/259798762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html#259798762">(Oct 31 2021 at 17:30)</a>:</h4>
<p>Latest version on a Macbook Air M1 (aarch64):</p>
<div class="codehilite"><pre><span></span><code>/dev/spikes/fastatoi
$ rustc --version
rustc 1.58.0-nightly (e249ce6b2 2021-10-30)
~/dev/spikes/fastatoi
$ cargo bench
    Finished bench [optimized] target(s) in 0.01s
     Running unittests (target/release/deps/fastatoi-9bbd8d26b9670993)

running 23 tests
test parse::test_convert_x4 ... ignored
test parse::test_convert_x8 ... ignored
test parse::test_parse ... ignored
test parse::test_parse_generic_params ... ignored
test parse::test_parse_invalid ... ignored
test test::bench_123456_new         ... bench:           3 ns/iter (+/- 0)
test test::bench_123456_std         ... bench:           5 ns/iter (+/- 0)
test test::bench_1_new              ... bench:           3 ns/iter (+/- 0)
test test::bench_1_std              ... bench:           3 ns/iter (+/- 0)
test test::bench_999999999_new      ... bench:           4 ns/iter (+/- 0)
test test::bench_999999999_std      ... bench:           7 ns/iter (+/- 0)
test test::bench_invalid_new        ... bench:           3 ns/iter (+/- 0)
test test::bench_invalid_std        ... bench:          11 ns/iter (+/- 0)
test test::bench_many_new           ... bench:   1,018,891 ns/iter (+/- 15,549)
test test::bench_many_std           ... bench:   1,694,355 ns/iter (+/- 5,548)
test test::bench_max_new            ... bench:           4 ns/iter (+/- 0)
test test::bench_max_std            ... bench:          17 ns/iter (+/- 0)
test test::bench_overflow_early_new ... bench:           3 ns/iter (+/- 0)
test test::bench_overflow_early_std ... bench:          15 ns/iter (+/- 0)
test test::bench_overflow_late_new  ... bench:           5 ns/iter (+/- 0)
test test::bench_overflow_late_std  ... bench:          16 ns/iter (+/- 0)
test test::bench_too_long_new       ... bench:           3 ns/iter (+/- 0)
test test::bench_too_long_std       ... bench:          16 ns/iter (+/- 0)

test result: ok. 0 passed; 0 failed; 5 ignored; 18 measured; 0 filtered out; finished in 18.90s

$ cargo bench --features simd_core
    Updating git repository `https://github.com/rust-lang/portable-simd`
   Compiling core_simd v0.1.0 (https://github.com/rust-lang/portable-simd#772bf209)
   Compiling fastatoi v0.1.0 (/Users/hans/dev/spikes/fastatoi)
warning: function is never used: `all_ascii_digits_8`
  --&gt; src/lib.rs:17:18
   |
17 |     pub const fn all_ascii_digits_8(src: u64) -&gt; bool {
   |                  ^^^^^^^^^^^^^^^^^^
   |
   = note: `#[warn(dead_code)]` on by default

warning: `fastatoi` (lib test) generated 1 warning
    Finished bench [optimized] target(s) in 4.14s
     Running unittests (target/release/deps/fastatoi-03aa29e8faed8db6)

running 23 tests
test parse::test_convert_x4 ... ignored
test parse::test_convert_x8 ... ignored
test parse::test_parse ... ignored
test parse::test_parse_generic_params ... ignored
test parse::test_parse_invalid ... ignored
test test::bench_123456_new         ... bench:           7 ns/iter (+/- 0)
test test::bench_123456_std         ... bench:           5 ns/iter (+/- 0)
test test::bench_1_new              ... bench:           3 ns/iter (+/- 0)
test test::bench_1_std              ... bench:           3 ns/iter (+/- 0)
test test::bench_999999999_new      ... bench:           7 ns/iter (+/- 0)
test test::bench_999999999_std      ... bench:           7 ns/iter (+/- 0)
test test::bench_invalid_new        ... bench:           7 ns/iter (+/- 0)
test test::bench_invalid_std        ... bench:          11 ns/iter (+/- 0)
test test::bench_many_new           ... bench:   1,214,212 ns/iter (+/- 14,303)
test test::bench_many_std           ... bench:   1,708,708 ns/iter (+/- 12,093)
test test::bench_max_new            ... bench:           8 ns/iter (+/- 0)
test test::bench_max_std            ... bench:          17 ns/iter (+/- 0)
test test::bench_overflow_early_new ... bench:           3 ns/iter (+/- 0)
test test::bench_overflow_early_std ... bench:          15 ns/iter (+/- 0)
test test::bench_overflow_late_new  ... bench:           8 ns/iter (+/- 0)
test test::bench_overflow_late_std  ... bench:          16 ns/iter (+/- 0)
test test::bench_too_long_new       ... bench:           3 ns/iter (+/- 0)
test test::bench_too_long_std       ... bench:          16 ns/iter (+/- 0)

test result: ok. 0 passed; 0 failed; 5 ignored; 18 measured; 0 filtered out; finished in 8.98s
</code></pre></div>



<a name="259799050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/2-4x%20faster%20atoi/near/259799050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/2-4x.20faster.20atoi.html#259799050">(Oct 31 2021 at 17:38)</a>:</h4>
<p>Tested on my <code>armv7-unknown-linux-gnueabihf</code> machine.</p>
<div class="codehilite"><pre><span></span><code>$ cargo +nightly bench
    Finished bench [optimized] target(s) in 0.07s
     Running unittests (target/release/deps/parse-1d8181307a0fb7a5)

running 23 tests
test parse::test_convert_x4 ... ignored
test parse::test_convert_x8 ... ignored
test parse::test_parse ... ignored
test parse::test_parse_generic_params ... ignored
test parse::test_parse_invalid ... ignored
test test::bench_123456_new         ... bench:         143 ns/iter (+/- 3)
test test::bench_123456_std         ... bench:         126 ns/iter (+/- 0)
test test::bench_1_new              ... bench:          55 ns/iter (+/- 0)
test test::bench_1_std              ... bench:          56 ns/iter (+/- 0)
test test::bench_999999999_new      ... bench:         109 ns/iter (+/- 0)
test test::bench_999999999_std      ... bench:         164 ns/iter (+/- 0)
test test::bench_invalid_new        ... bench:          73 ns/iter (+/- 4)
test test::bench_invalid_std        ... bench:         225 ns/iter (+/- 13)
test test::bench_many_new           ... bench:  20,539,629 ns/iter (+/- 54,107)
test test::bench_many_std           ... bench:  29,427,077 ns/iter (+/- 315,612)
test test::bench_max_new            ... bench:         107 ns/iter (+/- 6)
test test::bench_max_std            ... bench:         301 ns/iter (+/- 1)
test test::bench_overflow_early_new ... bench:          86 ns/iter (+/- 4)
test test::bench_overflow_early_std ... bench:         293 ns/iter (+/- 1)
test test::bench_overflow_late_new  ... bench:         110 ns/iter (+/- 6)
test test::bench_overflow_late_std  ... bench:         300 ns/iter (+/- 3)
test test::bench_too_long_new       ... bench:          33 ns/iter (+/- 1)
test test::bench_too_long_std       ... bench:         301 ns/iter (+/- 1)

test result: ok. 0 passed; 0 failed; 5 ignored; 18 measured; 0 filtered out; finished in 51.34s
</code></pre></div>
<div class="codehilite"><pre><span></span><code>$ cargo +nightly bench --features &quot;core_simd&quot;
   Compiling core_simd v0.1.0 (https://github.com/rust-lang/portable-simd#772bf209)
   Compiling parse v0.1.0 (/home/*****/parse)
    Finished bench [optimized] target(s) in 56.12s
     Running unittests (target/release/deps/parse-929807f38b3adfcb)

running 23 tests
test parse::test_convert_x4 ... ignored
test parse::test_convert_x8 ... ignored
test parse::test_parse ... ignored
test parse::test_parse_generic_params ... ignored
test parse::test_parse_invalid ... ignored
test test::bench_123456_new         ... bench:          67 ns/iter (+/- 3)
test test::bench_123456_std         ... bench:         126 ns/iter (+/- 7)
test test::bench_1_new              ... bench:          55 ns/iter (+/- 3)
test test::bench_1_std              ... bench:          56 ns/iter (+/- 0)
test test::bench_999999999_new      ... bench:         115 ns/iter (+/- 1)
test test::bench_999999999_std      ... bench:         164 ns/iter (+/- 9)
test test::bench_invalid_new        ... bench:          73 ns/iter (+/- 0)
test test::bench_invalid_std        ... bench:         225 ns/iter (+/- 2)
test test::bench_many_new           ... bench:  20,599,377 ns/iter (+/- 690,649)
test test::bench_many_std           ... bench:  29,500,022 ns/iter (+/- 1,273,600)
test test::bench_max_new            ... bench:         107 ns/iter (+/- 6)
test test::bench_max_std            ... bench:         301 ns/iter (+/- 5)
test test::bench_overflow_early_new ... bench:          82 ns/iter (+/- 0)
test test::bench_overflow_early_std ... bench:         293 ns/iter (+/- 3)
test test::bench_overflow_late_new  ... bench:         104 ns/iter (+/- 6)
test test::bench_overflow_late_std  ... bench:         301 ns/iter (+/- 5)
test test::bench_too_long_new       ... bench:          31 ns/iter (+/- 1)
test test::bench_too_long_std       ... bench:         301 ns/iter (+/- 6)

test result: ok. 0 passed; 0 failed; 5 ignored; 18 measured; 0 filtered out; finished in 58.82s
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>