<html>
<head><meta charset="utf-8"><title>std::thread::Thread not Unwind safe on macos? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F.html">std::thread::Thread not Unwind safe on macos?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275528493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3AThread%20not%20Unwind%20safe%20on%20macos%3F/near/275528493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F.html#275528493">(Mar 16 2022 at 15:33)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7db21b09b483dae9d53e83e9d92c7d07">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7db21b09b483dae9d53e83e9d92c7d07</a> compiles fine on linux, but on macos:</p>
<div class="codehilite"><pre><span></span><code>error[E0277]: the type `UnsafeCell&lt;libc::unix::bsd::apple::pthread_cond_t&gt;` may contain interior mutability and a reference may not be safely transferrable across a catch_unwind boundary
 --&gt; src/main.rs:6:5
  |
6 |     safe(std::thread::current());
  |     ^^^^ `UnsafeCell&lt;libc::unix::bsd::apple::pthread_cond_t&gt;` may contain interior mutability and a reference may not be safely transferrable across a catch_unwind boundary
  |
  = help: within `std::thread::Inner`, the trait `RefUnwindSafe` is not implemented for `UnsafeCell&lt;libc::unix::bsd::apple::pthread_cond_t&gt;`
  = note: required because it appears within the type `std::sys::unix::condvar::Condvar`
  = note: required because it appears within the type `*const std::sys::unix::condvar::Condvar`
  = note: required because it appears within the type `Unique&lt;std::sys::unix::condvar::Condvar&gt;`
  = note: required because it appears within the type `Box&lt;std::sys::unix::condvar::Condvar&gt;`
  = note: required because it appears within the type `std::sys_common::condvar::Condvar`
  = note: required because it appears within the type `Condvar`
  = note: required because it appears within the type `std::sys_common::thread_parker::generic::Parker`
  = note: required because it appears within the type `std::thread::Inner`
  = note: required because of the requirements on the impl of `UnwindSafe` for `Arc&lt;std::thread::Inner&gt;`
  = note: required because it appears within the type `Thread`
</code></pre></div>
<p>is this an oversight? Seems bad to have different behavior on different platforms without documenting it. I tested a couple previous stables and it doesnt seem to be a recent regression</p>



<a name="275982086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3AThread%20not%20Unwind%20safe%20on%20macos%3F/near/275982086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F.html#275982086">(Mar 20 2022 at 18:54)</a>:</h4>
<p>that looks like an oversight. quite possibly we should get rid of the 'unwind safe' traits entirely.</p>



<a name="276008368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3AThread%20not%20Unwind%20safe%20on%20macos%3F/near/276008368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F.html#276008368">(Mar 21 2022 at 05:41)</a>:</h4>
<p>Most probably, particularly since they have nothing to do with the normal safe/unsafe distinction. (specifically: all types already <em>must</em> remain sound in the presence of unwinding, and UnwindSafe is just like "also I'm pretty sure it's useful as well as sound")</p>



<a name="276033921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3AThread%20not%20Unwind%20safe%20on%20macos%3F/near/276033921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F.html#276033921">(Mar 21 2022 at 11:01)</a>:</h4>
<p>Previous discussion: <a href="https://internals.rust-lang.org/t/pre-rfc-deprecating-unwindsafe/15974">https://internals.rust-lang.org/t/pre-rfc-deprecating-unwindsafe/15974</a></p>



<a name="276410814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/std%3A%3Athread%3A%3AThread%20not%20Unwind%20safe%20on%20macos%3F/near/276410814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F.html#276410814">(Mar 23 2022 at 22:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/std.3A.3Athread.3A.3AThread.20not.20Unwind.20safe.20on.20macos.3F/near/275982086">said</a>:</p>
<blockquote>
<p>that looks like an oversight. quite possibly we should get rid of the 'unwind safe' traits entirely.</p>
</blockquote>
<p>I agree</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>