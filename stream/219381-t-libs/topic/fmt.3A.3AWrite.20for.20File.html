<html>
<head><meta charset="utf-8"><title>fmt::Write for File · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html">fmt::Write for File</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275703082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275703082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275703082">(Mar 17 2022 at 18:06)</a>:</h4>
<p>Why doesn't File implement fmt::Write? I want my code to accept both files and strings (through <code>&lt;W: fmt::Write&gt;(mut w: W)</code>) but File doesn't implement fmt::Write.</p>
<p>And I can't switch to io::Write because then it wouldn't work for strings (and I'm only dealing with Unicode anyway).</p>
<p><em>Original thread, with replies, is <a href="#narrow/stream/122651-general/topic/fmt.3A.3AWrite.20for.20File">here</a>. Someone suggested I post here as well since it's relevant to the libs team.</em></p>



<a name="275704007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275704007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275704007">(Mar 17 2022 at 18:13)</a>:</h4>
<p>As brought up at <a href="#narrow/stream/122651-general/topic/fmt.3A.3AWrite.20for.20File/near/275327123">https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/fmt.3A.3AWrite.20for.20File/near/275327123</a> doing so would result in ambiguity errors.</p>



<a name="275704018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275704018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275704018">(Mar 17 2022 at 18:14)</a>:</h4>
<p>There's no fundamental reason we couldn't add it, but doing so would introduce a lot of inference breakage in any code that has both traits imported and uses <code>write!</code> or <code>writeln!</code> with files.</p>



<a name="275704094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275704094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275704094">(Mar 17 2022 at 18:14)</a>:</h4>
<p><code>write!(file, "{}", foo)</code> wouldn't know if it should call <code>fmt::Write::write_fmt</code> or <code>io::Write::write_fmt</code>.</p>



<a name="275708712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275708712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275708712">(Mar 17 2022 at 18:50)</a>:</h4>
<p>but doesn't the macro just call write_fmt and then rely on what traits are in scope? So as josh said, it's only a problem when both versions of Write are in scope. Which is certainly possible, but rare. And it is an allowed breakage.</p>



<a name="275709315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275709315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275709315">(Mar 17 2022 at 18:55)</a>:</h4>
<p>It's allowed, but many times we don't make changes that would cause even allowed breakage if we feel the breakage is too widespread.</p>



<a name="275709346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275709346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275709346">(Mar 17 2022 at 18:55)</a>:</h4>
<p>And it's not that uncommon to have both traits imported, if you're working with multiple types of objects.</p>



<a name="275713103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275713103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275713103">(Mar 17 2022 at 19:25)</a>:</h4>
<p>I feel like I've run into this issue a few times before too, and it seems unfortunate to not have a simple, intuitive, and ergonomic solution since it is likely to stymie users from executing the design they want. Is there any way the ambiguity issue can be solved or would a new language feature (some kind of annotation that would say to prefer one trait over another when both are implemented?) be required?</p>



<a name="275715980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275715980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275715980">(Mar 17 2022 at 19:49)</a>:</h4>
<p>2nd on my "write an RFC list" is something like <a href="https://internals.rust-lang.org/t/idea-paths-in-method-names/6834?u=scottmcm">https://internals.rust-lang.org/t/idea-paths-in-method-names/6834?u=scottmcm</a> to handle that -- especially with supertrait shadowing accepted, and <a href="https://github.com/rust-lang/rfcs/pull/3240">https://github.com/rust-lang/rfcs/pull/3240</a> now under consideration</p>
<p>But that wouldn't solve the macros, of course.</p>
<p>Is there a <code>.as_utf8()</code> adapter for <code>io::Write</code> to give a temporary <code>fmt::Write</code> or something?</p>



<a name="275717569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717569">(Mar 17 2022 at 20:01)</a>:</h4>
<p>adding <code>as_fmt_writer</code> does seem the simplest way</p>



<a name="275717734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717734">(Mar 17 2022 at 20:02)</a>:</h4>
<p>Would that be a provided trait method or something else?</p>



<a name="275717797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717797">(Mar 17 2022 at 20:02)</a>:</h4>
<p>Entertaining a completely different direction for a moment: we could also implement <code>io::Write</code> for String.</p>



<a name="275717815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717815">(Mar 17 2022 at 20:02)</a>:</h4>
<p>That seems like an interesting idea, at least as a solution until we have something more general. <em>EDIT: This message was in response to the <code>as_utf8</code>/<code>as_fmt_writer</code> comments.</em></p>



<a name="275717817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717817">(Mar 17 2022 at 20:02)</a>:</h4>
<p>And return <code>io::Error</code> on non-UTF-8.</p>



<a name="275717897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717897">(Mar 17 2022 at 20:03)</a>:</h4>
<p>It wouldn't be the first output device to return an error on invalid Unicode; the Windows console does as well.</p>



<a name="275717902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717902">(Mar 17 2022 at 20:03)</a>:</h4>
<p>Hmm seems interesting. Although it perhaps doesn't solve the more general problem since there are other implementors of <code>fmt::Write</code></p>



<a name="275717948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275717948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275717948">(Mar 17 2022 at 20:03)</a>:</h4>
<p>True, but it solves the "write to String or File" problem.</p>



<a name="275718060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718060">(Mar 17 2022 at 20:04)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Noah Lev</span> As an aside, in the short term, would your particular use case be solved by using <code>Vec&lt;u8&gt;</code> in place of <code>String</code> (possibly with the help of the bstr crate to make it easier to work with)?</p>



<a name="275718068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718068">(Mar 17 2022 at 20:04)</a>:</h4>
<p>It still seems a little fishy to use something named <code>io::Write</code> with a <code>String</code>, but it might be worth it</p>



<a name="275718140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718140">(Mar 17 2022 at 20:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File/near/275718060">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> As an aside, in the short term, would your particular use case be solved by using <code>Vec&lt;u8&gt;</code> (possibly with the help of the bstr crate to make it easier to work with)?</p>
</blockquote>
<p>Hmm... perhaps. FWIW, this is my use case: <a href="https://github.com/GuillaumeGomez/minifier-rs/pull/86">https://github.com/GuillaumeGomez/minifier-rs/pull/86</a></p>



<a name="275718184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718184">(Mar 17 2022 at 20:05)</a>:</h4>
<p>I want <code>Minified</code> to be able to write to <code>io::Write</code> and work with <code>to_string</code> (or <code>format!</code> in general)</p>



<a name="275718278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718278">(Mar 17 2022 at 20:06)</a>:</h4>
<p>So perhaps I could write to <code>Vec&lt;u8&gt;</code> and then do <code>String::from_utf8(...).unwrap_or(std::fmt::Error)</code></p>



<a name="275718672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718672">(Mar 17 2022 at 20:09)</a>:</h4>
<p>I'm surprised that there's a desire for avoiding just having minify return String -- it seems like in practice it's a simpler API and you're probably almost always directly writing the whole thing anyway?</p>



<a name="275718723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718723">(Mar 17 2022 at 20:09)</a>:</h4>
<p>The issue is that it wastes memory since a ton of small strings are concatenated together and then immediately written out</p>



<a name="275718738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718738">(Mar 17 2022 at 20:09)</a>:</h4>
<p>I also want to make the API more lazy in general and this is a start</p>



<a name="275718860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718860">(Mar 17 2022 at 20:10)</a>:</h4>
<p>I don't understand how this helps with that, to be honest</p>



<a name="275718891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718891">(Mar 17 2022 at 20:10)</a>:</h4>
<p>Are you minifying many-megabyte files or something?</p>



<a name="275718892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718892">(Mar 17 2022 at 20:10)</a>:</h4>
<p>Can you elaborate?</p>



<a name="275718955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275718955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275718955">(Mar 17 2022 at 20:11)</a>:</h4>
<p>I don't know for sure that it'll improve performance but I would like to test it.</p>



<a name="275719137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719137">(Mar 17 2022 at 20:12)</a>:</h4>
<p>I profiled rustdoc on an empty crate with no_core just to see what came up and minification dominated by far. So I imagine improving it would have some effect, even if it's relatively small, on more complex runs.</p>



<a name="275719215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719215">(Mar 17 2022 at 20:13)</a>:</h4>
<p>But writing to a String is <em>by far</em> faster than almost anything else you can do, right?</p>



<a name="275719259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719259">(Mar 17 2022 at 20:13)</a>:</h4>
<p>(Certainly faster than file i/o, if you're exceeding in-memory page caching in the OS)</p>



<a name="275719273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719273">(Mar 17 2022 at 20:13)</a>:</h4>
<p>Well, currently the minifier generates a big Vec of tokens that it then concatenates into a string and writes to a file</p>



<a name="275719291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719291">(Mar 17 2022 at 20:13)</a>:</h4>
<p>So I was hoping to skip the intermediate step</p>



<a name="275719323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719323">(Mar 17 2022 at 20:14)</a>:</h4>
<p>And then eventually get rid of the intermediate token vec</p>



<a name="275719425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719425">(Mar 17 2022 at 20:14)</a>:</h4>
<p>FWIW, rustdoc minifies 232 KB of CSS and JS every run. So not super big but not small either</p>



<a name="275719528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719528">(Mar 17 2022 at 20:15)</a>:</h4>
<p>Perhaps the ideal solution would be to minify them at compile-time – although I guess that might break some debugging that people do so might not be possible</p>



<a name="275719592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719592">(Mar 17 2022 at 20:16)</a>:</h4>
<p>That token vec is going to consume (likely) much more memory than the string representation of it, for sure</p>



<a name="275719712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719712">(Mar 17 2022 at 20:16)</a>:</h4>
<p>All right, so maybe I'll try to incrementalize the token vec instead. It seemed like it might be low-hanging fruit to get rid of the intermediate string</p>



<a name="275719753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719753">(Mar 17 2022 at 20:17)</a>:</h4>
<p>io::Write on String seems "obvious enough" for me. There's nearly no reason at all for fmt Write and io Write to be separate traits to begin with.</p>



<a name="275719781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719781">(Mar 17 2022 at 20:17)</a>:</h4>
<p>io::Write on String seems "ok", though is probably a backwards compat hazard so I'm not sure we could pull it off.</p>



<a name="275719834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719834">(Mar 17 2022 at 20:17)</a>:</h4>
<p>Yeah, wouldn't io::Write on String have the same backcompat issues as fmt::Write on File?</p>



<a name="275719949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275719949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275719949">(Mar 17 2022 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File/near/275719712">said</a>:</p>
<blockquote>
<p>All right, so maybe I'll try to incrementalize the token vec instead. It seemed like it might be low-hanging fruit to get rid of the intermediate string</p>
</blockquote>
<p>I would try benchmarking the tokenization -- my guess is that the intermediate String is incredibly cheap -- a memcpy of a couple hundred kilobytes is basically what you're saving here, and memcpy is really quite fast.</p>



<a name="275720222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275720222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275720222">(Mar 17 2022 at 20:20)</a>:</h4>
<p>Thanks, I'll try that</p>



<a name="275720973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275720973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275720973">(Mar 17 2022 at 20:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File/near/275719781">said</a>:</p>
<blockquote>
<p>io::Write on String seems "ok", though is probably a backwards compat hazard so I'm not sure we could pull it off.</p>
</blockquote>
<p>It'd have the same backwards compatibility hazard, but it <em>might</em> have less actual breakage. Worth testing with a crater run.</p>



<a name="275721053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275721053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275721053">(Mar 17 2022 at 20:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> The other downside of preparing the whole string and then writing it out is that you start the write later, rather than pipelining the operation with the I/O.</p>



<a name="275721158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275721158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275721158">(Mar 17 2022 at 20:28)</a>:</h4>
<p>In theory, yes, though for anything less than a few megabytes I would expect the whole write to just land in kernel buffers and be written in the background anyway, right?</p>



<a name="275721198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275721198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275721198">(Mar 17 2022 at 20:28)</a>:</h4>
<p>Would that apply to non-Linux kernels too?</p>



<a name="275722022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275722022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275722022">(Mar 17 2022 at 20:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> That's not what I mean. Suppose it takes 100ms to do the minification, and 100ms to write to disk. If you write to a string first the whole thing takes 200ms. If you start writing to disk right away, it takes 100ms plus however long it takes to <em>start</em> producing minified output.</p>



<a name="275722384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275722384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275722384">(Mar 17 2022 at 20:37)</a>:</h4>
<p>Is the write to disk actually something you need to wait for (even before process end)?</p>



<a name="275722585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275722585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275722585">(Mar 17 2022 at 20:38)</a>:</h4>
<p>But yes, you're not wrong that buffering in memory will theoretically could slow you down</p>



<a name="275722642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275722642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275722642">(Mar 17 2022 at 20:39)</a>:</h4>
<p>but I would expect the many small writes (that you say would pipeline) are in practice going to be just as slow -- or slower -- if done in small bits due to more syscalls, etc. so it's not an obvious win to do that interleaving</p>



<a name="275728159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275728159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275728159">(Mar 17 2022 at 21:15)</a>:</h4>
<p>I definitely wouldn't write bytes or short strings at a time, yeah; I was thinking a buffered writer that wrote kilobytes at a time, at minimum.</p>



<a name="275731035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275731035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275731035">(Mar 17 2022 at 21:36)</a>:</h4>
<p>Naively wrapper the inner writer with BufWriter would help significantly</p>



<a name="275744932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275744932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275744932">(Mar 18 2022 at 00:05)</a>:</h4>
<p>Are <code>File</code>s not automatically buffered? Or are the buffers just small?</p>



<a name="275745012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275745012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275745012">(Mar 18 2022 at 00:06)</a>:</h4>
<p>There are no buffers in Rust with File, so each write is its own syscall.</p>



<a name="275749900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275749900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275749900">(Mar 18 2022 at 01:24)</a>:</h4>
<p>and then the kernel will do its own buffering, independent of the process</p>



<a name="275815381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275815381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lovelymono <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275815381">(Mar 18 2022 at 15:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File/near/275717797">said</a>:</p>
<blockquote>
<p>Entertaining a completely different direction for a moment: we could also implement <code>io::Write</code> for String.</p>
</blockquote>
<p>It feels like implementing <code>io::Write</code> for <code>String</code> breaks the mental abstraction of an <code>io</code> module, since it isn't really an IO device.</p>



<a name="275819810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275819810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275819810">(Mar 18 2022 at 15:38)</a>:</h4>
<p>well fmt write outputs str, and io write outputs [u8], which is less restricted than str. So if either File or String are going to implement the "other" trait then File should support fmt write because any str can be viewed as [u8]</p>



<a name="275820125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275820125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275820125">(Mar 18 2022 at 15:41)</a>:</h4>
<p>But really we should just put a generic adapter for all io write types so that they can be viewed as a fmt writers</p>



<a name="275846832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275846832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johannes Dahlström <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275846832">(Mar 18 2022 at 18:50)</a>:</h4>
<p>Isn't "io to memory buffer" a pretty standard concept? C++ has <code>stringstream</code>, Java has <code>ArrayOutputStream</code> (byte-oriented) / <code>StringWriter</code> (utf-16) and so on</p>



<a name="275847379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275847379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johannes Dahlström <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275847379">(Mar 18 2022 at 18:55)</a>:</h4>
<p>(Granted in <code>stringstream</code>'s case it's because C++ couples i/o and formatting which Rust (and Java) doesn't do)</p>



<a name="275847890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275847890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275847890">(Mar 18 2022 at 18:59)</a>:</h4>
<p><code>io::Write</code> does work in memory with <code>Vec&lt;u8&gt;</code>, just not <code>String</code> because that has to be utf-8</p>



<a name="275852416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275852416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johannes Dahlström <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275852416">(Mar 18 2022 at 19:35)</a>:</h4>
<p>Oh, right. So <code>fmt::Write</code> is <em>sort</em> of like Java's <code>Writer</code>, except that in Java it works such that you wrap an <code>OutputStream</code> (byte i/o) in a <code>Writer</code> to get string/formatted i/o… which in turn is similar to the idea in this discussion of a wrapper adapting <code>io::Write</code> to <code>fmt::Write</code>. Which IMHO makes a lot of sense to have in any case.</p>



<a name="275852697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/fmt%3A%3AWrite%20for%20File/near/275852697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Johannes Dahlström <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/fmt.3A.3AWrite.20for.20File.html#275852697">(Mar 18 2022 at 19:37)</a>:</h4>
<p>(Just like in Rust, in Java you can't do byte i/o into a String because of the UTF invariant.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>