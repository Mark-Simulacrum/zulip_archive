<html>
<head><meta charset="utf-8"><title>Static thread locals · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html">Static thread locals</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259097101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259097101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259097101">(Oct 26 2021 at 13:38)</a>:</h4>
<p>The Windows implementation of <code>std::thread_local</code> use the <a href="https://github.com/rust-lang/rust/blob/c7a30c8b6860d1f3459086f7a91074db1b54bc37/library/std/src/sys/windows/thread_local_key.rs#L49">dynamic TLS APIs</a>. Which is great! However, this means there's no way in stable Rust (as far as I know) to do implicitly initialized TLS. These are embedded in the <code>.tls</code> section and the OS will automatically copy them for each new thread.</p>
<p>This can be implemented on nightly using <code>asm!</code> for generating the right assembly (which is done in <a href="https://github.com/ChrisDenton/wintls/">this example crate</a>) but this is lacking compared to proper compiler support. It'd be great to have something that works on stable and is a bit more ergonomic.</p>
<p>I say this not because I'm making any concrete proposals at this time. I just saw people were working on TLS stuff and thought it was worth mentioning, in case this is of interest to anyone.</p>



<a name="259097287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259097287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259097287">(Oct 26 2021 at 13:39)</a>:</h4>
<p>Is the implicit version faster? Or just more convenient?</p>



<a name="259098195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259098195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259098195">(Oct 26 2021 at 13:45)</a>:</h4>
<p>It's more convenient in some ways. In C++ it's used just like a normal static (aside from its magic thread behaviour). And it doesn't require manual initialization. I would assume it's faster because it doesn't require a function call (but I admit I haven't benchmarked it).</p>



<a name="259099595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259099595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259099595">(Oct 26 2021 at 13:56)</a>:</h4>
<p>Incidentally, this is how <code>thread_local</code> is implemented in MSVC C++ which is partly why I've been looking at it. I've been asking myself "what can C++ do that Rust can't?" and this was one of the things. Not that that is a reason on its own to implement something.</p>



<a name="259101308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259101308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259101308">(Oct 26 2021 at 14:08)</a>:</h4>
<p>So this would improve our ability to support our thread_local attribute on Windows?</p>



<a name="259101363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259101363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259101363">(Oct 26 2021 at 14:08)</a>:</h4>
<p>I'd be happy to see that happen, and I'm hoping we could use our existing attribute for that, just as we do on Linux.</p>



<a name="259103378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259103378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259103378">(Oct 26 2021 at 14:21)</a>:</h4>
<p>I'm not actually sure! It feels like static TLS could (perhaps) be an optimization for small, const initialized, <code>Copy</code> types that use <code>thread_local</code>. But I'm not certain if that's a good idea or not. Or it could be used for all <code>thread_locals</code> but I'd want to investigate the trade-offs a bit more.</p>



<a name="259103411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259103411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259103411">(Oct 26 2021 at 14:21)</a>:</h4>
<p>I guess the issue at the moment is that they might both have different trade-offs but, while dynamic TLS can be reimplemented by any third party crate, static TLS really needs some support from the compiler (at a minimum, reading and writing values).</p>



<a name="259103552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259103552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259103552">(Oct 26 2021 at 14:22)</a>:</h4>
<p>Adding compiler support makes sense, I think.</p>



<a name="259103616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259103616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259103616">(Oct 26 2021 at 14:22)</a>:</h4>
<p>I'm distinguishing between <code>#[thread_local]</code> and <code>thread_local!</code>.</p>



<a name="259103669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259103669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259103669">(Oct 26 2021 at 14:23)</a>:</h4>
<p>I think the former should use static; I'm not sure if the latter should use static or dynamic, or if there's some semantic requirement of <code>thread_local!</code> that might distinguish.</p>



<a name="259104378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259104378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259104378">(Oct 26 2021 at 14:27)</a>:</h4>
<p>Ah, right. Yeah that makes sense. I think so long as there's some way to do both then I'm happy <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="259111129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259111129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259111129">(Oct 26 2021 at 15:09)</a>:</h4>
<blockquote>
<p>The Windows implementation of std::thread_local use the dynamic TLS APIs. Which is great! However, this means there's no way in stable Rust (as far as I know) to do implicitly initialized TLS. These are embedded in the .tls section and the OS will automatically copy them for each new thread.</p>
</blockquote>
<p><code>thread_local!</code> uses implicitly initialized TLS using <code>#[thread_local]</code> with MSVC. However implicitly initialized TLS doesn't provide destructor support, so the code you linked is used to run the drop impl of thread locals when necessary.</p>
<p><code>#[thread_local]</code> definition: <a href="https://github.com/rust-lang/rust/blob/0d7f236b8a255b7e0afa19223bfe72cbaf9cc2d5/library/std/src/thread/local.rs#L202">https://github.com/rust-lang/rust/blob/0d7f236b8a255b7e0afa19223bfe72cbaf9cc2d5/library/std/src/thread/local.rs#L202</a><br>
destructor registration: <a href="https://github.com/rust-lang/rust/blob/0d7f236b8a255b7e0afa19223bfe72cbaf9cc2d5/library/std/src/thread/local.rs#L220">https://github.com/rust-lang/rust/blob/0d7f236b8a255b7e0afa19223bfe72cbaf9cc2d5/library/std/src/thread/local.rs#L220</a></p>



<a name="259112297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259112297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259112297">(Oct 26 2021 at 15:16)</a>:</h4>
<p>isn't thread spawning super slow on windows anyway? i.e. it would only provide a tiny relative improvement.</p>



<a name="259113589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259113589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259113589">(Oct 26 2021 at 15:24)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="133247">@bjorn3</span>, I missed that. It makes more sense now.</p>



<a name="259117492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259117492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259117492">(Oct 26 2021 at 15:49)</a>:</h4>
<p>It is process creation that is super slow on windows. Thread creation on windows is _only_ about 2x slower than on linux. Source: <a href="https://stackoverflow.com/questions/47845/why-is-creating-a-new-process-more-expensive-on-windows-than-linux/51396188#51396188">https://stackoverflow.com/questions/47845/why-is-creating-a-new-process-more-expensive-on-windows-than-linux/51396188#51396188</a></p>



<a name="259118006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259118006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259118006">(Oct 26 2021 at 15:53)</a>:</h4>
<p>Can if there's a particular reason why is switches to dynamic tls for the needs drop case? It seems like the destructor code is independent of how the TLS slot is allocated? It just needs space for a pointer. Is it so there's a key?</p>



<a name="259118590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259118590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259118590">(Oct 26 2021 at 15:57)</a>:</h4>
<p>It doesn't switch to dynamic tls. It uses it in addition to statis tls. The static tls is used for storing the actual data. The dynamic tls is used to call the destructor.</p>



<a name="259118676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259118676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259118676">(Oct 26 2021 at 15:57)</a>:</h4>
<p>Ah, I see! I completely misread that.</p>



<a name="259118738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259118738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259118738">(Oct 26 2021 at 15:58)</a>:</h4>
<p><span class="user-mention" data-user-id="260325">@Chris Denton</span> did you see <a href="https://github.com/rust-lang/rust/issues/84223">https://github.com/rust-lang/rust/issues/84223</a> ?</p>



<a name="259118833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Static%20thread%20locals/near/259118833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Static.20thread.20locals.html#259118833">(Oct 26 2021 at 15:59)</a>:</h4>
<p>That looks interesting, thanks!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>