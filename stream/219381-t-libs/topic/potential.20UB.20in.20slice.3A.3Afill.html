<html>
<head><meta charset="utf-8"><title>potential UB in slice::fill · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html">potential UB in slice::fill</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248871405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248871405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248871405">(Aug 09 2021 at 16:23)</a>:</h4>
<p>I'm wondering if the optimization here is correct: <a href="https://github.com/rust-lang/rust/blob/ae90dcf0207c57c3034f00b07048d63f8b2363c8/library/core/src/slice/specialize.rs#L22-L28">https://github.com/rust-lang/rust/blob/ae90dcf0207c57c3034f00b07048d63f8b2363c8/library/core/src/slice/specialize.rs#L22-L28</a></p>
<p>Specifically if T is <code>MaybeUninit&lt;u8&gt;</code>. It momentarily transmutes that to an u8 before passing it to <code>write_bytes</code>.</p>



<a name="248872271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872271">(Aug 09 2021 at 16:29)</a>:</h4>
<p>Heh, good point. We may want to use <code>MaybeUninit&lt;u8&gt;</code> here</p>



<a name="248872390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872390">(Aug 09 2021 at 16:30)</a>:</h4>
<p><code>write_bytes</code> wants a <code>u8</code> though.</p>



<a name="248872391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872391">(Aug 09 2021 at 16:30)</a>:</h4>
<p>oh, but then <code>write_bytes</code> can't work <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="248872663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872663">(Aug 09 2021 at 16:32)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">MaybeUninit</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"> </span><span class="mi">10</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error: Undefined Behavior: using uninitialized data, but this operation requires initialized memory
    --&gt; /home/mara/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/intrinsics.rs:2191:14
     |
2191 |     unsafe { write_bytes(dst, val, count) }
     |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ using uninitialized data, but this operation requires initialized memory
     |
     = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior
     = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information
</code></pre></div>



<a name="248872665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872665">(Aug 09 2021 at 16:32)</a>:</h4>
<p>:(</p>



<a name="248872770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872770">(Aug 09 2021 at 16:33)</a>:</h4>
<p>we could add an intrinsic similar to <a href="https://doc.rust-lang.org/core/intrinsics/fn.assert_zero_valid.html">https://doc.rust-lang.org/core/intrinsics/fn.assert_zero_valid.html</a> that returns <code>true</code> instead of panicking, so we can make decisions on that</p>



<a name="248872998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248872998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248872998">(Aug 09 2021 at 16:35)</a>:</h4>
<p>time to make <code>std::panic::catch_unwind(|| assert_zero_valid::&lt;T&gt;()).is_none()</code> a const fn. ;)</p>



<a name="248873113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873113">(Aug 09 2021 at 16:36)</a>:</h4>
<p><span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="248873133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873133">(Aug 09 2021 at 16:36)</a>:</h4>
<p>How do get uninitialized bytes normally get moved around?</p>



<a name="248873173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873173">(Aug 09 2021 at 16:36)</a>:</h4>
<p>what do you mean?</p>



<a name="248873189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873189">(Aug 09 2021 at 16:36)</a>:</h4>
<p>you can move them, you just can't put them into a type that expects to be initialized</p>



<a name="248873264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873264">(Aug 09 2021 at 16:37)</a>:</h4>
<p>yeah, but if you can move them something has to do the moving without blowing up</p>



<a name="248873280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873280">(Aug 09 2021 at 16:37)</a>:</h4>
<p>most of our code around moving things is generic</p>



<a name="248873290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873290">(Aug 09 2021 at 16:37)</a>:</h4>
<p>can write_bytes be taught to do the same?</p>



<a name="248873306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873306">(Aug 09 2021 at 16:37)</a>:</h4>
<p>oh heh</p>



<a name="248873317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873317">(Aug 09 2021 at 16:37)</a>:</h4>
<p>not sure</p>



<a name="248873332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873332">(Aug 09 2021 at 16:37)</a>:</h4>
<p>you'd need a write_bytes that takes a MaybeUninit&lt;u8&gt; instead of a u8</p>



<a name="248873342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873342">(Aug 09 2021 at 16:37)</a>:</h4>
<p>depends on what the underlying LLVM intrinsic is</p>



<a name="248873423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873423">(Aug 09 2021 at 16:38)</a>:</h4>
<p>we can't change the library function, but this is in libcore, we can use intrinsics</p>



<a name="248873431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873431">(Aug 09 2021 at 16:38)</a>:</h4>
<p>but such a write_maybe_uninit_bytes might not have a nice implementation as write_bytes</p>



<a name="248873697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248873697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248873697">(Aug 09 2021 at 16:40)</a>:</h4>
<p>the LLVM docs don't make it clear to me whether the value arg can be undef: <a href="https://llvm.org/docs/LangRef.html#llvm-memset-intrinsics">https://llvm.org/docs/LangRef.html#llvm-memset-intrinsics</a></p>



<a name="248874458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874458">(Aug 09 2021 at 16:46)</a>:</h4>
<p><code>assert_zero_valid</code> also wouldn't be quite the right tool since you could do <code>slice.fill(NonZeroU8::new(1))</code> and ideally that would become a memset.</p>



<a name="248874519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874519">(Aug 09 2021 at 16:46)</a>:</h4>
<p>yeah, not exactly that instrinsic, but something similar that checks that it can't be undef.</p>



<a name="248874707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874707">(Aug 09 2021 at 16:48)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> generally there's no reason uninit cannot be used as a value. But there's also no reason LLVM wouldn't just remove the memset immediately.</p>



<a name="248874742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874742">(Aug 09 2021 at 16:49)</a>:</h4>
<p>that's fine. copying/assigning an uninit MaybeUninit is also a nop</p>



<a name="248874776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874776">(Aug 09 2021 at 16:49)</a>:</h4>
<p>yea, then we can fix our intrinsic</p>



<a name="248874791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874791">(Aug 09 2021 at 16:49)</a>:</h4>
<p>not sure what to do on the libs level, but that seems orthogonal</p>



<a name="248874794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248874794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248874794">(Aug 09 2021 at 16:49)</a>:</h4>
<p>so if that's fine, we should just change the intrinsic signature to take a MaybeUninit&lt;u8&gt;</p>



<a name="248875743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248875743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248875743">(Aug 09 2021 at 16:57)</a>:</h4>
<p>do we need that <code>if size == 1</code> case there at all btw? for e.g. u64 llvm is smart enough to turn that loop in the <code>else</code> branch into a <code>memset</code> too.</p>



<a name="248876870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248876870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BurntSushi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248876870">(Aug 09 2021 at 17:04)</a>:</h4>
<p>i am no expert in this area, but IIRC, i thought that it hadn't been decided whether unitialized <code>u8</code> was UB or not? (of course, reading from it would be, but i had thought it was still an open question as to whether it simply exists would make it insta UB.) i can't find the words i have in my memory, but i thought they were from <span class="user-mention" data-user-id="120791">@RalfJ</span> a while back. (which i could be misrepresenting here.)</p>



<a name="248877005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877005">(Aug 09 2021 at 17:05)</a>:</h4>
<p>i remember that it wasn't entirely decided whether a <code>&amp;mut u8</code> pointing to an uninit u8 is UB, but not sure about <code>u8</code>s by themselves.</p>



<a name="248877080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877080">(Aug 09 2021 at 17:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill/near/248875743">said</a>:</p>
<blockquote>
<p>do we need that <code>if size == 1</code> case there at all btw? for e.g. u64 llvm is smart enough to turn that loop in the <code>else</code> branch into a <code>memset</code> too.</p>
</blockquote>
<p>There was some speculation about it being potentially useful for less optimizing backends, but no concrete answers.</p>



<a name="248877081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877081">(Aug 09 2021 at 17:06)</a>:</h4>
<p>filed this topic as an issue btw: <a href="https://github.com/rust-lang/rust/issues/87891">https://github.com/rust-lang/rust/issues/87891</a></p>



<a name="248877235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BurntSushi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877235">(Aug 09 2021 at 17:07)</a>:</h4>
<p>not sure if this is still the latest thinking on the topic or not: <a href="https://github.com/rust-lang/unsafe-code-guidelines/blob/master/active_discussion/validity.md">https://github.com/rust-lang/unsafe-code-guidelines/blob/master/active_discussion/validity.md</a></p>



<a name="248877287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BurntSushi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877287">(Aug 09 2021 at 17:07)</a>:</h4>
<p>"Integers and floating point types" -&gt; "Do we allow values that contain uninitialized bits?"</p>



<a name="248877346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877346">(Aug 09 2021 at 17:08)</a>:</h4>
<p>and assembly was smaller with this specialization, a few avoided branches. but those would only be significant for short slices</p>



<a name="248877546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877546">(Aug 09 2021 at 17:09)</a>:</h4>
<p>i'd assume that llvm is pretty good at picking the right threshold between an (unrolled) loop and calling memset</p>



<a name="248877828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248877828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248877828">(Aug 09 2021 at 17:11)</a>:</h4>
<p><a href="https://rust.godbolt.org/z/P1ePM7r3W">https://rust.godbolt.org/z/P1ePM7r3W</a></p>



<a name="248878274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878274">(Aug 09 2021 at 17:14)</a>:</h4>
<p>rust 1.50 didn't have the Copy specialization either, so that's not really a good comparison</p>



<a name="248878481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878481">(Aug 09 2021 at 17:16)</a>:</h4>
<p>1.52 has the Copy specialization but not the size==1 specialization, but it has no #[inline] on them, so that doesn't work either.</p>



<a name="248878640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878640">(Aug 09 2021 at 17:16)</a>:</h4>
<p><a href="https://rust.godbolt.org/z/vWrfWvbvE">https://rust.godbolt.org/z/vWrfWvbvE</a></p>



<a name="248878699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878699">(Aug 09 2021 at 17:17)</a>:</h4>
<p>i tried a few different things locally, but so far i haven't found anything where the <code>size == 1</code> case results in better code.</p>



<a name="248878768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878768">(Aug 09 2021 at 17:17)</a>:</h4>
<p>oh nvm, it can only do it if it knows the bytes are constant, d'uh.</p>



<a name="248878769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878769">(Aug 09 2021 at 17:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill/near/248878640">said</a>:</p>
<blockquote>
<p><a href="https://rust.godbolt.org/z/vWrfWvbvE">https://rust.godbolt.org/z/vWrfWvbvE</a></p>
</blockquote>
<p>sure. memset can't write arbitrary u64s. only works if all bytes of it are identical. e.g. 0u64.</p>



<a name="248878782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248878782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248878782">(Aug 09 2021 at 17:17)</a>:</h4>
<p>yeah</p>



<a name="248879038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248879038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248879038">(Aug 09 2021 at 17:19)</a>:</h4>
<p>it produces one extra jump with a fixed u64</p>



<a name="248879329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248879329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248879329">(Aug 09 2021 at 17:21)</a>:</h4>
<p>to avoid it for zero sized slices. depends on the situation whether that's a good or bad thing</p>



<a name="248879606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248879606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248879606">(Aug 09 2021 at 17:23)</a>:</h4>
<p>(if you change it to a <code>&amp;mut [u64; 200]</code> it disappears)</p>



<a name="248907743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248907743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248907743">(Aug 09 2021 at 21:03)</a>:</h4>
<p>refresher: <code>&amp;mut T</code> must point to a valid <code>T</code>, absolutely, but since <code>u8</code> <em>might</em> be valid when uninit (this is the part that isn't decided).</p>
<p>If <code>u8</code> is valid when uninit, then <code>&amp;mut u8</code> can point at an uninit u8 and still be valid.</p>



<a name="248982660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/248982660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#248982660">(Aug 10 2021 at 14:01)</a>:</h4>
<blockquote>
<p>&amp;mut T must point to a valid T, absolutely,</p>
</blockquote>
<p>I mean this rule is still something I want to abolish ;) and Miri doesn't implement it -- but it's what we currently document since it is the most conservative choice</p>



<a name="249002865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249002865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249002865">(Aug 10 2021 at 16:35)</a>:</h4>
<p>ralf pulling the rug out from under me yet again.</p>
<p>though if i remember my llvm ir lore properly then it would seem to make sense to relax that rule.</p>



<a name="249121156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249121156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249121156">(Aug 11 2021 at 15:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill/near/248907743">said</a>:</p>
<blockquote>
<p>refresher: <code>&amp;mut T</code> must point to a valid <code>T</code>, absolutely, but <code>u8</code> <em>might</em> be valid when uninit (this is the part that isn't decided).</p>
<p>If <code>u8</code> is valid when uninit, then <code>&amp;mut u8</code> can point at an uninit u8 and still be valid.</p>
</blockquote>
<p>that's just not true. right now an uninit <code>u8</code> is not okay, but we do use &amp;mut's to uninit data in some parts of std::io right now, which is 'okay'*-ish. (e.g. <a href="https://doc.rust-lang.org/stable/std/io/struct.Initializer.html#method.initialize">this</a>)</p>



<a name="249122552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249122552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249122552">(Aug 11 2021 at 15:16)</a>:</h4>
<p>the validity of integers is still an open question, the topic is here: <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/71">https://github.com/rust-lang/unsafe-code-guidelines/issues/71</a></p>
<p>As to the other part, Ralf covered that.</p>



<a name="249130937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249130937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249130937">(Aug 11 2021 at 16:16)</a>:</h4>
<p>it might be an open question as to whether to relax it, but right now it causes UB and/or angry miri. that's not the case for the <code>&amp;mut</code> thing.</p>



<a name="249139796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249139796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249139796">(Aug 11 2021 at 17:23)</a>:</h4>
<p>yes, that's what Ralf said.</p>



<a name="249159691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249159691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249159691">(Aug 11 2021 at 19:44)</a>:</h4>
<p>in the mean time we can just adjust the intrinsic until we know more</p>



<a name="249340237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249340237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249340237">(Aug 13 2021 at 09:37)</a>:</h4>
<blockquote>
<p>ralf pulling the rug out from under me yet again.</p>
</blockquote>
<p>sorry. :/ but I think I've been very consistent in my stanza on reference validity for several years now</p>



<a name="249340412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249340412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249340412">(Aug 13 2021 at 09:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill/near/249121156">said</a>:</p>
<blockquote>
<p>that's just not true. right now an uninit <code>u8</code> is not okay, but we do use &amp;mut's to uninit data in some parts of std::io right now, which is 'okay'*-ish. (e.g. <a href="https://doc.rust-lang.org/stable/std/io/struct.Initializer.html#method.initialize">this</a>)</p>
</blockquote>
<p>libstd is using privileged compiler knowledge here. this is explicitly violating the rules we currently have in the reference.</p>
<p>under the rules as I think they should be, this would not be UB, but it's still unsafe to give uninit <code>u8</code> to unknown code implementing the <code>Write</code> trait, so this libstd API is doomed anyway (and a better replacement has already been RFCd)</p>



<a name="249340503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249340503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249340503">(Aug 13 2021 at 09:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill/near/249130937">said</a>:</p>
<blockquote>
<p>it might be an open question as to whether to relax it, but right now it causes UB and/or angry miri. that's not the case for the <code>&amp;mut</code> thing.</p>
</blockquote>
<p>creating uninit <code>u8</code> doesnt cause angry miri. only actually using it for arithmetic does.<br>
so this is UB according to the reference but Miri currently does not complain (but I plan to add a flag to make it complain):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">().</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="249340580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249340580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249340580">(Aug 13 2021 at 09:41)</a>:</h4>
<p>so a big part of the problem in the above discussion is that saying "is not okay" is very ambiguous. do you mean okay wrt</p>
<ul>
<li>the rules as written in the reference</li>
<li>the rules as implemented in Miri</li>
<li>the rules as actually exploited by the compiler</li>
<li>the rules as I think they should be</li>
</ul>
<p>(and this is all just about UB; soundness adds another layer of questions)</p>



<a name="249340967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249340967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249340967">(Aug 13 2021 at 09:46)</a>:</h4>
<p>this code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">().</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>is okay according to what is implemented in Miri or exploited by the compiler,<br>
but not okay according to the reference or according to how I think the rules should be.</p>



<a name="249341095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249341095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249341095">(Aug 13 2021 at 09:48)</a>:</h4>
<p>this code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">xref</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">assume_init_mut</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>is okay according to what is implemented in Miri, exploited by the compiler, and how I think the rules should be;<br>
but not okay according to the reference.</p>



<a name="249341154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249341154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249341154">(Aug 13 2021 at 09:49)</a>:</h4>
<p>this code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">xref</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">assume_init_mut</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>is okay according to what is implemented in Miri, or exploited by the compiler;<br>
but not okay according to the reference or how I think the rules should be.</p>



<a name="249367779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249367779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249367779">(Aug 13 2021 at 14:34)</a>:</h4>
<p>that almost needs a state of the undefined union table</p>



<a name="249369573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249369573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249369573">(Aug 13 2021 at 14:48)</a>:</h4>
<p>Yeah I wasn't aware that the documented rules here were out of sync.</p>
<p>Doesn't have to be a grand essay, but some bullet points would probably be good.</p>



<a name="249458862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/potential%20UB%20in%20slice%3A%3Afill/near/249458862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/potential.20UB.20in.20slice.3A.3Afill.html#249458862">(Aug 14 2021 at 13:00)</a>:</h4>
<p>yeah this UCG validity thing is dragging on longer than I anticipated</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>