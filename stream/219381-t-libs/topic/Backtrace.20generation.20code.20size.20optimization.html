<html>
<head><meta charset="utf-8"><title>Backtrace generation code size optimization · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html">Backtrace generation code size optimization</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251186892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251186892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251186892">(Aug 30 2021 at 05:59)</a>:</h4>
<p>I'm interested in making the backtrace code that powers RUST_BACKTRACE smaller. Before I get too deep, has anyone else worked on this?</p>



<a name="251190406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251190406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pachi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251190406">(Aug 30 2021 at 06:56)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock</span> have a look also to the <a class="stream" data-stream-id="257204" href="/#narrow/stream/257204-project-error-handling">#project-error-handling</a> group streams. They are working also on backtraces, trying to move it to core IIRC, and may have additional information if you ping them.</p>



<a name="251203424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251203424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pachi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251203424">(Aug 30 2021 at 09:20)</a>:</h4>
<p>This is the issue they're tracking: <a href="https://github.com/rust-lang/rfcs/pull/3156">https://github.com/rust-lang/rfcs/pull/3156</a></p>



<a name="251268649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251268649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251268649">(Aug 30 2021 at 18:03)</a>:</h4>
<p>we've not done any work on backtrace code size</p>



<a name="251268689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251268689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251268689">(Aug 30 2021 at 18:03)</a>:</h4>
<p>though much of the work we've done will certainly have an impact</p>



<a name="251268747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251268747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251268747">(Aug 30 2021 at 18:03)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock</span> I'd be happy to talk to you about the changes you'd like to make and all of the changes we're actively considering</p>



<a name="251295905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251295905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251295905">(Aug 30 2021 at 21:12)</a>:</h4>
<p>Thanks for the offer <span class="user-mention" data-user-id="220273">@Jane Lusby</span> <br>
It sounds like the changes under discussion are all about what API should be provided, and what embedded developers would do with backtrace support. I'm interested in making an stripped executable from an empty fn main on x86_64-unknown-linux-gnu smaller than 252 kB. I expect I'll be fiddling mostly in <code>gimli</code> and <code>addr2line</code>, so as long as the the error handling project group isn't going to rewrite the existing backtrace implementations I shouldn't be impacted much by your work.</p>



<a name="251296002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251296002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251296002">(Aug 30 2021 at 21:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock</span> <a href="#narrow/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization/near/251295905">said</a>:</p>
<blockquote>
<p>Thanks for the offer <span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <br>
It sounds like the changes under discussion are all about what API should be provided, and what embedded developers would do with backtrace support. I'm interested in making an stripped executable from an empty fn main on x86_64-unknown-linux-gnu smaller than 252 kB. I expect I'll be fiddling mostly in <code>gimli</code> and <code>addr2line</code>, so as long as the the error handling project group isn't going to rewrite the existing backtrace implementations I shouldn't be impacted much by your work.</p>
</blockquote>
<p>is your stripped executable going to link <code>std</code>?</p>



<a name="251296139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251296139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251296139">(Aug 30 2021 at 21:14)</a>:</h4>
<p>actually either way it probably doesn't matter</p>



<a name="251330413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251330413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251330413">(Aug 31 2021 at 04:31)</a>:</h4>
<p>See <a href="https://github.com/Amanieu/mini-backtrace">https://github.com/Amanieu/mini-backtrace</a> for a very stripped-down backtrace implementation. It just outputs a code address for each frame, all the post-processing for resolving the backtrace to a symbol &amp; line number is done off-line with <code>addr2line</code>.</p>



<a name="251382844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Backtrace%20generation%20code%20size%20optimization/near/251382844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Backtrace.20generation.20code.20size.20optimization.html#251382844">(Aug 31 2021 at 13:19)</a>:</h4>
<p>Well, if the goal is for code size and only address is needed probably it's easier to use _Unwind_Backtrace: <a href="https://github.com/nbdd0121/unwind/blob/41e805c1cfa1e0a853007e670491448e458c15e3/src/panic_handler.rs#L58-L77">https://github.com/nbdd0121/unwind/blob/41e805c1cfa1e0a853007e670491448e458c15e3/src/panic_handler.rs#L58-L77</a></p>
<p>Because you can dynamically link to libgcc_s.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>