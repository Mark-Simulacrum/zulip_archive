<html>
<head><meta charset="utf-8"><title>Can we stabilize `Box::new_uninit` &amp; friends? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html">Can we stabilize `Box::new_uninit` &amp; friends?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270531880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270531880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270531880">(Feb 03 2022 at 11:06)</a>:</h4>
<p>The whole "how do I build something on heap without putting it on stack first" thing <a href="https://users.rust-lang.org/t/construct-a-box-i32-32-32-32-without-hitting-stack/71214?u=scottmcm">came up on URLO</a>.</p>
<p>It looks like it's been a couple years; could we at least stabilize <code>Box::new_uninit</code> and <code>Box::new_zeroed</code> and <code>Box::assume_init</code>?</p>
<p>I could make a PR for a subset, if that would help.</p>
<p>Tracking issue: <a href="https://github.com/rust-lang/rust/issues/63291">https://github.com/rust-lang/rust/issues/63291</a></p>



<a name="270553958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270553958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270553958">(Feb 03 2022 at 14:06)</a>:</h4>
<p>A personal clarification: I think the ones for box can and ought to be stabilized; but I don't think the ones for <code>{A,}Rc</code> necessarily should, because the whole non-guaranteed <code>&amp;mut</code> access in there is annoying; I'd personally like to see something like <span class="user-mention" data-user-id="132829">@Christopher Durham</span>'s <a href="https://docs.rs/rc-box">https://docs.rs/rc-box</a> be featured so that we could avoid the <code>rc.get_mut().unwrap()</code> dance before the call to <code>.write()</code>.</p>



<a name="270554904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270554904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270554904">(Feb 03 2022 at 14:14)</a>:</h4>
<p>I can't find it right now, but there was a PR a while back to add a <code>RcAlloc</code> so you could make <code>Box&lt;T, RcAlloc&gt;</code> and then convert that into <code>Rc&lt;T&gt;</code> without reallocating. (<code>RcAlloc</code> wraps another <code>Alloc</code> and wraps the allocation in the space for <code>RcInner</code>.)<br>
Thinking long-term, that feels like the better solution, as it doesn't require mirroring ~all of the <code>Box</code> APIs into two new types for "has space for no-realloc recounting". But it also blocks on alloc/storage APIs, so... though if the intent is primarily to avoid blowing the stack, a copy from <code>Box</code> to <code>Rc</code> isn't going to blow the stack, it'll just be a giant copy.</p>



<a name="270554942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270554942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270554942">(Feb 03 2022 at 14:14)</a>:</h4>
<p>I am <em>slightly</em> unhappy about the combinations of new methods. <a href="https://github.com/rust-lang/wg-allocators/issues/90">https://github.com/rust-lang/wg-allocators/issues/90</a></p>



<a name="270555367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270555367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270555367">(Feb 03 2022 at 14:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> That's a nice suggestion as well, and thus, <em>imho</em>, a quite legitimate argument not to stabilize yet; I haven't read all the comments in the tracking issue, <span class="user-mention" data-user-id="330154">@The 8472</span>: did you mention this builder pattern idea there?</p>



<a name="270555461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270555461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270555461">(Feb 03 2022 at 14:18)</a>:</h4>
<p>No, I haven't</p>



<a name="270555601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270555601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270555601">(Feb 03 2022 at 14:19)</a>:</h4>
<p>Found the PR: <a href="https://github.com/rust-lang/rust/pull/84338">https://github.com/rust-lang/rust/pull/84338</a><br>
It wasn't landed because it was a significant compile time regression on code using <code>Rc</code> due to LLVM spending more time optimizing.</p>



<a name="270556417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270556417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270556417">(Feb 03 2022 at 14:25)</a>:</h4>
<p>In <a href="https://github.com/rust-lang/rust/issues/87777">#87777</a> I added <code>try_new_zeroed_slice</code> and <code>try_new_uninit_slice</code> labeled them as #[unstable] issue <a href="https://github.com/rust-lang/rust/issues/32838">#32838</a><br>
Should they be changed to <a href="https://github.com/rust-lang/rust/issues/63291">#63291</a> too?</p>



<a name="270556798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270556798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270556798">(Feb 03 2022 at 14:27)</a>:</h4>
<p>Hrm, no, all the <code>try_</code> variants are tracked as <a href="https://github.com/rust-lang/rust/issues/32838">#32838</a>. Still, there's some overlap.</p>



<a name="270613356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270613356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270613356">(Feb 03 2022 at 20:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F/near/270554942">said</a>:</p>
<blockquote>
<p>I am <em>slightly</em> unhappy about the combinations of new methods. <a href="https://github.com/rust-lang/wg-allocators/issues/90">https://github.com/rust-lang/wg-allocators/issues/90</a></p>
</blockquote>
<p>I cant help but pattern match combinatorial explosions of methods like this, always feels like a sign that APIs in question are modeling effects</p>



<a name="270861309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Can%20we%20stabilize%20%60Box%3A%3Anew_uninit%60%20%26%20friends%3F/near/270861309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Can.20we.20stabilize.20.60Box.3A.3Anew_uninit.60.20.26.20friends.3F.html#270861309">(Feb 06 2022 at 01:50)</a>:</h4>
<p>I touched on this here <a href="https://github.com/rust-lang/rust/pull/93653#issuecomment-1030733043">https://github.com/rust-lang/rust/pull/93653#issuecomment-1030733043</a> and ended up nominating that PR, but we can shuffle the nomination elsewhere (the PR itself is "OK", just worried about letting this continue)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>