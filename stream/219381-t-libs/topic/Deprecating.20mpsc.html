<html>
<head><meta charset="utf-8"><title>Deprecating mpsc · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html">Deprecating mpsc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267531370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267531370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267531370">(Jan 11 2022 at 03:06)</a>:</h4>
<p>I just ran into some folks on Reddit who had no idea that mpsc had issues, and were happily using it without any knowledge of that.</p>



<a name="267531390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267531390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267531390">(Jan 11 2022 at 03:07)</a>:</h4>
<p>What would be the blocker for attaching a <code>deprecated</code> to mpsc, or at least a <code>deprecated_future</code>?</p>



<a name="267531670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267531670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267531670">(Jan 11 2022 at 03:12)</a>:</h4>
<p>I also had no idea that mpsc has issues; what issues are there?</p>



<a name="267531715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267531715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267531715">(Jan 11 2022 at 03:12)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/39364">https://github.com/rust-lang/rust/issues/39364</a></p>



<a name="267531788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267531788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267531788">(Jan 11 2022 at 03:13)</a>:</h4>
<p>It has a <a href="https://doc.rust-lang.org/book/ch16-02-message-passing.html">whole chapter</a> in The Book, which seems misleading if it's not supposed to be used</p>



<a name="267532016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267532016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267532016">(Jan 11 2022 at 03:16)</a>:</h4>
<p>I agree entirely!</p>



<a name="267532385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267532385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267532385">(Jan 11 2022 at 03:23)</a>:</h4>
<p>Here's the subthread where this came up: <a href="https://www.reddit.com/r/rust/comments/rz8fjv/how_to_push_an_err_condition_to_mpscchannelstring/hrvg3nj/">https://www.reddit.com/r/rust/comments/rz8fjv/how_to_push_an_err_condition_to_mpscchannelstring/hrvg3nj/</a></p>



<a name="267539889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267539889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267539889">(Jan 11 2022 at 06:01)</a>:</h4>
<p>if the current mspc is deprecated, then the need to bring one of the <a href="http://crates.io">crates.io</a> alternatives into std would greatly increase. I have no opinion on exactly which one, but std needs to offer <em>some</em> version of this.</p>



<a name="267547835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267547835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267547835">(Jan 11 2022 at 08:00)</a>:</h4>
<p>I mean, if it's broken, then there's a significant need to do that now. Deprecating would just formalize that, wouldn't it?</p>



<a name="267547897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267547897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267547897">(Jan 11 2022 at 08:00)</a>:</h4>
<p>Isn't it sufficient to deprecate <code>recv_timeout()</code>?</p>



<a name="267575420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267575420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BurntSushi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267575420">(Jan 11 2022 at 12:45)</a>:</h4>
<p>personally, i'm not quite sold on deprecating it. how much has the "replace it with a trivially correct, but perhaps not fastest, implementation" been explored? i think i would like that better instead of just completely declaring defeat.</p>



<a name="267594729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267594729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267594729">(Jan 11 2022 at 15:09)</a>:</h4>
<p>There have been discussions in several libs meetings, replacing it with a trivial implementation or wrapping an existing crate (which likely would have to be moved into the rust-lang org) were options. I don't recall if any consensus was reached.</p>



<a name="267605744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267605744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267605744">(Jan 11 2022 at 16:21)</a>:</h4>
<p>if someone wants to fix the mpsc implementation, that effort would be very welcome. but no one seems to have the time and expertise to do that</p>



<a name="267608069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267608069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267608069">(Jan 11 2022 at 16:35)</a>:</h4>
<p>I believe there is a consensus on just importing flume into the standard library, it's just that nobody has gotten around to it yet.</p>



<a name="267608324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267608324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267608324">(Jan 11 2022 at 16:37)</a>:</h4>
<p>flume has quite a few dependencies though, making that tricky. but maybe just taking the relevant parts could work, if the flume authors are happy with that.</p>



<a name="267608805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267608805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267608805">(Jan 11 2022 at 16:40)</a>:</h4>
<p>Isn't it just <code>spin</code>? Everything else seems to be a dev dependency or optional.</p>



<a name="267615706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267615706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267615706">(Jan 11 2022 at 17:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/Deprecating.20mpsc/near/267539889">said</a>:</p>
<blockquote>
<p>std needs to offer <em>some</em> version of this.</p>
</blockquote>
<p>It's not completely obvious to me that, if we <em>didn't</em> have <code>mpsc</code> already, we'd <em>need</em> to add something like this rather than refer to <a href="http://crates.io">crates.io</a>.</p>



<a name="267615802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267615802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267615802">(Jan 11 2022 at 17:27)</a>:</h4>
<p>Regarding flume: my understanding was that the hardest part would be making flume fully <code>no_std</code> so that it could build without circular dependencies on <code>std</code>.</p>



<a name="267616145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267616145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267616145">(Jan 11 2022 at 17:30)</a>:</h4>
<p>flume can't be <code>no_std</code> because it needs to block, access to time, etc. The only way to integrate it into std is by copying the code over and adapting it.</p>



<a name="267616292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267616292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267616292">(Jan 11 2022 at 17:31)</a>:</h4>
<p>That seems...unfortunate, especially if we're not going to adopt and expose its full feature set, and thus it would still need to exist as a standalone crate as well.</p>



<a name="267616442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267616442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267616442">(Jan 11 2022 at 17:32)</a>:</h4>
<p>maybe we could use the same hacks that were used for stdsimd? <code>#[path]</code> + submodule?</p>



<a name="267616476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267616476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267616476">(Jan 11 2022 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="222471">BurntSushi</span> <a href="#narrow/stream/219381-t-libs/topic/Deprecating.20mpsc/near/267575420">said</a>:</p>
<blockquote>
<p>personally, i'm not quite sold on deprecating it. how much has the "replace it with a trivially correct, but perhaps not fastest, implementation" been explored? i think i would like that better instead of just completely declaring defeat.</p>
</blockquote>
<p>My impression is that people are supportive of doing that, but someone would actually have to write that new implementation.</p>



<a name="267645419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267645419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267645419">(Jan 11 2022 at 21:10)</a>:</h4>
<p>I used Flume for a while and kind of think it needs a few fixes. It uses spinlocks rather than OS mutexes on unix (which has no business in the standard library). I've had some surprising behavior (rare deadlocks which for the most part I never was able to reproduce particularly frequently; or at least the one case where I was able to repro it got fixed). That is: IMO we should be careful of replacing std::sync::mpsc with something that brings its own set of problems, given that mpsc has gotten so much more production testing.</p>
<p>Another note is: I would be cautious of the performance claims, the benchmarks it has are... not comprehensive (mostly benchmarking large numbers of threads all using the same channel and similar cases — real applications have many threads doing other things and such). Anecdotally, I ended up seeing an improvement when I went back to the std channels several months ago, although at the time I had convinced myself that the bugs weren't there anymore or were overblown (which seems to have been delusional <span aria-label="scream cat" class="emoji emoji-1f640" role="img" title="scream cat">:scream_cat:</span>), but that could have just been my usage pattern.</p>
<p>But to be clear: I don't think worse perf is a dealbreaker, just that I'd caution against using performance numbers to justify a switch without further testing, and I expect that if we do switch, it may need various changes and improvements to get "up to snuff" as it were.</p>



<a name="267727345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267727345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267727345">(Jan 12 2022 at 13:58)</a>:</h4>
<p>How "perhaps not fastest" is likely to be accepted?  Like, if I rewrite the implementation to use Arc&lt;Mutex&lt;VecDeque&lt;T&gt;&gt;&gt; would that be preferable to the current implementation?</p>



<a name="267727848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267727848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BurntSushi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267727848">(Jan 12 2022 at 14:01)</a>:</h4>
<p><span class="user-mention" data-user-id="306504">@Tavian Barnes</span> i'm personally fine with that. i think the "just use a mutex" solution is likely good enough for a lot of cases.</p>



<a name="267728618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267728618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267728618">(Jan 12 2022 at 14:06)</a>:</h4>
<p>Cool.  No promises, but if I get time I'll try to PR that</p>



<a name="267728668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267728668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267728668">(Jan 12 2022 at 14:07)</a>:</h4>
<p><span class="user-mention" data-user-id="306504">@Tavian Barnes</span> Isn't that what flume uses internally?</p>



<a name="267728849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267728849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267728849">(Jan 12 2022 at 14:08)</a>:</h4>
<p>After staring at mpsc for an hour now as an outsider, naively thinking "how hard can it be to fix this particular issue", I have to say I am stumped by the stupendous complexity of the current implementation.</p>



<a name="267729624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267729624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267729624">(Jan 12 2022 at 14:14)</a>:</h4>
<p><span class="user-mention" data-user-id="327095">@Urgau</span> Basically yeah, I didn't realize that.  It uses spinlocks instead of mutexes though on some platforms.</p>



<a name="267729755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267729755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267729755">(Jan 12 2022 at 14:15)</a>:</h4>
<p>I suppose the use of spinlocks is when there are no Mutex implementation for that platform ?</p>



<a name="267730244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267730244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267730244">(Jan 12 2022 at 14:19)</a>:</h4>
<p>The "simplest" thing to do might be to try copy/paste flume into the standard library (like suggested before) instead of trying to redo a complete implementation from scratch .</p>



<a name="267731129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267731129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267731129">(Jan 12 2022 at 14:25)</a>:</h4>
<p>Hm, flume seems to have recently made using an internal spinlock an optional feature: <a href="https://github.com/zesterer/flume/commit/de20ddf5476e6e5816e6db9765775752f86603ee">https://github.com/zesterer/flume/commit/de20ddf5476e6e5816e6db9765775752f86603ee</a></p>



<a name="267822932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267822932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267822932">(Jan 13 2022 at 04:34)</a>:</h4>
<blockquote>
<p>I suppose the use of spinlocks is when there are no Mutex implementation for that platform ?</p>
</blockquote>
<p>At the time it on all unix, because pthread_mutex_t was apparently too slow (which might be true, but the nature of things is that for various reasons spinning will almost always look better in microbenchmarks, but do worse in real code). That said, I'm happy to see they've fixed that, I should have looked.</p>



<a name="267825108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267825108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267825108">(Jan 13 2022 at 05:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="407656">Hans Kratz</span> <a href="#narrow/stream/219381-t-libs/topic/Deprecating.20mpsc/near/267728849">said</a>:</p>
<blockquote>
<p>After staring at mpsc for an hour now as an outsider, naively thinking "how hard can it be to fix this particular issue", I have to say I am stumped by the stupendous complexity of the current implementation.</p>
</blockquote>
<p>The current implementation has reasonably good docs, but is complicated by a lot of things:</p>
<ol>
<li>
<p>The fact that it's several implementations (oneshot, spsc, mpsc) that get switched between based on usage</p>
<p>- starts as oneshot, upgrades to SPSC on 2nd send. either oneshot/spsc upgrae to spsc when the producer is cloned.</p>
</li>
<li>
<p>The queue algorithms it uses don't all have the delivery ordering guarantees we need, e.g. the MPSC has an edge case where a later item can be delivered first, which it has to detect and work around.</p>
</li>
<li>Use of pools to avoid allocation overhead on each send, but the pools are also complicated because they need to maintain a fixed maximum.</li>
<li>Being structured in such a way as to support several legacy features (select, the pre-1.0 green thread runtime, ...), which it doesn't support, but you can still feel their impact in how the code is organized.</li>
<li>Probably other stuff. A lot of algorithms in the wild or in literature don't need to detect sender disconnection, for example. Not that I think it's really a factor.</li>
</ol>
<p>I actually do think we could fix the current implementation, but it would start by cutting at these optimizations (upgrade logic and pooling are most suspect IMO). It would also probably require a reliable case that triggers it, which IDK if I've seen.</p>
<p>Anyway, I think we should just use another impl that's more obviously correct even if it's slower. I'm really not generally in favor of subpar things in the stdlib, but... this one has a bad name which reflects its limitations (mpsc),  I think/hope it will be easier to implement a good queue in the future (when the situation with the other less-than-ideal parts of std::sync are more resolved), at which point we can deprecate it for real and move to a better implementation (or implementations — IMO we really should not repeat the auto-upgrade mistake when it would be easy for us to enforce correct usage in the type system).</p>



<a name="267825404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267825404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267825404">(Jan 13 2022 at 05:21)</a>:</h4>
<p>Devils advocate being that "add more mutexes" is only becoming less and less reasonable for a core concurrency primitive, so perhaps deprecating it and pointing people in the direction of something more scalable would be better.</p>
<p>But I probably don't really believe this (a better queue will not really save a program thats bottlenecked on a single channel). And the <code>sync_channel</code> already does just use a Mutex, IIRC.</p>



<a name="267833779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267833779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267833779">(Jan 13 2022 at 07:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/Deprecating.20mpsc/near/267825108">said</a>:</p>
<blockquote>
<p>I actually do think we could fix the current implementation, but it would start by cutting at these optimizations (upgrade logic and pooling are most suspect IMO). It would also probably require a reliable case that triggers it, which IDK if I've seen.</p>
</blockquote>
<p>We do have a deterministic reproducer (see <a href="https://github.com/rust-lang/rust/issues/39364#issuecomment-1009737562">this comment</a>) in issue <a href="https://github.com/rust-lang/rust/issues/39364">#39364</a>. The problem is that the current oneshot/stream -&gt; shared upgrade is implemented without waking up a currently waiting receiver. This was written under the assumption that the receiver only wakes if there is data in the channel. That is obviously not true for <code>recv_timeout()</code>. Like others in the issue comments I have locally fixed the one problem that oberien described, namely that the waiter is not properly deregistered on the new shared channel in the timeout case, but fixing that is not enough - the <code>cnt</code> and <code>steals</code> values are also wrong in the timeout case and trigger assertions.</p>
<p>Even if that is fixed it is likely that more issues are lurking - e.g. this panic described in  <a href="https://github.com/rust-lang/rust/issues/39364#issuecomment-438861408">this comment</a> or the ones found after an attempted fix (see <a href="https://github.com/rust-lang/rust/issues/39364#issuecomment-529654951">this comment</a>).</p>



<a name="267834968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267834968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267834968">(Jan 13 2022 at 08:03)</a>:</h4>
<p>Note that the original author (<span class="user-mention" data-user-id="116015">@Alex Crichton</span>) has explicitly encouraged us to throw the existing code away and replace it with something simpler.</p>



<a name="267841693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267841693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267841693">(Jan 13 2022 at 09:15)</a>:</h4>
<p>I realise this is a deep discussion and I'm an outsider (and don't even understand the motivating issue fully), but my 2c anyway: deprecating or even changing such an important and widely used item would be a huge thing to do. If y'all do it, it must be properly communicated and telegraphed to the community. Just sticking a deprecated attribute in the code would be a disaster. I would expect a loudly promoted blog post, some public discussion, possibly an RFC, and extensive documentation changes, and even that might not be enough.</p>



<a name="267841907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267841907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267841907">(Jan 13 2022 at 09:17)</a>:</h4>
<p>More importantly I don't think you should even consider the question of 'should we deprecate mpsc?' in isolation. There should be a vision/plan for the long-term future of the concurrency primitives and you should work backwards from that to what should be done now for this particular channel</p>



<a name="267856506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267856506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267856506">(Jan 13 2022 at 11:35)</a>:</h4>
<p>i agree the switching behaviour is something we could get rid of. we could have a separate OneShotChannel or something, and then not support a specific oneshot mode for the mpsc channel</p>



<a name="267858654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267858654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267858654">(Jan 13 2022 at 11:58)</a>:</h4>
<blockquote>
<p>But I probably don't really believe this (a better queue will not really save a program thats bottlenecked on a single channel). </p>
</blockquote>
<p>This isn't just a matter of throughput. The producers could also suffer latency when they're contending on the submission side which could be much lower with a lockless queue.</p>



<a name="267896443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267896443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267896443">(Jan 13 2022 at 16:49)</a>:</h4>
<p>Just throwing it out there, I think deprecating <code>sync::mpsc</code> and pulling in crossbeam-channel as <code>sync::mpmc</code> would be a welcome change. I've run into needing <code>Sender</code> and <code>Receiver</code> to both be <code>Sync</code> on almost every project I've worked on involving channels. While crossbeam-channel is a large complicated crate in it's own right, it's heavily user tested,  has no know bugs (<a href="https://github.com/crossbeam-rs/crossbeam/issues?q=is%3Aissue+is%3Aopen+label%3Abug">as far as I can tell</a>), zero required dependencies, and is <em>very</em> well documented. I understand skepticism about pulling such a large dependency into the standard library, but it's worth considering.</p>



<a name="267900088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267900088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267900088">(Jan 13 2022 at 17:12)</a>:</h4>
<p>crossbeam doesn't optimize for the oneshot case <a href="https://github.com/crossbeam-rs/crossbeam/issues/199">(#199)</a>; all channels use fixed flavors decided on creation, without having to handle upgrades.</p>



<a name="267902719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267902719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267902719">(Jan 13 2022 at 17:30)</a>:</h4>
<p><code>crossbeam-channel</code> also requires <code>crossbeam-utils</code>, which in turn requires <code>lazy_static</code></p>



<a name="267902813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267902813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267902813">(Jan 13 2022 at 17:30)</a>:</h4>
<p>but maybe those could be worked around or removed if we inlined and stripped unused stuff</p>



<a name="267903352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267903352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267903352">(Jan 13 2022 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/219381-t-libs/topic/Deprecating.20mpsc/near/267902719">said</a>:</p>
<blockquote>
<p><code>crossbeam-channel</code> also requires <code>crossbeam-utils</code>, which in turn requires <code>lazy_static</code></p>
</blockquote>
<p>Ah, I thought that was an optional dependency, but it looks like it's effectively required.</p>



<a name="267903708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267903708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267903708">(Jan 13 2022 at 17:36)</a>:</h4>
<p>It looks like it's needed only for <code>Backoff</code>, <code>CachePadded</code>, and <code>AtomicCell</code>. The first two are easily inline, the latter might take some more work.</p>



<a name="267903817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267903817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267903817">(Jan 13 2022 at 17:37)</a>:</h4>
<p>Could <code>AtomicCell&lt;Instant&gt;</code> be packed into an <code>AtomicUsize</code>?</p>



<a name="267904281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267904281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267904281">(Jan 13 2022 at 17:41)</a>:</h4>
<p>Maybe not, I suppose it could be replaced with a mutex. <code>AtomicCell</code> is difficult to inline because it's behavior is different on different architectures.</p>



<a name="267904523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267904523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267904523">(Jan 13 2022 at 17:42)</a>:</h4>
<p>Ah actually, it's only used for the <code>tick</code> channel, I don't think std would need it.</p>



<a name="267905403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267905403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267905403">(Jan 13 2022 at 17:49)</a>:</h4>
<p>For the parts we would need, crossbeam-channel is ~750 lines less than the current implementation.</p>



<a name="267905861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267905861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267905861">(Jan 13 2022 at 17:52)</a>:</h4>
<p>As a first step, the implementation for mpsc could be replaced with crossbeam-channel with no breaking changes, and <code>sync::mpmc</code> could be exposed later.</p>



<a name="267908269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267908269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267908269">(Jan 13 2022 at 18:10)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> if you're keen, this sounds like a worthwhile experimental PR, at least</p>



<a name="267908364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267908364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267908364">(Jan 13 2022 at 18:11)</a>:</h4>
<p>Sure, I was wondering if a PR would help get the ball rolling, or if it would make more sense for T-libs to make a decision first.</p>



<a name="267908527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267908527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267908527">(Jan 13 2022 at 18:12)</a>:</h4>
<p>IMO, we could use a spur into action, showing that this is actually feasible</p>



<a name="267971836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267971836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267971836">(Jan 14 2022 at 04:43)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> To confirm, are you proposing to copy-paste crossbeam-channel into the standard library, or modify the standard library to depend on it?</p>



<a name="267971915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267971915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267971915">(Jan 14 2022 at 04:45)</a>:</h4>
<p>Separate from that: for the purposes of copying a known-working implementation, this probably doesn't matter very much, but if we intend to continue evolving the result as something people are actively using, I'd love to base it on something that supports async.</p>



<a name="267971981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267971981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267971981">(Jan 14 2022 at 04:47)</a>:</h4>
<p>I regularly use channels where one end is sync and the other is async, and while I think for a first pass we should just transparently replace mpsc, if we're actually replacing it with a reasonable implementation I hope we one day have async methods as well.</p>



<a name="267974265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267974265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267974265">(Jan 14 2022 at 05:30)</a>:</h4>
<p>I can't imagine that anything with as many choices as channels (sync vs async, for example) would ever get added to <code>std</code> today if it were new.  So I really like the "discourage the std's one use, remove the complicated bits from the implementation, and let people use a crate" solution.</p>



<a name="267977370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267977370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267977370">(Jan 14 2022 at 06:42)</a>:</h4>
<p>Whether we do or do not decide to expand the channel capability in <code>std</code> eventually, I don't think the current replacement plan needs to foresee that.</p>



<a name="267977434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/267977434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#267977434">(Jan 14 2022 at 06:44)</a>:</h4>
<p>As long as we're keeping the API facade, it just needs to improve the current situation. If it gets ripped out again later and replaced with something even more flexible, that will be fine too.</p>



<a name="268013286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/268013286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#268013286">(Jan 14 2022 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Both would work, but modifying the standard-library to depend on it would probably be more work.</p>



<a name="268013343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/268013343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#268013343">(Jan 14 2022 at 13:31)</a>:</h4>
<p>I agree that the focus right now should be on fixing an existing problem, and new functionality can be added later.</p>



<a name="268013373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/268013373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#268013373">(Jan 14 2022 at 13:31)</a>:</h4>
<p>Sync/Async API split in std is still an open question.</p>



<a name="268013930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/268013930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#268013930">(Jan 14 2022 at 13:36)</a>:</h4>
<p>Modifying crossbeam to support async should be as simple as replacing the internal waker mechanism with an enum.</p>



<a name="270298745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270298745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270298745">(Feb 01 2022 at 22:28)</a>:</h4>
<p>Opened <a href="https://github.com/rust-lang/rust/pull/93563">https://github.com/rust-lang/rust/pull/93563</a>.</p>



<a name="270540546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270540546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270540546">(Feb 03 2022 at 12:31)</a>:</h4>
<p>I don’t know if Zulip or PR comments are better to discuss this, but what’s the maintenance story for <code>std::sync::mpmc</code> v.s. <code>crossbeam-channel</code>? <a href="https://github.com/rust-lang/rust/pull/93563#issuecomment-1028923738">https://github.com/rust-lang/rust/pull/93563#issuecomment-1028923738</a></p>



<a name="270578269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270578269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270578269">(Feb 03 2022 at 16:40)</a>:</h4>
<p>it's a bike-shed thing, but if we deprecate <code>mpsc</code>, I'd rather call the new thing just <code>channel</code> instead of the cryptic name</p>



<a name="270579061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270579061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270579061">(Feb 03 2022 at 16:44)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> Of the options we talked about in the meeting, I don't think any of them was to deprecate mpsc <em>and</em> introduce a new thing.</p>



<a name="270579354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270579354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270579354">(Feb 03 2022 at 16:46)</a>:</h4>
<p>well that's what the PR is suggesting long-term, and I think that's not a bad idea. if we fix the existing thing, and in the process have something that would be fine with multi-consumer, then "sc" is an unnecessary restriction baked in the name.</p>



<a name="270581839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270581839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270581839">(Feb 03 2022 at 17:01)</a>:</h4>
<p>agreed that "mpsc" is rather opaque jargon</p>



<a name="270598041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270598041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270598041">(Feb 03 2022 at 18:47)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> It seems like we have three options:<br>
1) Deprecate, without fixing.<br>
2) Fix, but still deprecate.<br>
3) Fix, and expand further in the future.</p>
<p>(3) would involve introducing a new thing but wouldn't involve deprecation; (1) and (2) would involve deprecation and I don't think it would make sense to introduce a new name in those cases.</p>



<a name="270598106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270598106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270598106">(Feb 03 2022 at 18:47)</a>:</h4>
<p>But yes, in general I agree that <code>channel</code> is a much better name.</p>



<a name="270598345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270598345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270598345">(Feb 03 2022 at 18:49)</a>:</h4>
<p>why is deprecation not part of 3 if we give the expansion a new name?</p>



<a name="270598423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270598423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270598423">(Feb 03 2022 at 18:50)</a>:</h4>
<p>i.e. have a fixed <code>mpsc</code>, but nudge people toward the superior <code>channel</code></p>



<a name="270598754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270598754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270598754">(Feb 03 2022 at 18:52)</a>:</h4>
<p>The bar for renaming things in std is pretty high since the old name needs to continue to exist anyway.</p>



<a name="270599480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270599480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270599480">(Feb 03 2022 at 18:57)</a>:</h4>
<p>Yeah. I don't think we'd mark something deprecated just to rename it.</p>



<a name="270599559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270599559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270599559">(Feb 03 2022 at 18:58)</a>:</h4>
<p>If we <em>did</em> add mpmc functionality, I'd absolutely call <em>that</em> <code>channel</code>, but I wouldn't deprecate <code>mpsc</code> in that case.</p>



<a name="270600183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270600183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270600183">(Feb 03 2022 at 19:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219747">Simon Sapin</span> <a href="#narrow/stream/219381-t-libs/topic/Deprecating.20mpsc/near/270540546">said</a>:</p>
<blockquote>
<p>I don’t know if Zulip or PR comments are better to discuss this, but what’s the maintenance story for <code>std::sync::mpmc</code> v.s. <code>crossbeam-channel</code>? <a href="https://github.com/rust-lang/rust/pull/93563#issuecomment-1028923738">https://github.com/rust-lang/rust/pull/93563#issuecomment-1028923738</a></p>
</blockquote>
<p>I think the ideal scenario would be to move crossbeam-channel into the rust-lang org and have std re-export that, like was done with hashbrown.</p>



<a name="270600291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270600291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270600291">(Feb 03 2022 at 19:01)</a>:</h4>
<p>That would let the current maintainers continue maintenance without a huge change.</p>



<a name="270600352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270600352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270600352">(Feb 03 2022 at 19:02)</a>:</h4>
<p>But I'm not sure how that works with crossbeam-channel depending on OS support <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="270601081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/270601081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#270601081">(Feb 03 2022 at 19:06)</a>:</h4>
<p>As a starter it would be good to know how large the diff to upstream is. And if it's too big if it could be minimized. Submodule of a fork with a small set of patches might be another option.</p>



<a name="272151728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/272151728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#272151728">(Feb 16 2022 at 17:48)</a>:</h4>
<p><span class="user-mention" data-user-id="310399">@Mara</span> in your update, did you mean T-libs is fine with the PR being merged as-is (after more review)?</p>



<a name="272151863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/272151863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#272151863">(Feb 16 2022 at 17:49)</a>:</h4>
<p>i.e before/without crossbeam-channel crate integration?</p>



<a name="272152331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/272152331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#272152331">(Feb 16 2022 at 17:52)</a>:</h4>
<p>libs-api is fine with it. libs (who is responsible for maintaining the standard library implementation) hasn't discussed it, but i don't think that's necessary. we just need one or two reviewers who are confident the code is maintanable, or at least more maintainable than what we currently have. ^^  it might take some time before it gets reviewed though, because it's a lot to review.</p>



<a name="272154765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/272154765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#272154765">(Feb 16 2022 at 18:06)</a>:</h4>
<p>One of the arguments during the meeting was that upstreamability could be reconsidered at the point when/if we want to expand the API rather than just doing minimal maintenance.<br>
Alternatively, if a later decision is to still deprecate the module then we'd need it even less.</p>



<a name="272403114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Deprecating%20mpsc/near/272403114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Deprecating.20mpsc.html#272403114">(Feb 18 2022 at 13:46)</a>:</h4>
<p>Relevant here is probably <a href="https://web.archive.org/web/20200226103012/https://stjepang.github.io/2019/03/02/new-channels.html">Stjepan's 2019 post on deprecating MSPC channels and replacing them with a better alternative</a>. (For those unaware of who Stjepan is: they took over maintenance of the crossbeam project pretty early on, and they designed among other things crossbeam's <code>channel</code> and <code>scope</code> primitives.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>