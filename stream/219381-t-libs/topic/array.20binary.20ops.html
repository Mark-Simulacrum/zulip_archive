<html>
<head><meta charset="utf-8"><title>array binary ops · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html">array binary ops</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273337644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273337644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273337644">(Feb 26 2022 at 12:23)</a>:</h4>
<p>Previously I was playing around with doing binary element-wise ops on arrays (Add, Mul etc). For simple code, I had experimented with a combination of <code>a.zip(b).map(|(a, b)| a + b)</code>, but I noticed that this code <a href="https://godbolt.org/z/WMxvTvrjv">doesn't like to optimise well</a>.</p>
<p>I started to work on an alternative impl that optimises to an equivalent hand written for loop (or faster by utilising uninit), and providing fast paths and slow paths depending on whether drops are required or not. You can find that here: <a href="https://github.com/conradludgate/array-bin-ops">https://github.com/conradludgate/array-bin-ops</a></p>
<p>I'm wondering if this addition would be appreciated to be added back into core (under some <code>.zip_map</code> func). It also improves regular zip by proxy.</p>
<p>It obviously adds more maintenance and unsafe overhead, so I would understand if it's not worth it. I haven't yet done proper benchmarks, I've mostly been optimising it to reduce the raw asm instructions, which I know isn't the best metric</p>



<a name="273346852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273346852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273346852">(Feb 26 2022 at 15:28)</a>:</h4>
<p>Well... just ran a benchmark and it's quite conclusive. I took a slice of 512 i32s, and did a reduce sum over array_chunks of 32.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">nightly</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">map</span><span class="w"></span>
<span class="n">zip</span><span class="o">+</span><span class="n">map32</span><span class="w">               </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">1.3415</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.3428</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="mf">1.3441</span><span class="w"> </span><span class="n">us</span><span class="p">]</span><span class="w"></span>

#<span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">zip_map</span><span class="w"> </span><span class="n">method</span><span class="w"></span>
<span class="n">zip_map32</span><span class="w">               </span><span class="n">time</span>:   <span class="p">[</span><span class="mf">115.97</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">116.16</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="mf">116.36</span><span class="w"> </span><span class="n">ns</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>Which is 11.5x faster!</p>



<a name="273347264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273347264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273347264">(Feb 26 2022 at 15:35)</a>:</h4>
<p>Source: <a href="https://github.com/conradludgate/array-bin-ops/blob/main/benches/sum.rs">https://github.com/conradludgate/array-bin-ops/blob/main/benches/sum.rs</a><br>
Running on a modern AMD x86 Ryzen desktop processor on Linux.<br>
I'll also run it on my M1 Macbook later in the day to see if performance is good on arm too</p>



<a name="273350496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273350496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273350496">(Feb 26 2022 at 16:41)</a>:</h4>
<p>Unfortunately it's just true in general that chaining array methods seems to optimize poorly.  To the extent that it's unclear how many operations make sense to provide on it, vs finding a better way.  Like maybe it needs an iterator-like chaining mechanism for building arrays -- maybe literally iterators with some smart way to turn them into arrays, who knows.</p>
<p>But you can probably just send a PR for <code>zip_with</code> if you want.  <code>zip</code> is unstable too (<a href="https://github.com/rust-lang/rust/issues/80094">#80094</a>), so it's a small addition that wouldn't be a big deal to add.  After all, it can always just be removed again later if libs-api decides it's unwanted.  That said, anything that duplicates the array building unsafe code is probably not going to be accepted from an implementation perspective, so you'll need to find a way to merge your improvements with what core is already doing, not just copy-paste wholesale.</p>
<p>I'll note that skipping zip+map and just using <code>from_fn</code> gives something much better: &lt;<a href="https://rust.godbolt.org/z/Yb66hfMcr">https://rust.godbolt.org/z/Yb66hfMcr</a>&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(array_from_fn)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_i64x32</span><span class="p">(</span><span class="n">lhs</span>: <span class="p">[</span><span class="kt">i64</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="n">rhs</span>: <span class="p">[</span><span class="kt">i64</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">i64</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">array</span>::<span class="n">from_fn</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">lhs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rhs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>How much of your improvement is just from skipping the drop guards for <code>!needs_drop</code> types?  As a first PR, you might experiment with just adding a "<code>T</code> isn't <code>needs_drop</code> so we can skip the guard" path in <a href="https://github.com/rust-lang/rust/blob/8c9640e34c73dc45bfd38eca49fa1405b11b6cae/library/core/src/array/mod.rs#L793-L856">https://github.com/rust-lang/rust/blob/8c9640e34c73dc45bfd38eca49fa1405b11b6cae/library/core/src/array/mod.rs#L793-L856</a></p>



<a name="273350799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273350799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273350799">(Feb 26 2022 at 16:48)</a>:</h4>
<p>using iterator methods and collecting into a vec yields decent assembly. so as usual we're lacking a way to collect into arrays</p>



<a name="273350810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273350810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273350810">(Feb 26 2022 at 16:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/81615">#81615</a></p>



<a name="273357782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273357782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273357782">(Feb 26 2022 at 19:14)</a>:</h4>
<p>I mean at the risk of self-promotion, this is basically what std::simd will be for. &lt;_&lt;</p>



<a name="273362066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273362066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Conrad Ludgate <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273362066">(Feb 26 2022 at 20:46)</a>:</h4>
<p>Well, i think I'll still make a PR. I had already started on it before and I think i mostly got it to fit into the existing <code>Iter</code> based impl</p>



<a name="273365222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/array%20binary%20ops/near/273365222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/array.20binary.20ops.html#273365222">(Feb 26 2022 at 21:59)</a>:</h4>
<p>Another thing that might be worth trying is changing the loop in that method to be <code>for i in 0..N</code> instead of being a loop on the iterator.  I thought there was a PR recently that said that improved the codegen, though I'm currently failing to find it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>