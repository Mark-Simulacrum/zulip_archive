<html>
<head><meta charset="utf-8"><title>Binary search and multiple matches · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html">Binary search and multiple matches</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270473651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270473651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270473651">(Feb 02 2022 at 23:08)</a>:</h4>
<p>A  note about <code>binary_search</code> and friends: when there are multiple matches, any one of the matches might be returned. I'm currently writing code that wants all the matches, so it uses <code>binary_search_by</code> and then has to scan forward and backward to find additional matches.</p>
<p>I suspect the current behaviour gives maximum performance, but it is a little inconvenient for my current use case. I'm not saying anything should necessarily change, but perhaps this is a useful anecdote for the libs team <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="270473939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270473939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270473939">(Feb 02 2022 at 23:11)</a>:</h4>
<p><code>partition_point</code> will give you the first index</p>



<a name="270474775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270474775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270474775">(Feb 02 2022 at 23:20)</a>:</h4>
<p>I've wanted something like C++'s <code>equal_range</code> for ages.  It could return a <code>Range&lt;usize&gt;</code> of the found positions -- and if it's empty, it'd be the place to insert to keep the sequence in sorted order.</p>
<p>Approaching-5-year-old RFCs issue: <a href="https://github.com/rust-lang/rfcs/issues/2184">https://github.com/rust-lang/rfcs/issues/2184</a></p>



<a name="270476904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270476904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270476904">(Feb 02 2022 at 23:40)</a>:</h4>
<p>I looked at <code>partition_point</code>. I have a sorted slice of strings, and I want to find all the strings that match a given prefix. <code>partition_point</code> didn't seem like it would fit, but I guess the predicate could be <code>|s| s.starts_with(prefix) || s.cmp(prefix) == Ordering::Greater</code> ?</p>



<a name="270477884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270477884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270477884">(Feb 02 2022 at 23:50)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> To find the lower bound, use <code>|s| s &lt; prefix</code>, and to find the upper bound use <code>|s| s.starts_with(prefix)</code> on the subslice from the first operation</p>



<a name="270478074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270478074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270478074">(Feb 02 2022 at 23:53)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> From the RFC, it looks like progress stalled after <code>partition_point</code> landed. I think that <code>partition_point</code> does make <code>lower_bound</code> and <code>upper_bound</code> obsolete, but <code>equal_range</code> can be implemented more efficiently than two calls to <code>partition_point</code></p>



<a name="270478102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270478102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270478102">(Feb 02 2022 at 23:53)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> Oh, I see! Thanks for the suggestion. (I was hoping someone would tell me a better way to do it, and you did <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> )</p>



<a name="270479193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270479193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270479193">(Feb 03 2022 at 00:03)</a>:</h4>
<p>Hmm, I have to be a bit careful for the case where there are no matches.</p>



<a name="270480758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270480758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270480758">(Feb 03 2022 at 00:20)</a>:</h4>
<p>Here's what I've got now:</p>
<div class="codehilite"><pre><span></span><code>            let i = rlibs.partition_point(|spf| spf.file_name_str &lt; rlib_prefix);
            let binary_matches: SmallVec&lt;[usize; 4]&gt; = if let Some(true) =
                rlibs.get(i).map(|spf| spf.file_name_str.starts_with(&amp;rlib_prefix))
            {
                let mut j = i;
                while j &lt; rlibs.len() - 1 &amp;&amp; rlibs[j + 1].file_name_str.starts_with(&amp;rlib_prefix) {
                    j += 1;
                }
                (i..=j).collect()
            } else {
                SmallVec::new()
            };
</code></pre></div>



<a name="270480815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270480815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270480815">(Feb 03 2022 at 00:21)</a>:</h4>
<p>It's more concise than the binary search version, but it was harder to get right, with more edge cases.</p>



<a name="270480852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270480852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270480852">(Feb 03 2022 at 00:21)</a>:</h4>
<p>E.g. getting an index that's out of bounds</p>



<a name="270481967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270481967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270481967">(Feb 03 2022 at 00:33)</a>:</h4>
<p>that's more complicated than I expected. No promises on this being syntactically correct but I was expecting something more like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlibs</span><span class="p">.</span><span class="n">partition_point</span><span class="p">(</span><span class="o">|</span><span class="n">spf</span><span class="o">|</span><span class="w"> </span><span class="n">spf</span><span class="p">.</span><span class="n">file_name_str</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rlib_prefix</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlibs</span><span class="p">[</span><span class="n">i</span><span class="o">..</span><span class="p">].</span><span class="n">partition_point</span><span class="p">(</span><span class="o">|</span><span class="n">spf</span><span class="o">|</span><span class="w"> </span><span class="n">spf</span><span class="p">.</span><span class="n">file_name_str</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rlib_prefix</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">rlibs</span><span class="p">[</span><span class="n">i</span><span class="o">..</span><span class="n">j</span><span class="p">]</span><span class="w"></span>
</code></pre></div>



<a name="270482156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270482156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270482156">(Feb 03 2022 at 00:35)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span></p>



<a name="270482324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270482324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270482324">(Feb 03 2022 at 00:37)</a>:</h4>
<p>it's also faster than your version in the case where the list of matches is long (since it does binary search to find the end point instead of linear search), although linear search often wins in small-to-medium cases</p>



<a name="270482442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270482442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270482442">(Feb 03 2022 at 00:38)</a>:</h4>
<p>I believe this seamlessly handles the case where there are no matches: the first search will return the point at which the prefix would live, and the second search makes <code>j = i</code></p>



<a name="270485592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270485592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270485592">(Feb 03 2022 at 01:12)</a>:</h4>
<p>In my case the number of matches is rarely greater than 1, alas</p>



<a name="270492648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270492648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270492648">(Feb 03 2022 at 02:39)</a>:</h4>
<p>After more fiddling I got it down to this:</p>
<div class="codehilite"><pre><span></span><code>            let i = rmetas.partition_point(|spf| spf.file_name_str &lt; rmeta_prefix);
            let mut j = i;
            while let Some(true) =
                rmetas.get(j).map(|spf| spf.file_name_str.starts_with(&amp;rmeta_prefix))
            {
                j += 1;
            }

           // Then iterate over `&amp;rmetas[i..j]`
</code></pre></div>



<a name="270492783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270492783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270492783">(Feb 03 2022 at 02:40)</a>:</h4>
<p>Thanks again for the suggestions</p>



<a name="270526403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270526403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270526403">(Feb 03 2022 at 10:18)</a>:</h4>
<p>Imo the sub-slice based approach would be more rusty</p>



<a name="270526537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270526537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270526537">(Feb 03 2022 at 10:19)</a>:</h4>
<p>"sort in place but return a subslice" seems like an unusual and error-prone interface.</p>



<a name="270526634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270526634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270526634">(Feb 03 2022 at 10:20)</a>:</h4>
<p>In particular, the subslice will only differ from the original iff you have NaNs present.</p>



<a name="270526666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Binary%20search%20and%20multiple%20matches/near/270526666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Binary.20search.20and.20multiple.20matches.html#270526666">(Feb 03 2022 at 10:20)</a>:</h4>
<p>And in the common case where you don't, people could ignore that and use the original.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>