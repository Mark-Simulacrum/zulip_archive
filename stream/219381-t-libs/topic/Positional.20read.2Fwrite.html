<html>
<head><meta charset="utf-8"><title>Positional read/write · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html">Positional read/write</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276452970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276452970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276452970">(Mar 24 2022 at 10:01)</a>:</h4>
<p>Has there been any discussion about or is anyone interested in supporting positional read/writes? Context is that for async a number of people have told me that a positional read is better than seek + read (and respectively for writes). The motivation is stronger for async and the underlying OS APIs often support it directly. I'm wondering if this is something that has come up before? And/or if people have thoughts about this sort of thing should be added to the Read/Write traits or be on separate traits (I assume the latter because not all readers would support positional read). And if separate traits, should PosRead: Read  + Seek, or just one or neither? Plus any other thoughts about the necessary-ness of this, or what the API should look like.</p>



<a name="276458097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276458097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276458097">(Mar 24 2022 at 10:51)</a>:</h4>
<p>I think PosRead shouldn't require either Read or Seek. That allows implementing it for a type without internal seek position like <code>&amp;[u8]</code>.</p>



<a name="276528155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276528155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276528155">(Mar 24 2022 at 19:29)</a>:</h4>
<p>there's a platform-specific trait for preadv/pwritev. <a href="https://doc.rust-lang.org/std/os/unix/fs/trait.FileExt.html">https://doc.rust-lang.org/std/os/unix/fs/trait.FileExt.html</a></p>



<a name="276528915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276528915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276528915">(Mar 24 2022 at 19:36)</a>:</h4>
<p>Wow. I've been using <code>libc::pread</code> <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="276532500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276532500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276532500">(Mar 24 2022 at 20:06)</a>:</h4>
<p>Any idea why it’s Unix only rather than cross platform? Just because the Unix api exists? (That may sound like a silly question, but it could be derived at least elsewhere, if it doesn’t exist)</p>



<a name="276533847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276533847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276533847">(Mar 24 2022 at 20:17)</a>:</h4>
<p>No idea, maybe check the issue that introduced it if there were cross-platform concerns.</p>



<a name="276534814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276534814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276534814">(Mar 24 2022 at 20:26)</a>:</h4>
<p>I don't think it can be derived on other platforms so easily because it wouldn't be an atomic operation - other threads could observe the file pointer being moved. Maybe if it took <code>&amp;mut self</code> it could be added though. I also heard that the closest Windows equivalent (a single syscall that seeks and reads at the same time) is async only.</p>



<a name="276536463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276536463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276536463">(Mar 24 2022 at 20:39)</a>:</h4>
<p>Taking &amp;mut self is not enough. Libstd implements <code>Read</code>, <code>Write</code> and <code>Seek</code> for <code>&amp;File</code>, <code>&amp;TcpStream</code> and a couple of other types. This allows performing these operations from multiple threads without locks.</p>



<a name="276536676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276536676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276536676">(Mar 24 2022 at 20:41)</a>:</h4>
<p>Windows has its own similar <code>FileExt</code>:<br>
<a href="https://doc.rust-lang.org/std/os/windows/fs/trait.FileExt.html">https://doc.rust-lang.org/std/os/windows/fs/trait.FileExt.html</a></p>



<a name="276536722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276536722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276536722">(Mar 24 2022 at 20:42)</a>:</h4>
<p>and those <code>seek_read</code>/<code>write</code> <em>do</em> affect the file cursor</p>



<a name="276536968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276536968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276536968">(Mar 24 2022 at 20:43)</a>:</h4>
<p>and then WASI only has <code>read</code>/<code>write_vectored_at</code><br>
<a href="https://doc.rust-lang.org/std/os/wasi/fs/trait.FileExt.html">https://doc.rust-lang.org/std/os/wasi/fs/trait.FileExt.html</a></p>



<a name="276537134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276537134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276537134">(Mar 24 2022 at 20:45)</a>:</h4>
<p>oh, nvm, that has provided versions of <code>read_at</code> and <code>write_at</code> too</p>



<a name="276537179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276537179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276537179">(Mar 24 2022 at 20:45)</a>:</h4>
<p>Windows' trait is different than the Unix trait; in Windows, the stream remembers the position, as if it were a seek followed by a read/write</p>



<a name="276537301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276537301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276537301">(Mar 24 2022 at 20:46)</a>:</h4>
<p>that's what I meant by affecting the file cursor</p>



<a name="276537457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276537457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276537457">(Mar 24 2022 at 20:48)</a>:</h4>
<p>I wonder if there's any atomicity in that, at least?</p>



<a name="276538071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276538071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276538071">(Mar 24 2022 at 20:54)</a>:</h4>
<p>I have a <code>read_at</code> implementation for Windows <a href="https://docs.rs/system-interface/latest/src/system_interface/fs/file_io_ext.rs.html#631">here</a>; effectively, it does <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-reopenfile"><code>ReOpenFile</code></a> to get an independent handle and does <code>seek_read</code> on that. It isn't perfect; <code>ReOpenFile</code> requires permission to re-open the file, but it's enough for some use cases.</p>



<a name="276541885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276541885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276541885">(Mar 24 2022 at 21:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/219381-t-libs/topic/Positional.20read.2Fwrite/near/276536463">said</a>:</p>
<blockquote>
<p>Taking &amp;mut self is not enough. Libstd implements <code>Read</code>, <code>Write</code> and <code>Seek</code> for <code>&amp;File</code>, <code>&amp;TcpStream</code> and a couple of other types. This allows performing these operations from multiple threads without locks.</p>
</blockquote>
<p>The function would take <code>&amp;mut File</code> not <code>&amp;mut &amp;File</code>, so you'd have the guarantee that no <code>&amp;File</code>s exist</p>



<a name="276542015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276542015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276542015">(Mar 24 2022 at 21:29)</a>:</h4>
<p><code>dup</code>'d file descriptors share offsets iirc</p>



<a name="276542192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276542192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276542192">(Mar 24 2022 at 21:31)</a>:</h4>
<p>try_clone:</p>
<blockquote>
<p>Creates a new File instance that shares the same underlying file handle as the existing File instance. Reads, writes, and seeks will affect both File instances simultaneously.</p>
</blockquote>



<a name="276542897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276542897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276542897">(Mar 24 2022 at 21:39)</a>:</h4>
<p>If the trait is implemented for &amp;File, the function would take <code>&amp;mut &amp;File</code>, not <code>&amp;mut File</code>.</p>



<a name="276548444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276548444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276548444">(Mar 24 2022 at 22:39)</a>:</h4>
<p><code>ReOpenFile</code> on Windows obtains a new handle that has an independent offset.</p>



<a name="276725085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276725085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276725085">(Mar 26 2022 at 13:02)</a>:</h4>
<p>Huh, I was always under impression that <code>ReadFile</code> won't update any file-specific state if using the <code>OVERLAPPED</code> argument.</p>



<a name="276728747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Positional%20read/write/near/276728747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Positional.20read.2Fwrite.html#276728747">(Mar 26 2022 at 14:29)</a>:</h4>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntreadfile"><code>NtReadFile</code></a> has some more details on what's happening:</p>
<blockquote>
<p>If the call to NtCreateFile set either of the CreateOptions flags FILE_SYNCHRONOUS_IO_ALERT or FILE_SYNCHRONOUS_IO_NONALERT, the I/O Manager maintains the current file position...</p>
<p>Even when the I/O Manager is maintaining the current file position, the caller can reset this position by passing an explicit ByteOffset value to NtReadFile. Doing this automatically changes the current file position to that ByteOffset value, performs the read operation, and then updates the position according to the number of bytes actually read. This technique gives the caller atomic seek-and-read service.</p>
</blockquote>
<p>Note that <code>CreateFileW</code> opens files with <code>FILE_SYNCHRONOUS_IO_NONALERT</code> unless <code>FILE_FLAG_OVERLAPPED</code> is used.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>