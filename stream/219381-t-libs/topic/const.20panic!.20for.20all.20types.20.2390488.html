<html>
<head><meta charset="utf-8"><title>const panic! for all types #90488 · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html">const panic! for all types #90488</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262490339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262490339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262490339">(Nov 23 2021 at 17:50)</a>:</h4>
<p>I am assigned <a href="https://github.com/rust-lang/rust/issues/90488">#90488</a> but am unsure whether to merge and am looking for more opinions. The TLDR is that that PR will allow you to format any type that works at runtime in const contexts, but if there is no <code>const Display</code> impl (but a regular <code>Display</code>) it will just fall back to <code>&lt;could not format X&gt;</code> in the message. If we stabilize this, we will never be able to restrict panic formatting to just <code>const Display</code> or <code>const Debug</code> types, but will keep the silent fallback. On the other hand, this is just during panicking, so not sure how problematic/relevant my concern is at all.</p>



<a name="262492411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262492411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262492411">(Nov 23 2021 at 18:06)</a>:</h4>
<p>I'd definitely lean towards preferring being able to enforce that types can be displayed</p>



<a name="262492550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262492550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262492550">(Nov 23 2021 at 18:07)</a>:</h4>
<p>Wouldn't it be possible to use a wrapper to provide the "could not format" fallback display for types that don't impl const display?</p>



<a name="262493509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262493509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262493509">(Nov 23 2021 at 18:15)</a>:</h4>
<p>I think we should, at least for now, only allow compile-time panic formatting for types that we are pretty sure will be <code>const Display</code> eventually</p>



<a name="262493616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262493616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262493616">(Nov 23 2021 at 18:16)</a>:</h4>
<p>Otherwise we end up with a permanent inconsistency between format strings in panic and format strings elsewhere, and that does not seem great</p>



<a name="262493745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262493745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262493745">(Nov 23 2021 at 18:17)</a>:</h4>
<p>I think we should be very careful here because I think there is a significant risk of users unknowingly failing to include important information in hard to reproduce panics which would bite people continuously and might be impossible to undo</p>



<a name="262493888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262493888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262493888">(Nov 23 2021 at 18:18)</a>:</h4>
<p>Tho I need to look more into the issues around constification of Result unwrap, which we need to be balanced against the cost of lossy panic messages</p>



<a name="262493917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262493917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262493917">(Nov 23 2021 at 18:18)</a>:</h4>
<p>Is that the only issue really pushing us towards having the silent fallback?</p>



<a name="262497801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262497801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262497801">(Nov 23 2021 at 18:52)</a>:</h4>
<p>for panic messages, I'd say that we use the looser bound of <code>const Debug</code>, since you can derive a Debug but you can't derive a Display.</p>



<a name="262498165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262498165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262498165">(Nov 23 2021 at 18:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262497801">said</a>:</p>
<blockquote>
<p>for panic messages, I'd say that we use the looser bound of <code>const Debug</code>, since you can derive a Debug but you can't derive a Display.</p>
</blockquote>
<p>we should use whatever the format string uses -- <code>{}</code> needs <code>const Display</code>, <code>:?</code> needs <code>const Debug</code></p>



<a name="262498924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262498924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262498924">(Nov 23 2021 at 19:00)</a>:</h4>
<p>Ah, I'd forgot we aren't panicing raw values any more.</p>



<a name="262506338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262506338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262506338">(Nov 23 2021 at 20:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262493888">said</a>:</p>
<blockquote>
<p>Tho I need to look more into the issues around constification of Result unwrap, which we need to be balanced against the cost of lossy panic messages</p>
</blockquote>
<p>It's mostly a question of how fast we want to get there. We don't expect <code>impl const Display</code> to be a thing in the near future or even next year. So unwrap would come after that.</p>



<a name="262506380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262506380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262506380">(Nov 23 2021 at 20:04)</a>:</h4>
<p>It doesn't affect runtime, so the panic messages would just be bad at compile time</p>



<a name="262506409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262506409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262506409">(Nov 23 2021 at 20:05)</a>:</h4>
<p>But we'll have to support that fallback machinery forever</p>



<a name="262527635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262527635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262527635">(Nov 23 2021 at 23:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby [she/her]</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262493745">said</a>:</p>
<blockquote>
<p>I think we should be very careful here because I think there is a significant risk of users unknowingly failing to include important information in hard to reproduce panics which would bite people continuously and might be impossible to undo</p>
</blockquote>
<p>That's the reason why I think it's important to allow everything to be used in const panic.</p>



<a name="262527660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262527660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262527660">(Nov 23 2021 at 23:13)</a>:</h4>
<p>Because otherwise people will delete info that can't be formatted in const panic.</p>



<a name="262527768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262527768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262527768">(Nov 23 2021 at 23:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262506380">said</a>:</p>
<blockquote>
<p>It doesn't affect runtime, so the panic messages would just be bad at compile time</p>
</blockquote>
<p>ooh that's an interesting point. I could see that being much less of an issue</p>



<a name="262527910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262527910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262527910">(Nov 23 2021 at 23:16)</a>:</h4>
<p>Note though that it's "transitive" compile-time -- e.g., panicking with a debug of <code>Vec&lt;T&gt;</code> in crate A gives you no warning until some downstream crate B actually invokes that code, potentially</p>



<a name="262527919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262527919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262527919">(Nov 23 2021 at 23:16)</a>:</h4>
<p>so I'm not sure it's a huge difference, in some sense</p>



<a name="262528001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528001">(Nov 23 2021 at 23:17)</a>:</h4>
<p>yea, the main issue I am worried about is the potential for very long turn around on noticing an error message with insufficient information, fixing that error message, and reproducing the error</p>



<a name="262528004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528004">(Nov 23 2021 at 23:17)</a>:</h4>
<p>At minimum it seems worthwhile to have a lint (at some level, I'd suggest warn) that indicates when you've not provided the appropriate bound -- though that gets complicated where the bound isn't stable yet</p>



<a name="262528078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528078">(Nov 23 2021 at 23:18)</a>:</h4>
<p>if its runtime you run the risk of that error being in a very hard to reach code path, but with compile time I imagine that once you've encountered an error with insufficient info reproducing that error will be trivial</p>



<a name="262528099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528099">(Nov 23 2021 at 23:18)</a>:</h4>
<p>and you can always still use patch deps to fix the missing info if it comes from a dependency</p>



<a name="262528150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528150">(Nov 23 2021 at 23:19)</a>:</h4>
<p>My plan is just to dump all fields (like a dervied Debug) if it couldn't be formatted.</p>



<a name="262528167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528167">(Nov 23 2021 at 23:19)</a>:</h4>
<p>With a note saying that this probably isn't what you'll see in runtime.</p>



<a name="262528234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528234">(Nov 23 2021 at 23:20)</a>:</h4>
<p>that sounds okay I think</p>



<a name="262528249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528249">(Nov 23 2021 at 23:20)</a>:</h4>
<p>And the cost is what <span class="user-mention silent" data-user-id="124288">oli</span> said, this needs a fallback machinary that needs to be kept even if we have <code>const Debug</code> in the future.</p>



<a name="262528447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528447">(Nov 23 2021 at 23:22)</a>:</h4>
<p>(I am very pessimistic about when <code>const Debug</code> would be usable)</p>



<a name="262528483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262528483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262528483">(Nov 23 2021 at 23:23)</a>:</h4>
<p>And I certainly think people need const unwrap now while <code>const Debug</code> can wait.</p>



<a name="262537555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262537555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262537555">(Nov 24 2021 at 01:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262528249">said</a>:</p>
<blockquote>
<p>And the cost is what <span class="user-mention silent" data-user-id="124288">oli</span> said, this needs a fallback machinary that needs to be kept even if we have <code>const Debug</code> in the future.</p>
</blockquote>
<p>the other cost is that if we ever have <code>format_args</code> at const-time there will be an (unfixable) inconsistency between what you can format for a panic and what you can format for other purposes. this is the main reason why I am in favor of requiring a proper bound.</p>



<a name="262537694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262537694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262537694">(Nov 24 2021 at 01:42)</a>:</h4>
<p>I also think there is no rush -- we can stabilize the uncontroversial part of the formatting machinery and wait how much of a problem the missing support for <code>const Debug</code> on user types and generic types is. I don't understand why you want to rush this through all at once when we have an uncontroversially useful core part of this feature and we can just wait and see if a magic fallback impl is really needed.</p>



<a name="262537748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262537748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262537748">(Nov 24 2021 at 01:43)</a>:</h4>
<p><code>Result::unwrap</code> lives in std so presumably it could use a <code>const Debug</code> bound long before anyone else can (so at last user code calling <code>Result::unwrap</code> on a concrete supported type can get proper formatting -- though I guess it is unlikely that the error type actually falls in the set of supported types)</p>



<a name="262538145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262538145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262538145">(Nov 24 2021 at 01:51)</a>:</h4>
<p>The issue is that I don't see how <code>const Debug</code> would work today.</p>



<a name="262538214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262538214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262538214">(Nov 24 2021 at 01:52)</a>:</h4>
<p>So constraining it would require probably a marker trait</p>



<a name="262538234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262538234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262538234">(Nov 24 2021 at 01:53)</a>:</h4>
<p>And then there is the problem of  the<code>dyn Debug</code> used in <code>assert_eq!</code>.</p>



<a name="262538382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262538382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262538382">(Nov 24 2021 at 01:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262537748">said</a>:</p>
<blockquote>
<p>though I guess it is unlikely that the error type actually falls in the set of supported types)</p>
</blockquote>
<p>And this is why I think we should accept all types, because otherwise it is just not as useful.</p>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262527660">said</a>:</p>
<blockquote>
<p>Because otherwise people will delete info that can't be formatted in const panic.</p>
</blockquote>
<p>^</p>



<a name="262556226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262556226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262556226">(Nov 24 2021 at 08:06)</a>:</h4>
<p>one alternative would also be to do this just for Debug and not for the other formatting traits</p>



<a name="262562711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262562711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262562711">(Nov 24 2021 at 09:15)</a>:</h4>
<p>Anyway. In the spirit of getting uncontroversial things out the door quickly, I propose to split the feature into two gates. One for "obviously fine" types like builtin types (which will get const impls some day) and one for the "print everything with fallback" schemes.</p>



<a name="262563001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262563001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262563001">(Nov 24 2021 at 09:18)</a>:</h4>
<p>Wrt the dyn trait thing, we could start experimenting with <code>dyn ~const Trait</code> and make the two feature checks  happen during unsizing, too</p>



<a name="262582878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262582878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262582878">(Nov 24 2021 at 12:45)</a>:</h4>
<p>Note that if we had const fn pointers it is possible to emulate const trait objects</p>



<a name="262586218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262586218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262586218">(Nov 24 2021 at 13:12)</a>:</h4>
<p>Maybe we should add a bunch of unstable features like const trait objects and const rn pointers so we can try out the alternatives before committing to new schemes</p>



<a name="262596281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262596281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262596281">(Nov 24 2021 at 14:34)</a>:</h4>
<blockquote>
<p>Because otherwise people will delete info that can't be formatted in const panic.</p>
</blockquote>
<p>const panics are already stabilized, so even the version of your PR restricted to types that we know can be const-formatted can only make things strictly better.<br>
If, once we ship this, it turns out deleting info is a real problem, then we can go back to the extended version of your PR -- but this change is way too risky (can never be taken back!) to do it based on just an untested hypothesis of what people might do if we dont do this.</p>



<a name="262596415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262596415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262596415">(Nov 24 2021 at 14:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262538214">said</a>:</p>
<blockquote>
<p>So constraining it would require probably a marker trait</p>
</blockquote>
<p>I think the constrained version would simply have a list of allowed types, no need for a trait</p>



<a name="262596479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262596479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262596479">(Nov 24 2021 at 14:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262538234">said</a>:</p>
<blockquote>
<p>And then there is the problem of  the<code>dyn Debug</code> used in <code>assert_eq!</code>.</p>
</blockquote>
<p>could you elaborate on what that problem is?</p>



<a name="262611190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262611190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262611190">(Nov 24 2021 at 16:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262596415">said</a>:</p>
<blockquote>
<p>I think the constrained version would simply have a list of allowed types, no need for a trait</p>
</blockquote>
<p>How would you check the types? The current PR touches no typecheck at all. The check needs to be done early before monomorphizing. This also means that you can't panic with a type param anymore, something needed for <code>Result::unwrap</code>.</p>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262596479">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262538234">said</a>:</p>
<blockquote>
<p>And then there is the problem of  the<code>dyn Debug</code> used in <code>assert_eq!</code>.</p>
</blockquote>
<p>could you elaborate on what that problem is?</p>
</blockquote>
<p><code>assert_eq!</code> delegates failing path to <code>assert_failed_inner</code> that formats with <code>&amp;dyn Debug</code> to avoid code bloat.</p>



<a name="262613421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262613421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262613421">(Nov 24 2021 at 16:48)</a>:</h4>
<p>There are multiple reasons that I used the current approach</p>
<ul>
<li>It allows <code>Result::unwrap</code> (more or less guiding principle for me)</li>
<li>It is the least intrusive approach (it basically just plugs into const eval, no need to modify many different parts of compiler or libs).</li>
<li>If there is going to be a check for formattable types, it needs to happen in typecheck (or somewhere else before mono)<ul>
<li><code>const Debug</code> is not doable today without magic, and even if it's doable with magic like <code>rustc_do_not_const_check</code> it's not desirable because that'll allow user code to call <code>Debug::fmt</code> in const context, which we don't want now and we don't know if we want it in the future.</li>
<li>An additional helper trait (say, <code>ConstDebug</code>) could potentially solve the issue, but that'll require <code>Result::unwrap</code>or <code>assert_eq!</code> to take a <code>~const ConstDebug</code> bound; I am not sure if that could be done in a back-compat way. Plus the helper trait has to be perma-unstable and so code outside std couldn't carry the same bound.</li>
</ul>
</li>
</ul>



<a name="262813936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262813936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262813936">(Nov 26 2021 at 16:16)</a>:</h4>
<blockquote>
<p>How would you check the types? The current PR touches no typecheck at all.</p>
</blockquote>
<p>sounds like a job for const-checking</p>



<a name="262813988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262813988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262813988">(Nov 26 2021 at 16:17)</a>:</h4>
<blockquote>
<p>This also means that you can't panic with a type param anymore, something needed for Result::unwrap.</p>
</blockquote>
<p>I specifically mentioned a possible work-around for that (not something for the MVP though): use <code>T: ~const Debug</code> in that function; it is defined in libcore so it can do Magic</p>



<a name="262814164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262814164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262814164">(Nov 26 2021 at 16:19)</a>:</h4>
<p>I understand why you picked this approach, but I also think it is the wrong approach for the reasons stated before -- it is an ad-hoc extension of the language that we can never take back. formatting things requires the appropriate trait to be implemented; I dont think we should depart from this important fundamental principle for some short-term gains.</p>



<a name="262825140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262825140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262825140">(Nov 26 2021 at 18:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262813936">said</a>:</p>
<blockquote>
<p>sounds like a job for const-checking</p>
</blockquote>
<p>I am not really convinced that this is the correct way though; this makes formatting part of the language.</p>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262813988">said</a>:</p>
<blockquote>
<p>I specifically mentioned a possible work-around for that (not something for the MVP though): use <code>T: ~const Debug</code> in that function; it is defined in libcore so it can do Magic</p>
</blockquote>
<p>And I specifically mentioned why it wouldn't work. Would <code>&lt;T as Debug&gt;::fmt</code> be considered const if <code>T: const Debug</code>? Have<code>T: const Debug</code> to only mean that it can be used for const panic is simply confusing.</p>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262814164">said</a>:</p>
<blockquote>
<p>it is an ad-hoc extension of the language that we can never take back. formatting things requires the appropriate trait to be implemented; I dont think we should depart from this important fundamental principle for some short-term gains.</p>
</blockquote>
<p>This is not an extension to the language, if we say "you can const panic with anything and diagnostics is not guaranteed to be precise". From a language perspective then an alternative implementation could just panic without trying to format messages. The compiler is only doing its best-effort to produce better diagnostics. No fundamental concepts are being broken, and formatting things still require appropriate traits. The only difference is that libcore needs a special way to construct format args for panic (which it already has for the limited const panic we support today). If const panic becomes a thing in the future, then the compiler is just doing its best-effort diagnostics in a different way.</p>



<a name="262825564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262825564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262825564">(Nov 26 2021 at 18:38)</a>:</h4>
<p>IMO the only reason for not allowing const panic with anything is that the current separate <code>const_format_args</code> code in library and const panicking code will stay forever. But it's not an ad-hoc extension to the language. Also, I still see it being useful to be able to panic with types that can't be const formatted, e.g. pointers, which could never be formatted accurately during compile time.</p>
<p>My question is perhaps, do we want perfection to be the enemy of good?</p>



<a name="262897237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262897237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262897237">(Nov 27 2021 at 22:54)</a>:</h4>
<blockquote>
<p>this makes formatting part of the language.</p>
</blockquote>
<p>Your patch makes formatting part of the language, by hard-coding it in the interpreter. So this is really not valid criticism IMO.<br>
In fact, making it part of the dynamics of the language (the interpreter) <em>without</em> also making it part of the static checks of the language (const-checking) is an awkward mismatch.</p>



<a name="262897309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262897309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262897309">(Nov 27 2021 at 22:56)</a>:</h4>
<blockquote>
<p>And I specifically mentioned why it wouldn't work. Would &lt;T as Debug&gt;::fmt be considered const if T: const Debug? HaveT: const Debug to only mean that it can be used for const panic is simply confusing.</p>
</blockquote>
<p>I don't understand. Assuming a working implementation of const traint bounds, yes, <code>&lt;T as Debug&gt;::fmt </code> is const if <code>T: const Debug</code>. nothing panic-specific there. but Result::unwrap is going to be the only method with that bound, we sure shouldnt expose it for any non-panic-related things.</p>



<a name="262897324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262897324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262897324">(Nov 27 2021 at 22:57)</a>:</h4>
<blockquote>
<p>This is not an extension to the language, if we say "you can const panic with anything and diagnostics is not guaranteed to be precise". </p>
</blockquote>
<p>The fact that you have to change the interpreter shows very clearly that this <em>is</em> a part of the language. That's what it <em>means</em> to be part of the langauge -- that the interpreter needs special support for it.</p>



<a name="262897387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262897387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262897387">(Nov 27 2021 at 22:59)</a>:</h4>
<blockquote>
<p>From a language perspective then an alternative implementation could just panic without trying to format messages.</p>
</blockquote>
<p>The concrete thing that you are making part of the language that I am objecting to is that using Display or Debug-formatting for a panic message in const code is allowed <em>even when the type in question does not const-implement the relevant trait</em>.<br>
How exactly the output of that panic looks like is not relevant for my concern. The fact that that code compiles and runs at all is my concern.</p>



<a name="262897494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262897494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262897494">(Nov 27 2021 at 23:00)</a>:</h4>
<p>We don</p>



<a name="262897678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262897678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262897678">(Nov 27 2021 at 23:05)</a>:</h4>
<blockquote>
<p>My question is perhaps, do we want perfection to be the enemy of good?</p>
</blockquote>
<p>No, we want a coherent language that makes sense and that can be maintained going forward. We don't want ad-hoc language extensions that are insufficiently motivated.</p>
<p>Note that despite all I said above, <em>if there is clear evidence</em> that formatting things for const-time panics without the appropriate bounds would help a lot in practice, I would consider it a worthwhile tradeoff. But I think it is worth <em>trying</em> to do the principled, minimal, future-compatible thing first.<br>
This is the standard approach that Rust has followed many times, and it has served us well. If we can ship something that is clearly useful and future-compatible with more ambitious, but also more questionable / complicated / contentious proposals, then we ship the minimum thing and see how it fares in practice, and that serves as evidence for what is the best next step to take.</p>
<p>In fact I could turn your question around and ask if you want to make perfection (being able to format <em>all the things</em> in const-panics) be the enemy of the good (being able to format some things). Let's go for the good now and see if we want/need to reach perfection later. ;)</p>



<a name="262911445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262911445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262911445">(Nov 28 2021 at 05:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262897237">said</a>:</p>
<blockquote>
<p>Your patch makes formatting part of the language, by hard-coding it in the interpreter. So this is really not valid criticism IMO.<br>
In fact, making it part of the dynamics of the language (the interpreter) <em>without</em> also making it part of the static checks of the language (const-checking) is an awkward mismatch.</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262897324">said</a>:</p>
<blockquote>
<p>The fact that you have to change the interpreter shows very clearly that this <em>is</em> a part of the language. That's what it <em>means</em> to be part of the langauge -- that the interpreter needs special support for it.</p>
</blockquote>
<p>The compiler has all sorts of tricks to produce better diagnostics, and that doesn't make these part of the language.</p>



<a name="262911553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262911553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262911553">(Nov 28 2021 at 05:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262897387">said</a>:</p>
<blockquote>
<p>The concrete thing that you are making part of the language that I am objecting to is that using Display or Debug-formatting for a panic message in const code is allowed <em>even when the type in question does not const-implement the relevant trait</em>.<br>
How exactly the output of that panic looks like is not relevant for my concern. The fact that that code compiles and runs at all is my concern.</p>
</blockquote>
<p>I don't understand why it's a concern. I don't need to have a <code>const Debug</code> to produce a <code>Debug::fmt</code> function pointer in compile time. If how exactly the panic message looks is not relevant, why would a <code>cosnt Debug</code> bound be needed?</p>



<a name="262911671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262911671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262911671">(Nov 28 2021 at 05:50)</a>:</h4>
<p>There are zero language extensions here, and there's nothing non-coherent. I consider all the work I done in the interpreter be purely for diagnositcs, and only the library changes to be substantial.</p>



<a name="262911732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262911732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262911732">(Nov 28 2021 at 05:52)</a>:</h4>
<p>The whole interpreter changes can be removed and replace with some code that produces "const eval panicked". How is it a change to the language?</p>



<a name="262941365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262941365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262941365">(Nov 28 2021 at 18:22)</a>:</h4>
<blockquote>
<p>I don't need to have a const Debug to produce a Debug::fmt function pointer in compile time</p>
</blockquote>
<p>Yes, but you cannot call such a fn ptr either.<br>
You need a <code>const Debug</code> to produce a <code>const fn</code> ptr at compile time (which have not been implemented yet).<br>
So this is a total red herring, has nothing to do with calling functions without the appropriate bounds.</p>



<a name="262941457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262941457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262941457">(Nov 28 2021 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488/near/262911732">said</a>:</p>
<blockquote>
<p>The whole interpreter changes can be removed and replace with some code that produces "const eval panicked". How is it a change to the language?</p>
</blockquote>
<p>the fact that code like this compiles is a change to the language</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this code calls a non-const function (<code>&lt;T as Debug&gt;::fmt</code>) at const-time.<br>
I know there are hacks in the CTFE interpreter which mean that that non-const function is never actually called, but that does not solve the conceptual issue. We dont accept code like this either:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I view these two situations as fairly equivalent.</p>



<a name="262941717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/262941717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#262941717">(Nov 28 2021 at 18:30)</a>:</h4>
<p>At this point it seems clear that neither of us is going to convince the other that this change is a good idea / is a hacky language extension. there haven't really been new arguments in a while. but there is one point I keep making that you have not responded to (or maybe I missed that, in which case I apologize): if we had concrete evidence that the benefits of this change outweigh the problems some people see with it, that would make a huge difference for me. we could gather that evidence by stabilizing a restricted version and seeing how it fares in practice. yes, implementing the checks that enforce those restrictions will take work, but this is not the first time that "the checks implementing the restrictions" are the most tricky bit of a feature to get right (min_const_fn is another example of that -- we got a whole second const-checker for that!).</p>



<a name="263249360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/const%20panic%21%20for%20all%20types%20%2390488/near/263249360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/const.20panic!.20for.20all.20types.20.2390488.html#263249360">(Dec 01 2021 at 06:23)</a>:</h4>
<p>I'll try to gather some use cases when I have time.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>