<html>
<head><meta charset="utf-8"><title>Gurantees of `NonZeroU*` · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html">Gurantees of `NonZeroU*`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274728167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274728167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274728167">(Mar 09 2022 at 18:03)</a>:</h4>
<p>I can't find any docs anywhere that guarantee that <code>NonZeroU*</code> types are layout compatible with their <code>u*</code> analogues. I assume this is non-controversial though. Would there be any objections to a PR that adds this to std?</p>



<a name="274728499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274728499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274728499">(Mar 09 2022 at 18:05)</a>:</h4>
<p>If you look at the definition of the type you can a <code>repr(transparent)</code> attribute. It means that the layout (representation) of the type is the same as the underline one.</p>



<a name="274728669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274728669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274728669">(Mar 09 2022 at 18:06)</a>:</h4>
<p>I think they already guarantee the <code>Option&lt;NonZeroU##&gt;</code> layout, so yeah, it makes sense to guarantee it.</p>
<p>But exactly what "layout" means is vague (see the UCG threads), so you might want to say exactly what you mean by it in the PR instead of the word "layout".  Perhaps "same size and alignment".</p>



<a name="274728771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274728771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274728771">(Mar 09 2022 at 18:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60/near/274728499">said</a>:</p>
<blockquote>
<p>If you look at the definition of the type you can a <code>repr(transparent)</code> attribute.</p>
</blockquote>
<p>The definition of a type in the standard library is not necessarily a guarantee that it cannot change.  So generally the parts that <em>are</em> guaranteed should be in the prose.</p>



<a name="274728860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274728860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274728860">(Mar 09 2022 at 18:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60/near/274728499">said</a>:</p>
<blockquote>
<p>If you look at the definition of the type you can a <code>repr(transparent)</code> attribute. It means that the layout (representation) of the type is the same as the underline one.</p>
</blockquote>
<p>That isn't enough without knowing what the field is, and also we need to additionally guarantee that <code>NonZeroU8::new(value)</code> is stored as <code>value</code> and not as <code>value - 1</code></p>



<a name="274733956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274733956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274733956">(Mar 09 2022 at 18:47)</a>:</h4>
<p>Documenting that guarantee seems reasonable.</p>



<a name="274739948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274739948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274739948">(Mar 09 2022 at 19:29)</a>:</h4>
<p>Layout is, in addition to size and alignment, also the register type, which LLVM definitely uses and we preserve through repr(transparent) on purpose</p>



<a name="274740024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274740024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274740024">(Mar 09 2022 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60/near/274728860">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60/near/274728499">said</a>:</p>
<blockquote>
<p>If you look at the definition of the type you can a <code>repr(transparent)</code> attribute. It means that the layout (representation) of the type is the same as the underline one.</p>
</blockquote>
<p>That isn't enough without knowing what the field is, and also we need to additionally guarantee that <code>NonZeroU8::new(value)</code> is stored as <code>value</code> and not as <code>value - 1</code></p>
</blockquote>
<p>Fair, I didn't think of that.</p>



<a name="274741853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274741853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274741853">(Mar 09 2022 at 19:44)</a>:</h4>
<p>Incidentally they <em>could</em> implement AsRef&lt;zeroable_num_type&gt;, but it seems currently they do not.</p>



<a name="274742236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274742236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274742236">(Mar 09 2022 at 19:47)</a>:</h4>
<p>Oh, interesting idea.  <code>Deref</code> seems undesirable, but <code>AsRef</code> seems like it'd be ok.</p>
<p>(Not sure why anyone would ever take <code>AsRef&lt;u32&gt;</code>, though.)</p>



<a name="274743089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274743089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274743089">(Mar 09 2022 at 19:53)</a>:</h4>
<p>more likely AsRef&lt;T&gt; and then T happens to be u32 in some case</p>



<a name="274749287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274749287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274749287">(Mar 09 2022 at 20:40)</a>:</h4>
<p>definitely not <code>AsMut</code> though</p>



<a name="274752693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/274752693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#274752693">(Mar 09 2022 at 21:08)</a>:</h4>
<p>Though that might be an interesting way to do this documentation.</p>
<p>Add both of</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="nb">AsRef</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">NonZeroU32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="nb">AsMut</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">NonZeroU32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And comment on them the layout guaranteeds/restrictions that allow them to be done.</p>
<p>(Like how we have <code>impl !Clone for &amp;mut _</code> which is a great way to keep the compiler from ever suggesting to implement it, or potentially some day to point at in error messages for extra context.)</p>



<a name="276791941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/276791941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#276791941">(Mar 27 2022 at 14:46)</a>:</h4>
<p><code>#[repr(transparent)]</code> appears in rustdoc output.</p>



<a name="276791987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/Gurantees%20of%20%60NonZeroU%2A%60/near/276791987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/Gurantees.20of.20.60NonZeroU*.60.html#276791987">(Mar 27 2022 at 14:47)</a>:</h4>
<p>Ah, never mind, that has already been discussed…</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>