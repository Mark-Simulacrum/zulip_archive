<html>
<head><meta charset="utf-8"><title>`malloc_usable_size` and better Vec sizing · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html">`malloc_usable_size` and better Vec sizing</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263957067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957067">(Dec 07 2021 at 04:24)</a>:</h4>
<p>The <code>Allocator</code> trait has methods like this:</p>



<a name="263957074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957074">(Dec 07 2021 at 04:24)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">NonNull</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">AllocErrrust</span><span class="w"></span>
</code></pre></div>



<a name="263957101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957101">(Dec 07 2021 at 04:25)</a>:</h4>
<p>This has scope for the actual size allocated being different (larger) than the requested size. But in practice the size of the <code>NonNull&lt;[u8]&gt;</code> is always the same as the requested size.</p>



<a name="263957154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957154">(Dec 07 2021 at 04:26)</a>:</h4>
<p>I'm wondering if it's possible to make the actual size returned take advantage of malloc_usable_size or something similar. I did this in the past with Firefox and it was quite effective, particularly for things like <code>Vec</code>.</p>



<a name="263957225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957225">(Dec 07 2021 at 04:28)</a>:</h4>
<p>E.g. imagine you have a <code>Vec</code> where the element are 72 bytes in size, and  you resize it to 16 elements. That's 1152 bytes. In practice the allocator might round this up to 1536 bytes, so you could actually fit 21 elements in that space.</p>



<a name="263957236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957236">(Dec 07 2021 at 04:28)</a>:</h4>
<p>In practice I think the split between <code>Allocator</code> and <code>GlobalAlloc</code> may make things difficult.</p>



<a name="263957262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957262">(Dec 07 2021 at 04:29)</a>:</h4>
<p>The latter is what knows about the internals of the allocator implementation, and so can provide answers to questions like "exactly how much memory did I really allocate for that request". But it has methods like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="263957310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957310">(Dec 07 2021 at 04:30)</a>:</h4>
<p>The raw pointer return value doesn't allow for the size info to be returned easily.</p>



<a name="263957316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263957316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263957316">(Dec 07 2021 at 04:30)</a>:</h4>
<p>Anyway, I'm wondering if people have considered this previously, if I'm overlooking anything, etc.</p>



<a name="263958204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263958204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263958204">(Dec 07 2021 at 04:49)</a>:</h4>
<p>Maybe <code>Allocator</code> could gain new method that return the size too, defaulting to the same size requested.</p>



<a name="263958278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263958278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263958278">(Dec 07 2021 at 04:50)</a>:</h4>
<p>Hmm, the unstable methods do return pointer slices, so you could set a real useable size there.</p>



<a name="263958417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263958417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263958417">(Dec 07 2021 at 04:53)</a>:</h4>
<p>I see what you mean now, the <code>Allocator</code> trait makes it possible but <code>GlobalAlloc</code> does not</p>



<a name="263958506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263958506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263958506">(Dec 07 2021 at 04:54)</a>:</h4>
<p>Couldn't we still add new methods to that though?</p>



<a name="263961304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263961304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263961304">(Dec 07 2021 at 05:45)</a>:</h4>
<p>Yes!!! I've been complaining about this for sooooo long!</p>
<ul>
<li><a href="https://github.com/rust-lang/wg-allocators/issues/74">https://github.com/rust-lang/wg-allocators/issues/74</a></li>
<li><a href="https://github.com/rust-lang/wg-allocators/issues/75">https://github.com/rust-lang/wg-allocators/issues/75</a></li>
<li>probably some threads on zulip</li>
</ul>
<p>The current design is not good for high performance. Either it has to assume the caller will need the size info, or return the requested size. Eitehr of these are bad unless your allocator can return it without any cos</p>



<a name="263968998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/%60malloc_usable_size%60%20and%20better%20Vec%20sizing/near/263968998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/.60malloc_usable_size.60.20and.20better.20Vec.20sizing.html#263968998">(Dec 07 2021 at 08:05)</a>:</h4>
<p>I would have thought that returning the actual size was easy to do as part of the alloc() call. Certainly easier than determining the actual size in a separate option afterwards</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>