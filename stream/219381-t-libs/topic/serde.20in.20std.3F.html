<html>
<head><meta charset="utf-8"><title>serde in std? · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html">serde in std?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260668884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260668884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260668884">(Nov 08 2021 at 15:05)</a>:</h4>
<p>I'm working on patches to add a new target to std. The target's ABI includes some CBOR. Would it be ok to add serde and serde_cbor to std (for this target only)? The alternative would be to write/vendor some minimal CBOR implementation</p>



<a name="260671018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260671018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260671018">(Nov 08 2021 at 15:20)</a>:</h4>
<p>cbor in the abi? what target are you working on?</p>



<a name="260671152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260671152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260671152">(Nov 08 2021 at 15:21)</a>:</h4>
<p>a new target for amazon nitro enclaves</p>



<a name="260690789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260690789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260690789">(Nov 08 2021 at 17:32)</a>:</h4>
<p>where would <code>std</code> be manually dealing with ABI?</p>



<a name="260692339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260692339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260692339">(Nov 08 2021 at 17:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> has marked this topic as resolved.</p>



<a name="260692342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260692342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260692342">(Nov 08 2021 at 17:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> has marked this topic as unresolved.</p>



<a name="260692393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260692393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260692393">(Nov 08 2021 at 17:43)</a>:</h4>
<p>(err, sorry, i didn't mean to click that button <span aria-label="sweat" class="emoji emoji-1f613" role="img" title="sweat">:sweat:</span>)</p>



<a name="260692463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260692463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260692463">(Nov 08 2021 at 17:44)</a>:</h4>
<p>Isn't <code>serde_cbor</code> looking for a maintainer?</p>



<a name="260713862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260713862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260713862">(Nov 08 2021 at 20:25)</a>:</h4>
<p>If you add serde you should disable serde_derive I think. Having proc macros as part of the standard library build will make the compiled standard library only work with a single host compiler (and not with the host compiler for all targets) I think as proc macros need to be compiled for the host and rustc tries to load all proc macros used by a crate when loading the crate. Rustc itself already has a hack (<code>-Zdual-proc-macro</code>) to make allow it to use proc macros while still being able to cross compile. However unlike for libstd, we don't support cross compiling code linking against internal rustc libraries anyway AFAIK.</p>



<a name="260713942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260713942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260713942">(Nov 08 2021 at 20:25)</a>:</h4>
<p>Using serde without serde_derive is pretty verbose though, so maybe writing your own cbor implementation is the best option?</p>



<a name="260717594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260717594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260717594">(Nov 08 2021 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> in std::net<br>
<span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span> yeah I guess we would be using a different CBOR crate</p>



<a name="260717946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260717946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260717946">(Nov 08 2021 at 20:58)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span></p>
<blockquote>
<p>Having proc macros as part of the standard library build will make the compiled standard library only work with a single host compiler (and not with the host compiler for all targets)</p>
</blockquote>
<p>really? the proc macros aren't evaluated at compile time?</p>



<a name="260718044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718044">(Nov 08 2021 at 20:59)</a>:</h4>
<p>They are, but it is possible to re-export proc macros, so they still need to be registered as dependencies.</p>



<a name="260718170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718170">(Nov 08 2021 at 21:00)</a>:</h4>
<p>I guess we could use a build script instead, but that seems... not ideal</p>



<a name="260718191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718191">(Nov 08 2021 at 21:00)</a>:</h4>
<p>It is possible that it will work if you don't re-export any proc-macro, but I would be somewhat surprised if such a special case exists.</p>



<a name="260718307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718307">(Nov 08 2021 at 21:01)</a>:</h4>
<p>Do you only need to deserialize structs, or also enums?</p>



<a name="260718351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718351">(Nov 08 2021 at 21:01)</a>:</h4>
<p>If only structs, maybe it would be possible to write a <code>macro_rules!</code> macro?</p>



<a name="260718391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718391">(Nov 08 2021 at 21:01)</a>:</h4>
<p>there are enums, but the structures/enums are pretty simple, so it's certainly possible to not use serde</p>



<a name="260718468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718468">(Nov 08 2021 at 21:02)</a>:</h4>
<p>it's just less nice</p>



<a name="260718621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260718621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260718621">(Nov 08 2021 at 21:03)</a>:</h4>
<blockquote>
<p>They are, but it is possible to re-export proc macros, so they still need to be registered as dependencies.</p>
</blockquote>
<p>I see. For some reason I thought there was only one big rlib that contained everything, but checking some installed targets I do see now that every dependency of std is included as an rlib in the distribution</p>



<a name="260723439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260723439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260723439">(Nov 08 2021 at 21:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138938">Jethro</span> <a href="#narrow/stream/219381-t-libs/topic/serde.20in.20std.3F/near/260717594">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> in std::net</p>
</blockquote>
<p>so you mean something in the system's networking API and ABI requires CBOR?<br>
(I was thinking of lower level ABI at first, like calling conventions)</p>



<a name="260724439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260724439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260724439">(Nov 08 2021 at 21:56)</a>:</h4>
<p>yeah no, not calling conventions. more like DNS resolution</p>



<a name="260724799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260724799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260724799">(Nov 08 2021 at 21:59)</a>:</h4>
<p>well I suppose you could say that this is technically the calling convention for some RPC</p>



<a name="260734666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260734666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260734666">(Nov 08 2021 at 23:35)</a>:</h4>
<p>Hm, if we include proc macros in libstd, it would also break -Zbuild-std on at least musl linux with static CRT (which is the default).</p>



<a name="260734714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260734714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260734714">(Nov 08 2021 at 23:35)</a>:</h4>
<p>Ah, right, this would only be relevant to this new target, so that's probably fine</p>



<a name="260734790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260734790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260734790">(Nov 08 2021 at 23:36)</a>:</h4>
<p>I still suspect that if it's not that bad to do it manually, there are enough reasons to justify doing so.</p>



<a name="260738783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260738783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260738783">(Nov 09 2021 at 00:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138938">Jethro</span> <a href="#narrow/stream/219381-t-libs/topic/serde.20in.20std.3F/near/260668884">said</a>:</p>
<blockquote>
<p>I'm working on patches to add a new target to std. The target's ABI includes some CBOR. Would it be ok to add serde and serde_cbor to std (for this target only)? The alternative would be to write/vendor some minimal CBOR implementation</p>
</blockquote>
<p>Note that <code>serde_cbor</code> isn't currently actively maintained, and needs help. Making std depend on it for a target would add more pressure. I think if you're considering doing this, the plan would <em>have</em> to include volunteering to help maintain it and fix any outstanding issues.</p>



<a name="260738831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260738831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260738831">(Nov 09 2021 at 00:25)</a>:</h4>
<p>See the note at the top of <a href="https://crates.io/crates/serde_cbor">https://crates.io/crates/serde_cbor</a> .</p>



<a name="260739490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260739490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260739490">(Nov 09 2021 at 00:34)</a>:</h4>
<p>Which references <a href="https://crates.io/crates/ciborium">https://crates.io/crates/ciborium</a> . (And minicbor, but that's under an unusual non-standard license.)</p>



<a name="260766349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/serde%20in%20std%3F/near/260766349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jethro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/serde.20in.20std.3F.html#260766349">(Nov 09 2021 at 08:23)</a>:</h4>
<p>Noted</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>