<html>
<head><meta charset="utf-8"><title>float total_cmp · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html">float total_cmp</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269486851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269486851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269486851">(Jan 26 2022 at 21:42)</a>:</h4>
<p>Following up from <a href="https://github.com/rust-lang/rust/issues/72599">https://github.com/rust-lang/rust/issues/72599</a> , once total_cmp is stabilized, would there be any objections to adding a <code>sort_float</code> method on <code>Vec&lt;f32&gt;</code> and <code>Vec&lt;f64&gt;</code>, which just calls <code>sort_by</code>? That would help people doing floating-point operations on Rust to know what they should use.</p>



<a name="269487431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269487431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269487431">(Jan 26 2022 at 21:47)</a>:</h4>
<p>(if we'll add <code>sort_float</code> we should probably add it to <code>[f32]</code> and not <code>Vec&lt;f32&gt;</code>)</p>



<a name="269487438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269487438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269487438">(Jan 26 2022 at 21:47)</a>:</h4>
<p>It should be on <code>&amp;mut [f]</code>, but that sounds good to me.</p>



<a name="269487523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269487523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269487523">(Jan 26 2022 at 21:48)</a>:</h4>
<p>sort_unstable_by, presumably?</p>
<p>It feels rather unfortunate to add a new method -- particularly one that will not get well-sorted in rustdoc or easily discoverable (since the name isn't sort_f32, searching for f32 wouldn't help you...)</p>
<p>It might make sense to add a rustc_on_unimplemented attribute  on Ord  for floats that suggests total_cmp, and some custom code that gives you the one-line snippet for sort_by with total_cmp as the argument (on <code>[f32].sort()</code> in particular), maybe.</p>



<a name="269487651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269487651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269487651">(Jan 26 2022 at 21:49)</a>:</h4>
<p>It could be called <code>sort_f32</code> / <code>sort_f64</code></p>



<a name="269487850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269487850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269487850">(Jan 26 2022 at 21:51)</a>:</h4>
<p>Using <code>sort_unstable_by</code> also means it can go in <code>core</code></p>



<a name="269488100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488100">(Jan 26 2022 at 21:53)</a>:</h4>
<p>Does <code>total_cmp</code> even provide order for different bit patterns of NaN?</p>



<a name="269488296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488296">(Jan 26 2022 at 21:54)</a>:</h4>
<p>Inner comments say yes, it follows bitwise order.</p>



<a name="269488417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488417">(Jan 26 2022 at 21:55)</a>:</h4>
<p>Also, quote from the documentation:</p>
<blockquote>
<p>The values are ordered in following order:</p>
<ul>
<li>Negative quiet NaN</li>
<li>Negative signaling NaN</li>
<li>Negative infinity</li>
<li>Negative numbers</li>
<li>Negative subnormal numbers</li>
<li>Negative zero</li>
<li>Positive zero</li>
<li>Positive subnormal numbers</li>
<li>Positive numbers</li>
<li>Positive infinity</li>
<li>Positive signaling NaN</li>
<li>Positive quiet NaN</li>
</ul>
</blockquote>



<a name="269488589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488589">(Jan 26 2022 at 21:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269487651">said</a>:</p>
<blockquote>
<p>It could be called <code>sort_f32</code> / <code>sort_f64</code></p>
</blockquote>
<p>It'd be on a type that contains an <code>f32</code> or <code>f64</code>, and there's lots of precedent for having the same methods on different numeric types.</p>



<a name="269488686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488686">(Jan 26 2022 at 21:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269487523">said</a>:</p>
<blockquote>
<p>sort_unstable_by, presumably?</p>
</blockquote>
<p>Right, yes.</p>



<a name="269488700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488700">(Jan 26 2022 at 21:57)</a>:</h4>
<p>I thought that and then didn't end up typing it. :)</p>



<a name="269488782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488782">(Jan 26 2022 at 21:58)</a>:</h4>
<p><code>sort_total</code>?</p>



<a name="269488839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488839">(Jan 26 2022 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> That seems less discoverable.</p>



<a name="269488868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488868">(Jan 26 2022 at 21:58)</a>:</h4>
<p>Part of the notion here was "I have a collection that has a sort method, but I can't sort floats...oooh, there's a method named "sort_float", that's what I want."</p>



<a name="269488943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269488943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269488943">(Jan 26 2022 at 21:59)</a>:</h4>
<p><span class="user-mention" data-user-id="273349">@Waffle Lapkin</span> there are more bit patterns of NaN than simply +/- quiet/signaling</p>



<a name="269489078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269489078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269489078">(Jan 26 2022 at 22:00)</a>:</h4>
<p>That's fine, just offering shed colors</p>



<a name="269491605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269491605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269491605">(Jan 26 2022 at 22:19)</a>:</h4>
<p>The other thing that would make this easier to use would be to make <code>.sort_by_key(|x| (x.some_float.total_cmp_key(), x.other_thing))</code> work -- that's much less annoying to actually use than <code>sort_by</code>, in basically every case I've hit.  But deciding a return type for that is harder than defining <code>total_cmp</code> was.</p>
<p>Arguably it could just be called <code>.sort_unstable()</code>, the same way that there's <code>min</code> on <code>f32</code> different from <code>Ord::min</code>.</p>
<p>I do like simulacrum's suggestion of a diagnostic, though.  It could mention <code>.sort_unstable_by(f32::total_cmp)</code> but also the possibility of <code>.sort_unstable_by(|a, b| PartialCmp::partial_cmp(a, b).unwrap())</code>.</p>



<a name="269494176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269494176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269494176">(Jan 26 2022 at 22:44)</a>:</h4>
<p>why not just have <code>f32::total_cmp_key()</code> return <code>i32</code> and <code>f64::total_cmp_key()</code> return <code>i64</code>? that's basically what <code>total_cmp</code> does internally anyway</p>



<a name="269495567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269495567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269495567">(Jan 26 2022 at 22:58)</a>:</h4>
<p>Yeah, there are also a lot of uses for the operation that total_cmp performs internally — that is to say, ideally total_cmp_key would return u64/u32 (depending on the float type), rather than a wrapper.</p>
<p>EDIT: didn't see Jacobs post. i32/i64 is fine too.</p>



<a name="269495898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269495898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269495898">(Jan 26 2022 at 23:00)</a>:</h4>
<p>is there a function for the equivalent of <code>reinterpret_cast&lt;u64&gt;(x: f64)</code>? <code>x as u64</code> does float conversion so it's not ideal here</p>



<a name="269495976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269495976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269495976">(Jan 26 2022 at 23:01)</a>:</h4>
<p><code>to_bits</code>, but it's not equivalent to the total key</p>



<a name="269495997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269495997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269495997">(Jan 26 2022 at 23:01)</a>:</h4>
<p>I guess <code>total_cmp_key</code> is just a bit more complicated than that because it has to swap positive and negative IIRC</p>



<a name="269496049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269496049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269496049">(Jan 26 2022 at 23:01)</a>:</h4>
<p>there's a big explanation of what it does: <a href="https://doc.rust-lang.org/src/core/num/f32.rs.html#1053">https://doc.rust-lang.org/src/core/num/f32.rs.html#1053</a></p>



<a name="269497172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269497172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269497172">(Jan 26 2022 at 23:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269494176">said</a>:</p>
<blockquote>
<p>that's basically what <code>total_cmp</code> does internally anyway</p>
</blockquote>
<p>Yeah, but it's not obvious to me that that fact makes sense to expose -- <code>x.total_cmp_key() &gt; 4</code> compiling is non-great.  It could potentially just be <code>-&gt; impl Ord + Copy</code>, for example.  (And if we had TAIT that might be enough.)  But then there's a bunch of other questions about that like whether it should have had <code>Hash</code> and <code>Debug</code> and ...</p>



<a name="269497390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269497390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269497390">(Jan 26 2022 at 23:14)</a>:</h4>
<p>I've wanted this when performing non-comparison based sort (for example, radix/bucket sort). It's not too much work to implement manually, but it also is already implemented in the standard library, and it's unclear that the abstraction barrier here is actually very useful.</p>



<a name="269497898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269497898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269497898">(Jan 26 2022 at 23:19)</a>:</h4>
<p>That said a wrapper that can be converted into the integer type with From/Into would be acceptable for this too.</p>



<a name="269544030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269544030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269544030">(Jan 27 2022 at 09:20)</a>:</h4>
<p>This sounds like a really good convenience method to have! (and worth having over the sort_by  desugaring for beginners, readability, and because it is a common thing to do) My 2c on naming is that since total_cmp is specific to floats (i.e., is an inherent method, not a trait one) that sort_float is the right name (rather than sort_total) and _float is better than _f32/_f64 because it is more flexible and readible and consistent with other naming of numeric functions.</p>



<a name="269657917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269657917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269657917">(Jan 27 2022 at 23:36)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/93397">https://github.com/rust-lang/rust/pull/93397</a></p>



<a name="269657929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269657929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269657929">(Jan 27 2022 at 23:36)</a>:</h4>
<p>Tracking issue at <a href="https://github.com/rust-lang/rust/issues/93396">https://github.com/rust-lang/rust/issues/93396</a></p>



<a name="269665951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269665951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269665951">(Jan 28 2022 at 00:55)</a>:</h4>
<blockquote>
<p>This sounds like a really good convenience method to have! (and worth having over the sort_by  desugaring for beginners, readability, and because it is a common thing to do) My 2c on naming is that since total_cmp is specific to floats (i.e., is an inherent method, not a trait one) that sort_float is the right name (rather than sort_total) and _float is better than _f32/_f64 because it is more flexible and readible and consistent with other naming of numeric functions.</p>
</blockquote>
<p>I would say that <code>_float</code> in <code>sort_float</code> is superfluous piece of information given that the type is already float. Also, what if there comes up other sensible and convincing ways to order floats in a ways other than by <code>totalOrder</code>?</p>



<a name="269665971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269665971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269665971">(Jan 28 2022 at 00:55)</a>:</h4>
<p>In that case <code>sort_float</code> would seem like insufficiently precise, to me at least.</p>



<a name="269667947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269667947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269667947">(Jan 28 2022 at 01:16)</a>:</h4>
<p>there's definitely an argument that people might often prefer <code>.sort_unstable_by_key(|x| (x.is_nan(), x.total_cmp_key())</code> or something.</p>
<p>Or, going further, it could be something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">sort_float</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">().</span><span class="n">partition_in_place</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">is_nan</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="o">..</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">sort_by</span><span class="p">(</span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">PartialOrd</span>::<span class="n">partial_cmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">).</span><span class="n">unwrap_unchecked</span><span class="p">()</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>&lt;<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=0c4e163e0fb051e1e489b57f5539a7fe">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=0c4e163e0fb051e1e489b57f5539a7fe</a>&gt;</p>



<a name="269668766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269668766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269668766">(Jan 28 2022 at 01:25)</a>:</h4>
<p>A large segment of float users generally do not want NaNs to disappear. They may want to cast NaNs to one of 0.0, 1.0, or Infinity, possibly with a sign.</p>



<a name="269677511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269677511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269677511">(Jan 28 2022 at 02:17)</a>:</h4>
<p>Note that if you ignore the returned slice then that <code>sort_float</code> sketch I put up <em>does</em> keep them.</p>



<a name="269684015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269684015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269684015">(Jan 28 2022 at 04:05)</a>:</h4>
<p>I feel like this would be too... idiosyncratic for the stdlib?</p>



<a name="269706190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269706190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269706190">(Jan 28 2022 at 09:09)</a>:</h4>
<p>Hmm, by the same reasoning, there are other total orderings of the floats which make sense, so I think sort_total or similar are also sub-optimal. Is there a way to describe the ordering which would label it definitively (like is it officially the Hoare-Djikstra-73 ordering, or something)?</p>



<a name="269706529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269706529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269706529">(Jan 28 2022 at 09:12)</a>:</h4>
<p>it's officially the "<code>totalOrder</code>" predicate from ieee754 2019 (and probably 2008 — I don't have a copy on this machine and don't feel like looking).</p>
<p>which doesn't particularly help, i know.</p>



<a name="269710083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269710083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269710083">(Jan 28 2022 at 09:43)</a>:</h4>
<p>call the function <code>sort_ieee754</code>?</p>



<a name="269711355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269711355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269711355">(Jan 28 2022 at 09:55)</a>:</h4>
<p>That's just a confusing mess of letters and numbers to the average user.</p>



<a name="269712024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269712024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269712024">(Jan 28 2022 at 10:00)</a>:</h4>
<p>That doesn’t seem like a massive downside? It starts with sort_ which is the important thing and it is very specific</p>



<a name="269712091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269712091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269712091">(Jan 28 2022 at 10:01)</a>:</h4>
<p>Put it another way, we’re describing a sort using an arbitrary ordering, so I’m not sure we can do better for a name than an arbitrary jumble of letters and numbers</p>



<a name="269712244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269712244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269712244">(Jan 28 2022 at 10:02)</a>:</h4>
<p>(And for a lot of users who just want to sort some floats, talking about total orderings, etc is just as confusing a mess of letters)</p>



<a name="269712568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269712568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269712568">(Jan 28 2022 at 10:05)</a>:</h4>
<p>The lowest-commitment form would be to just special-case a diagnostic.</p>
<p>I wonder if this would work...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[rustc_on_unimplemented(</span>
<span class="cp">    on(</span>
<span class="cp">        all(_Self=</span><span class="s">"f32"</span><span class="cp">, from_method=</span><span class="s">"sort_unstable"</span><span class="cp">),</span>
<span class="cp">        note = </span><span class="s">"consider using `.sort_unstable_by(f32::total_cmp)`"</span><span class="cp">,</span>
<span class="cp">    ),</span>
<span class="cp">    on(</span>
<span class="cp">        all(_Self=</span><span class="s">"f32"</span><span class="cp">, from_method=</span><span class="s">"sort"</span><span class="cp">),</span>
<span class="cp">        note = </span><span class="s">"consider using `.sort_by(f32::total_cmp)`"</span><span class="cp">,</span>
<span class="cp">    ),</span>
<span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">Ord</span><span class="w"></span>
</code></pre></div>



<a name="269713020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269713020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269713020">(Jan 28 2022 at 10:09)</a>:</h4>
<p>That seems not terrible, but also not great. This seems like the kind of simple operation that it is worth making really ergonomic even if it means papering over some details for the sake of making the beginner/casual user experience smoother</p>



<a name="269713748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269713748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269713748">(Jan 28 2022 at 10:16)</a>:</h4>
<p>Yeah, its primary goodness is that it can go in and start helping immediately without fcp.</p>
<p><code>f32::min</code> is precedent for just picking one and giving it the same name as the <code>Ord</code> version, FWIW.  To me the "really ergonomic" version is just letting <code>.sort_unstable()</code> and <code>.sort()</code> work, by defining a specific inherent method on <code>[f32]</code> and <code>[f64]</code>.  (And if we can't do that today, we could with <a href="https://github.com/rust-lang/negative-impls-initiative/issues/1">https://github.com/rust-lang/negative-impls-initiative/issues/1</a> )</p>



<a name="269757805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269757805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269757805">(Jan 28 2022 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269713748">said</a>:</p>
<blockquote>
<p><code>f32::min</code> is precedent for just picking one and giving it the same name as the <code>Ord</code> version, FWIW.  To me the "really ergonomic" version is just letting <code>.sort_unstable()</code> and <code>.sort()</code> work, by defining a specific inherent method on <code>[f32]</code> and <code>[f64]</code>.</p>
</blockquote>
<p>As long as we're clear that this kind of "just works" is only for concrete types, not possible for generic code on <code>[T]</code> -- but that's also true of <code>min</code></p>



<a name="269764797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269764797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269764797">(Jan 28 2022 at 16:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269710083">said</a>:</p>
<blockquote>
<p>call the function <code>sort_ieee754</code>?</p>
</blockquote>
<p>IEEE754 also defines other comparisons though — this is actually <em>more</em> vague, IMO.</p>



<a name="269786828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269786828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269786828">(Jan 28 2022 at 19:08)</a>:</h4>
<p>I don't object to just calling it <code>sort</code>, as long as that doesn't require substantial compiler magic.</p>



<a name="269787419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269787419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269787419">(Jan 28 2022 at 19:13)</a>:</h4>
<p>It'll probably require a bit of compiler magic no matter what we call it, because writing <code>impl [f32]</code> even in core needs a lang item.</p>



<a name="269788674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269788674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269788674">(Jan 28 2022 at 19:22)</a>:</h4>
<p>I've already added that part. :)</p>



<a name="269788709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269788709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269788709">(Jan 28 2022 at 19:23)</a>:</h4>
<p>I meant, <em>more</em> magic to handle having <code>sort</code> on both <code>[T] where T: Ord</code> and <code>[f32]</code>.</p>



<a name="269789683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269789683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269789683">(Jan 28 2022 at 19:30)</a>:</h4>
<p>Hmm, trying <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=a99d3d45844ae80909e8368411f99ea1">something similar in playground</a> gives</p>
<div class="codehilite"><pre><span></span><code>note: upstream crates may add a new impl of trait `std::cmp::Ord` for type `f32` in future versions
</code></pre></div>
<p>so I think that implies it just needs <code>impl !Ord for f32</code> and already-in-the-works magic <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="269790687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269790687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269790687">(Jan 28 2022 at 19:38)</a>:</h4>
<p>I'm going to go ahead and finish getting the implementation working as <code>sort_floats</code>, but I'd be happy to change that to <code>sort</code> if negative impls are available. I'm also happy to add a blocking item to the tracking issue to say that change needs to be made before stabilization, if negative impls aren't ready yet.</p>



<a name="269791177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269791177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269791177">(Jan 28 2022 at 19:42)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> Trying to use a negative impl resulted in:</p>
<blockquote>
<p>error[E0658]: negative trait bounds are not yet fully implemented; use marker types for now</p>
</blockquote>



<a name="269791189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269791189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269791189">(Jan 28 2022 at 19:42)</a>:</h4>
<p>Not sure what using marker types looks like.</p>



<a name="269791197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269791197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269791197">(Jan 28 2022 at 19:42)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span></p>



<a name="269791333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269791333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269791333">(Jan 28 2022 at 19:43)</a>:</h4>
<p>Odd that it would mention negative <em>bounds</em>, since we already have negative impls in <code>core</code> like &lt;<a href="https://doc.rust-lang.org/nightly/std/clone/trait.Clone.html#impl-Clone-126">https://doc.rust-lang.org/nightly/std/clone/trait.Clone.html#impl-Clone-126</a>&gt;</p>



<a name="269791431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269791431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269791431">(Jan 28 2022 at 19:44)</a>:</h4>
<p>But the coherence part of negative impls isn't done yet, afaik, so it might not work until that's done.</p>



<a name="269792379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269792379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269792379">(Jan 28 2022 at 19:51)</a>:</h4>
<p>Then I'm going to try to avoid tying the two together, and just note in the tracking issue that we could change that.</p>



<a name="269796561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269796561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269796561">(Jan 28 2022 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269789683">said</a>:</p>
<blockquote>
<p>Hmm, trying <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=a99d3d45844ae80909e8368411f99ea1">something similar in playground</a> gives</p>
<div class="codehilite"><pre><span></span><code>note: upstream crates may add a new impl of trait `std::cmp::Ord` for type `f32` in future versions
</code></pre></div>
<p>so I think that implies it just needs <code>impl !Ord for f32</code> and already-in-the-works magic <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
</blockquote>
<p>that should fare better when done <em>in</em> <code>core</code>, as it is also the source of <code>Ord</code></p>



<a name="269796579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269796579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269796579">(Jan 28 2022 at 20:18)</a>:</h4>
<p>your example works with a local <code>MyOrd</code></p>



<a name="269797010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269797010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269797010">(Jan 28 2022 at 20:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269791177">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> Trying to use a negative impl resulted in:</p>
<blockquote>
<p>error[E0658]: negative trait bounds are not yet fully implemented; use marker types for now</p>
</blockquote>
</blockquote>
<p>I need to read what all this is about but I guess this error shows up because the feature gate is not enabled ?</p>



<a name="269797119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269797119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269797119">(Jan 28 2022 at 20:22)</a>:</h4>
<p>(don't need the negative bound when <code>Ord</code> is local though)</p>



<a name="269797179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269797179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269797179">(Jan 28 2022 at 20:23)</a>:</h4>
<p>would need to read the thread :)</p>



<a name="269797335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269797335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269797335">(Jan 28 2022 at 20:24)</a>:</h4>
<p>just saw the mention, saw the error and if you check the source code is doing <a href="https://github.com/rust-lang/rust/blob/427eba2f0bacdeaebc992a78eb2889564de7d7cf/compiler/rustc_ast_passes/src/feature_gate.rs#L434-L442">https://github.com/rust-lang/rust/blob/427eba2f0bacdeaebc992a78eb2889564de7d7cf/compiler/rustc_ast_passes/src/feature_gate.rs#L434-L442</a></p>



<a name="269798185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269798185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269798185">(Jan 28 2022 at 20:31)</a>:</h4>
<p>hmm, but if <code>core</code> adds <code>fn sort</code> for floats, maybe that will make <code>alloc</code> fail on its <code>fn sort</code> for <code>T: Ord</code></p>



<a name="269819762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269819762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269819762">(Jan 28 2022 at 23:49)</a>:</h4>
<p>fwiw I tried that, and it built fine. I'm guessing <code>lang = "slice_alloc"</code> sidesteps that coherency</p>



<a name="269848655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269848655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269848655">(Jan 29 2022 at 08:17)</a>:</h4>
<p>How about adding a trait <code>SortOrd</code> for types that want to implement a sort-order that might be different from a <code>PartialOrd</code> implementation. Give it a default implementation based on <code>Ord</code>, and give <code>sort</code> function a <code>T: SortOrd</code> bound? Then (eventually, once stabilized) every downstream library defining float-like types that have a <code>PartialOrd</code>-but-not-<code>Ord</code> overloading of comparison operators will be able to have it supported by sorting functions, too. It also doesn't require negative implementation, and should be backwards compatible. Unless I'm missing something.</p>



<a name="269848747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269848747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269848747">(Jan 29 2022 at 08:19)</a>:</h4>
<p>Also, I guess <code>total_cmp</code> could just be a method of that trait then <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="269852165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269852165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269852165">(Jan 29 2022 at 09:30)</a>:</h4>
<p>That's not the split I usually want, though.  To me the one I really want is the "I want to use BTreeMap but there isn't a meaningful order" -- like I'd be happy for <code>Result</code> to <em>not</em> be <code>PartialOrd</code>, because I never want to write <code>&lt;</code> between results.</p>
<p>But I think really the first thing we should have is <code>NonNanF32</code> &amp; <code>NonNanF64</code> that just work normally.  Because those can be <code>Ord</code> no problem, and will sort without issue.</p>
<p>(And it would be relatively easy to compute in <code>f32</code>, then store <code>NonNanF32</code> at the end, or something)</p>



<a name="269859789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269859789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269859789">(Jan 29 2022 at 11:59)</a>:</h4>
<p>For “*Map” types (i.e. <code>BTreeMap</code> or <code>HashMap</code>), I’m not sure whether NaN keys are a good idea. Do you want to differentiate different NaNs or not? And equality testing on floats is usually questionable anyways. Perhaps <code>BTreeMap</code> has some more/better use-cases since it also allows operations such as accessing all entries in a given range.</p>
<p>Sorting, particularly unstable sorting, seems way less problematic than “*Map” types; things that are equal are sorted in an unpredictable order anyways, this generalizes neatly to: things that are <em>roughly</em> equal are sorted in a hard-to-predict order, based on rounding errors.</p>
<p>I agree with the sentiment that it's a bit unfortunate that <code>Ord</code> implementations for the sake of using <code>BTreeMap</code> (or other ordering-based data structures) are coupled to <code>Ord</code> implementations for the sake of introducing/overloading the <code>&lt;</code>/<code>&gt;</code>/<code>&lt;=</code>/<code>&gt;=</code> operators, but I feel like that ship has sailed, since there’s already a lot of types that implement <code>Ord</code> and support comparison operators even though it’s not really necessary.</p>
<hr>
<p>My <em>main</em> point in my post above was anyways that using a trait with a glob implementation based on <code>Ord</code> should remove the need for using negative implementations in order to support re-using the same <code>.sort_unstable</code>/<code>.sort</code> method for slices of floats. Whether or not the trait is made stable / user-implementable any time soon is not even that relevant. If we get “inherent traits implementations” eventually, then <code>total_cmp</code> could even be neatly migrated from inherent methods to trait methods in the future without breakage. Instead of a <code>SortOrd[er]</code> trait, it could even be named more narrowly as something like <code>SliceSort</code>, similar to the <code>SliceIndex</code> trait, with the sole main purpose of being used for slice's <code>.sort*</code> methods.</p>



<a name="269874546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269874546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269874546">(Jan 29 2022 at 16:40)</a>:</h4>
<p>If you just want to put it in a BTreeMap then isn't basically any ordering fine? Like you could just newtype it to use the bit ordering? It's a pain of course for the newtype to be in there, but it'd work and be consistent and even be NaN friendly.</p>



<a name="269875755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269875755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269875755">(Jan 29 2022 at 17:03)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span>  Using comparison of bit-patterns for NaN values in a map seems like a terrible idea, in light of issues such as the problems described in <a href="https://github.com/rust-lang/rust/issues/73328">#73328</a>.</p>
<p>While for sorting alone, as I explained above, this can still be reasonably explained along the lines of “well, the sorting is kind-of unstable around NaNs, so please don't rely on their particular relative order too much”, as soon as you start using NaNs as keys in a map, in my view the negative consequences are severe enough that such an approach should be strongly discouraged. Newtypes that treat all NaNs the same are in my view far better, as e.g. the newtypes provided by the popular <a href="https://crates.io/crates/ordered-float">ordered-float</a> crate, which has one newtype <code>OrderedFloat</code> that classifies all NaNs as <code>Equal</code>, and another newtype <code>NotNan</code> that forbids NaN values entirely. Even then, using these as keys can be questionable, depending on how you’d like to obtain the keys you want to look up… certainly any kind of floating-point operation can lead to rounding-errors giving you unequal keys that “ought-to-be” equal.</p>



<a name="269875973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269875973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269875973">(Jan 29 2022 at 17:07)</a>:</h4>
<p>On second thought, even sorting is problematic because positive and negative NaNs are <strong><em>not</em></strong> grouped together, as long as the sign of NaNs you get from calculations is unspecified.</p>



<a name="269876243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269876243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269876243">(Jan 29 2022 at 17:12)</a>:</h4>
<p>hmm, that's a rough one, but now that you mention it I've hit this bug before myself</p>



<a name="269887923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269887923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269887923">(Jan 29 2022 at 20:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/269874546">said</a>:</p>
<blockquote>
<p>If you just want to put it in a BTreeMap then isn't basically any ordering fine?</p>
</blockquote>
<p>It depends if you want to be able to use <code>BTreeMap::range</code> reasonably -- and that API (for things like next after queries) is one of the best reasons to use <code>BTreeMap</code>.</p>
<p>...which I guess also contradicts my previous statement of just wanting "something that works" with it.  I suppose what I want (given a time machine) is something like Partial Ord on Result, so that the results from <code>range</code> would exclude anything incomparable to it (like <code>.range(Ok(3)..)</code> would not include any Errs and <code>.range(Err(3)..)</code> would not include any Oks).  But with some "arbitrary tie breaker" to split the categories, or something...</p>



<a name="269956246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269956246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269956246">(Jan 30 2022 at 20:45)</a>:</h4>
<p>I updated <a href="https://github.com/rust-lang/rust/pull/93397">https://github.com/rust-lang/rust/pull/93397</a> to call the method <code>sort</code>; let's see if this works without needing a negative impl.</p>



<a name="269959062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/269959062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#269959062">(Jan 30 2022 at 21:35)</a>:</h4>
<p>...and it turns out that doesn't work without some additional steps, so I reverted back to <code>sort_floats</code>.</p>



<a name="270030687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270030687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270030687">(Jan 31 2022 at 13:30)</a>:</h4>
<p>I don't think adding this is a good idea; doing so could make users be oblivious to NaNs. The total order as defined by IEEE 754 is not always what users want for sorting. Users could want to:</p>
<ul>
<li>Sort all NaNs to one side (total order would place negative NaN and positive NaN on different sides)</li>
<li>Sort floats without NaNs; in this case it might make more sense to panic when NaN exists instead (i.e. <code>partial_cmp(..).unwrap()</code>)</li>
</ul>



<a name="270043282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270043282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270043282">(Jan 31 2022 at 14:53)</a>:</h4>
<p>Do you propose not having float sorting at all? Or some alternative sorting?</p>
<p>Because not having a float sorting at all seems unacceptable to me as a user. Let me sort the darn floats.</p>



<a name="270050230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270050230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270050230">(Jan 31 2022 at 15:35)</a>:</h4>
<p>Maybe <code>sort_float</code> should accept a setting? Like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">SortFloatStrategyNamesBikeshadable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">TotalOrder</span><span class="p">,</span><span class="w"> </span><span class="c1">// as defined in IEEE 754</span>
<span class="w">    </span><span class="n">NonNans</span><span class="p">,</span><span class="w"> </span><span class="c1">// panic on nan</span>
<span class="w">    </span><span class="n">SmallNans</span><span class="p">,</span><span class="w"> </span><span class="c1">// NaN is the smallest value</span>
<span class="w">    </span><span class="n">BigNans</span><span class="p">,</span><span class="w"> </span><span class="c1">// NaN is the biggest value</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270050620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270050620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270050620">(Jan 31 2022 at 15:37)</a>:</h4>
<p>All that flexibility exists in the sort-by methods. IMO <code>sort_float</code> should just stick to a reasonable default, and total order seems like the best option.</p>



<a name="270051012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270051012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270051012">(Jan 31 2022 at 15:39)</a>:</h4>
<p>I just feel like there isn't a reasonable default and any default will lead to unexpected behaviour for some users.</p>



<a name="270051262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270051262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Yu [they/she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270051262">(Jan 31 2022 at 15:41)</a>:</h4>
<p>do we have a way to discover how often the IEEE total ordering is used in practice?</p>



<a name="270058485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270058485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270058485">(Jan 31 2022 at 16:17)</a>:</h4>
<p>It's not that I think total order is amazing and perfect, just that it's well-defined and standardized. It will do the right thing for all the partially ordered values, while also doing something consistent for NaN. If a user has more opinions about handling NaN, they can write their own comparison.</p>



<a name="270092694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270092694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270092694">(Jan 31 2022 at 19:44)</a>:</h4>
<p>And it'd actually be nice if there were always NANs at both ends, since that's the places they're most likely to get noticed, I suspect.</p>



<a name="270271382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270271382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270271382">(Feb 01 2022 at 19:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270043282">said</a>:</p>
<blockquote>
<p>Because not having a float sorting at all seems unacceptable to me as a user. Let me sort the darn floats.</p>
</blockquote>
<p>I don't see why writing <code>.sort_float</code> is better than <code>.sort_by(f32::total_cmp)</code>.</p>



<a name="270271614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270271614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270271614">(Feb 01 2022 at 19:34)</a>:</h4>
<p>The former is easier to find when looking for a sort function.</p>



<a name="270271643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270271643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270271643">(Feb 01 2022 at 19:34)</a>:</h4>
<p>And "I have a <code>Vec&lt;f32&gt;</code> and just want to sort it" seems reasonable.</p>



<a name="270271951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270271951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270271951">(Feb 01 2022 at 19:36)</a>:</h4>
<p>And that is exactly what I worry about, because then the users won't understand the quirks about sorting floats.</p>



<a name="270275145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270275145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270275145">(Feb 01 2022 at 19:56)</a>:</h4>
<p>I think "easier to find" can be solved with diagnostics and/or diagnostics.</p>
<p>Hmm, looks like we don't mention anything about floats in the <code>sort</code> documentation.  Seems like an easy no-fcp thing would be to just add a "if you're trying to sort floats, consider <code>sort_by(f32::total_cmp)</code>" or whatever.  Or maybe a section in the documentation for floats that we can link from <code>sort</code> and <code>sort_unstable</code>?</p>



<a name="270278852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270278852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270278852">(Feb 01 2022 at 20:20)</a>:</h4>
<p>We could totally talk about <code>f32::total_cmp</code> in the diagnostic of <code>error[E0277]: the trait bound f32: Ord is not satisfied</code>. And potentially even figure out if that error comes from <code>required by a bound in slice::&lt;impl [T]&gt;::sort</code> and then mention <code>sort_by</code>.</p>



<a name="270279159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270279159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270279159">(Feb 01 2022 at 20:22)</a>:</h4>
<p>We absolutely could add compiler suggestions to steer people.</p>



<a name="270279230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270279230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270279230">(Feb 01 2022 at 20:23)</a>:</h4>
<p>But I feel like if you are writing float-heavy code, you shouldn't <em>have</em> to write out <code>.sort_by(f32::total_cmp)</code>, any more than you have to write <code>x.float_add(y.float_mul(z))</code>.</p>



<a name="270279273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270279273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270279273">(Feb 01 2022 at 20:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270271951">said</a>:</p>
<blockquote>
<p>And that is exactly what I worry about, because then the users won't understand the quirks about sorting floats.</p>
</blockquote>
<p>1) Those quirks will be in the documentation.<br>
2) Why do they <em>need</em> to understand those quirks? And to what extent will having to type out a more verbose incantation force them to understand it, rather than just copy-paste it and treat it as a verbose way to spell <code>sort</code>?</p>



<a name="270279555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270279555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270279555">(Feb 01 2022 at 20:25)</a>:</h4>
<p>I generally tend to agree with the premise of "don't hide details that people need to care about", and I <em>will</em> say that's making me increasingly convinced we shouldn't call this <code>.sort()</code>; <code>.sort_floats()</code> being different gives us the chance for people to ask "why is it different" and learn about those quirks.</p>



<a name="270458653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270458653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270458653">(Feb 02 2022 at 21:14)</a>:</h4>
<p><code>total_cmp</code> is in ieee754. But is it widely used? Does it being in the standard make it a better choice than the other way to sort floats? Since there is no one true way to sort them I'm not sure if calling it <code>sort_floats</code> is the best choice since it just chooses one that we happen to have in the standard library because we needed something.</p>



<a name="270459243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270459243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270459243">(Feb 02 2022 at 21:19)</a>:</h4>
<p>I think any reasonable way to sort floats is going to sort numeric values identically. The only plausible way to differ would be how to handle NaN, I think.</p>



<a name="270459283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270459283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270459283">(Feb 02 2022 at 21:19)</a>:</h4>
<p>And in practice, I think the primary thing people want is sorting numeric values.</p>



<a name="270459693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270459693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Yu [they/she] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270459693">(Feb 02 2022 at 21:22)</a>:</h4>
<p>supposedly, IEEE 754 was designed to tolerate well-meaning ignorance among programmers. no idea how well that extends to its total order predicate. <a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic#IEEE_754_design_rationale">https://en.wikipedia.org/wiki/Floating-point_arithmetic#IEEE_754_design_rationale</a></p>



<a name="270459802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270459802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270459802">(Feb 02 2022 at 21:22)</a>:</h4>
<p>yeah, but that handling matters. panic, NaN at start, NaN at end... and then what total_cmp does.</p>



<a name="270459845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270459845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270459845">(Feb 02 2022 at 21:23)</a>:</h4>
<p>Let's compromise and put them at both ends!</p>



<a name="270459882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270459882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270459882">(Feb 02 2022 at 21:23)</a>:</h4>
<p>If we want to go down the very configurable route, we could add defaulted generic params to the float types that configures their behaviour (basically the OrderedFloat &amp; NotNan newtypes integrated into <code>f32</code> via generic params).</p>



<a name="270460345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270460345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270460345">(Feb 02 2022 at 21:26)</a>:</h4>
<p>another silly approach: poison the whole slice with nans if you encounter a single one on sorting</p>



<a name="270461359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270461359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270461359">(Feb 02 2022 at 21:33)</a>:</h4>
<p>Please tweet this xD</p>



<a name="270462610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270462610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270462610">(Feb 02 2022 at 21:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270460345">said</a>:</p>
<blockquote>
<p>another silly approach: poison the whole slice with nans if you encounter a single one on sorting</p>
</blockquote>
<p>The batman approach?</p>



<a name="270462632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270462632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270462632">(Feb 02 2022 at 21:42)</a>:</h4>
<p>NaNaNaNaNaNaNaNaNaNaNaNaNaNaNaN Batman!</p>



<a name="270463230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463230">(Feb 02 2022 at 21:47)</a>:</h4>
<p>I see you're already planning your replies. <a href="https://twitter.com/the8472/status/1488992329902051333">https://twitter.com/the8472/status/1488992329902051333</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/the8472/status/1488992329902051333"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/b06fe73b56f4f203ff80b62d19fcb0c8a901fe62/68747470733a2f2f6162732e7477696d672e636f6d2f737469636b792f64656661756c745f70726f66696c655f696d616765732f64656661756c745f70726f66696c655f6e6f726d616c2e706e67"></a><p><span aria-label="crab" class="emoji emoji-1f980" role="img" title="crab">:crab:</span> How to deal with NaNs when sorting [f32] since it's not Ord? Panic, sort them to the start or end, or use ieee754 total ordering which puts them at both ends?

The best way to surface them is to poison the whole slice with NaNs when encountering the first one.</p><span>- the8472 (@the8472)</span></div></div>



<a name="270463308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463308">(Feb 02 2022 at 21:47)</a>:</h4>
<p>:retweet:</p>



<a name="270463824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463824">(Feb 02 2022 at 21:51)</a>:</h4>
<p>Note that even without NANs, <code>sort_by(f32::total_cmp)</code> is different from <code>sort_by(|a, b| a.partial_cmp(b).unwrap())</code>, because it differs in the handling of signed zeros.</p>



<a name="270463942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463942">(Feb 02 2022 at 21:52)</a>:</h4>
<p>That seems fine. I kind of expect total and partial orderings to be different</p>



<a name="270463969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463969">(Feb 02 2022 at 21:52)</a>:</h4>
<p>True, but I think the handling of signed zeroes in total_cmp seems right, and either people won't care or if they care they want the negative-zeroes-then-positive-zeroes behavior.</p>



<a name="270463980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463980">(Feb 02 2022 at 21:52)</a>:</h4>
<p>I suspect fewer people care about those than about NaN handling.</p>



<a name="270463986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270463986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270463986">(Feb 02 2022 at 21:52)</a>:</h4>
<p>Or at least it seems as fine as the rest of the best of footguns which is floating point</p>



<a name="270464188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270464188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270464188">(Feb 02 2022 at 21:54)</a>:</h4>
<p>But sure, that's yet another dimension along which we can skin this cat</p>



<a name="270464265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270464265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270464265">(Feb 02 2022 at 21:55)</a>:</h4>
<p>Can you skin a foot gun?</p>



<a name="270464479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270464479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270464479">(Feb 02 2022 at 21:56)</a>:</h4>
<p>ow</p>



<a name="270464496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270464496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270464496">(Feb 02 2022 at 21:56)</a>:</h4>
<p>The fur goes onto the gun if it's a fancy one.</p>



<a name="270466685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270466685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270466685">(Feb 02 2022 at 22:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270279230">said</a>:</p>
<blockquote>
<p>But I feel like if you are writing float-heavy code, you shouldn't <em>have</em> to write out <code>.sort_by(f32::total_cmp)</code>, any more than you have to write <code>x.float_add(y.float_mul(z))</code>.</p>
</blockquote>
<p>Honestly, if you are writing float-heavy code, you are going to be bringing in a library with custom tooling for this issue, either because you are doing graphics work or because you are doing scientific numerical computation, and both of those libraries have different needs and slightly different answers to this issue.</p>



<a name="270468406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270468406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270468406">(Feb 02 2022 at 22:24)</a>:</h4>
<p>I do think that the equivalent of PyTorch or similar will need a library, but I'm hoping the equivalent of numpy won't.</p>



<a name="270468448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270468448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270468448">(Feb 02 2022 at 22:25)</a>:</h4>
<p>I'm thinking of this as part of the story for having functionality like numpy.</p>



<a name="270468644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270468644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270468644">(Feb 02 2022 at 22:27)</a>:</h4>
<p>Doesn't ndarray already cover that? (I don't know much about numpy)</p>



<a name="270474144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270474144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270474144">(Feb 02 2022 at 23:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270468448">said</a>:</p>
<blockquote>
<p>I'm thinking of this as part of the story for having functionality like numpy.</p>
</blockquote>
<p>Eh? Something like NumPy is far more likely to use a mechanism where the NumArray <code>sort</code> doesn't simply take <code>&amp;mut self</code> and instead accepts an argument and dispatches to something that is likely going to look like <code>sort_by</code> anyways.</p>
<p>Or if you meant "NumPy in the std": That is... a lot. NumPy does a lot.</p>



<a name="270483729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270483729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270483729">(Feb 03 2022 at 00:53)</a>:</h4>
<p>I just meant "good handling of large-scale numeric work".</p>



<a name="270489988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270489988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> TennyZhuang <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270489988">(Feb 03 2022 at 02:01)</a>:</h4>
<p>Consider another solution, how about introduce NotNanF32 and NotNanF64 to our stdlib?</p>
<p>Currently, we already have NonZero* in std::num, so it’s reasonable to introduce NotNan* for floats.</p>
<p>There are several advantages:</p>
<ol>
<li>They can implement Ord directly, so we don’t need sort_floats anymore.</li>
<li>NAN is likely a mistake but not expected in sort, and the error can be reported from construction.</li>
<li>Users has another choose if they can confirm there is no NAN in their slice, just transmute them.</li>
<li>Option&lt;NotNanF32&gt;/Option&lt;NotNanF64&gt; can be optimized in memory layout inside compiler, so they will only use 4/8 bytes.</li>
</ol>



<a name="270490679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270490679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> TennyZhuang <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270490679">(Feb 03 2022 at 02:10)</a>:</h4>
<p>As the price, if we really want to sort floats with Nan (unlikely), we may have to iterate the slice twice. sort_floats is meaningful in the case. But for general case, I think NotNan* is a better solution.</p>
<p>In fact, there are no conflicts between the two APIs, I just propose  a better solution for some cases covered by sort_floats.</p>



<a name="270492951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270492951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270492951">(Feb 03 2022 at 02:43)</a>:</h4>
<p><code>NonNanF32</code> and friends come up regularly on IRLO.  Here's a recent instance: &lt;<a href="https://internals.rust-lang.org/t/suggestion-ffastmath-intrinsics-in-stable/14447/60?u=scottmcm">https://internals.rust-lang.org/t/suggestion-ffastmath-intrinsics-in-stable/14447/60?u=scottmcm</a>&gt;</p>
<p>I'd really like to see them.  Though they'll always be somewhat of a pain until we find a better way to do literals.</p>



<a name="270494787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270494787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270494787">(Feb 03 2022 at 03:10)</a>:</h4>
<p>Having experimented extensively with wrapping types in Rust, I think the NonZero* types are not a great model.</p>



<a name="270506799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270506799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270506799">(Feb 03 2022 at 06:36)</a>:</h4>
<p>Ugh, I think it might be a problem if we partition -NaN and +NaN on different ends of the slice, the way total order requires. LLVM's APFloat currently gets the sign bit of NaNs wrong on many architectures, including common ones like x86_64.</p>
<p>The concrete outcome of this is that the sign bit of NaNs will switch based on what optimization levels are enabled (and more broadly, what optimizations LLVM happens to apply). Here's a program whose output changes on debug versus release as a result of this: <a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=3eaa2447c25f89fd2375b152e0aa68af">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=3eaa2447c25f89fd2375b152e0aa68af</a></p>
<p>This generally isn't noticed by anybody, but if we add <code>sort_float</code> using total order, it will expose the problem in a way that makes NaNs go to wildly different positions depending on the build flags you use, which seems like it could cause hard to track-down bugs that only show up in release builds.</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>You'd like am unreasonable amount of writing about this problem, including a made-up FAQ? Say no more.</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>On most arches (all I'm aware of), there's essentially a "default NaN" bitpattern that gets produced when a NaN is generated by some operation which does not have NaN in any of the inputs (typically if it has a NaN in the inputs, that one is propagated to the output).</p>
<p>Unfortunately, <code>llvm::APFloat</code> is not really aware of the target architecture it is compiling to (its only aware of the type of float you're emulating), and fixing this is tricky. As a result, it just produces a positive qNaN everywhere. This is correct on some arches, but also wrong on many. As mentioned, x86_64 is an example of an architecture where a <em>negative</em> qNaN will be emitted instead.</p>
<p><code>llvm::APFloat</code> is used to implement a few optimizations, such as constant propagation. This means that whether or not this optimization is performed on your code (which is up to the whims of the inliner, optimization level, and luck) may determine what sign bit NaNs happen to have in your program.. </p>
<p>Historically, we've had this problem for a while, but this hasn't been a significant issue -- even if code does handle NaNs in some way, it typically doesn't care about the signbit value they have. However, using total order here sadly would make it much more visible and seems like a real footgun.</p>
<p>That is, it might appear to some unsuspecting users that the sort order of NaNs switches between "NaNs at the end of slices" to "NaNs at the start of slices" based on optimization levels. This seems almost guaranteed to cause only-happens-in-release-build heisenbugs.</p>
<hr>
<h2>The made-up FAQ</h2>
<ol>
<li>Is this bug in llvm::APFloat?<p>I don't know. I think so, but would have to argue it -- it's not 100% clear at all if LLVM considers it to be one, or if it just considers it unsupported (intentiaonally or otherwise).</p>
<p>Concretely: even with this bug, APFloat is IEEE-754 compliant, as that spec does not require a specific sign bit to be used in these cases. However, as it is, it means the optimizations applied can change the result of code quite significantly, which seems very unfortunate for something like constant folding, which <em>should</em> otherwise be entirely transparent (in the absense of UB, which this is certainly not).</p>
<p>That is: I think it's a bug, but that it isn't cut and dry.</p>
</li>
</ol>
<hr>
<ol start="2">
<li>Does our port of APFloat have this issue?<p>Yes, it has the same issue. We don't use it in optimization dependent ways, and forbid float arithmetic in const fn, which considerably limits the scope of the bug.</p>
<p>That is, while this might means <code>f64::NAN</code> may have a different sign bit than NaNs generated at runtime, we could just document that <code>{f64,f32}::NAN</code> is guaranteed to have a positive signbit (or something), if it became an issue.</p>
<p>Moreover, CTFE and const eval don't have (nor want to have) optimization-dependent behavior, which limits the negative aspects a great deal IMO.</p>
</li>
</ol>
<hr>
<ol start="3">
<li>What about WASM?<p>On Wasm the values of NaN bits and sign are specced as being produced non deterministically. This is annoying, and will probably result in some bugs if it's exhibited by sort_float, but it's more likely to be caught in test code, as it's not opt-level dependent (not to be a broken record, or anything...)</p>
</li>
</ol>
</div></div>



<a name="270508814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270508814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270508814">(Feb 03 2022 at 07:12)</a>:</h4>
<blockquote>
<p>That is, it might appear to some unsuspecting users that the sort order of NaNs switches between "NaNs at the end of slices" to "NaNs at the start of slices" based on optimization levels. This seems almost guaranteed to cause only-happens-in-release-build heisenbugs.</p>
</blockquote>
<p>I think this is the issue that needs to be tackled head-on in documentation. I can definitely see people just trying to sort NaN and other stuff to find out the answer to the question "do NaNs sort before other stuff or after?" and the docs need to very loudly and clearly indicate that the question has a false premise and the answer is "both, nondeterministically"</p>



<a name="270512663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270512663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270512663">(Feb 03 2022 at 08:11)</a>:</h4>
<p>What are the actual solutions for this in the community?</p>



<a name="270515591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270515591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pachi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270515591">(Feb 03 2022 at 08:43)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> in most numeric code I have worked with, mostly in Python or R languages, you actively define how you want to deal with NaN values before doing any sorting, so you can drop the rows with NaN values, you replace them with the mean value for that column or use the min or max value. So I'd say that "cleaning" the data before sorting is needed and depends on the specific case. The problem is having that ergonomic hit in all cases, even when you can be sure that there are no NaNs or, if you have them, then that's a logic bug.</p>



<a name="270515705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270515705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pachi <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270515705">(Feb 03 2022 at 08:44)</a>:</h4>
<p>So, I personally would say that total ordering is perfectly fine for my cases, as if I need special casing for NaNs I'd probably have to deal with it before doing any data sorting, grouping, etc</p>



<a name="270516579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270516579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270516579">(Feb 03 2022 at 08:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270512663">said</a>:</p>
<blockquote>
<p>What are the actual solutions for this in the community?</p>
</blockquote>
<p><code>noisy_float</code> apparently just YOLOs it: <a href="https://docs.rs/noisy_float/0.2.0/src/noisy_float/float_impl.rs.html#108-119">https://docs.rs/noisy_float/0.2.0/src/noisy_float/float_impl.rs.html#108-119</a></p>
<p><code>ordered_float</code> would let you do <code>.sort_by_key(|a| NotNan::new(a).ok())</code>, which would put all the NANs at one end: <a href="https://docs.rs/ordered-float/latest/ordered_float/struct.NotNan.html#method.new">https://docs.rs/ordered-float/latest/ordered_float/struct.NotNan.html#method.new</a></p>



<a name="270516911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270516911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270516911">(Feb 03 2022 at 08:56)</a>:</h4>
<p>Also yes, I should mention I think float sorting functions should in fact sort sign of zeros even if they are not, strictly speaking, "ordered" by such except under <code>total_cmp</code> and its ilk.</p>



<a name="270517516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270517516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270517516">(Feb 03 2022 at 09:01)</a>:</h4>
<p>either all your values are gonna be negative or positive anyways or you have reason to care about sign of zero.</p>



<a name="270517959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270517959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270517959">(Feb 03 2022 at 09:05)</a>:</h4>
<p>I do think that, for sorting, distinguishing negative zeros is a good thing -- at least since it's inexpensive to do so.</p>
<p>(Similarly I wish there was an efficient way to have <code>(-0.0).clamp(0.0, 1.0)</code> return <code>+0.0</code>, not the current <code>-0.0</code>.)</p>



<a name="270562712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270562712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270562712">(Feb 03 2022 at 15:02)</a>:</h4>
<p>I'm pretty sure <span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span> showed me a special comparison ordering you can do which brings even NaN and -0.0 into a range like that.</p>



<a name="270600860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270600860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270600860">(Feb 03 2022 at 19:05)</a>:</h4>
<p><code>robust_saturate</code> in <a href="https://shift.click/codelet/codelet-saturate">https://shift.click/codelet/codelet-saturate</a> brings all floats into the range between 0.0 and 1.0 (it maps -0.0 and the NaNs to 0.0 -- which can be controversial). I've never tried to make it that fast other than a batch SIMD impl I did once in some image processing code (converting f32 channels to u8). Not that relevant here tho</p>



<a name="270601795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270601795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270601795">(Feb 03 2022 at 19:11)</a>:</h4>
<p><code>NotNan</code> is a funny name since NaN is already "not a number" :)</p>



<a name="270602277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270602277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270602277">(Feb 03 2022 at 19:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270562712">said</a>:</p>
<blockquote>
<p>I'm pretty sure <span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> showed me a special comparison ordering you can do which brings even NaN and -0.0 into a range like that.</p>
</blockquote>
<p>Once <a href="https://llvm.org/docs/LangRef.html#llvm-minimum-intrinsic">https://llvm.org/docs/LangRef.html#llvm-minimum-intrinsic</a> is fast everywhere then <code>clamp</code> could just use that instead, yes.</p>



<a name="270603368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270603368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270603368">(Feb 03 2022 at 19:23)</a>:</h4>
<p>Sure, but also that's not the same as what's described in the blog post Thom linked.</p>



<a name="270603793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270603793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270603793">(Feb 03 2022 at 19:26)</a>:</h4>
<p>Mine's not quite that, since I explicitly turns NaNs into 0 (which is desirable in stuff like image processing, but probably not appropriate for the stdlib).</p>
<p>I remember asking about changing something (maybe <code>clamp</code>?) to use <code>minimum</code> instead of <code>minNum</code>, and was told it was too slow on important targets (e.g. x86_64).</p>
<p>That said, I didn't check if this was true. In retrospect it seems unlikely, since minps/maxps arent ieee754's minNum/maxNUm anyway, so neither could use the instruction regardless.</p>
<p>Might be misremembering tho</p>



<a name="270604384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270604384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270604384">(Feb 03 2022 at 19:30)</a>:</h4>
<p>So the fast form of <code>min()</code> on x86_64 is <code>if x &lt; y { x } else { y }</code> which propagates NaNs in <code>y</code> but not <code>x</code>.  So <code>robust_saturate()</code> is just <code>max(min(v, 1.0), 0.0)</code> which should be two instructions</p>



<a name="270604474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270604474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270604474">(Feb 03 2022 at 19:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="306504">Tavian Barnes</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270601795">said</a>:</p>
<blockquote>
<p><code>NotNan</code> is a funny name since NaN is already "not a number" :)</p>
</blockquote>
<p><code>Real&lt;f32&gt;</code></p>



<a name="270604520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270604520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270604520">(Feb 03 2022 at 19:31)</a>:</h4>
<p>You don't like <code>An&lt;f32&gt;</code>? ;)</p>



<a name="270604556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270604556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270604556">(Feb 03 2022 at 19:31)</a>:</h4>
<p>HA.</p>



<a name="270604718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270604718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270604718">(Feb 03 2022 at 19:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270604474">said</a>:</p>
<blockquote>
<p><code>Real&lt;f32&gt;</code></p>
</blockquote>
<p>Personally I'd say <code>ExtendedReal</code>, since it includes infinities -- or at least I think it would, since the infinities are useful and don't have issues like the NANs do.</p>



<a name="270604778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270604778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270604778">(Feb 03 2022 at 19:33)</a>:</h4>
<p><code>Real++</code></p>



<a name="270605458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270605458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270605458">(Feb 03 2022 at 19:37)</a>:</h4>
<p>joke: <code>Hyper&lt;f32&gt;</code> because that sounds faster. <a href="https://en.wikipedia.org/wiki/Hyperreal_number">https://en.wikipedia.org/wiki/Hyperreal_number</a></p>



<a name="270622759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270622759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270622759">(Feb 03 2022 at 21:45)</a>:</h4>
<p>Aside: treating <code>+0</code> and <code>-0</code> as positive/negative infinitesimals and <code>+-INF</code> as specific positive/negative infinite hyperreal numbers (note, this is not the same as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">∞</span></span></span></span>) is actually somewhat more logically coherent than the usual way of reading these as members of the extended reals and +-0 being the same but also not really. <code>NaN</code> is right out though, even the hyperreals want nothing to do with that mess</p>



<a name="270623102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270623102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270623102">(Feb 03 2022 at 21:48)</a>:</h4>
<p>Re: naming, I think we shouldn't miss the opportunity to have <code>NaNaN</code></p>



<a name="270634143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270634143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270634143">(Feb 03 2022 at 23:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270516579">said</a>:</p>
<blockquote>
<p><code>noisy_float</code> apparently just YOLOs it: <a href="https://docs.rs/noisy_float/0.2.0/src/noisy_float/float_impl.rs.html#108-119">https://docs.rs/noisy_float/0.2.0/src/noisy_float/float_impl.rs.html#108-119</a></p>
</blockquote>
<p>afaict <code>NoisyFloat</code> is essentially a <code>NotNaN</code> or <code>FiniteOnly</code> (except it only checks in debug builds?? <a href="https://docs.rs/noisy_float/0.2.0/src/noisy_float/checkers.rs.html#29-31">https://docs.rs/noisy_float/0.2.0/src/noisy_float/checkers.rs.html#29-31</a>)</p>



<a name="270654827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270654827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270654827">(Feb 04 2022 at 01:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="306504">Tavian Barnes</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270604384">said</a>:</p>
<blockquote>
<p>So the fast form of <code>min()</code> on x86_64 is <code>if x &lt; y { x } else { y }</code> which propagates NaNs in <code>y</code> but not <code>x</code>.  So <code>robust_saturate()</code> is just <code>max(min(v, 1.0), 0.0)</code> which should be two instructions</p>
</blockquote>
<p>i am pretty sure you can't use the max instruction, which has the args the other way? maybe i am wrong. fwiw, llvm doesn't optimize it two just min/max <a href="https://godbolt.org/z/cPKv55boP">https://godbolt.org/z/cPKv55boP</a>, but maybe thats something something something canonicalization gone wrong</p>



<a name="270667021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270667021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270667021">(Feb 04 2022 at 04:36)</a>:</h4>
<p>It's unclear to me what minss does about signed zeros -- <a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=minss&amp;ig_expand=4786">https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=minss&amp;ig_expand=4786</a> says </p>
<blockquote>
<p>does not follow the IEEE Standard for Floating-Point Arithmetic (IEEE 754) minimum value when inputs are NaN or signed-zero values.</p>
</blockquote>
<p>so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="270746324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270746324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270746324">(Feb 04 2022 at 17:29)</a>:</h4>
<p>ah right, that too.</p>



<a name="270752177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270752177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270752177">(Feb 04 2022 at 18:15)</a>:</h4>
<blockquote>
<p>If the values being compared are both 0.0s (of either sign), the value in the second source operand is returned. If a value in the second operand is an SNaN, that SNaN is returned unchanged to the destination (that is, a QNaN version of the SNaN is not returned).</p>
<p>If only one value is a NaN (SNaN or QNaN) for this instruction, the second source operand, either a NaN or a valid floating-point value, is written to the result. If instead of this behavior, it is required that the NaN in either source operand be returned, the action of MINSD can be emulated using a sequence of instructions, such as, a comparison followed by AND, ANDN and OR.</p>
</blockquote>
<p><a href="https://www.felixcloutier.com/x86/minss">https://www.felixcloutier.com/x86/minss</a></p>



<a name="270761118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270761118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270761118">(Feb 04 2022 at 19:24)</a>:</h4>
<p>Yeah, <code>clamp</code> is written carefully so it compiles to <code>minss+maxss</code> while handling NAN correctly.  But because of the "of either sign" it doesn't handle signed zeros perfectly.</p>



<a name="270761398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270761398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270761398">(Feb 04 2022 at 19:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/219381-t-libs/topic/float.20total_cmp/near/270654827">said</a>:</p>
<blockquote>
<p>i am pretty sure you can't use the max instruction, which has the args the other way? maybe i am wrong. fwiw, llvm doesn't optimize it two just min/max <a href="https://godbolt.org/z/cPKv55boP">https://godbolt.org/z/cPKv55boP</a>, but maybe thats something something something canonicalization gone wrong</p>
</blockquote>
<p>Well I dunno why that didn't work exactly, but this does: <a href="https://godbolt.org/z/Wc6eqKEen">https://godbolt.org/z/Wc6eqKEen</a></p>



<a name="270761653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270761653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270761653">(Feb 04 2022 at 19:28)</a>:</h4>
<p>Oh actually there is a difference between those implementations</p>



<a name="270761927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/float%20total_cmp/near/270761927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/float.20total_cmp.html#270761927">(Feb 04 2022 at 19:31)</a>:</h4>
<p>The correct one would be <code>min(max(v, 0.0), 1.0)</code>, which is also compiled optimally.  Your version codegens differently because both tests use <code>v</code>, whereas in mine the  second test is on the clamped value.  I guess yours is harder to canonicalize</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>