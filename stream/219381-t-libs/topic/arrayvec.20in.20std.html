<html>
<head><meta charset="utf-8"><title>arrayvec in std · t-libs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/index.html">t-libs</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html">arrayvec in std</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253664189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253664189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253664189">(Sep 16 2021 at 23:02)</a>:</h4>
<p>I’d really like some kind of <code>ArrayVec</code> in libcore. Though last time I thought about what it could look like, I felt tension between sharing implementation code (since there’s a lot that would be similar or identical) on one hand, and not compromising on convenience for users on the other hand. (This includes things like rustdoc output that looks good)</p>



<a name="253670967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253670967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253670967">(Sep 17 2021 at 00:22)</a>:</h4>
<p>I don't think there would be much common code to share: most of the common stuff is implemented directly on slices.</p>



<a name="253674830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253674830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253674830">(Sep 17 2021 at 01:13)</a>:</h4>
<p>I had a somewhat similar idea when I am trying to add no alloc support gimli. It looks like this: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">VecLikeStorage</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Storage</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">new_storage</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Storage</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_slice</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">Self</span>::<span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">as_mut_slice</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">grow</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">additional</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">AllocError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">AllocError</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VecLikeStorage</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ArrayVecStorage</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">A</span>: <span class="nc">Allocator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VecLikeStorage</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">VecStorage</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">],</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">VecLike</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">VecLikeStorage</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">storage</span>: <span class="nc">S</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">len</span>: <span class="kt">usize</span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span>: <span class="nc">VecLikeStorage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VecLike</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253674919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253674919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253674919">(Sep 17 2021 at 01:14)</a>:</h4>
<p>VecLikeStorage only have methods related to its capacity, and all manipulations are in VecLike.</p>



<a name="253675054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253675054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253675054">(Sep 17 2021 at 01:16)</a>:</h4>
<p>(I had a Storage assoc type because in my case I actually want <code>impl VecLikeStorage for [T; N]</code>, but it could be replaced with Self)</p>



<a name="253726320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253726320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253726320">(Sep 17 2021 at 11:18)</a>:</h4>
<p>Yes we get a lot "for free" through Deref to slices. But there’s still a lot more to Vec than that. <code>library/alloc/src/vec/*.rs</code> is 4k lines</p>



<a name="253925452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253925452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253925452">(Sep 19 2021 at 07:26)</a>:</h4>
<p>It'd be nice to have an arrayvec-like thing in <code>core</code> even if not exposed just to avoid it getting re-implemented in essentially every single PR that does stuff with arrays.  (Though <code>collect_into_array</code> <em>has</em> helped reduce that problem somewhat.)</p>
<p>But I do think it should be exposed.  I just don't know how it should spell and type <code>.push(x)</code>.</p>



<a name="253937597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253937597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253937597">(Sep 19 2021 at 11:08)</a>:</h4>
<p>there's a suggestion to add <code>push_within_capacity</code> to Vec. It's fallible in the sense that it doesn't even try to allocate. Once we have that it would also fit arrayvec and we wouldn't have to worry about <code>push</code> as much.</p>



<a name="253985358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/253985358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim McNamara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#253985358">(Sep 20 2021 at 01:07)</a>:</h4>
<p>That sounds like an interesting idea. I guess the implementation of <code>push()</code> would probably be changed to make use of that method internally also.</p>



<a name="254002396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254002396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Sapin <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254002396">(Sep 20 2021 at 06:16)</a>:</h4>
<p>I don’t love the name but I’ve had a use case for this one (in a <code>Vec</code>-based arena allocator)</p>



<a name="254012152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254012152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254012152">(Sep 20 2021 at 08:07)</a>:</h4>
<p>maybe <code>try_push</code> or something. names are hard. but yeah, having that function would be good</p>



<a name="254064304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254064304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254064304">(Sep 20 2021 at 15:03)</a>:</h4>
<p><code>try_push</code> implies a function that returns Result or similar, rather than one that just never fails.</p>



<a name="254065111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254065111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254065111">(Sep 20 2021 at 15:09)</a>:</h4>
<p>wouldn't <code>push_within_capacity</code> be fallible too? or would it just drop extras?</p>



<a name="254067715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254067715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254067715">(Sep 20 2021 at 15:25)</a>:</h4>
<p>It would probably look like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">try_push</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">AllocError</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="n">push_within_capacity</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="254070382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254070382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254070382">(Sep 20 2021 at 15:40)</a>:</h4>
<p>yeah, "give it back on error" is the way to go</p>



<a name="254097051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/219381-t-libs/topic/arrayvec%20in%20std/near/254097051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/219381-t-libs/topic/arrayvec.20in.20std.html#254097051">(Sep 20 2021 at 18:36)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/89123">#89123</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>