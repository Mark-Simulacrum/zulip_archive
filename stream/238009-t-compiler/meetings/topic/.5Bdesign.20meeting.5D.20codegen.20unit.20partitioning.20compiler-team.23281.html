<html>
<head><meta charset="utf-8"><title>[design meeting] codegen unit partitioning compiler-team#281 · t-compiler/meetings · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/index.html">t-compiler/meetings</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html">[design meeting] codegen unit partitioning compiler-team#281</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="198443239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198443239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198443239">(May 22 2020 at 13:52)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="897">@T-compiler/meeting</span> -- design meeting in <strong>this topic</strong> in ~10 minutes.</p>
<p>Topic:  Code Generation Unit Partitioning Meeting <a href="https://github.com/rust-lang/compiler-team/issues/281">compiler-team#281</a></p>



<a name="198443452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198443452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198443452">(May 22 2020 at 13:54)</a>:</h4>
<p><a href="https://gist.github.com/wesleywiser/9a7e3ca53a948dabbf30b3a0b8635860">Gist with details</a></p>



<a name="198444034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444034">(May 22 2020 at 13:58)</a>:</h4>
<p>Hi Niko :)<br>
I'd like to participate because this topic is very important to me (specially because I'm now working on mir-opts). How do the meetings work? Do we have like a Hangouts Meet / Jitsi / that kind of thing?</p>



<a name="198444078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444078">(May 22 2020 at 13:59)</a>:</h4>
<p>They happen here in this Zulip channel over chat <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="198444157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444157">(May 22 2020 at 13:59)</a>:</h4>
<p><span class="user-mention" data-user-id="212698">@Félix Fischer</span> you're in the right place!</p>



<a name="198444270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444270">(May 22 2020 at 14:00)</a>:</h4>
<p>Yay! Okay, I'm ready then <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="198444285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> andjo403 <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444285">(May 22 2020 at 14:00)</a>:</h4>
<p>I will also hang around :D</p>



<a name="198444503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444503">(May 22 2020 at 14:02)</a>:</h4>
<p>Hello <span class="user-group-mention" data-user-group-id="897">@T-compiler/meeting</span>! codegen unit partitioning discussion starting <strong>now</strong>. Please <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> to show you're here. To give folks time to gather, let's have a few minutes for</p>
<h1>Announcements</h1>



<a name="198444527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444527">(May 22 2020 at 14:03)</a>:</h4>
<ul>
<li>PS, I'm happy to "hand off" the running of this meeting to <span class="user-mention" data-user-id="125250">@Wesley Wiser</span>, if that's ok with you <span class="user-mention" data-user-id="125250">@Wesley Wiser</span></li>
</ul>



<a name="198444549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444549">(May 22 2020 at 14:03)</a>:</h4>
<p>Um, sure <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="198444566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444566">(May 22 2020 at 14:03)</a>:</h4>
<p>I've never run one of these before so I'm a bit lost. I guess it would be good to start by re-iterating the problem?</p>



<a name="198444608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444608">(May 22 2020 at 14:04)</a>:</h4>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="198444640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444640">(May 22 2020 at 14:04)</a>:</h4>
<p><del>So the backend part of the compiler has parallel codegen.</del></p>



<a name="198444653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444653">(May 22 2020 at 14:04)</a>:</h4>
<ul>
<li>perf.rlo will be transitioning to using a database for the site backend, as well as some (not yet implemented) changes to the collector with the intent of being able to collect more statistics (currently on the radar: cache misses, artifact sizes). Feel free to file issues if there's something you think would be helpful to track! (PR here: <a href="https://github.com/rust-lang/rustc-perf/pull/656">https://github.com/rust-lang/rustc-perf/pull/656</a>)</li>
</ul>



<a name="198444689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444689">(May 22 2020 at 14:04)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> oh lets wait until announcements are done, I guess</p>



<a name="198444711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444711">(May 22 2020 at 14:05)</a>:</h4>
<p>Sorry!</p>



<a name="198444738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444738">(May 22 2020 at 14:05)</a>:</h4>
<p>wanted to mention, as I've stated <a href="#narrow/stream/131828-t-compiler/topic/Trait.20object.20with.20non-static.20lifetime.20is.20accepted.20where.20sta">in this topic</a> that both current <code>P-critical</code> issues are solved with the same PR. Niko "is" investigating (Niko?)</p>



<a name="198444742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444742">(May 22 2020 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I'm glad to give you some interesting tasks <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="198444763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444763">(May 22 2020 at 14:05)</a>:</h4>
<p>(its not your fault, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> ! we don't have a good way to signaling "time for announcements is over.)</p>



<a name="198444854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198444854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198444854">(May 22 2020 at 14:06)</a>:</h4>
<ul>
<li>infrastructure and release teams are checking boxes in a planned move to Zulip</li>
<li>we have a release in ~12 days</li>
</ul>



<a name="198445001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445001">(May 22 2020 at 14:07)</a>:</h4>
<p>Oooh!</p>



<a name="198445074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445074">(May 22 2020 at 14:07)</a>:</h4>
<blockquote>
<p>(currently on the radar: cache misses, artifact sizes)</p>
</blockquote>
<p>That is super cool <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span></p>



<a name="198445076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445076">(May 22 2020 at 14:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> can you link the discussion of shifting to zulip?</p>



<a name="198445174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445174">(May 22 2020 at 14:08)</a>:</h4>
<p><a href="https://github.com/rust-lang/release-team/issues/6">https://github.com/rust-lang/release-team/issues/6</a> and <a href="https://github.com/rust-lang/infra-team/issues/36">https://github.com/rust-lang/infra-team/issues/36</a></p>



<a name="198445214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445214">(May 22 2020 at 14:08)</a>:</h4>
<p>okay. I think that's enough time for announcements. Take it away, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> !</p>



<a name="198445264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445264">(May 22 2020 at 14:08)</a>:</h4>
<p>So the backend part of the compiler has parallel codegen. To facilitate this as well as our incremental compilation, we split a crate into LLVM modules which we call "code generation units" or CGUs. Each CGU can then be run through LLVM in parallel or only recompiled if it has changed. </p>
<p>The process of deciding what functions go in what CGU is called CGU partitioning. This is a pretty critical algorithm because it impacts two things:</p>
<ol>
<li>
<p>Without LTO, LLVM will only perform inter-procedural optimizations like inlining between functions in the same CGU (since, if they are in another CGU, it can't see the function body). </p>
</li>
<li>
<p>In incremental mode, if a function body changes, we have to re-codegen the entire CGU it belongs to.</p>
</li>
</ol>



<a name="198445398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445398">(May 22 2020 at 14:09)</a>:</h4>
<p>(And those two things are interconnected)</p>



<a name="198445466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445466">(May 22 2020 at 14:10)</a>:</h4>
<p>(i.e., partly why we have to recodegen everything, is because we don't know what LLVM inlined into what etc)</p>



<a name="198445514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445514">(May 22 2020 at 14:10)</a>:</h4>
<p>I think we also suspected that partitioning could have been affecting the gains from polymorphisation (testing with a single codegen unit is something I plan to do).</p>



<a name="198445518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445518">(May 22 2020 at 14:10)</a>:</h4>
<p>So CGU partitioning is critical to both runtime performance of Rust code because it enables or hinders LLVM optimizations and it is also critical to compiler performance since incremental works best when CGUs are smaller and there is less work to do.</p>



<a name="198445606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445606">(May 22 2020 at 14:11)</a>:</h4>
<p>Yeah, that's a great point.</p>



<a name="198445663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445663">(May 22 2020 at 14:11)</a>:</h4>
<p>Which is a good segway into the problem which is that there are (probably) some deficiencies in the current partitioning algorithm.</p>



<a name="198445701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445701">(May 22 2020 at 14:11)</a>:</h4>
<p>So, for reference, the current algorithm is defined in <a href="https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs">https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs</a></p>



<a name="198445788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445788">(May 22 2020 at 14:12)</a>:</h4>
<p>It's actually very well commented so kudos to mw and others!</p>



<a name="198445824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445824">(May 22 2020 at 14:12)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> out of curiosity, do you or others know the partitioning algorithm LLVM uses?</p>



<a name="198445873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445873">(May 22 2020 at 14:12)</a>:</h4>
<p>or sorry, that clang uses, I mean</p>



<a name="198445921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445921">(May 22 2020 at 14:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198445873">said</a>:</p>
<blockquote>
<p>or sorry, that clang uses, I mean</p>
</blockquote>
<p>Thank you for the clarification, I was just gonna ask you what you meant by llvm!</p>



<a name="198445941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445941">(May 22 2020 at 14:13)</a>:</h4>
<p>No, I don't but I suspect it's very closely mapped to the translation unit concept C and C++ have.</p>



<a name="198445968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445968">(May 22 2020 at 14:13)</a>:</h4>
<p>yeah I was just in the midst of trying to phrase a comment hypothesizing that</p>



<a name="198445972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198445972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198445972">(May 22 2020 at 14:13)</a>:</h4>
<p>I'm not aware of what Clang uses</p>



<a name="198446070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446070">(May 22 2020 at 14:14)</a>:</h4>
<p>I'm not a C\C++ dev but my impression is that there's a greater expectation on C\C++ developers to manage compile times by splitting or combining code themselves to manage compile time and performance.</p>



<a name="198446078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446078">(May 22 2020 at 14:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> they use "one <code>.c</code> file is one partition"</p>



<a name="198446079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446079">(May 22 2020 at 14:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198445701">said</a>:</p>
<blockquote>
<p>So, for reference, the current algorithm is defined in <a href="https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs">https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs</a></p>
</blockquote>
<p>One detail that wasn't immediately obvious to me - the doc comment explains that the heuristic is that, for each source-level module, there are two codegen units - one for non-generic code, and one for generic code. It didn't explain how you get to the requested <code>N</code> codegen units from that, and I believe from a quick read that it merges the smallest two codegen units repeatedly until it reaches <code>N</code>.</p>



<a name="198446106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446106">(May 22 2020 at 14:14)</a>:</h4>
<p>Yes, that's correct.</p>



<a name="198446112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446112">(May 22 2020 at 14:14)</a>:</h4>
<p>or <code>.cpp</code> of course</p>



<a name="198446149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446149">(May 22 2020 at 14:14)</a>:</h4>
<p>There is one other thing worth mentioning though, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span></p>



<a name="198446169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446169">(May 22 2020 at 14:15)</a>:</h4>
<p>in principle, ThinLTO was supposed to help ammeliorate this trade-off on the LLVM side</p>



<a name="198446226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446226">(May 22 2020 at 14:15)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="116009">@nikomatsakis</span>!</p>



<a name="198446238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446238">(May 22 2020 at 14:15)</a>:</h4>
<p>it being basically a scheme that lets you do inlining quite late, so that we still get (most of) the benefits of inlining even if we slice into very fine codegen-units</p>



<a name="198446305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446305">(May 22 2020 at 14:16)</a>:</h4>
<p>(from polymorphisation's perspective: my assumption is that if we mostly polymorphise closures right now - which are necessarily contained in generic functions - then the result is that polymorphised closures are initially in different codegen units from the functions that call them; of course, after merging, who knows how it ends up)</p>



<a name="198446311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446311">(May 22 2020 at 14:16)</a>:</h4>
<p>(and in principle I think it supports incremental recompilation, too, but I'm not sure if we're doing that)</p>



<a name="198446361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446361">(May 22 2020 at 14:16)</a>:</h4>
<p>I'm definitely not an expert on this part of the compiler so I'm mostly just talking about what I've learned from tinkering with the partitioning algorithm.</p>



<a name="198446385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446385">(May 22 2020 at 14:17)</a>:</h4>
<p>so, the strategy of merging smallest two repeatedly until N is hit</p>



<a name="198446396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446396">(May 22 2020 at 14:17)</a>:</h4>
<p>I can understand how that is optimizing the load balancing</p>



<a name="198446400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446400">(May 22 2020 at 14:17)</a>:</h4>
<p>in terms of compilation work</p>



<a name="198446415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446415">(May 22 2020 at 14:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198446311">said</a>:</p>
<blockquote>
<p>(and in principle I think it supports incremental recompilation, too, but I'm not sure if we're doing that)</p>
</blockquote>
<p>It appears to support it, at least from the Clang side: <a href="https://clang.llvm.org/docs/ThinLTO.html">https://clang.llvm.org/docs/ThinLTO.html</a></p>



<a name="198446465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446465">(May 22 2020 at 14:17)</a>:</h4>
<p>but I would have thought one would be better off with something that is aware of the, I dunno, "edges" between the cgu's ?</p>



<a name="198446467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446467">(May 22 2020 at 14:17)</a>:</h4>
<p>One thing I was hoping to get out of this meeting would be to identify who has an understanding of this part of the compiler.</p>



<a name="198446475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446475">(May 22 2020 at 14:17)</a>:</h4>
<p>in terms of interdependencies</p>



<a name="198446494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446494">(May 22 2020 at 14:17)</a>:</h4>
<p>(i.e. referencing relationships?)</p>



<a name="198446550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446550">(May 22 2020 at 14:18)</a>:</h4>
<p>So, <span class="user-mention" data-user-id="116083">@pnkfelix</span> I think what you're getting is is something I haven't mentioned yet</p>



<a name="198446580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446580">(May 22 2020 at 14:18)</a>:</h4>
<p>Which is that, within a CGU, we include copies of all the functions callable from the "roots" of the CGU</p>



<a name="198446616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446616">(May 22 2020 at 14:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198446467">said</a>:</p>
<blockquote>
<p>One thing I was hoping to get out of this meeting would be to identify who has an understanding of this part of the compiler.</p>
</blockquote>
<p>I've looked at this a little bit anticipating that it could be affecting polymorphisation, and I'm happy to help out and dive deeper (exams have just finished, so just starting to get polymorphisation back in cache).</p>



<a name="198446642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446642">(May 22 2020 at 14:19)</a>:</h4>
<p>This is mentioned here <a href="https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs#L73">https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs#L73</a></p>



<a name="198446686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446686">(May 22 2020 at 14:19)</a>:</h4>
<p>and is implemented here <a href="https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs#L555">https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs#L555</a></p>



<a name="198446691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446691">(May 22 2020 at 14:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198446580">said</a>:</p>
<blockquote>
<p>Which is that, within a CGU, we include copies of all the functions callable from the "roots" of the CGU</p>
</blockquote>
<p>oh, right. I think I forgot that detail</p>



<a name="198446769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446769">(May 22 2020 at 14:20)</a>:</h4>
<p>even so, the merging process would still benefit from being aware of this, right?</p>



<a name="198446808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446808">(May 22 2020 at 14:20)</a>:</h4>
<p>Perhaps yeah.</p>



<a name="198446811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446811">(May 22 2020 at 14:20)</a>:</h4>
<p>because those copies are creating extra work that would be eliminated by smarter merging</p>



<a name="198446840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446840">(May 22 2020 at 14:20)</a>:</h4>
<p>(at least, I <strong>hope</strong> it would be eliminated.)</p>



<a name="198446842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446842">(May 22 2020 at 14:20)</a>:</h4>
<p>I would think merging CGUs that share large overlaps of the same functions would result in less duplicate code</p>



<a name="198446847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446847">(May 22 2020 at 14:20)</a>:</h4>
<p>Wait, we include copies of <em>all</em> the callable functions?</p>



<a name="198446865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446865">(May 22 2020 at 14:20)</a>:</h4>
<p>Or those that are marked <code>#[inline]</code> or some other heuristic</p>



<a name="198446871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446871">(May 22 2020 at 14:20)</a>:</h4>
<p>ones from the same module that comment says</p>



<a name="198446880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446880">(May 22 2020 at 14:21)</a>:</h4>
<p>even if not marked inline</p>



<a name="198446907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446907">(May 22 2020 at 14:21)</a>:</h4>
<p>And if marked <code>#[inline(never)]</code>?</p>



<a name="198446908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446908">(May 22 2020 at 14:21)</a>:</h4>
<p>OK.</p>



<a name="198446919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446919">(May 22 2020 at 14:21)</a>:</h4>
<p>wait, hold on, that's just a consequence of the cgu choice</p>



<a name="198446926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446926">(May 22 2020 at 14:21)</a>:</h4>
<p>/me thinks more</p>



<a name="198446954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198446954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198446954">(May 22 2020 at 14:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198446842">said</a>:</p>
<blockquote>
<p>I would think merging CGUs that share large overlaps of the same functions would result in less duplicate code</p>
</blockquote>
<p>Maybe we could compute a "distance" between two CGU that was more or less representative of this overlap, and use that as a heuristic for picking CGU pairs for the purposes of merging?</p>



<a name="198447015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447015">(May 22 2020 at 14:22)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> can you confirm wheter it makes copies from other modules even if they aren't marked <code>#[inline]</code> ?</p>



<a name="198447037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447037">(May 22 2020 at 14:22)</a>:</h4>
<p>Hmm....</p>



<a name="198447111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447111">(May 22 2020 at 14:22)</a>:</h4>
<p>actually, its seems easy to conclude that <em>either</em> way, there's potentially stuff to investigate here</p>



<a name="198447124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447124">(May 22 2020 at 14:22)</a>:</h4>
<p>I've definitely seen code from other CGUs get included but I can't recall if it's due to <code>#[inline]</code> or not.</p>



<a name="198447134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447134">(May 22 2020 at 14:22)</a>:</h4>
<p>I think the inlining-specific movement of mono items between the codegen units only considers those marked with <code>#[inline]</code>.</p>



<a name="198447153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447153">(May 22 2020 at 14:23)</a>:</h4>
<p>(based on the top comment)</p>



<a name="198447158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447158">(May 22 2020 at 14:23)</a>:</h4>
<p>regardless of how/whether duplication is done, a smarter merge strategy might be good</p>



<a name="198447209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447209">(May 22 2020 at 14:23)</a>:</h4>
<p>I think it must <em>only</em> be <code>#[inline]</code> items otherwise the CGUs would all be much bigger.</p>



<a name="198447257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447257">(May 22 2020 at 14:23)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="sd">//! - The partitioning algorithm has to know which functions are likely to get</span>
<span class="sd">//!   inlined, so it can distribute function instantiations accordingly. Since</span>
<span class="sd">//!   there is no way of knowing for sure which functions LLVM will decide to</span>
<span class="sd">//!   inline in the end, we apply a heuristic here: Only functions marked with</span>
<span class="sd">//!   `#[inline]` are considered for inlining by the partitioner. The current</span>
<span class="sd">//!   implementation will not try to determine if a function is likely to be</span>
<span class="sd">//!   inlined by looking at the functions definition.</span>
</code></pre></div>



<a name="198447386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447386">(May 22 2020 at 14:24)</a>:</h4>
<p>So, we've talked a lot about the specifics of the current algorithm. Are there other questions people have that we should address about it now or should we move on?</p>



<a name="198447401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447401">(May 22 2020 at 14:24)</a>:</h4>
<p>Thank you <span class="user-mention" data-user-id="116107">@davidtwco</span>, I was copying the same snippet :3</p>



<a name="198447411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447411">(May 22 2020 at 14:24)</a>:</h4>
<p>(Just trying to watch the clock)</p>



<a name="198447447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447447">(May 22 2020 at 14:24)</a>:</h4>
<p>I think it's worth mentioning that we're modeling the current status as a local maxima</p>



<a name="198447486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447486">(May 22 2020 at 14:25)</a>:</h4>
<p>Like, it's more or less optimized for how we generate MIR today</p>



<a name="198447520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447520">(May 22 2020 at 14:25)</a>:</h4>
<p>BUT it's just a local optimum, and not what we really want. We seem to get regressions with every other MIR opt :P</p>



<a name="198447582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447582">(May 22 2020 at 14:26)</a>:</h4>
<p>Does that make sense?</p>



<a name="198447610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447610">(May 22 2020 at 14:26)</a>:</h4>
<p>Yeah, so the theory <span class="user-mention" data-user-id="124288">@oli</span>  and I have is that the algorithm got tweaked per how rustc works "today" and the MIR we generate gets tweaked to make the partitioning logic happy and so on.</p>



<a name="198447625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447625">(May 22 2020 at 14:26)</a>:</h4>
<p>As in, we may only see benefits from changing this strategy if we do it in tandem with other changes to e..g. MIR code gen?</p>



<a name="198447636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447636">(May 22 2020 at 14:26)</a>:</h4>
<p>Potentially yeah</p>



<a name="198447642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447642">(May 22 2020 at 14:26)</a>:</h4>
<p>Or said another way</p>



<a name="198447686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447686">(May 22 2020 at 14:27)</a>:</h4>
<p>We may only see benefits from further MIR optimizations if we tweak the partitioning logic.</p>



<a name="198447716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447716">(May 22 2020 at 14:27)</a>:</h4>
<p>ah, okay, I was wondering if I was supposed to read <span class="user-mention" data-user-id="212698">@Félix Fischer</span> 's comment with that (bidirectional) interpretation</p>



<a name="198447721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447721">(May 22 2020 at 14:27)</a>:</h4>
<p>is the concern that MIR optimizations are limited by what they see from other CGUs?</p>



<a name="198447771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447771">(May 22 2020 at 14:28)</a>:</h4>
<p>or is that we think LLVM is not able to do the inlining that would be imp't</p>



<a name="198447783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447783">(May 22 2020 at 14:28)</a>:</h4>
<p>I don't think so but perhaps I'm misinterpreting your question <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="198447791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447791">(May 22 2020 at 14:28)</a>:</h4>
<p>I think my question is confused</p>



<a name="198447803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447803">(May 22 2020 at 14:28)</a>:</h4>
<p>all of our opts happen before cgu partionining</p>



<a name="198447807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447807">(May 22 2020 at 14:28)</a>:</h4>
<p>MIR optimizations generally don't care about CGU partitioning since it happens later in the compiler.</p>



<a name="198447809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447809">(May 22 2020 at 14:28)</a>:</h4>
<p>so I guess I don't quite understand how it interacts with the mir opts I guess</p>



<a name="198447810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447810">(May 22 2020 at 14:28)</a>:</h4>
<p>Yeah, exactly.</p>



<a name="198447815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447815">(May 22 2020 at 14:28)</a>:</h4>
<p>Oh</p>



<a name="198447820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447820">(May 22 2020 at 14:28)</a>:</h4>
<p>So</p>



<a name="198447836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447836">(May 22 2020 at 14:29)</a>:</h4>
<p>What we think is happening, is that as we optimize things, that changes the "estimated size" of a MIR function.</p>



<a name="198447858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447858">(May 22 2020 at 14:29)</a>:</h4>
<p>That estimated size is critical to the CGU partitioning algorithm because it uses it to estimate how big CGUs are</p>



<a name="198447872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447872">(May 22 2020 at 14:29)</a>:</h4>
<p>Which controls which ones get merged (or not)</p>



<a name="198447951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447951">(May 22 2020 at 14:30)</a>:</h4>
<p>And because of that, there's been a sort of "selective pressure" influencing which MIR optimisations we've adopted and which we haven't?</p>



<a name="198447956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447956">(May 22 2020 at 14:30)</a>:</h4>
<p>Have we tried pre-estimating the sizes and using those instead of post-opt sizes? Obviously they're "wrong" but could give some idea of whether this theory is right, correct?</p>



<a name="198447958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447958">(May 22 2020 at 14:30)</a>:</h4>
<p>So as MIR optimizations play with the amount of MIR statements in a <code>Body</code>, it changes which CGU those are potentially included in.</p>



<a name="198447972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447972">(May 22 2020 at 14:30)</a>:</h4>
<p>so there's a tension here that I want to try to make explicit</p>



<a name="198447975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447975">(May 22 2020 at 14:30)</a>:</h4>
<p>Yes, exactly <span class="user-mention" data-user-id="116107">@davidtwco</span></p>



<a name="198447987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198447987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198447987">(May 22 2020 at 14:30)</a>:</h4>
<p>you're pointing out that regressions occur when you try to add some mir-opt</p>



<a name="198448025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448025">(May 22 2020 at 14:31)</a>:</h4>
<p>and those regressions are being caused by issues with the partitioning (or cgu merging scheme, if you prefer)</p>



<a name="198448026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448026">(May 22 2020 at 14:31)</a>:</h4>
<p>Yeah, specifically regressions from LLVM where the number of CGUs codegenned changes</p>



<a name="198448037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448037">(May 22 2020 at 14:31)</a>:</h4>
<p>but the regressions here</p>



<a name="198448044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448044">(May 22 2020 at 14:31)</a>:</h4>
<p>they are in the <em>quality</em> of the generated object code</p>



<a name="198448054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448054">(May 22 2020 at 14:31)</a>:</h4>
<p>not in the compile time, right?</p>



<a name="198448074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448074">(May 22 2020 at 14:31)</a>:</h4>
<p>or are you talking about regressions in compile time</p>



<a name="198448075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448075">(May 22 2020 at 14:31)</a>:</h4>
<p>I'm not sure what you mean by "here"</p>



<a name="198448095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448095">(May 22 2020 at 14:31)</a>:</h4>
<p>you say "things regressed"</p>



<a name="198448110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448110">(May 22 2020 at 14:31)</a>:</h4>
<p>I want to confirm that what kinds of regressions we're talking about</p>



<a name="198448113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448113">(May 22 2020 at 14:31)</a>:</h4>
<p>Yeah, by regressions I mean compile time regressions, not code quality regressions.</p>



<a name="198448124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448124">(May 22 2020 at 14:32)</a>:</h4>
<p>oh, you <em>do</em> mean compile time regressions. Okay</p>



<a name="198448139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448139">(May 22 2020 at 14:32)</a>:</h4>
<p>My understanding is that the changes to merging/partitioning mean that we are regressing on incremental compiles, because where before we skipped codegen we no longer can (because we merged different things)</p>



<a name="198448144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448144">(May 22 2020 at 14:32)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I'm curious -- have you tested what happens with one partition? Also, in release builds, do we partition by default? I forget.</p>



<a name="198448164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448164">(May 22 2020 at 14:32)</a>:</h4>
<p>Oh, thank you for bringing that up (<span class="user-mention" data-user-id="116083">@pnkfelix</span>). Yas. As Wesley says, it's compile-time regressions</p>



<a name="198448186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448186">(May 22 2020 at 14:32)</a>:</h4>
<p>The optimisations that we've wanted to adopt and haven't yet - which motivated these discussions - have we tested those with <code>codegen-units=1</code>? Is my logic right that-</p>
<p>...what <span class="user-mention" data-user-id="116009">@nikomatsakis</span> said I guess.</p>



<a name="198448200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448200">(May 22 2020 at 14:32)</a>:</h4>
<p>Or maybe my question is answered by the point that this is compilation time</p>



<a name="198448212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448212">(May 22 2020 at 14:32)</a>:</h4>
<p>Yeah, we still partition in release mode</p>



<a name="198448222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448222">(May 22 2020 at 14:32)</a>:</h4>
<p>Because we want parallel codegen</p>



<a name="198448233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448233">(May 22 2020 at 14:32)</a>:</h4>
<p>Right, I remember we debated about it for some time</p>



<a name="198448240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448240">(May 22 2020 at 14:32)</a>:</h4>
<p>16 partitions is the default w/o incremental, I think with incremental we have some more complicated scheme but I'm not sure</p>



<a name="198448241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448241">(May 22 2020 at 14:32)</a>:</h4>
<p>can you confirm <span class="user-mention" data-user-id="116122">@simulacrum</span> 's statement, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> ?</p>



<a name="198448259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448259">(May 22 2020 at 14:33)</a>:</h4>
<p>are the regressions largely affecting incremental alone?</p>



<a name="198448281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448281">(May 22 2020 at 14:33)</a>:</h4>
<p>Which has the side effect that people that <em>really</em> care about runtime performance or code size set the CGU count to 1.</p>



<a name="198448314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448314">(May 22 2020 at 14:33)</a>:</h4>
<p>Let me find an example...</p>



<a name="198448382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448382">(May 22 2020 at 14:34)</a>:</h4>
<p>(because I can definitely believe that mir-opts =&gt; code size changes =&gt; totally different partitioning =&gt; completely different performance profile for incremental.)</p>



<a name="198448425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448425">(May 22 2020 at 14:34)</a>:</h4>
<p>they'll affect non-incremental too, to be clear, just to a lesser extent because it's a matter of how the work is distributed (though you can get 200% work, AIUI, or more, since we duplicate functions).</p>



<a name="198448427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448427">(May 22 2020 at 14:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198448259">said</a>:</p>
<blockquote>
<p>are the regressions largely affecting incremental alone?</p>
</blockquote>
<p>If I recall correctly, that was the case for one of my PRs. I think Wesley's looking for that one or one that's similar :3</p>



<a name="198448453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448453">(May 22 2020 at 14:34)</a>:</h4>
<p>Yeah, I would say in general this is mostly an issue for incremental tests.</p>



<a name="198448524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448524">(May 22 2020 at 14:35)</a>:</h4>
<p>but incremental is where we see "compile times got 50% worse" because, well, we started doing 2x work in llvm</p>



<a name="198448551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448551">(May 22 2020 at 14:35)</a>:</h4>
<p>one could argue that this is also a symptom of our tests</p>



<a name="198448561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448561">(May 22 2020 at 14:35)</a>:</h4>
<p>I think the most extreme example I've seen is <span class="user-mention" data-user-id="116118">@Matthew Jasper</span>'s PR which reworked some drop logic</p>



<a name="198448577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448577">(May 22 2020 at 14:35)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/71840">https://github.com/rust-lang/rust/pull/71840</a></p>



<a name="198448584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448584">(May 22 2020 at 14:35)</a>:</h4>
<p>(Do we duplicate <code>#[inline]</code> functions in debug builds also, or only release?)</p>



<a name="198448587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448587">(May 22 2020 at 14:35)</a>:</h4>
<p>I suspect that it matters a <em>lot</em> where you put the <code>println!</code> or whatever; we don't have great coverage</p>



<a name="198448590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448590">(May 22 2020 at 14:35)</a>:</h4>
<p><a href="https://perf.rust-lang.org/compare.html?start=e5f35df2c6944b843b08369c4b2ff3bdb0beb2d2&amp;end=d4d72c3f314944d906c0b5214cc5062315df842b">https://perf.rust-lang.org/compare.html?start=e5f35df2c6944b843b08369c4b2ff3bdb0beb2d2&amp;end=d4d72c3f314944d906c0b5214cc5062315df842b</a></p>



<a name="198448638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448638">(May 22 2020 at 14:36)</a>:</h4>
<p>okay. so then that leads me to wonder, shifting to a different strategy that is not based on estimated cgu code sizes, but rather based on other factors that are inherent in the structucture</p>



<a name="198448648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448648">(May 22 2020 at 14:36)</a>:</h4>
<p>So</p>



<a name="198448653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448653">(May 22 2020 at 14:36)</a>:</h4>
<p>might mean that we have less noisy results when we try to evaluate impact of changes</p>



<a name="198448670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448670">(May 22 2020 at 14:36)</a>:</h4>
<p>That's one of the observations I had: We use the same CGU partitioning algorithm for all build types.</p>



<a name="198448672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448672">(May 22 2020 at 14:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198448584">said</a>:</p>
<blockquote>
<p>(Do we duplicate <code>#[inline]</code> functions in debug builds also, or only release?)</p>
</blockquote>
<p>(my understanding, from the doc comment, is that we always do - the algorithm itself doesn't appear to change, just the number of codegen-units?)</p>



<a name="198448693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448693">(May 22 2020 at 14:37)</a>:</h4>
<p>to my knowledge debug and release builds both have 16 codegen units by default</p>



<a name="198448702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448702">(May 22 2020 at 14:37)</a>:</h4>
<p>incremental may change that</p>



<a name="198448709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448709">(May 22 2020 at 14:37)</a>:</h4>
<p>When I suspect there are perhaps better strategies for various types of builds.</p>



<a name="198448724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448724">(May 22 2020 at 14:37)</a>:</h4>
<p>debug-incremental vs release-no-incremental for example.</p>



<a name="198448764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448764">(May 22 2020 at 14:37)</a>:</h4>
<p>Am i right that the strategy of merging two smallest cgu's is essentially prioritizing load balancing over all other metrics?</p>



<a name="198448776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448776">(May 22 2020 at 14:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198448653">said</a>:</p>
<blockquote>
<p>[shifting to a different strategy that is not based on estimated cgu code sizes, but rather based on other factors that are inherent in the structucture] might mean that we have less noisy results when we try to evaluate impact of changes</p>
</blockquote>
<p>That sounds like a good starting principle, I like that :)</p>



<a name="198448779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448779">(May 22 2020 at 14:37)</a>:</h4>
<p>Kind of yeah</p>



<a name="198448835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448835">(May 22 2020 at 14:38)</a>:</h4>
<p>It's a bit weird IMO that it doesn't split huge CGUs</p>



<a name="198448874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448874">(May 22 2020 at 14:38)</a>:</h4>
<p>Like you can wind up with <code>CGU0: 124, CGU1: 431, CGU2: 123456</code></p>



<a name="198448887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448887">(May 22 2020 at 14:38)</a>:</h4>
<p>even with the current strategy we commonly end up with one huge cgu -- I know historically this has been the case for a servo crate and rustc_middle and that means you're waiting for it to compile forever</p>



<a name="198448896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448896">(May 22 2020 at 14:38)</a>:</h4>
<p>and then obviously a change that requires regenerating CGU2 takes forever</p>



<a name="198448941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448941">(May 22 2020 at 14:39)</a>:</h4>
<p>so that's an interesting point too then: We probably <em>should</em> be considering splitting cgu's up</p>



<a name="198448973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448973">(May 22 2020 at 14:39)</a>:</h4>
<p>as well as revising the merge strategy, and maybe even revising how we select the initial set of cgu's.</p>



<a name="198448993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198448993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198448993">(May 22 2020 at 14:40)</a>:</h4>
<p>So one idea I've been experimenting with is that in debug-incremental, we should try to partition everything into it's own CGU as much as possible.</p>



<a name="198449045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449045">(May 22 2020 at 14:40)</a>:</h4>
<p>On the theory that allows incremental to do the least work</p>



<a name="198449062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449062">(May 22 2020 at 14:40)</a>:</h4>
<p>(I've been sitting here musing if we should add a <code>-Z</code> flag that lets you say "use the one file per cgu for the initial set of cgus", to get something more like what clang does)</p>



<a name="198449072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449072">(May 22 2020 at 14:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198448993">said</a>:</p>
<blockquote>
<p>So one idea I've been experimenting with is that in debug-incremental, we should try to partition everything into it's own CGU as much as possible.</p>
</blockquote>
<p>That makes a lot of sense. Specially because in debug we don't care as much about optimizations</p>



<a name="198449086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449086">(May 22 2020 at 14:40)</a>:</h4>
<p>...right?</p>



<a name="198449094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449094">(May 22 2020 at 14:40)</a>:</h4>
<p>(and another <code>-Z</code> flags that lets you say "start with each function in its own cgu")</p>



<a name="198449125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449125">(May 22 2020 at 14:41)</a>:</h4>
<p>I have an extremely hacky version of this <a href="https://github.com/rust-lang/rust/pull/71349">https://github.com/rust-lang/rust/pull/71349</a></p>



<a name="198449131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449131">(May 22 2020 at 14:41)</a>:</h4>
<p>Do we know why the original algorithm decided to split source-level modules into generic and non-generic codegen units?</p>



<a name="198449134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449134">(May 22 2020 at 14:41)</a>:</h4>
<p>I assume "each function in its own cgu" is basically what <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> is suggesting as maximizing the initial partition, right?</p>



<a name="198449175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449175">(May 22 2020 at 14:41)</a>:</h4>
<p>With mixed but interesting results <a href="https://perf.rust-lang.org/compare.html?start=0aa6751c19d3ba80df5b0b02c00bf44e13c97e80&amp;end=35fdb7107589ab8f0cce89e7a5790f12c40ca662">https://perf.rust-lang.org/compare.html?start=0aa6751c19d3ba80df5b0b02c00bf44e13c97e80&amp;end=35fdb7107589ab8f0cce89e7a5790f12c40ca662</a></p>



<a name="198449185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449185">(May 22 2020 at 14:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> Yeah</p>



<a name="198449194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449194">(May 22 2020 at 14:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I think the Rust algorithm for "what can get inlined" was decided long ago and since then std and similar have been carefully annotated respecting it, e.g. you'll find very few <code>#[inline]</code> tagged functions in std if they're generic because of this</p>



<a name="198449258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449258">(May 22 2020 at 14:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> it's talked a bit about here <a href="https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs#L38">https://github.com/rust-lang/rust/blob/e91aebc1a3835b9b420da0c021e211175a724b8d/src/librustc_mir/monomorphize/partitioning.rs#L38</a></p>



<a name="198449262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449262">(May 22 2020 at 14:42)</a>:</h4>
<p>(since <code>#[inline]</code> today plays two roles: makes something <em>eligible</em> for inlining but also bumps priorities to LLVM)</p>



<a name="198449391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449391">(May 22 2020 at 14:43)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span>, maybe good to discuss what regressions we're willing to accept? I doubt we can find something that's better (or not worse at least) in 100% of cases while making improvements</p>



<a name="198449404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449404">(May 22 2020 at 14:43)</a>:</h4>
<p>(we have ~15 minutes left)</p>



<a name="198449418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449418">(May 22 2020 at 14:43)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="116122">@simulacrum</span></p>



<a name="198449436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449436">(May 22 2020 at 14:43)</a>:</h4>
<p>Let me copy some things in from the gist</p>



<a name="198449510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449510">(May 22 2020 at 14:44)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Key design questions

    Is there currently an expert on the compiler team we should be talking to?

    Does anyone have ideas for improving the current algorithm?

    Does anyone have ideas for a different algorithm that would perform better?

    Is regressing some types of compilation performance more acceptable than others? For example, how much do we care about fat LTO + release vs regular release vs debug?

    What should the performance criteria be for merging changes?
        &quot;No regressions&quot;: the default and the &quot;safest&quot; answer but makes it very challenging to land any improvements.
        &quot;big enough to offset small losses&quot;
        &quot;bias toward improvements on large crates&quot;
        others?

Ideally we would identify several ideas to try with the current algorithm and one or two different algorithms that could be implemented and tested in parallel.
</code></pre></div>



<a name="198449541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449541">(May 22 2020 at 14:44)</a>:</h4>
<p>One thing I will say</p>



<a name="198449551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449551">(May 22 2020 at 14:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198449391">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span>, maybe good to discuss what regressions we're willing to accept? I doubt we can find something that's better (or not worse at least) in 100% of cases while making improvements</p>
</blockquote>
<p>And also if our theory of local maxima holds, we'll probably be seeing overall regressions from small changes to the algorithm.</p>



<a name="198449568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449568">(May 22 2020 at 14:44)</a>:</h4>
<p>I don't think there's a real expert right now, but we should form some :)</p>



<a name="198449612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449612">(May 22 2020 at 14:45)</a>:</h4>
<p>Maybe this would blend nicely with my hope to make a WG-incr-comp</p>



<a name="198449628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449628">(May 22 2020 at 14:45)</a>:</h4>
<p>of course codegen units are a broader topic than incr comp</p>



<a name="198449637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449637">(May 22 2020 at 14:45)</a>:</h4>
<p>but they are clearly closely coupled</p>



<a name="198449731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449731">(May 22 2020 at 14:46)</a>:</h4>
<p>There's definitely a strong relationship there</p>



<a name="198449766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449766">(May 22 2020 at 14:46)</a>:</h4>
<p>Yas. And I think CGU's most relevant target are incremental compilation scenarios</p>



<a name="198449830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449830">(May 22 2020 at 14:47)</a>:</h4>
<p>So I think we've talked a bit about the first question and it sounds like we don't have an expert but we want to have some.</p>



<a name="198449876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449876">(May 22 2020 at 14:47)</a>:</h4>
<p>It sounds like <span class="user-mention" data-user-id="116009">@nikomatsakis</span> and maybe <span class="user-mention" data-user-id="116083">@pnkfelix</span> probably understand a bit about the overall backend and how it interacts with LLVM</p>



<a name="198449882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449882">(May 22 2020 at 14:47)</a>:</h4>
<p>?</p>



<a name="198449966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449966">(May 22 2020 at 14:48)</a>:</h4>
<p>I have a decent 'big picture' view</p>



<a name="198449977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449977">(May 22 2020 at 14:48)</a>:</h4>
<p>So perhaps they would be good to talk to about "big picture" questions?</p>



<a name="198449980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449980">(May 22 2020 at 14:48)</a>:</h4>
<p>Oh</p>



<a name="198449988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449988">(May 22 2020 at 14:48)</a>:</h4>
<p>and I talked a lot to <span class="user-mention" data-user-id="124287">@mw</span> when he was doing the design work</p>



<a name="198449994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198449994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198449994">(May 22 2020 at 14:48)</a>:</h4>
<p>I think I do. I'm embarrassed that I didn't really grok the merging strategy until now</p>



<a name="198450009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450009">(May 22 2020 at 14:48)</a>:</h4>
<p>but it's a bit out of cache and I know there were tweaks in the interim</p>



<a name="198450042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450042">(May 22 2020 at 14:49)</a>:</h4>
<p>I think I'm coming up to speed on the actual algorithm but I lack a lot of background knowledge about LLVM</p>



<a name="198450073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450073">(May 22 2020 at 14:49)</a>:</h4>
<p>So having somebody to bounce those kinds of questions off of would be helpful.</p>



<a name="198450088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450088">(May 22 2020 at 14:49)</a>:</h4>
<p>so when it comes to the specifics of the partitioning strategy I suspect you all grok it more</p>



<a name="198450095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450095">(May 22 2020 at 14:49)</a>:</h4>
<p>all of my LLVM knowledge has been learned on demand in order to resolve those ThinLTO+incremental linking bugs</p>



<a name="198450121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450121">(May 22 2020 at 14:49)</a>:</h4>
<p>Maybe we really should form that working group...</p>



<a name="198450198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450198">(May 22 2020 at 14:50)</a>:</h4>
<p>Ok, anyway</p>



<a name="198450218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450218">(May 22 2020 at 14:50)</a>:</h4>
<p>I think I'll draft a proposal (RFC, whatever the protocol is) today for a WG</p>



<a name="198450223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450223">(May 22 2020 at 14:50)</a>:</h4>
<blockquote>
<p>Does anyone have ideas for improving the current algorithm?</p>
</blockquote>



<a name="198450245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450245">(May 22 2020 at 14:50)</a>:</h4>
<p>So I've mentioned an idea I had but I don't want to monopolize the conversation</p>



<a name="198450304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450304">(May 22 2020 at 14:51)</a>:</h4>
<p>i have ideas, yes. But I also think there must be tons of prior work in this area?</p>



<a name="198450355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450355">(May 22 2020 at 14:51)</a>:</h4>
<p>That's a good point.</p>



<a name="198450451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450451">(May 22 2020 at 14:52)</a>:</h4>
<p>Is there standard terminology for this? I thought our codegen unit partitioning terminology was rustc specific.</p>



<a name="198450473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450473">(May 22 2020 at 14:52)</a>:</h4>
<p>Perhaps I should do some more research</p>



<a name="198450499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450499">(May 22 2020 at 14:52)</a>:</h4>
<p>In terms of the literature, I'm betting "compilation unit" is popular</p>



<a name="198450534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450534">(May 22 2020 at 14:53)</a>:</h4>
<p>That's very helpful</p>



<a name="198450545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450545">(May 22 2020 at 14:53)</a>:</h4>
<p>but then maybe I'm wrong, in terms of whether a bunch of people have researched partitioning schemes there</p>



<a name="198450557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450557">(May 22 2020 at 14:53)</a>:</h4>
<p>(versus just assuming "use whatever the user gave to you")</p>



<a name="198450588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450588">(May 22 2020 at 14:53)</a>:</h4>
<p>So maybe that's worth talking about a bit?</p>



<a name="198450599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450599">(May 22 2020 at 14:53)</a>:</h4>
<p>I guess I was implicitly assuming this was something that rustc should do</p>



<a name="198450600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450600">(May 22 2020 at 14:53)</a>:</h4>
<p>/me is Asking Jeeves</p>



<a name="198450663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450663">(May 22 2020 at 14:54)</a>:</h4>
<p>I think it could be very useful to at least <em>try out</em> a per-file scheme</p>



<a name="198450699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450699">(May 22 2020 at 14:54)</a>:</h4>
<p>at the very least, such a scheme should mean that changing a span will only pollute the other functions in <em>your initial cgu</em></p>



<a name="198450707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450707">(May 22 2020 at 14:54)</a>:</h4>
<p>Would making the user have a more direct responsibility in this regard be desired/acceptable?</p>



<a name="198450730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450730">(May 22 2020 at 14:54)</a>:</h4>
<p>this "merging minimum size cgus" thing means that changes to spans can pollute pretty much anywhere</p>



<a name="198450734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450734">(May 22 2020 at 14:54)</a>:</h4>
<p>Isn't that what the current scheme approximates by being per-module? (of course, it then gets split into generic/non-generic and then merged again)</p>



<a name="198450740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450740">(May 22 2020 at 14:54)</a>:</h4>
<p>(right?)</p>



<a name="198450767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450767">(May 22 2020 at 14:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198450734">said</a>:</p>
<blockquote>
<p>Isn't that what the current scheme approximates by being per-module? (of course, it then gets split into generic/non-generic and then merged again)</p>
</blockquote>
<p>Well I was figuring that one file may have many modules</p>



<a name="198450770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450770">(May 22 2020 at 14:55)</a>:</h4>
<p>Yeah, that's my understanding</p>



<a name="198450787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450787">(May 22 2020 at 14:55)</a>:</h4>
<p>but you're right, <span class="user-mention" data-user-id="116107">@davidtwco</span> ,that current best practices for rust may imply one module per file anyway</p>



<a name="198450797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450797">(May 22 2020 at 14:55)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I don't think per-file and per-module are appreciably different</p>



<a name="198450825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450825">(May 22 2020 at 14:55)</a>:</h4>
<p>and definitely when we settled on per-module the intent was to be "more or less the same" as per-file</p>



<a name="198450847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450847">(May 22 2020 at 14:55)</a>:</h4>
<p>that said, there are the twists like "generic vs non-generic", and I don't remember that well the motivation there</p>



<a name="198450853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450853">(May 22 2020 at 14:56)</a>:</h4>
<p>yeah, they definitely aren't the same thing, but my gut feeling is that the difference would be negligible.</p>



<a name="198450913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450913">(May 22 2020 at 14:56)</a>:</h4>
<p>So</p>



<a name="198450918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450918">(May 22 2020 at 14:56)</a>:</h4>
<p>4 minutes left</p>



<a name="198450947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450947">(May 22 2020 at 14:56)</a>:</h4>
<p>I guess one last thing, if we have time, might be to talk about what <span class="user-mention" data-user-id="116122">@simulacrum</span>  mentioned earlier</p>



<a name="198450968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450968">(May 22 2020 at 14:56)</a>:</h4>
<p>What kind of performance regressions are acceptable?</p>



<a name="198450980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450980">(May 22 2020 at 14:56)</a>:</h4>
<p>basically when we concocted the current scheme <em>initially</em>, the idea was</p>
<ul>
<li>we could get smart</li>
<li>but let's start with something relatively predictable that people can optimize around</li>
<li>and we can change it later when we've got more data</li>
</ul>
<p>but it seems like it evolved a reasonable amount away from "simple and predictable" in the meantime</p>



<a name="198450988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198450988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198450988">(May 22 2020 at 14:57)</a>:</h4>
<p>Or what are the performance targets?</p>



<a name="198451005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451005">(May 22 2020 at 14:57)</a>:</h4>
<p>Yeah, that's awlays a really hard question toa nswer</p>



<a name="198451012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451012">(May 22 2020 at 14:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    What should the performance criteria be for merging changes?
        &quot;No regressions&quot;: the default and the &quot;safest&quot; answer but makes it very challenging to land any improvements.
        &quot;big enough to offset small losses&quot;
        &quot;bias toward improvements on large crates&quot;
        others?
</code></pre></div>



<a name="198451014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451014">(May 22 2020 at 14:57)</a>:</h4>
<p>one thing I do recall</p>



<a name="198451025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451025">(May 22 2020 at 14:57)</a>:</h4>
<p>when we talked about this  for e.g. NLL</p>



<a name="198451031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451031">(May 22 2020 at 14:57)</a>:</h4>
<p>(Fuck I lost connection. Okay I'm on my phone now. Will read the backlog)</p>



<a name="198451039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451039">(May 22 2020 at 14:57)</a>:</h4>
<p>we came up with some thresholds that were based on human perception</p>



<a name="198451062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451062">(May 22 2020 at 14:57)</a>:</h4>
<p>I'll have to go look back, but it came down to something like .. &lt;10% people can't really tell</p>



<a name="198451090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451090">(May 22 2020 at 14:57)</a>:</h4>
<p>after that, there are gradations of how much they notice</p>



<a name="198451145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451145">(May 22 2020 at 14:58)</a>:</h4>
<p>so I think on this basis we tried to hold a strict line of 10%</p>



<a name="198451150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451150">(May 22 2020 at 14:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198450988">said</a>:</p>
<blockquote>
<p>Or what are the performance targets?</p>
</blockquote>
<p>it would be nice, on this note, if we somehow indicated on perf.rlo how "important" each benchmark was, or some way to track back to who even cared about that case</p>



<a name="198451169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451169">(May 22 2020 at 14:58)</a>:</h4>
<p>with the general rule of like "but those should be rare"</p>



<a name="198451180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451180">(May 22 2020 at 14:58)</a>:</h4>
<p>I can go back and find the actual citations and so forth</p>



<a name="198451210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451210">(May 22 2020 at 14:58)</a>:</h4>
<p>but yes I agree with felix that "importance" is not uniform</p>



<a name="198451242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451242">(May 22 2020 at 14:58)</a>:</h4>
<p>I would say that "integration tests" are by far the most imp't</p>



<a name="198451263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451263">(May 22 2020 at 14:59)</a>:</h4>
<p>as in things like serde?</p>



<a name="198451277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451277">(May 22 2020 at 14:59)</a>:</h4>
<p>yes, real-world crates and things</p>



<a name="198451306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451306">(May 22 2020 at 14:59)</a>:</h4>
<p>but some of the other tests were extracted based on patterns we saw in real life so it's a bit tricky :)</p>



<a name="198451313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451313">(May 22 2020 at 14:59)</a>:</h4>
<p>right. stress tests are like microbenchmarks</p>



<a name="198451317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451317">(May 22 2020 at 14:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281/near/198450988">said</a>:</p>
<blockquote>
<p>Or what are the performance targets?</p>
</blockquote>
<p>It definitely depends on the goal - we want to maintain runtime performance for release builds but compile-time perf could probably slip there; but we want to maintain compile-times for debug builds but runtime perf could probably slip there.</p>



<a name="198451347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451347">(May 22 2020 at 14:59)</a>:</h4>
<p>they can tell you interesting things, but you shoudn't necessarily make decisions based on changes to microbenchmarks/stress tests</p>



<a name="198451359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451359">(May 22 2020 at 14:59)</a>:</h4>
<p>I 300% agree with david there</p>



<a name="198451411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451411">(May 22 2020 at 15:00)</a>:</h4>
<p>Yeah, that's why the idea of using different algorithms for different compilation modes seems so interesting to me.</p>



<a name="198451436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451436">(May 22 2020 at 15:00)</a>:</h4>
<p>I think it's ultimately kind of essential to do so</p>



<a name="198451443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451443">(May 22 2020 at 15:00)</a>:</h4>
<p>Ok. We're at 11.</p>



<a name="198451450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451450">(May 22 2020 at 15:00)</a>:</h4>
<p>I guess that's it?</p>



<a name="198451461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451461">(May 22 2020 at 15:00)</a>:</h4>
<p>One benefit of having the same algorithm is that when you optimise for it, you optimise for both debug and release.</p>



<a name="198451468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451468">(May 22 2020 at 15:00)</a>:</h4>
<p>this was really great, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span></p>



<a name="198451489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451489">(May 22 2020 at 15:00)</a>:</h4>
<p>Like... there are optimizations that are really great, but only make sense from compile time perspective in release mode</p>



<a name="198451543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451543">(May 22 2020 at 15:01)</a>:</h4>
<p>Thanks, it felt very hap-hazard to me but that's probably just because I was "under the gun" to run the meeting. <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="198451633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451633">(May 22 2020 at 15:02)</a>:</h4>
<p>If anyone has questions or stuff they want to talk about, I'm happy to chat and we can spin up a topic in <a class="stream" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler">#t-compiler</a> or something</p>



<a name="198451693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451693">(May 22 2020 at 15:02)</a>:</h4>
<p>Thanks for everyone who was here. This conversation felt really insightful to me :)</p>



<a name="198451703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/238009-t-compiler/meetings/topic/%5Bdesign%20meeting%5D%20codegen%20unit%20partitioning%20compiler-team%23281/near/198451703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/238009-t-compiler/meetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281.html#198451703">(May 22 2020 at 15:02)</a>:</h4>
<p>Have a great day/evening <a class="stream" data-stream-id="238009" href="/#narrow/stream/238009-t-compiler.2Fmeetings">#t-compiler/meetings</a> <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>