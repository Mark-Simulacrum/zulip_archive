<html>
<head><meta charset="utf-8"><title>ptr2int transmutes · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html">ptr2int transmutes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277345000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277345000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277345000">(Mar 31 2022 at 21:54)</a>:</h4>
<p>I have a new nasty example for why ptr2int transmutes are evil, and unlike my others it doesn't involve any int2ptr casts so it is somewhat orthogonal to strict aliasing: <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085144431">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085144431</a>.<br>
we have to disallow this <em>somehow</em>, not everyone agrees with the 'how' though. :D</p>



<a name="277345024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277345024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277345024">(Mar 31 2022 at 21:54)</a>:</h4>
<p>I think this relates to discussions I had with <span class="user-mention" data-user-id="143798">@Talchas</span> a few days ago</p>



<a name="277345775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277345775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277345775">(Mar 31 2022 at 22:01)</a>:</h4>
<p>Would it be allowed to transmute a pointer to an int if it doesnt have any provenance? i.e. <code>transmute::&lt;*mut u8, usize&gt;(std::ptr::null())</code></p>



<a name="277345960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277345960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277345960">(Mar 31 2022 at 22:02)</a>:</h4>
<p>So why isn't this fixed by a definition something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Byte</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Uninit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Init</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Provenance</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>We then define ints to never have provenance, and so writing an int to memory always yields bytes of the form <code>Init(val, None)</code>. Furthermore, this does not break <code>x = x;</code> being a nop, because we can claim that giving bytes in memory strictly more provenance than they had before is a refinement of the previous behavior</p>



<a name="277346351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346351">(Mar 31 2022 at 22:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277345775">said</a>:</p>
<blockquote>
<p>Would it be allowed to transmute a pointer to an int if it doesnt have any provenance? i.e. <code>transmute::&lt;*mut u8, usize&gt;(std::ptr::null())</code></p>
</blockquote>
<p>yes</p>



<a name="277346439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346439">(Mar 31 2022 at 22:07)</a>:</h4>
<p><span class="user-mention" data-user-id="310518">@Jak{e,ob} Degen</span> so you are saying loading data with provenance at int type just strips that provenance (but does <em>not</em> expose, I hope, under models that have that)?</p>



<a name="277346452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346452">(Mar 31 2022 at 22:07)</a>:</h4>
<p>Yes</p>



<a name="277346542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346542">(Mar 31 2022 at 22:08)</a>:</h4>
<p>that violates what I considered an axiom of data representation, that when you start with a bunch of bytes, convert them to a value, and convert them back to bytes, then the original representation is still an allowable representation</p>



<a name="277346552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346552">(Mar 31 2022 at 22:08)</a>:</h4>
<p>hm not sure how to best put this into words</p>



<a name="277346574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346574">(Mar 31 2022 at 22:08)</a>:</h4>
<p>basically I am not sure it truly is a refinement. it isn't in the obvious way.</p>



<a name="277346601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346601">(Mar 31 2022 at 22:09)</a>:</h4>
<p>I see what you're saying</p>



<a name="277346676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346676">(Mar 31 2022 at 22:09)</a>:</h4>
<p>Actually, hmm</p>



<a name="277346684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346684">(Mar 31 2022 at 22:09)</a>:</h4>
<p>like, with padding (the only other example we have where byte/value conversion 'changes' anything), we have that the value <code>(0u16, 2u8)</code> can be represented by <em>any</em> byte sequence matching <code>[0x00, 0x00, 0x08, _]</code></p>



<a name="277346796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346796">(Mar 31 2022 at 22:10)</a>:</h4>
<p>so when you convert the pair into its low-level representation you pick <em>any</em> value for the padding byte</p>



<a name="277346803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346803">(Mar 31 2022 at 22:10)</a>:</h4>
<p>(including possibly <code>Uninit</code>)</p>



<a name="277346866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346866">(Mar 31 2022 at 22:11)</a>:</h4>
<p>this means that if you start with some array of 4 bytes, turn it into that pair, and turn it back to the low-level rep, it is always <em>possible</em> to get exactly the original sequence (assuming no UB)</p>



<a name="277346902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346902">(Mar 31 2022 at 22:11)</a>:</h4>
<p>however, for data with provenance that is loaded into an integer type and put back into bytes, your proposal violates that property</p>



<a name="277346906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346906">(Mar 31 2022 at 22:11)</a>:</h4>
<p>and intuitively that seems bad...</p>



<a name="277346910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346910">(Mar 31 2022 at 22:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277346542">said</a>:</p>
<blockquote>
<p>that violates what I considered an axiom of data representation, that when you start with a bunch of bytes, convert them to a value, and convert them back to bytes, then the original representation is still an allowable representation</p>
</blockquote>
<p>I mean, what this does it it makes the representation relation asymmetric - in other words, the set of input bytes for which the representation relation is defined is not the same as the set of output bytes that its inverse might yield</p>



<a name="277346997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277346997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277346997">(Mar 31 2022 at 22:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277346906">said</a>:</p>
<blockquote>
<p>and intuitively that seems bad...</p>
</blockquote>
<p>I just don't share this intuition. Maybe there is some enlightening example here that I just don't know about though</p>



<a name="277347005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347005">(Mar 31 2022 at 22:12)</a>:</h4>
<p>in particular it means <code>x=x;</code> cannot <em>obviously</em> be removed</p>



<a name="277347034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347034">(Mar 31 2022 at 22:12)</a>:</h4>
<p>the program with <code>x=x</code> will strip provenance, after removing the assignment provenance is preserved in those bytes</p>



<a name="277347055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347055">(Mar 31 2022 at 22:13)</a>:</h4>
<p><code>x=x</code> is more like <code>transmute::&lt;T, T&gt;</code> isnt it?</p>



<a name="277347066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347066">(Mar 31 2022 at 22:13)</a>:</h4>
<p>yeah those are the same</p>



<a name="277347071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347071">(Mar 31 2022 at 22:13)</a>:</h4>
<p>rather than <code>transmute::&lt;ThignWithPRovenance, NoProvenance&gt;()</code></p>



<a name="277347081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347081">(Mar 31 2022 at 22:13)</a>:</h4>
<p>so we'd need a general theorem that says: adding provenance to any byte without provenance will never change program behavior or introduce UB</p>



<a name="277347091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347091">(Mar 31 2022 at 22:13)</a>:</h4>
<p>that <em>might</em> be a correct theorem but it does not seem trivial either</p>



<a name="277347176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347176">(Mar 31 2022 at 22:14)</a>:</h4>
<p>Yes, agreed. This is essentially what I was counting on when I said</p>
<blockquote>
<p>we can claim that giving bytes in memory strictly more provenance than they had before is a refinement of the previous behavior</p>
</blockquote>



<a name="277347221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347221">(Mar 31 2022 at 22:15)</a>:</h4>
<p>If such a theorem is problematic, I would love to investigate more why</p>



<a name="277347346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347346">(Mar 31 2022 at 22:16)</a>:</h4>
<p>Even if "problematic" is just "this is hard to prove" or "this is incompatible with <em>insert weird thing we probably don't want</em>" or whatever</p>



<a name="277347405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347405">(Mar 31 2022 at 22:17)</a>:</h4>
<p>yeah I agree</p>



<a name="277347447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347447">(Mar 31 2022 at 22:17)</a>:</h4>
<p>we already have a similar theorem we want but that one just seems a lot more obvious:<br>
replacing any <code>uninit</code> byte by anything else will never change program behavior or introduce UB</p>



<a name="277347543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347543">(Mar 31 2022 at 22:18)</a>:</h4>
<p>whats you GH handle so I can credit you in the GH issue?^^</p>



<a name="277347558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347558">(Mar 31 2022 at 22:18)</a>:</h4>
<p><code>@JakobDegen</code></p>



<a name="277347945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347945">(Mar 31 2022 at 22:23)</a>:</h4>
<p>okay so I think agree this might work</p>



<a name="277347968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277347968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277347968">(Mar 31 2022 at 22:23)</a>:</h4>
<p>the next question then is, do we want it? it's still 'odd': doing a transmute roundtrip irrecoverably uses provenance!</p>



<a name="277348010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277348010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277348010">(Mar 31 2022 at 22:24)</a>:</h4>
<p>presumably, code that transmutes pointers to integers does that because it uses an integer type as a "universal container" that can hold any kind of data, including pointers with provenance</p>



<a name="277348056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277348056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277348056">(Mar 31 2022 at 22:24)</a>:</h4>
<p>such code would still be broken</p>



<a name="277348146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277348146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277348146">(Mar 31 2022 at 22:25)</a>:</h4>
<p>so it might be easier to just say "this is UB", instead of saying "this is allowed but doesn't do what you think it does". (also easier then for tools like Miri to flag the error immediately, rather than flagging waaaay later that a pointer somehow lost its provenance.)</p>



<a name="277348788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277348788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277348788">(Mar 31 2022 at 22:32)</a>:</h4>
<p>Yeah, I'm not sure. It might be interesting to add a flag to miri that allows what I propose (after ptr to int transmutes are UB) and try and get some usage reports from people for whom that flag fixed things</p>



<a name="277348810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277348810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277348810">(Mar 31 2022 at 22:32)</a>:</h4>
<p>If those people don't exist, I agree that this is not very useful</p>



<a name="277351170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351170">(Mar 31 2022 at 22:58)</a>:</h4>
<p>implementing "value changes on copy" in Miri is non-trivial so dont expect such a flag any time soon</p>



<a name="277351176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351176">(Mar 31 2022 at 22:58)</a>:</h4>
<p>that's why Miri currently doesnt even reset padding on copy...</p>



<a name="277351513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351513">(Mar 31 2022 at 23:02)</a>:</h4>
<p>I mean, "on copy" is overstating the case; "cannot optimize out memcpy/transmute containing pointers to be language level copies" is bad but not as bad as that</p>



<a name="277351566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351566">(Mar 31 2022 at 23:03)</a>:</h4>
<p>?</p>



<a name="277351670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351670">(Mar 31 2022 at 23:05)</a>:</h4>
<p>not being able to optimize the chain <code>transmute_to_ptr(transmute_to_usize(ptr))</code>down to <code>ptr</code> because it is a side effect does not imply <code>x=x</code> is a side effect</p>



<a name="277351804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351804">(Mar 31 2022 at 23:06)</a>:</h4>
<p>it does, under some light assumnptions about how the semantics is structured</p>



<a name="277351829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351829">(Mar 31 2022 at 23:07)</a>:</h4>
<p>also that's not even the relevant optimization here</p>



<a name="277351843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351843">(Mar 31 2022 at 23:07)</a>:</h4>
<p>(like, "any <code>ptr::copy_memory</code> at all is a side effect" does not imply "<code>x=x</code> is a side effect")</p>



<a name="277351870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351870">(Mar 31 2022 at 23:07)</a>:</h4>
<p>no side-effects have been proposed here</p>



<a name="277351887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351887">(Mar 31 2022 at 23:07)</a>:</h4>
<p>just non-identity transformations as part of the value representation relating values to bytes</p>



<a name="277351940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351940">(Mar 31 2022 at 23:08)</a>:</h4>
<p>the optimization you mention wasnt even mentioned</p>



<a name="277351945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351945">(Mar 31 2022 at 23:08)</a>:</h4>
<p>by "is a side effect" I mean "strips provenance"</p>



<a name="277351949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351949">(Mar 31 2022 at 23:08)</a>:</h4>
<p>IOW, I cant relate what you say to the previous discussion^^</p>



<a name="277351984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351984">(Mar 31 2022 at 23:08)</a>:</h4>
<p>also we concluded that removing <code>x=x;</code> was probably still possible under some reasonable assumption about the semantics as a whole</p>



<a name="277351991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277351991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277351991">(Mar 31 2022 at 23:09)</a>:</h4>
<p>so... <em>Ralf is confused</em></p>



<a name="277352167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277352167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277352167">(Mar 31 2022 at 23:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277351945">said</a>:</p>
<blockquote>
<p>by "is a side effect" I mean "strips provenance"</p>
</blockquote>
<p>the proposed way to fix this is to strip provenance every time an integer is loaded from anywhere. you cant know if the old value had provenance. so this is not about syntactic <code>transmute</code> calls or so.<br>
<code>x=x;</code> loads an integer from the place <code>x</code> and then stores it back. thus, <code>x=x;</code> is affected by what we are discussing here.</p>



<a name="277352199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277352199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277352199">(Mar 31 2022 at 23:11)</a>:</h4>
<p>to be fair, it looks like it was either Jake who started the <code>x=x</code> thing or it was carryover from some previous thread</p>



<a name="277352438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277352438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277352438">(Mar 31 2022 at 23:14)</a>:</h4>
<p>oh, I see, this is all starting at more <code>*x = *x;</code> in a rust representation of optimizations in progress, because <code>x=x</code> is the MIR syntax assuming everything is in a memory location or something like that?</p>



<a name="277352522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277352522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277352522">(Mar 31 2022 at 23:15)</a>:</h4>
<p>Yes</p>



<a name="277352587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277352587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277352587">(Mar 31 2022 at 23:16)</a>:</h4>
<p>Afaik no version of the Rust memory model proposes a location for bytes to be that isn't memory or a way to access memory that isn't through a pointer</p>



<a name="277352593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277352593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277352593">(Mar 31 2022 at 23:16)</a>:</h4>
<p>Locals are just pointers that are dereferenced implicitly</p>



<a name="277353936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277353936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277353936">(Mar 31 2022 at 23:35)</a>:</h4>
<p>well it could be <code>x=x;</code> in Rust syntax as well</p>



<a name="277354009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277354009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277354009">(Mar 31 2022 at 23:36)</a>:</h4>
<p><code>x</code> might still store pointer bytes when someone did something nasty like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">usize</span><span class="p">;</span><span class="w"></span>
<span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"></span>
<span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="c1">// the load of the RHS here loads a value with provenance</span>
</code></pre></div>



<a name="277557653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277557653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vince Mutolo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277557653">(Apr 02 2022 at 23:21)</a>:</h4>
<p>Question about the <code>deref</code> example in <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085144431">Ralf's GitHub comment</a>:</p>
<p>While (I think) I can understand why the ptr-to-int transmute is UB here, I'm having trouble seeing why a cast would be different. We'd still end up with <code>left_int</code> having the same value, which is still equal to <code>right_int</code> in that branch, and should still be replaceable (?) with <code>right_int</code>.</p>
<p>I think I'm missing some compiler magic around how ptr-to-int <em>casts</em> are treated.</p>



<a name="277558439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277558439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277558439">(Apr 02 2022 at 23:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="251214">Vince Mutolo</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277557653">said</a>:</p>
<blockquote>
<p>Question about the <code>deref</code> example in <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085144431">Ralf's GitHub comment</a>:</p>
<p>While (I think) I can understand why the ptr-to-int transmute is UB here, I'm having trouble seeing why a cast would be different. We'd still end up with <code>left_int</code> having the same value, which is still equal to <code>right_int</code> in that branch, and should still be replaceable (?) with <code>right_int</code>.</p>
<p>I think I'm missing some compiler magic around how ptr-to-int <em>casts</em> are treated.</p>
</blockquote>
<p>In a model in which we have some kind of "provenance escaping," the compiler cannot conclude that <code>(ptr_val as usize) as ptr</code> is a nop</p>



<a name="277558726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277558726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vince Mutolo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277558726">(Apr 02 2022 at 23:45)</a>:</h4>
<p>Ok, that makes sense. So the new pointer would be marked as something like "unclear provenance" and would prevent optimizations. </p>
<p>And I guess the way to get those optimizations back would be to use something like <code>left.with_addr(left_int)</code> to explicitly give the new pointer provenance.</p>



<a name="277558777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277558777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277558777">(Apr 02 2022 at 23:46)</a>:</h4>
<p>Yes</p>



<a name="277558868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277558868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vince Mutolo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277558868">(Apr 02 2022 at 23:49)</a>:</h4>
<p>Actually, I think there's still something a little fuzzy here. Your example was ((ptr as int) as ptr), whereas I think I was asking about (ptr as int) transmuted back to ptr. Would that be ok?</p>
<p>The thing I'm stumbling over is how the compiler differentiates between a pointer cast to an int and a pointer transmuted into an int. Either way we end up with an int, and AFAIK ints are untracked for provenance.</p>



<a name="277559157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277559157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277559157">(Apr 02 2022 at 23:57)</a>:</h4>
<p>So, to make this more explicit: In a weak provenance model (as it is being proposed here, there may be alternatives), when a pointer is <em>cast</em> to an int, it's provenance is "exposed" and added to a global pool of "exposed" provenances. Transmuting is just UB.</p>
<p>When an int is <em>cast</em> to a pointer, the pointer gets provenance from this global pool of provenances - there may be many possible choices, the requirement is that there exist at least one choice of provenance that makes the program have defined behavior. When an int is transmuted to a pointer, the provenance of the resulting pointer is the "null" provenance. In other words, the transmute is defined behavior of its own, but the pointer does not have valid provenance for any memory.</p>
<p>That means that this example with a ptr2int cast and int2ptr transmute would still be UB when the pointer is dereferenced (because of the null provenance)</p>



<a name="277559870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277559870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vince Mutolo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277559870">(Apr 03 2022 at 00:13)</a>:</h4>
<p>That makes total sense. Thanks. What I was missing is that the pointer-to-int cast changes the tracking of the pointer that we're casting <em>from</em> and not of the integer we're casting <em>to</em>.</p>



<a name="277560203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277560203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277560203">(Apr 03 2022 at 00:22)</a>:</h4>
<p>Technically speaking, it doesn't change the tracking of the <em>pointer</em>, but of the <em>provenance</em>. This is a bit of a pedantic distinction, but it's also an important one, because it means there's no such thing as special pointers (or integers)</p>



<a name="277560738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277560738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277560738">(Apr 03 2022 at 00:36)</a>:</h4>
<p>The dead-simplest way to make these transmutes work is to pretend that every transmute goes in and exposes (and eliminates provenance for) every reachable pointer in whatever you're transmuting, Of course, you'd pretty much make transmutes no longer NOPs, and make a lot of people very sad. I <em>think</em> this would isolate any weird behaviors to only the function that calls transmute, which means stuff like redundant store eliminations work, at the cost of making these transmutes be a massive optimization barrier.</p>



<a name="277561091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277561091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277561091">(Apr 03 2022 at 00:45)</a>:</h4>
<p>It does not isolate to functions that call transmute</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>The last statement there is a potential transmute, because <code>foo</code> may have written pointer data to <code>x</code></p>



<a name="277561154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277561154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277561154">(Apr 03 2022 at 00:46)</a>:</h4>
<p>By "transmute," we don't mean "calls to <code>std::mem::transmute</code>" but rather "any type punning through memory"</p>



<a name="277561232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277561232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vince Mutolo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277561232">(Apr 03 2022 at 00:50)</a>:</h4>
<p>This isn't the first time I've seen the word "pun" or "punning" come up in over the last few days of this discussion. How is it being used in this context?</p>



<a name="277561298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277561298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277561298">(Apr 03 2022 at 00:51)</a>:</h4>
<p>It's used for any mechanism that writes data to memory as one type and reads it from memory as a different type</p>



<a name="277561357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277561357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277561357">(Apr 03 2022 at 00:52)</a>:</h4>
<p>No idea of it's origin - I suppose it could be vaguely related to the use of "pun" as in the type of joke, since there it's the words instead of the memory that have a double meaning?</p>



<a name="277561358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277561358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277561358">(Apr 03 2022 at 00:52)</a>:</h4>
<p>the same memory has two different meanings at different types, so it's like a pun where the same word has two different meanings in different context</p>



<a name="277628692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277628692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277628692">(Apr 03 2022 at 13:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277560738">said</a>:</p>
<blockquote>
<p>The dead-simplest way to make these transmutes work is to pretend that every transmute goes in and exposes (and eliminates provenance for) every reachable pointer in whatever you're transmuting, Of course, you'd pretty much make transmutes no longer NOPs, and make a lot of people very sad. I <em>think</em> this would isolate any weird behaviors to only the function that calls transmute, which means stuff like redundant store eliminations work, at the cost of making these transmutes be a massive optimization barrier.</p>
</blockquote>
<p>note that <code>transmute</code> here means <code>mem::trasnmute</code> but also every time you read a pointer -- you dont know how the memory the pointer points to was written (it might have been at a different type). so this means a lot of exposing is happening all the time everywhere even in code that is really disciplined with pointers.</p>



<a name="277628732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277628732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277628732">(Apr 03 2022 at 13:27)</a>:</h4>
<p>disallowing transmutes (of all sorts) has the <em>huge</em> advantage that we can still support sloppy provenance via casts, <em>and only the code using them pays for that</em> (in terms of lost optimizations)</p>



<a name="277678240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277678240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277678240">(Apr 04 2022 at 03:39)</a>:</h4>
<p>I think we need another primitive to express this use case though; let's call it <code>expose_all&lt;T&gt;(p: *const T)</code> which interprets the bytes at <code>*p</code> at type <code>T</code> and exposes all pointers indicated by type <code>T</code>. For example if memory contains two pointers <code>[p1, p2]</code> and I pass a pointer to this to <code>expose_all::&lt;(usize, *const ())&gt;</code> then <code>p2</code> will be exposed.</p>
<p>Importantly, this is also "type-driven exposing" just like <code>ptr as usize</code>, there is no accidental exposing due to types not matching when you read some data. It's also clearly a machine-level no-op, which makes it easier to reason about in the IR. This can be used prior to any explicit <code>mem::transmute</code> (we might even include it as part of the desugaring of the operation) which would at least solve the problem of ptr2int2ptr transmutes done explicitly through <code>transmute</code> rather than type punning.</p>



<a name="277678584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277678584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277678584">(Apr 04 2022 at 03:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277678240">said</a>:</p>
<blockquote>
<p>which would at least solve the problem of ptr2int2ptr transmutes done explicitly through <code>transmute</code> rather than type punning.</p>
</blockquote>
<p>It's not obvious to me that this would be good.  Being able to say "transmutes, unions, and type punning all have the same rules" is nice, even if it means fewer things work than if some of them special cased some things.</p>



<a name="277678611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277678611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277678611">(Apr 04 2022 at 03:47)</a>:</h4>
<p>that's fair, I'm not sure I want to push for that myself. I just think it might help address some of <span class="user-mention" data-user-id="384014">@Patrick Walton</span> 's concerns about backwards compatible support for <code>mem::transmute</code></p>



<a name="277678666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277678666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277678666">(Apr 04 2022 at 03:48)</a>:</h4>
<p>The more principled approach would be to introduce this as a new function and teach people to use it as the "right" way to do abomonation type stuff</p>



<a name="277678842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277678842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277678842">(Apr 04 2022 at 03:52)</a>:</h4>
<p>There are also lots of places people use <code>transmute</code> without wanting any ptr2int or exposing stuff at all. I know I have written <code>transmute&lt;&amp;T, &amp;T&gt;</code> before when I'm feeling smarter than the borrow checker, and in that case there is really no need for any side effects at all</p>



<a name="277776026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277776026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277776026">(Apr 04 2022 at 18:39)</a>:</h4>
<p>Catching up on this. Let me see if I can hack the compiler and run it through our internal code to find ptr-to-int transmutes.</p>



<a name="277776094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277776094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277776094">(Apr 04 2022 at 18:39)</a>:</h4>
<p>I have no idea off the top of my head how common they might or might not be.</p>



<a name="277903287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277903287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277903287">(Apr 05 2022 at 16:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277628692">said</a>:</p>
<blockquote>
<p>note that transmute here means mem::trasnmute but also every time you read a pointer -- you dont know how the memory the pointer points to was written (it might have been at a different type). so this means a lot of exposing is happening all the time everywhere even in code that is really disciplined with pointers.</p>
</blockquote>
<p>I've advocated for the int2ptr as FFI calls, and I'm wondering if the same thing could work for transmutes. The following is defined in C.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cast</span><span class="p">(</span><span class="n">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Iff FFI calls can do any operation in the Rust AM, how we represent this if we make these transmutes UB? (Yes, in the absence of LTO, any Rust call to this function will not miscompile, simply because the compiler isn't smart enough)</p>



<a name="277903604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277903604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277903604">(Apr 05 2022 at 16:10)</a>:</h4>
<blockquote>
<p>I've advocated for the int2ptr as FFI calls, and I'm wondering if the same thing could work for transmutes. The following is defined in C.</p>
</blockquote>
<p>The issue is that a transmute is just caused by <code>core::mem::transmute</code>.</p>



<a name="277903802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277903802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277903802">(Apr 05 2022 at 16:12)</a>:</h4>
<p>"Transmutes" can be caused by mere memory accesses.</p>



<a name="277903934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277903934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277903934">(Apr 05 2022 at 16:13)</a>:</h4>
<p>Imagine the following trivial function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">usize</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Is the compiler allowed to optimize away the <code>x.read()</code>?</p>



<a name="277906052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277906052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277906052">(Apr 05 2022 at 16:28)</a>:</h4>
<p>The issue is that int2ptr is a one-time escape that is entirely contained in the call; a pointer pun is an ongoing escape that can occur at every pointer write + integer read that might be aliased to each other. And there's definite issues if the compiler wants to do optimizations to a function f, then inline it, then do more optimizations with different alias knowledge</p>



<a name="277906434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277906434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277906434">(Apr 05 2022 at 16:30)</a>:</h4>
<p>(and PNVI being in the source language rather than something more restrictive like PVI or handwave means you can't really say "<code>x.read();</code> is unused so it doesn't count as an escape even if it read pointer bytes")</p>



<a name="277919141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277919141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277919141">(Apr 05 2022 at 17:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277678240">said</a>:</p>
<blockquote>
<p>I think we need another primitive to express this use case though; let's call it <code>expose_all&lt;T&gt;(p: *const T)</code> which interprets the bytes at <code>*p</code> at type <code>T</code> and exposes all pointers indicated by type <code>T</code>. For example if memory contains two pointers <code>[p1, p2]</code> and I pass a pointer to this to <code>expose_all::&lt;(usize, *const ())&gt;</code> then <code>p2</code> will be exposed.</p>
<p>Importantly, this is also "type-driven exposing" just like <code>ptr as usize</code>, there is no accidental exposing due to types not matching when you read some data. It's also clearly a machine-level no-op, which makes it easier to reason about in the IR. This can be used prior to any explicit <code>mem::transmute</code> (we might even include it as part of the desugaring of the operation) which would at least solve the problem of ptr2int2ptr transmutes done explicitly through <code>transmute</code> rather than type punning.</p>
</blockquote>
<p>this doesn't help fix <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085144431">this example</a> though. even if all transmutes expose, if the compiler can assume that <code>transmute_int2ptr(transmute_ptr2int(ptr))</code> returns <code>ptr</code> (and exposes an arbitrary set of locations), that is already enough to break everything. it's not the loss of 'expose' that is the primary problem with optimizing away ptr-int-ptr roundtrips, it's the (wrong) assumption about which provenance the final pointer will pick up.</p>
<p>I don't think that's enough because you also need to do something on the 'int2ptr transmute' side. as you said yourself on GH, it's really the cast <em>back</em> that is the tricky one.</p>



<a name="277920082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277920082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277920082">(Apr 05 2022 at 18:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277903287">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277628692">said</a>:</p>
<blockquote>
<p>note that transmute here means mem::trasnmute but also every time you read a pointer -- you dont know how the memory the pointer points to was written (it might have been at a different type). so this means a lot of exposing is happening all the time everywhere even in code that is really disciplined with pointers.</p>
</blockquote>
<p>I've advocated for the int2ptr as FFI calls, and I'm wondering if the same thing could work for transmutes. The following is defined in C.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cast</span><span class="p">(</span><span class="n">int</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Iff FFI calls can do any operation in the Rust AM, how we represent this if we make these transmutes UB? (Yes, in the absence of LTO, any Rust call to this function will not miscompile, simply because the compiler isn't smart enough)</p>
</blockquote>
<p>when you call FFI code, the relevant property is that there is <em>some</em> way to express its effect on the AM through a Rust program. but that way doesn't have to be an algorithm or so, the only relevant property is that it exists at all.<br>
so if we call C code that does transmutes, we can just pretend they did casts, as far as the Rust AM is concerned.</p>



<a name="277946469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277946469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277946469">(Apr 05 2022 at 21:33)</a>:</h4>
<blockquote>
<p>when you call FFI code, the relevant property is that there is some way to express its effect on the AM through a Rust program. but that way doesn't have to be an algorithm or so, the only relevant property is that it exists at all.<br>
so if we call C code that does transmutes, we can just pretend they did casts, as far as the Rust AM is concerned.</p>
</blockquote>
<p>Right, but these are proper transmutes, which infect everything.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">cast</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a_ptr_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">a_ptr_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277954932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277954932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277954932">(Apr 05 2022 at 22:56)</a>:</h4>
<p>oh <code>cast</code> is just doing a pointer cast? you can write that in Rust. no sure why you'd expect this to be legal just because you did it in C?</p>



<a name="277954944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277954944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277954944">(Apr 05 2022 at 22:56)</a>:</h4>
<p>the actual transmute is still happening in Rust</p>



<a name="277954950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277954950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277954950">(Apr 05 2022 at 22:56)</a>:</h4>
<p>so Rust rules apply there for sure</p>



<a name="277956200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277956200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277956200">(Apr 05 2022 at 23:07)</a>:</h4>
<p>I think the compiler can't rule out the possibility that this is defined behavior, e.g. if <code>cast</code> followed the pointer and replaced the memory there with a pointer value</p>



<a name="277956430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277956430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277956430">(Apr 05 2022 at 23:10)</a>:</h4>
<p>I mean, UB in Rust should never happen, but in C... Well, <em>in theory</em> it shouldn't.</p>



<a name="277959408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277959408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277959408">(Apr 05 2022 at 23:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277956200">said</a>:</p>
<blockquote>
<p>I think the compiler can't rule out the possibility that this is defined behavior, e.g. if <code>cast</code> followed the pointer and replaced the memory there with a pointer value</p>
</blockquote>
<p>basically, if you can implement <code>cast</code> in Rust in a way that this code becomes allowed then that's fine</p>



<a name="277959419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277959419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277959419">(Apr 05 2022 at 23:51)</a>:</h4>
<p>not sure if that is possible here</p>



<a name="277959465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277959465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277959465">(Apr 05 2022 at 23:52)</a>:</h4>
<p>with cross-lang LTO it's definitely not fine as then LLVM sees what you are (not) doing</p>



<a name="277965454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277965454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277965454">(Apr 06 2022 at 01:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277954932">said</a>:</p>
<blockquote>
<p>oh <code>cast</code> is just doing a pointer cast? you can write that in Rust. no sure why you'd expect this to be legal just because you did it in C?</p>
</blockquote>
<p>Yes, but what justifies the fact that this is UB? The cast is defined with no-strict-aliasing, or if you just write raw assembly. You'd also need some sort of TBAA to forbid this, where it is UB for a pointer to pointer to alias with a pointer to not-pointer.</p>



<a name="277968593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277968593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277968593">(Apr 06 2022 at 02:33)</a>:</h4>
<p>no TBAA needed. it's UB for the same reason that this is UB, which Miri can detect with <code>-Zmiri-check-number-validity</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">cast</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a_ptr_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">a_ptr_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277968666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277968666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277968666">(Apr 06 2022 at 02:35)</a>:</h4>
<blockquote>
<p>where it is UB for a pointer to pointer to alias with a pointer to not-pointer.</p>
</blockquote>
<p>no alias reasoning is involved here. rather, at the <code>a=a</code>, when the load from <code>a</code> is evaluated, we require that the data stored at <code>a</code> is indeed valid for the given type (<code>u64</code>). in this execution the data has provenance, making it not valid.<br>
this is entirely the same as what happens when you store <code>0xff</code> into a <code>bool</code>.</p>



<a name="277970090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970090">(Apr 06 2022 at 03:01)</a>:</h4>
<p>that argument is extraordinarily unsatisfying when provenance does not actually exist in actual bytes on platforms other than CHERI (and miri if you call that a platform rather than a checker). The uninit analogy is better but still not great</p>



<a name="277970142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970142">(Apr 06 2022 at 03:02)</a>:</h4>
<p>(and CHERI actually supports it for -&gt; uintptr_t)</p>



<a name="277970238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970238">(Apr 06 2022 at 03:04)</a>:</h4>
<p>and said nonexistence means that as a matter of spec/principle it's totally reasonable to say it just counts as an escape; the problem there is only in practice what it means for optimizations</p>



<a name="277970254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970254">(Apr 06 2022 at 03:05)</a>:</h4>
<p>(and <em>that</em> is like 90% a TBAA-like issue)</p>



<a name="277970379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970379">(Apr 06 2022 at 03:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277970090">said</a>:</p>
<blockquote>
<p>that argument is extraordinarily unsatisfying when provenance does not actually exist in actual bytes on platforms other than CHERI (and miri if you call that a platform rather than a checker). The uninit analogy is better but still not great</p>
</blockquote>
<p>Provenance does exist in actual bytes in the Abstract Machine, though.</p>



<a name="277970453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970453">(Apr 06 2022 at 03:08)</a>:</h4>
<p>that doesn't matter when it very definitely doesn't on the physical machine, when the analogy is bool rather than uninit</p>



<a name="277970455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970455">(Apr 06 2022 at 03:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277970238">said</a>:</p>
<blockquote>
<p>and said nonexistence means that as a matter of spec/principle it's totally reasonable to say it just counts as an escape; the problem there is only in practice what it means for optimizations</p>
</blockquote>
<p>Yeah, and in practice it means that many operations that are pure by definition are now side-effectful.</p>



<a name="277970501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970501">(Apr 06 2022 at 03:09)</a>:</h4>
<p><code>p.read()</code> is pure, and Reading a pointer as an integer escapes the pointer are two fundamentally incompatible provisions.</p>



<a name="277970549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970549">(Apr 06 2022 at 03:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277970453">said</a>:</p>
<blockquote>
<p>that doesn't matter when it very definitely doesn't on the physical machine, when the analogy is bool rather than uninit</p>
</blockquote>
<p>The physical machine is an implementation detail.</p>



<a name="277970556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970556">(Apr 06 2022 at 03:10)</a>:</h4>
<p>Specifications don't talk about "The effects on the physical machine".</p>



<a name="277970569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/277970569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#277970569">(Apr 06 2022 at 03:11)</a>:</h4>
<p>I can store my bools in the physical machine as potatoes and carrots for all rust cares.</p>



<a name="278031318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278031318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278031318">(Apr 06 2022 at 14:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277970453">said</a>:</p>
<blockquote>
<p>that doesn't matter when it very definitely doesn't on the physical machine, when the analogy is bool rather than uninit</p>
</blockquote>
<p>it matters a lot unless you are okay with only doing optimizations that are correct on the physical machine</p>



<a name="278031394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278031394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278031394">(Apr 06 2022 at 14:27)</a>:</h4>
<p>like, either you say "physical machine first" and accept what what means for optimizations, or you say "yeah there is an abstract machine" because you want extra optimizations but then you have to accept the AM as a 'real' thing</p>



<a name="278031430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278031430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278031430">(Apr 06 2022 at 14:27)</a>:</h4>
<p>I dont think it is a reasonable position to ask for the benefits of both and not pay the costs of either</p>



<a name="278031609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278031609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278031609">(Apr 06 2022 at 14:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277970254">said</a>:</p>
<blockquote>
<p>(and <em>that</em> is like 90% a TBAA-like issue)</p>
</blockquote>
<p>you must be using "TBAA-like" in a very broad sense. I maintain that Rust does not have TBAA and hence this is not a TBAA-like issue at all.</p>



<a name="278031734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278031734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278031734">(Apr 06 2022 at 14:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/277970238">said</a>:</p>
<blockquote>
<p>and said nonexistence means that as a matter of spec/principle it's totally reasonable to say it just counts as an escape; the problem there is only in practice what it means for optimizations</p>
</blockquote>
<p>oh yes it is totally reasonable. if you ware okay with also paying the price this carries for optimizations. but that is <em>not</em> how Rust and C are currently being optimized.<br>
it is <em>not</em> reasonable to say everything counts as an escape but also we totally ignore that when optimizing the program.</p>



<a name="278087792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278087792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278087792">(Apr 06 2022 at 21:21)</a>:</h4>
<p>I've been looking through our internal code and we have several ptr2int transmutes. We also have at least one case in which we use the low bit of an <code>&amp;'static</code> as a flag.</p>



<a name="278087855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278087855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278087855">(Apr 06 2022 at 21:22)</a>:</h4>
<p>That one is probably fixable to use a raw pointer instead</p>



<a name="278088131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278088131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278088131">(Apr 06 2022 at 21:23)</a>:</h4>
<p>(I guess that one is already UB?)</p>



<a name="278088514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278088514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278088514">(Apr 06 2022 at 21:26)</a>:</h4>
<p>There's actually a <em>lot</em> of code that does ptr2int transmutes in order to use the bottom few bits as flags.</p>



<a name="278088606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278088606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278088606">(Apr 06 2022 at 21:27)</a>:</h4>
<p>It's worth thinking about how we're going to support using pointer bits as flags, since this is a thing people do.</p>



<a name="278089251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278089251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278089251">(Apr 06 2022 at 21:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/278088131">said</a>:</p>
<blockquote>
<p>(I guess that one is already UB?)</p>
</blockquote>
<p>if this is <code>&amp;'static u32</code> (for example), then yes because setting the flag violates alignment</p>



<a name="278089289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278089289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278089289">(Apr 06 2022 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/278088606">said</a>:</p>
<blockquote>
<p>It's worth thinking about how we're going to support using pointer bits as flags, since this is a thing people do.</p>
</blockquote>
<p>well, we do support that, Gankra even wrote demo code using the strict provenance APIs.<br>
the hard question is what to do about code that is already written not using those APIs.^^</p>



<a name="278089567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278089567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278089567">(Apr 06 2022 at 21:36)</a>:</h4>
<p>Yeah</p>



<a name="278089595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278089595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278089595">(Apr 06 2022 at 21:36)</a>:</h4>
<p><span class="user-mention" data-user-id="384014">@Patrick Walton</span> With respect to shoving stuff into pointers, you could draw some inspiration from ecosystem crates: <a href="https://crates.io/crates/stuff">https://crates.io/crates/stuff</a> which was written by <span class="user-mention" data-user-id="444933">@nilstrieb</span> (I think that's you?) directly inspired by how <code>semver</code> packs short strings into pointers, and also <a href="https://crates.io/crates/tagged-pointer">https://crates.io/crates/tagged-pointer</a> (whose implementation I am not particularly excited about, but it does pass <code>-Zmiri-strict-provenance</code>).</p>



<a name="278089698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278089698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278089698">(Apr 06 2022 at 21:37)</a>:</h4>
<p>To be clear, I do not think that any of this pointer munging is particularly graceful at the moment, but it can definitely be done, and this all should probably serve as inspiration for standard library APIs</p>



<a name="278089854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278089854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278089854">(Apr 06 2022 at 21:38)</a>:</h4>
<p>Oh also some of it optimizes strangely if you do the CHERI-friendly stuff, as was mentioned in <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate</a></p>



<a name="278093006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278093006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278093006">(Apr 06 2022 at 22:08)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> <br>
Yeah, I guess the practical consequence of that is that it'd be legal to write a MIR optimization pass that deletes the code that sets and tests those bits. e.g. optimizing <code>(p as usize &amp; 1) == 1</code> with <code>p: &amp;i32</code> to <code>false</code>, which AFAICT is a legal optimization today and might actually make code faster, but would break that pattern.</p>



<a name="278093418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278093418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278093418">(Apr 06 2022 at 22:13)</a>:</h4>
<p>It was pointed out to me that LLVM already does this <span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span></p>



<a name="278094094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278094094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278094094">(Apr 06 2022 at 22:20)</a>:</h4>
<p>well, we give LLVM the information that it could do it</p>



<a name="278094104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278094104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278094104">(Apr 06 2022 at 22:21)</a>:</h4>
<p>are there examples of it actually doing that in the wild?</p>



<a name="278094335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278094335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278094335">(Apr 06 2022 at 22:23)</a>:</h4>
<p>it only breaks the pattern when implemented incorrectly with references rather than raw pointers. I feel like the fact that references have to be aligned was always fairly uncontroversial? I suppose one could think this means "aligned only when dereferenced", but we have been talking about validity invariants for years now.<br>
though to be fair the reference only explicitly documents this since <a href="https://doc.rust-lang.org/1.39.0/reference/behavior-considered-undefined.html">https://doc.rust-lang.org/1.39.0/reference/behavior-considered-undefined.html</a> (released Nov 2019)</p>



<a name="278095277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278095277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278095277">(Apr 06 2022 at 22:34)</a>:</h4>
<p>FWIW, I haven't seen anyone in <a href="https://github.com/rust-lang/rfcs/pull/3204">https://github.com/rust-lang/rfcs/pull/3204</a> say "no you can't add a niche here because I use unaligned references".  It seems like everyone's pretty much internalized the "it's a validity invariant that references are aligned" idea.</p>



<a name="278095347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278095347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278095347">(Apr 06 2022 at 22:35)</a>:</h4>
<p>Is alignment implied by <code>dereferencable</code>? How long has rustc told LLVM that references are aligned?</p>



<a name="278095636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278095636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278095636">(Apr 06 2022 at 22:38)</a>:</h4>
<p>To be clear I'm fine with fixing our code here</p>



<a name="278095643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278095643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278095643">(Apr 06 2022 at 22:38)</a>:</h4>
<p>Not objecting to that one.</p>



<a name="278095758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278095758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278095758">(Apr 06 2022 at 22:40)</a>:</h4>
<p>Alignment is on loads, so <code>dereferencable</code> probably doesn't imply any particular alignment.</p>
<p>We've apparently been saying <code>dereferenceable(4)</code> all the way back to 1.0.0: <a href="https://rust.godbolt.org/z/4evhvKP6M">https://rust.godbolt.org/z/4evhvKP6M</a></p>
<p>And we've been explicitly marking the <code>load</code> as <code>align 4</code> (for an <code>i32</code>) since 1.1.0: <a href="https://rust.godbolt.org/z/djqbPY65c">https://rust.godbolt.org/z/djqbPY65c</a></p>



<a name="278096085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278096085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278096085">(Apr 06 2022 at 22:44)</a>:</h4>
<p><code>dereferenceable(4)</code> determines the size though, not the alignment</p>



<a name="278096229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278096229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278096229">(Apr 06 2022 at 22:46)</a>:</h4>
<p>we've been adding <code>align 4</code> as an argument attribute since 1.33.0: <a href="https://rust.godbolt.org/z/T1W3evWhr">https://rust.godbolt.org/z/T1W3evWhr</a></p>



<a name="278098292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278098292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278098292">(Apr 06 2022 at 23:08)</a>:</h4>
<p>Langref does say this though (I know we're deep in the weeds here)</p>
<blockquote>
<p>A pointer that is dereferenceable can be loaded from speculatively without a risk of trapping.</p>
</blockquote>



<a name="278104751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int%20transmutes/near/278104751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr2int.20transmutes.html#278104751">(Apr 07 2022 at 00:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr2int.20transmutes/near/278094104">said</a>:</p>
<blockquote>
<p>are there examples of it actually doing that in the wild?</p>
</blockquote>
<p><a href="https://godbolt.org/z/zvG1YfjvK">https://godbolt.org/z/zvG1YfjvK</a> is a small example that was pointed out to me</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>