<html>
<head><meta charset="utf-8"><title>strict provenance std compat notes · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html">strict provenance std compat notes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276132993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276132993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276132993">(Mar 22 2022 at 01:07)</a>:</h4>
<p>I'm going through std and fixing all the lint warnings for "no ptr&lt;-&gt;int casts", leaving my notes about this conversion here for future reference</p>



<a name="276133079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276133079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276133079">(Mar 22 2022 at 01:08)</a>:</h4>
<p>core::hash -- writes the address of DST pointers by casting it to a usize -- trivial .addr() fix</p>



<a name="276133143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276133143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276133143">(Mar 22 2022 at 01:10)</a>:</h4>
<p>slice::ascii -- converts to usize for some debug_assert "paranoia checks" (pointer is aligned, etc) -- trivial .addr() fix</p>



<a name="276133254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276133254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276133254">(Mar 22 2022 at 01:13)</a>:</h4>
<p>slice/iter/macros.rs -- uses difference of addresses to do size_hint stuff -- trivial .addr() fix</p>



<a name="276133358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276133358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276133358">(Mar 22 2022 at 01:16)</a>:</h4>
<p>core::fmt -- ?!? converting to usize to check if a callback is a specific function ?!?</p>
<p><a href="https://github.com/rust-lang/rust/blob/master/library/core/src/fmt/mod.rs#L355">https://github.com/rust-lang/rust/blob/master/library/core/src/fmt/mod.rs#L355</a></p>
<p>Does rust not let you directly compare function pointers??? I guess still trivial .addr() but wtf...</p>



<a name="276133888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276133888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276133888">(Mar 22 2022 at 01:27)</a>:</h4>
<p>hmmm should it use <a href="https://doc.rust-lang.org/std/primitive.pointer.html#method.guaranteed_eq">https://doc.rust-lang.org/std/primitive.pointer.html#method.guaranteed_eq</a></p>



<a name="276133947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276133947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276133947">(Mar 22 2022 at 01:28)</a>:</h4>
<p>no it's comparing two actual-for-real runtime function pointers</p>



<a name="276134003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134003">(Mar 22 2022 at 01:30)</a>:</h4>
<p>although if i'm being entirely honest you linked the most wild API i've ever seen so I have no idea why anyone would ever use it</p>



<a name="276134011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134011">(Mar 22 2022 at 01:30)</a>:</h4>
<p>lmao</p>



<a name="276134018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134018">(Mar 22 2022 at 01:30)</a>:</h4>
<p>I mean if it's all at runtime it would be exactly the same no?</p>



<a name="276134034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134034">(Mar 22 2022 at 01:31)</a>:</h4>
<p>the answer to that IIRC is "const weirdness".</p>



<a name="276134037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134037">(Mar 22 2022 at 01:31)</a>:</h4>
<p>i am saying i literally don't know wtf the function you linked for is or does</p>



<a name="276134045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134045">(Mar 22 2022 at 01:31)</a>:</h4>
<p>Oh.</p>



<a name="276134047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134047">(Mar 22 2022 at 01:31)</a>:</h4>
<p>" this function may spuriously return false for pointers that later actually turn out to be equal" ??????</p>



<a name="276134095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134095">(Mar 22 2022 at 01:32)</a>:</h4>
<p>It's "check if CTFE pointers are definitely equal".</p>



<a name="276134111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134111">(Mar 22 2022 at 01:32)</a>:</h4>
<p>is... fmt... const...?</p>



<a name="276134130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134130">(Mar 22 2022 at 01:32)</a>:</h4>
<p>Hmmm.</p>



<a name="276134134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134134">(Mar 22 2022 at 01:32)</a>:</h4>
<p>...probably will be soon, tbh.</p>



<a name="276134151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134151">(Mar 22 2022 at 01:33)</a>:</h4>
<p>I'm going to leave that to whoever does that</p>



<a name="276134158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134158">(Mar 22 2022 at 01:33)</a>:</h4>
<p>fair.</p>



<a name="276134618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276134618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276134618">(Mar 22 2022 at 01:43)</a>:</h4>
<p>(updated the fmt saga again)</p>



<a name="276135069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276135069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276135069">(Mar 22 2022 at 01:52)</a>:</h4>
<p>oh also I change ptr::to_bits to return <code>-&gt; [u8; core::mem::size_of::&lt;*mut ()&gt;]</code> and it is extremely funny and cool that this is legal rust syntax and works now</p>



<a name="276135076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276135076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276135076">(Mar 22 2022 at 01:53)</a>:</h4>
<p>:D</p>



<a name="276135179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276135179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276135179">(Mar 22 2022 at 01:55)</a>:</h4>
<p>"haha i will make you say what size a pointer is"<br>
...<br>
"it is the size of pointer"</p>



<a name="276135266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276135266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276135266">(Mar 22 2022 at 01:56)</a>:</h4>
<p><a href="http://intrinsics.rs">intrinsics.rs</a> -- documents <code>ptr as usize</code> as an alternative to transmute, checks alignment, compares address -- all .addr()'d</p>



<a name="276135367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276135367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276135367">(Mar 22 2022 at 01:59)</a>:</h4>
<p>non_null/unique -- ptr::dangling... this arguably needs special support</p>



<a name="276135497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276135497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276135497">(Mar 22 2022 at 02:00)</a>:</h4>
<p>thankfully we've pushed dangling for so long that there hopefully shouldn't be many people who do it manually</p>



<a name="276137417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137417">(Mar 22 2022 at 02:37)</a>:</h4>
<p>More ptr APIs I'm adding:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// Creates an invalid pointer with the given address.</span>
<span class="sd">///</span>
<span class="sd">/// This pointer will have no provenance associated with it and is therefore</span>
<span class="sd">/// UB to read/write/offset it. This mostly exists to facilitate things</span>
<span class="sd">/// like ptr::null and NonNull::dangling which make invalid pointers.</span>
<span class="cp">#[unstable(feature = </span><span class="s">"strict_provenance"</span><span class="cp">, issue = </span><span class="s">"99999999"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">invalid</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">addr</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// FIXME(strict_provenance_magic): I am magic and should be a compiler intrinsic.</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Creates a mutable invalid pointer with the given address.</span>
<span class="sd">///</span>
<span class="sd">/// This pointer will have no provenance associated with it and is therefore</span>
<span class="sd">/// UB to read/write/offset it. This mostly exists to facilitate things</span>
<span class="sd">/// like ptr::null and NonNull::dangling which make invalid pointers.</span>
<span class="cp">#[unstable(feature = </span><span class="s">"strict_provenance"</span><span class="cp">, issue = </span><span class="s">"99999999"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">invalid_mut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">addr</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// FIXME(strict_provenance_magic): I am magic and should be a compiler intrinsic.</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Forge a pointer to a Zero-Sized Type (ZST) from nothing.</span>
<span class="sd">///</span>
<span class="sd">/// Zero-sized types do not actually exist in memory, and therefore you cannot actually</span>
<span class="sd">/// "read" or "write" a ZST (any method that claims to do so is just playing pretend,</span>
<span class="sd">/// although you do still need to respect alignment for something like `&amp;[u32; 0]`).</span>
<span class="sd">/// As a result, you are free to claim a ZSTs exists anywhere you want (except null).</span>
<span class="sd">///</span>
<span class="sd">/// This API exists to make the soundness of this pattern explicit, even under</span>
<span class="sd">/// "strict provenance". It is equivalent to the deprecated `addr as *mut T` cast.</span>
<span class="sd">///</span>
<span class="sd">/// **BUT YOU AREN'T ACTUALLY ALLOWED TO BLINDLY FORGE ZST _INSTANCES_.**</span>
<span class="sd">///</span>
<span class="sd">/// It's sound for an API to use an instance of a ZST to enforce some important</span>
<span class="sd">/// safety property. So for instance, you can make an API like this:</span>
<span class="sd">///</span>
<span class="sd">/// ```ignore</span>
<span class="sd">/// pub struct Step1Token(_private_to_construct: ());</span>
<span class="sd">///</span>
<span class="sd">/// pub fn step1() -&gt; Step1Token { ... }</span>
<span class="sd">/// pub fn step2(proof: Step1Token) { ... }</span>
<span class="sd">/// ```</span>
<span class="sd">///</span>
<span class="sd">/// And it's sound in the body of `step2` to assume that `step1` has been run</span>
<span class="sd">/// beforehand, because the only way to get an instance of Step1Token is to call</span>
<span class="sd">/// `step1` (assuming `step1` is indeed the only API that creates one).</span>
<span class="sd">///</span>
<span class="sd">/// A well-behaved abstraction should conceptually only be "reading" ZSTs that it</span>
<span class="sd">/// has previously "written". You don't *actually* need to do the write, and could</span>
<span class="sd">/// feed it into [`mem::forget`][] instead, but for ZSTs `write` is a perfectly</span>
<span class="sd">/// good way to say `forget` and better expresses the semantics of your code.</span>
<span class="sd">///</span>
<span class="sd">/// Anything that stores *many* ZSTs should at the minimum maintain a counter of how</span>
<span class="sd">/// many it has written so that it can know how many it can/must read later.</span>
<span class="sd">/// `Vec&lt;()&gt;` is basically just a counter that goes up on `push` and down on `pop`.</span>
<span class="sd">///</span>
<span class="sd">/// Note: if you need to "allocate" memory for a buffer of ZSTs,</span>
<span class="sd">/// [`core::ptr::NonNull::dangling`][] is more useful, because it</span>
<span class="sd">/// handles alignment for you.</span>
<span class="sd">///</span>
<span class="sd">/// # Example</span>
<span class="sd">///</span>
<span class="sd">/// ```</span>
<span class="sd">/// use core::{ptr, mem};</span>
<span class="sd">///</span>
<span class="sd">/// // I store my ZSTs at the *coolest* address</span>
<span class="sd">/// let my_good_ptr = ptr::zst_exists::&lt;()&gt;(0xc001_add7);</span>
<span class="sd">///</span>
<span class="sd">/// // "store" and then "load" a ZST at this cool address.</span>
<span class="sd">/// my_good_ptr.write(());</span>
<span class="sd">/// let output = my_good_ptr.read();</span>
<span class="sd">/// ```</span>
<span class="cp">#[unstable(feature = </span><span class="s">"strict_provenance"</span><span class="cp">, issue = </span><span class="s">"99999999"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">zst_exists</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">addr</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nb">Sized</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"Only ZSTs can be pulled from the aether!"</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// We are the language so we get to know that `invalid` is fine here.</span>
<span class="w">    </span><span class="n">invalid_mut</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276137472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137472">(Mar 22 2022 at 02:38)</a>:</h4>
<p>(I'm not sure zst_exists needs to exist but I feel like it's worth just making it explicit that this is a thing)</p>



<a name="276137740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137740">(Mar 22 2022 at 02:44)</a>:</h4>
<p>properly auditing the rest of <code>ptr</code> and...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="cp">#[stable(feature = </span><span class="s">"fnptr_impls"</span><span class="cp">, since = </span><span class="s">"1.4.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">        </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">Ret</span><span class="p">,</span><span class="w"> </span><span class="cp">$($Arg</span><span class="p">),</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="cp">$FnTy</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// HACK: The intermediate cast as usize is required for AVR</span>
<span class="w">                </span><span class="c1">// so that the address space of the source function pointer</span>
<span class="w">                </span><span class="c1">// is preserved in the final function pointer.</span>
<span class="w">                </span><span class="c1">//</span>
<span class="w">                </span><span class="c1">// https://github.com/avr-rust/rust/issues/143</span>
<span class="w">                </span><span class="n">fmt</span>::<span class="n">Pointer</span>::<span class="n">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">()),</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276137743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137743">(Mar 22 2022 at 02:44)</a>:</h4>
<p>I'd note that the pointer returned from <code>NonNull::dangling</code> and a dangling/invalid pointer are not the same thing.</p>



<a name="276137758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137758">(Mar 22 2022 at 02:45)</a>:</h4>
<p>They are in fact the same thing though</p>



<a name="276137759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137759">(Mar 22 2022 at 02:45)</a>:</h4>
<p><code>NonNull::dangling</code> can be used for accesses of <code>0</code> size, whereas a dangling pointer, which points into a freed allocation, cannot.</p>



<a name="276137767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137767">(Mar 22 2022 at 02:45)</a>:</h4>
<p>incorrect</p>



<a name="276137825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137825">(Mar 22 2022 at 02:46)</a>:</h4>
<p>or rather, freed memory is irrelevant for ZSTs, they are always allocated everywhere</p>



<a name="276137832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137832">(Mar 22 2022 at 02:46)</a>:</h4>
<p>The name of <code>NonNull::dangling</code> is a misnomer, because it doesn't actually return a dangling pointer.<br>
See: <a href="https://doc.rust-lang.org/nightly/core/ptr/index.html#safety">https://doc.rust-lang.org/nightly/core/ptr/index.html#safety</a></p>
<blockquote>
<ul>
<li>Even for operations of size zero, the pointer must not be pointing to deallocated memory ...</li>
</ul>
</blockquote>



<a name="276137940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137940">(Mar 22 2022 at 02:49)</a>:</h4>
<p>WTF?</p>



<a name="276137941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137941">(Mar 22 2022 at 02:49)</a>:</h4>
<p>that doesn't make any sense</p>



<a name="276137949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137949">(Mar 22 2022 at 02:49)</a>:</h4>
<p>I mean, it makes my job of writing consistent pointer semantics for xir easier.</p>



<a name="276137962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276137962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276137962">(Mar 22 2022 at 02:49)</a>:</h4>
<p>And I think llvm also likes it somewhat as well.</p>



<a name="276138062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138062">(Mar 22 2022 at 02:51)</a>:</h4>
<p>operations of size 0 should never reach llvm</p>



<a name="276138126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138126">(Mar 22 2022 at 02:52)</a>:</h4>
<p>I think <code>offset</code> for a raw pointer slice.</p>



<a name="276138136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138136">(Mar 22 2022 at 02:52)</a>:</h4>
<p>I spent a very long time several years ago getting together everyone important and getting them to agree that even shit like dangling.offset(n) was valid too</p>



<a name="276138145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138145">(Mar 22 2022 at 02:53)</a>:</h4>
<p>I'm pretty sure llvm says, uh... no.</p>



<a name="276138157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138157">(Mar 22 2022 at 02:53)</a>:</h4>
<p>Since GEPi requires both the input and result pointer to be inbounds of each other.</p>



<a name="276138165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138165">(Mar 22 2022 at 02:53)</a>:</h4>
<p>llvm underspecifies it, i got the llvm maintainers to agree it's a reasonable interpretation that there are allocations of size 0 everywhere</p>



<a name="276138226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138226">(Mar 22 2022 at 02:54)</a>:</h4>
<p>In any case, that makes my job (and my semantics) so much more complicated, having to special case ZSTs everywhere down to the backend.</p>



<a name="276138248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138248">(Mar 22 2022 at 02:54)</a>:</h4>
<p>(And it's either that, or I just can't emit reads for types with dependant sizes)</p>



<a name="276138279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138279">(Mar 22 2022 at 02:55)</a>:</h4>
<p>I think that level of implementation complexity is fair for not having to deal with ZST UB and aliasing and provenance.</p>



<a name="276138342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138342">(Mar 22 2022 at 02:56)</a>:</h4>
<p>Right, but I have to specify those interactions as well.</p>



<a name="276138355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138355">(Mar 22 2022 at 02:57)</a>:</h4>
<p>you have to special case ZSTs anyway, they don't exist</p>



<a name="276138358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138358">(Mar 22 2022 at 02:57)</a>:</h4>
<p>And two thirds of my memory model suddenly has to care about whether a type has a zero size.</p>



<a name="276138361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138361">(Mar 22 2022 at 02:57)</a>:</h4>
<p>like you can't ask a cpu to load 0 bytes</p>



<a name="276138373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138373">(Mar 22 2022 at 02:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276138355">said</a>:</p>
<blockquote>
<p>you have to special case ZSTs anyway, they don't exist</p>
</blockquote>
<p>They go right to the codegen as-is, and the codegen throws them away there.</p>



<a name="276138398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138398">(Mar 22 2022 at 02:57)</a>:</h4>
<p>that should be fine?</p>



<a name="276138437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138437">(Mar 22 2022 at 02:58)</a>:</h4>
<p>I mean let's be honest here.</p>



<a name="276138439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138439">(Mar 22 2022 at 02:58)</a>:</h4>
<p>your project includes x86-64 codegen.</p>



<a name="276138464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138464">(Mar 22 2022 at 02:58)</a>:</h4>
<p>relatively speaking, the complexity of ZSTs is... <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="276138480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138480">(Mar 22 2022 at 02:59)</a>:</h4>
<p>I made sure "ZSTs are always allocated everywhere" was the agreed-upon memory model for rust, you don't get to say "I will make an optimization that miscompiles that" because it's inconvenient</p>



<a name="276138492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138492">(Mar 22 2022 at 02:59)</a>:</h4>
<p>The xir indirect instruction has</p>
<blockquote>
<p>Preconditions:</p>
<ul>
<li><code>p</code> shall be a non-null valid pointer that points to an object, or to a well-aligned offset within an object, at least <code>size_of T</code> bytes shall be reachable from <code>p</code></li>
</ul>
</blockquote>



<a name="276138556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138556">(Mar 22 2022 at 03:00)</a>:</h4>
<p>There's something with ZST pointers and deallocated memory though, which was (is?) a problem? But alas I cannot seem to find it right now.</p>



<a name="276138607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138607">(Mar 22 2022 at 03:00)</a>:</h4>
<p>I linked it above<br>
deallocated pointers are <em>not</em> valid for ZST accesses.</p>



<a name="276138617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138617">(Mar 22 2022 at 03:01)</a>:</h4>
<p>Right, but rather the actual reason why we have that rule.</p>



<a name="276138629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138629">(Mar 22 2022 at 03:01)</a>:</h4>
<p>Ralf conflated offsets of size 0 with ZSTs, those are different</p>



<a name="276138646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138646">(Mar 22 2022 at 03:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276138492">said</a>:</p>
<blockquote>
<p>The xir indirect instruction has</p>
<blockquote>
<p>Preconditions:</p>
<ul>
<li><code>p</code> shall be a non-null valid pointer that points to an object, or to a well-aligned offset within an object, at least <code>size_of T</code> bytes shall be reachable from <code>p</code><br>
</li>
</ul>
</blockquote>
</blockquote>
<p>And if I can't generate an <code>indirect</code> for ZSTs, then suddenly I can't dereference pointers in generic code.</p>



<a name="276138648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138648">(Mar 22 2022 at 03:01)</a>:</h4>
<p>zst_ptr.offset(x) is fine. nonzst_ptr.offset(0) is an assertion</p>



<a name="276138723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138723">(Mar 22 2022 at 03:03)</a>:</h4>
<p>Whatever codegen backend can already erase dereferences of size 0s anyways (it has to), so I really don't think this is such a problem.</p>



<a name="276138726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138726">(Mar 22 2022 at 03:03)</a>:</h4>
<p>xlang relies heavily on being able to reason about operations on pointers reguardless of what the pointee is, because xlang has to deal with pre-monomorphic generic parameters.</p>



<a name="276138807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138807">(Mar 22 2022 at 03:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276138723">said</a>:</p>
<blockquote>
<p>Whatever codegen backend can already erase dereferences of size 0s anyways (it has to), so I really don't think this is such a problem.</p>
</blockquote>
<p>the problem is that llvm is a pissant about gep(0)</p>



<a name="276138825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138825">(Mar 22 2022 at 03:05)</a>:</h4>
<p>Oh?</p>



<a name="276138890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138890">(Mar 22 2022 at 03:06)</a>:</h4>
<p>As it is, there is exactly one ZST special case</p>
<blockquote>
<p>When casting an integer to a pointer, the resulting pointer may manifest a zero-sized object at it's address. Such a pointer is considered valid and at least <code>0</code> bytes are reachable from that pointer.</p>
</blockquote>



<a name="276138907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138907">(Mar 22 2022 at 03:07)</a>:</h4>
<p>Ah, here it is. <a href="https://github.com/rust-lang/rust/pull/77844">https://github.com/rust-lang/rust/pull/77844</a></p>



<a name="276138912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138912">(Mar 22 2022 at 03:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276138825">said</a>:</p>
<blockquote>
<p>Oh?</p>
</blockquote>
<p>the operation doesn't make any sense and should reasonably regarded as a noop but they're like "naahhh, but what if it wasn't though"</p>



<a name="276138968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138968">(Mar 22 2022 at 03:08)</a>:</h4>
<p>I think the issue was if gep(0) was fine then gep(n) couldn't be optimized because n could be 0.</p>



<a name="276138977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276138977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276138977">(Mar 22 2022 at 03:08)</a>:</h4>
<p>To fix this, I basically would have to special case half of the xir instruction set, and oh, can't run any optimizations pre-monomorph time (also IIRC there are some people that want to do some pre-monomorph mir optimizations along the same lines)</p>



<a name="276139006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139006">(Mar 22 2022 at 03:09)</a>:</h4>
<p>Meanwhile, I'd rather be able to write a compiler, then have to spend the next several months writing the IR spec instead.</p>



<a name="276139056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139056">(Mar 22 2022 at 03:10)</a>:</h4>
<p>hmm ok so I can make this coherent with the knowledge that we are making provenance make sense</p>



<a name="276139062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139062">(Mar 22 2022 at 03:10)</a>:</h4>
<p>and defining gep(0) where 0 is some sort of constexpr thing gets complicated with constant-folding and all that jazz... Also (not to get too sidetracked) in XIR is there not an object of size 0 at every address?</p>



<a name="276139072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139072">(Mar 22 2022 at 03:11)</a>:</h4>
<p>when you free memory, pointers with that memory's provenance are invalid and even ZSTs are bad</p>



<a name="276139075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139075">(Mar 22 2022 at 03:11)</a>:</h4>
<p>There isn't implicitly, but you can manifest one. But not out of an invalid pointer.</p>



<a name="276139089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139089">(Mar 22 2022 at 03:11)</a>:</h4>
<p>Yeah I was imagining you were going to say something like that.</p>



<a name="276139093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139093">(Mar 22 2022 at 03:11)</a>:</h4>
<p>basically it needs to be ok to make a ZST from the aether that happens to be inside an allocation that gets freed and for that to not fuck with it</p>



<a name="276139095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139095">(Mar 22 2022 at 03:11)</a>:</h4>
<p>Yeah.</p>



<a name="276139138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139138">(Mar 22 2022 at 03:12)</a>:</h4>
<p>(Specifically, zero-sized objects can be manifested whenever you use <code>convert reinterpret</code> to perform an integer to pointer conversion)</p>



<a name="276139149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139149">(Mar 22 2022 at 03:12)</a>:</h4>
<p>ok this is a tolerable model, i will accept it</p>



<a name="276139161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139161">(Mar 22 2022 at 03:13)</a>:</h4>
<p>but I'm going to rewrite these docs to talk about provenance</p>



<a name="276139168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139168">(Mar 22 2022 at 03:13)</a>:</h4>
<p>Basically, I want to be able to say what happens when you <code>free</code> a pointer in less than an entire thesis.</p>



<a name="276139307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139307">(Mar 22 2022 at 03:15)</a>:</h4>
<p>With strict provenance we can appeal to provenance in a not-handwavey way so it's fine to have this kind of thing</p>



<a name="276139358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139358">(Mar 22 2022 at 03:16)</a>:</h4>
<p>the proposed C provenance rules where you "look at all the allocations in the world" make this nuts</p>



<a name="276139607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139607">(Mar 22 2022 at 03:22)</a>:</h4>
<p>Conceptually, it would be <code>claim_alloc(int, size) -&gt; ptr</code>, <code>create_provenance(ptr) -&gt; ptr</code>, <code>destroy_provenance(ptr)</code>, and <code>invalid_provenance(int) -&gt; ptr</code> and that seems like it could take care of everything. Userspace allocators are a lot easier in this model hmm. Except the container_ofs are still a pain.</p>



<a name="276139757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139757">(Mar 22 2022 at 03:26)</a>:</h4>
<p>Yeah, this is why I am so against PNVI-ae.</p>



<a name="276139840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139840">(Mar 22 2022 at 03:28)</a>:</h4>
<p>We don't have like <strong>50 years</strong> of legacy code to worry about we have like 5~10.</p>



<a name="276139951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276139951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276139951">(Mar 22 2022 at 03:30)</a>:</h4>
<p>And we have interfaces that allow us to sidestep most of the atrocities that justify PNVI-ae*</p>



<a name="276141280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141280">(Mar 22 2022 at 03:56)</a>:</h4>
<p>Indeed (though I ran into a situation that leaves using interfaces kinda sketchy - I'm inside of a dynamic loader's plt resolver function and I didn't want to use pure assembly because that would just be painful - <code>0 as *mut Elf64Sym</code> is fine, <code>core::ptr::null::&lt;Elf64Sym&gt;()</code> might make my resolver recursive if the compiler in use at the time hates me)</p>



<a name="276141405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141405">(Mar 22 2022 at 03:59)</a>:</h4>
<p>My proposed rewrite of these docs:</p>



<a name="276141409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141409">(Mar 22 2022 at 03:59)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">//! # Safety</span>
<span class="sd">//!</span>
<span class="sd">//! Many functions in this module take raw pointers as arguments and read from</span>
<span class="sd">//! or write to them. For this to be safe, these pointers must be *valid*.</span>
<span class="sd">//! Whether a pointer is valid depends on the operation it is used for</span>
<span class="sd">//! (read or write), and the extent of the memory that is accessed (i.e.,</span>
<span class="sd">//! how many bytes are read/written). Most functions use `*mut T` and `*const T`</span>
<span class="sd">//! to access only a single value, in which case the documentation omits the size</span>
<span class="sd">//! and implicitly assumes it to be `size_of::&lt;T&gt;()` bytes.</span>
<span class="sd">//!</span>
<span class="sd">//! The precise rules for validity are not determined yet. The guarantees that are</span>
<span class="sd">//! provided at this point are very minimal:</span>
<span class="sd">//!</span>
<span class="sd">//! * A [null] pointer is *never* valid, not even for accesses of [size zero][zst].</span>
<span class="sd">//! * For a pointer to be valid, it is necessary, but not always sufficient, that the pointer</span>
<span class="sd">//!   be *dereferenceable*: the memory range of the given size starting at the pointer must all be</span>
<span class="sd">//!   within the bounds of a single allocated object. Note that in Rust,</span>
<span class="sd">//!   every (stack-allocated) variable is considered a separate allocated object.</span>
<span class="sd">//! * Deallocating memory invalidates all pointers with provenance to that allocation, *even*</span>
<span class="sd">//!   for accesses of [size zero][zst].</span>
<span class="sd">//! * All accesses performed by functions in this module are *non-atomic* in the sense</span>
<span class="sd">//!   of [atomic operations] used to synchronize between threads. This means it is</span>
<span class="sd">//!   undefined behavior to perform two concurrent accesses to the same location from different</span>
<span class="sd">//!   threads unless both accesses only read from memory. Notice that this explicitly</span>
<span class="sd">//!   includes [`read_volatile`] and [`write_volatile`]: Volatile accesses cannot</span>
<span class="sd">//!   be used for inter-thread synchronization.</span>
<span class="sd">//! * The result of casting a reference to a pointer is valid for as long as the</span>
<span class="sd">//!   underlying object is live and no reference (just raw pointers) is used to</span>
<span class="sd">//!   access the same memory.</span>
<span class="sd">//!</span>
<span class="sd">//! These axioms, along with careful use of [`offset`] for pointer arithmetic,</span>
<span class="sd">//! are enough to correctly implement many useful things in unsafe code. Stronger guarantees</span>
<span class="sd">//! will be provided eventually, as the [aliasing] rules are being determined. For more</span>
<span class="sd">//! information, see the [book] as well as the section in the reference devoted</span>
<span class="sd">//! to [undefined behavior][ub].</span>
<span class="sd">//!</span>
<span class="sd">//! ## Alignment</span>
<span class="sd">//!</span>
<span class="sd">//! Valid raw pointers as defined above are not necessarily properly aligned (where</span>
<span class="sd">//! "proper" alignment is defined by the pointee type, i.e., `*const T` must be</span>
<span class="sd">//! aligned to `mem::align_of::&lt;T&gt;()`). However, most functions require their</span>
<span class="sd">//! arguments to be properly aligned, and will explicitly state</span>
<span class="sd">//! this requirement in their documentation. Notable exceptions to this are</span>
<span class="sd">//! [`read_unaligned`] and [`write_unaligned`].</span>
<span class="sd">//!</span>
<span class="sd">//! When a function requires proper alignment, it does so even if the access</span>
<span class="sd">//! has size 0, i.e., even if memory is not actually touched. Consider using</span>
<span class="sd">//! [`NonNull::dangling`] in such cases.</span>
<span class="sd">//!</span>
<span class="sd">//! ## Allocated Object and Provenance</span>
<span class="sd">//!</span>
<span class="sd">//! For several operations, such as [`offset`] or field projections (`expr.field`), the notion of an</span>
<span class="sd">//! "allocated object" becomes relevant. An allocated object is a contiguous region of memory.</span>
<span class="sd">//! Common examples of allocated objects include stack-allocated variables (each variable is a</span>
<span class="sd">//! separate allocated object), heap allocations (each allocation created by the global allocator is</span>
<span class="sd">//! a separate allocated object), and `static` variables.</span>
<span class="sd">//!</span>
<span class="sd">//! When an object is allocated there should be only one way to access to it (the variable's name,</span>
<span class="sd">//! the pointer returned by malloc). This One True Handle is given a unique *provenance* which</span>
<span class="sd">//! gives it permission to access that object. This provenance, and therefore permission to access</span>
<span class="sd">//! the allocation, is implicitly shared with all pointers that are either directly or transitively</span>
<span class="sd">//! *derived* from the One True Handle through operations like `offset` or borrowing.</span>
<span class="sd">//!</span>
<span class="sd">//! (Unclear detail: taking a subslice is proposed to create a slice that is no longer allowed</span>
<span class="sd">//! to access the full range of memory -- is this part of provenance or another system?)</span>
<span class="sd">//!</span>
<span class="sd">//! You may always "forge" an allocated object of size 0 at any properly aligned non-[null]</span>
<span class="sd">//! address with [`zst_exists`] or [`NonNull::dangling`], even at addresses which "accidentally"</span>
<span class="sd">//! overlap other allocations. This is allowed because the forged pointer has its own</span>
<span class="sd">//! provenance, which means the compiler can distinguish between the forged pointer</span>
<span class="sd">//! and those that *genuinely* point into the allocation (and the forged pointer can't</span>
<span class="sd">//! be used to load or store any memory, so it really can't do anything observable</span>
<span class="sd">//! that alias analysis might be concerned with).</span>
<span class="sd">//!</span>
<span class="sd">//! Critically, this means that freeing the *actually* allocated object does not</span>
<span class="sd">//! invalidate the "accidentally" overlapping forged allocation. This is in some sense</span>
<span class="sd">//! equivalent to the fact you don't get to be "lucky" and use a freed pointer whenever</span>
<span class="sd">//! the memory it points at happens to get reallocated -- the new allocation has a fresh</span>
<span class="sd">//! provenance, and so has no relationship to the freed pointer, even if the addresses</span>
<span class="sd">//! may be the same.</span>
</code></pre></div>



<a name="276141462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141462">(Mar 22 2022 at 04:00)</a>:</h4>
<p>Notable changes:</p>



<a name="276141514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141514">(Mar 22 2022 at 04:00)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">//! * Deallocating memory invalidates all pointers with provenance to that allocation, *even*</span>
<span class="sd">//!   for accesses of [size zero][zst].</span>
</code></pre></div>



<a name="276141516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141516">(Mar 22 2022 at 04:00)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">//! When an object is allocated there should be only one way to access to it (the variable's name,</span>
<span class="sd">//! the pointer returned by malloc). This One True Handle is given a unique *provenance* which</span>
<span class="sd">//! gives it permission to access that object. This provenance, and therefore permission to access</span>
<span class="sd">//! the allocation, is implicitly shared with all pointers that are either directly or transitively</span>
<span class="sd">//! *derived* from the One True Handle through operations like `offset` or borrowing.</span>
<span class="sd">//!</span>
<span class="sd">//! (Unclear detail: taking a subslice is proposed to create a slice that is no longer allowed</span>
<span class="sd">//! to access the full range of memory -- is this part of provenance or another system?)</span>
<span class="sd">//!</span>
<span class="sd">//! You may always "forge" an allocated object of size 0 at any properly aligned non-[null]</span>
<span class="sd">//! address with [`zst_exists`] or [`NonNull::dangling`], even at addresses which "accidentally"</span>
<span class="sd">//! overlap other allocations. This is allowed because the forged pointer has its own</span>
<span class="sd">//! provenance, which means the compiler can distinguish between the forged pointer</span>
<span class="sd">//! and those that *genuinely* point into the allocation (and the forged pointer can't</span>
<span class="sd">//! be used to load or store any memory, so it really can't do anything observable</span>
<span class="sd">//! that alias analysis might be concerned with).</span>
<span class="sd">//!</span>
<span class="sd">//! Critically, this means that freeing the *actually* allocated object does not</span>
<span class="sd">//! invalidate the "accidentally" overlapping forged allocation. This is in some sense</span>
<span class="sd">//! equivalent to the fact you don't get to be "lucky" and use a freed pointer whenever</span>
<span class="sd">//! the memory it points at happens to get reallocated -- the new allocation has a fresh</span>
<span class="sd">//! provenance, and so has no relationship to the freed pointer, even if the addresses</span>
<span class="sd">//! may be the same.</span>
</code></pre></div>



<a name="276141533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276141533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276141533">(Mar 22 2022 at 04:01)</a>:</h4>
<p>Again this is almost certainly insufficiently formal but it reflects the mental model of the APIs I am sketching out here</p>



<a name="276142195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142195">(Mar 22 2022 at 04:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276133143">said</a>:</p>
<blockquote>
<p>slice::ascii -- converts to usize for some debug_assert "paranoia checks" (pointer is aligned, etc) -- trivial .addr() fix</p>
</blockquote>
<p>There are some pretty widespread debug assertions about alignment elsewhere in <code>core</code>. Authors of unsafe code have an unfortunate habit of doing misaligned pointer operations, and these debug assertions are great at catching those (with the asterisk that you currently need to use <code>-Zbuild-std</code>). With all this pointer reworking, I wouldn't mind having a built-in way to check if a pointer is aligned, or to get the alignment bits.</p>
<p>BTW I've seen code like this done in other places, might be interesting to you <a href="https://github.com/rayon-rs/rayon/blob/f57bfa5126bc07ab752e9cbda0194f3b35876ce9/src/slice/mergesort.rs#L220-L223">https://github.com/rayon-rs/rayon/blob/f57bfa5126bc07ab752e9cbda0194f3b35876ce9/src/slice/mergesort.rs#L220-L223</a></p>



<a name="276142214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142214">(Mar 22 2022 at 04:17)</a>:</h4>
<p>That might be reasonable but is a bit out of scope</p>



<a name="276142261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142261">(Mar 22 2022 at 04:18)</a>:</h4>
<p>This example is completely nuts:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="sd">/// Returns a raw pointer to the slice's buffer.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This is equivalent to casting `self` to `*const T`, but more type-safe.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// # Examples</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// ```rust</span>
<span class="w">    </span><span class="sd">/// #![feature(slice_ptr_get)]</span>
<span class="w">    </span><span class="sd">/// use std::ptr;</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// let slice: *const [i8] = ptr::slice_from_raw_parts(ptr::null(), 3);</span>
<span class="w">    </span><span class="sd">/// assert_eq!(slice.as_ptr(), 0 as *const i8);</span>
<span class="w">    </span><span class="sd">/// ```</span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[unstable(feature = </span><span class="s">"slice_ptr_get"</span><span class="cp">, issue = </span><span class="s">"74265"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[rustc_const_unstable(feature = </span><span class="s">"slice_ptr_get"</span><span class="cp">, issue = </span><span class="s">"74265"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">as_ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276142266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142266">(Mar 22 2022 at 04:18)</a>:</h4>
<p>This feels like.... almost certainly UB??</p>



<a name="276142273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142273">(Mar 22 2022 at 04:19)</a>:</h4>
<p>oh it's <code>*const [T]</code> the poor unloved raw pointer type</p>



<a name="276142353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142353">(Mar 22 2022 at 04:20)</a>:</h4>
<p>*fondly remembers the time she spent trying to convince people <code>*mut [T]</code> could be useful for some things</p>



<a name="276142632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142632">(Mar 22 2022 at 04:28)</a>:</h4>
<p>yeah what the hell</p>



<a name="276142656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142656">(Mar 22 2022 at 04:28)</a>:</h4>
<p>that involves creating a slice with a nonzero len of real data pointing at null</p>



<a name="276142675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142675">(Mar 22 2022 at 04:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276142195">said</a>:</p>
<blockquote>
<p>There are some pretty widespread debug assertions about alignment elsewhere in <code>core</code>. Authors of unsafe code have an unfortunate habit of doing misaligned pointer operations, and these debug assertions are great at catching those (with the asterisk that you currently need to use <code>-Zbuild-std</code>). With all this pointer reworking, I wouldn't mind having a built-in way to check if a pointer is aligned, or to get the alignment bits.</p>
<p>BTW I've seen code like this done in other places, might be interesting to you <a href="https://github.com/rayon-rs/rayon/blob/f57bfa5126bc07ab752e9cbda0194f3b35876ce9/src/slice/mergesort.rs#L220-L223">https://github.com/rayon-rs/rayon/blob/f57bfa5126bc07ab752e9cbda0194f3b35876ce9/src/slice/mergesort.rs#L220-L223</a></p>
</blockquote>
<p><code>is_aligned</code> seems like a pretty simple function to PR.</p>



<a name="276142772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142772">(Mar 22 2022 at 04:31)</a>:</h4>
<p>Wait but *mut [T] is so useful</p>



<a name="276142837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142837">(Mar 22 2022 at 04:33)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/94231#issuecomment-1047248968">https://github.com/rust-lang/rust/issues/94231#issuecomment-1047248968</a> is the kind of thing that happens because it isn't used</p>



<a name="276142910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142910">(Mar 22 2022 at 04:35)</a>:</h4>
<p>i agree it's conceptually useful but the API/syntax support isn't there, iirc</p>



<a name="276142917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142917">(Mar 22 2022 at 04:35)</a>:</h4>
<p>well heck it's been like 5 years maybe it is now but it wasn't</p>



<a name="276142966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276142966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276142966">(Mar 22 2022 at 04:36)</a>:</h4>
<p>and i still see many of my horrible pet projects in here like Unique so just kinda assuming the core design is the same lol</p>



<a name="276143004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276143004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276143004">(Mar 22 2022 at 04:38)</a>:</h4>
<p>NonNull/Unique -- just needed to use ptr::invalid(mem::align_of::&lt;T&gt;()) for their core functionality, also a lot of doc examples blindly asserting against <code>1 as *mut u8</code> which is awful and I have replace with tautological comparisons against dangling</p>



<a name="276143227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276143227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276143227">(Mar 22 2022 at 04:43)</a>:</h4>
<p>holy shit, shoutouts to core::mem for never doing an int-ptr conversion or even discussing it in the docs</p>



<a name="276143230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276143230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276143230">(Mar 22 2022 at 04:43)</a>:</h4>
<p>you did it core::mem, you're the best module with all the Good Evil</p>



<a name="276144377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276144377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276144377">(Mar 22 2022 at 05:09)</a>:</h4>
<blockquote>
<p>slice::ascii -- converts to usize for some debug_assert "paranoia checks" (pointer is aligned, etc) -- trivial .addr() fix</p>
</blockquote>
<p>lol i wrote that, i do a lot of those style of paranoia checks in my code... i've certainly added other ptr-&gt;int to the stdlib also (for example, just off the top of my head i know that io/error/repr_bitpacked.rs also has some ptr-&gt;int i wrote, but i was (trying to be) pretty careful around provenance so <em>hopefully</em> it should be fine)</p>



<a name="276144620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276144620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276144620">(Mar 22 2022 at 05:14)</a>:</h4>
<p>I'm assuming under your model reading the bytes of a pointer via transmute or pointer cast, and transmuting stuff to pointers is also wrong?</p>



<a name="276145517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276145517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276145517">(Mar 22 2022 at 05:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276144620">said</a>:</p>
<blockquote>
<p>I'm assuming under your model reading the bytes of a pointer via transmute or pointer cast, and transmuting stuff to pointers is also wrong?</p>
</blockquote>
<p>i have no fundamental objection to getting the bytes of a pointer, under CHERI this isn't actually dangerous because you can't use "stolen" metadata for anything</p>



<a name="276145563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276145563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276145563">(Mar 22 2022 at 05:36)</a>:</h4>
<p>although it may Make You Sad if you observe implementation details that are Weird</p>



<a name="276145571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276145571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276145571">(Mar 22 2022 at 05:36)</a>:</h4>
<p>but yes you can't transmute anything to a pointer</p>



<a name="276145578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276145578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276145578">(Mar 22 2022 at 05:36)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95199">https://github.com/rust-lang/rust/pull/95199</a></p>



<a name="276145580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276145580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276145580">(Mar 22 2022 at 05:36)</a>:</h4>
<p>^ WIP</p>



<a name="276145583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276145583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276145583">(Mar 22 2022 at 05:36)</a>:</h4>
<p>I need to SLEEP</p>



<a name="276146112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276146112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276146112">(Mar 22 2022 at 05:49)</a>:</h4>
<p>goodnight!</p>



<a name="276147122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276147122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276147122">(Mar 22 2022 at 06:08)</a>:</h4>
<p>Goodnight!</p>



<a name="276147240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276147240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276147240">(Mar 22 2022 at 06:11)</a>:</h4>
<p>Damn, I need to sleep too but just got a random idea that I spent like 3 seconds thinking about. Iff the allocator can "restore" provenances by doing some <code>wrapping_offset</code>s, what if you had a something like <code>trait Ptr2IntSupportingAllocator: Allocator</code> as a fallback for weird stuff. This does tie into how this model handles [userspace] allocators tho.</p>



<a name="276151882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276151882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276151882">(Mar 22 2022 at 07:39)</a>:</h4>
<p>Allocators are a particularly tough case, since they need to bend or break the rules for provenance, since they're returning "unaliased" allocations which (in practice if not in theory) are actually aliased by their internal representation of the data in question.</p>



<a name="276180289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180289">(Mar 22 2022 at 12:26)</a>:</h4>
<p>ok back on the horse</p>



<a name="276180347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180347">(Mar 22 2022 at 12:26)</a>:</h4>
<p>alloc::rc -- uses usize::MAX as its dangling sentinel -- another fine application of ptr::invalid</p>



<a name="276180410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180410">(Mar 22 2022 at 12:27)</a>:</h4>
<p><code>ptr::invalid</code> might not compare unequal to a valid pointer.</p>



<a name="276180505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180505">(Mar 22 2022 at 12:28)</a>:</h4>
<p>it definitely will for usize::MAX for a pointee larger than 1 byte, which is what it's doing</p>



<a name="276180689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180689">(Mar 22 2022 at 12:30)</a>:</h4>
<p>That wouldn't be valid for <code>NonNull::dangling</code> if the type has &gt;1 alignment, though.</p>



<a name="276180810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180810">(Mar 22 2022 at 12:31)</a>:</h4>
<p>NonNull does not require alignment (same rules as *mut), and <code>dangling</code> is an argument-less ctor. This is just "morally equivalent to dangling, but not"</p>



<a name="276180934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276180934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276180934">(Mar 22 2022 at 12:32)</a>:</h4>
<p>alloc::slice -- taking the difference between addresses to compute array length -- trivial .addr()</p>



<a name="276181340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276181340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276181340">(Mar 22 2022 at 12:36)</a>:</h4>
<p>arc -- same as rc</p>



<a name="276181391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276181391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276181391">(Mar 22 2022 at 12:36)</a>:</h4>
<p>vec -- address difference for array length thing</p>



<a name="276182205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276182205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276182205">(Mar 22 2022 at 12:43)</a>:</h4>
<p>dwarf::eh -- our first pointer fuckery!</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">reader</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round_up</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">())</span><span class="o">?</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>changed to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">reader</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">with_addr</span><span class="p">(</span><span class="n">round_up</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">addr</span><span class="p">(),</span><span class="w"> </span><span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">())</span><span class="o">?</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="276182480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276182480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276182480">(Mar 22 2022 at 12:45)</a>:</h4>
<p>oh my bad, this is all fuckery:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_absptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_uleb128</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read_uleb128</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_udata2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_udata4</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_udata8</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_sleb128</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read_sleb128</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_sdata2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">i16</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_sdata4</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_sdata8</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span>::<span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(()),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x70</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_absptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// relative to address of the encoded value, despite the name</span>
<span class="w">        </span><span class="n">DW_EH_PE_pcrel</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">ptr</span><span class="p">.</span><span class="n">addr</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_funcrel</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">func_start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">func_start</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_textrel</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">.</span><span class="n">get_text_start</span><span class="p">)(),</span><span class="w"></span>
<span class="w">        </span><span class="n">DW_EH_PE_datarel</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">.</span><span class="n">get_data_start</span><span class="p">)(),</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(()),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DW_EH_PE_indirect</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276182602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276182602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276182602">(Mar 22 2022 at 12:46)</a>:</h4>
<p>(at the very end the cast the usize they've constructed to a pointer and read another usize out of it)</p>



<a name="276184549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276184549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276184549">(Mar 22 2022 at 13:01)</a>:</h4>
<p>this whole file needs a rejig, unfortunately</p>



<a name="276186207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276186207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276186207">(Mar 22 2022 at 13:14)</a>:</h4>
<p>The eh_personality function needs to be working outside of the regular pointer provenance rules anyway. The compiler trusts that it behaves in  accordance with the generated unwind tables. If it doesn't you get UB.</p>



<a name="276186265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276186265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276186265">(Mar 22 2022 at 13:15)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> hmm could you elaborate on that?</p>



<a name="276186310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276186310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276186310">(Mar 22 2022 at 13:15)</a>:</h4>
<p>that sounds plausible but i'm still waking up, and this is definitely an Interesting Case Study to say the least</p>



<a name="276186723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276186723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276186723">(Mar 22 2022 at 13:18)</a>:</h4>
<p>Normally you aren't allowed to read or write anything on the stack except when you have taken a pointer to it. The personality function (and the unwinding mechanism in general) reads and writes parts of the stack that contain eg spilled values. This is only allowed because the unwind tables specify exactly what the unwinding mechanism should do. Any deviation from this (eg writing some other value than told to) causes UB.</p>



<a name="276186845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276186845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276186845">(Mar 22 2022 at 13:19)</a>:</h4>
<p>ok so in terms of a strict model this would be given provenance over ~the whole stack anyway</p>



<a name="276187319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276187319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276187319">(Mar 22 2022 at 13:23)</a>:</h4>
<p>so this is basically fine on the premise that the compiler <em>generated</em> this unwinding table, so it "knows" exactly what it will do already, but the runtime needs to remember what that is..?</p>



<a name="276187321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276187321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276187321">(Mar 22 2022 at 13:23)</a>:</h4>
<p>HMMM</p>



<a name="276187559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276187559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276187559">(Mar 22 2022 at 13:25)</a>:</h4>
<p>pretty much. if you follow the unwinding table generated by the compiler to the letter everything is fine. if you don't follow it, arbitrary bad things happen.</p>



<a name="276187825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276187825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276187825">(Mar 22 2022 at 13:27)</a>:</h4>
<p>i should look into how CHERI expects a binary to establish this kind of chain of custody</p>



<a name="276194204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276194204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276194204">(Mar 22 2022 at 14:12)</a>:</h4>
<p>so it turns out that there's calls of that function that don't need the full capability lol</p>



<a name="276194421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276194421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276194421">(Mar 22 2022 at 14:14)</a>:</h4>
<p>specifically the "call site encoding" can only have two values:</p>
<ol>
<li>GCC: <a href="https://github.com/gcc-mirror/gcc/blob/373a2dc2be0089ae59b61202a6023458aaaf63d8/gcc/except.cc#L3118-L3122">https://github.com/gcc-mirror/gcc/blob/373a2dc2be0089ae59b61202a6023458aaaf63d8/gcc/except.cc#L3118-L3122</a></li>
<li>LLVM: <a href="https://github.com/llvm/llvm-project/blob/2ef95efb414e215490a222de05cafdffb8054758/llvm/lib/Target/TargetLoweringObjectFile.cpp#L50-L65">https://github.com/llvm/llvm-project/blob/2ef95efb414e215490a222de05cafdffb8054758/llvm/lib/Target/TargetLoweringObjectFile.cpp#L50-L65</a><br>
(there's also <code>CallSiteEncoding = dwarf::DW_EH_PE_udata4;</code> in <a href="https://github.com/llvm/llvm-project/blob/2ef95efb414e215490a222de05cafdffb8054758/llvm/lib/CodeGen/TargetLoweringObjectFileImpl.cpp">https://github.com/llvm/llvm-project/blob/2ef95efb414e215490a222de05cafdffb8054758/llvm/lib/CodeGen/TargetLoweringObjectFileImpl.cpp</a>)</li>
</ol>



<a name="276194596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276194596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276194596">(Mar 22 2022 at 14:15)</a>:</h4>
<p>so we could safely have a much more limited version that produces <code>Err</code> on anything other than integer encodings, for these 3 calls <a href="https://github.com/rust-lang/rust/blob/3ea44938e21f0de8ae7d4f6399a8a30f97867c70/library/panic_unwind/src/dwarf/eh.rs#L83-L85">https://github.com/rust-lang/rust/blob/3ea44938e21f0de8ae7d4f6399a8a30f97867c70/library/panic_unwind/src/dwarf/eh.rs#L83-L85</a></p>



<a name="276194691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276194691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276194691">(Mar 22 2022 at 14:16)</a>:</h4>
<p>and then a lot of that file needs s/<code>usize</code>/<code>*mut u8</code>/ or thereabouts</p>



<a name="276194806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276194806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276194806">(Mar 22 2022 at 14:17)</a>:</h4>
<p>(fwiw the seh file also looks messy, but I didn't even bother since dwarf broke my spirit lol)</p>



<a name="276194841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276194841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276194841">(Mar 22 2022 at 14:17)</a>:</h4>
<p>I agree with <span class="user-mention" data-user-id="133247">@bjorn3</span> but e.g. <code>DW_EH_PE_textrel</code> and <code>DW_EH_PE_datarel</code> should have their own separate pointer offsetting and whatnot, because those two could/should be isolated under CHERI</p>



<a name="276195013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276195013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276195013">(Mar 22 2022 at 14:18)</a>:</h4>
<p>for almost anything there's a clear chain of custody, and when there isn't, it looks an awful lot like "CHERI would have a relocation so that the value is actually a valid pointer in memory" (tho I guess DWARF doesn't want actual relocations in the debuginfo/EH sections? not sure)</p>



<a name="276195377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276195377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276195377">(Mar 22 2022 at 14:21)</a>:</h4>
<p>the best information I could find on <code>DW_EH_PE_indirect</code> is that it's used to encode a "RTTI is a <code>static</code> accessible through this GOT", which means that:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DW_EH_PE_indirect</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>should instead be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DW_EH_PE_indirect</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(with <code>result</code> being <code>*const u8</code> instead of <code>usize</code>, at that point)</p>
<p>That is, IIUC, GOT under CHERI would contain actual valid CHERI pointers ("capabilities"), <em>not</em> addresses</p>



<a name="276195696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276195696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276195696">(Mar 22 2022 at 14:22)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> the worst part about this LSDA stuff is that GCC just made up an encoding and LLVM reimplemented it, but in neither case there's no actual strict spec AFAICT, and out of sheer laziness, existing unwinders (including this Rust code) support nonsensical situations</p>



<a name="276196004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276196004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276196004">(Mar 22 2022 at 14:25)</a>:</h4>
<p>up to 30/36 crates, just hit 33 cases in sys, not looking forward to that... break time...</p>



<a name="276196013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276196013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276196013">(Mar 22 2022 at 14:25)</a>:</h4>
<p>I think DWARF allows relocations in <code>.eh_frame</code> the linker output. It just needs the dynamic linker to perform them before the unwinder runs.</p>



<a name="276196129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276196129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276196129">(Mar 22 2022 at 14:26)</a>:</h4>
<p>I guess that means using a large enough encoding to allow relocating, no ULEB128 shenans</p>



<a name="276198413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276198413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276198413">(Mar 22 2022 at 14:41)</a>:</h4>
<p>forked the <code>dwarf::eh</code> discussion into <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20in.20dwarf.3A.3Aeh">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20in.20dwarf.3A.3Aeh</a> because I left some notes there if anyone wants to clean up the implementation to be CHERI-friendly</p>



<a name="276198724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276198724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276198724">(Mar 22 2022 at 14:43)</a>:</h4>
<p>this thread would make for a great blog post as a case study in the difficulty of transitioning away from int-ptr casts in practice</p>



<a name="276208733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276208733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276208733">(Mar 22 2022 at 15:43)</a>:</h4>
<p>that is the point yes</p>



<a name="276219431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276219431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276219431">(Mar 22 2022 at 16:49)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">keyed_event_handle</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">c</span>::<span class="n">HANDLE</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INVALID</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">HANDLE</span>: <span class="nc">AtomicUsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AtomicUsize</span>::<span class="n">new</span><span class="p">(</span><span class="n">INVALID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">HANDLE</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">Relaxed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">INVALID</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span>::<span class="n">INVALID_HANDLE_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">c</span>::<span class="n">NtCreateKeyedEvent</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">c</span>::<span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c</span>::<span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">c</span>::<span class="n">STATUS_SUCCESS</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">                    </span><span class="n">r</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Unable to create keyed event handle: error {r}"</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">HANDLE</span><span class="p">.</span><span class="n">compare_exchange</span><span class="p">(</span><span class="n">INVALID</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Relaxed</span><span class="p">,</span><span class="w"> </span><span class="n">Relaxed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// Lost the race to another thread initializing HANDLE before we did.</span>
<span class="w">                    </span><span class="c1">// Closing our handle and using theirs instead.</span>
<span class="w">                    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">c</span>::<span class="n">CloseHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="n">h</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">c</span>::<span class="n">HANDLE</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">handle</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">c</span>::<span class="n">HANDLE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276219438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276219438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276219438">(Mar 22 2022 at 16:49)</a>:</h4>
<p>windowsssss</p>



<a name="276221271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276221271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276221271">(Mar 22 2022 at 17:01)</a>:</h4>
<p>HANDLE is only sort of a pointer. It's not something anyone ever dereferences, I believe.</p>



<a name="276221594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276221594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276221594">(Mar 22 2022 at 17:03)</a>:</h4>
<p>yeah this code is actually pretty easy to swap out with AtomicPtr and stuff, afaict</p>



<a name="276221835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276221835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276221835">(Mar 22 2022 at 17:05)</a>:</h4>
<p>lol windows/os.rs just has <code>ch as usize == 0</code></p>



<a name="276222097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276222097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276222097">(Mar 22 2022 at 17:06)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">security_attributes</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="c1">// FIXME: should be a reference</span>
</code></pre></div>



<a name="276222118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276222118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276222118">(Mar 22 2022 at 17:06)</a>:</h4>
<p>whelp that deserve a git blame</p>



<a name="276223117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223117">(Mar 22 2022 at 17:12)</a>:</h4>
<p>nooooo</p>



<a name="276223120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223120">(Mar 22 2022 at 17:12)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/commit/ae30294771e3c5c65a2d70be0e09b5bec2490c66">https://github.com/rust-lang/rust/commit/ae30294771e3c5c65a2d70be0e09b5bec2490c66</a></p>



<a name="276223167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223167">(Mar 22 2022 at 17:13)</a>:</h4>
<p>rather than an <code>impl</code> Sync they just made the pointer a usize???????????</p>



<a name="276223172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223172">(Mar 22 2022 at 17:13)</a>:</h4>
<p>no?????</p>



<a name="276223815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223815">(Mar 22 2022 at 17:18)</a>:</h4>
<p>raw ptr behavior wrt auto traits is really suboptimal. best idea I have is they should make it <em>ambiguous</em> whether <code>Send</code>/<code>Sync</code> are implemented, and force you to explicitly say which is the case (cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span>: IMO auto traits should use ternary logic :P)</p>



<a name="276223898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223898">(Mar 22 2022 at 17:19)</a>:</h4>
<p>y-yeah that's called unsafe impl eddyb</p>



<a name="276223922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223922">(Mar 22 2022 at 17:19)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> comment from the PR that did it: "Maybe it is better to remove the pointer for now, as the function to set also removed."</p>



<a name="276223968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223968">(Mar 22 2022 at 17:19)</a>:</h4>
<p>The classic permanent temporary solution</p>



<a name="276223988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223988">(Mar 22 2022 at 17:19)</a>:</h4>
<p>there's not a problem???</p>



<a name="276223990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276223990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276223990">(Mar 22 2022 at 17:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276223898">said</a>:</p>
<blockquote>
<p>y-yeah that's called unsafe impl eddyb</p>
</blockquote>
<p>no, that's risky in case a new field could be added that is <em>definitely</em> <code>!Send</code>/<code>!Sync</code> (like an <code>Rc</code>)</p>



<a name="276224014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224014">(Mar 22 2022 at 17:19)</a>:</h4>
<p>wheres raw pointers are just "sus idk"</p>



<a name="276224084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224084">(Mar 22 2022 at 17:20)</a>:</h4>
<p><em>I guess</em></p>



<a name="276224103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224103">(Mar 22 2022 at 17:20)</a>:</h4>
<p>I maintain unsafe impl is just Right here</p>



<a name="276224178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224178">(Mar 22 2022 at 17:20)</a>:</h4>
<p>I would want a non-<code>unsafe</code> version of <code>impl Send for Foo</code> that doesn't allow fields that are <code>!Send</code> <em>on purpose</em></p>



<a name="276224467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224467">(Mar 22 2022 at 17:22)</a>:</h4>
<p>there are many solutions but this is like, the Worst one lol</p>



<a name="276224536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224536">(Mar 22 2022 at 17:23)</a>:</h4>
<p>like newtyping the pointer would be just as much work as what they did</p>



<a name="276224561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224561">(Mar 22 2022 at 17:23)</a>:</h4>
<p>oh definitely agreed heh. I would make an <code>unsafe impl Send + Sync</code> wrapper for that pointer if that was necessary - oh you just said that heh</p>



<a name="276224798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224798">(Mar 22 2022 at 17:25)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">layout</span><span class="p">.</span><span class="n">align</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">layout</span><span class="p">.</span><span class="n">align</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="c1">// SAFETY: `MIN_ALIGN` &lt;= `offset` &lt;= `layout.align()` and the size of the allocated</span>
<span class="w">        </span><span class="c1">// block is `layout.align() + layout.size()`. `aligned` will thus be a correctly aligned</span>
<span class="w">        </span><span class="c1">// pointer inside the allocated block with at least `layout.size()` bytes after it and at</span>
<span class="w">        </span><span class="c1">// least `MIN_ALIGN` bytes of padding before it.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="276224810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224810">(Mar 22 2022 at 17:25)</a>:</h4>
<p>don't we just have APIs for this now</p>



<a name="276224868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276224868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276224868">(Mar 22 2022 at 17:25)</a>:</h4>
<p>oh no wait it's the evil one that goes to infinity isn't it</p>



<a name="276225171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276225171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276225171">(Mar 22 2022 at 17:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276223167">said</a>:</p>
<blockquote>
<p>rather than an <code>impl</code> Sync they just made the pointer a usize???????????</p>
</blockquote>
<p>It would be very cool to have a list of places this was done. <code>rayon</code> does the same thing.</p>



<a name="276227141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276227141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276227141">(Mar 22 2022 at 17:41)</a>:</h4>
<p>hell yes now for the real fun</p>



<a name="276227146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276227146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276227146">(Mar 22 2022 at 17:41)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="c1">// Swap out our state with however we finished.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state_and_queue</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">state_and_queue</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">set_state_on_drop_to</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">AcqRel</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// We should only ever see an old state which was RUNNING.</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state_and_queue</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">STATE_MASK</span><span class="p">,</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="276227158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276227158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276227158">(Mar 22 2022 at 17:41)</a>:</h4>
<p>sync::once doing atomic tagged pointers</p>



<a name="276227235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276227235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276227235">(Mar 22 2022 at 17:42)</a>:</h4>
<p>STATE_MASK is 3 so, should be Fine</p>



<a name="276231921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276231921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276231921">(Mar 22 2022 at 18:11)</a>:</h4>
<p>love too noop</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutex</span><span class="p">.</span><span class="n">raw</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">mutex_imp</span>::<span class="n">Mutex</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_void</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="276233421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276233421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276233421">(Mar 22 2022 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276227158">said</a>:</p>
<blockquote>
<p>sync::once doing atomic tagged pointers</p>
</blockquote>
<p>Do your changes include support for this? I had been meaning to try hacking in the bitops on AtomicPtr as an experiment, but had (perhaps falsely) concluded it would be a pain in the ass and require a bunch of compiler changes</p>



<a name="276233750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276233750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276233750">(Mar 22 2022 at 18:23)</a>:</h4>
<p>the API as-is works fine, all the tagging is non-atomic, it's just doing cmpxchg on the tagged ptrs</p>



<a name="276233825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276233825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276233825">(Mar 22 2022 at 18:23)</a>:</h4>
<p><a href="/user_uploads/4715/gS8lU3rOsKFuTB4ui7nq_onR/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/gS8lU3rOsKFuTB4ui7nq_onR/image.png" title="image.png"><img src="/user_uploads/4715/gS8lU3rOsKFuTB4ui7nq_onR/image.png"></a></div>



<a name="276233842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276233842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276233842">(Mar 22 2022 at 18:23)</a>:</h4>
<p>;-;</p>



<a name="276234505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276234505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276234505">(Mar 22 2022 at 18:28)</a>:</h4>
<p>std::io::error::repr_bitpacked is a Whole Thing</p>



<a name="276234586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276234586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276234586">(Mar 22 2022 at 18:28)</a>:</h4>
<p>oof, shift by <em>32</em></p>



<a name="276234850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276234850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276234850">(Mar 22 2022 at 18:30)</a>:</h4>
<p>oh thank god it's an implicit union, and not a pointer actually getting shifted by 32</p>



<a name="276235125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276235125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276235125">(Mar 22 2022 at 18:32)</a>:</h4>
<p>whoever wrote this is a GOOD BEAN</p>



<a name="276235133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276235133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276235133">(Mar 22 2022 at 18:32)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">().</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">().</span><span class="n">wrapping_sub</span><span class="p">(</span><span class="n">TAG_CUSTOM</span><span class="p">).</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="n">Custom</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="276235139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276235139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276235139">(Mar 22 2022 at 18:32)</a>:</h4>
<p>already responsible</p>



<a name="276235359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276235359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276235359">(Mar 22 2022 at 18:33)</a>:</h4>
<p>Oh, I wrote that</p>



<a name="276235462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276235462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276235462">(Mar 22 2022 at 18:34)</a>:</h4>
<p>I was thinking about provenance when I wrote it, but yes, it is a whole thing.</p>



<a name="276235577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276235577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276235577">(Mar 22 2022 at 18:35)</a>:</h4>
<p><em>high fives</em></p>



<a name="276236484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276236484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276236484">(Mar 22 2022 at 18:41)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>



<a name="276236486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276236486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276236486">(Mar 22 2022 at 18:41)</a>:</h4>
<p>...huh</p>



<a name="276236504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276236504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276236504">(Mar 22 2022 at 18:41)</a>:</h4>
<p>i guess?</p>



<a name="276239038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276239038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276239038">(Mar 22 2022 at 19:00)</a>:</h4>
<p>PAST STAGE 1</p>



<a name="276239906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276239906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276239906">(Mar 22 2022 at 19:07)</a>:</h4>
<p>I've been auditing transmutes in the standard library (and working on getting lints for transmutes and unions working). Lot's of transmutes to/from in docs and tests, but not that many in actual std.</p>
<p>main one is in mpsc, also appears to be the AtomicUsize thing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="sd">/// Converts to an unsafe usize value. Useful for storing in a pipe's state</span>
<span class="w">    </span><span class="sd">/// flag.</span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">cast_to_usize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="sd">/// Converts from an unsafe usize value. Useful for retrieving a pipe's state</span>
<span class="w">    </span><span class="sd">/// flag.</span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">cast_from_usize</span><span class="p">(</span><span class="n">signal_ptr</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">SignalToken</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SignalToken</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inner</span>: <span class="nc">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">signal_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276240399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276240399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276240399">(Mar 22 2022 at 19:11)</a>:</h4>
<p>good to know</p>



<a name="276240451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276240451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276240451">(Mar 22 2022 at 19:11)</a>:</h4>
<p>actually yeah there's transmute checks now, I suppose we should complain about transmuting this stuff too...?</p>



<a name="276240458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276240458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276240458">(Mar 22 2022 at 19:11)</a>:</h4>
<p>but harder to catch</p>



<a name="276240533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276240533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276240533">(Mar 22 2022 at 19:12)</a>:</h4>
<p>anyway, onto STAGE 2 where we start getting the compiler narcing on itself for being mean to pointers</p>



<a name="276240554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276240554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276240554">(Mar 22 2022 at 19:12)</a>:</h4>
<p>rustc_arena, unsurprisingly, our first stop</p>



<a name="276242346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276242346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276242346">(Mar 22 2022 at 19:27)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">new_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="p">.</span><span class="n">checked_sub</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">align</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>thanks rustc_arena</p>



<a name="276244016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276244016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276244016">(Mar 22 2022 at 19:40)</a>:</h4>
<p>oh i <em>hate</em> whatever rustc_data_structures thinks it's doing</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">BITS</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">().</span><span class="n">trailing_zeros</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">into_usize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_usize</span><span class="p">(</span><span class="n">ptr</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">with_ref</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ManuallyDrop</span>::<span class="n">new</span><span class="p">(</span><span class="bp">Self</span>::<span class="n">from_usize</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276245299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276245299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276245299">(Mar 22 2022 at 19:52)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compiler</span><span class="err">\</span><span class="n">rustc_middle</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">ty</span><span class="err">\</span><span class="n">list</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="mi">200</span>:<span class="nc">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rustc_data_structures</span>::<span class="n">tagged_ptr</span>::<span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">compiler</span><span class="err">\</span><span class="n">rustc_data_structures</span><span class="err">\</span><span class="n">src</span><span class="err">\</span><span class="n">tagged_ptr</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="mi">91</span>:<span class="nc">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">107</span>:<span class="nc">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Rc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">123</span>:<span class="nc">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">139</span>:<span class="nc">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">154</span>:<span class="nc">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>



<a name="276245302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276245302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276245302">(Mar 22 2022 at 19:52)</a>:</h4>
<p>crimes</p>



<a name="276249570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276249570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276249570">(Mar 22 2022 at 20:26)</a>:</h4>
<p>pretty fried, pushed up my work so far.</p>



<a name="276249577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276249577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276249577">(Mar 22 2022 at 20:26)</a>:</h4>
<p>rustc has a bunch of tagged pointers</p>



<a name="276268621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276268621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276268621">(Mar 22 2022 at 23:30)</a>:</h4>
<p>hey rustc_interface what the actual fuck</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(unix)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">current_dll_path</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">PathBuf</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="p">{</span><span class="n">CStr</span><span class="p">,</span><span class="w"> </span><span class="n">OsStr</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_dll_path</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">zeroed</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">libc</span>::<span class="n">dladdr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">"dladdr failed"</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">dli_fname</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">"dladdr returned null pointer"</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CStr</span>::<span class="n">from_ptr</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">dli_fname</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">os</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OsStr</span>::<span class="n">from_bytes</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">PathBuf</span>::<span class="n">from</span><span class="p">(</span><span class="n">os</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276268636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276268636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276268636">(Mar 22 2022 at 23:30)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_dll_path</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="276268642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276268642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276268642">(Mar 22 2022 at 23:30)</a>:</h4>
<p><em>that's its own symbol</em></p>



<a name="276268660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276268660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276268660">(Mar 22 2022 at 23:31)</a>:</h4>
<p>it casts itself to a pointer........</p>



<a name="276269240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276269240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276269240">(Mar 22 2022 at 23:39)</a>:</h4>
<p>I see you've never worked with some <em>fun</em> platfrom APIs.</p>



<a name="276269274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276269274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276269274">(Mar 22 2022 at 23:39)</a>:</h4>
<p>like i get the idea it's just a real double-take moment</p>



<a name="276269353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276269353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276269353">(Mar 22 2022 at 23:40)</a>:</h4>
<p>also the random as usize along the way is HMM</p>



<a name="276269363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276269363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276269363">(Mar 22 2022 at 23:40)</a>:</h4>
<p>unless is doing The AVR Hack</p>



<a name="276269366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276269366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276269366">(Mar 22 2022 at 23:40)</a>:</h4>
<p>But I doubt that?</p>



<a name="276269447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276269447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276269447">(Mar 22 2022 at 23:42)</a>:</h4>
<p>Probably the result of being unable to directly cast without going through the fn(...) -&gt; ... dance</p>



<a name="276271366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276271366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276271366">(Mar 23 2022 at 00:06)</a>:</h4>
<p>got stage2 built my marking a bunch of files in rustc as WONTFIX (for now, eddyb is looking at some of the most eggregious stuff)</p>



<a name="276271380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276271380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276271380">(Mar 23 2022 at 00:06)</a>:</h4>
<p>now figuring out what linux needs for std</p>



<a name="276272398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276272398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276272398">(Mar 23 2022 at 00:19)</a>:</h4>
<p>ha, gcc unwinder casts to uintptr_t: <a href="https://github.com/rust-lang/rust/blob/5f37001055c29982f4c27ee9edd90449c8e07774/library/panic_unwind/src/gcc.rs#L199">https://github.com/rust-lang/rust/blob/5f37001055c29982f4c27ee9edd90449c8e07774/library/panic_unwind/src/gcc.rs#L199</a></p>



<a name="276273284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276273284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276273284">(Mar 23 2022 at 00:26)</a>:</h4>
<p>DlsymWeak just casually pulls out <em>transmute_copy</em> to convert a usize to a function pointer, you know, as you do.</p>



<a name="276273298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276273298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276273298">(Mar 23 2022 at 00:26)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute_copy</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="276273348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276273348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276273348">(Mar 23 2022 at 00:26)</a>:</h4>
<p>I think the issue is the code is generic over all function pointer signatures but you can't... say... that...?</p>



<a name="276273724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276273724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276273724">(Mar 23 2022 at 00:29)</a>:</h4>
<p>you could write some trait for like 10 different argument counts and still wouldn't be able to handle for&lt;'a&gt;, correct</p>



<a name="276273887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276273887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276273887">(Mar 23 2022 at 00:31)</a>:</h4>
<p>for regular function pointers you could do <code>F: Fn&lt;Args&gt;</code> to add a little type-safety but you still wouldn't be able to do a <code>transmute</code></p>



<a name="276273924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276273924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276273924">(Mar 23 2022 at 00:31)</a>:</h4>
<p>agreed</p>



<a name="276274029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276274029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276274029">(Mar 23 2022 at 00:32)</a>:</h4>
<p>I think this code is """fine""" if I make it use AtomicPtr instead of AtomicUsize</p>



<a name="276274178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276274178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276274178">(Mar 23 2022 at 00:33)</a>:</h4>
<p>the two-special-case match is a little uglier, but yeah</p>



<a name="276274192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276274192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276274192">(Mar 23 2022 at 00:33)</a>:</h4>
<p>no matter what it's relying on ptr == fnptr, but that's literally the dlsym API so</p>



<a name="276274546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276274546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276274546">(Mar 23 2022 at 00:36)</a>:</h4>
<p>that AVR thing in ptr has me super paranoid now lol</p>



<a name="276276882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276276882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276276882">(Mar 23 2022 at 00:56)</a>:</h4>
<p>unix thread code doing a lot of intptr stuff just to hack in <code>offset</code> on a c_void</p>



<a name="276276911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276276911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276276911">(Mar 23 2022 at 00:57)</a>:</h4>
<p>I'm replacing it with with_addr, because it's a bit less verbose than going to *mut u8 and back</p>



<a name="276276912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276276912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276276912">(Mar 23 2022 at 00:57)</a>:</h4>
<p>(and less disruptive)</p>



<a name="276277329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277329">(Mar 23 2022 at 01:02)</a>:</h4>
<p>hmm unix::process....</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">want_clone3_pidfd</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">HAS_CLONE3</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">Ordering</span>::<span class="n">Relaxed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clone_args</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">flags</span>: <span class="nc">CLONE_PIDFD</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">pidfd</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">pidfd</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">pid_t</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">child_tid</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">parent_tid</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">exit_signal</span>: <span class="nc">libc</span>::<span class="n">SIGCHLD</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">stack</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">stack_size</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">tls</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">set_tid</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">set_tid_size</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">cgroup</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="276277337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277337">(Mar 23 2022 at 01:02)</a>:</h4>
<p><code>pidfd: &amp;mut pidfd as *mut pid_t as u64,</code></p>



<a name="276277369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277369">(Mar 23 2022 at 01:03)</a>:</h4>
<p>second encounter with "C ABI mandates integer"</p>



<a name="276277375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277375">(Mar 23 2022 at 01:03)</a>:</h4>
<p>in this case I suspect it's forcing a consistent size for x32</p>



<a name="276277397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277397">(Mar 23 2022 at 01:03)</a>:</h4>
<p>addr() as u64 should work the same afaict</p>



<a name="276277469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277469">(Mar 23 2022 at 01:04)</a>:</h4>
<p>I mean, the C is casting it back to a pointer and writing to it</p>



<a name="276277504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277504">(Mar 23 2022 at 01:05)</a>:</h4>
<p>so it needs to be usable as a pointer</p>



<a name="276277516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277516">(Mar 23 2022 at 01:05)</a>:</h4>
<p>hmm fair</p>



<a name="276277693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276277693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276277693">(Mar 23 2022 at 01:08)</a>:</h4>
<p>gonna mark this one WONTFIX for now</p>



<a name="276278296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276278296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276278296">(Mar 23 2022 at 01:21)</a>:</h4>
<p><a href="http://stack_overflow.rs">stack_overflow.rs</a> has the same problem but sighandler_t == size_t</p>



<a name="276278332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276278332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276278332">(Mar 23 2022 at 01:21)</a>:</h4>
<p>same for PR_SET_NAME</p>



<a name="276278388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276278388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276278388">(Mar 23 2022 at 01:22)</a>:</h4>
<p>this time libc_ulong</p>



<a name="276279693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276279693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276279693">(Mar 23 2022 at 01:47)</a>:</h4>
<blockquote>
<p>test result: FAILED. 12555 passed; 89 failed; 106 ignored; 0 measured; 0 filtered out; finished in 117.40s</p>
</blockquote>



<a name="276280202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276280202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276280202">(Mar 23 2022 at 01:57)</a>:</h4>
<p>nice.</p>



<a name="276281526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281526">(Mar 23 2022 at 02:25)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> am I just... allowed... to land these buckwild APIs???</p>



<a name="276281745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281745">(Mar 23 2022 at 02:29)</a>:</h4>
<p>i feel like this kind of thing needs an rfc maybe</p>



<a name="276281756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281756">(Mar 23 2022 at 02:29)</a>:</h4>
<p>at least the fact that it comes with a future-compat lint</p>



<a name="276281815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281815">(Mar 23 2022 at 02:30)</a>:</h4>
<p>this is specifically in the context of just like .addr() and stuff so submodules can use it</p>



<a name="276281830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281830">(Mar 23 2022 at 02:30)</a>:</h4>
<p>right not stdarch is sad because of a debug_assert</p>



<a name="276281834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281834">(Mar 23 2022 at 02:30)</a>:</h4>
<p>Yeah, the lint can't land with the fn, but yes, the functions per se can simply be PRed as a library feature and they will fall under the purview of a T-libs signoff, but I feel the motivation is obvious.</p>



<a name="276281835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281835">(Mar 23 2022 at 02:30)</a>:</h4>
<p>I guess we could just, remove the debug_assert</p>



<a name="276281861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281861">(Mar 23 2022 at 02:31)</a>:</h4>
<p>I was <em>intending</em> for this to just be a hacky ball that people run off with to do miri experiments on</p>



<a name="276281867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281867">(Mar 23 2022 at 02:31)</a>:</h4>
<p>but I guess if I can just, add some APIs, sure, I guess?</p>



<a name="276281871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281871">(Mar 23 2022 at 02:31)</a>:</h4>
<p>unstable ofc.</p>



<a name="276281874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281874">(Mar 23 2022 at 02:31)</a>:</h4>
<p>well yeah</p>



<a name="276281924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281924">(Mar 23 2022 at 02:32)</a>:</h4>
<p>is it fine to const-stable an unstable API?</p>



<a name="276281925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281925">(Mar 23 2022 at 02:32)</a>:</h4>
<p>i assume so?</p>



<a name="276281929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281929">(Mar 23 2022 at 02:32)</a>:</h4>
<p>(nothing complains)</p>



<a name="276281949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276281949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276281949">(Mar 23 2022 at 02:32)</a>:</h4>
<p>If we did add the lint to the compiler I would hide it behind a -Z flag</p>



<a name="276282048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282048">(Mar 23 2022 at 02:34)</a>:</h4>
<p>Yeah, I think so.</p>



<a name="276282061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282061">(Mar 23 2022 at 02:34)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> We can just land <code>addr</code> and <code>with_addr</code>, right?</p>



<a name="276282109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282109">(Mar 23 2022 at 02:35)</a>:</h4>
<p>Might be worth tossing in map_addr if we're letting people actually mess around with them so they can tell us if one is better or not</p>



<a name="276282430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282430">(Mar 23 2022 at 02:41)</a>:</h4>
<p>Yeah. :3</p>



<a name="276282492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282492">(Mar 23 2022 at 02:42)</a>:</h4>
<p>if we wanted to let people mess around with this it would be desirable to land:</p>
<ul>
<li>ptr.addr()</li>
<li>ptr.with_addr()</li>
<li>? ptr.map_addr()</li>
<li>ptr::invalid</li>
<li>ptr::invalid_mut</li>
</ul>



<a name="276282499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282499">(Mar 23 2022 at 02:43)</a>:</h4>
<p>fake_alloc and exists_zst are more me fucking around</p>



<a name="276282562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282562">(Mar 23 2022 at 02:44)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> do you want me to undo all the places where I use these APIs in the PR for them?</p>



<a name="276282669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282669">(Mar 23 2022 at 02:46)</a>:</h4>
<p>Hmmmmmm, probably not unless it's really convoluted?</p>



<a name="276282678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282678">(Mar 23 2022 at 02:47)</a>:</h4>
<p>"it depends"</p>



<a name="276282687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282687">(Mar 23 2022 at 02:47)</a>:</h4>
<p>Haha.</p>



<a name="276282688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282688">(Mar 23 2022 at 02:47)</a>:</h4>
<p>it's like 80% as -&gt; addr()<br>
15% AtomicUsize -&gt; AtomicPtr</p>



<a name="276282698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282698">(Mar 23 2022 at 02:47)</a>:</h4>
<p>Yeah I'd carve out the 15% then.</p>



<a name="276282746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282746">(Mar 23 2022 at 02:48)</a>:</h4>
<p>Since that isn't new API surface.</p>



<a name="276282779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282779">(Mar 23 2022 at 02:49)</a>:</h4>
<p>mm fair enough</p>



<a name="276282789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282789">(Mar 23 2022 at 02:49)</a>:</h4>
<p>i'll think about how to untangle this into a palattable form tomorrow</p>



<a name="276282900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276282900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276282900">(Mar 23 2022 at 02:51)</a>:</h4>
<p>push latest?</p>



<a name="276283139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276283139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276283139">(Mar 23 2022 at 02:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276282900">said</a>:</p>
<blockquote>
<p>push latest?</p>
</blockquote>
<p>what do you mean?</p>



<a name="276283151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276283151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276283151">(Mar 23 2022 at 02:56)</a>:</h4>
<p>oh was just a request in case you had any other changes on local</p>



<a name="276283169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276283169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276283169">(Mar 23 2022 at 02:57)</a>:</h4>
<p>no i pushed it up, and also set the lint to Allow so the dependency "isn't" an issue</p>



<a name="276283171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276283171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276283171">(Mar 23 2022 at 02:57)</a>:</h4>
<p>aha.</p>



<a name="276284768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284768">(Mar 23 2022 at 03:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276282492">said</a>:</p>
<blockquote>
<p>if we wanted to let people mess around with this it would be desirable to land:</p>
<ul>
<li>ptr.addr()</li>
<li>ptr.with_addr()</li>
<li>? ptr.map_addr()</li>
<li>ptr::invalid</li>
<li>ptr::invalid_mut</li>
</ul>
</blockquote>
<p>which of these is the equivalent of like, <code>0x0400_0000 as *mut u16</code></p>



<a name="276284859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284859">(Mar 23 2022 at 03:33)</a>:</h4>
<p>is that a sentinel value or a MMIO stuff?</p>



<a name="276284870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284870">(Mar 23 2022 at 03:33)</a>:</h4>
<p>mmio stuff</p>



<a name="276284881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284881">(Mar 23 2022 at 03:34)</a>:</h4>
<p>fake_alloc which I'm not including in the first mvp, way too "i'm making shit up now"</p>



<a name="276284916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284916">(Mar 23 2022 at 03:34)</a>:</h4>
<p>:(</p>



<a name="276284922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284922">(Mar 23 2022 at 03:34)</a>:</h4>
<p>the mvp will not be enforced, it will be opt-in semantics that e.g. std will use to work better under miri initially</p>



<a name="276284938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284938">(Mar 23 2022 at 03:35)</a>:</h4>
<p>(fake_alloc would just be <code>as usize</code> in the mvp anyway)</p>



<a name="276284942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284942">(Mar 23 2022 at 03:35)</a>:</h4>
<p>the <code>voladdress</code> crate is basically entirely "i'll do your usize math for you and then turn it into a pointer and MMIO on it at the last moment"</p>



<a name="276284944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284944">(Mar 23 2022 at 03:35)</a>:</h4>
<p><em>nods</em></p>



<a name="276284946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276284946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276284946">(Mar 23 2022 at 03:35)</a>:</h4>
<p>we'll get to figuring that stuff out</p>



<a name="276285097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276285097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276285097">(Mar 23 2022 at 03:39)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95228">https://github.com/rust-lang/rust/issues/95228</a></p>



<a name="276286715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276286715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276286715">(Mar 23 2022 at 04:16)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> Excised the lint and AtomicPtr changes, now in <a href="https://github.com/rust-lang/rust/pull/95229">https://github.com/rust-lang/rust/pull/95229</a> for you to loot.</p>



<a name="276287765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276287765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276287765">(Mar 23 2022 at 04:41)</a>:</h4>
<p>Correction, now it's properly excised. Missed a spot.</p>



<a name="276289413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276289413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276289413">(Mar 23 2022 at 05:10)</a>:</h4>
<p>oh wow, thanks!</p>



<a name="276290956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276290956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276290956">(Mar 23 2022 at 05:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276282061">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> We can just land <code>addr</code> and <code>with_addr</code>, right?</p>
</blockquote>
<p>I don't see a fundamental reason we couldn't land those on nightly. I wouldn't want to see them <em>stabilized</em> without consensus on the solution they're a part of, but for experimentation sure.</p>



<a name="276291092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276291092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276291092">(Mar 23 2022 at 05:43)</a>:</h4>
<p><em>nods</em></p>



<a name="276292178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276292178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276292178">(Mar 23 2022 at 06:06)</a>:</h4>
<p>lol git</p>



<a name="276292181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276292181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276292181">(Mar 23 2022 at 06:06)</a>:</h4>
<p>"these things that don't conflict at all actually conflict!"</p>



<a name="276315783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276315783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276315783">(Mar 23 2022 at 10:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276274546">said</a>:</p>
<blockquote>
<p>that AVR thing in ptr has me super paranoid now lol</p>
</blockquote>
<p>eh I don't think we support any UNIX platform with the Harvard code/data split :P</p>



<a name="276315861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276315861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276315861">(Mar 23 2022 at 10:56)</a>:</h4>
<p>we may need to add an unstable <code>cfg</code> tho, to actually check for it</p>



<a name="276315968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276315968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276315968">(Mar 23 2022 at 10:57)</a>:</h4>
<p>like <code>#[cfg(target_has_unified_code_and_data_addrspace)]</code> or something</p>



<a name="276316429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276316429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276316429">(Mar 23 2022 at 11:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276284942">said</a>:</p>
<blockquote>
<p>the <code>voladdress</code> crate is basically entirely "i'll do your usize math for you and then turn it into a pointer and MMIO on it at the last moment"</p>
</blockquote>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> hah what if we... added a function to <code>std::arch</code> that only existed on embedded targets, and which was like <code>std::arch::mmio_ptr</code> :P?</p>



<a name="276316533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276316533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276316533">(Mar 23 2022 at 11:02)</a>:</h4>
<p>probably needs a better name, but, that's probably as best as we could manage without forcing people to synthesize them from a whole-address-space root at startup</p>



<a name="276316709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276316709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276316709">(Mar 23 2022 at 11:04)</a>:</h4>
<p>the idea being that you're opting into non-portable code, and it's unstable/unaccessible outside of the platforms deemed relevant</p>



<a name="276319084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276319084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276319084">(Mar 23 2022 at 11:25)</a>:</h4>
<p>BTW, <code>ptr::addr</code> cannot be made valid in a <code>const_fn</code>, but would still be useful in static initializers, which may be an argument for leaving it a primitive operation.</p>



<a name="276319195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276319195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276319195">(Mar 23 2022 at 11:26)</a>:</h4>
<p>And I think <code>with_addr</code> might be a similar story.<br>
<code>claim</code>/<code>unclaim</code>/<code>invalid</code>/<code>invalid_mut</code>/<code>mmio_ptr</code> I think could theoretically be, though.</p>



<a name="276321648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276321648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276321648">(Mar 23 2022 at 11:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276315783">said</a>:</p>
<blockquote>
<p>eh I don't think we support any UNIX platform with the Harvard code/data split :P</p>
</blockquote>
<p>does rust work on any non-unix harvard architectures??</p>



<a name="276321757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276321757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276321757">(Mar 23 2022 at 11:50)</a>:</h4>
<p>bstrie: <a href="https://github.com/avr-rust/rust-legacy-fork/issues/143">https://github.com/avr-rust/rust-legacy-fork/issues/143</a></p>



<a name="276321782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276321782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276321782">(Mar 23 2022 at 11:50)</a>:</h4>
<p><a href="https://github.com/avr-rust/rust-legacy-fork/issues/143#issuecomment-500126585">https://github.com/avr-rust/rust-legacy-fork/issues/143#issuecomment-500126585</a></p>



<a name="276321990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276321990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276321990">(Mar 23 2022 at 11:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276284942">said</a>:</p>
<blockquote>
<p>the <code>voladdress</code> crate is basically entirely "i'll do your usize math for you and then turn it into a pointer and MMIO on it at the last moment"</p>
</blockquote>
<p>so thinking about this more, I think tying this stuff explicitly to <code>volatile</code> might be the right play here. I am imagining rebranding <code>claim_alloc</code> as <code>claim_volatile</code> with roughly the contract of "all accesses to this address must be volatile and you must have permission to access this address (so basically you're a kernel)".</p>
<p>With the rationale that any valid use of <code>volatile</code> is basically wholy irrelevant to any kind of memory model. Like nothing should ever be reordered or cached, and there is a magical oracle that is changing the memory beyond the compiler's view. Only relevant thing is like "don't free this" but if you have volatile freeable memory I am Concerned to say the least.</p>



<a name="276322040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322040">(Mar 23 2022 at 11:53)</a>:</h4>
<p>Wasm is a harvard architecture.</p>



<a name="276322092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322092">(Mar 23 2022 at 11:54)</a>:</h4>
<p>but I Am Not A Language Lawyer</p>



<a name="276322285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322285">(Mar 23 2022 at 11:56)</a>:</h4>
<p>my mind is blown that wasm is harvard. that's cool</p>



<a name="276322472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322472">(Mar 23 2022 at 11:58)</a>:</h4>
<p>You can't put function references in the linear memory. You have to put them in a table of funcref elements and then store the index into this table in the linear memory.</p>



<a name="276322500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322500">(Mar 23 2022 at 11:58)</a>:</h4>
<p>There is no way to read the actual code of a function.</p>



<a name="276322512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322512">(Mar 23 2022 at 11:59)</a>:</h4>
<p>it would be really nice if Rust had "void* but for function pointers" to make this stuff easier</p>



<a name="276322630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322630">(Mar 23 2022 at 12:00)</a>:</h4>
<p>"is the size and representation of a function pointer; if you make an array of function pointers, this will offset through it; you can do address comparisons just fine"</p>



<a name="276322857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276322857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276322857">(Mar 23 2022 at 12:02)</a>:</h4>
<p>josh was expanding core::ffi recently, feel free to make it and stick it in there under its own feature flag</p>



<a name="276323010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276323010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276323010">(Mar 23 2022 at 12:04)</a>:</h4>
<p>i think it genuinely needs compiler/lang support</p>



<a name="276323045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276323045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276323045">(Mar 23 2022 at 12:04)</a>:</h4>
<p>hmm I guess it could be a repr(transparent) wrapper around <code>fn() -&gt; ()</code> that we transmute to?</p>



<a name="276326168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276326168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276326168">(Mar 23 2022 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276321648">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276315783">said</a>:</p>
<blockquote>
<p>eh I don't think we support any UNIX platform with the Harvard code/data split :P</p>
</blockquote>
<p>does rust work on any non-unix harvard platforms??</p>
</blockquote>
<p>AVR at least (and <span class="user-mention" data-user-id="133247">@bjorn3</span> mentioned wasm which I had forgotten about) but also I was just discussing last night with someone that for both MSP430 and x86_16 (the latter not being supported yet at all I don't think) you could theoretically do 32-bit code pointers while keeping 16-bit data pointers heh</p>



<a name="276326418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276326418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276326418">(Mar 23 2022 at 12:37)</a>:</h4>
<p>Yeah, real mode outside of <code>-mflat</code> can both have pointers in different address spaces (even with <code>-mnear</code>), but also different code and data sizes (both cases, <code>-mnear-data-far-fn</code> and <code>-mfar-data-near-fn</code>)</p>



<a name="276326859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276326859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276326859">(Mar 23 2022 at 12:42)</a>:</h4>
<p>(heh yeah I was staring at <a href="https://en.wikipedia.org/wiki/Intel_Memory_Model#Memory_models">https://en.wikipedia.org/wiki/Intel_Memory_Model#Memory_models</a> last night and it's surprisingly more sensible than I thought - in retrospect, you can't really go crazy with near pointers in a compiled language, only in assembly can you operate on "the segments live in the programmer's mind/code comments" principles, similar to banked memory, anything else would really want to get into dependent types or at least some kind of other static reasoning shenanigans)</p>



<a name="276327176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276327176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276327176">(Mar 23 2022 at 12:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276322512">said</a>:</p>
<blockquote>
<p>it would be really nice if Rust had "void* but for function pointers" to make this stuff easier</p>
</blockquote>
<p><code>unsafe extern "C" fn(...) -&gt;</code> oh... right, you can't do the varargs thing for the return, Objective-C has this issue where it needs one <code>objc_msgSend</code> for every possible return ABI.... (integer, float, indirect return that goes into the first argument pointer, etc.)</p>



<a name="276327213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276327213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276327213">(Mar 23 2022 at 12:45)</a>:</h4>
<p>and I guess you'd want to hide the ABI as well</p>



<a name="276327231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276327231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276327231">(Mar 23 2022 at 12:45)</a>:</h4>
<p>an integer can be defined but I agree that something weirder would be nice</p>



<a name="276327283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276327283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276327283">(Mar 23 2022 at 12:45)</a>:</h4>
<p>also Harvard arches make me happy we didn't go the <code>&amp;'static Code</code> route for <code>fn</code> pointers, because now we can account for that somehow, instead of being stuck</p>



<a name="276330754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276330754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276330754">(Mar 23 2022 at 13:16)</a>:</h4>
<p>With <code>&amp;'static Code</code> we can check that the pointee is a function, right?</p>



<a name="276353021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276353021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276353021">(Mar 23 2022 at 15:44)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95241">https://github.com/rust-lang/rust/pull/95241</a> &lt;--- actually mergeable PR</p>



<a name="276359750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276359750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276359750">(Mar 23 2022 at 16:21)</a>:</h4>
<p>yooo :D</p>



<a name="276360909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276360909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276360909">(Mar 23 2022 at 16:27)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> could you give me <code>try</code> perms?</p>



<a name="276360933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276360933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276360933">(Mar 23 2022 at 16:27)</a>:</h4>
<p>(for this pr)</p>



<a name="276361004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276361004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276361004">(Mar 23 2022 at 16:27)</a>:</h4>
<p>suresure.</p>



<a name="276361314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276361314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276361314">(Mar 23 2022 at 16:29)</a>:</h4>
<p>hmmm, did that not work.</p>



<a name="276361346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276361346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276361346">(Mar 23 2022 at 16:29)</a>:</h4>
<p>does it haave to be delegate+ oookaaay</p>



<a name="276361889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276361889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276361889">(Mar 23 2022 at 16:32)</a>:</h4>
<p>ah I think bors is dead.</p>



<a name="276362724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276362724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276362724">(Mar 23 2022 at 16:37)</a>:</h4>
<p>Ah, we're experiencing "degraded performance". <a href="https://www.githubstatus.com/">https://www.githubstatus.com/</a></p>



<a name="276365026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276365026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276365026">(Mar 23 2022 at 16:50)</a>:</h4>
<p>bors love inttoptr, fighting back</p>



<a name="276417881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276417881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276417881">(Mar 23 2022 at 23:52)</a>:</h4>
<p>PR passed try</p>



<a name="276417887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276417887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276417887">(Mar 23 2022 at 23:52)</a>:</h4>
<p>i sleep</p>



<a name="276419177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276419177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276419177">(Mar 24 2022 at 00:11)</a>:</h4>
<p>gnight!</p>



<a name="276745834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276745834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276745834">(Mar 26 2022 at 21:06)</a>:</h4>
<p>I've rebased/squashed all the previous changes and pushed up some new ones to fix review <a href="https://github.com/rust-lang/rust/pull/95241">https://github.com/rust-lang/rust/pull/95241</a></p>



<a name="276745864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276745864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276745864">(Mar 26 2022 at 21:07)</a>:</h4>
<p>while I am <em>sympathetic</em> to the places where people said "oh this can be turned into ptr.offset_from" they're all in like, Pretty Fucking Fancy Code and I think this is introducing too high of a chance for error for a PR that is scattershotting through 50 files and therefore won't get the kind of scrutiny necessary for that kind of thing</p>



<a name="276745927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276745927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276745927">(Mar 26 2022 at 21:08)</a>:</h4>
<p>(I already have one CVE under my belt for such a sweeping stdlib refactor, I would prefer not to get another, tyvm)</p>



<a name="276746029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276746029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276746029">(Mar 26 2022 at 21:11)</a>:</h4>
<p>anyone who wants to fuck with memrchr, TypedArena, or sorting algorithms can be my guest but i'm not taking the blame lol</p>



<a name="276794553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276794553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276794553">(Mar 27 2022 at 15:53)</a>:</h4>
<p>I've massively fleshed out the tracking issue with more descriptive text and an FAQ / link-tree in the second comment: <a href="https://github.com/rust-lang/rust/issues/95228">https://github.com/rust-lang/rust/issues/95228</a></p>



<a name="276794712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276794712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276794712">(Mar 27 2022 at 15:57)</a>:</h4>
<p>oh also I made it explicit that this work should tertiarily be trying to answer the question of "what the fuck is the deal with harvard architectures" because I kept running into that question during my prototyping, since fnptr &lt;-&gt; ptr/int casts kinda trivially get wrapped up into the same questions/issues.</p>



<a name="276912601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276912601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276912601">(Mar 28 2022 at 18:20)</a>:</h4>
<p>because i absolutely refused to get the MVP involved with the compiler, I was able to pull it out to a stable library, so anyone who wants to polyfill the APIs on stable can :D</p>
<p><a href="https://crates.io/crates/sptr">https://crates.io/crates/sptr</a></p>



<a name="276912618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276912618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276912618">(Mar 28 2022 at 18:20)</a>:</h4>
<blockquote>
<p>sptr: The Strict Provenance Polyfill</p>
</blockquote>



<a name="276912641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276912641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276912641">(Mar 28 2022 at 18:21)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="281757">@Jubilee</span> <span class="user-mention" data-user-id="120791">@RalfJ</span> ^</p>



<a name="276913407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276913407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276913407">(Mar 28 2022 at 18:27)</a>:</h4>
<p>the <a href="http://docs.rs">docs.rs</a> queue is so long today :(</p>



<a name="276913441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276913441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276913441">(Mar 28 2022 at 18:27)</a>:</h4>
<p>always is ime</p>



<a name="276913561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276913561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276913561">(Mar 28 2022 at 18:28)</a>:</h4>
<p>I often-enough seem to publish stuff when it's nearly empty</p>



<a name="276918957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276918957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276918957">(Mar 28 2022 at 19:16)</a>:</h4>
<p>nice :)</p>



<a name="276919689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276919689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276919689">(Mar 28 2022 at 19:23)</a>:</h4>
<p>...should i add these</p>



<a name="276919803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276919803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276919803">(Mar 28 2022 at 19:24)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// A pointer that pretends to be an integer, for API Crimes.</span>
<span class="sd">///</span>
<span class="sd">/// If you can't possibly satisfy strict provenance for whatever reason, you can at least</span>
<span class="sd">/// use this type to make sure the compiler still understands that Pointers Are Happening.</span>
<span class="sd">///</span>
<span class="sd">/// All operations on this type will derive provenance from the left-hand-size (lhs).</span>
<span class="sd">/// So `x + y` has `x`'s provenance. *Many* operations are nonsensical if the pointer</span>
<span class="sd">/// inside is a real pointer, but hey, you've reached for the "I Know What I'm Doing"</span>
<span class="sd">/// lever, so we'll let you *say* whatever gibberish you want.</span>
<span class="sd">///</span>
<span class="sd">/// Please submit a PR if you need some operation defined on usize to be exposed here.</span>
<span class="sd">///</span>
<span class="sd">/// Please don't use these types.</span>
<span class="cp">#[repr(transparent)]</span><span class="w"></span>
<span class="cp">#[allow(non_camel_case_types)]</span><span class="w"></span>
<span class="cp">#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, Hash)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">uptr</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
</code></pre></div>



<a name="276924445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276924445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276924445">(Mar 28 2022 at 20:06)</a>:</h4>
<p>Some nits:</p>
<ul>
<li>I think <code>Strict</code>'s type parameter should be an associated type instead, no? Because it's nonsensical for a pointer to implement both <code>Strict&lt;Foo&gt;</code> and <code>Strict&lt;Bar&gt;</code>.</li>
<li>I also wonder if <code>Strict</code> should be sealed, and am pretty sure that it should be an unsafe trait.</li>
</ul>



<a name="276924868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276924868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276924868">(Mar 28 2022 at 20:10)</a>:</h4>
<p>Does rust have first-class trait sealing now, or is there just A Trick You Do?</p>



<a name="276925783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276925783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276925783">(Mar 28 2022 at 20:16)</a>:</h4>
<p>Just A Trick You Do.</p>



<a name="276925862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276925862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276925862">(Mar 28 2022 at 20:16)</a>:</h4>
<p>the trick is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">private</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Sealed</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span>: <span class="nc">private</span>::<span class="n">Sealed</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">private</span>::<span class="n">Sealed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="c1">// ...</span>
</code></pre></div>



<a name="276925916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276925916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276925916">(Mar 28 2022 at 20:17)</a>:</h4>
<p>(I still want it to become a real thing, especially since that could let us take it into account in coherence.)</p>



<a name="276925961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276925961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276925961">(Mar 28 2022 at 20:17)</a>:</h4>
<p>Yeah I don't like having to use the hack really, becuase it feels like a hack.</p>



<a name="276926385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276926385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276926385">(Mar 28 2022 at 20:21)</a>:</h4>
<p>Yeah, especially since there are bunch of different hacks with subtly different behaviours.</p>
<p>Like you can also do something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">private</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Sealant</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">_sealed</span><span class="p">(</span><span class="n">_</span>: <span class="nc">private</span>::<span class="n">Sealant</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">_sealed</span><span class="p">(</span><span class="n">_</span>: <span class="nc">private</span>::<span class="n">Sealant</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276926716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276926716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276926716">(Mar 28 2022 at 20:24)</a>:</h4>
<p>Ah right, yeah, I... dislike that one</p>



<a name="276929059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276929059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276929059">(Mar 28 2022 at 20:47)</a>:</h4>
<p>Ok, I cleaned up the trait/sealed it (I don't think it needs to be unsafe... it's not a trait To Be Generic Over)</p>



<a name="276929096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276929096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276929096">(Mar 28 2022 at 20:47)</a>:</h4>
<p>published 0.2.0 with uptr/iptr and OpaqueFn stubbed out (behind features, only the stuff in the PR is on-by-default)</p>



<a name="276929104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276929104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276929104">(Mar 28 2022 at 20:47)</a>:</h4>
<p><a href="https://crates.io/crates/sptr">https://crates.io/crates/sptr</a></p>



<a name="276929178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276929178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276929178">(Mar 28 2022 at 20:48)</a>:</h4>
<p>(well OK I have the to_bits/from_bits deprecations on by default, but like, if you're using this stuff you <em>really</em> don't want to be using <em>that</em> stuff)</p>



<a name="276929315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276929315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276929315">(Mar 28 2022 at 20:49)</a>:</h4>
<p>Yeah, sealing means it doesn't matter if it's an unsafe trait or not.</p>



<a name="276929960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276929960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276929960">(Mar 28 2022 at 20:55)</a>:</h4>
<p>Hmm... I'm sure I've seen crates expose things "behind features" before. Is there a special way to tell <a href="http://docs.rs">docs.rs</a> to do that?</p>



<a name="276930427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276930427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276930427">(Mar 28 2022 at 20:59)</a>:</h4>
<p>ah, <a href="https://docs.rs/about/metadata">https://docs.rs/about/metadata</a></p>



<a name="276932381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276932381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276932381">(Mar 28 2022 at 21:15)</a>:</h4>
<p>If you're wondering how some crates make it show up as requiring the feature in the docs (e.g. the bit on &lt;<a href="https://docs.rs/rusqlite/latest/rusqlite/blob/index.html">https://docs.rs/rusqlite/latest/rusqlite/blob/index.html</a>&gt;, that says "This is supported on crate feature blob only."), you need <code>#![feature(doc_cfg)]</code>.</p>
<p>You can put this all behind a <code>cfg_attr</code> by using something like <code>rustdoc-args = ["--cfg", "docsrs"]</code> in the docsrs metadata, but it is a pain.</p>



<a name="276932590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276932590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276932590">(Mar 28 2022 at 21:16)</a>:</h4>
<p>I think it's good enough that they'll try to use it and get told something's missing</p>



<a name="276932604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276932604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276932604">(Mar 28 2022 at 21:17)</a>:</h4>
<p>(for now)</p>



<a name="276934941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276934941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276934941">(Mar 28 2022 at 21:40)</a>:</h4>
<p>probably best not to spread this around until the PR lands (which, hopefully does not require a ton of administrative work...)</p>



<a name="276934958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276934958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276934958">(Mar 28 2022 at 21:40)</a>:</h4>
<p>Presumably we want a kind of, "it's all here, use it" rollout</p>



<a name="276935680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276935680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276935680">(Mar 28 2022 at 21:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276932381">said</a>:</p>
<blockquote>
<p><code>#![feature(doc_cfg)]</code>.</p>
</blockquote>
<p>It needs <code>#![feature(doc_cfg, doc_auto_cfg)]</code> if you want to avoid adding annotations everywhere</p>



<a name="276939078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276939078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276939078">(Mar 28 2022 at 22:34)</a>:</h4>
<p>Wow, TIL</p>



<a name="276941059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276941059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276941059">(Mar 28 2022 at 23:03)</a>:</h4>
<p>Because <a href="https://github.com/rust-lang/rust/issues/90497">https://github.com/rust-lang/rust/issues/90497</a></p>



<a name="276941225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276941225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276941225">(Mar 28 2022 at 23:06)</a>:</h4>
<p>I've just been adding annotations everywhere</p>



<a name="276945686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276945686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276945686">(Mar 29 2022 at 00:22)</a>:</h4>
<p>so i think whatever the fuck is going on with SOCKET is actually fine but it sucks that things are inconsistent and wobbly, filed: <a href="https://github.com/microsoft/windows-rs/issues/1643">https://github.com/microsoft/windows-rs/issues/1643</a></p>



<a name="276945712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276945712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276945712">(Mar 29 2022 at 00:23)</a>:</h4>
<p>tl;dr it's seemingly all integers pretending to be pointers For Fun, so provenance doesn't matter</p>



<a name="276951630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276951630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276951630">(Mar 29 2022 at 02:26)</a>:</h4>
<p>From a brief skim of types in <a href="https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types">https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types</a> that typedef to HANDLE, I found 2 that seem to actually be pointers:<br>
1) HINSTANCE/HMODULE "A handle to an instance. This is the base address of the module in memory."<br>
2) HGLOBAL , return value of GlobalAlloc <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-globalalloc">https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-globalalloc</a></p>



<a name="276957977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/276957977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#276957977">(Mar 29 2022 at 04:52)</a>:</h4>
<p>Yeah those seem like they probably mean HANDLE should be a pointer</p>



<a name="277041934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277041934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277041934">(Mar 29 2022 at 17:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/276929315">said</a>:</p>
<blockquote>
<p>Yeah, sealing means it doesn't matter if it's an unsafe trait or not.</p>
</blockquote>
<p>well that's like saying for private functions it doesnt matter if they are unsafe: technically correct but IMO morally wrong. ;) they should both still be annotated correctly.</p>



<a name="277042117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277042117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277042117">(Mar 29 2022 at 17:49)</a>:</h4>
<p>i do not know what it means for a trait that makes no guarantees of its own intrinsic semantics to "be unsafe"</p>



<a name="277042338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277042338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277042338">(Mar 29 2022 at 17:50)</a>:</h4>
<p>like my understanding of an unsafe trait is "a trait that generic code can assume all implementations are correct, at penalty of UB"</p>



<a name="277042435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277042435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277042435">(Mar 29 2022 at 17:51)</a>:</h4>
<p>and generally speaking is only really useful for marker traits, ime</p>



<a name="277045719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277045719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277045719">(Mar 29 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/277042435">said</a>:</p>
<blockquote>
<p>and generally speaking is only really useful for marker traits, ime</p>
</blockquote>
<p>Well with specialization you can split the unsafeness into a marker, I guess.</p>
<p>But IIRC <code>sort_unstable</code> could be something like 5-10% faster if <code>Ord</code> were <code>unsafe trait</code>.</p>



<a name="277045896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277045896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277045896">(Mar 29 2022 at 18:19)</a>:</h4>
<p>yeah that's the standard trick with TrustedLen, right?</p>



<a name="277045911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277045911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277045911">(Mar 29 2022 at 18:19)</a>:</h4>
<p>And there's TrustedLen. I don't remember if it's that or another trait that powers the specializations that enable reusing a Vec allocation</p>



<a name="277046075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277046075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277046075">(Mar 29 2022 at 18:21)</a>:</h4>
<p>I am... dubious of these optimizations tbh. It's stripping away defense in depth. I get it, people want numbers to go down, just worries me. (anyway, off topic...)</p>



<a name="277050711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277050711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277050711">(Mar 29 2022 at 19:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/277042338">said</a>:</p>
<blockquote>
<p>like my understanding of an unsafe trait is "a trait that generic code can assume all implementations are correct, at penalty of UB"</p>
</blockquote>
<p>unsafe trait means "when you implement this trait you have a proof obligation". it's certainly useful for non-marker-traits as well, in particular when combined with <code>unsafe fn</code> inside the trait</p>



<a name="277089853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277089853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277089853">(Mar 30 2022 at 03:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/277046075">said</a>:</p>
<blockquote>
<p>I am... dubious of these optimizations tbh. It's stripping away defense in depth. I get it, people want numbers to go down, just worries me. (anyway, off topic...)</p>
</blockquote>
<p>tbh this is why I have invested so much effort into portable SIMD on Rust. people should not be this eager to make crazy specialization stuff happen, there should be obvious fast impls.</p>



<a name="277098385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277098385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277098385">(Mar 30 2022 at 06:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/277046075">said</a>:</p>
<blockquote>
<p>I am... dubious of these optimizations tbh. It's stripping away defense in depth. I get it, people want numbers to go down, just worries me. (anyway, off topic...)</p>
</blockquote>
<p>i think std being fast and having optimizations means theres less need for user code to use unsafe to get performance. Given that std probably gets more eyes than other random crates <em>and</em> gets auto-updated as they update their compiler (unlike some lib implementing a more optimized $foo from <a href="http://crates.io">crates.io</a>), this feels worthwhile to me.</p>



<a name="277098402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277098402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277098402">(Mar 30 2022 at 06:14)</a>:</h4>
<p>its a balance though, for sure.</p>



<a name="277098620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277098620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277098620">(Mar 30 2022 at 06:19)</a>:</h4>
<p>I am very uncomfortable with the fact that specialization is such a load-bearing feature in std which has (AFAIK) no candidates for a sound implementation. I'm not sure there are any other nightly features with that combination</p>



<a name="277098720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277098720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277098720">(Mar 30 2022 at 06:21)</a>:</h4>
<p>it would be better if all specializations were <code>unsafe impl</code>, although that still wouldn't address the problem of what the proof obligations for safety are</p>



<a name="277100824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277100824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277100824">(Mar 30 2022 at 06:55)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// safety: I paid Ferris $10 to make sure this always works</span>
</code></pre></div>



<a name="277104567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277104567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277104567">(Mar 30 2022 at 07:38)</a>:</h4>
<p>Yeah it does seem unfortunate. I think for something as widely used as std performance is quite critical, but specialization seems like realizing footgun are better and playing with fireworks instead. An improvement sure, but...</p>
<p>Off topic: I parsed Lok's statement as the anime Ferris and got a chuckle after the Ferris meme that's been floating around.</p>



<a name="277122584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277122584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277122584">(Mar 30 2022 at 10:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/277089853">said</a>:</p>
<blockquote>
<p>tbh this is why I have invested so much effort into portable SIMD on Rust. people should not be this eager to make crazy specialization stuff happen, there should be obvious fast impls.</p>
</blockquote>
<p>I think people will always be eager regardless. "Find the optimal way to combine these two standards container types to improve performance" is the kind of stuff that scratches people's optimization itch.</p>



<a name="277122640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277122640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277122640">(Mar 30 2022 at 10:22)</a>:</h4>
<p>If you add better SIMD, you just give them more opportunity to optimize.</p>



<a name="277137181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277137181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277137181">(Mar 30 2022 at 12:37)</a>:</h4>
<p>YESSSSS IT LANDED</p>
<p>ok i will properly post a public announcement for this when it hits nightly and I can link the docs</p>



<a name="277137939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277137939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277137939">(Mar 30 2022 at 12:44)</a>:</h4>
<p>Nice.</p>



<a name="277197114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277197114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277197114">(Mar 30 2022 at 19:52)</a>:</h4>
<p>there is now a label for strict-provenance-related issues: <a href="https://github.com/rust-lang/rust/labels/A-strict-provenance">https://github.com/rust-lang/rust/labels/A-strict-provenance</a></p>



<a name="277203650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277203650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277203650">(Mar 30 2022 at 21:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes/near/277122640">said</a>:</p>
<blockquote>
<p>If you add better SIMD, you just give them more opportunity to optimize.</p>
</blockquote>
<p>This is actually false, but for a non-intuitive reason:</p>
<p>Explicit SIMD gets lowered into machine operations that can actually fully saturate an individual core's functionality, leaving essentially no slack to pick up in other ways.</p>



<a name="277204076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277204076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277204076">(Mar 30 2022 at 21:07)</a>:</h4>
<p>The point is to make it so that if you really need to optimize, that the only thing left will largely be to find ways to actually operate on <strong>less data</strong>, and once you have finished removing steps where your program processes unnecessary data, you are done. There is nothing to take away or add.</p>



<a name="277204320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277204320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277204320">(Mar 30 2022 at 21:10)</a>:</h4>
<p>In actuality we have small bubbles of variation because the SIMD operations are expressed largely in terms of the Rust Abstract Machine, with an imperfect mapping to the real ISA, much less real execution units. However, many of these are due to direct failings of the LLVM codegen backend which thus require ornate workarounds in C++ code as well.</p>



<a name="277206572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277206572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277206572">(Mar 30 2022 at 21:30)</a>:</h4>
<p>(announcement stuff prepped, just gotta wait for the nightly....)</p>



<a name="277222037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20std%20compat%20notes/near/277222037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20std.20compat.20notes.html#277222037">(Mar 31 2022 at 01:12)</a>:</h4>
<p>threadddd <a href="https://twitter.com/Gankra_/status/1509335163045650436?s=20&amp;t=g1UCHrBNwblJOHhFYnf9vQ">https://twitter.com/Gankra_/status/1509335163045650436?s=20&amp;t=g1UCHrBNwblJOHhFYnf9vQ</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/Gankra_/status/1509335163045650436?s=20&amp;t=g1UCHrBNwblJOHhFYnf9vQ"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/37663fd2872232bfa24553d81b8b079cdd79fc11/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313233373135353532323631343336363230382f6c68686b554158395f6e6f726d616c2e6a7067"></a><p>OK DON'T PANIC BUT I JUST REWROTE RUST'S MEMORY MODEL AND NOW ALL CODE IS UNDEFINED AND NEEDS TO BE FIXED RIGHT AWAY

...ok no, I didn't, but the Strict Provenance experiment just hit nightly and is VERY IMPORTANT and I have SO MUCH to say about it!!

<a href="https://t.co/JUS0pyv0ad">https://github.com/rust-lang/rust/issues/95228</a></p><span>- Aria the Cat (@Gankra_)</span></div></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>