<html>
<head><meta charset="utf-8"><title>Intrusive Linked Lists in SB · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html">Intrusive Linked Lists in SB</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276533479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276533479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276533479">(Mar 24 2022 at 20:14)</a>:</h4>
<p>So I've seen a number of times the claim that intrusive linked lists are not possible in SB. This is not true: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=a4a0782783f1130be1e59fe15872e0b9">playground</a></p>
<p>That passes MIRI with tagged raw pointers (and other hard mode flags) without issues. This is not restricted to linked lists either. You can put the edges of the graph into much more complicated shapes too, it all doesn't matter.</p>
<p>The fundamental reason this works (and the biggest restriction for it) is that all the pointers stored in the linked list that point to the same node are the same, ie they have the same provenance. This is possible (and easy) to do in SB because pointers are not retagged on move. If you have a pointer, you can just write it into two places and the provenance of the pointers in those places is the same. In this sense, there is a "master pointer" to each node, which must not be invalidated as long as the node is in the linked list. A good choice for such a master pointer if the node is allocated on the heap is the pointer returned by the allocator - that cannot be invalidated without freeing the allocation. If the node is in the stack, we need to create the pointer from the local once and then not use the local directly again (except through the pointer).</p>
<p>The playground includes lots of examples of things that work. The one thing that won't work is any pattern that does this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">curr</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">curr_ptr</span><span class="p">;</span><span class="w"></span>
<span class="n">other_node</span><span class="p">.</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>The reason is that now, the <code>other_node.prev</code> pointer is <em>not</em> the master pointer that we stored before, but rather another pointer that is derived from <code>curr</code>. That's no good, and will cause us SB errors as soon as <code>curr</code> gets invalidated.</p>



<a name="276534900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276534900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276534900">(Mar 24 2022 at 20:27)</a>:</h4>
<p>The particular way you have written this example does not really show an intrusive list, just a regular single-item-per-node linked list. This /is/ adaptable into a proper intrusive list (ie, ability to be on multiple lists while having the list operations encapsulated), but the encapsulation causes hassle with the currently available syntax (brb, writing it up)</p>



<a name="276535106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276535106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276535106">(Mar 24 2022 at 20:29)</a>:</h4>
<p>I agree with the syntax issue, but would like to keep that out of this thread if at all possible. <span class="user-mention" data-user-id="137587">@Gankra</span>  has brought up some suggestions for how to address this, and it's in general no secret that <code>addr_of</code> and friends are not user friendly. The point here isn't to show that it's easy to write - even my example may be unintuitive. The point is to show that it's <em>possible</em></p>



<a name="276535265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276535265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276535265">(Mar 24 2022 at 20:30)</a>:</h4>
<p>"How (if at all) can we change syntax/ergonomics problems to make SB less of a pain to work with?" does sound like a good topic for another thread though</p>



<a name="276535362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276535362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276535362">(Mar 24 2022 at 20:31)</a>:</h4>
<p>yes, my bigger point is that your intrusive list example should still be an actual intrusive list</p>



<a name="276535800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276535800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276535800">(Mar 24 2022 at 20:34)</a>:</h4>
<p>huh? I thought this was an intrusive list, and that a non-intrusive one uses an abstraction like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">next</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">prev</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Data</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276535928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276535928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276535928">(Mar 24 2022 at 20:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276535800">said</a>:</p>
<blockquote>
<p>huh? I thought this was an intrusive list, and that a non-intrusive one uses an abstraction like</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">next</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">prev</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Data</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Well, you can make it "more" intrusive by having</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">next</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">prev</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">list_1</span>: <span class="nc">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">list_2</span>: <span class="nc">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>or something like that</p>



<a name="276536098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276536098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276536098">(Mar 24 2022 at 20:36)</a>:</h4>
<p>But I'm going to call this covered under the points "this pattern isn't restricted to a linked list, you can have the edges in more complicated shapes" and "nothing cares if you put some data in a struct or code in a function"</p>



<a name="276536339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276536339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276536339">(Mar 24 2022 at 20:38)</a>:</h4>
<p>If you do add stuff to a function though, keep in mind that you cannot implement this interface for reasons discussed above:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">add_to_list</span><span class="p">(</span><span class="n">new_node</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">next</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="276536378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276536378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276536378">(Mar 24 2022 at 20:38)</a>:</h4>
<p>(yes, this does pose ergonomics issues - discuss elsewhere)</p>



<a name="276536557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276536557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276536557">(Mar 24 2022 at 20:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276535800">said</a>:</p>
<blockquote>
<p>huh? I thought this was an intrusive list, and that a non-intrusive one uses an abstraction like</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Node</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">next</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">prev</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Data</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>that's like a non-intrusive list in java where everything is a pointer. The relevant part is that a direct translation to a generic version of this would be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">next</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">prev</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">data</span>: <span class="nc">T</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>ie the data is owned by the Node, not the other way around</p>



<a name="276536652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276536652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276536652">(Mar 24 2022 at 20:41)</a>:</h4>
<p>Yeah, wanting to avoid forcing the <code>Node</code> type to own <code>data</code> is completely fair</p>



<a name="276537162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276537162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276537162">(Mar 24 2022 at 20:45)</a>:</h4>
<p>Actually, interestingly, this type of pattern is one that is liable to be broken by not tagging raw pointers. None of the code I wrote runs into this, but "accidentally reborrowed too high up the stack" is a super easy problem to run into here</p>



<a name="276537415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276537415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276537415">(Mar 24 2022 at 20:48)</a>:</h4>
<p>I think the "reborrowed too high up in the stack" is just one aspect of the deeper problem with SB without raw pointer tagging</p>



<a name="276539974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276539974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276539974">(Mar 24 2022 at 21:10)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=e44fd33f6d63fc1109c7bb3966ccc3e2">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=e44fd33f6d63fc1109c7bb3966ccc3e2</a> is what I'd use as an example without CRTP+traits, to clarify that reasonable encapsulation and actual intrusiveness is possible</p>



<a name="276543164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276543164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276543164">(Mar 24 2022 at 21:42)</a>:</h4>
<p>I wrote <a href="https://gist.github.com/Darksonn/1567538f56af1a8038ecc3c664a42462">this page</a> on intrusive lists last year, and for the use cases discussed there it really is not possible to do it correctly under SB. The primary difference is that we cannot prevent the user from taking a new mutable reference to the stack location, invalidating the old raw pointers.</p>



<a name="276543265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276543265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276543265">(Mar 24 2022 at 21:43)</a>:</h4>
<p>and <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=ee8e6d59bd7941f93284c05a926938f6">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=ee8e6d59bd7941f93284c05a926938f6</a> is the nice looking CRTPish one</p>



<a name="276543725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276543725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276543725">(Mar 24 2022 at 21:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276543164">said</a>:</p>
<blockquote>
<p>I wrote <a href="https://gist.github.com/Darksonn/1567538f56af1a8038ecc3c664a42462">this page</a> on intrusive lists last year, and for the use cases discussed there it really is not possible to do it correctly under SB. The primary difference is that we cannot prevent the user from taking a new mutable reference to the stack location, invalidating the old raw pointers.</p>
</blockquote>
<p>Why can't you prevent this? Can't you shadow the local the same way <code>pin_mut!</code> does and I do in the example?</p>



<a name="276544384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276544384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276544384">(Mar 24 2022 at 21:55)</a>:</h4>
<p>Well, in the most common situation, the intrusive list is inside a Future. The only pointers you have access to are those the user passes to <code>poll</code>, but since that's a reference, they are invalidated on the next poll (or on drop)</p>



<a name="276544446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276544446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276544446">(Mar 24 2022 at 21:55)</a>:</h4>
<p>and Pin::map_unchecked_mut/etc probably are narrowing provenance as well</p>



<a name="276544518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276544518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276544518">(Mar 24 2022 at 21:56)</a>:</h4>
<p>(though whether or not narrowing spatially is a problem depends)</p>



<a name="276544595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276544595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276544595">(Mar 24 2022 at 21:57)</a>:</h4>
<p>I mean, the mutable reference itself would be invalidated on the next call, so it doesn't matter how you derive your raw pointers from it</p>



<a name="276545671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276545671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276545671">(Mar 24 2022 at 22:06)</a>:</h4>
<p>So it's not exactly that rust is completely unable to represent them, but that future/poll APIs use references which make it impossible?<br>
Could that be more of a problem with those specific APIs than with the language semantics? Like the Read trait not letting you read into an uninit buffer<br>
Would it help at all if there was a raw pointer poll version that didn't assert uniqueness and/or narrow provenance?</p>



<a name="276546013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276546013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276546013">(Mar 24 2022 at 22:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276544384">said</a>:</p>
<blockquote>
<p>Well, in the most common situation, the intrusive list is inside a Future. The only pointers you have access to are those the user passes to <code>poll</code>, but since that's a reference, they are invalidated on the next poll (or on drop)</p>
</blockquote>
<p>Ah. To be honest, that sounds like it might be more of a problem with the generator stuff in general than anything else</p>



<a name="276546166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276546166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276546166">(Mar 24 2022 at 22:11)</a>:</h4>
<p>Whenever we do decide on a fix, I think supporting use cases like this is a good thing to keep in mind</p>



<a name="276547272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276547272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276547272">(Mar 24 2022 at 22:23)</a>:</h4>
<p>What if you replace <em>all</em> occurrences of <code>&amp;mut _</code> with <code>&amp;Cell&lt;_&gt;</code>? Don't go through any mutable references, go straight from <code>*mut</code> to <code>&amp;Cell</code>.   This isn't possible in all interfaces—in particular not for Futures—but it does sound possible if one were to invent a new linked-list from scratch. And iirc then a reference-to-cell alone will not invalidate the SharedRW provenance of any of the other pointers, nor get invalidated if you copy any of the other sharedRW provenance (or use them for <code>write</code> or <code>read</code> operations). Just never create a unique references.</p>



<a name="276547652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276547652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276547652">(Mar 24 2022 at 22:28)</a>:</h4>
<p>I've been lamenting the lack of standard library goodies for <code>&amp;Cell</code> elsewhere. It should feel more native. For example, <code>&amp;mut [_]</code> gets <code>copy_from_slice</code>, <code>copy_within</code> and other utilities. There should be similar methods offered on <code>&amp;Cell</code>, imho. Many only make use of the writeability, not uniqueness. There's an explainable lack of prior-art of course but using <code>Cell</code> is better than unsound code—sadly this isn't incentivized due to the lack of (safe) utilities for <code>Cell</code>/<code>UnsafeCell</code>.</p>



<a name="276548616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276548616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276548616">(Mar 24 2022 at 22:41)</a>:</h4>
<p>you can't split <code>&amp;Cell&lt;(A, B)&gt;</code> into <code>(&amp;Cell&lt;A&gt;, &amp;Cell&lt;B&gt;)</code> (such a function should be safe though I think?) Though yes, a lot of intrusive list uses would probably be using &amp; for any top-level access and then various Cell types for any mutation</p>



<a name="276549958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276549958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276549958">(Mar 24 2022 at 22:57)</a>:</h4>
<p>Yes, that split should be sound as far as I'm aware of SB. Count it towards the missing utilities, only this one can't even be emulated by <code>as_slice_of_cells</code> and reverse.</p>



<a name="276551215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276551215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276551215">(Mar 24 2022 at 23:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219940">Nick12</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276545671">said</a>:</p>
<blockquote>
<p>So it's not exactly that rust is completely unable to represent them, but that future/poll APIs use references which make it impossible?<br>
Could that be more of a problem with those specific APIs than with the language semantics? Like the Read trait not letting you read into an uninit buffer<br>
Would it help at all if there was a raw pointer poll version that didn't assert uniqueness and/or narrow provenance?</p>
</blockquote>
<p>I don't think that would help because all Future implementors are (AIUI) in a shared ecosystem and must all interoperate. It's not... clear how you could define a "new" "lower level" API under that</p>



<a name="276680686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276680686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276680686">(Mar 25 2022 at 21:25)</a>:</h4>
<p>To be clear, the interface of the Future trait is not the only reason it is not really possible for futures. Another issue comes up when you require all stack-allocated nodes to be defined using your own fancy macro so your macro can create a "root" reference and prevent the user from creating new references in the future. The issue there is that you can no longer "compose" these kinds of types together, similar to how there are various combinators for futures and streams, since now the macro would be used on the full struct and not the field.</p>
<p>Maybe you can get around it by requiring that all such combinators access the field only with the <code>addr_of!</code> macro and other such hackery, but it gets a lot more complicated than pin-projection is today.</p>
<p>Another potential issue is that when the destructor runs, it will create a new reference to the variable, invalidating the old one. Though you can probably get around that by putting the destructor on a wrapper struct around the reference rather than on the struct itself.</p>



<a name="276681579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276681579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276681579">(Mar 25 2022 at 21:36)</a>:</h4>
<p>Hmm, I'm sort of tempted to go and write a library for semi-safe intrusive linked lists. It might make this conversation easier to have in a concrete way</p>



<a name="276681986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276681986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276681986">(Mar 25 2022 at 21:38)</a>:</h4>
<p>The real problem with it though isn't the safe interface for stack allocated stuff, but for heap allocated stuff. You somehow have to know when to free it... Brinstorming time ig</p>



<a name="276682494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276682494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276682494">(Mar 25 2022 at 21:43)</a>:</h4>
<p>If you can heap allocate all the nodes, then it's "easy" to do intrusive lists. Just make sure that all pointers you store long-term are derived from the original pointer you got from malloc without going through any references.</p>



<a name="276685063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276685063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276685063">(Mar 25 2022 at 22:06)</a>:</h4>
<p><a href="https://docs.rs/intrusive-collections/0.9.3/intrusive_collections/">This</a> exists, but it's sort of very unsound under <code>-Zmiri-tag-raw-pointers</code>. This is also not fixable for that crate as far as I can tell, because the "scoped collections" example on that page just cannot be made to work</p>



<a name="276686485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276686485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sabrina Jewson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276686485">(Mar 25 2022 at 22:19)</a>:</h4>
<p>I made <a href="https://docs.rs/pinned-aliasable">the pinned-aliasable</a> crate a while back which was intended to help with this situation. Your code would be unsound but wouldn't miscompile as long as Miri passes.</p>



<a name="276687310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276687310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276687310">(Mar 25 2022 at 22:28)</a>:</h4>
<blockquote>
<p>There is one final snag: Miri. Miri is a tool for running your Rust code and dynamically checking whether it is sound or not. If we used the main implementation of this crate under Miri, it would report all kinds of errors, because what we are doing is fundamentally unsound after all. So instead, when this crate detects that Miri is enabled it switches to a different backend that boxes the value in a way that is totally sound, but isn’t used normally for efficiency reasons.</p>
</blockquote>
<p>lol<br>
aside: I thought <a href="https://github.com/rust-lang/miri/pull/1952">https://github.com/rust-lang/miri/pull/1952</a> "fixed" that?</p>



<a name="276687720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276687720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276687720">(Mar 25 2022 at 22:34)</a>:</h4>
<p>How is this</p>
<blockquote>
<p>Your code would be unsound but wouldn't miscompile as long as Miri passes.</p>
</blockquote>
<p>possibly correct then? If you're doing a lot of cfg(miri) stuff, Miri passing doesn't mean anything.</p>



<a name="276687853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276687853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276687853">(Mar 25 2022 at 22:36)</a>:</h4>
<p>"it's not actually unsound by the patched rustc spec"</p>



<a name="276687880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276687880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276687880">(Mar 25 2022 at 22:36)</a>:</h4>
<p>(but that would be before that miri pull was done)</p>



<a name="276687912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276687912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276687912">(Mar 25 2022 at 22:37)</a>:</h4>
<p>Also I think it's possible the assumption of "&amp;mut Aliasable&lt;T&gt; can alias &amp;mut T" might be wrong</p>
<p>To quote RalfJ from that PR:</p>
<blockquote>
<blockquote>
<p>But can an &amp;Aliasable or &amp;mut Aliasable coexist with an &amp;mut T (or to a field of T)?</p>
</blockquote>
<p>&amp;mut T (with this patch: for T: Unpin) cannot coexist with anything (assuming both pointers are being used). Weakening that guarantee would make it entirely useless for optimizations.</p>
<p>But &amp;mut T can be reborrowed from &amp;mut Aliasable&lt;T&gt;, as long as for the time that the &amp;mut T is active, no other reference/pointer to that memory is used.</p>
</blockquote>



<a name="276688331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276688331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276688331">(Mar 25 2022 at 22:42)</a>:</h4>
<p>on a related note I was recently surprised to learn that miri has somehow found a way to semantically use ptr::Unique? Does anyone have a good resource for what it's interpretation is? I added it to std as a vague idea, and my coworker was asking what it did over NonNull and all I could do was shrug.</p>



<a name="276688420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276688420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276688420">(Mar 25 2022 at 22:43)</a>:</h4>
<p>(seemingly if you take a ref to the pointee it would have the same semantics as if it was a raw pointer)</p>



<a name="276688866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276688866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276688866">(Mar 25 2022 at 22:49)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I meant to ask this at the time you posted it, but never got around to it. Are you able to elaborate on what exactly you mean in the text that <span class="user-mention" data-user-id="219940">@Nick12</span> quoted?</p>



<a name="276692005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276692005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276692005">(Mar 25 2022 at 23:37)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> Skimming code I could only find this FIXME: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_middle/src/ty/layout.rs#L2569-L2576">https://github.com/rust-lang/rust/blob/master/compiler/rustc_middle/src/ty/layout.rs#L2569-L2576</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                </span><span class="c1">// FIXME(eddyb) This should be for `ptr::Unique&lt;T&gt;`, not `Box&lt;T&gt;`.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pointee</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span>::<span class="n">Adt</span><span class="p">(</span><span class="n">def</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">ty</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="n">def</span><span class="p">.</span><span class="n">is_box</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">offset</span><span class="p">.</span><span class="n">bytes</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">pointee</span><span class="p">.</span><span class="n">safe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">PointerKind</span>::<span class="n">UniqueOwned</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But I can give you this RalfJ quote from 2020 <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/258">https://github.com/rust-lang/unsafe-code-guidelines/issues/258</a></p>
<blockquote>
<blockquote>
<p>I don't believe Stacked Borrows special cases Unique</p>
</blockquote>
<p>Indeed it does not. That is an extension I hope I will be able to support eventually, and at that point I think Box will not be special-cased any more, but Unique will. Though as you said Unique does not imply dereferencable so Box probably still needs to be special-cased a bit.</p>
</blockquote>



<a name="276692317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276692317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276692317">(Mar 25 2022 at 23:42)</a>:</h4>
<p>Is it just Dereferenceable?</p>



<a name="276693055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276693055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276693055">(Mar 25 2022 at 23:55)</a>:</h4>
<p>I think it's supposed to be noalias</p>



<a name="276693557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276693557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276693557">(Mar 26 2022 at 00:02)</a>:</h4>
<p>I'm pretty sure Box gets noalias but if someone could point out the code where that happens, would be very cool</p>



<a name="276693563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276693563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276693563">(Mar 26 2022 at 00:02)</a>:</h4>
<p>But also, I have no idea why</p>



<a name="276693820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276693820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276693820">(Mar 26 2022 at 00:08)</a>:</h4>
<p>the <code>PointerKind::UniqueOwned</code> above is what make it <code>noalias</code></p>



<a name="276693860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276693860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276693860">(Mar 26 2022 at 00:09)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/d53246fedde4c193eae8a003546a8f0f9f85d223/compiler/rustc_middle/src/ty/layout.rs#L3120-L3124">https://github.com/rust-lang/rust/blob/d53246fedde4c193eae8a003546a8f0f9f85d223/compiler/rustc_middle/src/ty/layout.rs#L3120-L3124</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">no_alias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">PointerKind</span>::<span class="n">Shared</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PointerKind</span>::<span class="n">UniqueBorrowed</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">PointerKind</span>::<span class="n">UniqueOwned</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">PointerKind</span>::<span class="n">Frozen</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="n">is_return</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="276694885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276694885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276694885">(Mar 26 2022 at 00:27)</a>:</h4>
<p>is the implication basically "if you want to hold onto raw pointers to this you  must Box::into_raw first?". because having a noalias pointer has no practical consequences if you're taking shared/mutable refs to the pointee, right? because they essentially introduce that same claim?</p>



<a name="276695064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695064">(Mar 26 2022 at 00:30)</a>:</h4>
<p>it <em>feels</em> like that's just already true because Deref is the only API to access the pointee of a Box (DerefMove magic aside), and that's defined in terms of references, so there's no way to go through the Box pointer without accidentally claiming noalias and invalidating everything pointing into it?</p>



<a name="276695082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695082">(Mar 26 2022 at 00:31)</a>:</h4>
<p>So tbh this kinda just feels like Dereferencable is the only practical implication, idk</p>



<a name="276695296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695296">(Mar 26 2022 at 00:36)</a>:</h4>
<p>The implication is that if you move a Box, you invalidate all pointers into it</p>



<a name="276695362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695362">(Mar 26 2022 at 00:37)</a>:</h4>
<p>&amp;mut technically has the same behavior, but people want to treat Box as a stable pointer to an allocation, but that's at least a dangerously misleading characterization under SB</p>



<a name="276695422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695422">(Mar 26 2022 at 00:38)</a>:</h4>
<p>HUH</p>



<a name="276695431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695431">(Mar 26 2022 at 00:38)</a>:</h4>
<p>Well, under SB with this bizarre addition</p>



<a name="276695446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695446">(Mar 26 2022 at 00:39)</a>:</h4>
<p>I guess that technically has to be true for move semantics to be coherent since it can result in a Drop you can't see</p>



<a name="276695462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695462">(Mar 26 2022 at 00:39)</a>:</h4>
<p>no it doesn't</p>



<a name="276695476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695476">(Mar 26 2022 at 00:39)</a>:</h4>
<p>You can write an owning pointer that does not have this property</p>



<a name="276695483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695483">(Mar 26 2022 at 00:40)</a>:</h4>
<p>If you try to implement your own Box, that's what you get</p>



<a name="276695577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695577">(Mar 26 2022 at 00:40)</a>:</h4>
<p>The standard library just chooses to provide a more dangerous tool</p>



<a name="276695854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276695854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276695854">(Mar 26 2022 at 00:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276695064">said</a>:</p>
<blockquote>
<p>it <em>feels</em> like that's just already true because Deref is the only API to access the pointee of a Box (DerefMove magic aside), and that's defined in terms of references, so there's no way to go through the Box pointer without accidentally claiming noalias and invalidating everything pointing into it?</p>
</blockquote>
<p>This certainly calls into question whether or not that decision was worthwhile, tbh, since this makes sense to me.</p>



<a name="276696002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276696002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276696002">(Mar 26 2022 at 00:50)</a>:</h4>
<p>I really do not think that Box aliasing optimizations are valuable. Wouldn't mind being proven wrong. But I would grumble mightily if someone checked in code that used Box on an interface boundary instead of &amp; or &amp;mut.</p>



<a name="276696052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276696052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276696052">(Mar 26 2022 at 00:51)</a>:</h4>
<p>If it is, I want examples of it being impactful added to my wishlist of motivating examples for SB.</p>



<a name="276696873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276696873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276696873">(Mar 26 2022 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276695064">said</a>:</p>
<blockquote>
<p>it <em>feels</em> like that's just already true because Deref is the only API to access the pointee of a Box (DerefMove magic aside), and that's defined in terms of references, so there's no way to go through the Box pointer without accidentally claiming noalias and invalidating everything pointing into it?</p>
</blockquote>
<p>But does LLVM know all that, if we don't mark the box pointer <code>noalias</code>?</p>



<a name="276696949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276696949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276696949">(Mar 26 2022 at 01:10)</a>:</h4>
<p>The docs on <code>PointerKind::UniqueOwned</code> specifically mention returns, and LLVM says this:</p>
<blockquote>
<p>For function return values, C99’s restrict is not meaningful, while LLVM’s noalias is. Furthermore, the semantics of the noalias attribute on return values are stronger than the semantics of the attribute when used on function arguments. On function return values, the noalias attribute indicates that the function acts like a system memory allocation function, returning a pointer to allocated storage disjoint from the storage for any other object accessible to the caller.</p>
</blockquote>



<a name="276696950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276696950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276696950">(Mar 26 2022 at 01:10)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">addr_of</span><span class="o">!</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>appears to not invoke Deref, so in that sense you can dodge &amp;T. (Though this is sorta a variant of DerefMove magic)</p>



<a name="276696952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276696952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276696952">(Mar 26 2022 at 01:10)</a>:</h4>
<p>i am thinking in terms of Stacked Borrows here and not llvm</p>



<a name="276697021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697021">(Mar 26 2022 at 01:12)</a>:</h4>
<p>ok -- if you answer that in SB, does that produce the same actionable knowledge for LLVM?</p>



<a name="276697116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697116">(Mar 26 2022 at 01:14)</a>:</h4>
<p>barring llvm bugs, all references should be noalias, right?</p>



<a name="276697139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697139">(Mar 26 2022 at 01:15)</a>:</h4>
<p>except for interior mutability, i.e. references to <code>!Freeze</code> types</p>



<a name="276697212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697212">(Mar 26 2022 at 01:16)</a>:</h4>
<p>but <code>Box</code> is not a reference, so I don't really understand you</p>



<a name="276697304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697304">(Mar 26 2022 at 01:18)</a>:</h4>
<p>IIUC <code>noalias</code> mostly pertains to accesses, and to access the data in the box, you have to go through &amp;T or &amp;mut T, which are references, no?</p>



<a name="276697321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697321">(Mar 26 2022 at 01:19)</a>:</h4>
<p>Sort of like we're applying noalias at the last minute</p>



<a name="276697324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697324">(Mar 26 2022 at 01:19)</a>:</h4>
<p>But perhaps thats not how it happens.</p>



<a name="276697415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697415">(Mar 26 2022 at 01:21)</a>:</h4>
<p>I am saying that if you have &amp;mut MyBox&lt;T&gt; and do my_box.val = 0, then you went through DerefMut, which made an &amp;mut T and therefore did a mega aliasing/derefencability assert for llvm</p>



<a name="276697474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697474">(Mar 26 2022 at 01:22)</a>:</h4>
<p>If we ignore DerefMove magic then this is also definitely true for by-val box</p>



<a name="276697916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276697916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276697916">(Mar 26 2022 at 01:32)</a>:</h4>
<p>I copied the aliasable box from <a href="https://crates.io/crates/aliasable">https://crates.io/crates/aliasable</a> and wrote a dumb test function in godbolt: <a href="https://godbolt.org/z/jfEYTa8rc">https://godbolt.org/z/jfEYTa8rc</a><br>
It looks like the std box gets optimizations the other one doesn't, but I don't really know if this is because of some <em>other</em> attribute than noalias that is lost or if it's just that llvm can't figure it out despite the optimization being technically allowed</p>



<a name="276698342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276698342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276698342">(Mar 26 2022 at 01:43)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> that's not quite right; <code>noalias</code> is something that goes on function arguments. As far as I know we don't emit any aliasing metadata for references created inside the function body</p>



<a name="276698511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276698511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276698511">(Mar 26 2022 at 01:47)</a>:</h4>
<p>Also, under SB without the Unique rule</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">a</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is allowed to alias</p>



<a name="276698673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276698673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276698673">(Mar 26 2022 at 01:51)</a>:</h4>
<p>Those are both good academic examples, but I would reject Nick's in code review and the replacement has only one <code>Box</code> on the interface, and thus all the aliasing is stipulated by <code>&amp;mut</code>.</p>



<a name="276698728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276698728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276698728">(Mar 26 2022 at 01:52)</a>:</h4>
<blockquote>
<p>allowed to alias</p>
</blockquote>
<p>Because even if the deref created a &amp;mut, the tag for the Box ptr and the <code>b</code> ptr are the same? And obviously creating a &amp;mut from the box ptr doesn't invalidate it's tag/provenance</p>



<a name="276698794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276698794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276698794">(Mar 26 2022 at 01:54)</a>:</h4>
<p>Nick - yes</p>



<a name="276698857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276698857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276698857">(Mar 26 2022 at 01:56)</a>:</h4>
<p>Saethlin - I agree, this doesn't on its own justify a need for this rule. I was just making the point that deref doesn't make this redundant</p>



<a name="276701051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701051">(Mar 26 2022 at 02:47)</a>:</h4>
<p>great example, thanks!</p>



<a name="276701053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701053">(Mar 26 2022 at 02:47)</a>:</h4>
<p>hmm actually wait</p>



<a name="276701099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701099">(Mar 26 2022 at 02:48)</a>:</h4>
<p>kinda unclear how it's possible to get a *mut into a Box without having introduced an intermediary ref</p>



<a name="276701104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701104">(Mar 26 2022 at 02:48)</a>:</h4>
<p>I guess with some into_raw shenanigans?</p>



<a name="276701105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701105">(Mar 26 2022 at 02:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276701099">said</a>:</p>
<blockquote>
<p>kinda unclear how it's possible to get a *mut into a Box without having introduced an intermediary ref</p>
</blockquote>
<p><code>Box::from_raw</code></p>



<a name="276701117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701117">(Mar 26 2022 at 02:49)</a>:</h4>
<p>yeah</p>



<a name="276701119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701119">(Mar 26 2022 at 02:49)</a>:</h4>
<p><em>mildly</em> contrived but doable</p>



<a name="276701171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701171">(Mar 26 2022 at 02:50)</a>:</h4>
<p>Well, yes, but optimizations can't distinguish between contrived and non-contrived code</p>



<a name="276701176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701176">(Mar 26 2022 at 02:50)</a>:</h4>
<p>The options are only "UB" or "not UB"</p>



<a name="276701572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701572">(Mar 26 2022 at 03:01)</a>:</h4>
<p>totally, and we should be airtight, but also I'm willing to recognize a difference between "this can technically happen but is unlikely in practice" and "this happens all the time"</p>



<a name="276701576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276701576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276701576">(Mar 26 2022 at 03:01)</a>:</h4>
<p>(a lot of std safety is sadly the former...)</p>



<a name="276733857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276733857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276733857">(Mar 26 2022 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB/near/276688866">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> I meant to ask this at the time you posted it, but never got around to it. Are you able to elaborate on what exactly you mean in the text that <span class="user-mention silent" data-user-id="219940">Nick12</span> quoted?</p>
</blockquote>
<p>basically in code like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">uwu</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>we have UB if <code>x</code> and <code>y</code> alias. this is <em>despite</em> the fact that "raw pointer are allowed to alias". yes they are, but mutable references are not, and when two pointers are used to access overlapping regions of memory <em>both</em> have to consent for that to be legal.<br>
the situation is similar with <code>fn owo(x: &amp;mut u8, y: &amp;mut Aliasable&lt;u8&gt;)</code>.</p>



<a name="276734019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive%20Linked%20Lists%20in%20SB/near/276734019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Intrusive.20Linked.20Lists.20in.20SB.html#276734019">(Mar 26 2022 at 16:32)</a>:</h4>
<p>but it is totally fine to do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">uwu</span><span class="p">(</span><span class="n">y</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">y</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>since yes they alias but "while <code>x</code> lives, no other pointer to this memory is used". that is what I meant with the last part of my statement, "as long as for the time that the &amp;mut T is active, no other reference/pointer to that memory is used".</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>