<html>
<head><meta charset="utf-8"><title>`std::mem::transmute` from `*const Dst` to `*const Wrappe... · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E.html">`std::mem::transmute` from `*const Dst` to `*const Wrappe...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253029830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60std%3A%3Amem%3A%3Atransmute%60%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrappe.../near/253029830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E.html#253029830">(Sep 13 2021 at 02:39)</a>:</h4>
<p>I wouldn't use transmute directly for pointers, though.</p>



<a name="253035585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60std%3A%3Amem%3A%3Atransmute%60%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrappe.../near/253035585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E.html#253035585">(Sep 13 2021 at 04:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138909">matt1992</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E/near/253028519">said</a>:</p>
<blockquote>
<p>Is transmuting from <code>*const Dst</code> to <code>*const Wrapper&lt;Dst&gt;</code> sound?</p>
</blockquote>
<p>Yes. They would have the same metadata. See <a href="https://doc.rust-lang.org/std/ptr/trait.Pointee.html">https://doc.rust-lang.org/std/ptr/trait.Pointee.html</a>:</p>
<blockquote>
<p>For structs whose last field is a DST, metadata is the metadata for the last field</p>
</blockquote>
<p>Although ptr_metadata is not yet stable, I doubt this rule will change.</p>



<a name="253038222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60std%3A%3Amem%3A%3Atransmute%60%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrappe.../near/253038222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E.html#253038222">(Sep 13 2021 at 05:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E/near/253035585">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="138909">matt1992</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.60std.3A.3Amem.3A.3Atransmute.60.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrappe.2E.2E.2E/near/253028519">said</a>:</p>
<blockquote>
<p>Is transmuting from <code>*const Dst</code> to <code>*const Wrapper&lt;Dst&gt;</code> sound?</p>
</blockquote>
<p>Yes. They would have the same metadata. See <a href="https://doc.rust-lang.org/std/ptr/trait.Pointee.html">https://doc.rust-lang.org/std/ptr/trait.Pointee.html</a>:</p>
<blockquote>
<p>For structs whose last field is a DST, metadata is the metadata for the last field</p>
</blockquote>
<p>Although ptr_metadata is not yet stable, I doubt this rule will change.</p>
</blockquote>
<p>The is the metadata being the same, it doesn't guarantee that the metadata and the data pointer are laid out the same in the fat pointer though.</p>
<p><code>*const Wrapper&lt;str&gt;</code>: <code>#[repr(C)] struct{data: *const (), metadata: usize}</code><br>
<code>*const str</code>: <code>#[repr(C)] struct{metadata: usize, data: *const ()}</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>