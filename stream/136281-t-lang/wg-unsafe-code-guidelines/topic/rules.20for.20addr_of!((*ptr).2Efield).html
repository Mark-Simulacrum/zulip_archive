<html>
<head><meta charset="utf-8"><title>rules for addr_of!((*ptr).field) · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html">rules for addr_of!((*ptr).field)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272968114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272968114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272968114">(Feb 23 2022 at 15:57)</a>:</h4>
<p>yeah that has nothing to do with the previous topic so I split it :)</p>



<a name="272969741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272969741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272969741">(Feb 23 2022 at 16:06)</a>:</h4>
<p><span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span>  I am of the strong opinion that the behavior of a compound expression should be fully determined by its constituent expressions. in this case, given a value expression <code>ptr</code>, we have 3 pieces:</p>
<ul>
<li>the place expression <code>*ptr</code></li>
<li>the (place) field projection <code>_ .field</code></li>
<li>the (value) expression <code>addr_of!(_)</code></li>
</ul>
<p>the current rule for the first step, <code>*ptr</code>, says that when a place is constructed from a value by means of the <code>*</code> operator, the pointer needs to be aligned and dereferencable as determined by the pointee type. we cannot know, at this point, which field will be projected to (if any) and if a load/store actually happens, so I dont see a good way to only require things "up to the point thats read".<br>
we could simply entirely remove this rule (or say that it only applies when using <code>*</code> on reference-typed values, not raw-ptr-typed values), and I would be very happy with that outcome. but then we have to change the LLVM IR that we generate.</p>



<a name="272969972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272969972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272969972">(Feb 23 2022 at 16:07)</a>:</h4>
<p>Yeah, I don't think the <code>inbounds</code> helps very much there anyway. More broadly, I think this is a large footgun that many people keep runnign into, even experienced rust users.</p>



<a name="272969995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272969995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272969995">(Feb 23 2022 at 16:07)</a>:</h4>
<p>It feels like we should do something about it.</p>



<a name="272972326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272972326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272972326">(Feb 23 2022 at 16:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/rules.20for.20addr_of!.28.28*ptr.29.2Efield.29/near/272969741">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span>  I am of the strong opinion that the behavior of a compound expression should be fully determined by its constituent expressions. in this case, given a value expression <code>ptr</code>, we have 3 pieces:</p>
<ul>
<li>the place expression <code>*ptr</code></li>
<li>the (place) field projection <code>_ .field</code></li>
<li>the (value) expression <code>addr_of!(_)</code></li>
</ul>
<p>the current rule for the first step, <code>*ptr</code>, says that when a place is constructed from a value by means of the <code>*</code> operator, the pointer needs to be aligned and dereferencable as determined by the pointee type. we cannot know, at this point, which field will be projected to (if any) and if a load/store actually happens, so I dont see a good way to only require things "up to the point thats read".<br>
we could simply entirely remove this rule (or say that it only applies when using <code>*</code> on reference-typed values, not raw-ptr-typed values), and I would be very happy with that outcome. but then we have to change the LLVM IR that we generate: <code>addr_of!((*ptr).field)</code> can no longer use <code>getelementptr inbounds</code>.</p>
</blockquote>
<p>Yeah, it also seems fairly easy to re-introduce the relevant rules on a <code>move</code>/<code>copy</code> out of the place. This way we can still keep emitting <code>aligned</code> and such on loads/stores to LLVM</p>



<a name="272978860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272978860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272978860">(Feb 23 2022 at 17:09)</a>:</h4>
<p>I think the specific case of <code>addr_of!</code> <em>could</em> be justified as just taking something that "looks like" an expression, but that is not an actual expression.</p>
<p>In other words, for the specific case of <code>addr_of!</code> we make it "even more magic" and skip the <code>inbounds</code> attribute as you say, while not changing the rules for any expression that's not within the macro.</p>



<a name="272979242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272979242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272979242">(Feb 23 2022 at 17:11)</a>:</h4>
<p>Because what people want is, as always, a way to offset from an arbitrary base pointer to a field pointer. And any answer that we come up with that doesn't just do that is a wrong answer.</p>



<a name="272990534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272990534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272990534">(Feb 23 2022 at 18:19)</a>:</h4>
<blockquote>
<p>Yeah, it also seems fairly easy to re-introduce the relevant rules on a move/copy out of the place. This way we can still keep emitting aligned and such on loads/stores to LLVM</p>
</blockquote>
<p>yes, definitely</p>



<a name="272990641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272990641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272990641">(Feb 23 2022 at 18:20)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> I really dont like magic, and I think it will be more confusing than helpful</p>



<a name="272991069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272991069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272991069">(Feb 23 2022 at 18:23)</a>:</h4>
<p>I think in practice people are more often confused that it doesn't do the thing they need it for, not that some very precise rules written down in a book they've never read have arguably been broken a bit. (but not really because the input to the macro could just <em>not actually</em> be interpreted as a real expression).</p>



<a name="272991223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272991223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272991223">(Feb 23 2022 at 18:24)</a>:</h4>
<p>I think that's a different set of people than the set we would confuse with magic :) so I think that's a bad tradeoff</p>



<a name="272991251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272991251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272991251">(Feb 23 2022 at 18:24)</a>:</h4>
<p>I'd rather make sure this behaves as expected without introducing magic</p>



<a name="272991508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272991508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272991508">(Feb 23 2022 at 18:26)</a>:</h4>
<p>That's fine too. As long as it behaves as expected in the end then I don't have any strong opinion on how it gets there.</p>



<a name="272997374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules%20for%20addr_of%21%28%28%2Aptr%29.field%29/near/272997374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/rules.20for.20addr_of!((*ptr).2Efield).html#272997374">(Feb 23 2022 at 19:12)</a>:</h4>
<p>I created an issue for centralizing discussion, and to be referenced when this is encountered again in the wild: <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/319">https://github.com/rust-lang/unsafe-code-guidelines/issues/319</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>