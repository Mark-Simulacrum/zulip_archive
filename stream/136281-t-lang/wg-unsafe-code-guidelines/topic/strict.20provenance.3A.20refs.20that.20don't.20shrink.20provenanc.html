<html>
<head><meta charset="utf-8"><title>strict provenance: refs that don&#x27;t shrink provenanc · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html">strict provenance: refs that don&#x27;t shrink provenanc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276495266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276495266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276495266">(Mar 24 2022 at 15:47)</a>:</h4>
<p>A coworker pointed out that currently in Firefox's Rust bridging to its C++ COM-based design, they play games like primarily passing around &amp;ZST and downcasting it to concrete classes. This is definitely unsound, but I was wondering if there was an established plan to allow for this kind of "reference that preserves provenance". I assume <code>&amp;extern type</code> <em>must</em> have such semantics?</p>



<a name="276498204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276498204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276498204">(Mar 24 2022 at 16:05)</a>:</h4>
<p><a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/256">https://github.com/rust-lang/unsafe-code-guidelines/issues/256</a> has a lot of discussion on this topic, if you haven't seen it.</p>



<a name="276732686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276732686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276732686">(Mar 26 2022 at 16:02)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> basically my hope is that Stacked Borrows NG will not shrink provenance to match the type, or at least do it much more controlled than current SB (e.g., only on place projections).</p>



<a name="276732896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276732896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276732896">(Mar 26 2022 at 16:07)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> is an accidental/implicit reborrow a place-projection or a noop?</p>



<a name="276733327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733327">(Mar 26 2022 at 16:17)</a>:</h4>
<p>I envision it to be neither. it is a fresh provenance but inherits the "range" of its parent.</p>



<a name="276733409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733409">(Mar 26 2022 at 16:19)</a>:</h4>
<p>ok, that's good. then the only remaining thing is if we can be "nice" and let <code>struct SubClass { base: BaseClass, .. }</code> be upcast in the natural/safe projection way or have to say "sorry do the moral equivalent of a transmute so we don't get confused"</p>



<a name="276733497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733497">(Mar 26 2022 at 16:21)</a>:</h4>
<p>so basically you are saying we shouldnt restrict the range even for projections?</p>



<a name="276733502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733502">(Mar 26 2022 at 16:21)</a>:</h4>
<p>yeah sounds reasonable</p>



<a name="276733508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733508">(Mar 26 2022 at 16:21)</a>:</h4>
<p>I still dont know if this model even works though so we'll see :D</p>



<a name="276733597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733597">(Mar 26 2022 at 16:23)</a>:</h4>
<p>i think it would be fine to restrict the range for projections, I'm just curious if the curve can be bent here</p>



<a name="276733738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733738">(Mar 26 2022 at 16:26)</a>:</h4>
<p>fwiw i was spitballing with nika a model based on some formulation of "extern types" where you can say something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[extern]</span><span class="w"></span>
<span class="n">SubClass</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cp">#[extern]</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span>: <span class="nc">BaseClass</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And what this is expressing is:</p>
<ul>
<li>on a type, *T =&gt; &amp;T does not narrow provenance range</li>
<li>on a field, a projection from the parent type to that field does not narrow provenance range</li>
<li>it is a compile error for a #[extern] field to <em>NOT</em> be an #[extern] type</li>
</ul>



<a name="276733750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733750">(Mar 26 2022 at 16:26)</a>:</h4>
<p>this was on the assumption that a coherent model would need maximally robust information on what you're doing</p>



<a name="276733784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733784">(Mar 26 2022 at 16:27)</a>:</h4>
<p>however i don't think that would actually get you maximally robust information everywhere if you want to be able to talk about polymorphic analysis of generic code</p>



<a name="276733828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733828">(Mar 26 2022 at 16:28)</a>:</h4>
<p>would need to go down a rabbithole of &lt;T: ?Extern&gt; or something</p>



<a name="276733891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276733891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276733891">(Mar 26 2022 at 16:29)</a>:</h4>
<p>this was all working on the assumption that &amp;T only pointing to T was sacred, which it sounds like it's not now</p>



<a name="276734115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276734115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276734115">(Mar 26 2022 at 16:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don't.20shrink.20provenanc/near/276733891">said</a>:</p>
<blockquote>
<p>this was all working on the assumption that &amp;T only pointing to T was sacred, which it sounds like it's not now</p>
</blockquote>
<p>well as I said I cant promise this will work. but I had some vague ideas for how to loosen this restriction and we'll see how that goes.</p>



<a name="276734208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%3A%20refs%20that%20don%27t%20shrink%20provenanc/near/276734208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.3A.20refs.20that.20don&#x27;t.20shrink.20provenanc.html#276734208">(Mar 26 2022 at 16:36)</a>:</h4>
<p>ok cool i'll keep working on the assumption of maximally strict stacked borrows and what can work under it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>