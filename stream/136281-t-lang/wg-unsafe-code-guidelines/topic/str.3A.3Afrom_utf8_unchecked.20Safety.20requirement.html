<html>
<head><meta charset="utf-8"><title>str::from_utf8_unchecked Safety requirement · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html">str::from_utf8_unchecked Safety requirement</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278422824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422824">(Apr 09 2022 at 18:06)</a>:</h4>
<p><code>str::from_utf8_unchecked</code> documents this:</p>
<blockquote>
<p>This function is unsafe because it does not check that the bytes passed to it are valid UTF-8. If this constraint is violated, undefined behavior results, as the rest of Rust assumes that &amp;strs are valid UTF-8.</p>
</blockquote>
<p>This makes me super uncomfortable, because it suggests that the UB is elsewhere, if the requirements of this <code>unsafe fn</code> are violated.</p>
<p><span class="user-mention" data-user-id="326176">@Boxy [she/her]</span> asked if I'm okay with <code>NonZeroU32</code>. The answer is yes, absolutely. It documents</p>
<blockquote>
<p>Creates a non-zero without checking whether the value is non-zero. This results in undefined behaviour if the value is zero.<br>
Safety<br>
The value must not be zero.</p>
</blockquote>
<p>Interpreted literally, or per <span class="user-mention" data-user-id="224471">@Lokathor</span>'s reading here: <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278421409">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278421409</a> it would be incorrect for an implementation of <code>str::from_utf8_unchecked</code> to abort if it were passed a slice of bytes which is not UTF-8. By contrast, if you attempt to run this program:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">num</span>::<span class="n">NonZeroU32</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>in debug mode with <code>-Zbuild-std</code>, you will see this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">scratch</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">scratch</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.36</span><span class="n">s</span><span class="w"></span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">scratch</span><span class="err">`</span><span class="w"></span>
<span class="n">Illegal</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="278422839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422839">(Apr 09 2022 at 18:07)</a>:</h4>
<p>So the only problem is that <code>str</code> doesnt actually have niches for invalid utf8?</p>



<a name="278422861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422861">(Apr 09 2022 at 18:07)</a>:</h4>
<p>and that you'd be uncomfortable with <code>NonZeroU32</code> having <code>new_unchecked</code> be unsafe if it didnt have a niche?</p>



<a name="278422908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422908">(Apr 09 2022 at 18:08)</a>:</h4>
<p>No, my concern is that <code>&amp;str</code> has a wobbly sort of unsafe postcondition</p>



<a name="278422916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422916">(Apr 09 2022 at 18:08)</a>:</h4>
<p>i dont see how its any different than <code>NonZeroU32</code></p>



<a name="278422932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422932">(Apr 09 2022 at 18:08)</a>:</h4>
<p><code>NonZeroU32::new_unchecked</code> has a precondition</p>



<a name="278422939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422939">(Apr 09 2022 at 18:08)</a>:</h4>
<p>it doesnt really have a postcondition- just make sure that the bytes are valid utf8</p>



<a name="278422955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422955">(Apr 09 2022 at 18:09)</a>:</h4>
<p>by not being lang level UB yes i suppose its not _immediately_ UB and the real UB might happen later</p>



<a name="278422963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422963">(Apr 09 2022 at 18:09)</a>:</h4>
<p>but that seems _better_ to me</p>



<a name="278422966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422966">(Apr 09 2022 at 18:09)</a>:</h4>
<p>Yes it does, a literal reading of that says it is not UB to pass invalid bytes to <code>str::from_utf8_unchecked</code>, so long as you don't do anything with it. That means it would be incorrect for the standard library to check that the bytes passed are UTF-8 in debug mode.</p>



<a name="278422972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422972">(Apr 09 2022 at 18:09)</a>:</h4>
<p>The utf8 condition applies any time you pass a <code>&amp;str</code> value to any function at all, <em>ever</em>, unless you specifically know that the function can cope with malformed data (eg: because you wrote that function).</p>



<a name="278422979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278422979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278422979">(Apr 09 2022 at 18:10)</a>:</h4>
<blockquote>
<p>If this constraint is violated, undefined behavior results</p>
</blockquote>



<a name="278423024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423024">(Apr 09 2022 at 18:10)</a>:</h4>
<p>this sounds pretty clear cut to me that it is UB to pass it  bytes that arent utf8</p>



<a name="278423030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423030">(Apr 09 2022 at 18:10)</a>:</h4>
<p>the docs are quite fuzzy on when, as they should be</p>



<a name="278423040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423040">(Apr 09 2022 at 18:10)</a>:</h4>
<p>the safety docs could probably be clearer though about exactly what is going on, but I definitely dont read it as "its fine to pass in non utf8 bytes"</p>



<a name="278423043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423043">(Apr 09 2022 at 18:11)</a>:</h4>
<p>because the only UB is if some code assumes utf8 as part of a safety contract (eg: pointer offsetting) and the data doesn't hold</p>



<a name="278423054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423054">(Apr 09 2022 at 18:11)</a>:</h4>
<p>anyway, that's not the only way to make a malformed str</p>



<a name="278423058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423058">(Apr 09 2022 at 18:11)</a>:</h4>
<p>there's also as_bytes_mut</p>



<a name="278423064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423064">(Apr 09 2022 at 18:11)</a>:</h4>
<p>That may be when the program actually explodes, but my concern is about where the author's mistake is</p>



<a name="278423119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423119">(Apr 09 2022 at 18:12)</a>:</h4>
<p>If it's okay to pass invalid bytes to <code>from_utf8_unchecked</code>, we basically have no ability to write a helpful checker</p>



<a name="278423136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423136">(Apr 09 2022 at 18:13)</a>:</h4>
<p>That is, a checker without false positives or a bajillion flags</p>



<a name="278423206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423206">(Apr 09 2022 at 18:14)</a>:</h4>
<p>I mean the safety contract of that function is clear</p>



<a name="278423208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423208">(Apr 09 2022 at 18:14)</a>:</h4>
<p>by "checker" do you mean miri? because tbh I wouldnt expect miri to detect library UB like invalid utf8 strings</p>



<a name="278423216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423216">(Apr 09 2022 at 18:14)</a>:</h4>
<p>but again that's not the only way to do what we're talking about, so whatever</p>



<a name="278423235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423235">(Apr 09 2022 at 18:15)</a>:</h4>
<p>its okay language UB wise to pass invalid bytes, but its incorrect library UB wise so its "obviously" the fault of the <code>from_utf8_unchecked</code> call having not valid bytes if safe code then causes lang UB from relying on it being valid utf8</p>



<a name="278423282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423282">(Apr 09 2022 at 18:16)</a>:</h4>
<p>safe code would not cause lang UB</p>



<a name="278423289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423289">(Apr 09 2022 at 18:16)</a>:</h4>
<p>it would still be library UB</p>



<a name="278423306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423306">(Apr 09 2022 at 18:16)</a>:</h4>
<p>Side note: lang ub / lib ub is an absolutely terrible pair of names</p>



<a name="278423405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423405">(Apr 09 2022 at 18:18)</a>:</h4>
<p>what i mean is that calling a safe fn could cause lang ub</p>



<a name="278423411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423411">(Apr 09 2022 at 18:18)</a>:</h4>
<p>no that's still lib ub</p>



<a name="278423415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423415">(Apr 09 2022 at 18:18)</a>:</h4>
<p>i.e. safe code could call a safe fn which uses unsafe internally relying on the library UB</p>



<a name="278423420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423420">(Apr 09 2022 at 18:19)</a>:</h4>
<p>which then escalates to lang UB</p>



<a name="278423441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423441">(Apr 09 2022 at 18:19)</a>:</h4>
<p>I like lang/library UB distinction</p>



<a name="278423498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423498">(Apr 09 2022 at 18:20)</a>:</h4>
<p>I'm very unclear on how library ub would "escalate" to lang ub. Once you've done any ub the whole program is nonsense and it doesn't go any farther</p>



<a name="278423512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423512">(Apr 09 2022 at 18:21)</a>:</h4>
<blockquote>
<p>I like lang/library UB distinction</p>
</blockquote>
<p>I like the distinction but they initial to the same thing which is utterly terrible</p>



<a name="278423692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423692">(Apr 09 2022 at 18:25)</a>:</h4>
<p>By "checker" I mean any principled automatic insertion of checks. It could be Miri, or it could be the standard library debug assertions, or it could be some third-party analysis tool or interpreter.</p>



<a name="278423775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423775">(Apr 09 2022 at 18:27)</a>:</h4>
<p>I think it would be perfectly fine to insert a check that the bytes are valid utf8 inside of that function</p>



<a name="278423932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278423932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278423932">(Apr 09 2022 at 18:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278423498">said</a>:</p>
<blockquote>
<p>I'm very unclear on how library ub would "escalate" to lang ub. Once you've done any ub the whole program is nonsense and it doesn't go any farther</p>
</blockquote>
<p>take this example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// Safety: n must be &gt; 0</span>
<span class="n">unsaf</span><span class="w"> </span><span class="n">efn</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>violating the safety invariant doesnt ever turn into lang UB its "just" library UB- still UB and wrong and dont do it but its not violating any of the built in rust lang rules that can result in your code getting mangled up by optimizations and miri cant check this either. </p>
<p>but if we then add <code>NonZeroU32::new_unchecked(n)</code> now we've "escalated" the library UB into lang UB because we've got a <code>NonZeroU32</code> with a niche of <code>0</code> and its value set to <code>0</code></p>



<a name="278424031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424031">(Apr 09 2022 at 18:33)</a>:</h4>
<p>What if I wrote this though?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[requires = </span><span class="s">"n &gt; 0"</span><span class="cp">]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="278424080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424080">(Apr 09 2022 at 18:34)</a>:</h4>
<p>hard to say given <code>#[requires</code> is not a rust attribute that i know exists lol</p>



<a name="278424101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424101">(Apr 09 2022 at 18:35)</a>:</h4>
<p>is the string "n &gt; 0" something that rust itself now understands and will optimize around?</p>



<a name="278424111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424111">(Apr 09 2022 at 18:35)</a>:</h4>
<p>What if it's just a thing that the frontend parses, and Miri recognizes, and will check for you?</p>



<a name="278424118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424118">(Apr 09 2022 at 18:36)</a>:</h4>
<p>seems reasonable to me</p>



<a name="278424161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424161">(Apr 09 2022 at 18:36)</a>:</h4>
<p>that would be pretty cool to have :D</p>



<a name="278424163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424163">(Apr 09 2022 at 18:36)</a>:</h4>
<p>So is it library UB or language UB now that Miri can check it but it's not optimized on?</p>



<a name="278424167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424167">(Apr 09 2022 at 18:36)</a>:</h4>
<p>still library UB imo</p>



<a name="278424177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424177">(Apr 09 2022 at 18:36)</a>:</h4>
<p>So what about all the properties of Stacked Borrows which Miri checks but rustc does not optimize on?</p>



<a name="278424179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424179">(Apr 09 2022 at 18:37)</a>:</h4>
<p>its also still _ub_ so it seems perfectly fine to me to yell at the user about them having violated the safety invariants here</p>



<a name="278424256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424256">(Apr 09 2022 at 18:38)</a>:</h4>
<p>my wording has probably been pretty crap so this is on me but whether rustc _currently_ optimizes soemthing doesnt determine if its lang ub or not</p>



<a name="278424271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424271">(Apr 09 2022 at 18:39)</a>:</h4>
<p>im not really sure if you expect a real answer to your question im not on lang team and even if i was I couldnt unanimously say that stacked borrows was now the Official<span aria-label="tm" class="emoji emoji-2122" role="img" title="tm">:tm:</span> aliasing rules for rust :P</p>



<a name="278424280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424280">(Apr 09 2022 at 18:39)</a>:</h4>
<p>i dont quite understand what you're asking here</p>



<a name="278424292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424292">(Apr 09 2022 at 18:39)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> a checker can <em>absolutely</em> insert a check in <code>str::from_utf8_unchecked</code> if it wants to.</p>



<a name="278424297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424297">(Apr 09 2022 at 18:39)</a>:</h4>
<p><del>I guess in some ways you could consider lang UB to be library UB on the <code>compile_my_code</code> function rofl</del></p>



<a name="278424365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424365">(Apr 09 2022 at 18:40)</a>:</h4>
<p>I'm trying to point out how incredibly wobbly the difference between "library UB" and "language UB" is. I'm yet to see a solid definition for either, and I'm <em>extremely</em> wary of Miri's ability to check things or rustc's optimizations bleeding into any such conversation.</p>



<a name="278424393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424393">(Apr 09 2022 at 18:41)</a>:</h4>
<p>well.. its hard to say exactly waht is lang ub and what isnt seeing as how rust has conveniently not decided on this yet which amkes it a huge pain to write unsafe code</p>



<a name="278424435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424435">(Apr 09 2022 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278424297">said</a>:</p>
<blockquote>
<p><del>I guess in some ways you could consider lang UB to be library UB on the <code>compile_my_code</code> function rofl</del></p>
</blockquote>
<p>tbh i was joking with this remark but i do sort of like it :P</p>



<a name="278424438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424438">(Apr 09 2022 at 18:42)</a>:</h4>
<p>if <code>cargo run/build/check/test</code> could be unsafe and had a big <code>/// Safety:</code> section...</p>



<a name="278424439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424439">(Apr 09 2022 at 18:42)</a>:</h4>
<blockquote>
<p>but if we then add <code>NonZeroU32::new_unchecked(n)</code> now we've "escalated" the library UB into lang UB because we've got a <code>NonZeroU32</code> with a niche of <code>0</code> and its value set to <code>0</code></p>
</blockquote>
<p>So, my position is that it doesn't matter what the body of <code>foo</code> is. If the unsafe function documents &gt;0 then it's UB the instant you call it with 0 <em>regardless</em> of the actual code body of <code>foo</code>.</p>



<a name="278424458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424458">(Apr 09 2022 at 18:43)</a>:</h4>
<p>to be clear im not saying that calling it wouldnt conceptually be UB</p>



<a name="278424459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424459">(Apr 09 2022 at 18:43)</a>:</h4>
<p>im just saying that its library UB not language UB</p>



<a name="278424464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424464">(Apr 09 2022 at 18:43)</a>:</h4>
<p>both of which are UB and Bad</p>



<a name="278424513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424513">(Apr 09 2022 at 18:44)</a>:</h4>
<p>For example, this program is UB under stacked borrows with raw pointer tagging, it's documented to be not allowed by the standard library documentation, and it is checked for by debug assertions. But I am not sure we will ever have a world where it is optimized against.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="o">..</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">sli</span><span class="p">.</span><span class="n">get_unchecked</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>So I don't know how you'd draw a distinction between whether this is library UB or language UB, so I'm uncomfortable with drawing any distinction in the first place between those.</p>
<p>(*) we could turn the above program into definite LLVM UB for fun, but it would probably just be slower</p>



<a name="278424517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424517">(Apr 09 2022 at 18:44)</a>:</h4>
<p>sure, but I'm saying that once the lib UB has happened the program is nonsense and there's no escalation because nothing at all happens.</p>
<p>Which is a purely philosophical point perhaps.</p>



<a name="278424523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424523">(Apr 09 2022 at 18:44)</a>:</h4>
<p>I would say its lang UB in a world where we officially endorse stacked borrows as the rules<span aria-label="tm" class="emoji emoji-2122" role="img" title="tm">:tm:</span></p>



<a name="278424525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424525">(Apr 09 2022 at 18:44)</a>:</h4>
<p>But anyway that took my cold fingers a long time to type out and I see we mostly agree, so yeah now I feel like I'm more venting :p</p>



<a name="278424586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424586">(Apr 09 2022 at 18:46)</a>:</h4>
<p>Ben i would say your example is a lib UB, get_unchecked to an oob location violates the function contract</p>



<a name="278424593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424593">(Apr 09 2022 at 18:47)</a>:</h4>
<p>lang ub is actually, i would say, very rare because most of what we do in rust goes through functions (many of which wrap intrinsics)</p>



<a name="278424605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424605">(Apr 09 2022 at 18:47)</a>:</h4>
<p>But it's only documented to be UB because it is language UB under Stacked Borrows <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="278424669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424669">(Apr 09 2022 at 18:48)</a>:</h4>
<p>I'm 99% sure that reading out of bounds has been UB since before stacked borrows ;P</p>



<a name="278424690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424690">(Apr 09 2022 at 18:49)</a>:</h4>
<p>it's in bounds of the original allocation, so there's a reasonable world in which it's ok</p>



<a name="278424692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424692">(Apr 09 2022 at 18:49)</a>:</h4>
<p>Exactly</p>



<a name="278424696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424696">(Apr 09 2022 at 18:49)</a>:</h4>
<p>just hard to define what exactly the boundaries of &amp;mut+unsafe are in that world</p>



<a name="278424826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424826">(Apr 09 2022 at 18:52)</a>:</h4>
<p>i don't think it is. I think the bounds of the intermediate reference are narrowed, and we've (probably) treated things like that since before stacked borrows. Slice::split_at_mut is so old it doesn't have a stabilized version listed, and it's only sound if references narrow provenance</p>



<a name="278424830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424830">(Apr 09 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278424439">said</a>:</p>
<blockquote>
<blockquote>
<p>but if we then add <code>NonZeroU32::new_unchecked(n)</code> now we've "escalated" the library UB into lang UB because we've got a <code>NonZeroU32</code> with a niche of <code>0</code> and its value set to <code>0</code></p>
</blockquote>
<p>So, my position is that it doesn't matter what the body of <code>foo</code> is. If the unsafe function documents &gt;0 then it's UB the instant you call it with 0 <em>regardless</em> of the actual code body of <code>foo</code>.</p>
</blockquote>
<p>this doesn't work because it doesn't violate any rules of the abstract machine. we still have a fully defined operational semantics that completely ignores the function documentation. "library ub" is just a way to say "if you do this it may or may not be actual abstract-machine ub today, i as the library author simply reserve the right to have it result in abstract-machine ub without any further <code>unsafe</code> apis"</p>



<a name="278424866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424866">(Apr 09 2022 at 18:53)</a>:</h4>
<p>sure, and everything you just said applies to str methods and safety invariants in general.</p>



<a name="278424877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424877">(Apr 09 2022 at 18:53)</a>:</h4>
<blockquote>
<p>we've (probably) treated things like that since before stacked borrows</p>
</blockquote>
<p>Well, that would be before my involvement in unsafe Rust, but this out-of-bounds access was only documented to be UB on its own in August 2019: <a href="https://github.com/rust-lang/rust/commit/f44abba4ec19ee8b7ae4dfbe557fa4846eec8ad6">https://github.com/rust-lang/rust/commit/f44abba4ec19ee8b7ae4dfbe557fa4846eec8ad6</a></p>



<a name="278424878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424878">(Apr 09 2022 at 18:53)</a>:</h4>
<p>in other words "library ub" is only a useful concept "one level up" when you're talking about <code>unsafe</code> and api design</p>



<a name="278424915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424915">(Apr 09 2022 at 18:54)</a>:</h4>
<p>correct johnst</p>



<a name="278424935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424935">(Apr 09 2022 at 18:55)</a>:</h4>
<p>calling <code>from_utf8_unchecked</code> with invalid utf-8 may or may not invoke any language/abstract machine UB, but because we're talking about its api contract, that is not relevant- it is an implementation detail.</p>



<a name="278424936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424936">(Apr 09 2022 at 18:55)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> sadly our docs are often insufficient. Again, <code>slice::split_at_mut</code> is only sound if references have their provenance narrowed. That's just a fact, even if no one documented it</p>



<a name="278424948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278424948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278424948">(Apr 09 2022 at 18:56)</a>:</h4>
<p>and as an implementation detail, it is already perfectly fine to add debug asserts to it, have miri check it, etc</p>



<a name="278425016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425016">(Apr 09 2022 at 18:57)</a>:</h4>
<p>rpjohnst i think you and i are in complete agreement, or at least nearly so</p>



<a name="278425065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425065">(Apr 09 2022 at 18:58)</a>:</h4>
<p>yeah i'm not trying to disagree with your general position just the justification you gave</p>



<a name="278425089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425089">(Apr 09 2022 at 18:59)</a>:</h4>
<p>because i think saying "it's UB the instant you call wrong" doesn't really help answer ben's concern about the docs</p>



<a name="278425202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425202">(Apr 09 2022 at 19:00)</a>:</h4>
<p>fair point, I've been eating lunch this whole time so I've probably been less than fully articulate</p>



<a name="278425211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425211">(Apr 09 2022 at 19:00)</a>:</h4>
<p>No, it does. The docs need some clarification</p>



<a name="278425230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425230">(Apr 09 2022 at 19:01)</a>:</h4>
<p>They suggest a particular causality, which I think is unnecessary vague. The slice unchecked indexing docs clarified this some time ago, we should do the same for <code>from_utf8_unchecked</code></p>



<a name="278425241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425241">(Apr 09 2022 at 19:01)</a>:</h4>
<p>I prefer using something simpler than UTF-8 to have these conversations.</p>
<p>I find it much easier to talk about</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// This one has a *safety* invariant that it must be even</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Even</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new_unchecked</span><span class="p">(</span><span class="n">x</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Even</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>vs</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// This one has a *correctness* invariant that it must be even</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Even</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new_unchecked</span><span class="p">(</span><span class="n">x</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Even</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The code is <em>exactly</em> the same, other than <code>unsafe</code>.</p>
<p>But the former type carries a "proof" that it's even, upon which <code>unsafe</code> code can rely, while the latter doesn't.</p>



<a name="278425294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425294">(Apr 09 2022 at 19:02)</a>:</h4>
<p>my point is that it is not, in fact, inherently UB to call an unsafe function without upholding its preconditions- this is not a question of immediate (language) UB, it is a question "one level up" about API design</p>



<a name="278425318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425318">(Apr 09 2022 at 19:03)</a>:</h4>
<p>And my response to this has been that if it is not immediately UB, it cannot be checked</p>



<a name="278425329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425329">(Apr 09 2022 at 19:03)</a>:</h4>
<p>no, that is wrong- it can be checked, the justification is just different</p>



<a name="278425335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425335">(Apr 09 2022 at 19:03)</a>:</h4>
<p>you could even check it if the function were safe</p>



<a name="278425346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425346">(Apr 09 2022 at 19:03)</a>:</h4>
<p>It can be checked <em>with false positives</em> and <em>with a wobbly error message</em> which I don't find compelling</p>



<a name="278425395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425395">(Apr 09 2022 at 19:04)</a>:</h4>
<p>it may be a false positive for <em>language UB</em> but it is certainly not a false positive for <em>library correctness</em></p>



<a name="278425400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425400">(Apr 09 2022 at 19:04)</a>:</h4>
<p>bringing UB into this at all is a bit of a red herring</p>



<a name="278425412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425412">(Apr 09 2022 at 19:04)</a>:</h4>
<p>even a safe API is fully within its rights to panic on precondition violations</p>



<a name="278425490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425490">(Apr 09 2022 at 19:06)</a>:</h4>
<p>in other words, <code>unsafe</code> has no bearing on the abstract machine. it's part of a different layer, whose job is to assign blame for potential abstract machine UB, not to actually determine what is or is not UB</p>



<a name="278425649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425649">(Apr 09 2022 at 19:10)</a>:</h4>
<p>in terms of scott's example, how would you document <code>unsafe fn new_unchecked(x: u32) -&gt; Even</code> when the only abstract machine UB is off in some other function <code>fn use_even(Even(x): Even) { if x % 2 == 1 { unsafe { unreachable_unchecked() } }</code></p>



<a name="278425842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425842">(Apr 09 2022 at 19:15)</a>:</h4>
<p>I don't think that <code>from_utf8_unchecked</code> needs a docs change.</p>
<p>If you call the function with invalid bytes it's UB. End. That's it.</p>
<p>Checkers can put as many guards inside the function, because the caller did a UB, so go wild with checks.</p>



<a name="278425924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425924">(Apr 09 2022 at 19:17)</a>:</h4>
<p>I would really like to emphasize that the function is <em>just one way</em> to get invalid data inside a <code>&amp;str</code></p>



<a name="278425946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278425946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278425946">(Apr 09 2022 at 19:17)</a>:</h4>
<p>that's why the utf8 rule exists on the type as well as the function</p>



<a name="278426009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278426009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278426009">(Apr 09 2022 at 19:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278425842">said</a>:</p>
<blockquote>
<p>If you call the function with invalid bytes it's UB. End. That's it.</p>
</blockquote>
<p>but it's not abstract machine UB, that's the part that makes this tricky- we certainly don't ever want anyone call it with invalid bytes, and the API/docs are certainly not trying to allow tricks like "construct an invalid &amp;str but never pass it anywhere," but the justification needs to be a bit more precise than "it's UB" because it simply isn't.</p>



<a name="278426042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278426042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278426042">(Apr 09 2022 at 19:20)</a>:</h4>
<p>the justification is rather, the fact that it isn't immediately UB is not part of the API surface, it is an implementation detail of the API that you are not supposed to rely on</p>



<a name="278426135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278426135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278426135">(Apr 09 2022 at 19:21)</a>:</h4>
<p>for example, it would actually be sound for from_utf8_unchecked to start invoking UB immediately if passed invalid bytes</p>



<a name="278426181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278426181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278426181">(Apr 09 2022 at 19:22)</a>:</h4>
<p>and if <em>that's</em> fine then surely putting in a check is fine</p>



<a name="278426284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278426284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278426284">(Apr 09 2022 at 19:24)</a>:</h4>
<p>An action that's UB might work anyway. It really might. It could behave as you thought it would. That does not make it not UB.</p>
<p>We certainly <em>should</em> justify why an unsafe function is unsafe, but I would say that's separate.</p>



<a name="278467957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278467957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278467957">(Apr 10 2022 at 13:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278423498">said</a>:</p>
<blockquote>
<p>I'm very unclear on how library ub would "escalate" to lang ub. Once you've done any ub the whole program is nonsense and it doesn't go any farther</p>
</blockquote>
<p>that's only true for lang ub.<br>
the AM doesn't even know what lib UB is, so lib UB has absolutely no bearing on how the program behaves.</p>



<a name="278468024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278468024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278468024">(Apr 10 2022 at 13:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278424936">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> sadly our docs are often insufficient. Again, <code>slice::split_at_mut</code> is only sound if references have their provenance narrowed. That's just a fact, even if no one documented it</p>
</blockquote>
<p>no that's not true. for <code>split_at_mut</code> to be sound, it is enough for a reference's <em>safety contract</em> to ensure it is limited to stay within its bounds. provenance, language UB, all that stuff -- is not needed.</p>



<a name="278468105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278468105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278468105">(Apr 10 2022 at 13:26)</a>:</h4>
<p>so I agree with <span class="user-mention" data-user-id="117495">@rpjohnst</span> and disagree with <span class="user-mention" data-user-id="224471">@Lokathor</span> here. all of this "when you cause UB that's The End" is only true for lang UB.</p>



<a name="278468203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278468203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278468203">(Apr 10 2022 at 13:29)</a>:</h4>
<p>lang UB is the contract between the programmer(s) -- all the source code -- and the compiler.<br>
library UB is the contract <em>between the library author and the library user</em>. the compiler doesn't care to the slightest, and program behavior is not affected by this contract. library UB <em>does</em> give the library author license to cause language UB, and if that happens then the usual lang UB things apply. but library UB on its own doesn't have any world-ending powers -- if you are willing to break the abstraction and look into the library code, things might go on even if you cause library UB. you still should never do that because breaking abstractions is bad, other versions of the library might be different, etc., but this is a fundamental difference between lang UB and lib UB.</p>



<a name="278468205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278468205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278468205">(Apr 10 2022 at 13:29)</a>:</h4>
<p>(and yes all these terms are bad, including UB itself)</p>



<a name="278468799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278468799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278468799">(Apr 10 2022 at 13:43)</a>:</h4>
<p>I agree with <span class="user-mention" data-user-id="120791">@RalfJ</span> here, but I also think <span class="user-mention" data-user-id="224471">@Lokathor</span> has a point that the situation with lang UB is actually somewhat parallel in that you can also open the hood of the compiler and write code that is lang UB and still know that the show will go on. (In fact, <code>std</code> does exactly this in some places, not with lang UB AFAIK but with <code>repr(Rust)</code>.) The AM in this setting is revealed to be a lie that is used to define and describe the contract between the compiler and the code author; if you are willing to break that abstraction barrier then the AM ceases to matter</p>



<a name="278470860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278470860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278470860">(Apr 10 2022 at 14:23)</a>:</h4>
<p>yeah, I agree. however, "opening up" the compiler is a much bigger step -- you now have to consider all interactions of all optimizations, everything becomes very non-local.</p>



<a name="278470866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278470866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278470866">(Apr 10 2022 at 14:23)</a>:</h4>
<p>you can inspect the assembly, but even changing unrelated parts of the program can change the assembly of your function.</p>



<a name="278470871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278470871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278470871">(Apr 10 2022 at 14:23)</a>:</h4>
<p>in contrast, "going below" lib UB still gives you local reasoning etc</p>



<a name="278474196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474196">(Apr 10 2022 at 15:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278467957">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278423498">said</a>:</p>
<blockquote>
<p>I'm very unclear on how library ub would "escalate" to lang ub. Once you've done any ub the whole program is nonsense and it doesn't go any farther</p>
</blockquote>
<p>that's only true for lang ub.<br>
the AM doesn't even know what lib UB is, so lib UB has absolutely no bearing on how the program behaves.</p>
</blockquote>
<p>I dispute the distinction here - after all, the standard library is free to "promote" lib UB to lang UB, or interact with other parts of the libraries in ways that render the program equally nonsensical. There isn't a functional difference - it's just UB.<br>
And in both cases, you have implementation privilege - the stdlib can rely on the compiler doing "the right thing" (for some definiton thereof) for some case of lang UB, just as much as it can rely on the rest of the stdlib doing the right thing for some case of lib UB.<br>
Yes, you have to ensure that it interacts properly, but it's the same with lib UB. If you violate a stdlib precondition within the stdlib, you have to ensure that you don't exploit that precondition in a way that affects the observable behaviour, and it's the same for lang preconditions.</p>



<a name="278474318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474318">(Apr 10 2022 at 15:37)</a>:</h4>
<p>A valid implementation of <code>core::str::from_utf8_unchecked</code> is <code>core::ptr::from_utf8(buf).unwrap_unchecked()</code>.</p>



<a name="278474327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474327">(Apr 10 2022 at 15:37)</a>:</h4>
<p>As is "transmute and check later".</p>



<a name="278474342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474342">(Apr 10 2022 at 15:38)</a>:</h4>
<p>(check meaning assume here)</p>



<a name="278474402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474402">(Apr 10 2022 at 15:39)</a>:</h4>
<blockquote>
<p>I dispute the distinction here - after all, the standard library is free to "promote" lib UB to lang UB, or interact with other parts of the libraries in ways that render the program equally nonsensical. There isn't a functional difference - it's just UB.</p>
</blockquote>
<p>It's a very big difference when you are debugging your code.<br>
so this is just what I said above -- "library UB does give the library author license to cause language UB"</p>



<a name="278474414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474414">(Apr 10 2022 at 15:39)</a>:</h4>
<p>(deleted)</p>



<a name="278474475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474475">(Apr 10 2022 at 15:40)</a>:</h4>
<p>Non-standard library is the same case as the stdlib, but you don't get implementation privilege over language UB, just like you don't get implementation privilege over the standard library, or for that matter any library you call to not under your contrl.</p>



<a name="278474479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474479">(Apr 10 2022 at 15:40)</a>:</h4>
<blockquote>
<p>[the stdlib] can rely on the rest of the stdlib doing the right thing for some case of lib UB.</p>
</blockquote>
<p><em>any</em> library can rely on <em>other parts of itself</em> doing the right thing for some cases of lib UB. as I said, lib UB is a contract between the lib author and its users. the lib author can break its own contract as much as they please.</p>



<a name="278474491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474491">(Apr 10 2022 at 15:41)</a>:</h4>
<p>IOW, nothing you say is even in arguing against anything I said above...</p>



<a name="278474492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474492">(Apr 10 2022 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474318">said</a>:</p>
<blockquote>
<p>A valid implementation of <code>core::str::from_utf8_unchecked</code> is <code>core::ptr::from_utf8(buf).unwrap_unchecked()</code>.</p>
</blockquote>
<p>agreed</p>



<a name="278474552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474552">(Apr 10 2022 at 15:42)</a>:</h4>
<p>Yes. The exception is that the standard library also has the same privilege wrt. it's contract with the abstract machine, because, strictly speaking, the Standard Library is part of the whole implementation of the Rust Programming Language, and thus under it's control.</p>



<a name="278474557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474557">(Apr 10 2022 at 15:42)</a>:</h4>
<p>yes</p>



<a name="278474567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474567">(Apr 10 2022 at 15:42)</a>:</h4>
<p>but that still doesnt eradicate the clear distincion between lib UB and lang UB</p>



<a name="278474573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474573">(Apr 10 2022 at 15:43)</a>:</h4>
<p>But I wouldn't call that any different from just another "library" that the stdlib calls to, but that's under the standard libraries control.</p>



<a name="278474580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474580">(Apr 10 2022 at 15:43)</a>:</h4>
<p>so?</p>



<a name="278474648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474648">(Apr 10 2022 at 15:44)</a>:</h4>
<p>So there really isn't a difference here.<br>
And one of the reasons I don't like the distinction is that it seems to give people the impression that it's not as bad. It's all UB. The program is entirely nonsensical unless you control the result of that UB.</p>



<a name="278474665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474665">(Apr 10 2022 at 15:45)</a>:</h4>
<blockquote>
<p>So there really isn't a difference here.</p>
</blockquote>
<p>There's the differences I explained above, none of which you even gave arguments against...</p>



<a name="278474679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474679">(Apr 10 2022 at 15:45)</a>:</h4>
<p>I certainly dont want to give anyone the impression that violating lib UB is okay. and I don't think I ever did. so for this discussion that's a strawman argument.</p>



<a name="278474732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474732">(Apr 10 2022 at 15:46)</a>:</h4>
<blockquote>
<p>The program is entirely nonsensical unless you control the result of that UB.</p>
</blockquote>
<p>Your definition of "nonsensical" must be very different from mine.</p>



<a name="278474739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474739">(Apr 10 2022 at 15:46)</a>:</h4>
<p>using my Abstract Machine, I can very easily make a lot of sense of programs that violate lib UB but not lang UB. I can even prove formal statements about them.</p>



<a name="278474749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474749">(Apr 10 2022 at 15:47)</a>:</h4>
<p>Sure - <em>if</em> you know and control the result.</p>



<a name="278474861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474861">(Apr 10 2022 at 15:49)</a>:</h4>
<p>my proof might break when the lib is updated, yeah</p>



<a name="278474865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474865">(Apr 10 2022 at 15:50)</a>:</h4>
<p>but if I keep everything pinned, it'll keep working</p>



<a name="278474909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474909">(Apr 10 2022 at 15:50)</a>:</h4>
<p>Or replaced with a different version.</p>



<a name="278474912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474912">(Apr 10 2022 at 15:50)</a>:</h4>
<p>which is a <em>lot</em> easier than what happens when lang UB is violated</p>



<a name="278474915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474915">(Apr 10 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474909">said</a>:</p>
<blockquote>
<p>Or replaced with a different version.</p>
</blockquote>
<p>how's that different from "updated"?^^</p>



<a name="278474917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474917">(Apr 10 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474865">said</a>:</p>
<blockquote>
<p>but if I keep everything pinned, it'll keep working</p>
</blockquote>
<p>That is also true if you pin the compiler to a version that "defines" the UB.</p>



<a name="278474921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474921">(Apr 10 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474917">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474865">said</a>:</p>
<blockquote>
<p>but if I keep everything pinned, it'll keep working</p>
</blockquote>
<p>That is also true if you pin the compiler to a version that "defines" the UB.</p>
</blockquote>
<p>no. changing any code anywhere in your program can have arbitrary effects with lang UB, even if you keep the rustc version the same.</p>



<a name="278474923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278474923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278474923">(Apr 10 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474915">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474909">said</a>:</p>
<blockquote>
<p>Or replaced with a different version.</p>
</blockquote>
<p>how's that different from "updated"?^^</p>
</blockquote>
<p>Mostly isn't for user libraries. The standard library, however, is supplied with the implementation.</p>



<a name="278475024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475024">(Apr 10 2022 at 15:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474921">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474917">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474865">said</a>:</p>
<blockquote>
<p>but if I keep everything pinned, it'll keep working</p>
</blockquote>
<p>That is also true if you pin the compiler to a version that "defines" the UB.</p>
</blockquote>
<p>no. changing any code anywhere in your program can have arbitrary effects with lang UB.</p>
</blockquote>
<p>Only if the compiler didn't define the behaviour.</p>
<p>I can use C++ unions to type pun all I want so long as I know that I'm using a compiler in the (nonexistautive) set {gcc. clang, msvc, lccc, nvcc (I think)}, and I can reason about what it's behaviour is.<br>
The fact it's strictly UB in C++ is moot, because all of those implementations have said what happens. And if I know that, I can proof the behaviour of the AM in those cases. It's the same with library UB. If you know what the implementation specifically does, you can proof it's behaviour.</p>



<a name="278475101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475101">(Apr 10 2022 at 15:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474923">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474915">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278474909">said</a>:</p>
<blockquote>
<p>Or replaced with a different version.</p>
</blockquote>
<p>how's that different from "updated"?^^</p>
</blockquote>
<p>Mostly isn't for user libraries. The standard library, however, is supplied with the implementation.</p>
</blockquote>
<p>If you pin, say, bytemuck 1.7.0, then you can be reasonably sure that it's the same every time.<br>
But if you pin rust 1.60, and use it's standard library, you  can get multiple different versions in different compilations (as the compilations may come with different implementations of the rust 1.60 standard library, particularily if it's using different implemenations of rust 1.60). Pinning rustc itself returns to the former case, though (most likely).</p>



<a name="278475211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475211">(Apr 10 2022 at 15:57)</a>:</h4>
<p>So you could say that the difference between language UB and library UB is how easy it is to "know" the behaviour (if it's not just "do literally anything") - but this still doesn't hold for the stdlib.</p>



<a name="278475231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475231">(Apr 10 2022 at 15:57)</a>:</h4>
<blockquote>
<p>Only if the compiler didn't define the behaviour.</p>
</blockquote>
<p>oh sure, if you have some idea of what the effective AM actually implemented by the compiler is you could exploit that</p>



<a name="278475277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475277">(Apr 10 2022 at 15:58)</a>:</h4>
<p>generally that's super hard though because not even the authors of the compiler know what the effective AM induced by their optimizations is ;)</p>



<a name="278475280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475280">(Apr 10 2022 at 15:58)</a>:</h4>
<p>that's the argument <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> made above that I already agreed to, not sure why you had to repeat it...</p>



<a name="278475692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475692">(Apr 10 2022 at 16:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278475277">said</a>:</p>
<blockquote>
<p>generally that's super hard though because not even the authors of the compiler know what the effective AM induced by their optimizations is ;)</p>
</blockquote>
<p>Well, they do if they control how correct optimizations are applied to a program.</p>



<a name="278475716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475716">(Apr 10 2022 at 16:07)</a>:</h4>
<p>for most of the compilers in your list, as far as I can tell, nobody has a clue</p>



<a name="278475757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475757">(Apr 10 2022 at 16:08)</a>:</h4>
<p>lccc might be doing better, and that's great. :-)</p>



<a name="278475787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475787">(Apr 10 2022 at 16:09)</a>:</h4>
<p>Well, since all of those compilers specifically permit (as an extension) bit_cast through inactive member of union, I'm fairly confident that a decent number of people do for that operation.</p>



<a name="278475879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278475879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278475879">(Apr 10 2022 at 16:11)</a>:</h4>
<p>(So an optimization that exploited active member rule in a way that violates that extension would be unsound - thus it's fairly trivial to reason about programs that contain such an operation)</p>



<a name="278476060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278476060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278476060">(Apr 10 2022 at 16:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278475757">said</a>:</p>
<blockquote>
<p>lccc might be doing better, and that's great. :-)</p>
</blockquote>
<p>I'd hope that in the case of the entire set, lccc will do as good at most. In this case, I'm meaning "control the information given to the optimizer in ways that would make certain transformations valid and others invalid" (for example, by not indicating that the optimizer is free to exploit active variant rule).</p>



<a name="278483971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278483971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278483971">(Apr 10 2022 at 18:59)</a>:</h4>
<p>There was an explicit decision to make "str is UTF-8" a safety invariant rather than a validity invariant (though I can't find the issue where it was discussed rn)</p>



<a name="278484151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484151">(Apr 10 2022 at 19:02)</a>:</h4>
<p>So it isn't UB to create a str that isn't UTF-8?</p>



<a name="278484247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484247">(Apr 10 2022 at 19:04)</a>:</h4>
<p>I think the key point is this: "library UB" versus "language UB" only matters for a <em>specific execution</em> (just like UB in general refers to a specific execution).<br>
"Language UB" is specifically "did this execution violate requirements of the Abstract Machine" — if so, there is <em>no</em> guarantee on the behavior of the execution.<br>
"Library UB" is specifically "did this execution violate safety invariants of the used functions, but not violate the Abstract Machine" — if so, there is a guaranteed execution, but no guarantee <em>under changing the implementation/provider of the functions</em></p>



<a name="278484355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484355">(Apr 10 2022 at 19:06)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span><br>
<a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/78">unsafe-code-guidelines#78</a> <a href="https://github.com/rust-lang/reference/issues/792">reference#792</a> <a href="https://github.com/rust-lang/rust/issues/71033">rust#71033</a><br>
Found them</p>



<a name="278484612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484612">(Apr 10 2022 at 19:11)</a>:</h4>
<p>The fact that this is a safety and not validity invariant is also important for <code>as_bytes_mut</code>; if it were a validity invariant that UTF-8 were well-formed, then you wouldn't be able to write in UTF-8 bytewise, as it temporarily puts ill-formed UTF-8 into the string</p>



<a name="278484661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484661">(Apr 10 2022 at 19:12)</a>:</h4>
<p>(well, modulo <em>when</em> exactly validity at type str is actually enforced...)</p>



<a name="278484860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484860">(Apr 10 2022 at 19:16)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/84184#issuecomment-981800385">https://github.com/rust-lang/rust/issues/84184#issuecomment-981800385</a></p>



<a name="278484969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484969">(Apr 10 2022 at 19:18)</a>:</h4>
<p>So I'm not sure why we need to demote str to a safety invariant to support <code>as_bytes_mut</code> if this example is valid. It's in the docs, which seems to me the most normative thing we have.</p>



<a name="278484979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278484979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278484979">(Apr 10 2022 at 19:18)</a>:</h4>
<p>I believe as the <code>from_utf8_unchecked</code> docs are currently written, they do imply that it is <em>not</em> a violation of the Abstract Machine to call with ill-formed UTF-8. However, no other method on <code>&amp;str</code> says it works on ill-formed UTF-8, so strictly the only valid thing to do would be to drop the reference or coerce it to a pointer.</p>



<a name="278485008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278485008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278485008">(Apr 10 2022 at 19:19)</a>:</h4>
<p>But yeah also see <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/84">unsafe-code-guidelines#84</a> and related discussion</p>



<a name="278485062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278485062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278485062">(Apr 10 2022 at 19:20)</a>:</h4>
<p>"validity on typed copy" seems to be the way we're going... but <code>str</code> is an unsized type, and can't have a typed copy IIUC, at least not until unsized locals</p>



<a name="278486387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486387">(Apr 10 2022 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278484151">said</a>:</p>
<blockquote>
<p>So it isn't UB to create a str that isn't UTF-8?</p>
</blockquote>
<p>It's UB to pass such a <code>&amp;str</code> to any function that expects a normal well-formed <code>&amp;str</code> (which is any function that accepts <code>&amp;str</code>, unless you specifically know otherwise about a specific function).</p>
<p>and that requirement is arguably <em>separate</em> from the <code>from_utf8_unchecked</code> safety requirements, which are in fact allowed to be "immediate UB on passing in malformed bytes", which is what's currently documented.</p>



<a name="278486490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486490">(Apr 10 2022 at 19:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278486387">said</a>:</p>
<blockquote>
<p>which is what's currently documented.</p>
</blockquote>
<p>This is what's debatable, though. The actual text is</p>
<blockquote>
<p>This function is unsafe because it does not check that the bytes passed to it are valid UTF-8. If this constraint is violated, undefined behavior results, as the rest of Rust assumes that <code>&amp;strs</code> are valid UTF-8.</p>
</blockquote>
<p>which can reasonably be read as the UB results <em>as a result of</em> the rest of Rust assuming that <code>&amp;str</code> is valid UTF-8, or that the UB happens <em>when</em> the rest of Rust exploits that assumption, <em>not</em> as a result of calling this function.</p>



<a name="278486511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486511">(Apr 10 2022 at 19:51)</a>:</h4>
<p>Ah, so we're quibbling about precisely when it's saying the UB happens.</p>



<a name="278486512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486512">(Apr 10 2022 at 19:51)</a>:</h4>
<p>I agree it <em>should</em> be considered immediate UB, and you have to use a transmute to go from non-UTF-8 <code>&amp;[u8]</code> to non-UTF-8 <code>&amp;str</code>, but the docs don't make this clear at the moment</p>



<a name="278486560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486560">(Apr 10 2022 at 19:52)</a>:</h4>
<p>But yes, the debate here is over the exact wording and when the (library) UB happens</p>



<a name="278486569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486569">(Apr 10 2022 at 19:52)</a>:</h4>
<p>(and thus when the library would be allowed to insert a violation of the Abstract Machine)</p>



<a name="278486608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486608">(Apr 10 2022 at 19:53)</a>:</h4>
<p>(or, equivalently, a UB sanitizer failure)</p>



<a name="278486674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486674">(Apr 10 2022 at 19:54)</a>:</h4>
<p>Well I suppose I don't super care on where that falls out, <strong> Saethlin</strong> wants to put a debugger check for valid UTF-8 on that function then I say it's legitimate to have such a debug check. Even if it's not immediate UB it should be fine to have such a check! I genuinely don't care about debug code hitting a panic because it definitely broke safety invariants that it planned to fix up later before anyone noticed. It's honestly fine, really.</p>



<a name="278486676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486676">(Apr 10 2022 at 19:54)</a>:</h4>
<p>...interesting tangentially related note: <code>from_utf8_unchecked</code> uses <code>mem::transmute</code> but <code>from_utf8_unchecked_mut</code> uses pointer casts... for some reason</p>



<a name="278486825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278486825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278486825">(Apr 10 2022 at 19:58)</a>:</h4>
<p>This doc note is from 2015, so I think it's reasonable to say it is loosely worded and tighten the wording for current conventions <a href="https://github.com/rust-lang/rust/commit/4d73da92f0e6d00025609e42b1e7f59f00b73be9">https://github.com/rust-lang/rust/commit/4d73da92f0e6d00025609e42b1e7f59f00b73be9</a></p>



<a name="278487137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278487137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278487137">(Apr 10 2022 at 20:05)</a>:</h4>
<p>I opened a PR: <a href="https://github.com/rust-lang/rust/issues/95895">rust#95895</a></p>



<a name="278489849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278489849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278489849">(Apr 10 2022 at 21:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278486387">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278484151">said</a>:</p>
<blockquote>
<p>So it isn't UB to create a str that isn't UTF-8?</p>
</blockquote>
<p>It's UB to pass such a <code>&amp;str</code> to any function that expects a normal well-formed <code>&amp;str</code> (which is any function that accepts <code>&amp;str</code>, unless you specifically know otherwise about a specific function).</p>
<p>and that requirement is arguably <em>separate</em> from the <code>from_utf8_unchecked</code> safety requirements, which are in fact allowed to be "immediate UB on passing in malformed bytes", which is what's currently documented.</p>
</blockquote>
<p>(library UB)</p>



<a name="278489914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278489914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278489914">(Apr 10 2022 at 21:08)</a>:</h4>
<p>but we all agree that adding such checks in <code>from_utf8_unchecked</code> is fine, yes. the part where the docs say "this is not checked" should be interpreted as "the implementation does not <em>guarantee</em> to check this".</p>



<a name="278489918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278489918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278489918">(Apr 10 2022 at 21:09)</a>:</h4>
<p>Are there <em>any</em> std methods that have lang UB on invalid utf-8? I recall looking into this a while ago and I think I couldn't find any</p>



<a name="278489940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278489940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278489940">(Apr 10 2022 at 21:09)</a>:</h4>
<p>I am pretty sure an example was brought up during the safety/validity invariant discussion</p>



<a name="278489943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278489943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278489943">(Apr 10 2022 at 21:10)</a>:</h4>
<p>I dont recall if the example was confirmed or refuted though...^^</p>



<a name="278489994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278489994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278489994">(Apr 10 2022 at 21:10)</a>:</h4>
<p>there are of course plenty of hypothetical implementations you can make with lang UB on invalid UTF-8</p>



<a name="278490017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278490017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278490017">(Apr 10 2022 at 21:11)</a>:</h4>
<p>ah, here's the thread -&gt; <a href="#narrow/stream/122651-general/topic/Memory.20safety.20exploits.20involving.20non-UTF-8.20strings">https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Memory.20safety.20exploits.20involving.20non-UTF-8.20strings</a></p>



<a name="278490253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278490253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278490253">(Apr 10 2022 at 21:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278489918">said</a>:</p>
<blockquote>
<p>Are there <em>any</em> std methods that have lang UB on invalid utf-8? I recall looking into this a while ago and I think I couldn't find any</p>
</blockquote>
<p>I haven't gotten to UTF-8 in lccc libcore yet, but my own UTF-8 hander in a basic-string library uses <code>get_unchecked</code> in <code>decode_char_unchecked</code> and <code>debug_range_unchecked</code> (called by <code>BasicStr&lt;Char,Traits&gt;::unicode_iter()</code> and <code>BasicStr&lt;Char,Traits&gt;::debug()</code> respectively)</p>



<a name="278490318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278490318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278490318">(Apr 10 2022 at 21:18)</a>:</h4>
<p>(So malformed UTF-8 - specifically an unepxected EOS - could lead to OOB accesses in theory).</p>



<a name="278491392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491392">(Apr 10 2022 at 21:44)</a>:</h4>
<p>Malformed UTF-8 will lead to out of bounds reads with the rustc std str as well, for any function that does UTF-8 decoding</p>



<a name="278491464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491464">(Apr 10 2022 at 21:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="132829">Christopher Durham (CAD97)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement/near/278491392">said</a>:</p>
<blockquote>
<p>Malformed UTF-8 will lead to out of bounds reads with the rustc std str as well, for any function that does UTF-8 decoding</p>
</blockquote>
<p>I tried to find that code but couldn't^^</p>



<a name="278491481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491481">(Apr 10 2022 at 21:47)</a>:</h4>
<p>I know at one point I verified that the chars iterator does</p>



<a name="278491533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491533">(Apr 10 2022 at 21:48)</a>:</h4>
<p>yeah I thought I had seen that</p>



<a name="278491610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491610">(Apr 10 2022 at 21:50)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/027a232755fa9728e9699337267f6675dfd0a8ba/library/core/src/str/validations.rs#L36-L70">https://github.com/rust-lang/rust/blob/027a232755fa9728e9699337267f6675dfd0a8ba/library/core/src/str/validations.rs#L36-L70</a></p>



<a name="278491614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491614">(Apr 10 2022 at 21:51)</a>:</h4>
<p>Uses <code>bytes.next().unwrap_unchecked()</code> to get the bytes of a code point encoding</p>



<a name="278491620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491620">(Apr 10 2022 at 21:51)</a>:</h4>
<p>No longer an OOB read, it seems, "just" <code>std::hint::unreachable_unchecked</code></p>



<a name="278491632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491632">(Apr 10 2022 at 21:51)</a>:</h4>
<p>(Which, of course, given that it's UB, likely compiles to an OOB read, but no guarantees etc)</p>



<a name="278491679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491679">(Apr 10 2022 at 21:52)</a>:</h4>
<p>I grepped for 'unreachable' in that folder and didnt' find it...</p>



<a name="278491684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491684">(Apr 10 2022 at 21:52)</a>:</h4>
<p>I guess I had whole-word matching turned on or something silly like that :/</p>



<a name="278491692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491692">(Apr 10 2022 at 21:52)</a>:</h4>
<p>ah no it's hidden behind <code>unwrap_unchecked</code>, I see</p>



<a name="278491700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491700">(Apr 10 2022 at 21:53)</a>:</h4>
<p>I literally saw that code but didnt realize it makes the UTF8 assumption :( oh well</p>



<a name="278491782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278491782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278491782">(Apr 10 2022 at 21:54)</a>:</h4>
<p>yeah thats why my grep didnt find it</p>



<a name="278492450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278492450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278492450">(Apr 10 2022 at 22:10)</a>:</h4>
<p>Oh, that's a recent change: <a href="https://github.com/rust-lang/rust/commit/23637e20cdf3f7b8e01b42dbaf25357e5d3c31ae">https://github.com/rust-lang/rust/commit/23637e20cdf3f7b8e01b42dbaf25357e5d3c31ae</a></p>



<a name="278492462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278492462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278492462">(Apr 10 2022 at 22:11)</a>:</h4>
<p>that code was safe when I audited it last year</p>



<a name="278493229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278493229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278493229">(Apr 10 2022 at 22:32)</a>:</h4>
<p>A <em>long</em> time ago it used an unchecked slice: <a href="https://github.com/rust-lang/rust/blob/9bae6ec828fdc7f87838ee008cccef90e31b9f84/src/libcore/str.rs#L111">https://github.com/rust-lang/rust/blob/9bae6ec828fdc7f87838ee008cccef90e31b9f84/src/libcore/str.rs#L111</a></p>



<a name="278493260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278493260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278493260">(Apr 10 2022 at 22:32)</a>:</h4>
<p>But that was before I started using Rust so I have no idea where I saw UTF-8 being trusted</p>



<a name="278494027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278494027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278494027">(Apr 10 2022 at 22:53)</a>:</h4>
<p>Actually that code is safe because <code>char_range_at</code> is written in such a way that it would panic on earlier byte accesses if the slice was out of bounds</p>



<a name="278639514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str%3A%3Afrom_utf8_unchecked%20Safety%20requirement/near/278639514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/str.3A.3Afrom_utf8_unchecked.20Safety.20requirement.html#278639514">(Apr 12 2022 at 02:03)</a>:</h4>
<p>I'm surprised there's not at least a <code>255 =&gt; unreachable_unchecked()</code> somewhere in decoding, since there might as well be, to not have to handle that impossible case.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>