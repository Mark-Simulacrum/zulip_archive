<html>
<head><meta charset="utf-8"><title>transmute from `*const Dst` to `*const Wrapper&lt;Dst&gt;` · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html">transmute from `*const Dst` to `*const Wrapper&lt;Dst&gt;`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253028519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253028519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253028519">(Sep 13 2021 at 02:19)</a>:</h4>
<p>Is transmuting from <code>*const Dst</code> to <code>*const Wrapper&lt;Dst&gt;</code> sound?</p>
<p>(<code>Wrapper</code> being <code>#[repr(transparent))] struct Wrapper&lt;T: ?Sized&gt;(T);</code>)</p>
<p>I noticed that <code>bytemuck</code> does that transmute in <a href="https://docs.rs/bytemuck/1.7.2/src/bytemuck/transparent.rs.html#103"><code>wrap_ref</code></a></p>



<a name="253028703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253028703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253028703">(Sep 13 2021 at 02:23)</a>:</h4>
<p>how wouldn't it be sound? that's part of the guarantees made by repr(transparent), no?</p>



<a name="253029058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029058">(Sep 13 2021 at 02:27)</a>:</h4>
<p>I'm not aware that <code>#[repr(transparent)]</code> makes guarantees about arbitrary generic types that have it as a type parameter.<br>
I'm only aware about guarantees made WRT using it by value.</p>



<a name="253029176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029176">(Sep 13 2021 at 02:29)</a>:</h4>
<p>Transmuting from <code>*const T</code> to <code>*const U</code> is sound for any (sized) <code>T</code> and <code>U</code></p>



<a name="253029187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029187">(Sep 13 2021 at 02:29)</a>:</h4>
<p>...but I suppose that's not what you mean</p>



<a name="253029260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029260">(Sep 13 2021 at 02:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60/near/253029187">said</a>:</p>
<blockquote>
<p>...but I suppose that's not what you mean</p>
</blockquote>
<p>I did mean <code>!Sized</code> types, like <code>str</code> or <code>[T]</code>.</p>



<a name="253029270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029270">(Sep 13 2021 at 02:30)</a>:</h4>
<p>I believe that <code>#[repr(transparent)]</code> guarantees that <code>*const Transparent&lt;T&gt;</code> and <code>*const T</code> (likewise <code>*mut</code>) have the same layout as well.</p>



<a name="253029285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029285">(Sep 13 2021 at 02:31)</a>:</h4>
<p>(Regardless of the <code>Sized</code>ness of <code>T</code>)</p>



<a name="253029305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029305">(Sep 13 2021 at 02:31)</a>:</h4>
<p>I don't think <code>*const impl !Sized</code> types have a stable ABI</p>



<a name="253029316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029316">(Sep 13 2021 at 02:31)</a>:</h4>
<p>They don't, but transparent does special things.</p>



<a name="253029375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029375">(Sep 13 2021 at 02:32)</a>:</h4>
<p>You wouldn't be able to rely on the layout, but you should be able to rely on the layouts matching in that case <em>because</em> of the <code>repr(transparent)</code></p>



<a name="253029416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029416">(Sep 13 2021 at 02:33)</a>:</h4>
<p>I see. I believe that goes a bit beyond the documented guarantees of <code>repr(transparent)</code>, but it is a logical extension</p>



<a name="253029496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029496">(Sep 13 2021 at 02:34)</a>:</h4>
<p>One notable case for this is UnsafeCell, which allows &amp;mut T =&gt; &amp;UnsafeCell&lt;T&gt; (for T: ?Sized)</p>



<a name="253029782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029782">(Sep 13 2021 at 02:38)</a>:</h4>
<p>I think you meant <code>Cell</code>, which if you look at how that is implemented:<br>
<a href="https://doc.rust-lang.org/1.55.0/src/core/cell.rs.html#529">https://doc.rust-lang.org/1.55.0/src/core/cell.rs.html#529</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_mut</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>doesn't <em>transmute</em> the pointer type.</p>
<p>Using <code>as</code> casts allows the compiler to swap the pointer metadata with the data pointer if it wanted to.</p>



<a name="253029791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20from%20%60%2Aconst%20Dst%60%20to%20%60%2Aconst%20Wrapper%3CDst%3E%60/near/253029791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20from.20.60*const.20Dst.60.20to.20.60*const.20Wrapper.3CDst.3E.60.html#253029791">(Sep 13 2021 at 02:38)</a>:</h4>
<p>True</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>