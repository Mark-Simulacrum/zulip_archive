<html>
<head><meta charset="utf-8"><title>Should CTFE reject NonZero::new_unchecked(0)? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html">Should CTFE reject NonZero::new_unchecked(0)?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276740990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20CTFE%20reject%20NonZero%3A%3Anew_unchecked%280%29%3F/near/276740990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html#276740990">(Mar 26 2022 at 19:13)</a>:</h4>
<p>Idk where to ask this, but this issue was opened recently <a href="https://github.com/rust-lang/rust/issues/95332">https://github.com/rust-lang/rust/issues/95332</a></p>
<p>It's an interesting question. OP seems to think there is a compiler bug here. But I think this is <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span> library UB <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span> and CTFE isn't necessarily obligated to detect it. But it could, right? We're creating an instance of <code>T</code> where the value it guarantees is available isn't.</p>



<a name="276741351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20CTFE%20reject%20NonZero%3A%3Anew_unchecked%280%29%3F/near/276741351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html#276741351">(Mar 26 2022 at 19:20)</a>:</h4>
<p>it's language UB but we dont guarantee to detect that either</p>



<a name="276743917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20CTFE%20reject%20NonZero%3A%3Anew_unchecked%280%29%3F/near/276743917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html#276743917">(Mar 26 2022 at 20:20)</a>:</h4>
<p>NonNull is explicitly called out in the nomicon as part of the "forbidden values" family, but through an unstable feature that lets libs opt into it: <a href="https://doc.rust-lang.org/nightly/nomicon/what-unsafe-does.html">https://doc.rust-lang.org/nightly/nomicon/what-unsafe-does.html</a></p>



<a name="276743923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20CTFE%20reject%20NonZero%3A%3Anew_unchecked%280%29%3F/near/276743923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html#276743923">(Mar 26 2022 at 20:21)</a>:</h4>
<p>(so yes, language UB through library extension)</p>



<a name="276745368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20CTFE%20reject%20NonZero%3A%3Anew_unchecked%280%29%3F/near/276745368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Konrad Borowski <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html#276745368">(Mar 26 2022 at 20:57)</a>:</h4>
<p>currently <a href="https://rust-lang.github.io/rfcs/3016-const-ub.html">https://rust-lang.github.io/rfcs/3016-const-ub.html</a> says that there are no guarantees at all about <code>const</code> detecting UB</p>



<a name="276745679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20CTFE%20reject%20NonZero%3A%3Anew_unchecked%280%29%3F/near/276745679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20CTFE.20reject.20NonZero.3A.3Anew_unchecked(0).3F.html#276745679">(Mar 26 2022 at 21:02)</a>:</h4>
<p>Yes, this isn't a bug, but the question is whether an attempt should be made</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>