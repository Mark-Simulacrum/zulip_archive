<html>
<head><meta charset="utf-8"><title>SB Without Raw Pointer Tagging · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html">SB Without Raw Pointer Tagging</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277336578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277336578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277336578">(Mar 31 2022 at 20:35)</a>:</h4>
<p>For an example, <a href="https://github.com/rust-lang/miri/issues/1526">see this issue</a>. Essentially, the problem with raw pointer tagging is that the borrow stack may have many untagged items, and it's very hard to know which of those untagged items your use of a raw pointer will match. cc <span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> who I think had some cool examples of this</p>



<a name="277337107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277337107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277337107">(Mar 31 2022 at 20:40)</a>:</h4>
<p>Sure, here's one of my favorites</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">];</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This <code>Vec</code> is not mutable, and yet under SB without raw pointer tagging, you can convert a shared reference to one of its elements to a mutable reference and mutate through it.</p>



<a name="277338227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277338227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277338227">(Mar 31 2022 at 20:51)</a>:</h4>
<p>yeah so... what's the question here? ;)<br>
this is what happens when one tries to support ptr2int2ptr roundtrips without an exploding state space^^</p>



<a name="277338312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277338312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277338312">(Mar 31 2022 at 20:51)</a>:</h4>
<p>Ah, sorry, should have linked: <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277335957">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277335957</a></p>



<a name="277338600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277338600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277338600">(Mar 31 2022 at 20:54)</a>:</h4>
<p>I've noticed in conversations that people are mostly not familiar with how strange and chaotic SB without raw pointer tagging is. There's a good example on the UCG repo of the fragility of code that it accepts, but what I'm pointing out with this example is just that I find a lot of code that it accepts defies intuition that we teach in safe Rust.</p>



<a name="277341698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277341698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277341698">(Mar 31 2022 at 21:20)</a>:</h4>
<p>yes</p>



<a name="277341743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277341743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277341743">(Mar 31 2022 at 21:21)</a>:</h4>
<p>the evaluation criteria for original SB (without raw ptr tagging) is "are these optimizations correct". and they are.</p>



<a name="277341758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277341758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277341758">(Mar 31 2022 at 21:21)</a>:</h4>
<p>IOW, the extra UB introduced by raw ptr tagging doesn't help a lot for optimizations</p>



<a name="277341967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277341967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277341967">(Mar 31 2022 at 21:23)</a>:</h4>
<p>What optimizations? Are they in the paper?</p>



<a name="277342946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277342946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277342946">(Mar 31 2022 at 21:30)</a>:</h4>
<p>Okay, this is important then. My proposal in <a class="stream-topic" data-stream-id="136281" href="/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance">#t-lang/wg-unsafe-code-guidelines &gt; Strict provenance</a> isn't very good if untagged pointers don't work well</p>



<a name="277343274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343274">(Mar 31 2022 at 21:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277336578">said</a>:</p>
<blockquote>
<p>For an example, <a href="https://github.com/rust-lang/miri/issues/1526">see this issue</a>. Essentially, the problem with raw pointer tagging is that the borrow stack may have many untagged items, and it's very hard to know which of those untagged items your use of a raw pointer will match. cc <span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> who I think had some cool examples of this</p>
</blockquote>
<p>I think it could be argued (from a CHERI point of view) that you need to "enable/broadcast" <code>a</code> first with <code>&amp;a as *const _</code></p>



<a name="277343305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343305">(Mar 31 2022 at 21:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277337107">said</a>:</p>
<blockquote>
<p>This <code>Vec</code> is not mutable, and yet under SB without raw pointer tagging, you can convert a shared reference to one of its elements to a mutable reference and mutate through it.</p>
</blockquote>
<p>This matches my intuition that really, <code>*const</code> = <code>*mut</code>, it's just decoration</p>



<a name="277343333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343333">(Mar 31 2022 at 21:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277341967">said</a>:</p>
<blockquote>
<p>What optimizations? Are they in the paper?</p>
</blockquote>
<p>yes</p>



<a name="277343400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343400">(Mar 31 2022 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277342946">said</a>:</p>
<blockquote>
<p>Okay, this is important then. My proposal in <a class="stream-topic" data-stream-id="136281" href="/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance">#t-lang/wg-unsafe-code-guidelines &gt; Strict provenance</a> isn't very good if untagged pointers don't work well</p>
</blockquote>
<p>well, okay so I may have to relativize</p>



<a name="277343409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343409">(Mar 31 2022 at 21:36)</a>:</h4>
<p>default SB is very aggressive with untagging</p>



<a name="277343418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343418">(Mar 31 2022 at 21:36)</a>:</h4>
<p>like, all raw ptrs are untagged</p>



<a name="277343424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343424">(Mar 31 2022 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277343274">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277336578">said</a>:</p>
<blockquote>
<p>For an example, <a href="https://github.com/rust-lang/miri/issues/1526">see this issue</a>. Essentially, the problem with raw pointer tagging is that the borrow stack may have many untagged items, and it's very hard to know which of those untagged items your use of a raw pointer will match. cc <span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> who I think had some cool examples of this</p>
</blockquote>
<p>I think it could be argued (from a CHERI point of view) that you need to "enable/broadcast" <code>a</code> first with <code>&amp;a as *const _</code></p>
</blockquote>
<p>The problem isn't the ptr to int stuff, it's SB without raw pointer tagging in general. The "int to ptr gives an untagged raw pointer" only makes sense if untagged raw pointers exist at all</p>



<a name="277343427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343427">(Mar 31 2022 at 21:36)</a>:</h4>
<p><code>Vec</code> uses tons of raw ptrs so there is untagged everywhere</p>



<a name="277343513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343513">(Mar 31 2022 at 21:37)</a>:</h4>
<p>but I think it should be possible, at least with future generations of aliasing models, to only do the 'untagged' thing when doing <code>ptr as usize</code>. which <code>Vec</code> doesn't do so there is no problem there.<br>
also the only pointers that would be untagged are those produced by int2ptr. so code not using int2ptr would still be effectively using full tagging.</p>



<a name="277343606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343606">(Mar 31 2022 at 21:38)</a>:</h4>
<p><span class="user-mention" data-user-id="465167">@Bram Geron</span> So can you explain why in this code, converting to a raw pointer does not give you the ability to do writes?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">];</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277343659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343659">(Mar 31 2022 at 21:39)</a>:</h4>
<p>Same deal with this code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">];</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277343813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343813">(Mar 31 2022 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> why would it give you the ability to do writes?</p>



<a name="277343835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343835">(Mar 31 2022 at 21:41)</a>:</h4>
<p>it does in current SB because current SB basically treats all ref-to-raw conversions like ptr2int, and all raw-to-ref as int2ptr</p>



<a name="277343843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343843">(Mar 31 2022 at 21:41)</a>:</h4>
<p>Sure. Your <code>&amp;[T]</code> may come from a function argument. And rustc will optimize the caller assuming that the array doesn't change. So SB must prevent your code must changing the array.</p>



<a name="277343849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343849">(Mar 31 2022 at 21:41)</a>:</h4>
<p>like, raw pointers are basically integers for default SB</p>



<a name="277343866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343866">(Mar 31 2022 at 21:41)</a>:</h4>
<p>This matches my view that <code>*mut</code> doesn't give you any extra abilities over <code>*const</code></p>



<a name="277343880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343880">(Mar 31 2022 at 21:42)</a>:</h4>
<p>that is <em>clearly</em> crazy. I did it because I wanted to be <em>sure</em> that integer roundtrips work well in SB. So I made sure they happen all the time.</p>



<a name="277343918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343918">(Mar 31 2022 at 21:42)</a>:</h4>
<p>SB decides if you're allowed to write. The type system doesn't decide any more</p>



<a name="277343932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343932">(Mar 31 2022 at 21:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277343843">said</a>:</p>
<blockquote>
<p>Sure. Your <code>&amp;[T]</code> may come from a function argument. And rustc will optimize the caller assuming that the array doesn't change. So SB must prevent your code must changing the array.</p>
</blockquote>
<p>Why doesn't this logic apply to an immutable <code>Vec&lt;u8&gt;</code>? <code>Vec</code> does not contain any interior mutability.</p>



<a name="277343941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343941">(Mar 31 2022 at 21:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277343866">said</a>:</p>
<blockquote>
<p>This matches my view that <code>*mut</code> doesn't give you any extra abilities over <code>*const</code></p>
</blockquote>
<p>note that if <code>x: &amp;mut T</code>, then <code>x as *const T as *mut T</code> gives you a <em>read-only</em> pointer in SB</p>



<a name="277343954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343954">(Mar 31 2022 at 21:42)</a>:</h4>
<p>Hm. That's weird.</p>



<a name="277343958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343958">(Mar 31 2022 at 21:43)</a>:</h4>
<p>it is and it isnt...</p>



<a name="277343981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343981">(Mar 31 2022 at 21:43)</a>:</h4>
<p>the borrow checker will let you write <code>x as *const T</code> in some sitatiuons where you are not allowed to write <code>x as *mut T</code></p>



<a name="277343994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343994">(Mar 31 2022 at 21:43)</a>:</h4>
<p>so in ref-to-raw casts, the type you cast to clearly matters</p>



<a name="277343995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277343995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277343995">(Mar 31 2022 at 21:43)</a>:</h4>
<p>SB reflects that</p>



<a name="277344050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277344050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277344050">(Mar 31 2022 at 21:44)</a>:</h4>
<p>feel free to read <a href="https://github.com/rust-lang/rust/issues/56604">https://github.com/rust-lang/rust/issues/56604</a> for all the glory details :D</p>



<a name="277344348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277344348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277344348">(Mar 31 2022 at 21:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277343981">said</a>:</p>
<blockquote>
<p>the borrow checker will let you write <code>x as *const T</code> in some sitatiuons where you are not allowed to write <code>x as *mut T</code></p>
</blockquote>
<p>Remind me why it's helpful to forbid <code>x as *mut T</code> sometimes <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="277344542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277344542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277344542">(Mar 31 2022 at 21:49)</a>:</h4>
<p>helpful? no idea. borrowck does it.^^</p>



<a name="277344553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277344553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277344553">(Mar 31 2022 at 21:49)</a>:</h4>
<p>it lets you do <code>x as *mut T</code> only when you can also do <code>&amp;mut *x</code></p>



<a name="277344570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277344570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277344570">(Mar 31 2022 at 21:50)</a>:</h4>
<p>i.e., it doesnt let you do it when there are outstanding shared loans</p>



<a name="277344826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277344826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277344826">(Mar 31 2022 at 21:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277343606">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> So can you explain why in this code, converting to a raw pointer does not give you the ability to do writes?</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">];</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Here I can see an argument: <code>&amp;[0u8]</code> may have type <code>&amp;'static [u8]</code>.</p>
<p>I think we could stack-allocate the array at runtime, and then the miri encoding could create a <code>Unique</code>, making your program legal.</p>
<blockquote>
<p>same version but with <code>&amp;mut [0u8]</code></p>
</blockquote>
<p>I don't understand why miri should reject this. <span class="user-mention" data-user-id="120791">@RalfJ</span> ?</p>



<a name="277345364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277345364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277345364">(Mar 31 2022 at 21:57)</a>:</h4>
<p>The question here isn't <em>why</em> Miri should reject this code. That's not what my complaint about SB with raw pointer tagging is.</p>



<a name="277345534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277345534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277345534">(Mar 31 2022 at 21:59)</a>:</h4>
<p>My concern about SB without raw pointer tagging is that teaching it to people is a can of worms and the examples defy common intuition.</p>
<p>In the majority of cases when I see code that Miri rejects without raw pointer tagging, I turn on raw pointer tagging and hope that no other code in the project is rejected, in order to debug the code.</p>



<a name="277345610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277345610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277345610">(Mar 31 2022 at 22:00)</a>:</h4>
<p>Or if you like, understand what code pattern the model doesn't accept, if you don't consider code which is rejected by Miri to be buggy ;)</p>



<a name="277346042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346042">(Mar 31 2022 at 22:03)</a>:</h4>
<p>If your argument is that SB is needlessly restrictive in the context of CHERI, then I can see that point</p>



<a name="277346044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346044">(Mar 31 2022 at 22:03)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> yes so that is fixed by the hypothetical stacked-borrows-untagged-integers</p>



<a name="277346070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346070">(Mar 31 2022 at 22:04)</a>:</h4>
<p>which might not be coherent but I hope some future variant of stacked borrows will make it coherent</p>



<a name="277346120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346120">(Mar 31 2022 at 22:04)</a>:</h4>
<p>But as Rust lacks <code>volatile</code>, I think it might have to be so restrictive</p>



<a name="277346158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346158">(Mar 31 2022 at 22:04)</a>:</h4>
<p>eh... Rust has volatile and what does that have to do with anything??^^</p>



<a name="277346172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346172">(Mar 31 2022 at 22:04)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> Can you think of a model that's easier to explain that still allows for "Rusty" optimizations?</p>



<a name="277346200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346200">(Mar 31 2022 at 22:05)</a>:</h4>
<p>SB with raw pointer tagging ;)</p>



<a name="277346206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346206">(Mar 31 2022 at 22:05)</a>:</h4>
<p>:D</p>



<a name="277346236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346236">(Mar 31 2022 at 22:05)</a>:</h4>
<p>right so stacked-borrows-untagged-integers behaves exactly like SB with raw pointer tagging on programs that are strict aliasing conformant</p>



<a name="277346259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346259">(Mar 31 2022 at 22:05)</a>:</h4>
<p>so I dont think you have to be worried here <span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span></p>



<a name="277346267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346267">(Mar 31 2022 at 22:05)</a>:</h4>
<p>assuming I can make stacked-borrows-untagged-integers actually work, that is ;)</p>



<a name="277346335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346335">(Mar 31 2022 at 22:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging/near/277346158">said</a>:</p>
<blockquote>
<p>eh... Rust has volatile and what does that have to do with anything??^^</p>
</blockquote>
<p>Never mind, poor choice of words</p>



<a name="277346493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346493">(Mar 31 2022 at 22:08)</a>:</h4>
<p>What is SB with raw pointer tagging?</p>



<a name="277346535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346535">(Mar 31 2022 at 22:08)</a>:</h4>
<p>(and how is it easier to explain)</p>



<a name="277346809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346809">(Mar 31 2022 at 22:10)</a>:</h4>
<p>Raw pointers inherit properties strictly based on what they were created from. If your raw pointer comes from a <code>&amp;T</code>, it cannot be used for writes. If it comes from a <code>&amp;mut T</code>, it can.</p>
<p>There's no spooky action at a distance, like there is without raw pointer tagging. All of the examples I pasted above are rejected by SB with raw pointer tagging, because they all attempt to mutate through a pointer which descends from a <code>&amp;T</code>.</p>



<a name="277346995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277346995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277346995">(Mar 31 2022 at 22:12)</a>:</h4>
<p>There is of course a lot more to it. And it rejects a lot more code because <code>const</code> vs <code>mut</code> is just a lint, so people have been sort of trained that all raw pointers are equivalent. But they aren't, and they're not the same in SB without raw pointer tagging for action-at-a-distance reasons, but in SB with raw pointer tagging, it's all much more local.</p>



<a name="277347051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347051">(Mar 31 2022 at 22:13)</a>:</h4>
<p>Also, I can write good Miri diagnostics for SB with raw pointer tagging. Without it, diagnostics involve literal guesswork and luck.</p>



<a name="277347082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347082">(Mar 31 2022 at 22:13)</a>:</h4>
<p>So, the tag is just a boolean?</p>



<a name="277347167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347167">(Mar 31 2022 at 22:14)</a>:</h4>
<p>(quite something else than <code>untagged</code> in the context of the SB paper)</p>



<a name="277347226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347226">(Mar 31 2022 at 22:15)</a>:</h4>
<p>I cannot speak to the paper. I'm doing my best to exit academia, but <em>certain people</em> seem to be pulling me back in. I can speak to the implementation in Miri.</p>



<a name="277347267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347267">(Mar 31 2022 at 22:15)</a>:</h4>
<p>"Tag" is somewhat of a misnomer. Borrow stacks contain Items, and each Item is a Tag, a Permission, and a Protector. This is always the case, but in SB without raw pointer tagging there is a special tag Untagged which may appear many times in a borrow stack. All other tags may only appear once in a borrow stack.</p>



<a name="277347419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347419">(Mar 31 2022 at 22:17)</a>:</h4>
<p>What information does a tag contain?</p>



<a name="277347529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347529">(Mar 31 2022 at 22:18)</a>:</h4>
<p>A tag is just a unique identifier for a pointer.</p>



<a name="277347556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347556">(Mar 31 2022 at 22:18)</a>:</h4>
<p>You may want to read this <a href="https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md">https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md</a> or this <a href="https://github.com/rust-lang/miri/blob/master/src/stacked_borrows.rs">https://github.com/rust-lang/miri/blob/master/src/stacked_borrows.rs</a></p>



<a name="277347703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347703">(Mar 31 2022 at 22:20)</a>:</h4>
<p>Thanks</p>



<a name="277347923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277347923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277347923">(Mar 31 2022 at 22:22)</a>:</h4>
<p>So: enabling "tagging" in miri will reject more programs. I don't think we should necessarily go there for a specification of Rust (make more programs UB) but good to know.</p>



<a name="277348073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB%20Without%20Raw%20Pointer%20Tagging/near/277348073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging.html#277348073">(Mar 31 2022 at 22:24)</a>:</h4>
<p>Then again, maybe we'll want to mark memory read-only for CHERI. Could be very very desirable.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>