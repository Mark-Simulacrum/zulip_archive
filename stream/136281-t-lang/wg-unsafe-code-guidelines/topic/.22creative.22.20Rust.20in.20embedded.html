<html>
<head><meta charset="utf-8"><title>&quot;creative&quot; Rust in embedded · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html">&quot;creative&quot; Rust in embedded</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274062605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062605">(Mar 04 2022 at 00:38)</a>:</h4>
<p>and likewise I think using a numeric hex literal to declare an address you want to poke at, that you know is there to interact with because you <strong>read it in the manual</strong>, is fine.</p>



<a name="274062629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062629">(Mar 04 2022 at 00:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274062525">said</a>:</p>
<blockquote>
<p>well...in embedded, there may not be a way to do out-of-process debugging</p>
</blockquote>
<p>in-process debugging is a recipe for the compiler tearing your code to shreds. Everything to do with it. Entirely.</p>



<a name="274062642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062642">(Mar 04 2022 at 00:39)</a>:</h4>
<p>embedded has JTAG dunnit</p>



<a name="274062645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062645">(Mar 04 2022 at 00:39)</a>:</h4>
<p>crazy idea: <code>usize::try_into(_): *const T</code></p>



<a name="274062659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062659">(Mar 04 2022 at 00:39)</a>:</h4>
<p>heheh</p>



<a name="274062663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062663">(Mar 04 2022 at 00:39)</a>:</h4>
<p>Unrelated to whether or not <code>usize</code> and <code>*const T</code> are the same size.</p>



<a name="274062672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062672">(Mar 04 2022 at 00:39)</a>:</h4>
<p>what if your jtag is soldered to ground, making it in-accessible?</p>



<a name="274062685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062685">(Mar 04 2022 at 00:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274062605">said</a>:</p>
<blockquote>
<p>and likewise I think using a numeric hex literal to declare an address you want to poke at, that you know is there to interact with because you <strong>read it in the manual</strong>, is fine.</p>
</blockquote>
<p>Yes, as long as it's not memory the compiler controls.</p>



<a name="274062745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062745">(Mar 04 2022 at 00:40)</a>:</h4>
<p>yeah, sorry, i've veered well off-topic</p>



<a name="274062766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062766">(Mar 04 2022 at 00:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274062672">said</a>:</p>
<blockquote>
<p>what if your jtag is soldered to ground, making it in-accessible?</p>
</blockquote>
<p><del>buy better tools</del></p>



<a name="274062784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062784">(Mar 04 2022 at 00:41)</a>:</h4>
<p>&lt;_&lt;</p>



<a name="274062795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062795">(Mar 04 2022 at 00:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274062672">said</a>:</p>
<blockquote>
<p>what if your jtag is soldered to ground, making it in-accessible?</p>
</blockquote>
<p>blackbox debugger time</p>



<a name="274062833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062833">(Mar 04 2022 at 00:41)</a>:</h4>
<p>in-process debugger to the rescue!</p>



<a name="274062921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062921">(Mar 04 2022 at 00:42)</a>:</h4>
<p>also, there are cpus without any debugging hardware whatsoever</p>



<a name="274062938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062938">(Mar 04 2022 at 00:42)</a>:</h4>
<p>I am aware and their creators should be uninvited from making more hardware.</p>



<a name="274062954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062954">(Mar 04 2022 at 00:43)</a>:</h4>
<p>well...</p>



<a name="274062957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062957">(Mar 04 2022 at 00:43)</a>:</h4>
<p><a href="https://github.com/programmerjake/rv32">https://github.com/programmerjake/rv32</a></p>



<a name="274062974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062974">(Mar 04 2022 at 00:43)</a>:</h4>
<p>AHA</p>



<a name="274062979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062979">(Mar 04 2022 at 00:43)</a>:</h4>
<p>no debugging hardware cuz i ran out of time before finals</p>



<a name="274062980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062980">(Mar 04 2022 at 00:43)</a>:</h4>
<p>THE CRIMINAL IS THEE</p>



<a name="274062985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274062985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274062985">(Mar 04 2022 at 00:43)</a>:</h4>
<p>well I suppose that's fair.</p>



<a name="274063051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063051">(Mar 04 2022 at 00:44)</a>:</h4>
<p>but that's just going to be simulated / FPGA'd anyways</p>



<a name="274063082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063082">(Mar 04 2022 at 00:44)</a>:</h4>
<p>fpgas don't necessarily let you access their internals...</p>



<a name="274063088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063088">(Mar 04 2022 at 00:44)</a>:</h4>
<p>You're not shipping that to customers. If you are, we are going to have to have a talk.</p>



<a name="274063101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063101">(Mar 04 2022 at 00:44)</a>:</h4>
<p>instructors can be customers...</p>



<a name="274063125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063125">(Mar 04 2022 at 00:45)</a>:</h4>
<p>Maybe fork this discussion?</p>



<a name="274063153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063153">(Mar 04 2022 at 00:45)</a>:</h4>
<p>what about the riscv core embedded in some dram controller, where there is no debugger cuz that takes too much space?</p>



<a name="274063213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063213">(Mar 04 2022 at 00:46)</a>:</h4>
<p>done.</p>



<a name="274063261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063261">(Mar 04 2022 at 00:46)</a>:</h4>
<p>That reminds me, I need debugging lines in the Clever-ISA hardware reference.</p>



<a name="274063391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063391">(Mar 04 2022 at 00:48)</a>:</h4>
<blockquote>
<p>Maybe fork this discussion?</p>
</blockquote>
<p>yeah, sorry, afaict i don't have the required privileges to move existing messages to a new discussion... <span class="user-mention" data-user-id="281757">@Jubilee</span> do you?</p>



<a name="274063419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063419">(Mar 04 2022 at 00:48)</a>:</h4>
<p>refresh your Zulip.</p>



<a name="274063439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063439">(Mar 04 2022 at 00:49)</a>:</h4>
<p>anyone can edit topics</p>



<a name="274063449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063449">(Mar 04 2022 at 00:49)</a>:</h4>
<p>moving streams requires fancy permissions</p>



<a name="274063587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274063587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274063587">(Mar 04 2022 at 00:51)</a>:</h4>
<p>thx!</p>



<a name="274075394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274075394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274075394">(Mar 04 2022 at 03:30)</a>:</h4>
<p>It was mentioned that "magic linker symbols" can do this (pointers to non-rust memory), and strictly speaking they can, but I do wonder how much optimization that will kill.</p>



<a name="274075585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274075585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274075585">(Mar 04 2022 at 03:30)</a>:</h4>
<p>I mean, no more than any other external static.</p>



<a name="274075820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274075820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274075820">(Mar 04 2022 at 03:35)</a>:</h4>
<p>(SIde note, if people want to see creative, wait until I support z80/8080 in lccc <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span>)</p>



<a name="274075853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274075853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274075853">(Mar 04 2022 at 03:36)</a>:</h4>
<p>(Disclaimer: may not actually happen)</p>



<a name="274076333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274076333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274076333">(Mar 04 2022 at 03:43)</a>:</h4>
<p>well, you could probably get a working rustc for z80, using this wip z80 backend for llvm (idk how far along it is though): <a href="https://github.com/jacobly0/llvm-project/wiki">https://github.com/jacobly0/llvm-project/wiki</a></p>



<a name="274141831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274141831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274141831">(Mar 04 2022 at 15:07)</a>:</h4>
<blockquote>
<p>I mean, no more than any other external static.</p>
</blockquote>
<p>Yes, exactly. However if you're targeting a particular device you can instead use constants, and then the compiler has the chance to optimize them the same as any other math.</p>



<a name="274167620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274167620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274167620">(Mar 04 2022 at 18:12)</a>:</h4>
<p>Right. It may be a magic linker symbol but there's no reason you can't be asking the compiler to generate it and to specially take it into account.</p>



<a name="274170736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274170736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274170736">(Mar 04 2022 at 18:35)</a>:</h4>
<p>Also, in a lot of cases, the lookup can simply be moved to link time, by encoding an addend to the relocation.</p>



<a name="274173336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274173336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274173336">(Mar 04 2022 at 18:55)</a>:</h4>
<p>I'm not clear on what case you're imagining.</p>
<p>I'm thinking of a case where the compiler would see that you access several locations that <em>it turns out</em> happen to all be within a few bytes of each other. Then the compiler can put the lowest value in a register and access the others via an offset, which can free up some registers, which can prevent pushing to the stack.</p>
<p>If that location info was held back until link time then the linker can substitute in the value but it (likely) cannot go and reassess the register usage for the entire function.</p>



<a name="274174857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274174857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274174857">(Mar 04 2022 at 19:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded/near/274173336">said</a>:</p>
<blockquote>
<p>I'm not clear on what case you're imagining.</p>
</blockquote>
<p>At least <strong>I</strong> am imagining that there's a macro or attribute or something that ideally creates a symbol that the entire compiler toolchain becomes aware of as meaning that it denotes a Special Place that you want a pointer to and it should be Allowed in spite of it possibly otherwise bending the rules of Rust, and that would allow the compiler to do the reasoning you are talking about and make sure everywhere else in the program also participates in that reasoning.</p>



<a name="274254836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274254836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274254836">(Mar 05 2022 at 17:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded/near/274060768">said</a>:</p>
<blockquote>
<p>there are also cases where I need <code>0x12345678 as *mut T</code>, mostly for embedded stuff</p>
</blockquote>
<p>yes that is why I keep repeating all the time that it is the int2ptr cast <em>in a ptr2int2ptr roundtrip</em> that is causing trouble.<br>
casting a fixed address <em>that is disjoint from all the memory the abstract machine knows about</em> is totally fine. Basically, <code>0x12345678 as *mut T</code> is like a call to <code>malloc</code> where you already know the result. it synthesizes a fresh provenance, and crucially this pointer <em>may not be used to access any memory with any other provenance</em>.</p>



<a name="274255452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274255452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274255452">(Mar 05 2022 at 17:34)</a>:</h4>
<p>Is there any concrete guidance somewhere on what users <em>should</em> be doing? This discussion is making me quite concerned about one of the projects I'm working on, which is basically a tiny OS that needs to manage its own memory, and if I wanted to bring up these concerns to people I would need something specific to point at</p>



<a name="274255963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274255963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274255963">(Mar 05 2022 at 17:44)</a>:</h4>
<p>well, we are still figuring that out...</p>



<a name="274256140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/274256140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#274256140">(Mar 05 2022 at 17:49)</a>:</h4>
<p>meanwhile I would say the more you can avoid int2ptr roundtrip casts and instead work with an <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=a2f5075d11a23222e95d3dee844beaac">API like this</a>, the better -- but there's tons of low-level code out there that does int2ptr roundtrip casts and there's probably more important things to worry about in unsafe code...</p>



<a name="275838497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275838497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275838497">(Mar 18 2022 at 17:43)</a>:</h4>
<p>Interesting perspective, to call it a weird form of <code>malloc</code>. Could this be explicit? In the sense of platform/arch specific functions such as<br>
<code>unsafe fn arch::x86::new_virtual_address(addr: usize, len: usize) -&gt; *const [u8]</code><br>
as it allows us to invent any address if we just write a number to a page table. And some architecture might miss similar functions, have alternatives for mmio wherever llvm makes a difference, if they have non-usize-sized pointers, if it's fallible.</p>



<a name="275840525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275840525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275840525">(Mar 18 2022 at 17:58)</a>:</h4>
<p>I'm unclear what benefits that would give to the programmer compared to the current system. Does that function give me more assurances, or have some sort of debug mode check, or anything like that?</p>



<a name="275845060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275845060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275845060">(Mar 18 2022 at 18:35)</a>:</h4>
<p>it makes more explicit what happens and lets us avoid <code>as</code></p>



<a name="275845097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275845097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275845097">(Mar 18 2022 at 18:35)</a>:</h4>
<p>so it's somewhat similar in spirit to avoiding <code>as</code> in other tricky situations (like lossy casts)</p>



<a name="275849673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275849673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275849673">(Mar 18 2022 at 19:12)</a>:</h4>
<p>Two main differences: it's <code>unsafe</code>, with case-by-case documented preconditions. That provides a decent incentive to transition implementations away from the generic and (probably) improper safe <code>as</code> usage by providing an alternative. At the same time, similar to <code>size_of_val_raw</code> being underdefined, it could be explicit where Rust has and where it has not stabilized defined semantics.<br>
Secondly, some platforms may consume two arguments where <code>as</code> is inherently a unary operator. The showcased  <code>len</code> argument could be a helpful opt-in assertion by the programmer that's consumed in MIR or hardware provenance tracking, without needing to resort to dynamic usage analysis or a tag with unbounded access.</p>



<a name="275850149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275850149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275850149">(Mar 18 2022 at 19:16)</a>:</h4>
<p>Another not so important one in terms of soundess, at least as far as I can tell: by providing it in <code>arch::</code> (or another submodule) it becomes immediately obvious that such code is highly dependent on the hardware. And it will fail to compile on platforms that couldn't provide a sound, generic int2ptr. (Random thought: are there any scenarios where we could have a sound <code>const fn addr_to_static(???) -&gt; *const </code> in any shape of form, such as by linker tricks?)</p>



<a name="275851999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275851999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275851999">(Mar 18 2022 at 19:31)</a>:</h4>
<p>my understanding is that const evaluation happens within the object file generation phase, and static addresses aren't selected until linking.</p>



<a name="275852533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275852533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275852533">(Mar 18 2022 at 19:36)</a>:</h4>
<p>To go back a point or two though, I don't view a function call as any more explicit than <code>as</code>. It's just an expression that does something, and the way you type it doesn't really affect the amount of visible explicitness (in my mind).</p>
<p>I am very interested in what the documentation would be for these pre-conditions would say.</p>



<a name="275853225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275853225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275853225">(Mar 18 2022 at 19:42)</a>:</h4>
<p>I think it actually would be postconditions since the <code>unsafe</code> would be the dereferencing or similar functions.<br>
"Give this a static address and you get a pointer. Using it to push data in or out is probably <code>unsafe</code>!"</p>



<a name="275853563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275853563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275853563">(Mar 18 2022 at 19:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded/near/275852533">said</a>:</p>
<blockquote>
<p>To go back a point or two though, I don't view a function call as any more explicit than <code>as</code>. It's just an expression that does something, and the way you type it doesn't really affect the amount of visible explicitness (in my mind).</p>
<p>I am very interested in what the documentation would be for these pre-conditions would say.</p>
</blockquote>
<p>functions have (sometimes evocative) names, which IMO makes them a lot more explicit than <code>as</code>. <code>as</code> says nothing about what is converted to what and how.<br>
we also have things like <code>cast</code> on pointers as an explicitly named alternative to <code>as</code>. and that is useful, e.g. it avoids accidentally casting a const raw ptr to/from a mutable raw ptr.</p>



<a name="275853647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275853647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275853647">(Mar 18 2022 at 19:46)</a>:</h4>
<p>The obvious would be the non-arch-specific, that we could introduce in conformance with LLVM.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// # Safety</span>
<span class="sd">/// The argument must be a value created directly from a cast pointer-to-usize.</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_ptr_addr</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"></span>
</code></pre></div>
<p>This is rather restrictive in usage but allows to transition those casts which we all deem inherently sound away from <code>as</code>, freeing up some budget for the semantics of <code>as</code> implementation. At least conceptually. But other functions may perform their pointer cast with explicitly different methods, e.g. cast through non-integral pointers whenever LLVM actually agrees on what that means</p>



<a name="275853949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275853949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275853949">(Mar 18 2022 at 19:49)</a>:</h4>
<p>Doing this via explicit functions gets an explicit affirmation by the programmer that those are the semantics that they meant to assert. This is better than <code>as</code> which must be generic enough to cover all possible uses. This hurts the optimizer. The previously mentioned alloc-semantics can't be implemented with as because it can not assume non-aliasing (by itself). A new <code>unsafe fn</code> could have a precondition that requires non-aliasing with any existing pointers (exact semantics to be determined, this one might be too strict).</p>



<a name="275854966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275854966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275854966">(Mar 18 2022 at 19:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229913">HeroicKatora</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded/near/275853647">said</a>:</p>
<blockquote>
<p>The obvious would be the non-arch-specific, that we could introduce in conformance with LLVM.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// # Safety</span>
<span class="sd">/// The argument must be a value created directly from a cast pointer-to-usize.</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_ptr_addr</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"></span>
</code></pre></div>
<p>This is rather restrictive in usage but allows to transition those casts which we all deem inherently sound away from <code>as</code>, freeing up some budget for the semantics of <code>as</code> implementation. At least conceptually. But other functions may perform their pointer cast with explicitly different methods, e.g. cast through non-integral pointers whenever LLVM actually agrees on what that means</p>
</blockquote>
<p>that is exactly the kind of roundtrip we are hoping to discourage though :)</p>



<a name="275859212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275859212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275859212">(Mar 18 2022 at 20:33)</a>:</h4>
<p>yeah that <code>fn</code> is not fun for mmio.</p>



<a name="275861657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275861657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> HeroicKatora <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275861657">(Mar 18 2022 at 20:57)</a>:</h4>
<p>Discouarging is fine, and I do believe this would actually help with that. The motivating case of known external address could not soundly use this function; by design. Because conversely, whatever means we would add to permit MMIO can be forbidden to be used for ptr2int2ptr. This ties into the post-condition interpretation: currently the optimizer-known post-conditions of int2ptr-<code>as</code> is the union of all those different ways of divining a pointer, because there is no way to introspect between the cases in the virtual machine—effectively though this implies there are no known post-conditions. </p>
<p>For the set of argument-output pairs, we'd like to restrict it to a dependent sum of 'ways to create pointers' to 'some post condition of the so-created pointer result' but with <code>as</code> in its form there is no way to reliably <em>distinguish</em> between the input cases in the VM semantics (as integers don't get provenance). And so we can approximate this set only as the cross product of all inputs/outputs—which provides no useful information. What I'm asking with different functions is for the <em>programmer</em> to do (at least part of) this case distinction for us.</p>
<p>Doesn't it get significantly easier to add more restrictive and proper MIR/LLVM treatment (and semantics) to at least some of non-ptr2int2ptr cases if the separate use-cases go through different symbols and intrinsics? Can't different symbols also be linted differently, with regards to discouraging/edition changes? The hypothetical <code>unsafe fn alloc_from_mmio(usize) -&gt; *const u8</code> (with little regard to semantics) could actually be allowed to have post-conditions. For example, 'the pointer mustn't alias any existing pointer.'.</p>



<a name="275862286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275862286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275862286">(Mar 18 2022 at 21:02)</a>:</h4>
<p>I see these functions as having a distinction w/o a difference under PVNI-ae.</p>



<a name="275862425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275862425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275862425">(Mar 18 2022 at 21:03)</a>:</h4>
<blockquote>
<p>Doesn't it get significantly easier to add more restrictive and proper MIR/LLVM treatment (and semantics) to at least some of non-ptr2int2ptr cases if the separate use-cases go through different symbols and intrinsics?</p>
</blockquote>
<p>Not really... the moment roundtrips exist at all, it doesn't matter how they are exposed. they infect everything.</p>



<a name="275862434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275862434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275862434">(Mar 18 2022 at 21:03)</a>:</h4>
<p>I can't see either function being implemented uniquely on lccc at least, and I'd imagine a similar story from llvm and gcc.</p>



<a name="275862540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275862540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275862540">(Mar 18 2022 at 21:04)</a>:</h4>
<p>So you'd have undefined behaviour for the sake of being pedantic about this distinction.</p>



<a name="275862786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275862786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275862786">(Mar 18 2022 at 21:06)</a>:</h4>
<p>or we'd have UB for the sake of a sane future we might one day be able to wake up in</p>



<a name="275863008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275863008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275863008">(Mar 18 2022 at 21:08)</a>:</h4>
<p>Alas, unless you can convice WG14 and WG21 to break a ton of legacy C and C++ code, I doubt that future will ever come, at least for the three I mentioned.</p>



<a name="275863138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275863138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275863138">(Mar 18 2022 at 21:10)</a>:</h4>
<p>Although I suppose rust implementation <em>foo</em> could exploit the UB by virtue of solely being a rust implementation.</p>



<a name="275924619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275924619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275924619">(Mar 19 2022 at 19:06)</a>:</h4>
<p>if GCC/LLVM ever sort out their mess here I am curious how the result will look. but I wouldn't want to bet the sanity of a Rust spec on that happening any time soon... (and no, PNVI is not enough, it fails to account for <code>restrict</code> which makes everything a lot more complicated)</p>



<a name="275986410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%22creative%22%20Rust%20in%20embedded/near/275986410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded.html#275986410">(Mar 20 2022 at 20:37)</a>:</h4>
<p>I still would like to hear a more full example of how <code>restrict</code> breaks PNVI! Even though I agree.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>