<html>
<head><meta charset="utf-8"><title>Integer load/stores which ignore provenance · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html">Integer load/stores which ignore provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278492713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278492713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278492713">(Apr 10 2022 at 22:17)</a>:</h4>
<p>Relating to <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286">https://github.com/rust-lang/unsafe-code-guidelines/issues/286</a>, what happens if we let integer loads strip provenance and integer stores leave provenance untouched. That lets us remove a dummy integer load followed by a store.</p>



<a name="278492896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278492896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278492896">(Apr 10 2022 at 22:22)</a>:</h4>
<p>If type punning between pointers with provenance and integers are done, you could be left with stale provenances in memory, which is a bit odd. I can't tell if there's an issue with that.</p>



<a name="278493468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278493468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278493468">(Apr 10 2022 at 22:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance/near/278492713">said</a>:</p>
<blockquote>
<p>Relating to <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286">https://github.com/rust-lang/unsafe-code-guidelines/issues/286</a>, what happens if we let integer loads strip provenance and integer stores leave provenance untouched. That lets us remove a dummy integer load followed by a store.</p>
</blockquote>
<p>Integer stores can't really leave provenance untouched - integers values don't ever have provenance</p>



<a name="278493480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278493480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278493480">(Apr 10 2022 at 22:39)</a>:</h4>
<p>As in they don't change the provenance already stored in memory. So they don't clear it.</p>



<a name="278493533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278493533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278493533">(Apr 10 2022 at 22:40)</a>:</h4>
<p>That would be <em>disastrously</em> bad I think. This means that before <code>x = 5;</code>, <code>x</code> is not dead</p>



<a name="278493687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278493687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278493687">(Apr 10 2022 at 22:44)</a>:</h4>
<p>Its integer value would be dead, which may be what matters if <code>x</code> is an integer. It's does seem a bit wacky though, and <code>memcpy</code> would clear provenance in cases where stores wouldn't.</p>



<a name="278493768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278493768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278493768">(Apr 10 2022 at 22:46)</a>:</h4>
<p>What I mean is that the values in the memory backing <code>x</code> are not dead, which is the actual property we need to eliminate dead stores</p>



<a name="278494149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278494149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278494149">(Apr 10 2022 at 22:56)</a>:</h4>
<p>Say you have <code>x = 4; x = 5;</code>, you could still remove <code>x = 4;</code> since the integer value is dead. You'd need to mix in types with provenance to cause issues.</p>



<a name="278495995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278495995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278495995">(Apr 10 2022 at 23:46)</a>:</h4>
<p>why would you ever want that behavior...??</p>



<a name="278496002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278496002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278496002">(Apr 10 2022 at 23:47)</a>:</h4>
<p>if loads strip provenance (without exposing it!), we can optimize them and remove dead loads just like now</p>



<a name="278496425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278496425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278496425">(Apr 10 2022 at 23:58)</a>:</h4>
<p>You'd be left with say a <code>erase_provinence</code> instruction though right? I was just curious to see if that could be avoided.</p>



<a name="278497250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278497250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278497250">(Apr 11 2022 at 00:16)</a>:</h4>
<p>no, if there's no expose you are not left with anything</p>



<a name="278497277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278497277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278497277">(Apr 11 2022 at 00:17)</a>:</h4>
<p>you do have to be careful when removing a "store of the value that was just loaded", but doing that means <em>more</em> provenance is preserved which <em>usually</em> should only mean less UB, not more</p>



<a name="278497964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer%20load/stores%20which%20ignore%20provenance/near/278497964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Integer.20load.2Fstores.20which.20ignore.20provenance.html#278497964">(Apr 11 2022 at 00:32)</a>:</h4>
<p>Ah right. I guess this model not useful then.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>