<html>
<head><meta charset="utf-8"><title>Does wrapping_offset fizzle in cherry soda? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html">Does wrapping_offset fizzle in cherry soda?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276124777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276124777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276124777">(Mar 21 2022 at 23:02)</a>:</h4>
<p>Apparently <code>wrapping_offset</code> would in actual practice almost never break on CHERI:<br>
<a href="https://twitter.com/arichardson___/status/1506041671670284295">https://twitter.com/arichardson___/status/1506041671670284295</a><br>
<a href="https://twitter.com/arichardson___/status/1506042840425635844">https://twitter.com/arichardson___/status/1506042840425635844</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/arichardson___/status/1506041671670284295"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/01d2ec0d00cc478291d0d76be7347c373bcf1834/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313530363032363830303933333232303335342f66315f7450684a4c5f6e6f726d616c2e706e67"></a><p><a href="https://twitter.com/Gankra_">@Gankra_</a> <a href="https://twitter.com/brooksdavis">@brooksdavis</a> <a href="https://twitter.com/workingjubilee">@workingjubilee</a> <a href="https://twitter.com/MSpondee">@MSpondee</a> <a href="https://twitter.com/clarfonthey">@clarfonthey</a> I believe the last time we gathered those statistics was running the full FreeBSD testsuite using QEMU to log the out-of-bounds pointers: 155214 were out-of-bounds by more than one byte. 1205 pointed past the end and 81% were at most sizeof(void*) beyond
the bounds.</p><span>- Alex Richardson (@arichardson___)</span></div></div><div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/arichardson___/status/1506042840425635844"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/01d2ec0d00cc478291d0d76be7347c373bcf1834/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313530363032363830303933333232303335342f66315f7450684a4c5f6e6f726d616c2e706e67"></a><p><a href="https://twitter.com/Gankra_">@Gankra_</a> <a href="https://twitter.com/brooksdavis">@brooksdavis</a> <a href="https://twitter.com/workingjubilee">@workingjubilee</a> <a href="https://twitter.com/MSpondee">@MSpondee</a> <a href="https://twitter.com/clarfonthey">@clarfonthey</a> We now have a lot more software running on CheriBSD than back in early 2019 and the QEMU instrumentation still exists so it might be worth running that analysis again with something like e.g. a KDE desktop environment.</p><span>- Alex Richardson (@arichardson___)</span></div></div>



<a name="276127985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276127985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276127985">(Mar 21 2022 at 23:43)</a>:</h4>
<p>And reduplicating it over here:</p>
<blockquote>
<h3>CheriBSD kernel</h3>
<p>An extended version of the FreeBSD operating system whose kernel can be<br>
compiled either as hybrid-capability or pure-capability code, offering different degrees<br>
of kernel memory protection. The CheriBSD kernel is also able to host legacy, hybrid-<br>
capability, and pure-capability userspace environments. The pure-capability process en-<br>
vironment is known as CheriABI, and is a new OS ABI based on ubiquitous userspace use<br>
of architectural capabilities. CheriBSD is also able to offer optional temporal memory<br>
safety for (non-stack) allocations in pure-capability userspace applications. In addition,<br>
CheriBSD provides a libcheri intra-process compartmentalization framework, which<br>
allows library-like components to operate in compartments within a larger application<br>
process.</p>
<h3>CheriBSD hybrid userspace</h3>
<p>An extended version of the FreeBSD userspace that is mini-<br>
mally modified to support hybrid-capability code execution, including modest additions<br>
to the C runtime (CRT) and system libraries (including libc).</p>
<h3>CheriBSD CheriABI userspace</h3>
<p>An extended version of the FreeBSD userspace that supports<br>
pure-capability execution, with modest further extensions.</p>
<h3>CheriBSD applications</h3>
<p>A set of extended applications able to operate in the CheriABI pro-<br>
cess environment, including integrated FreeBSD programs such as OpenSSH, and also<br>
third-party applications such as Apple’s WebKit and the PostgreSQL database. These all<br>
operate with full spatial, referential, and temporal memory safety.</p>
</blockquote>



<a name="276129416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276129416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276129416">(Mar 22 2022 at 00:03)</a>:</h4>
<p>So the idea that CHERI fundamentally is incompatible with real practices in existing software and thus provides a significant barrier to mental models or use is... questionable at best. It is, yes, annoying that we have to roll back a line of documentation, but the documentation was incorrect and probably incorrect even according to the LLVM semantics we were compiling to, not just CHERI. As mentioned here:</p>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276110058">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109846">said</a>:</p>
<blockquote>
<p>so functionally, the problem with <code>wrapping_offset</code> is that, according to LLVM semantics, it creates a possibly-invalid pointer the moment we touch it, so we probably were wrong to say that it's a no-op to put it back in place.</p>
</blockquote>
<p>yeah I think this is the crux of it. calling it <code>wrapping_</code> suggests modular arithmetic which... I'm not sure LLVM <em>requires</em>?</p>
</blockquote>



<a name="276129791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276129791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276129791">(Mar 22 2022 at 00:08)</a>:</h4>
<p>oh right I meant to look that up, 'sec</p>



<a name="276129816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276129816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276129816">(Mar 22 2022 at 00:09)</a>:</h4>
<p>ah it does say two's complement, fair enough <a href="https://llvm.org/docs/GetElementPtr.html#what-happens-if-a-gep-computation-overflows">https://llvm.org/docs/GetElementPtr.html#what-happens-if-a-gep-computation-overflows</a></p>



<a name="276130071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276130071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276130071">(Mar 22 2022 at 00:13)</a>:</h4>
<p>The tragedy is that pointer provenance is in fact about things like "pointers have history and remember where they came from". And so the assumption that <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> is a no-op fails <em>in the presence of pointers having history</em>, which means that we have in fact actually added two entries to the pointer's history. Of course, most of the time, we can ignore these.</p>



<a name="276131118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276131118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276131118">(Mar 22 2022 at 00:31)</a>:</h4>
<p>one scenario i wonder about here is the idea of cramming pointers into NaNs- doing that while keeping provenance involves upper bit tagging, which seems like it might hit cheri limits? does anybody happen to know if the stuff they ported includes spidermonkey or webkit or luajit or anything? if so maybe they just use a fallback mode (since idk if cheri even has enough available upper bits like x86-64, which is itself on thin ice here lol)?</p>



<a name="276131241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276131241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276131241">(Mar 22 2022 at 00:33)</a>:</h4>
<p>if there are enough upper bits i imagine some of those could even treat their heap like an arena and keep 64-bit values</p>



<a name="276131325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276131325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276131325">(Mar 22 2022 at 00:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="117495">rpjohnst</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276131118">said</a>:</p>
<blockquote>
<p>one scenario i wonder about here is the idea of cramming pointers into NaNs- doing that while keeping provenance involves upper bit tagging, which seems like it might hit cheri limits? does anybody happen to know if the stuff they ported includes spidermonkey or webkit or luajit or anything?</p>
</blockquote>
<p>yes.</p>
<blockquote>
<h3>CheriBSD applications</h3>
<p>A set of extended applications able to operate in the CheriABI pro-<br>
cess environment, including integrated FreeBSD programs such as OpenSSH, and also<br>
third-party applications such as <strong>Apple’s WebKit</strong> and the PostgreSQL database. These all<br>
operate with full spatial, referential, and temporal memory safety.</p>
</blockquote>



<a name="276131661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276131661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276131661">(Mar 22 2022 at 00:41)</a>:</h4>
<p>I have no idea what exactly they do but I suspect it has a lot to do with using arena allocation kinds of strategies and thus retaining a pointer that has the necessary privileges to all the possible locations.</p>



<a name="276132127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276132127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276132127">(Mar 22 2022 at 00:50)</a>:</h4>
<p>note that webkit doesn't actually NaN Box</p>



<a name="276132138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276132138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276132138">(Mar 22 2022 at 00:50)</a>:</h4>
<p>it int-boxes</p>



<a name="276132163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276132163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276132163">(Mar 22 2022 at 00:51)</a>:</h4>
<p>They have a 31-bit integer type that gets tag-unioned with pointers</p>



<a name="276132393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276132393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276132393">(Mar 22 2022 at 00:56)</a>:</h4>
<p>aha.</p>



<a name="276133232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276133232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276133232">(Mar 22 2022 at 01:12)</a>:</h4>
<p>Ah, I am reminded of another conversation:<br>
When Rust runs on a virtual guest, the virtual host has kind of arbitrary power to force majeure the program even if it emits completely "normal" instructions. Indeed, in general, most processors that Rust compiles for can have even "normal" load instructions configured to trap by the host.</p>



<a name="276133426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276133426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276133426">(Mar 22 2022 at 01:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276132127">said</a>:</p>
<blockquote>
<p>note that webkit doesn't actually NaN Box</p>
</blockquote>
<p>This seems like they're still nan-boxing: <a href="https://github.com/WebKit/WebKit/blob/main/Source/JavaScriptCore/runtime/JSCJSValue.h#L394-L454">https://github.com/WebKit/WebKit/blob/main/Source/JavaScriptCore/runtime/JSCJSValue.h#L394-L454</a></p>
<p>It's not the same scheme as other implementations, but it's still taking advantage of the NaN space to encode a pointer or float in 64 bits both.</p>



<a name="276133495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276133495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276133495">(Mar 22 2022 at 01:18)</a>:</h4>
<p>oh whoops, sorry specifically <em>chrome</em> doesn't, and my brain mapped webkit to chrome, which is wrong on many levels</p>



<a name="276731493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276731493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276731493">(Mar 26 2022 at 15:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276130071">said</a>:</p>
<blockquote>
<p>The tragedy is that pointer provenance is in fact about things like "pointers have history and remember where they came from". And so the assumption that <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> is a no-op fails <em>in the presence of pointers having history</em>, which means that we have in fact actually added two entries to the pointer's history. Of course, most of the time, we can ignore these.</p>
</blockquote>
<p>I beg to differ; "pointers having history" does not mean "the pointers history includes all past values that lead here".<br>
provenance is a <em>very specific kind of history</em>, and <code>wrapping_offset</code> is specifically defined to not alter that history. so <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> ought to be a NOP.</p>
<p>so, I do agree with the concern that this makes CHERI a technically non-conforming implementation. and this is not the same as adding <code>abort()</code> somewhere in the stdlib, since this makes instructions abort <em>that LLVM would be allowed to assume will never abort</em>. silly example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">uwu</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="n">HUGE</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="n">HUGE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr2</span>:
  <span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>LLVM is allowed to move the <code>*ptr2</code> out of the conditional, since it is the same as <code>ptr</code> and that ptr was already dereferenced. However, in CHERI that transformation would introduce a fault into a non-faulty program (if <code>b</code> is <code>false</code>).</p>
<p>That said, the worst thing this platform quirk can do is introduce an unexpected fault. In that sense it is a lot less severe than some of our floating point quirks where computations can produce <em>incorrect results</em> on some targets (where "correct" = strictly what IEEE says).<br>
So the formal methods person inside me cries out loud because the compilation of <code>wrapping_offset</code> is simply <em>incorrect</em> and there is no papering over that, some other part of me just dies a little more inside and adds this to the list of things that make computers broken.</p>
<p>But indeed if CHERI becomes supported this should definitely be documented.</p>



<a name="276735486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276735486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276735486">(Mar 26 2022 at 17:05)</a>:</h4>
<p>I agree this restriction of CHERI is not nice from a conceptual and formal methods point of view, but in most cases it should be possible to fold the multiple offsets into a value that does not go beyond the representable bounds. The example above would only fault without optimization, but obviously we can also come up with one that actually breaks with optimization. I'm not convinced those cases really occur in the real world (based on porting all sorts of software to run on CheriBSD, including PostgreSQL, WebKit, X11, the FreeBSD kernel, etc.)</p>



<a name="276735896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276735896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276735896">(Mar 26 2022 at 17:14)</a>:</h4>
<p><span class="user-mention" data-user-id="473929">@Alexander Richardson</span> I have seen speculation that CHERI might be able to handle high-bit-tagging because e.g. ARM has explicit extensions/support for this. Can you confirm/deny?</p>



<a name="276735911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276735911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276735911">(Mar 26 2022 at 17:15)</a>:</h4>
<p>(semantically high-bit-tagging is just an enormous offset, right?)</p>



<a name="276735997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276735997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276735997">(Mar 26 2022 at 17:17)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> in arm's Morello implementation the bounds only cover the lower 56 bits so you can still use TBI to put whatever you want in the high bits. On CHERI-RISCV setting the high bits results in an enormous offset that will probably be beyond the representable bounds except for full address space bounds.</p>



<a name="276736003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276736003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276736003">(Mar 26 2022 at 17:17)</a>:</h4>
<p>But TBI-like features might be added in the future, we have to see what happens with the RISC-V pointer masking proposal</p>



<a name="276736508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276736508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276736508">(Mar 26 2022 at 17:29)</a>:</h4>
<p><span class="user-mention" data-user-id="473929">@Alexander Richardson</span> this probably still <em>wouldn't</em> allow for the cute trick in rustc right now where they actually <em>SHIFT</em> the entire pointer down to tag the "high" bits that are actually the low bits (because undoing it vaguely it optimizes better to x64/arm addressing modes)</p>



<a name="276736755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276736755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276736755">(Mar 26 2022 at 17:34)</a>:</h4>
<p>also it would be interesting to hear if you've taken a crack at Chromium's "smi" stuff --  <a href="https://v8.dev/blog/pointer-compression">https://v8.dev/blog/pointer-compression</a></p>



<a name="276736844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276736844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276736844">(Mar 26 2022 at 17:36)</a>:</h4>
<p>A shift will be converted to setaddr(shift addr, X). However Morello has a SCFLGS instruction to set the high 8 bits while retaining all other bits</p>



<a name="276736867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276736867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276736867">(Mar 26 2022 at 17:36)</a>:</h4>
<p>so rustc doesn't need to fix it's wild code?</p>



<a name="276737031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276737031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276737031">(Mar 26 2022 at 17:40)</a>:</h4>
<p>Regarding pointer compression, our view is that some language runtimes might want that to reduce memory overhead. In that case you can use 64 or 32 bit pointers and have loads be relative to a JS heap capability. You lose some bounds checking on those pointers but at least they can only corrupt other managed objects but none of the engine internals.</p>



<a name="276737054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276737054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276737054">(Mar 26 2022 at 17:40)</a>:</h4>
<p>I'd have to see the code first, not entirely sure if it's safe</p>



<a name="276737224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276737224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276737224">(Mar 26 2022 at 17:44)</a>:</h4>
<p><span class="user-mention" data-user-id="473929">@Alexander Richardson</span> in case you mean the rustc code, it's this: <a href="https://github.com/rust-lang/rust/pull/75590/files#diff-e60b36ce401c8219a469dbd39e3483bb58d32281e562163dc4232b6cca0240e5R61">https://github.com/rust-lang/rust/pull/75590/files#diff-e60b36ce401c8219a469dbd39e3483bb58d32281e562163dc4232b6cca0240e5R61</a></p>



<a name="276738268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276738268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276738268">(Mar 26 2022 at 18:08)</a>:</h4>
<p>Thanks, looking at it briefly it seems like that implementation won't always work with CHERI since the pointer address will go quite far out of bounds. But I am still very new to rust syntax and semantics so I could be mis-parsing some of it. Nevertheless I think it should be easy enough to use the low bits for CHERI enabled architectures instead.</p>



<a name="276738281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276738281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276738281">(Mar 26 2022 at 18:08)</a>:</h4>
<p>Or the high 8 bits for morello without shifting the pointer</p>



<a name="276738352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276738352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276738352">(Mar 26 2022 at 18:10)</a>:</h4>
<p>I am extremely keen to try and get rustc working for CHERI and I will hopefully have a bit more time to play around with it soon.</p>



<a name="276739787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276739787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276739787">(Mar 26 2022 at 18:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="473929">Alexander Richardson</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276736844">said</a>:</p>
<blockquote>
<p>A shift will be converted to setaddr(shift addr, X).</p>
</blockquote>
<p>and I assume that invalidates the ptr if it moves too far OOB?</p>



<a name="276740444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276740444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276740444">(Mar 26 2022 at 19:00)</a>:</h4>
<p>Yes exactly</p>



<a name="276741659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276741659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276741659">(Mar 26 2022 at 19:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276731493">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276130071">said</a>:</p>
<blockquote>
<p>The tragedy is that pointer provenance is in fact about things like "pointers have history and remember where they came from". And so the assumption that <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> is a no-op fails <em>in the presence of pointers having history</em>, which means that we have in fact actually added two entries to the pointer's history. Of course, most of the time, we can ignore these.</p>
</blockquote>
<p>I beg to differ; "pointers having history" does not mean "the pointers history includes all past values that lead here".<br>
provenance is a <em>very specific kind of history</em>, and <code>wrapping_offset</code> is specifically defined to not alter that history. so <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> ought to be a NOP.</p>
<p>so, I do agree with the concern that this makes CHERI a technically non-conforming implementation. and this is not the same as adding <code>abort()</code> somewhere in the stdlib, since this makes instructions abort <em>that LLVM would be allowed to assume will never abort</em>. silly example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">uwu</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="n">HUGE</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="n">HUGE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr2</span>:
  <span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>LLVM is allowed to move the <code>*ptr2</code> out of the conditional, since it is the same as <code>ptr</code> and that ptr was already dereferenced. However, in CHERI that transformation would introduce a fault into a non-faulty program (if <code>b</code> is <code>false</code>).</p>
<p>That said, the worst thing this platform quirk can do is introduce an unexpected fault. In that sense it is a lot less severe than some of our floating point quirks where computations can produce <em>incorrect results</em> on some targets (where "correct" = strictly what IEEE says).<br>
So the formal methods person inside me cries out loud because the compilation of <code>wrapping_offset</code> is simply <em>incorrect</em> and there is no papering over that, some other part of me just dies a little more inside and adds this to the list of things that make computers broken.</p>
<p>But indeed if CHERI becomes supported this should definitely be documented.</p>
</blockquote>
<p>IMO I agree with you that it <strong>ought</strong> to be a NOP.<br>
and only half joking: it sure would be if we guaranteed the optimization.</p>



<a name="276743233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276743233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276743233">(Mar 26 2022 at 20:04)</a>:</h4>
<p>I discussed this with Alexander a bit more in private, so to clarify: in terms of <em>addr</em> it is coherent. They made sure that when the compression falls over if corrupts the metadata and not the address. And I believe they guarantee that if you offset back the whole 128-bit pointer will have the same bit representation. Just the validity bit will be corrupt because it's sticky. This is still unfortunate but... It Could Have Been Worse</p>



<a name="276743386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276743386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276743386">(Mar 26 2022 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> said:</p>
<blockquote>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">uwu</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="n">HUGE</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="n">HUGE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr2</span>:
  <span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>I'm not so sure this can actually cause an incorrect fault? (Although I am very unfamiliar with LLVM internals, so this is a shot in the dark.)<br>
From earlier in this thread, it was implied that GEP (without inbounds) makes LLVM no longer "trust" a pointer (because it would've gone out of bounds). If this is true, if <code>ptr2</code> has been offset to lose its capability, it's lost its "trusted" status in LLVM, thus LLVM won't spuriously dereference it.<br>
Or IOW, I <em>think</em> the only way LLVM will lift the access is if it proves <code>ptr == ptr2</code>, in which case it will use <code>ptr</code>, not <code>ptr2</code>.<br>
... Well I suppose it could use <code>ptr2</code>, which would fault, since they're equal, so I'm wrong, but also, it's already proved it can use the less prior work value, so it should be using that one</p>



<a name="276743426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276743426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276743426">(Mar 26 2022 at 20:09)</a>:</h4>
<p>Theoretically (assuming the bit about GEP not inbounds is correct) this is something you could teach LLVM to avoid miscompiling, by only lifting the actually trusted ptr</p>



<a name="276746798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746798">(Mar 26 2022 at 21:29)</a>:</h4>
<p><span class="user-mention" data-user-id="132829">@Christopher Durham</span> that "trust" part is just how LLVM currently implements its analyses. It's irrelevant, what we care about is what LLVM (or MIR opts) <em>would be allowed to do</em> under the spec.</p>



<a name="276746844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746844">(Mar 26 2022 at 21:30)</a>:</h4>
<p>and I'd totally sign off on a MIR pass that replaces <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> by <code>ptr</code></p>



<a name="276746859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746859">(Mar 26 2022 at 21:30)</a>:</h4>
<p>and it is very possible that LLVM has peephole optimizations like that (but I don't know if it does, and it is not relevant for the argument)</p>



<a name="276746869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746869">(Mar 26 2022 at 21:30)</a>:</h4>
<p>But that wouldn't cause a trap to occur where it wouldn't otherwise<br>
It would only cause code which would trap due to platform limitations to succeed</p>



<a name="276746899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746899">(Mar 26 2022 at 21:31)</a>:</h4>
<p>Or am I misunderstanding your concern</p>



<a name="276746960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746960">(Mar 26 2022 at 21:32)</a>:</h4>
<p>oh right. I got my polarity wrong.<br>
the entire argument also works with a compiler that 'optimizes' <code>ptr</code> into <code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> but even I will accept that is a stretch. ;) it's still formally a correct argument though.</p>



<a name="276746997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276746997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276746997">(Mar 26 2022 at 21:33)</a>:</h4>
<p>I think the counterargument to that is that the compiler "just shouldn't do that" if it's targeting a platform where that could trap</p>



<a name="276747001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747001">(Mar 26 2022 at 21:33)</a>:</h4>
<p>But I'm not well versed in formal methods so I'll leave it there</p>



<a name="276747257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747257">(Mar 26 2022 at 21:39)</a>:</h4>
<p>i think the only really sketchy thing is if someone was writing platform-specific code and <em>semantically relying</em> on the fact that a really big offset would result in a downstream trap (but still getting the pointer back in bounds before the read), and that we scupper it by optimizing out the transiently bad offset</p>
<p>that could would be uh.... """interesting""" code to say the least</p>



<a name="276747486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747486">(Mar 26 2022 at 21:45)</a>:</h4>
<p>Oh so what you're saying is that you could codegen bounds checks on arrays in CHERI using wrapping_offset?</p>



<a name="276747538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747538">(Mar 26 2022 at 21:46)</a>:</h4>
<p>Or like. A cursed version of the assert about an array length before doing a bunch of access</p>



<a name="276747706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747706">(Mar 26 2022 at 21:50)</a>:</h4>
<p>that is clearly just wrong though, like relying on any kind of target machine behavior that is not part of the Abstract Machine</p>



<a name="276747718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747718">(Mar 26 2022 at 21:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276747486">said</a>:</p>
<blockquote>
<p>Oh so what you're saying is that you could codegen bounds checks on arrays in CHERI using wrapping_offset?</p>
</blockquote>
<p>that's not even sufficient because e.g. on Morello you have <em>at minimum</em> 1KB of "it's fine to offset into here" space. It would have to be some Very Special code to organically trigger this. Maybe just code that tries to write garbage to the pointer and then undo it so it's Not UB.</p>



<a name="276747737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747737">(Mar 26 2022 at 21:51)</a>:</h4>
<p>I am not saying such code is Good but I think it's fair to say folding of wrapping_offset is... Underspecified from Rust's side</p>



<a name="276747778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747778">(Mar 26 2022 at 21:52)</a>:</h4>
<p>no it's pretty clear on the Rust side I think</p>



<a name="276747781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747781">(Mar 26 2022 at 21:52)</a>:</h4>
<p>it's just incorrectly implemented by the CHERI backend</p>



<a name="276747821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/276747821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#276747821">(Mar 26 2022 at 21:53)</a>:</h4>
<p>yeah i'd accept that argument</p>



<a name="278376072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/278376072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#278376072">(Apr 09 2022 at 00:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/276114955">said</a>:</p>
<blockquote>
<p>I think, often, "make that more contained" gets conflated with "make that impossible", and I'm in favor of the former as long as we don't do the latter.</p>
</blockquote>
<p>Or breaking existing x86-64 code, right? i.e. don't introduce optimizations on x86-64 that assume strict provenance.</p>



<a name="278376251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/278376251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#278376251">(Apr 09 2022 at 00:07)</a>:</h4>
<p>(It sounds like the tower of weakenings implies introducing strict provenance alongside a commitment to not breaking existing code on x86-64 via new optimizations that assume strict provenance, which is a place I'd be very happy with.)</p>



<a name="278376672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/278376672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#278376672">(Apr 09 2022 at 00:16)</a>:</h4>
<p>iiuc existing code won't break but it may take an optimization hit in some cases</p>



<a name="278379975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/278379975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#278379975">(Apr 09 2022 at 01:27)</a>:</h4>
<p>I dont think we should special case any architecture like x86-64, but I also don't see why</p>



<a name="278380035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20wrapping_offset%20fizzle%20in%20cherry%20soda%3F/near/278380035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F.html#278380035">(Apr 09 2022 at 01:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="117495">rpjohnst</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F/near/278376672">said</a>:</p>
<blockquote>
<p>iiuc existing code won't break but it may take an optimization hit in some cases</p>
</blockquote>
<p>in the sense of, currently some of the optimizations we do are <em>wrong</em> and if we want to fix that then code not using strict provenance will probably get fewer optimizations -- yes</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>