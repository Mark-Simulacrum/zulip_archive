<html>
<head><meta charset="utf-8"><title>can you transmute_copy `*mut c_void` to a fn pointer type? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html">can you transmute_copy `*mut c_void` to a fn pointer type?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258905291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258905291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258905291">(Oct 24 2021 at 23:59)</a>:</h4>
<p>The question is as per the title: can you <code>transmute_copy(&amp;p)</code> where <code>p</code> is a <code>*mut c_void</code> and the output type is some function pointer type.</p>



<a name="258905605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258905605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258905605">(Oct 25 2021 at 00:06)</a>:</h4>
<p>(and to be clear, I know that the rust type system allows it to happen, but I'm also aware of the pointer/integer transmute problems, and so I'm wondering if those apply to pointer to fn pointer transmutes)</p>



<a name="258905891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258905891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258905891">(Oct 25 2021 at 00:14)</a>:</h4>
<p>it would be a very big problem if that didn't work, since then dlsym/GetProcAddress doesn't work anymore.</p>



<a name="258905917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258905917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258905917">(Oct 25 2021 at 00:15)</a>:</h4>
<p>there's no non-transmute way to do that conversion, so transmute has to be acceptable</p>



<a name="258906048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258906048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258906048">(Oct 25 2021 at 00:18)</a>:</h4>
<p>I've used transmute before, and in fact that's how i'm currently using it now for this project, but is there any difference when using transmute_copy (i hope not, it would simplify my code a lot)</p>



<a name="258906776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258906776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258906776">(Oct 25 2021 at 00:37)</a>:</h4>
<p>For reference, C standard does permit this, POSIX allows the conversion between <code>void*</code> to/from function pointer as an extension to the C language.</p>



<a name="258906835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258906835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258906835">(Oct 25 2021 at 00:38)</a>:</h4>
<p>There might be platforms that have distinct data and function pointrers (if they have no intention to ever support POSIX)</p>



<a name="258907097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907097">(Oct 25 2021 at 00:45)</a>:</h4>
<p>well, as Thom said, <code>transmute</code> between <code>*mut c_void</code> and function pointer must be allowed or like... all of dynamic function loading is just broken. So I trust that much to work.</p>
<p>However, in this case, I've got many (about 200) function pointers to load, and I'd like to conceptually compress it a bit by using a helper function that takes in the <code>*mut c_void</code>, checks for known-bad values, and then if things are fine it does a <code>transmute_copy</code> to <code>Option&lt;my_fn_ptr&gt;</code>. Since each function pointer is a distinct type, this helper must be generic, and since it's generic i have to use <code>transmute_copy</code> rather than <code>transmute</code>.</p>
<p>I'm vaguely of the understanding that <code>transmute</code> works "like a union read" and <code>transmute_copy</code> works "like a pointer read". And this usually isn't meaningfully different, but I just want to be extra sure because of the other ptr/int situation.</p>



<a name="258907146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907146">(Oct 25 2021 at 00:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F/near/258907097">said</a>:</p>
<blockquote>
<p>well, as Thom said, <code>transmute</code> between <code>*mut c_void</code> and function pointer must be allowed or like... all of dynamic function loading is just broken. So I trust that much to work.</p>
</blockquote>
<p>Only if the platform supports dynamic function.</p>



<a name="258907161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907161">(Oct 25 2021 at 00:47)</a>:</h4>
<p>let me rephrase: if the platform doesn't support loading functions as <code>*mut c_void</code> it's just so far outside of what this GL loader library is equipped to handle that the library can't possibly compensate, in fact the platform likely doesn't support dynamic GL loading to begin with, because GL loaders are specified to use the normal "load a function address from a dynamic library" style.</p>



<a name="258907218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907218">(Oct 25 2021 at 00:48)</a>:</h4>
<p>Well, there are no contexts beforehand..</p>



<a name="258907226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907226">(Oct 25 2021 at 00:49)</a>:</h4>
<p>right, i should have given more context at the start of the thread</p>



<a name="258907227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907227">(Oct 25 2021 at 00:49)</a>:</h4>
<p>For your particular context I would think it shall be okay.</p>



<a name="258907228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907228">(Oct 25 2021 at 00:49)</a>:</h4>
<p>but right now i've got this nonsense going on, which i'd prefer to simplify a bit<br>
<a href="/user_uploads/4715/VW6MG8LntcUFf4x6lKsdV6HB/Screenshot-2021-10-24-18.37.35.png">Screenshot-2021-10-24-18.37.35.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/VW6MG8LntcUFf4x6lKsdV6HB/Screenshot-2021-10-24-18.37.35.png" title="Screenshot-2021-10-24-18.37.35.png"><img src="/user_uploads/4715/VW6MG8LntcUFf4x6lKsdV6HB/Screenshot-2021-10-24-18.37.35.png"></a></div>



<a name="258907273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907273">(Oct 25 2021 at 00:50)</a>:</h4>
<p>You can safe guard your <code>transmute_copy</code> with an <code>assert_eq!</code></p>



<a name="258907297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907297">(Oct 25 2021 at 00:51)</a>:</h4>
<p>i do assume that it gives a bitwise identical value, but transmuting a ptr/int with that is UB because it goes through the wrong IR, even if the value is bitwise identical.</p>



<a name="258907374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907374">(Oct 25 2021 at 00:53)</a>:</h4>
<p><a href="https://rust-lang.github.io/unsafe-code-guidelines/layout/function-pointers.html">https://rust-lang.github.io/unsafe-code-guidelines/layout/function-pointers.html</a></p>



<a name="258907377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907377">(Oct 25 2021 at 00:53)</a>:</h4>
<blockquote>
<p>The ABI and layout of (unsafe)? (extern "ABI")? fn(Args...) -&gt; Ret is exactly that of the corresponding C type -- the lack of a null value does not change this. On common platforms, this means that *const () and fn(Args...) -&gt; Ret have the same ABI and layout. This is, in fact, guaranteed by POSIX and Windows.</p>
</blockquote>



<a name="258907380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907380">(Oct 25 2021 at 00:53)</a>:</h4>
<p>So I would say it's safe for your use case.</p>



<a name="258907428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907428">(Oct 25 2021 at 00:54)</a>:</h4>
<p>Use <code>transmute_copy</code> instead of <code>transmute</code> shouldn't be a problem if the size is the same.</p>



<a name="258907433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907433">(Oct 25 2021 at 00:55)</a>:</h4>
<p>well it's not a layout issue. <code>usize</code> and <code>*mut u8</code> have the same layout, but transmuting one to the other is UB, even though using <code>as</code> to convert one to the other is defined, because there's separate IR involved.</p>



<a name="258907450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907450">(Oct 25 2021 at 00:55)</a>:</h4>
<p>so i just don't want that same int/ptr transmutation problem to hit me when going from data ptr to fn ptr</p>
<p>but if transmute and transmute_copy are identical for these purposes, that's cool</p>



<a name="258907492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907492">(Oct 25 2021 at 00:56)</a>:</h4>
<p>The page does give an example of transmute and saying it's perfectly safe though.</p>



<a name="258907500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907500">(Oct 25 2021 at 00:56)</a>:</h4>
<p>convincing enough for me</p>



<a name="258907665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258907665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258907665">(Oct 25 2021 at 01:00)</a>:</h4>
<p>I presume it's platform-specific,</p>



<a name="258937639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258937639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258937639">(Oct 25 2021 at 09:56)</a>:</h4>
<p>While I agree that transmuting a "data pointer" to a "function pointer" ought to be fine for the sake of everyone's sanity, I'd also like to mention that using <code>unsafe extern "ABI" fn()</code> can be a nicer default for an "untyped function pointer" (for instance, it already mentions the desired ABI).<br>
Even better if using a technically hidden parameter; <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> maybe something like <code>unsafe extern "ABI" fn(c_void)</code>?</p>



<a name="258941276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/258941276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#258941276">(Oct 25 2021 at 10:37)</a>:</h4>
<p>Libloading uses pointer cast approach for this but that is ultimately still a transmute.</p>



<a name="259030730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259030730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259030730">(Oct 25 2021 at 22:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F/near/258906048">said</a>:</p>
<blockquote>
<p>I've used transmute before, and in fact that's how i'm currently using it now for this project, but is there any difference when using transmute_copy (i hope not, it would simplify my code a lot)</p>
</blockquote>
<p>no I think that would be horrible^^ <code>transmute</code> is just slightly safer because it checks size equality</p>



<a name="259030863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259030863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259030863">(Oct 25 2021 at 22:48)</a>:</h4>
<p>I assume the ptr here is actually a proper function pointer that was just disguised as <code>void*</code>? If so I see no way this could go wrong. The interesting questions are usually those that involve transmuting a value to some type where the value doesn't really fit that type (e.g. transmuting a ptr, which has provenance, to an integer, which does not).</p>



<a name="259030894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259030894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259030894">(Oct 25 2021 at 22:48)</a>:</h4>
<p>also you probably know that but obligatory reminder than <code>fn</code> is non-null</p>



<a name="259030947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259030947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259030947">(Oct 25 2021 at 22:49)</a>:</h4>
<p>whether transmuting <code>1usize</code> to fn is okay or not I dont think we can officially answer right now... <a href="https://github.com/rust-lang/unsafe-code-guidelines/pull/197">https://github.com/rust-lang/unsafe-code-guidelines/pull/197</a> wanted to say yes that is okay but then I got cold feet about guaranteeing any kind of "interesting" transmute^^</p>



<a name="259034878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259034878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259034878">(Oct 25 2021 at 23:43)</a>:</h4>
<p>The main issue would be when <code>size_of::&lt;*mut ()&gt;()!=size_of::&lt;fn()&gt;()</code>, but that would be ruled out by <code>transmute</code> (but not pointer casts or transmute_copy)</p>



<a name="259034975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259034975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259034975">(Oct 25 2021 at 23:44)</a>:</h4>
<p>(and of course, encountering a platform where that's the case is likely going to be rare, even infinitely extending into theoretical future supported platforms)</p>



<a name="259062439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259062439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259062439">(Oct 26 2021 at 07:49)</a>:</h4>
<p>we will need some way to convert integers to function pointers for things like calling functions at well-known potentially dynamically computed addresses, where linker symbols aren't sufficient</p>



<a name="259136617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259136617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259136617">(Oct 26 2021 at 18:00)</a>:</h4>
<p>I could imagine a platform where function pointers and data pointers have differing sizes, but at least on current windows/mac/linux the C functions used to get the function pointers at runtime are specified as returning <code>void*</code>.</p>
<p>Of course the headers could be updated when adding a new platform, blah blah blah, but the point is that the current C headers are the reason the function loader is written with <code>*mut c_void</code> as the standard "pointer to a function of an unknown signature" type.</p>
<p>Also, I would hesitate to make <code>unsafe extern "C" fn()</code> be the default data type instead, because that's immediately usable on accident. I think there's value in having to write down an additional operation to convert the <code>*mut c_void</code> to being definitely the correct type, instead of accidentally forgetting the additional conversion and using it with the wrong signature.</p>



<a name="259140762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259140762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259140762">(Oct 26 2021 at 18:32)</a>:</h4>
<blockquote>
<p>I could imagine a platform where function pointers and data pointers have differing sizes</p>
</blockquote>
<p>In practice these platforms just have the function pointer be a pointer to the static (possibly multi-word) data</p>



<a name="259140811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259140811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259140811">(Oct 26 2021 at 18:32)</a>:</h4>
<p>itanium did this. the "function pointer" was actually a pointer to the function descriptor which was 128 bits</p>



<a name="259164371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259164371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259164371">(Oct 26 2021 at 21:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F/near/259140762">said</a>:</p>
<blockquote>
<blockquote>
<p>I could imagine a platform where function pointers and data pointers have differing sizes</p>
</blockquote>
<p>In practice these platforms just have the function pointer be a pointer to the static (possibly multi-word) data</p>
</blockquote>
<p>That seems potentially inefficient if function pointers are smaller</p>



<a name="259164753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259164753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259164753">(Oct 26 2021 at 21:34)</a>:</h4>
<p>the perf can go either way, its a bit like a vtable call (saving the space in structures has a benefit). on the itanium it had some amount of architectural support too</p>



<a name="259164772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259164772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259164772">(Oct 26 2021 at 21:34)</a>:</h4>
<p>i'd be surprised if anything took a different approach in the future though. POSIX/windows compat is very important</p>



<a name="259164809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259164809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259164809">(Oct 26 2021 at 21:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F/near/259140811">said</a>:</p>
<blockquote>
<p>itanium did this. the "function pointer" was actually a pointer to the function descriptor which was 128 bits</p>
</blockquote>
<p>iirc VAX does that too...</p>



<a name="259164954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can%20you%20transmute_copy%20%60%2Amut%20c_void%60%20to%20a%20fn%20pointer%20type%3F/near/259164954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/can.20you.20transmute_copy.20.60*mut.20c_void.60.20to.20a.20fn.20pointer.20type.3F.html#259164954">(Oct 26 2021 at 21:36)</a>:</h4>
<p>16-bit x86 can have function pointers be 16/32-bits independently of data pointers being 16/32-bits</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>