<html>
<head><meta charset="utf-8"><title>Use-cases for unrestricted ptr2int2ptr · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html">Use-cases for unrestricted ptr2int2ptr</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276282515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276282515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276282515">(Mar 23 2022 at 02:44)</a>:</h4>
<p>The other threads are very long, so I'm just going to start this one to discuss any potential uses of these roundtrips that aren't transmutes (which are a big pain) or simple tagging. Some of these are addressable with changes to APIs such as <code>with_addr</code>, <code>map_addr</code>, or something like an arena allocator supporting ptr2int2ptr casts.</p>



<a name="276282762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276282762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276282762">(Mar 23 2022 at 02:48)</a>:</h4>
<p>Compressed pointers: These are used in V8, the JVM, and the purpose is to pack a 64bit pointer into 32 bits, using <code>libc:MAP_32BIT</code> or some other way of ensuring high bits are not used. The JVM and V8 implementations use an offset from some arena allocator, and such approaches probably can be ported fine.</p>
<p>There are <a href="https://users.rust-lang.org/t/32-bit-pointers-to-the-heap/58255">some uses</a> of Rust that simply truncate the top 32 bits though, and rely on a simple cast back to a pointer.</p>



<a name="276282853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276282853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276282853">(Mar 23 2022 at 02:50)</a>:</h4>
<p>User-memcpy: This is a well known issue in C, to the pointer where PNVI-ae-udi spends a good few paragraphs making sure this works. <a href="https://docs.rs/esp32-hal/latest/esp32_hal/mem/fn.memcpy.html">Rust embedded</a>, does use these semantics, but these could probably be fixed by adding some notion of <a href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151199.html">LLVM's proposed byte type</a> to Rust proper.</p>



<a name="276283089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276283089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276283089">(Mar 23 2022 at 02:55)</a>:</h4>
<ul>
<li>several unixy APIs take int args that you're supposed to cast to pointers</li>
<li>xor lists, technically</li>
<li><em>possibly</em> unwinder stuff, needs more investigation</li>
<li>ipc? swap?</li>
</ul>



<a name="276283183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276283183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276283183">(Mar 23 2022 at 02:57)</a>:</h4>
<p>Garbage collectors: I can't do this any justice better than this comment. <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/248#issuecomment-749726380">https://github.com/rust-lang/unsafe-code-guidelines/issues/248#issuecomment-749726380</a></p>
<blockquote>
<p>The garbage collected heap is a sea of aliasing, mutable pointers. Pointers are often tagged, and any object can (to a <br>
good approximation) point to any other object. Furthermore, some GC algorithms need to be able to go from one <br>
object to the object after it, even though there are no pointers from one to the other! That’s what I meant by <br>
“unbounded provenance”: I need to be able to take a usize, mask off its tag bits, and cast it into a pointer that is valid <br>
for the entire heap. I can, however, promise that there are no references into the GC heap at all, except for transient <br>
ones when dereferencing raw pointers.</p>
</blockquote>



<a name="276285760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276285760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276285760">(Mar 23 2022 at 03:56)</a>:</h4>
<p>libc backcompat: A lot of this in Rust is just libc giving up and defining stuff like <a href="https://docs.rs/libc/latest/libc/type.sighandler_t.html">sighandler_t</a> to be <code>size_t</code>, probably due to a lack of union support in Rust 1.0, and maybe due to the lack of extern types(?).</p>



<a name="276285865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276285865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276285865">(Mar 23 2022 at 03:59)</a>:</h4>
<p>Yeah that's just wrong. :|</p>



<a name="276286193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276286193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276286193">(Mar 23 2022 at 04:05)</a>:</h4>
<p>sighandler_t is a straightforward <code>Option&lt;extern fn(c_int)&gt;</code> at least on linux so I don't know why it was ever size_t</p>



<a name="276286279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276286279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276286279">(Mar 23 2022 at 04:07)</a>:</h4>
<p>(and in general it has to accept a function pointer, so I don't know if it's even a real impl-defined typedef or just "function pointer types in C syntax suck")</p>



<a name="276286365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276286365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276286365">(Mar 23 2022 at 04:08)</a>:</h4>
<p>but things like prctl just mean you just lose unless you write idiotic C wrappers</p>



<a name="276286373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276286373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276286373">(Mar 23 2022 at 04:09)</a>:</h4>
<p>meh, not the worst thing tbh.</p>



<a name="276286482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276286482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276286482">(Mar 23 2022 at 04:11)</a>:</h4>
<p>"no you can't do <code>foo(ptr.addr())</code> you have to write your own C wrapper that does literally the same thing" is kinda inexcusable</p>



<a name="276291039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276291039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276291039">(Mar 23 2022 at 05:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276283089">said</a>:</p>
<blockquote>
<ul>
<li>several unixy APIs take int args that you're supposed to cast to pointers</li>
</ul>
</blockquote>
<p>Which APIs are you thinking of here?</p>



<a name="276291095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276291095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276291095">(Mar 23 2022 at 05:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276283089">said</a>:</p>
<blockquote>
<ul>
<li>ipc? swap?</li>
</ul>
</blockquote>
<p>For both inter-process and intra-process communication, you could pass a pointer over a byte-serialized channel (e.g. a pipe), pick it up on the other end, and turn it back into a pointer. In the case of inter-process communication you'd probably want to base it on the start of your shared memory region, but I think some code just maps things to the same place in multiple address spaces.</p>
<p>Also not sure if RDMA or similar might care here.</p>



<a name="276292218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276292218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276292218">(Mar 23 2022 at 06:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276291039">said</a>:</p>
<blockquote>
<p>Which APIs are you thinking of here?</p>
</blockquote>
<p>prctl, makecontext (lol), clone3 and it looks like a few other modern linux syscalls that take pointers in a larger struct (which is relevant because it's done for layout) are what I know of offhand</p>



<a name="276292285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276292285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276292285">(Mar 23 2022 at 06:09)</a>:</h4>
<p>there's probably a few others like prctl where it's basically <code>union {pointer, integer}</code> but the authors saw no reason to bother and picked integer as the type to use rather than pointer basically at random</p>



<a name="276305589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276305589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276305589">(Mar 23 2022 at 09:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276286482">said</a>:</p>
<blockquote>
<p>"no you can't do <code>foo(ptr.addr())</code> you have to write your own C wrapper that does literally the same thing" is kinda inexcusable</p>
</blockquote>
<p>oh, no, I was thinking more that one would want to write a wrapper that has the Correct function signature, but that it's not really any harm to call <code>.addr()</code>.<br>
but tbh, I would be game for saying "we should be able to provide more correct function signatures for C functions", like saying "no this isn't an integer, it's an integer/pointer union."</p>



<a name="276363726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276363726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276363726">(Mar 23 2022 at 16:43)</a>:</h4>
<p>I mean, that's UB according to C and likely any rust AM too, sooo :P (it's probably not actually generating broken code anywhere, but LLVM's breakage around &amp;mut vs *mut certainly makes it somewhat sketchy)</p>



<a name="276365460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276365460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276365460">(Mar 23 2022 at 16:53)</a>:</h4>
<p>ehhhhhhhhhhhhhhhhhhhhhhhhh it's not for reasons that are hard to explain but boil down to "you get to talk a lot of shit if you're actually the compiler".</p>



<a name="276367081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367081">(Mar 23 2022 at 17:02)</a>:</h4>
<p>I mean, it is 100% absolutely UB by the C spec. You can say that on all platforms rust supports the ABI is the same, but now you need to list out exactly the valid replacements in the rust spec, because users need to be able to do this as well, not just stdlib</p>



<a name="276367173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367173">(Mar 23 2022 at 17:02)</a>:</h4>
<p>and you need to trust / check that LLVM doesn't screw this up ever, despite being primarily designed for C where this is UB</p>



<a name="276367203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367203">(Mar 23 2022 at 17:02)</a>:</h4>
<p>literally if the user does it wrong then you can emit a thunk instead.</p>



<a name="276367275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367275">(Mar 23 2022 at 17:03)</a>:</h4>
<p>you just happen to be emitting a thunk that does nothing and thus compiles away if they do it right.</p>



<a name="276367418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367418">(Mar 23 2022 at 17:04)</a>:</h4>
<p>thus "you get to talk a lot of shit if you're actually the compiler"</p>



<a name="276367425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367425">(Mar 23 2022 at 17:04)</a>:</h4>
<p>if you're not going the "just trust that the ABI is the same" route, you can't do that because shared objects, and non-LTO builds</p>



<a name="276367537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367537">(Mar 23 2022 at 17:04)</a>:</h4>
<p>unless you mean making a special type that is "int type X for ABI but exposed in rust as pointer"</p>



<a name="276367819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367819">(Mar 23 2022 at 17:06)</a>:</h4>
<p>I don't think explaining the precise steps I would take is going to be productive because any partial explanation is clearly going to be picked apart so there is no point in having this conversation as opposed to writing the essay and/or library.</p>



<a name="276367857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367857">(Mar 23 2022 at 17:07)</a>:</h4>
<blockquote>
<p>unless you mean making a special type that is "int type X for ABI but exposed in rust as pointer"</p>
</blockquote>
<p>actually, that would be pretty useful. One of my complaints about forbidding int-&gt;ptr is that with integers, you can handle 32/64 bit the same way by just always using u64 to store pointers -- since 32 bit pointers are a subset of 64 bit pointers this works and reduces the need to write a special codepath for each.</p>



<a name="276367943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367943">(Mar 23 2022 at 17:07)</a>:</h4>
<p>It seems difficult to design though.</p>



<a name="276367985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276367985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276367985">(Mar 23 2022 at 17:07)</a>:</h4>
<p>that's a useful note.</p>



<a name="276368794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276368794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276368794">(Mar 23 2022 at 17:13)</a>:</h4>
<p>I mean, saying you can somehow generate the correct code to interface with a shared library loaded at runtime without an accurate description of its ABI deserves a "no you can't, not even if you're the compiler"</p>



<a name="276369634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276369634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276369634">(Mar 23 2022 at 17:18)</a>:</h4>
<p>At worst the stdlib could define Ptr32, Ptr64, Ptr128, types to bless this pattern, and since We're The Language we can just say "lol it's an integer" and only fix it when the compiler gets smart enough to care</p>



<a name="276369713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276369713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276369713">(Mar 23 2022 at 17:19)</a>:</h4>
<p>You can,<br>
but clang cannot generate code that correctly calls GCC 100% of the time anyways, so I don't see why we're pretending C isn't UB when calling C even if the C isn't UB.</p>



<a name="276369903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276369903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276369903">(Mar 23 2022 at 17:20)</a>:</h4>
<p>I added a few of these things to the open questions on <a href="https://github.com/rust-lang/rust/issues/95228">https://github.com/rust-lang/rust/issues/95228</a></p>



<a name="276370025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276370025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276370025">(Mar 23 2022 at 17:21)</a>:</h4>
<p>And there are several spots in the existing ABIs that can cause UB even just doing the call like you're supposed to.<br>
So no,<br>
you don't need an accurate description of the ABI.<br>
You need something even more powerful.</p>



<a name="276370165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276370165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276370165">(Mar 23 2022 at 17:22)</a>:</h4>
<p>I explicitly wrote <a href="https://github.com/Gankra/abi-checker">https://github.com/Gankra/abi-checker</a></p>
<p>to help us validate that our claims of what Works are actually accurate against actual rustc and actual C compilers</p>



<a name="276374047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276374047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276374047">(Mar 23 2022 at 17:49)</a>:</h4>
<p>If we're talking about int2ptr and FFI, then another niche use-case are raw syscalls, which usually accept a list of longs which could be either pointers or integers</p>



<a name="276375114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276375114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276375114">(Mar 23 2022 at 17:56)</a>:</h4>
<p>Interop with C/C++/ASM: By all accounts, this code is currently valid. And even if technically UB in C proper right now, it's de facto guranteed, and will be valid with TS 6010/N2676. Or just imagine we're doing this in assembly.</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">uintptr_t</span><span class="w"> </span><span class="nf">ptrtoint</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">inttoptr</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="k">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptrtoint</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">libc</span>::<span class="n">c_void</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">inttoptr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Ditto goes for something that reinterprets numbers and integers in assembly or something. Now of course you could say that one/or all of these unsafe blocks is unsound, such as Rust pointers being unconvertible to integers even in C, but that's just <em>fun</em>.</p>



<a name="276375781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276375781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276375781">(Mar 23 2022 at 18:00)</a>:</h4>
<p>it's worth noting that things like ASM and FFI are outside the scope of a memory model -- a foreign language gets to do whatever the fuck it wants as long as it works in practice</p>



<a name="276375841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276375841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276375841">(Mar 23 2022 at 18:01)</a>:</h4>
<p>Not really when it comes to provenance.</p>



<a name="276376984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276376984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276376984">(Mar 23 2022 at 18:09)</a>:</h4>
<p>I miss concise code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Must use this</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"></span>
<span class="c1">// Instead of this</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Would it be possible to make <code>+=</code> into <code>self.with_addr(self.addr() + other)</code> without breaking things?</p>



<a name="276377474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276377474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276377474">(Mar 23 2022 at 18:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276375841">said</a>:</p>
<blockquote>
<p>Not really when it comes to provenance.</p>
</blockquote>
<p>Yeah, basically let's imagine a world where all inttoptr/ptrtoint casts in Rust were FFI function calls to a language where this has defined behavior, with all else being equal. Would that model solve the issue with inttoptr/ptrtoint casts? (Yes I'm aware this is a very non academic model)</p>
<p>But do any of the provenance simplifications work still? I'm sure we would lose some optimizations, but if you could get those back with <code>with_addr</code> and friends that might tractable. If that model doesn't work, then it looks to me like we can't really interop with C.</p>



<a name="276377693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276377693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276377693">(Mar 23 2022 at 18:14)</a>:</h4>
<p>and if that model _does_ work, then why do you need the C functions rather than have two variants of inttoptr/ptrtoint, one of which works like C, and one of which gives you better optimizations when all you're doing is align/bit stuff or other things like that</p>



<a name="276377860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276377860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276377860">(Mar 23 2022 at 18:15)</a>:</h4>
<p>(and saying "FFI is out of scope of the spec, so all that is fine" is kinda a useless dodge since it means all rust programs are out of scope)</p>



<a name="276378596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276378596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276378596">(Mar 23 2022 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="420380">Bot+</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276376984">said</a>:</p>
<blockquote>
<p>I miss concise code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Must use this</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"></span>
<span class="c1">// Instead of this</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Would it be possible to make <code>+=</code> into <code>self.with_addr(self.addr() + other)</code> without breaking things?</p>
</blockquote>
<p>that would be very weird since everyone "expects" offsets to be strided (multiplied by size)</p>



<a name="276378788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276378788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276378788">(Mar 23 2022 at 18:21)</a>:</h4>
<p>also you can write <code>ptr.cast::&lt;u8&gt;().add(7).cast::&lt;u64&gt;()</code> which is <em>less</em> bad (I know, I always forget that .cast exists too, i am very stuck in the old ways...)</p>



<a name="276378902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276378902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276378902">(Mar 23 2022 at 18:22)</a>:</h4>
<p>I do think there's an argument for including .byte_offset() for this kind of fuckery tho</p>



<a name="276379249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276379249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276379249">(Mar 23 2022 at 18:24)</a>:</h4>
<p>Yeah, advancing a window by a variable amount and doing unaligned load is kinda niche performance trick.</p>



<a name="276379495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276379495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276379495">(Mar 23 2022 at 18:26)</a>:</h4>
<p>the main place where I felt the pain is in the unix stackguard code where you have <code>void*</code>s</p>



<a name="276379516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276379516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276379516">(Mar 23 2022 at 18:26)</a>:</h4>
<p>and like <em>probably</em> offset is by bytes for that but I'm not gonna play that game lol</p>



<a name="276382084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382084">(Mar 23 2022 at 18:45)</a>:</h4>
<p>my understanding is that <code>void *</code> is in fact defined to have a stride of 1</p>



<a name="276382151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382151">(Mar 23 2022 at 18:46)</a>:</h4>
<p>Nope.</p>



<a name="276382211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382211">(Mar 23 2022 at 18:46)</a>:</h4>
<p><code>p+n</code> for <code>void* p;</code> is ill-formed in C.</p>



<a name="276382280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382280">(Mar 23 2022 at 18:47)</a>:</h4>
<p>It's a gcc extension that it's identical to <code>(void*)(((char*)p)+n)</code></p>



<a name="276382357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382357">(Mar 23 2022 at 18:47)</a>:</h4>
<p>an extremely common extension. but also rust defines it as a pointer to a Never enum which I am also Not Going To Fuck With</p>



<a name="276382393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382393">(Mar 23 2022 at 18:47)</a>:</h4>
<p><em>sips coffee</em> I see.</p>



<a name="276382451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382451">(Mar 23 2022 at 18:48)</a>:</h4>
<p>everything decent in C is a gcc extension lol</p>



<a name="276382602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382602">(Mar 23 2022 at 18:49)</a>:</h4>
<p>which makes it all the more impressive that msvc doesn't conform the meager standards lol</p>



<a name="276382754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276382754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276382754">(Mar 23 2022 at 18:50)</a>:</h4>
<p>In some cases, msvc is <em>more</em> compliant than gcc, because of gcc's myriad of extensions.</p>



<a name="276383018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276383018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276383018">(Mar 23 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276382357">said</a>:</p>
<blockquote>
<p>an extremely common extension. but also rust defines it as a pointer to a Never enum which I am also Not Going To Fuck With</p>
</blockquote>
<p><code>c_void</code> is a two-variant enum:<br>
<a href="https://github.com/rust-lang/rust/blob/92804455704cc59d6d8272faf72f442c6125d395/library/core/src/ffi/mod.rs#L165">https://github.com/rust-lang/rust/blob/92804455704cc59d6d8272faf72f442c6125d395/library/core/src/ffi/mod.rs#L165</a><br>
unless you mean something else?</p>



<a name="276383625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276383625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276383625">(Mar 23 2022 at 18:57)</a>:</h4>
<p>Ah I must have misremembered/misread last time I looked</p>



<a name="276384293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276384293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276384293">(Mar 23 2022 at 19:02)</a>:</h4>
<p>I am also possibly biased by being around when people were theory crafting wild shit like maybe making sizeof::&lt;opaque&gt; effectively infinite and other weird shit to try to hack around the inexpressibility of "no size"</p>



<a name="276385264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276385264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276385264">(Mar 23 2022 at 19:08)</a>:</h4>
<p>I remember talking about <code>size_of::&lt;uninhabited&gt; == -∞</code> too</p>



<a name="276385292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276385292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276385292">(Mar 23 2022 at 19:09)</a>:</h4>
<p><code>impl Sized for ! { const SIZE_OF: f32 = f32::NAN; }</code></p>



<a name="276385316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276385316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276385316">(Mar 23 2022 at 19:09)</a>:</h4>
<p>hahaha.</p>



<a name="276556726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276556726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276556726">(Mar 25 2022 at 00:20)</a>:</h4>
<p>Debuggers: These rely on I/O for pointers, but usually just cast them to call a platform API, so probably tractable. And I think CHERI even has OS-level support for them.</p>
<p>Pointer obfuscation: Replaceable with new APIs for the most part, although some implementations do cursed things like scrambling 4 pointers together. This really should be an LLVM level-pass or something, but in C, having a ton of macros you have to use is... surprisingly common.</p>
<p>Serialization: Somewhat of a mess... but <code>rkyv</code> doesn't do anything fundamentally incompatible unlike other implementations as it uses relative pointers. Stuff that requires you to be mmaped at a specific address is probably a lost cause though.</p>
<p>That's about all the actual use-cases I've been able to find. Feels both like not that much and quite a bit at the same time for some weird reason. (Now I need to work on the essay that's due that I've really been procrastinating on)</p>



<a name="276557410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276557410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276557410">(Mar 25 2022 at 00:28)</a>:</h4>
<p>rkyv is UCG 256/134. The issue with rkyv is not conjuring a pointer from nothing or doing ptr-int-ptr, it's converting a reference to a pointer then accessing outside of the referent.</p>



<a name="276557421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276557421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276557421">(Mar 25 2022 at 00:28)</a>:</h4>
<p>worth noting that llvm has prior art for pointer ofuscation APIs: <a href="https://llvm.org/docs/PointerAuth.html">https://llvm.org/docs/PointerAuth.html</a></p>



<a name="276557475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276557475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276557475">(Mar 25 2022 at 00:29)</a>:</h4>
<p>rkyv is another example like intrusive data structures where you can already do it, just not with references the way rkyv is trying to.</p>



<a name="276562041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276562041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276562041">(Mar 25 2022 at 01:40)</a>:</h4>
<p><a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/134">unsafe-code-guidelines#134</a> and <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/256">unsafe-code-guidelines#256</a> you mean?</p>



<a name="276565299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276565299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276565299">(Mar 25 2022 at 02:39)</a>:</h4>
<p>Yes, that is what I mean. The community discord sometimes uses those issues along with 133, <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/133">https://github.com/rust-lang/unsafe-code-guidelines/issues/133</a> as shorthand for particular patterns that people write often but are not permitted under SB.</p>



<a name="276721663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276721663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276721663">(Mar 26 2022 at 11:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276375114">said</a>:</p>
<blockquote>
<p>Interop with C/C++/ASM: By all accounts, this code is currently valid. And even if technically UB in C proper right now, it's de facto guranteed, and will be valid with TS 6010/N2676. Or just imagine we're doing this in assembly.</p>
<p><div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">uintptr_t</span><span class="w"> </span><span class="nf">ptrtoint</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">inttoptr</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>It's not UB, but implementation defined, unless I'm mistaken.</p>



<a name="276721902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276721902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276721902">(Mar 26 2022 at 11:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276375781">said</a>:</p>
<blockquote>
<p>it's worth noting that things like ASM and FFI are outside the scope of a memory model -- a foreign language gets to do whatever the fuck it wants as long as it works in practice</p>
</blockquote>
<p>It may be outside the scope of the <em>current</em> memory model, but IMO that means the memory model is incomplete.  For one thing, on platforms not named CHERI, the purpose of provenance is to enable optimizations, and with cross-language LTO, LLVM performs those optimizations on a mix of Rust and C code.  For another, even without cross-language LTO, you still have to define what optimizations around FFI calls are legal.</p>



<a name="276726993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276726993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276726993">(Mar 26 2022 at 13:48)</a>:</h4>
<p>cross-language LTO is a great point, in terms of needing to actually have a model that llvm can merge with C's model.</p>



<a name="276727104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276727104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276727104">(Mar 26 2022 at 13:50)</a>:</h4>
<p>(I don't think it would be a <em>tragedy</em> if Rust ended up with PNVI-ae-udi, and maybe FFI ends up acting like that? That's actually an interesting question if you can have stacked borrows / strict provenance as a layer "on top of" PNVI-ae-udi in a coherent way. Like the whole system is assumed to follow those semantics but the code we control has to follow stricter semantics? HMM...)</p>



<a name="276730046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276730046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276730046">(Mar 26 2022 at 15:01)</a>:</h4>
<p>also lmao one of the authors of the PNVI-ae-udi proposal (Martin Uecker) is just in my twitter mentions chatting me up and talking about collaboration lol</p>



<a name="276730133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276730133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276730133">(Mar 26 2022 at 15:03)</a>:</h4>
<p><a href="https://twitter.com/martin_uecker/status/1507713668141621255">https://twitter.com/martin_uecker/status/1507713668141621255</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/martin_uecker/status/1507713668141621255"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/5b8ce1ec917f53c6b5a4d5922b274f0a9e4160ff/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313138313238323030343039383134363330352f6c63676630354d4b5f6e6f726d616c2e6a7067"></a><p><a href="https://twitter.com/Gankra_">@Gankra_</a> Oh definitely. Rust may go beyond this. But it would be good to exchange ideas and maybe stay synchronized where this is possible.</p><span>- Martin Uecker (@martin_uecker)</span></div></div>



<a name="276731271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276731271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276731271">(Mar 26 2022 at 15:31)</a>:</h4>
<p>Ralf's evergreen concern is that PNVI-ae-udi does not produce sensible ptr-int-ptr behavior in the presence of <code>restrict</code>.</p>
<p>And it's interesting that in that paper they specifically talk about adding a no-expose annotation for memcpy to avoid pessimization. (Interesting because memcpy is probably the most common use of restrict)</p>



<a name="276731311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276731311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276731311">(Mar 26 2022 at 15:32)</a>:</h4>
<p>But of course they're don't seem sure how this could be done</p>



<a name="276734283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276734283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276734283">(Mar 26 2022 at 16:38)</a>:</h4>
<p>I think that is unrelated to <code>restrict</code>, and more related to <code>memcpy</code>  accessing pointer representations at <code>char</code> type which would be consider to 'expose' the pointer</p>



<a name="276734293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276734293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276734293">(Mar 26 2022 at 16:38)</a>:</h4>
<p>if C had <code>MaybeUninit&lt;char&gt;</code> or the <code>byte</code> type some folks are proposing for LLVM, that would solve the issue of memcpy exposing</p>



<a name="276734297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276734297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276734297">(Mar 26 2022 at 16:38)</a>:</h4>
<p>but wouldnt help with <code>restrict</code></p>



<a name="276735762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276735762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276735762">(Mar 26 2022 at 17:11)</a>:</h4>
<p>Is there an explicit example lying around of how PNVI-ae-udi breaks the restrictions <code>restrict</code> is supposed to enforce / breaks typical ways optimizers would like to take advantage of said restrictions?</p>



<a name="276739807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276739807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276739807">(Mar 26 2022 at 18:44)</a>:</h4>
<p>an example, yes. I hope to write it up as a blog post done day but until then here's just the example:<br>
<a href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151521.html">https://lists.llvm.org/pipermail/llvm-dev/2021-June/151521.html</a></p>



<a name="276739824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276739824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276739824">(Mar 26 2022 at 18:45)</a>:</h4>
<p>specifically this is an example against having 'dead cast elimination' with <code>restrict</code></p>



<a name="276739891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276739891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276739891">(Mar 26 2022 at 18:46)</a>:</h4>
<p>PNVI and its variants dont really consider the case where there are multiple distinct valid provenances for a single location, so it's a bit hard to say where/if/how they would break -- it's simply out of scope for them</p>



<a name="276741380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276741380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276741380">(Mar 26 2022 at 19:21)</a>:</h4>
<p>I think PNVI-ae in general needs to keep the cast metadata around? That doesn't seem like a special case with restrict? That is, since the various provenance specs clarify exactly how </p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">some</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">print</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>can't alias but </p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">math</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">print</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>can, you need to keep that metadata around by keeping the cast or whatever, even without <code>restrict</code> in play.</p>
<p>And PNVI-ae-udi explicitly handles multiple distinct provenances with its ugly hack, and no part of that hack seems to actually rely on C having only two possible provenances for a given location.</p>



<a name="276741563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276741563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276741563">(Mar 26 2022 at 19:24)</a>:</h4>
<p>by "ugly hack" you mean that "symbolic provenance" they have? (not sure what they call it)</p>



<a name="276741750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276741750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276741750">(Mar 26 2022 at 19:29)</a>:</h4>
<p>I mean making the world state be a set of possible states, and it's only real UB if there are no legal states left</p>



<a name="276742113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276742113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276742113">(Mar 26 2022 at 19:38)</a>:</h4>
<p>Yeah, but stacked borrows invalidating on read is a massive pain for that, as you quicky get into exponential blowup. And I think a greedy model or something would work, but that's beyond my ability to reason about, much less prove.</p>



<a name="276742516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276742516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276742516">(Mar 26 2022 at 19:49)</a>:</h4>
<p>And fun fact: there exists a dialect of C that also allows pointer-integer transmutes (no-strict-aliasing), so if these models are actualized before Rust's we could probably get some benchmark numbers.</p>



<a name="276742651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276742651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276742651">(Mar 26 2022 at 19:52)</a>:</h4>
<p>is anyone actually working on a formal model for -fno-strict-aliasing, or is it just going to be turning off TBAA info in the actual implementation?</p>



<a name="276742781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276742781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276742781">(Mar 26 2022 at 19:54)</a>:</h4>
<p>I may be wrong, but I think the provenance model is defined assuming no strict aliasing, (or at least considered if not officially defined), and strict aliasing "simply" allows those extra redundant store optimizations (in this case, there's many others).</p>



<a name="276742859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276742859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276742859">(Mar 26 2022 at 19:56)</a>:</h4>
<p>hmm, yeah thinking about it the provenance models as currently written don't bother saying anything about types, since that's kinda a separate restriction</p>



<a name="276743839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276743839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276743839">(Mar 26 2022 at 20:18)</a>:</h4>
<p>re the exponential blowup, I'm not 100% convinced this is a problem for compilers, since they aren't operating on world state (and to the extent that they are, every if statement can do that). To the extent it causes linear blowup for the possible provenances for a given pointer, that /also/ is unavoidable for a compiler in any PNVI-ae world. It's inelegant for the theory, but that's fine. The part where it really causes problems is for miri of course, which probably just falls over.</p>



<a name="276744011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276744011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276744011">(Mar 26 2022 at 20:23)</a>:</h4>
<p>Yeah in general PNVI-ae is a semantic model that basically blesses what compilers are already doing, which is to say if you ever lose track of a pointer you toss it in the "might be aliased bucket" and if you ever get a pointer you don't know about it also goes in the "might be aliased bucket" and everything in that bucket is conservatively assumed to all be aliasing eachother</p>



<a name="276744124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276744124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276744124">(Mar 26 2022 at 20:26)</a>:</h4>
<p>even the weird boundary condition on "one-past-the-end hittesting two exposed allocations" is not Actually a problem in the sense that "just only consistently access one" is cromulently covered by "might be aliased bucket" rules.</p>



<a name="276744128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276744128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276744128">(Mar 26 2022 at 20:26)</a>:</h4>
<p>so idk why the compiler would have any obligation to <em>actually</em> track this stuff because it's always a valid implementation to just... assume things alias</p>



<a name="276744144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276744144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276744144">(Mar 26 2022 at 20:27)</a>:</h4>
<p>and the Really Important stuff like spills/return pointers is "anonymous" in the sense that it's Never Exposed</p>



<a name="276747827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747827">(Mar 26 2022 at 21:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276741750">said</a>:</p>
<blockquote>
<p>I mean making the world state be a set of possible states, and it's only real UB if there are no legal states left</p>
</blockquote>
<p>PNVI doesn't even do that though, it "just" has a symbolic provenance and keeps track in a dedicated table of what that provenance "means".<br>
with SB / <code>restrict</code> you might indeed need the full "set of possible states" as the effect cannot be captured by a single table any more.</p>



<a name="276747885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747885">(Mar 26 2022 at 21:54)</a>:</h4>
<p>formally speaking what is happening here is that we use <em>angelic non-determinism</em> to pick a provenance that works. and then we deterministically encode that angelic non-determinism by considering a set of possible executions at the same time, via the usual powerset construction for making a non-det state-machine deterministic.</p>



<a name="276747909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747909">(Mar 26 2022 at 21:55)</a>:</h4>
<blockquote>
<p>Yeah in general PNVI-ae is a semantic model that basically blesses what compilers are already doing, </p>
</blockquote>
<p>I wouldn't say that, what compilers are currently doing is <a href="https://www.ralfj.de/blog/2020/12/14/provenance.html">simply buggy</a> and PNVI hopefully helps convince them to fix it...</p>



<a name="276747963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747963">(Mar 26 2022 at 21:56)</a>:</h4>
<p>ok sorry more accurately: expresses a well-formed version of what compilers basically want to be doing</p>



<a name="276747973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747973">(Mar 26 2022 at 21:56)</a>:</h4>
<p>PNVI does say that a ptr-to-int cast has a side-effect ("exposing" the allocation) but AFAIK no compiler treats casts as having side-effects</p>



<a name="276747988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747988">(Mar 26 2022 at 21:56)</a>:</h4>
<p>wow really? <em>that's</em> the part compilers have been refusing to implement?</p>



<a name="276747997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276747997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276747997">(Mar 26 2022 at 21:57)</a>:</h4>
<p>its not the only part</p>



<a name="276748005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748005">(Mar 26 2022 at 21:57)</a>:</h4>
<p>also GVN on pointers and peephole-optimizing away ptr-int-ptr roundtrips</p>



<a name="276748020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748020">(Mar 26 2022 at 21:57)</a>:</h4>
<p>FWIW, because of that side-effect I dont think PNVI is necessarily a great model for IRs, but C as a surface lang gets away with it</p>



<a name="276748076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748076">(Mar 26 2022 at 21:58)</a>:</h4>
<p>Surely someone has cobbled together an implementation somewhere to gauge the performance impact</p>



<a name="276748081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748081">(Mar 26 2022 at 21:59)</a>:</h4>
<p>huh, why would ptr-int-ptr being optimized away be a problem?</p>



<a name="276748090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748090">(Mar 26 2022 at 21:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748081">said</a>:</p>
<blockquote>
<p>huh, why would ptr-int-ptr being optimized away be a problem?</p>
</blockquote>
<p>see the blog post I linked ;)<br>
<a href="https://www.ralfj.de/blog/2020/12/14/provenance.html">https://www.ralfj.de/blog/2020/12/14/provenance.html</a></p>



<a name="276748094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748094">(Mar 26 2022 at 21:59)</a>:</h4>
<p>ok FINE i will read your highly recommended post</p>



<a name="276748100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748100">(Mar 26 2022 at 21:59)</a>:</h4>
<p>:D</p>



<a name="276748101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748101">(Mar 26 2022 at 21:59)</a>:</h4>
<p><em>shakes fist</em></p>



<a name="276748240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748240">(Mar 26 2022 at 22:01)</a>:</h4>
<p>also re: strict aliasing, AFAIK PNVI 'relies' on strict aliasing in the sense that that means they dont have to worry about things like <em>any load at integer type</em> potentially exposing a pointer that is being loaded...</p>



<a name="276748242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748242">(Mar 26 2022 at 22:01)</a>:</h4>
<p>which is another aspect that makes PNVI less suited at least for LLVM</p>



<a name="276748248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748248">(Mar 26 2022 at 22:01)</a>:</h4>
<p>this is the most evil code omg</p>



<a name="276748292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748292">(Mar 26 2022 at 22:02)</a>:</h4>
<p>thanks <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="276748343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748343">(Mar 26 2022 at 22:03)</a>:</h4>
<p>yeah, the proposal explicitly calls out that char* derefs would count as escapes and that there should be some way to tag a memcpy implementation as not qualifying</p>



<a name="276748346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748346">(Mar 26 2022 at 22:03)</a>:</h4>
<p>and does this in the formal definitions section, where they have no formal definition for this</p>



<a name="276748472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748472">(Mar 26 2022 at 22:06)</a>:</h4>
<p>yeah but making it formal isn't the problem</p>



<a name="276748478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748478">(Mar 26 2022 at 22:06)</a>:</h4>
<p>(though in practice of course again the most important targets are likely to be known not to alias regardless, since the pointer-to-pointer will not have escaped, etc)</p>



<a name="276748485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748485">(Mar 26 2022 at 22:06)</a>:</h4>
<p>the problem is that this means that every <code>char*</code> deref <em>can have a global side-effect</em></p>



<a name="276748489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748489">(Mar 26 2022 at 22:06)</a>:</h4>
<p>which means it is <em>incorrect</em> to remove such a deref even if its result is not used</p>



<a name="276748515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748515">(Mar 26 2022 at 22:07)</a>:</h4>
<p>and I have some even more horrible code that <span class="user-mention" data-user-id="137587">@Gankra</span> will love at <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-860189806">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-860189806</a> to demonstrate this in Rust</p>



<a name="276748531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748531">(Mar 26 2022 at 22:07)</a>:</h4>
<p>only if the compiler can't find a better way to lower those rules into optimizations, which it certainly feels like should be possible</p>



<a name="276748575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748575">(Mar 26 2022 at 22:08)</a>:</h4>
<p>but might well not be</p>



<a name="276748616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748616">(Mar 26 2022 at 22:09)</a>:</h4>
<p>so maybe when <span class="user-mention" data-user-id="281757">@Jubilee</span> suggests PNVI I should point to these problems rather than going on about <code>restrict</code>/<code>noalias</code> ;)</p>



<a name="276748658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748658">(Mar 26 2022 at 22:10)</a>:</h4>
<p>interesting.</p>



<a name="276748660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748660">(Mar 26 2022 at 22:10)</a>:</h4>
<p><span class="user-mention" data-user-id="143798">@Talchas</span>  not sure what "lowering rules into optimizations" means. what we need is an IR spec that (a) can be soundly compiled from C+PNVI and (b) still allows reasonable optimizations. I have a paper at <a href="https://www.ralfj.de/research/twinsem/twinsem.pdf">https://www.ralfj.de/research/twinsem/twinsem.pdf</a> that proposes one. It still has some problems though, and LLVM doesn't seem eager to accept the <code>byte</code> type proposal that I think is crucial to this goal.</p>



<a name="276748670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748670">(Mar 26 2022 at 22:10)</a>:</h4>
<p>(ofc in Rust "every <code>char*</code> deref" becomes "basically every deref ever" since we don't to TBAA)</p>



<a name="276748674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748674">(Mar 26 2022 at 22:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748240">said</a>:</p>
<blockquote>
<p>also re: strict aliasing, AFAIK PNVI 'relies' on strict aliasing in the sense that that means they dont have to worry about things like <em>any load at integer type</em> potentially exposing a pointer that is being loaded...</p>
</blockquote>
<p>oof.</p>



<a name="276748675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748675">(Mar 26 2022 at 22:11)</a>:</h4>
<p>the side-effect could instead be the store of the pointer into memory that could be aliased</p>



<a name="276748683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748683">(Mar 26 2022 at 22:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748675">said</a>:</p>
<blockquote>
<p>the side-effect could instead be the store of the pointer into memory that could be aliased</p>
</blockquote>
<p>at store time the memory might not be aliased yet</p>



<a name="276748741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748741">(Mar 26 2022 at 22:12)</a>:</h4>
<p>could at some point be aliased into an integer read</p>



<a name="276748748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748748">(Mar 26 2022 at 22:13)</a>:</h4>
<p>that's impossible to tell in many cases though</p>



<a name="276748750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748750">(Mar 26 2022 at 22:13)</a>:</h4>
<p>as it is a promise about <em>all future uses</em> of this memory</p>



<a name="276748754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748754">(Mar 26 2022 at 22:13)</a>:</h4>
<p>because if the compiler can't prove that, in general it already can't prove that it wasn't stored into a global or something</p>



<a name="276748757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748757">(Mar 26 2022 at 22:13)</a>:</h4>
<p>and thus must consider it escaped anyways</p>



<a name="276748758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748758">(Mar 26 2022 at 22:13)</a>:</h4>
<p>not with <code>restrict</code>/SB</p>



<a name="276748845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748845">(Mar 26 2022 at 22:15)</a>:</h4>
<p>so that leads me to "we should forbid ptr-to-int transmutes" (pointers must not be loaded at integer type) as the only way forward that I currently see here</p>



<a name="276748896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748896">(Mar 26 2022 at 22:16)</a>:</h4>
<p>aka "the validity invariant for integers says that there is no provenance"</p>



<a name="276748918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748918">(Mar 26 2022 at 22:17)</a>:</h4>
<p>with restrict I can't see how to derive that offhand, but with SB I can certainly believe that, hmm</p>



<a name="276748922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748922">(Mar 26 2022 at 22:17)</a>:</h4>
<p>(because restrict doesn't invalidate any pointers outside of its block)</p>



<a name="276748972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276748972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276748972">(Mar 26 2022 at 22:18)</a>:</h4>
<p>0.o it is very to interesting to see your suggesting in that issue that "ptrtoint" is clearly the "evil" one</p>



<a name="276749046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749046">(Mar 26 2022 at 22:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748896">said</a>:</p>
<blockquote>
<p>aka "the validity invariant for integers says that there is no provenance"</p>
</blockquote>
<p>Agreed, but how does this imply that the transmute has to be UB? Why can't the place to value conversion at the integer type lose the provenance?</p>



<a name="276749091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749091">(Mar 26 2022 at 22:22)</a>:</h4>
<p>There are already examples under SB of place to value conversions "mutating" the value, ie of <code>x = x;</code> not being a no-op</p>



<a name="276749096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749096">(Mar 26 2022 at 22:22)</a>:</h4>
<p>transmute is defined such that it does not alter the bytes returned from the function.</p>



<a name="276749103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749103">(Mar 26 2022 at 22:22)</a>:</h4>
<p>I cannot imagine that that is true. Transmuting to a type with padding should definitely deinitialize it</p>



<a name="276749114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749114">(Mar 26 2022 at 22:23)</a>:</h4>
<p>(also, functions don't return bytes but values, at least this is what I believe the intent is)</p>



<a name="276749126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749126">(Mar 26 2022 at 22:24)</a>:</h4>
<p>I'd say that transmuting to the type wouldn't but the assignment (resulting Copy) would, since it copies <code>Pad</code>.</p>



<a name="276749191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749191">(Mar 26 2022 at 22:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749114">said</a>:</p>
<blockquote>
<p>(also, functions don't return bytes but values, at least this is what I believe the intent is)</p>
</blockquote>
<p>But it specifically returns a valid value that corresponds to the bytes of the value given in it's parameters, if such a value exists, or the behaviour is undefined otherwise.</p>



<a name="276749197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749197">(Mar 26 2022 at 22:25)</a>:</h4>
<p>I mean also transmute being defined that way is entirely an artifact of provenance not existing</p>



<a name="276749244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749244">(Mar 26 2022 at 22:26)</a>:</h4>
<p>and definitely can be defined however rust/C wants when provenance is being formalized</p>



<a name="276749251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749251">(Mar 26 2022 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748972">said</a>:</p>
<blockquote>
<p>0.o it is very to interesting to see your suggesting in that issue that "ptrtoint" is clearly the "evil" one</p>
</blockquote>
<p>well, it is evil if you want inttoptr to work. if not, we are fine.</p>



<a name="276749261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749261">(Mar 26 2022 at 22:27)</a>:</h4>
<p>and the sort of side effect it is intended to avoid definitely does not include any side effect in <code>ptr as usize</code></p>



<a name="276749263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749263">(Mar 26 2022 at 22:27)</a>:</h4>
<p>So this doesn't make much sense in MIR (or Rust) because neither of those have a notion of assignment with unequal types. Assignment operations occur from a value (in <a href="https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/value-domain.md">this sense</a>) which is the result of the right hand side to a place on the left hand side. There's no way to write MIR/Rust that has the value/place types not match, and so there are no operational semantics attached to such a thing - at least this is how I interpret the current status of things</p>



<a name="276749325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749325">(Mar 26 2022 at 22:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749046">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748896">said</a>:</p>
<blockquote>
<p>aka "the validity invariant for integers says that there is no provenance"</p>
</blockquote>
<p>Agreed, but how does this imply that the transmute has to be UB? Why can't the place to value conversion at the integer type lose the provenance?</p>
</blockquote>
<p>(a) because that means writing the same integer back to memory will actually have changed its value (so there are some optimizations this loses); that's what the example exploits.<br>
(b) just "losing provenance" would otherwise be fine <em>if</em> nobody would expect a later inttoptr cast on that number to work. but if people expect the roundtrip to work (as C programmers typically will), then "losing provenance" has to be accompanied by "marking that provenance as exposed", so your load/transmute has to have a side-effect, and that is exactly the problem my proposed rule is supposed to fix.</p>



<a name="276749331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749331">(Mar 26 2022 at 22:29)</a>:</h4>
<p>note also that Ralf's example literally doesn't actually <code>transmute</code> anything in terms of the actual transmute function, it's just making two pointers to that same value, writing a usize into one and reading a *mut out of the other</p>



<a name="276749335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749335">(Mar 26 2022 at 22:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749103">said</a>:</p>
<blockquote>
<p>I cannot imagine that that is true. Transmuting to a type with padding should definitely deinitialize it</p>
</blockquote>
<p>that has nothing to do with transmute and everything to do with the target type</p>



<a name="276749339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749339">(Mar 26 2022 at 22:29)</a>:</h4>
<p><em>any</em> <code>=</code> on a type with padding de-inits that padding</p>



<a name="276749353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749353">(Mar 26 2022 at 22:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749339">said</a>:</p>
<blockquote>
<p><em>any</em> <code>=</code> on a type with padding de-inits that padding</p>
</blockquote>
<p>But is it the <code>=</code> or the place to value conversion? I'd assume it's the latter</p>



<a name="276749402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749402">(Mar 26 2022 at 22:30)</a>:</h4>
<p>I'd assume it to be the former.</p>



<a name="276749413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749413">(Mar 26 2022 at 22:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749331">said</a>:</p>
<blockquote>
<p>note also that Ralf's example literally doesn't actually <code>transmute</code> anything in terms of the actual transmute function, it's just making two pointers to that same value, writing a usize into one and reading a *mut out of the other</p>
</blockquote>
<p>right I am as usual using "transmute" as a term encompassing</p>
<ul>
<li><code>std::mem::transmute</code></li>
<li>union-based type punning</li>
<li>type punning by doing pointer casts and accessing the same data at different types</li>
</ul>
<p>I firmly hold that those should all be equivalent.</p>



<a name="276749417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749417">(Mar 26 2022 at 22:30)</a>:</h4>
<p>After all, you can create and assign values of a type with padding w/o ever touching p2v.</p>



<a name="276749440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749440">(Mar 26 2022 at 22:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749353">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749339">said</a>:</p>
<blockquote>
<p><em>any</em> <code>=</code> on a type with padding de-inits that padding</p>
</blockquote>
<p>But is it the <code>=</code> or the place to value conversion? I'd assume it's the latter</p>
</blockquote>
<p>Eh, ok, I take that back</p>



<a name="276749444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749444">(Mar 26 2022 at 22:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749353">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749339">said</a>:</p>
<blockquote>
<p><em>any</em> <code>=</code> on a type with padding de-inits that padding</p>
</blockquote>
<p>But is it the <code>=</code> or the place to value conversion? I'd assume it's the latter</p>
</blockquote>
<p>well, the place-to-value covnersion "forgets" the padding and the value-to-place store then puts <code>uninit</code> into the padding at the target place</p>



<a name="276749446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749446">(Mar 26 2022 at 22:31)</a>:</h4>
<p>Yeah, that's what I mean</p>



<a name="276749447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749447">(Mar 26 2022 at 22:31)</a>:</h4>
<p>so, it's not clearly one of them, but a side-effect of the composed action of <code>=</code></p>



<a name="276749449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749449">(Mar 26 2022 at 22:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749402">said</a>:</p>
<blockquote>
<p>I'd assume it to be the former.</p>
</blockquote>
<p>Or, possibly both.</p>



<a name="276749496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749496">(Mar 26 2022 at 22:32)</a>:</h4>
<p>So this already means that <code>x = x;</code> is not a no-op in Rust. I don't see why we should require that of integers</p>



<a name="276749503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749503">(Mar 26 2022 at 22:32)</a>:</h4>
<p>a "value" doesnt even have such a thing as padding. "padding" is what we call the bytes in a low-level representation that do not correspond to any part of the "value". (that's how I think about it anyway.)</p>



<a name="276749510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749510">(Mar 26 2022 at 22:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749496">said</a>:</p>
<blockquote>
<p>So this already means that <code>x = x;</code> is not a no-op in Rust. I don't see why we should require that of integers</p>
</blockquote>
<p>it's not a NOP <em>but it is a pure operation</em></p>



<a name="276749521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749521">(Mar 26 2022 at 22:33)</a>:</h4>
<p>So, I also have an example of a place to value conversion (and hence an <code>x = x;</code> assignment) not being a pure operation. Let me dig it up</p>



<a name="276749533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749533">(Mar 26 2022 at 22:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749503">said</a>:</p>
<blockquote>
<p>a "value" doesnt even have such a thing as padding. "padding" is what we call the bytes in a low-level representation that do not correspond to any part of the "value". (that's how I think about it anyway.)</p>
</blockquote>
<p>This is also how C++ defines it. Padding bytes (and bits) are parts of the object-representation that do not participate in the value-representation.</p>



<a name="276749536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749536">(Mar 26 2022 at 22:33)</a>:</h4>
<p>so, yes we could say that when turning "a list of bytes that have provenance" into "value of integer type" (a "type load" as I call it, e.g. at place-to-val conversion), that then we just ignore provenance. that would still be a pure operation.<br>
but then if you cast that int back to a ptr you have UB.</p>



<a name="276749595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749595">(Mar 26 2022 at 22:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749521">said</a>:</p>
<blockquote>
<p>So, I also have an example of a place to value conversion (and hence an <code>x = x;</code> assignment) not being a pure operation. Let me dig it up</p>
</blockquote>
<p>that sounds wrong.^^ there is the clear design goal that the compiler is allowed to optimize away <code>x=x</code>.<br>
it is not a NOP but it is allowed to be a NOP.</p>



<a name="276749613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749613">(Mar 26 2022 at 22:35)</a>:</h4>
<p>or, formally speaking: <code>x=x</code> is not (contextually) equivalent to a NOP, but it is (contextually) refined by a NOP, and the latter is really what we care about for optimizations</p>



<a name="276749623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749623">(Mar 26 2022 at 22:35)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// `r`s memory now contains a `&amp;mut x`.</span>

<span class="w">    </span><span class="c1">// The `r as *const i32` is lowered to `&amp;raw *r` in MIR</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276749627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749627">(Mar 26 2022 at 22:36)</a>:</h4>
<p>So this is indeed refined by a nop, but it is not equivalent to one and has "side-effects" in the sense of "touches other state"</p>



<a name="276749670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749670">(Mar 26 2022 at 22:36)</a>:</h4>
<p>(Here my point is that loading the memory in <code>r</code> at type <code>&amp;i32</code> does things to the borrow stack of a value far away)</p>



<a name="276749684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749684">(Mar 26 2022 at 22:36)</a>:</h4>
<p>Yeah, that wouldn't be pure.</p>



<a name="276749695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749695">(Mar 26 2022 at 22:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749670">said</a>:</p>
<blockquote>
<p>(Here my point is that loading the memory in <code>r</code> at type <code>&amp;i32</code> does things to the borrow stack of a value far away)</p>
</blockquote>
<p>oh yes but that is not at all an <code>x=x</code>. look at its MIR (the one Miri actually runs). there is an explicit reborrow there.</p>



<a name="276749700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749700">(Mar 26 2022 at 22:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749627">said</a>:</p>
<blockquote>
<p>So this is indeed refined by a nop, but it is not equivalent to one and has "side-effects" in the sense of "touches other state"</p>
</blockquote>
<p>and having side-effects means it is <em>not</em> refined by a NOP</p>



<a name="276749707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749707">(Mar 26 2022 at 22:37)</a>:</h4>
<p>since replacing it by a NOP would change program behavior (by removing side-effects)</p>



<a name="276749708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749708">(Mar 26 2022 at 22:37)</a>:</h4>
<p>If you did <code>r = r;</code>that's definately not a nop.</p>



<a name="276749710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749710">(Mar 26 2022 at 22:37)</a>:</h4>
<p>Ah, ok fair</p>



<a name="276749763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749763">(Mar 26 2022 at 22:38)</a>:</h4>
<p>you need to pass <code>-Zmir-emit-retag</code> or so to get the MIR with these explicit operations</p>



<a name="276749767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749767">(Mar 26 2022 at 22:38)</a>:</h4>
<p>some day we'll have to make that the default so that MIR optimizations don't go wrong...</p>



<a name="276749779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749779">(Mar 26 2022 at 22:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749695">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276749670">said</a>:</p>
<blockquote>
<p>(Here my point is that loading the memory in <code>r</code> at type <code>&amp;i32</code> does things to the borrow stack of a value far away)</p>
</blockquote>
<p>oh yes but that is not at all an <code>x=x</code>. look at its MIR (the one Miri actually runs). there is an explicit reborrow there.</p>
</blockquote>
<p>So, maybe we have different approaches to this, but I would greatly prefer if Miri interprets MIR that <em>doesn't</em> include retags. It's of course fine if CTFE/miri inserts them as a part of it's pipeline, but I don't think that the retags should exist at optimization time</p>



<a name="276749792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749792">(Mar 26 2022 at 22:39)</a>:</h4>
<p>so yeah terminology is hard.^^ the <code>=</code> I was talking about al along is MIR assignment. a <code>=</code> in surface Rust might lower down to a MIR assignment <em>and some extra stuff</em> so that's a different operation.<br>
(as I keep saying, language design is different for surface languages and IRs.)</p>



<a name="276749837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749837">(Mar 26 2022 at 22:40)</a>:</h4>
<p>And because of that I am intentionally trying to look at the semantics of the MIR without retags emitted</p>



<a name="276749841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749841">(Mar 26 2022 at 22:40)</a>:</h4>
<p>those are the wrong semantics though</p>



<a name="276749843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749843">(Mar 26 2022 at 22:40)</a>:</h4>
<p>like, <code>Retag</code> is literally what makes the aliasing model work</p>



<a name="276749848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749848">(Mar 26 2022 at 22:40)</a>:</h4>
<p>or, Rust/MIR without retags is Rust without any aliasing guarantees on its references</p>



<a name="276749868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749868">(Mar 26 2022 at 22:41)</a>:</h4>
<p>Is it not possible to make the retag operations semantically a part of place to value (or back) conversions?</p>



<a name="276749877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749877">(Mar 26 2022 at 22:41)</a>:</h4>
<p>it's possible but bad design IMO</p>



<a name="276749946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749946">(Mar 26 2022 at 22:42)</a>:</h4>
<p>with IRs it is usually better to have instructions that do exactly one thing, and not have "mega instructions" that do a bunch of a priori unrelated tasks</p>



<a name="276749967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749967">(Mar 26 2022 at 22:43)</a>:</h4>
<p>Hm, so this would mean that for <code>x: &amp;mut T</code> in MIR, an MIR opt could see a <code>x = move x</code> and then remove the retag statement that (normally) follows such an assignment to introduce more DB which then justifies its optimization?</p>



<a name="276749973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276749973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276749973">(Mar 26 2022 at 22:43)</a>:</h4>
<p>if it deems that useful, yes. (that would then also have to affect whether <code>noalias</code> is passed to LLVM.)</p>



<a name="276750017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750017">(Mar 26 2022 at 22:44)</a>:</h4>
<p>basically, <code>Retag</code> "compiles to" <code>noalias</code> in LLVM</p>



<a name="276750050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750050">(Mar 26 2022 at 22:45)</a>:</h4>
<p>but you are right that we could possibly make <code>retag</code> part of the action "convert value into byte representation when storing it into place or passing it to a function". this seems like a design discussion worth having at some point.<br>
I dont think this is a good idea but I am also not implementing MIR optimizations.^^</p>



<a name="276750118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750118">(Mar 26 2022 at 22:47)</a>:</h4>
<p>Actually, the retag statements don't justify it either as far as I can tell right now. The interesting MIR is here:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">_12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">raw</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">_1</span><span class="p">);</span><span class="w">          </span><span class="c1">// scope 3 at test.rs:9:13: 9:14</span>
<span class="w">        </span><span class="n">Retag</span><span class="p">([</span><span class="n">raw</span><span class="p">]</span><span class="w"> </span><span class="n">_12</span><span class="p">);</span><span class="w">                </span><span class="c1">// scope 3 at test.rs:9:13: 9:14</span>
</code></pre></div>
<p>(via <code>rustc +stage1 -Zmir-emit-retag=yes --emit mir --crate-type lib test.rs</code>)</p>



<a name="276750119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750119">(Mar 26 2022 at 22:47)</a>:</h4>
<p>the function passing thing is a bit tricky since it is crucial for optimizations that the <em>callee</em> does the retag, but it is usually the <em>caller</em> that writes the arguments into a place.</p>



<a name="276750136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750136">(Mar 26 2022 at 22:47)</a>:</h4>
<p><span class="user-mention" data-user-id="310518">@Jak{e,ob} Degen</span> not sure what is (not) justified here?</p>



<a name="276750139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750139">(Mar 26 2022 at 22:47)</a>:</h4>
<p><code>Retag</code>ing for <code>[raw]</code> would not cause UB if the write provenance was still preserved at that point, no?</p>



<a name="276750177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750177">(Mar 26 2022 at 22:48)</a>:</h4>
<p>(or am I misunderstanding retag statements?)</p>



<a name="276750199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750199">(Mar 26 2022 at 22:48)</a>:</h4>
<p><code>Retag(raw)</code> is basically the ptr-to-int "broadcast" operation</p>



<a name="276750204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750204">(Mar 26 2022 at 22:49)</a>:</h4>
<p>Like, if the load out of <code>_1</code> preserved the write provenance of the pointer, it would be an SRW that then gets retagged as <code>[raw]</code> and so remains an SRW is my interpretation</p>



<a name="276750208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750208">(Mar 26 2022 at 22:49)</a>:</h4>
<p>I dont understand the goal of your example. which optimization do you claim is (not) correct on it?</p>



<a name="276750211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750211">(Mar 26 2022 at 22:49)</a>:</h4>
<p>god Ralf's examples have made me More mad at inttoptr, somehow</p>



<a name="276750215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750215">(Mar 26 2022 at 22:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276750211">said</a>:</p>
<blockquote>
<p>god Ralf's examples have made me More mad at inttoptr, somehow</p>
</blockquote>
<p>wow I am impressed that that is possible. and I feel quite honored. :D</p>



<a name="276750248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750248">(Mar 26 2022 at 22:50)</a>:</h4>
<p>I'm not claiming that any optimization is incorrect, I'm trying to understand how MIRI justifies reporting UB (it does) if the provenance does not change on the load at type <code>&amp;T</code></p>



<a name="276750275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750275">(Mar 26 2022 at 22:51)</a>:</h4>
<p>I had actually forgotten (if I ever knew) the precise things the breaks under pointer provenance being ~vibes~ and tbh was mostly remotivating myself off of the fact that miri and CHERI both reify it and it sucks shit that the reification doesn't work</p>



<a name="276750286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750286">(Mar 26 2022 at 22:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276750248">said</a>:</p>
<blockquote>
<p>I'm not claiming that any optimization is incorrect, I'm trying to understand how MIRI justifies reporting UB (it does) if the provenance does not change on the load at type <code>&amp;T</code></p>
</blockquote>
<p>there isnt even a load at type &amp;T here...?</p>



<a name="276750297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750297">(Mar 26 2022 at 22:51)</a>:</h4>
<p>The load of <code>_1</code> that has to occur in order to dereference its value</p>



<a name="276750311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750311">(Mar 26 2022 at 22:52)</a>:</h4>
<p>miri reports UB because you are writing using a pointer that has a tag whose associated permission is ReadOnly</p>



<a name="276750346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750346">(Mar 26 2022 at 22:52)</a>:</h4>
<p><em>all</em> tags on the memory <code>r</code> points to have that permission so whether or not provenane ever changes doesnt even matter for this example</p>



<a name="276750348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750348">(Mar 26 2022 at 22:52)</a>:</h4>
<p>Or does <code>*_1</code> not perform a place to value conversion of <code>_1</code> at its type</p>



<a name="276750354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750354">(Mar 26 2022 at 22:52)</a>:</h4>
<p><code>&amp;raw const (*_1)</code> never loads _1, there is no place-to-val conversion here</p>



<a name="276750364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750364">(Mar 26 2022 at 22:53)</a>:</h4>
<p>So how does dereferencing work?</p>



<a name="276750367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750367">(Mar 26 2022 at 22:53)</a>:</h4>
<p>it constructs a place</p>



<a name="276750381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750381">(Mar 26 2022 at 22:53)</a>:</h4>
<p>and <code>&amp;</code> turns a place into a value (namely a pointer pointing to the memory denoted by the place)</p>



<a name="276750439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750439">(Mar 26 2022 at 22:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276750275">said</a>:</p>
<blockquote>
<p>I had actually forgotten (if I ever knew) the precise things the breaks under pointer provenance being ~vibes~ and tbh was mostly remotivating myself off of the fact that miri and CHERI both reify it and it sucks shit that the reification doesn't work</p>
</blockquote>
<p>oh I see. well at least for Miri that is all exactly the same reason. ;)</p>



<a name="276750447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750447">(Mar 26 2022 at 22:55)</a>:</h4>
<p>So, a place is not</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">SimplePlace</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">memory</span>: <span class="nc">Range</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// other stuff</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Place</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Direct</span><span class="p">(</span><span class="n">SimplePlace</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Indirect</span><span class="p">(</span><span class="n">Place</span><span class="p">),</span><span class="w"> </span><span class="c1">// Dereferencing constructs this</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276750502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750502">(Mar 26 2022 at 22:56)</a>:</h4>
<p>no a place is basically</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Place</span><span class="p">(</span><span class="n">Pointer</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="276750510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750510">(Mar 26 2022 at 22:56)</a>:</h4>
<p>(it also has a type ofc)</p>



<a name="276750517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750517">(Mar 26 2022 at 22:57)</a>:</h4>
<p>basically, look at Miri's <code>MemPlace</code>, that's what a place is</p>



<a name="276750525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750525">(Mar 26 2022 at 22:57)</a>:</h4>
<p>Miri's <code>Place</code> exists just as an optimization to make the interpreter faster, it doesnt exist in the semantics</p>



<a name="276750526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750526">(Mar 26 2022 at 22:57)</a>:</h4>
<p>What is <code>pointer</code> though? Is it the memory address, ie a <code>usize</code> (ish)?</p>



<a name="276750535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750535">(Mar 26 2022 at 22:57)</a>:</h4>
<p>your life is better if you can treat <code>Pointer</code> as an opaque thing that you dont know the internals of ;)</p>



<a name="276750541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750541">(Mar 26 2022 at 22:57)</a>:</h4>
<p>but basically it's a pair of an address and a provenance</p>



<a name="276750543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750543">(Mar 26 2022 at 22:57)</a>:</h4>
<p>Well, right, but this seems to justify my interpretation</p>



<a name="276750584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750584">(Mar 26 2022 at 22:58)</a>:</h4>
<p>In order to compute the pointer to put into the place for <code>*_1</code>, we need to load the data at <code>_1</code></p>



<a name="276750593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750593">(Mar 26 2022 at 22:58)</a>:</h4>
<p>I don't think that place contains a pointer, but they're one and the same.</p>



<a name="276750596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750596">(Mar 26 2022 at 22:58)</a>:</h4>
<p>we are talking about <code>&amp;raw const (*_1)</code> right?</p>



<a name="276750598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750598">(Mar 26 2022 at 22:58)</a>:</h4>
<p>there is no pointer put into the place <code>*_1</code> here</p>



<a name="276750606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750606">(Mar 26 2022 at 22:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276750596">said</a>:</p>
<blockquote>
<p>we are talking about <code>&amp;raw const (*_1)</code> right?</p>
</blockquote>
<p>My impression was that it shouldn't matter and these things compose</p>



<a name="276750610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750610">(Mar 26 2022 at 22:59)</a>:</h4>
<p>yes they do</p>



<a name="276750617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750617">(Mar 26 2022 at 22:59)</a>:</h4>
<p>so <code>_1</code> is a value expression that denotes some kind of pointer</p>



<a name="276750623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750623">(Mar 26 2022 at 22:59)</a>:</h4>
<p><code>*</code> then creates a <code>Place</code> with that exact pointer</p>



<a name="276750624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750624">(Mar 26 2022 at 22:59)</a>:</h4>
<p>ie my question is "does the construction of the place <code>*_1</code> load the memory at <code>_1</code>?"</p>



<a name="276750627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750627">(Mar 26 2022 at 22:59)</a>:</h4>
<p>and <code>&amp;</code> turns that back into a value with that exact pointer</p>



<a name="276750635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750635">(Mar 26 2022 at 22:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276750624">said</a>:</p>
<blockquote>
<p>ie my question is "does the construction of the place <code>*_1</code> load the memory at <code>_1</code>?"</p>
</blockquote>
<p>no, never</p>



<a name="276750682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750682">(Mar 26 2022 at 23:00)</a>:</h4>
<p>(assuming I understand what you mean by "memory at")</p>



<a name="276750731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750731">(Mar 26 2022 at 23:00)</a>:</h4>
<p>Ehh, I mean "the memory of <code>_1</code>", ie the memory in the local</p>



<a name="276750742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750742">(Mar 26 2022 at 23:00)</a>:</h4>
<p>ofc actually <code>_1</code> is itself a place and the full syntax for your expression is <code>&amp;raw const (*load(_1))</code></p>



<a name="276750743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750743">(Mar 26 2022 at 23:00)</a>:</h4>
<p>Not the memory being referred to</p>



<a name="276750755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750755">(Mar 26 2022 at 23:00)</a>:</h4>
<p>using <code>load</code> as syntax for place-to-val conversion</p>



<a name="276750776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750776">(Mar 26 2022 at 23:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276750742">said</a>:</p>
<blockquote>
<p>ofc actually <code>_1</code> is itself a place and the full syntax for your expression is <code>&amp;raw const (*load(_1))</code></p>
</blockquote>
<p>We just spent the last 10 minutes talking past each other then lol</p>



<a name="276750780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750780">(Mar 26 2022 at 23:01)</a>:</h4>
<p>but that's not really changing anything? sorry I lost track of what the question is</p>



<a name="276750784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750784">(Mar 26 2022 at 23:01)</a>:</h4>
<p>damn :(</p>



<a name="276750785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750785">(Mar 26 2022 at 23:01)</a>:</h4>
<p>I mean it loads the bytes that are in the local <code>_1</code></p>



<a name="276750791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276750791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276750791">(Mar 26 2022 at 23:01)</a>:</h4>
<p>okay could you write an example and explicit place2val conversion?</p>



<a name="276753179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276753179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276753179">(Mar 26 2022 at 23:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748240">said</a>:</p>
<blockquote>
<p>also re: strict aliasing, AFAIK PNVI 'relies' on strict aliasing in the sense that that means they dont have to worry about things like <em>any load at integer type</em> potentially exposing a pointer that is being loaded...</p>
</blockquote>
<p>I haven't tested load elimination, but on your example in the issue a long time ago, Cerberus prevents redundant store elimination... Although I'm not sure how many compilers are actually aware of that and wont silently miscompile programs.</p>



<a name="276754302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276754302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276754302">(Mar 27 2022 at 00:24)</a>:</h4>
<p><em>nervous laughter</em></p>



<a name="276754525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276754525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276754525">(Mar 27 2022 at 00:30)</a>:</h4>
<p>-fno-strict-aliasing exists so you could see how it behaves if there's a good test that doesn't run also into the cast-based bugs</p>



<a name="276754552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276754552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276754552">(Mar 27 2022 at 00:31)</a>:</h4>
<p>(and somewhat assuming that they'll actually fix any issues there equivalent to the cast bugs)</p>



<a name="276789465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276789465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276789465">(Mar 27 2022 at 13:52)</a>:</h4>
<p>the thing is that my miscompilation examples are theoretical</p>



<a name="276789469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276789469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276789469">(Mar 27 2022 at 13:52)</a>:</h4>
<p>as in, they chain together a bunch of optimizations that compilers <em>might</em> do -- in the sense that they consider them legal and will do them under certain circumstances</p>



<a name="276789495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276789495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276789495">(Mar 27 2022 at 13:53)</a>:</h4>
<p>going from there to <em>actually</em> getting a compiler to do the right sequence of optimizations in the right order is rather tricky</p>



<a name="276789513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276789513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276789513">(Mar 27 2022 at 13:53)</a>:</h4>
<p>with some help I managed to do that for the example from my blog post here: <a href="https://bugs.llvm.org/show_bug.cgi?id=35229">https://bugs.llvm.org/show_bug.cgi?id=35229</a><br>
EDIT: actually that's a slightly different example, where LLVM does GVN on pointers. (the example does it on integers.)</p>



<a name="276789573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276789573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276789573">(Mar 27 2022 at 13:54)</a>:</h4>
<p>but I haven't tried it for the more complicated examples involving <code>restrict</code> or type punning</p>



<a name="276806617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276806617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276806617">(Mar 27 2022 at 20:38)</a>:</h4>
<p>even without explicit examples of miscompilation, it would be good to have examples of the sort of alias info SB/restrict are supposed to guarantee but which seem /likely/ to be broken by int2ptr/transmute roundtrips (since a lot of the examples are just basic brokenness)</p>



<a name="276806916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276806916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276806916">(Mar 27 2022 at 20:45)</a>:</h4>
<p>we can ask "is this optimization sound under that memory model", but you are asking something else and I have no clue what.^^</p>



<a name="276808664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276808664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276808664">(Mar 27 2022 at 21:24)</a>:</h4>
<p>I mean things like "we want SB to permit the optimization of </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="k">struct</span><span class="p">.</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="k">struct</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>but this breaks if &amp;mut + field doesn't narrow narrow provenance"<br>
only for <code>as usize</code> + <code>as *mut T</code> and pointer-to-pointer/pointer-to-usize casts/transmutes</p>



<a name="276809336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276809336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276809336">(Mar 27 2022 at 21:38)</a>:</h4>
<p>well <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-860189806">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-860189806</a> (which I referenced above in this thread) is an example for pointer-to-usize transmutes (by means of type-punned loads)</p>



<a name="276810510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276810510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276810510">(Mar 27 2022 at 22:05)</a>:</h4>
<p>The point is that that particular example is plausibly fixable as we talked about earlier, because it's simple enough and all available for the compiler to do alias analysis on. You said that the simple fixes around detecting potential aliasing wouldn't work with SB's restrict-like optimizations, and examples of that would be good. (Because even restrict-based examples I've seen for ptrtoint like <a href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151521.html">https://lists.llvm.org/pipermail/llvm-dev/2021-June/151521.html</a> seem bogus - that one is importing knowledge of a ptrtoint cast without importing the alias info that making ptrtoint a side effect is meant to preserve)</p>



<a name="276813120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276813120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276813120">(Mar 27 2022 at 23:14)</a>:</h4>
<p>I'm sorry I don't know which point you are trying to make. The example demonstrates that when you have "load followed by store of the same value to the same address", you cannot eliminate the store. is the "simple fix" you refer to to simply not do that optimization? Sure that's always a fix...</p>



<a name="276813165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276813165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276813165">(Mar 27 2022 at 23:15)</a>:</h4>
<p>sure we could teach the compiler to detect this particular surrounding pattern and not do the optimization then, but it is impossible to do this soundly. (we <em>could</em> teach the compiler to not do the optimization <em>unless</em> it has more information, of course. that's equivalent to saying "sure this optimizaton is wrong but there are other correct optimizations", which is obviously true and so I don't see the point of it.)</p>



<a name="276813221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276813221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276813221">(Mar 27 2022 at 23:17)</a>:</h4>
<p>you can always spread this across enough different TUs that the compiler only sees the "load followed by store of the same value" and nothing else, and we have to decide if it's legal to remove the store or not. the answer is, if we say that a load implicitly performs a ptr2int cast, then it is not legal to remove the store. note that whether or not ptr2int has a side-effect doesn't even matter here, the argument applies even if we find a side-effect-free way of doing ptr2int.</p>



<a name="276813231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276813231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276813231">(Mar 27 2022 at 23:17)</a>:</h4>
<p>the other example related to <code>restrict</code> is in a similar vein. I dont know in which sense you think it is "bogus". all these examples demonstrate that certain ways of doing optimizations (including the way LLVM and everyone else currently does it) is "bogus", that is literally their entire point.</p>



<a name="276813504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276813504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276813504">(Mar 27 2022 at 23:25)</a>:</h4>
<p>if you already agree that ptr2int has a side-effect then sure the examples will not change your mind since you are already a believer. ;) but most of the ecosystem has certainly not accepted this; LLVM <em>will</em> remove ptr2int if their result is unused.</p>



<a name="276813572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276813572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276813572">(Mar 27 2022 at 23:26)</a>:</h4>
<p>(and yes I know they have a side-effect in PNVI, but that's a surface language memory model so design constraints are very different. just because they have a side-effect in C doesn't mean they have to have a side-effect in LLVM. for example, integer addition has a potential side-effect in C [UB], but is always pure in LLVM, and that is totally sound.)</p>



<a name="276821936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276821936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276821936">(Mar 28 2022 at 02:51)</a>:</h4>
<p>Hmm, I misremembered the llvm-dev example's argument and misread it when I doublechecked it. I thought it was showing additional problems with <code>restrict</code> rather than being an argument about the original ptr2int-as-sideeffect.</p>
<p>The "simple" fix I was referring to the discussion around <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748675">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/276748675</a> - it sounded maybe plausible to me that there are ways under SB that (alias knowledge about) a pointer could escape via int shenanigans but be forbidden from escaping into globals, but I couldn't actually figure one out. This is what I wanted an example of.</p>
<p>However related to your point about TU splitting and, the UCG/286 example split up as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// init...</span>
<span class="w">    </span><span class="o">*</span><span class="n">storage_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paddr</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">storage_usize</span><span class="p">,</span><span class="w"> </span><span class="n">qaddr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">**</span><span class="n">storage_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">storage_usize</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">storage_usize</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">storage_usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>makes a point that optimization /followed/ by inlining could erase the relevant alias information that might otherwise get around <code>x == y</code> being a lie. I suppose that could somehow be tracked, but it's not obvious how. Requiring inlining to be before those passes seems worse, but maaaybe. (Though it looks like clang/llvm isn't doing this particular store optimization anyways for some reason, but it certainly looks like something that should be permitted in general)</p>



<a name="276823145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276823145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276823145">(Mar 28 2022 at 03:12)</a>:</h4>
<p>(I suppose a store of <code>paddr</code> to a known int-aliased memory could lose its known provenance, but at best then you need to not erase /that/ cast which has less direct downside but seems ugly; particularly if llvm makes all pointers just being <code>pointer</code>, so you'd need to keep _an_ int access)</p>



<a name="276827137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/276827137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#276827137">(Mar 28 2022 at 04:52)</a>:</h4>
<p>Thinking on this later, I'm still not sure that the original sort of solution I mentioned in the issue is a disaster: these dead stores have to be erased to <code>wrote_to(storage_usize)</code>. In particular, pointers still can have <code>if *x == a { *x = a; }</code> be not-a-NOP unless pointer equality is full on UB for overlapping addresses (which is a violation of C2x if C equality is lowered to <code>==</code>, and is certainly a violation of rust PartialEq for the same). So it's a question of if maintaining that sort of metadata instruction is likely to prevent too many optimizations when applied to non-<code>char</code> integers.</p>
<p>(Yes it would require compiler changes, but given how much pointer equality and ptrtoint equality is broken in other ways where the obvious solution is also to keep metadata/not erase instructions, I don't think that is a valid objection)</p>



<a name="277008596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277008596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277008596">(Mar 29 2022 at 14:00)</a>:</h4>
<blockquote>
<p>Requiring inlining to be before those passes seems worse, but maaaybe. (Though it looks like clang/llvm isn't doing this particular store optimization anyways for some reason, but it certainly looks like something that should be permitted in general)</p>
</blockquote>
<p>The compiler usually expects to be able to apply passes in any order, and in practice with LTO, you can have a situation where first the compiler runs an optimization pass on just the current translation unit to produce the <code>.o</code> file, then the linker runs another optimization pass on all <code>.o</code> files, including inlining.  I don't think this is viable.</p>



<a name="277009207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277009207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277009207">(Mar 29 2022 at 14:04)</a>:</h4>
<blockquote>
<p>The compiler usually expects to be able to apply passes in any order</p>
</blockquote>
<p>lmao</p>



<a name="277009227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277009227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277009227">(Mar 29 2022 at 14:04)</a>:</h4>
<p>the llvm pass ordering struggle is Real</p>



<a name="277009513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277009513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277009513">(Mar 29 2022 at 14:06)</a>:</h4>
<p>Oh?  I know that pass ordering is a problem when it comes to generating optimal code - it's easy to miss optimizations - but I haven't heard of it being a problem for correctness.  I suppose there are analysis passes, but those have dependencies tracked explicitly...</p>



<a name="277010988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277010988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277010988">(Mar 29 2022 at 14:16)</a>:</h4>
<p>maybe it has gotten Better but my understanding is that in practice <em>MANY</em> passes are completely broken if they don't happen in the right order, and this order is completely unspecified because it's not intentional, but just a tower of poorly-specified cards that happen to work in the configurations people happen to use them in</p>



<a name="277011033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277011033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277011033">(Mar 29 2022 at 14:17)</a>:</h4>
<p>hrm, interesting.</p>



<a name="277011101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277011101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277011101">(Mar 29 2022 at 14:17)</a>:</h4>
<p>so yeah in general "this pass depends on this other pass" is extremely normal load-bearing stuff</p>



<a name="277011126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277011126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277011126">(Mar 29 2022 at 14:17)</a>:</h4>
<p>sad, but normal</p>



<a name="277011235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277011235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277011235">(Mar 29 2022 at 14:18)</a>:</h4>
<p>Do you have any examples?</p>



<a name="277011304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277011304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277011304">(Mar 29 2022 at 14:19)</a>:</h4>
<p>no this is just folklore to me, from compiler devs being sad</p>



<a name="277011314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277011314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277011314">(Mar 29 2022 at 14:19)</a>:</h4>
<p>Fair enough.</p>



<a name="277016597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277016597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277016597">(Mar 29 2022 at 14:52)</a>:</h4>
<blockquote>
<p>these dead stores have to be erased to <code>wrote_to(storage_usize)</code>.</p>
</blockquote>
<p>My mediocre knowledge of LLVM optimizations says this could work.  Keep in mind that many dead stores are not of the form "load then store same value", but rather "store the same value twice".  For the latter type of dead store, the compiler knows which instruction originally stored the value; instead of adding any "wrote_to" instruction, it could move the <code>ptrtoint</code>-<code>inttoptr</code> conversion to happen earlier, before the original store, making the later store truly dead.  This would be less likely to inhibit future optimizations.  Similarly, if the compiler doesn't know which instruction stored the value but knows it must be one of a small list of possibilities (all in the current function), then it could add the conversion to all of them.  </p>
<p>A major caveat is that <code>inttoptr</code> is defined as reconstituting provenance for something that _has been_ converted to integer, not something that _will be_ converted to integer in the future.  So in general it's not actually valid to move a <code>inttoptr</code> to earlier in the function, since you may be moving it past the <code>ptrtoint</code> that it's grabbing provenance from.  But it would be very useful to be able to move up <code>ptrtoint</code>-<code>inttoptr</code> pairs.  So I think it might make sense to define <code>inttoptr</code> in IR more broadly than it's defined in surface semantics – to say that it potentially pairs with a later <code>ptrtoint</code> rather than just an earlier one, allowing it to be moved up.  Alternately, create a different conversion that does have that broader definition.</p>



<a name="277019133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277019133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277019133">(Mar 29 2022 at 15:08)</a>:</h4>
<p>woah, doesn't reading values from the future have out-of-thin-air problems?</p>



<a name="277019421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277019421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277019421">(Mar 29 2022 at 15:10)</a>:</h4>
<p>the damage here is limited since it's restricted to runtime-invisible stuff, but I think you could still use it to forge provenance you couldn't possibly have obtained</p>



<a name="277019586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277019586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277019586">(Mar 29 2022 at 15:11)</a>:</h4>
<p>Perhaps; I haven't thought about it.  But as long as we're talking about provenance as interpreted in a compiler IR, the worst possible outcome is "the compiler optimizes as if these accesses could alias even though they really can't", so the damage really is limited.</p>



<a name="277036859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277036859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277036859">(Mar 29 2022 at 17:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/277011304">said</a>:</p>
<blockquote>
<p>no this is just folklore to me, from compiler devs being sad</p>
</blockquote>
<p>Come on, use the word, you know you want to =)</p>



<a name="277225629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277225629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277225629">(Mar 31 2022 at 02:24)</a>:</h4>
<p>Also something to add. ptr2int2ptr may be problematic for code with a low MSRV. I write some low level 1.54 code. I don't think I have need for any ptr2int/int2ptr shenanigans, but I won't have strict-provenance available if I do.</p>



<a name="277227922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277227922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277227922">(Mar 31 2022 at 03:06)</a>:</h4>
<p>So maybe there should be a documented way to polyfill them?</p>



<a name="277227955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277227955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277227955">(Mar 31 2022 at 03:07)</a>:</h4>
<p>the top of the tracking issue literally links the stable polyfill that works on like rust 1.10 probably because it just uses wrapping_add</p>



<a name="277229147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229147">(Mar 31 2022 at 03:32)</a>:</h4>
<p>You'll have to dial back its edition, at least</p>



<a name="277229183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229183">(Mar 31 2022 at 03:33)</a>:</h4>
<p>ah sure, forgot 2021 is a thing now</p>



<a name="277229457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229457">(Mar 31 2022 at 03:37)</a>:</h4>
<p>publish 0.2.2 as rust 2015 with literally no changes lol</p>



<a name="277229557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229557">(Mar 31 2022 at 03:39)</a>:</h4>
<p>Nice <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="277229642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229642">(Mar 31 2022 at 03:40)</a>:</h4>
<p>i have no idea what rust 2018+ changed but i doubt i use it because i am ancient rust ghoul</p>



<a name="277229744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229744">(Mar 31 2022 at 03:43)</a>:</h4>
<p>It should probably be <code>#![no_std]</code></p>



<a name="277229763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229763">(Mar 31 2022 at 03:43)</a>:</h4>
<p><code>const fn</code> will be version-limiting, regardless of edition</p>



<a name="277229815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229815">(Mar 31 2022 at 03:44)</a>:</h4>
<p>And <code>impl Trait</code></p>



<a name="277229839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229839">(Mar 31 2022 at 03:45)</a>:</h4>
<p>I'm sure you'll draw the line somewhere, but I'm just looking for things that haven't been around forever</p>



<a name="277229930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277229930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277229930">(Mar 31 2022 at 03:47)</a>:</h4>
<p><code>pointer::cast</code> is 1.38</p>



<a name="277256572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277256572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277256572">(Mar 31 2022 at 09:49)</a>:</h4>
<p>the regex crate's msrv is 1.41, and regex is the standard for conservative msrv. (libc's is 1.13, but that's because libc is silly)</p>



<a name="277280915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277280915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277280915">(Mar 31 2022 at 13:33)</a>:</h4>
<p>I've recently published a new crate version that still works on 1.34, but that does feel like an outlier. Anything older than Stable Debain's rustc is probably an outlier.</p>



<a name="277281434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277281434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277281434">(Mar 31 2022 at 13:37)</a>:</h4>
<p>syn is 1.31</p>



<a name="277347352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277347352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277347352">(Mar 31 2022 at 22:16)</a>:</h4>
<p><code>memoffset</code> is 1.19+ because we dont want to give people any excuse not to use it^^</p>



<a name="277354210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277354210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277354210">(Mar 31 2022 at 23:39)</a>:</h4>
<p>For what it's worth, <a href="https://packages.debian.org/stable/rust/rustc">Debian stable rustc</a> is rustc 1.48.</p>



<a name="277375241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277375241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277375241">(Apr 01 2022 at 06:25)</a>:</h4>
<p>Hey so is there a "wildcard function pointer" type in Rust?</p>



<a name="277375299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277375299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277375299">(Apr 01 2022 at 06:26)</a>:</h4>
<p>It feels like something I should know but it just completely escapes me and I have no idea what I would even a search for.</p>



<a name="277375306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277375306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277375306">(Apr 01 2022 at 06:26)</a>:</h4>
<p>seeing as I know that was one of the things that came up a bunch in the PR re: "Oxford casts"</p>



<a name="277387603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277387603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> riking <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277387603">(Apr 01 2022 at 08:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/277375241">said</a>:</p>
<blockquote>
<p>Hey so is there a "wildcard function pointer" type in Rust?</p>
</blockquote>
<p>No, adding it is one of the A-strict-provenance issues I think</p>



<a name="277387764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277387764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277387764">(Apr 01 2022 at 09:00)</a>:</h4>
<p>Ah okay, thought so but wanted to make sure. Designer hat time!</p>



<a name="277458515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277458515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277458515">(Apr 01 2022 at 18:13)</a>:</h4>
<p>I opened <a href="https://github.com/Gankra/sptr/pull/2">sptr#2</a> to support MSRV 1.31 -- going any further will have to deal with conditional <code>const fn</code></p>



<a name="277540434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases%20for%20unrestricted%20ptr2int2ptr/near/277540434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr.html#277540434">(Apr 02 2022 at 17:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Use-cases.20for.20unrestricted.20ptr2int2ptr/near/277011304">said</a>:</p>
<blockquote>
<p>no this is just folklore to me, from compiler devs being sad</p>
</blockquote>
<p>In theory the passes _should_ be independent. In practice ordering matters first and foremost because some passes convert the IR to a shape that the next one expects to work with – we don't want to have each pass re-do all the preparatory work if the previous one can do it for free. For MIR due to its phased nature misordered passes will cause significant issues because pass might not be expecting to get e.g. pre-drop-elaboration IR and just ICE or do the wrong thing with e.g. <code>drop</code>s.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>