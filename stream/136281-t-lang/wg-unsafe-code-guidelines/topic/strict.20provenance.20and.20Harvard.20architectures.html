<html>
<head><meta charset="utf-8"><title>strict provenance and Harvard architectures · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html">strict provenance and Harvard architectures</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276794922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276794922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276794922">(Mar 27 2022 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> I saw you cursing about fn ptr issues with AVR and you keep mentioning them here as well, but I don't actually understand the problem. Could you summarize what the issue is?</p>



<a name="276794968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276794968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276794968">(Mar 27 2022 at 16:02)</a>:</h4>
<p>There are a few problems</p>



<a name="276794992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276794992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276794992">(Mar 27 2022 at 16:03)</a>:</h4>
<ol>
<li>Function Pointers and Data Pointers may be in different segments/representations and therefore a fn&lt;-&gt;*mut cast has unclear semantics</li>
</ol>



<a name="276795053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795053">(Mar 27 2022 at 16:05)</a>:</h4>
<ol start="2">
<li>Because those casts have unclear semantics, it is desirable to go directly to usize because this can have a more coherent interpretation and Actually Avoids ICEs on AVR (WASM is the other example but we make it "work" there more)</li>
</ol>
<p><a href="https://doc.rust-lang.org/src/core/ptr/mod.rs.html#1431">https://doc.rust-lang.org/src/core/ptr/mod.rs.html#1431</a></p>
<p><a href="https://github.com/avr-rust/rust/issues/143">https://github.com/avr-rust/rust/issues/143</a></p>



<a name="276795119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795119">(Mar 27 2022 at 16:07)</a>:</h4>
<ol start="3">
<li>The absence of a way to generically/opaquely talk about "some" function pointer encourages you to cast them to *mut or ints to do so (the linux dynamic linking code just <em>transmute_copies</em> an int to T where T is just blindly assumed to be a function pointer of the expected type)</li>
</ol>



<a name="276795212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795212">(Mar 27 2022 at 16:09)</a>:</h4>
<p>do fn ptrs have provenance though?</p>



<a name="276795215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795215">(Mar 27 2022 at 16:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795119">said</a>:</p>
<blockquote>
<p>some code in the linux dynamic linking function loading code just <em>transmute_copies</em> an int to T</p>
</blockquote>
<p>There's also the fact that<code>dlsym</code> returns a <code>void *</code> and it could be either a function pointer or a pointer to data (static), so some mechanism to construct a pointer in the correct addrspace with address from <code>void *</code> is necessary…</p>



<a name="276795310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795310">(Mar 27 2022 at 16:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795212">said</a>:</p>
<blockquote>
<p>do fn ptrs have provenance though?</p>
</blockquote>
<p>In my head they should because you "shouldn't" be allowed to call a function you have no business knowing about, but tbh my main concern is just straight-up getting confusing/incorrect results at runtime when trying to do things like compare function pointers</p>



<a name="276795354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795354">(Mar 27 2022 at 16:12)</a>:</h4>
<p>(function pointers <em>can</em> be freed by unlinking dynamic code!)</p>



<a name="276795374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795374">(Mar 27 2022 at 16:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795212">said</a>:</p>
<blockquote>
<p>do fn ptrs have provenance though?</p>
</blockquote>
<p>Sort of? It's far more limited than raw pointer provenance.</p>



<a name="276795378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795378">(Mar 27 2022 at 16:13)</a>:</h4>
<p>AFAIK compilers so far dont do interesting provenance analysis on fn ptrs so we could treat them as not having provenance. but who knows what compiler authors will do in the future...</p>



<a name="276795457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795457">(Mar 27 2022 at 16:15)</a>:</h4>
<p>yeah it's less memory-model and more "we are generating garbage because we are letting people ask questions we do not properly define the answers to" (and which may have no coherent answer)</p>



<a name="276795460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795460">(Mar 27 2022 at 16:15)</a>:</h4>
<p>OTOH in Miri they do have provenance. in fact they are basically "only provenance" since there is no offsetting...</p>



<a name="276795518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795518">(Mar 27 2022 at 16:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795457">said</a>:</p>
<blockquote>
<p>yeah it's less memory-model and more "we are generating garbage because we are letting people ask questions we do not properly define the answers to" (and which may have no coherent answer)</p>
</blockquote>
<p>I would have expected that fn ptr to raw ptr cast is basically a transmute, so the fact that their address space is disjoint doesn't matter. is that not coherent?</p>



<a name="276795535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795535">(Mar 27 2022 at 16:16)</a>:</h4>
<p>It could be a transmute but it also could not be.</p>



<a name="276795537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795537">(Mar 27 2022 at 16:17)</a>:</h4>
<p>The AVR backend seems to disagree! I haven't looked into the details.</p>



<a name="276795553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795553">(Mar 27 2022 at 16:17)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> sure but what I am saying is: in Rust we should define it to be. Is there anything wrong with that?</p>



<a name="276795559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795559">(Mar 27 2022 at 16:17)</a>:</h4>
<p>On 8086, with <code>-mnear-data-far-fn</code>, you can't transmute from data pointers to fn pointers (nor the other way arround, but you can transmute_copy in reverse).</p>



<a name="276795570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795570">(Mar 27 2022 at 16:17)</a>:</h4>
<p>ah I should have known you would pull up some obscure system from the 80s ;)</p>



<a name="276795609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795609">(Mar 27 2022 at 16:18)</a>:</h4>
<p>In WASM there is just a fixed-size array of functions and a "function pointer" is actually an index into that array. You can turn that into a "fake" pointer like any integer, but you are doing something Confusing to say the least at that point.</p>



<a name="276795618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795618">(Mar 27 2022 at 16:18)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> I view that array as just another address space <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="276795631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795631">(Mar 27 2022 at 16:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795570">said</a>:</p>
<blockquote>
<p>ah I should have known you would pull up some obscure system from the 80s ;)</p>
</blockquote>
<p>:P.<br>
I mean, I do want to work on codegen for 8086, so...</p>



<a name="276795636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795636">(Mar 27 2022 at 16:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795618">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> I view that array as just another address space <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
</blockquote>
<p>Yep, but Rust has punted on What That Means up until now, and it would be good to... Not.</p>



<a name="276795707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795707">(Mar 27 2022 at 16:20)</a>:</h4>
<p>Like ideally, just as with strict-provenance, we could make it easier in rust to stay in fn-ptr land forever and not cross the streams because doing so raises Questions</p>



<a name="276795708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795708">(Mar 27 2022 at 16:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795631">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276795570">said</a>:</p>
<blockquote>
<p>ah I should have known you would pull up some obscure system from the 80s ;)</p>
</blockquote>
<p>:P.<br>
I mean, I do want to work on codegen for 8086, so...</p>
</blockquote>
<p>yeah fair, I'm just to a fan of mistakes or obsolete decisions made in the 80s holding us back now. ;)</p>



<a name="276795714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795714">(Mar 27 2022 at 16:20)</a>:</h4>
<p>Anyways, either form of "One is a near pointer, one is a far pointer" would stop transmutes, and stop transmute_copy in one direction.<br>
The transmute_copy could also be nonsensical, depending on the order of <code>(offset,segment)</code> (I'd probably want to define it to be that order, but if other compilers think it's the other way arround...)</p>



<a name="276795744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795744">(Mar 27 2022 at 16:21)</a>:</h4>
<p>We can have Answers That Are Coherent to those questions but it will be in some sense "garbage in, garbage out", and it would be good to avoid the "garbage in" part</p>



<a name="276795755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795755">(Mar 27 2022 at 16:21)</a>:</h4>
<p>so basically, we need a RawFnPtr type?</p>



<a name="276795759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795759">(Mar 27 2022 at 16:22)</a>:</h4>
<p>yeah that's my default solution</p>



<a name="276795802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795802">(Mar 27 2022 at 16:22)</a>:</h4>
<p>hey I thought I'm the type system guy here^^</p>



<a name="276795809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795809">(Mar 27 2022 at 16:22)</a>:</h4>
<p><code>#[repr(transparent)] OpaqueFnPtr(fn() -&gt; ())</code></p>



<a name="276795810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795810">(Mar 27 2022 at 16:22)</a>:</h4>
<p>can just be some shit in the stdlib</p>



<a name="276795825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795825">(Mar 27 2022 at 16:22)</a>:</h4>
<p>hm it doesnt need lang suppport?</p>



<a name="276795839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795839">(Mar 27 2022 at 16:23)</a>:</h4>
<p>it might just to define casts or something, needs Design Work</p>



<a name="276795848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795848">(Mar 27 2022 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> Also <em>I'm</em> the one who gave you NonNull and Unique to play with :p</p>



<a name="276795849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795849">(Mar 27 2022 at 16:23)</a>:</h4>
<p>fn ptr's only validity invariant is !null, so it could probably sit in stdlib with the defn being <code>Option&lt;fn()&gt;</code> instead of just <code>fn()</code>.</p>



<a name="276795900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795900">(Mar 27 2022 at 16:24)</a>:</h4>
<p>yeah but you cant write code that is generic over all fn ptrs</p>



<a name="276795905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795905">(Mar 27 2022 at 16:24)</a>:</h4>
<p>like converting them to/from RawFnPtr</p>



<a name="276795923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795923">(Mar 27 2022 at 16:25)</a>:</h4>
<p>(I think I prefer Raw over Opaque, in analogy with raw pointers)</p>



<a name="276795925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795925">(Mar 27 2022 at 16:25)</a>:</h4>
<p>True. That needs stuff (but we need that anyways <em>stare</em>)</p>



<a name="276795940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795940">(Mar 27 2022 at 16:25)</a>:</h4>
<p>The level one solution is just "yeah still do the transmute", but at least the type is always known by the compiler to be A Function Pointer and handled as such</p>



<a name="276795985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795985">(Mar 27 2022 at 16:26)</a>:</h4>
<p>yeah we'd need <code>T: FnPtr</code> at least...</p>



<a name="276795995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795995">(Mar 27 2022 at 16:26)</a>:</h4>
<p>that or a builtin cast, yeah</p>



<a name="276795998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276795998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276795998">(Mar 27 2022 at 16:26)</a>:</h4>
<p>OTOH if we definitely dont need provenance we could just say <code>RawFnPtr = usize</code>...^^</p>



<a name="276796003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796003">(Mar 27 2022 at 16:27)</a>:</h4>
<p>It can be Whatever Works :)</p>



<a name="276796013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796013">(Mar 27 2022 at 16:27)</a>:</h4>
<p>we already assume they have the same size anyway, right?</p>



<a name="276796020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796020">(Mar 27 2022 at 16:27)</a>:</h4>
<p>I don't think rust assumes <code>size_of::&lt;*mut ()&gt;()==size_of::&lt;fn()&gt;()</code></p>



<a name="276796069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796069">(Mar 27 2022 at 16:28)</a>:</h4>
<p>hm, Miri and CTFE certainly assume that all pointers are the same size -- raw and fn ptrs included</p>



<a name="276796077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796077">(Mar 27 2022 at 16:28)</a>:</h4>
<p>Joy.</p>



<a name="276796088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796088">(Mar 27 2022 at 16:29)</a>:</h4>
<p>and <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/abi/struct.TargetDataLayout.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/abi/struct.TargetDataLayout.html</a> doesnt have fn_ptr_size so I am pretty sure this assumption is all across the compiler</p>



<a name="276796089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796089">(Mar 27 2022 at 16:29)</a>:</h4>
<p>I think it defacto does but there isn't anywhere that <em>says</em> that just because, as I am always complaining, you cannot hang docs off <code>as</code>. Certainly I would want A Better Story For Letting People Stay In FnPtr Repr At All Times before really pushing on that door. For the exact same reasons a side-effect of strict-provenance is making it easier to loosen usize.</p>



<a name="276796091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796091">(Mar 27 2022 at 16:29)</a>:</h4>
<p>(That reminds me, I need to fix something of the kind in lccc...)</p>



<a name="276796149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796149">(Mar 27 2022 at 16:30)</a>:</h4>
<p>Architectures that need fat function pointers (Itanium, for example) tend to specify the ABI such that function pointers are a thin pointer to the fat pointer (the descriptor, on itanium).</p>
<p>And while technically IIUC wasm function pointers could be 32 bits even on wasm64, I don't think this matters in practice, since you can just zero-pad it up.</p>



<a name="276796180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796180">(Mar 27 2022 at 16:31)</a>:</h4>
<p>Technically I suppose for the Rust ABI we could go against this but it's nice to have e.g. dlsym work.</p>



<a name="276796186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796186">(Mar 27 2022 at 16:31)</a>:</h4>
<blockquote>
<p>Architectures that need fat function pointers (Itanium, for example) tend to specify the ABI such that function pointers are a thin pointer to the fat pointer (the descriptor, on itanium).</p>
</blockquote>
<p>lol that's almost what happens to Miri, where a fn ptr is basically a pointer to the <code>ty::Instance</code> of the function ;)</p>



<a name="276796247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796247">(Mar 27 2022 at 16:33)</a>:</h4>
<p>It's a pretty reasonable design</p>



<a name="276796252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796252">(Mar 27 2022 at 16:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276796089">said</a>:</p>
<blockquote>
<p>I think it defacto does but there isn't anywhere that <em>says</em> that just because, as I am always complaining, you cannot hang docs off <code>as</code>. Certainly I would want A Better Story For Letting People Stay In FnPtr Repr At All Times before really pushing on that door. For the exact same reasons a side-effect of strict-provenance is making it easier to loosen usize.</p>
</blockquote>
<p>yeah it'd be kind of a shame to do the nice disciplined thing for raw pointers, and then just say "fn ptrs are NonZeroUsize". OTOH for fn ptrs there's less pressure (due to them not having provenance, at least currently) and it's more annoying (since you can't be generic over them)...</p>



<a name="276796307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796307">(Mar 27 2022 at 16:34)</a>:</h4>
<p>ofc Miri will yell at you if you transmute a fn ptrs to usize since they do have provenance there ;)</p>



<a name="276796309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796309">(Mar 27 2022 at 16:34)</a>:</h4>
<p>hence why this is a "tertiary" goal of strict provenance. If we're already renovating the house, we should take a look at the shed out back, y'know?</p>



<a name="276796339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796339">(Mar 27 2022 at 16:35)</a>:</h4>
<p>fwiw I believe <span class="user-mention" data-user-id="473929">@Alexander Richardson</span>(?) was working on patches in this vein</p>



<a name="276796409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796409">(Mar 27 2022 at 16:37)</a>:</h4>
<p>(and i would be genuinely shocked if CHERI didn't treat function pointers as proper capabilities)</p>



<a name="276796474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276796474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276796474">(Mar 27 2022 at 16:38)</a>:</h4>
<p>I'd have to do some research in how other compilers handled far-fn-ptrs in near-data-ptr models, but intuitively, <code>fn()</code> in <code>-mfar-fn</code> and <code>fn() _far</code> (Not Real Syntax) would be the same, and I'd be suprised if there's an ABI-level difference between far data and far fn-pointers. <br>
If both of these are in fact true, then the double-indirection trick used by Itanium doesn't work.</p>



<a name="276797172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276797172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276797172">(Mar 27 2022 at 16:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276796409">said</a>:</p>
<blockquote>
<p>(and i would be genuinely shocked if CHERI didn't treat function pointers as proper capabilities)</p>
</blockquote>
<p>Yes, function pointers are also capabilities, but they are generally derived from a different root capability so that they have the execute permission, which will not be the case for global data pointers. We have had some "fun" issues in the past where calling into assembly code would crash because the code was missing the <code>.type   foo,@function</code> directive. In that case the run-time linker will derive the capability from the R/W data capability instead of the R/X one spanning the .text segment and jumping to that capability will fault with a Permit_Execute trap.</p>



<a name="276797245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276797245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276797245">(Mar 27 2022 at 16:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276796339">said</a>:</p>
<blockquote>
<p>fwiw I believe <span class="user-mention silent" data-user-id="473929">Alexander Richardson</span>(?) was working on patches in this vein</p>
</blockquote>
<p>the patches I was working on were to parse all pointer descriptions from the LLVM data layout which can then be used to differentiate pointers to the alloca/globals/program address space. I will try to upload those shortly, but please don't expect high-quality code, those are my first ever lines of rust.</p>



<a name="276797305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276797305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276797305">(Mar 27 2022 at 16:58)</a>:</h4>
<p>that is very common for rust-lang contributions, and why IMO code quality/correctness is 95% the problem of the reviewer and not the contributor for all PRs :)</p>



<a name="276806207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276806207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276806207">(Mar 27 2022 at 20:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/276796089">said</a>:</p>
<blockquote>
<p>I think it defacto does but there isn't anywhere that <em>says</em> that just because, as I am always complaining, you cannot hang docs off <code>as</code>. Certainly I would want A Better Story For Letting People Stay In FnPtr Repr At All Times before really pushing on that door. For the exact same reasons a side-effect of strict-provenance is making it easier to loosen usize.</p>
</blockquote>
<p>The reference has a section on as casts <a href="https://doc.rust-lang.org/reference/expressions/operator-expr.html#type-cast-expressions">https://doc.rust-lang.org/reference/expressions/operator-expr.html#type-cast-expressions</a><br>
But I don't know how many people actually read it, and I think the reference might be less normative than std docs</p>



<a name="276806348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276806348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276806348">(Mar 27 2022 at 20:32)</a>:</h4>
<p>It's extremely hard to find anything in the reference, yeah. it feels like it's entirely structured around parsing, the least important thing to "reference" lol</p>



<a name="276806970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276806970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276806970">(Mar 27 2022 at 20:46)</a>:</h4>
<p>at least it has a search but damn a restructure would be welcome.</p>



<a name="276807031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/276807031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#276807031">(Mar 27 2022 at 20:48)</a>:</h4>
<p>well but to be fair at least we <em>have</em> a reference for parsing; on the semantics we have a lot more questions than answers ;)</p>



<a name="277066469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277066469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277066469">(Mar 29 2022 at 21:23)</a>:</h4>
<blockquote>
<p>so basically, we need a RawFnPtr type?</p>
</blockquote>
<p>While you're at it, introduce a <code>Ptr</code> type and deprecate <code>*const T</code> and <code>*mut T</code>, thanks :)</p>



<a name="277066980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277066980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277066980">(Mar 29 2022 at 21:28)</a>:</h4>
<p><code>type Ptr&lt;T&gt; = Option&lt;NonNull&lt;T&gt;&gt;;</code></p>



<a name="277068104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068104">(Mar 29 2022 at 21:40)</a>:</h4>
<p>Or just give us a new type, make it bivariant, and let us do what we please.</p>



<a name="277068353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068353">(Mar 29 2022 at 21:42)</a>:</h4>
<p>you know i tried in like 2015 but no one wants to let me change rust's syntax :(</p>



<a name="277068440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068440">(Mar 29 2022 at 21:43)</a>:</h4>
<p>the secret is to make it a macro. they let me add <code>addr_of!</code>. now nobody is happy. hooray!</p>



<a name="277068570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068570">(Mar 29 2022 at 21:45)</a>:</h4>
<p>True.</p>



<a name="277068727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068727">(Mar 29 2022 at 21:47)</a>:</h4>
<p>the telltale signs of a compromise solution ;)</p>



<a name="277068748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068748">(Mar 29 2022 at 21:47)</a>:</h4>
<p>it's good that you did but i do truly hate it with a passion</p>



<a name="277068757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068757">(Mar 29 2022 at 21:47)</a>:</h4>
<p>But also we need a million different kinds of pointer types.<br>
Pointers to different address spaces, near pointers, far pointers, contravariant pointers.</p>



<a name="277068772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068772">(Mar 29 2022 at 21:47)</a>:</h4>
<p>underaligned pointers</p>



<a name="277068836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068836">(Mar 29 2022 at 21:48)</a>:</h4>
<p>Well, those are just raw pointers as they are now.</p>



<a name="277068852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068852">(Mar 29 2022 at 21:48)</a>:</h4>
<p>well, underaligned references</p>



<a name="277068858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068858">(Mar 29 2022 at 21:48)</a>:</h4>
<p>evil</p>



<a name="277068860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068860">(Mar 29 2022 at 21:48)</a>:</h4>
<p>with all reference guarantees except alignment</p>



<a name="277068912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068912">(Mar 29 2022 at 21:48)</a>:</h4>
<p>it's alignment that is evil, really</p>



<a name="277068937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068937">(Mar 29 2022 at 21:49)</a>:</h4>
<p>a world without padding.... aah.........</p>



<a name="277068943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068943">(Mar 29 2022 at 21:49)</a>:</h4>
<p>IDK, I like fast, non-faulting code.</p>



<a name="277068947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277068947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277068947">(Mar 29 2022 at 21:49)</a>:</h4>
<p>alignment's alignment is clearly chaotic evil. or so.</p>



<a name="277069020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069020">(Mar 29 2022 at 21:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/277068937">said</a>:</p>
<blockquote>
<p>a world without padding.... aah.........</p>
</blockquote>
<p>Just sort fields in descending order by alignment requirement. Then you only have tail padding.</p>



<a name="277069086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069086">(Mar 29 2022 at 21:50)</a>:</h4>
<p>I like to pretend that hardware either doesnt exist or is magic and we dont need to leak its limitations into software.</p>



<a name="277069140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069140">(Mar 29 2022 at 21:50)</a>:</h4>
<p>the problem is the existence of <em>any</em> padding and the eternal struggle it introduces for talking about memcpy/memset</p>



<a name="277069189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069189">(Mar 29 2022 at 21:51)</a>:</h4>
<p>like "bytes that exist but don't" is ass</p>



<a name="277069193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069193">(Mar 29 2022 at 21:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/277069086">said</a>:</p>
<blockquote>
<p>I like to pretend that hardware either doesnt exist or is magic and we dont need to leak its limitations into software.</p>
</blockquote>
<p>I also like to pretend I have an infinitely sized address space and it's as efficient to perform 4 reads of 1 byte each as to perform one read of 4 bytes.</p>



<a name="277069202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069202">(Mar 29 2022 at 21:51)</a>:</h4>
<p>dunno, doesnt seem so bad? like it's bad in C but in Rust where we have <code>MaybeUninit</code> it seems fine</p>



<a name="277069229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069229">(Mar 29 2022 at 21:51)</a>:</h4>
<p>it breaks memcmp and some people think they can use it on data with padsding and that truly is terrible</p>



<a name="277069276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069276">(Mar 29 2022 at 21:52)</a>:</h4>
<p>or atomic compare_and_set on data with padding, that's also evil</p>



<a name="277069296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069296">(Mar 29 2022 at 21:52)</a>:</h4>
<p>but otherwise...</p>



<a name="277069318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069318">(Mar 29 2022 at 21:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/277069193">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/277069086">said</a>:</p>
<blockquote>
<p>I like to pretend that hardware either doesnt exist or is magic and we dont need to leak its limitations into software.</p>
</blockquote>
<p>I also like to pretend I have an infinitely sized address space and it's as efficient to perform 4 reads of 1 byte each as to perform one read of 4 bytes.</p>
</blockquote>
<p>oh yes finite memory suuuucks</p>



<a name="277069375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069375">(Mar 29 2022 at 21:53)</a>:</h4>
<p>ah but Ralf, have you considered, finite memory makes all things O(1), so who could really say if it's bad, or not,,</p>



<a name="277069560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069560">(Mar 29 2022 at 21:55)</a>:</h4>
<p>i will accept only two realities: everything is O(1) or i am allowed to use <a href="https://en.wikipedia.org/wiki/Real_RAM">Real RAM</a> in algorithms</p>



<a name="277069568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069568">(Mar 29 2022 at 21:55)</a>:</h4>
<p>everything else is cowardice</p>



<a name="277069689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277069689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277069689">(Mar 29 2022 at 21:56)</a>:</h4>
<p>What I want is pointers that are assumed to point to init data and be aligned, but that aren't exclusive.</p>



<a name="277076701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277076701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277076701">(Mar 29 2022 at 23:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures/near/277069020">said</a>:</p>
<blockquote>
<p>Just sort fields in descending order by alignment requirement. Then you only have tail padding.</p>
</blockquote>
<p>Well <code>repr(Rust)</code> <em>does</em> sort by alignment, these days.  (Just an implementation detail, not a guarantee, of course.)</p>



<a name="277079182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277079182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277079182">(Mar 29 2022 at 23:54)</a>:</h4>
<p>Heh, great minds think alike I guess. That's what I spec'd for lccc's ABI.</p>



<a name="277079889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277079889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277079889">(Mar 30 2022 at 00:03)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> see <a href="https://www.ahicks.io/posts/April%202017/rust-struct-field-reordering/">https://www.ahicks.io/posts/April%202017/rust-struct-field-reordering/</a> for details -- apparently enums sort the other way, to easier sneak in the discriminant at the beginning.</p>



<a name="277080084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict%20provenance%20and%20Harvard%20architectures/near/277080084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/strict.20provenance.20and.20Harvard.20architectures.html#277080084">(Mar 30 2022 at 00:05)</a>:</h4>
<p>Hmm... Nice. Probably won't change the definition, though. It's easier to define enums as unions of structs.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>