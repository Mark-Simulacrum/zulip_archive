<html>
<head><meta charset="utf-8"><title>niche control · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html">niche control</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262861143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262861143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262861143">(Nov 27 2021 at 08:13)</a>:</h4>
<p>Hi, I'm looking at an extension to enable me to do: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C, u32, niches(0))]</span><span class="w"></span>
<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">Field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">transmute</span><span class="p">(</span><span class="mi">0_</span><span class="k">u32</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="fm">assert!</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">is_none</span><span class="p">());</span><span class="w">  </span><span class="c1">// guaranteed</span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">transmute</span><span class="p">(</span><span class="mi">0_</span><span class="k">u32</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="fm">assert!</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">is_err</span><span class="p">());</span><span class="w"> </span><span class="c1">// guaranteed</span>
</code></pre></div>
<p>In this particular case, there is only 1 niche, so that's the only niche that <code>Option</code> and <code>Result</code> can pick. </p>
<p>I'm not advocating for or right now interested in an extension like: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C, u32, niches(0, 3..=u32::max_value()))]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but it is something one could do (not sure which niches <code>Option</code> or <code>Result</code> would pick, and whether we could / would want to guarantee anything there).</p>
<p>Does anybody see anything wrong from the point of view of soundness for this?</p>



<a name="262897990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262897990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262897990">(Nov 27 2021 at 23:13)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C, u32, niches(0, 3..=u32::max_value()))]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This is the same as not giving a niche, right? enums always assume their discriminant are valid, even with these extra repr clauses.</p>



<a name="262911250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262911250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262911250">(Nov 28 2021 at 05:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="441719">Gonzalo Brito (gnzlbg)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/niche.20control/near/262861143">said</a>:</p>
<blockquote>
<p>Does anybody see anything wrong from the point of view of soundness for this?</p>
</blockquote>
<p>I'm wondering what it means for <code>match</code>ing things.  Can you match on reprs that don't have variants?  If not, how do you observe those values?</p>
<p>And, in general, <code>#[repr(C, u32, niches(0))]</code> looks to me like <code>#[repr(transparent)] struct E(NonZeroU32);</code> with a bunch of associated <code>const</code>s...</p>



<a name="262929408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262929408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262929408">(Nov 28 2021 at 13:38)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I think that’s correct, from the point of view of validity nothing changes. I really don’t understand why using repr(C, u32) disables niche optimizations in my experiments. Maybe it’s a bug?</p>



<a name="262929479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262929479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262929479">(Nov 28 2021 at 13:40)</a>:</h4>
<p>For the other cases being able to pick a single niche, to force the option optimization to use it, feels like a workaround, so maybe one could just have a single repr attribute for the option optimization and that’s it.</p>



<a name="262929506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262929506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262929506">(Nov 28 2021 at 13:41)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> you can’t observe the values, but for some reason when I was playing with this, rustc was not performing niche optimizations on repr(C) enums.</p>



<a name="262929575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262929575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262929575">(Nov 28 2021 at 13:42)</a>:</h4>
<p>Is there a simple way to match on the repr struct with a NonZero field for its associated consts “as if” it was an actual enum with fields ?</p>



<a name="262929626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262929626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262929626">(Nov 28 2021 at 13:44)</a>:</h4>
<p>Layout wise they still different because they have different niches at least in theory (the enum with two fields has more niches that NonZero which only has one), but the biggest difference is ergonomics.</p>



<a name="262933286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262933286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262933286">(Nov 28 2021 at 15:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="441719">Gonzalo Brito (gnzlbg)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/niche.20control/near/262929408">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> I think that’s correct, from the point of view of validity nothing changes. I really don’t understand why using repr(C, u32) disables niche optimizations in my experiments. Maybe it’s a bug?</p>
</blockquote>
<p>That sounds strange, but I am not a layout computation expert... Cc <span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="262936515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262936515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262936515">(Nov 28 2021 at 16:21)</a>:</h4>
<blockquote>
<p>Maybe it’s a bug?</p>
</blockquote>
<p>It <em>may</em> be by design (I'm not an expert in this field, but here is my two cents). The <a href="https://doc.rust-lang.org/nomicon/other-reprs.html">Rustonomicon</a> says: "<em>repr(c) is the most important repr. It has fairly simple intent: do what C does. The order, size, and alignment of fields is exactly what you would expect from C or C++</em>". I'm not sure if niche optimizations exist in C or C++, but if they don't then these couldn't be carried over from Rust's niche optimizations when you opt-in to <code>#[repr(C)]</code>. The only exception seems to be "<em>If T is an FFI-safe non-nullable pointer type, Option&lt;T&gt; is guaranteed to have the same layout and ABI as T and is therefore also FFI-safe. As of this writing, this covers &amp;, &amp;mut, and function pointers, all of which can never be null</em>". Although this is only for the aforementioned pointers (which excludes raw pointers <code>*const T</code>/<code>*mut T</code> and <code>NonNull&lt;T&gt;</code> apparently), not for enums or numbers.</p>



<a name="262941239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262941239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262941239">(Nov 28 2021 at 18:20)</a>:</h4>
<p>repr(C) for enums is somewhat weird anyway, since in C (and maybe C++), it is totally fine to have "invalid" values in an enum-typed variable</p>



<a name="262941257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262941257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262941257">(Nov 28 2021 at 18:20)</a>:</h4>
<p>so repr(C) just means that the (memory and call) ABI is the same, but doesnt mean that the types make "the same promises"</p>



<a name="262941284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262941284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262941284">(Nov 28 2021 at 18:21)</a>:</h4>
<p>and since C++ doesnt have enums with data, arguably it would be okay for repr(C) types to have niches (and indeed I think <code>bool</code> is considered C-compaible despite having a niche)</p>



<a name="262943665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262943665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262943665">(Nov 28 2021 at 19:15)</a>:</h4>
<p>Maybe what I want is repr(u32) without C</p>



<a name="262943725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262943725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262943725">(Nov 28 2021 at 19:17)</a>:</h4>
<p>Plus the guarantee that if the 0 niche is available it will be used for option-like optimizations.</p>



<a name="262943907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262943907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262943907">(Nov 28 2021 at 19:21)</a>:</h4>
<p>So, was in the train, and now I’m finally at home.</p>



<a name="262943918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262943918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262943918">(Nov 28 2021 at 19:21)</a>:</h4>
<p>I’d internally raise the issue about the constraints that you’ve mentioned</p>



<a name="262943993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262943993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262943993">(Nov 28 2021 at 19:23)</a>:</h4>
<p>But they are essentially that lib nvvm is proprietary, and therefore some people might not like it being usable from rust, and also that even if it were allowed, some fallback would need to be required .</p>



<a name="262944038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944038">(Nov 28 2021 at 19:24)</a>:</h4>
<p>I can’t promise anything about libnvvm, but it has been supported for longer than Rust has existed</p>



<a name="262944061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944061">(Nov 28 2021 at 19:25)</a>:</h4>
<p>And given that all toolchains that interfere with the CUDA platform use it, there is 15+ years of history</p>



<a name="262944065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944065">(Nov 28 2021 at 19:25)</a>:</h4>
<p>Having said this, rust has removed tier 1 targets in the past</p>



<a name="262944071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944071">(Nov 28 2021 at 19:25)</a>:</h4>
<p>So the claim that it is necessary to have a fallback just in case it’s stops being supported is not true either.</p>



<a name="262944112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944112">(Nov 28 2021 at 19:26)</a>:</h4>
<p>And there is prior art of rust downgrading and even removing targets.</p>



<a name="262944119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944119">(Nov 28 2021 at 19:26)</a>:</h4>
<p>If llvm removes a target, there is no workaround available either.</p>



<a name="262944529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944529">(Nov 28 2021 at 19:37)</a>:</h4>
<p>Did you mean to post this in <a class="stream-topic" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements">#t-compiler &gt; codegen upstreaming requirements</a>?</p>



<a name="262944792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262944792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262944792">(Nov 28 2021 at 19:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="441719">Gonzalo Brito (gnzlbg)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/niche.20control/near/262929408">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> I think that’s correct, from the point of view of validity nothing changes. I really don’t understand why using repr(C, u32) disables niche optimizations in my experiments. Maybe it’s a bug?</p>
</blockquote>
<p>The <code>#repr(C)</code> and <code>#[repr(inttype)]</code> on enums guarantee to encode discriminant in specific way (as per RFC 2195), so they are fundamentally incompatible with niche optimization for the enum. They still expose their niche, which can be used for niche optimization of an outer enum.</p>



<a name="262946795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262946795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262946795">(Nov 28 2021 at 20:33)</a>:</h4>
<p>my understanding was that <span class="user-mention" data-user-id="441719">@Gonzalo Brito (gnzlbg)</span> said that it is the <em>outer</em> niche optimizations that get diasbled. I admit I did not actually check this.</p>



<a name="262946852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262946852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262946852">(Nov 28 2021 at 20:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="441719">Gonzalo Brito (gnzlbg)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/niche.20control/near/262943665">said</a>:</p>
<blockquote>
<p>Maybe what I want is repr(u32) without C</p>
</blockquote>
<p>that already exists -- in fact on nightly I get a lint when I do <code>repr(C, u32)</code></p>



<a name="262946895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262946895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262946895">(Nov 28 2021 at 20:35)</a>:</h4>
<p>I checked now and the optimizations do happen: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=9315c06a76998fa5d9e73a0dce3a131b">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=9315c06a76998fa5d9e73a0dce3a131b</a></p>



<a name="262946943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262946943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262946943">(Nov 28 2021 at 20:36)</a>:</h4>
<p>so <span class="user-mention" data-user-id="441719">@Gonzalo Brito (gnzlbg)</span> why do you mean when you say "repr(C, u32) disables niche optimizations" -- the link above demonstrates they do not get disabled?</p>



<a name="262947176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947176">(Nov 28 2021 at 20:43)</a>:</h4>
<p>RFC: <a href="https://rust-lang.github.io/rfcs/2195-really-tagged-unions.html#guide-level-explanation">https://rust-lang.github.io/rfcs/2195-really-tagged-unions.html#guide-level-explanation</a></p>
<p><code>repr(C, Int)</code> being a 2-field struct with a tag enum and a paylod union says to me it would definitely get layout optimizations.  It's less obvious whether just <code>repr(Int)</code> would, as that's phrased as union-of-structs, and unions seem to disable them as we don't have the "at least one variant must be valid" rule, IIRC.</p>



<a name="262947456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947456">(Nov 28 2021 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I tried this a couple of weeks ago and I couldn’t get 0 to get picked as the niche</p>



<a name="262947598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947598">(Nov 28 2021 at 20:54)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8cf5330f3ef615cedb1a03b96517904b">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8cf5330f3ef615cedb1a03b96517904b</a></p>



<a name="262947604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947604">(Nov 28 2021 at 20:55)</a>:</h4>
<p>Shows that it get picked here, did this change recently?</p>



<a name="262947672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947672">(Nov 28 2021 at 20:56)</a>:</h4>
<p>Enum should prefer discriminant zero for niche: <a href="https://github.com/rust-lang/rust/issues/87794">#87794</a>, probably?</p>



<a name="262947757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947757">(Nov 28 2021 at 20:59)</a>:</h4>
<p>Might be, cool. Then nothing for me to do then <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="262947865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262947865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262947865">(Nov 28 2021 at 21:00)</a>:</h4>
<p>I only need this for C-like enums that don’t have a variant with value 0</p>



<a name="262949606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche%20control/near/262949606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/niche.20control.html#262949606">(Nov 28 2021 at 21:37)</a>:</h4>
<p>note however that I dont think we <em>guarantee</em> that 0 gets picked as a niche, even if it currently does get picked</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>