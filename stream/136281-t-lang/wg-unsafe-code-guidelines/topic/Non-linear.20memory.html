<html>
<head><meta charset="utf-8"><title>Non-linear memory · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html">Non-linear memory</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275980824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/275980824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#275980824">(Mar 20 2022 at 18:25)</a>:</h4>
<p>Many embedded systems have a memory system that's non-linear[^1], and it is also possible to construct such memory with an MMU on contemporary consumer-oriented systems as well. In systems following such model it seems to me like it might be possible to obtain mutable references without it immediately looking wrong (<code>e.g. std::slice::from_raw_parts_mut(0x2000_0000, 0x2000_0001): &amp;mut [u8]</code> would alias the byte at first and last element.)</p>
<p>While this is clearly invalid, I haven't seen this brought up anywhere so far, hence my ramblings here ^^</p>
<p>[^1]: The MCUs I have worked with seemed to largely just mask out bits of the address when accessing memory, allowing to access the same memory at e.g. address <code>0</code>, <code>0x2000_0000</code>, <code>0x4000_0000</code>, etc.</p>



<a name="275980903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/275980903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#275980903">(Mar 20 2022 at 18:27)</a>:</h4>
<p>Unless memory regions are overlapping, I don't think that it's <em>per se</em> unsound to have non-linear memory.</p>



<a name="275980980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/275980980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#275980980">(Mar 20 2022 at 18:29)</a>:</h4>
<p>It's unsound to create a reference to memory that has "holes" (like the SNES's MMIO registers, which fall out into open bus) or that can alias a region of memory via another address that there is also a reference to (or is otherwise accessed).</p>



<a name="275986645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/275986645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#275986645">(Mar 20 2022 at 20:42)</a>:</h4>
<p>On (some?) ARM MCUs they are overlapping (address space acts as a ring)</p>



<a name="275986739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/275986739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#275986739">(Mar 20 2022 at 20:44)</a>:</h4>
<p>The reason this topic got pulled into my L1 cache at all, was because I was thinking about ways for a WebAssembly runtime to avoid memory access checks, and I kinda remembered MCUs having this wrapping address space behaviour.</p>



<a name="275986772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/275986772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#275986772">(Mar 20 2022 at 20:45)</a>:</h4>
<p>(which turns out to be not applicable to webassembly because it does require linear memory…, but that led me thinking about what it means for using Rust on MCUs like that)</p>



<a name="276008630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/276008630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#276008630">(Mar 21 2022 at 05:46)</a>:</h4>
<p>Is this the same as "mirrored memory"? Because I've encountered that before, and just tried to mostly avoid using the mirrors.</p>



<a name="276034895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/276034895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#276034895">(Mar 21 2022 at 11:11)</a>:</h4>
<p>Yeah that would be another source of this.</p>



<a name="276120967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear%20memory/near/276120967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Non-linear.20memory.html#276120967">(Mar 21 2022 at 22:14)</a>:</h4>
<p>an even more extreme example is some Arm MCUs have a special address region where each byte (or 32-bit word? icr) maps to a single bit in another region.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>