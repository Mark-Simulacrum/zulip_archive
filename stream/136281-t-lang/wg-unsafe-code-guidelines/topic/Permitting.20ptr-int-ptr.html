<html>
<head><meta charset="utf-8"><title>Permitting ptr-int-ptr · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html">Permitting ptr-int-ptr</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277479624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277479624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277479624">(Apr 01 2022 at 21:25)</a>:</h4>
<p><span class="user-mention" data-user-id="465167">@Bram Geron</span> If you want to permit ptr-int-ptr you need to have some kind of solution to this problem <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/291">https://github.com/rust-lang/unsafe-code-guidelines/issues/291</a></p>
<p>My very short summary of this is that ptr-int-ptr conflicts with <code>restrict</code>/<code>noalias</code> with GVN. It's not entirely clear to me if one can point to GVN as a root cause here. That is, if we eliminated integer GVN, would a different integer optimization produce the same problem? I suspect so, but <span class="user-mention" data-user-id="120791">@RalfJ</span> probably knows better.</p>
<p>So, pending Ralf's response, I think Rust really does have to make a choice between sprinkling <code>noalias</code> on its LLVM IR and having ptr-int-ptr casts.</p>



<a name="277479940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277479940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277479940">(Apr 01 2022 at 21:28)</a>:</h4>
<p>or getting LLVM to fix their optimizations in the way ralf suggests right there (you can't delete ptrtoint if you aren't keeping alias/escape info any other way), which they need to do for C anyways even without restrict-specific examples</p>



<a name="277479991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277479991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277479991">(Apr 01 2022 at 21:28)</a>:</h4>
<p>there's "we don't want to wait for LLVM and don't have people willing to try to fix it ourselves", but this example is a general problem LLVM has, not rust-specific</p>



<a name="277480019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277480019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277480019">(Apr 01 2022 at 21:29)</a>:</h4>
<p>Don't ascribe intentionality to my omission lol, I just forgot about that option</p>



<a name="277480199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277480199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277480199">(Apr 01 2022 at 21:30)</a>:</h4>
<p>ah, ok :P</p>



<a name="277480958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277480958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277480958">(Apr 01 2022 at 21:37)</a>:</h4>
<p>I think my solution is that I agree that ptr2int casts should be side-effecting. Is that a valid solution? I have it like that in <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277358112">my summary post</a>. </p>
<blockquote>
<p>We introduce a performance lint against <code>usize as ptr</code> and <code>ptr as usize</code> and their synonyms — because they are slow+insecure on some platforms and merely slower on most others.</p>
</blockquote>



<a name="277481107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277481107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277481107">(Apr 01 2022 at 21:38)</a>:</h4>
<p>The details of the lowering to LLVM, what exactly LLVM is supposed to do, need to be figured out of course</p>



<a name="277481180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277481180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277481180">(Apr 01 2022 at 21:39)</a>:</h4>
<p>I'm very wary of overeager lints like that, because the actual problem is ptr-int-ptr, which can be spread across code and across time</p>



<a name="277482493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277482493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277482493">(Apr 01 2022 at 21:51)</a>:</h4>
<p><span class="user-mention" data-user-id="465167">@Bram Geron</span> I'm going to try to move the conversation here from the other thread to be able to address this head on: You seem to be under the impression that Rust can both allow non-strict provenance and have a sound memory model. I'm not so sure how you came to that conclusion; I am not at that point, and would like to see evidence of that fact</p>



<a name="277482544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277482544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277482544">(Apr 01 2022 at 21:51)</a>:</h4>
<p>I agree that it is likely that Rust can have a sound memory model and <em>avoid</em> miscompiling programs that do not comply with strict provenance, but that is not at all the same thing</p>



<a name="277483076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483076">(Apr 01 2022 at 21:56)</a>:</h4>
<p>I believe SB with the PNVI-ae-udi-like "ptrtoint adds to the escaped log, inttoptr gives the pointer the provenance of a set including all provenance values at that address, if the actual execution path is not valid at all points for some provenance in that set, it is UB" is generally assumed to be sound? (and assumed to still permit <code>noalias</code> with ptrtoint considered a side-effect)</p>



<a name="277483085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483085">(Apr 01 2022 at 21:56)</a>:</h4>
<p>but is glhf for miri</p>



<a name="277483335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483335">(Apr 01 2022 at 21:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277482493">said</a>:</p>
<blockquote>
<p>You seem to be under the impression that Rust can both allow non-strict provenance and have a sound memory model. I'm not so sure how you came to that conclusion; I am not at that point, and would like to see evidence of that fact</p>
</blockquote>
<p>Correct. Stacked Borrows has a notion of "exposing" pointers, like pnvi-ae, although the details are different. This is how I understand the paper and how I understand <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277321304">Ralf's message</a></p>



<a name="277483500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483500">(Apr 01 2022 at 22:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277483335">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277482493">said</a>:</p>
<blockquote>
<p>You seem to be under the impression that Rust can both allow non-strict provenance and have a sound memory model. I'm not so sure how you came to that conclusion; I am not at that point, and would like to see evidence of that fact</p>
</blockquote>
<p>Correct. Stacked Borrows has a notion of "exposing" pointers, like pnvi-ae, although the details are different. This is how I understand the paper and how I understand <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277321304">Ralf's message</a></p>
</blockquote>
<p>Under SB with tagged raw pointers (which is strongly favored over the alternative by a number of people right now), there is no notion of exposed raw pointers</p>



<a name="277483507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483507">(Apr 01 2022 at 22:01)</a>:</h4>
<p>AIUI the original SB non-udi like expose setup has had issues. The only complaints I've heard about -udi models is that the formalization would be ugly and miri probably dies</p>



<a name="277483511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483511">(Apr 01 2022 at 22:01)</a>:</h4>
<p>And IIUC Stacked Borrows is sound. We just don't know how to integrate it yet with the rest of the world. One problem being transmute (which I now think we should banish)</p>



<a name="277483574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483574">(Apr 01 2022 at 22:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277483507">said</a>:</p>
<blockquote>
<p>AIUI the original SB non-udi like expose setup has had issues. The only complaints I've heard about -udi models is that the formalization would be ugly and miri probably dies</p>
</blockquote>
<p>I'm also not convinced that it doesn't cause optimization problems. The paper is pretty light on the optimizations it proves correct</p>



<a name="277483639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483639">(Apr 01 2022 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277483500">said</a>:</p>
<blockquote>
<p>which is strongly favored over the alternative by a number of people right now</p>
</blockquote>
<p>I have yet to understand why normal Stacked Borrows wouldn't be a fine model / what, specifically, is making work on the compiler more complicated</p>



<a name="277483703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483703">(Apr 01 2022 at 22:03)</a>:</h4>
<p><a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/SB.20Without.20Raw.20Pointer.20Tagging</a></p>



<a name="277483719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483719">(Apr 01 2022 at 22:03)</a>:</h4>
<p>It might have issues, but my understanding is that it is similar to what compilers already do when they aren't running into inttoptr bugs - they already have to assume that unknown provenance could be any provenance</p>



<a name="277483721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483721">(Apr 01 2022 at 22:03)</a>:</h4>
<p>It's not that the compiler is more complicated, it's that the model is</p>



<a name="277483758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483758">(Apr 01 2022 at 22:03)</a>:</h4>
<p>Ralf claims that raw pointer tagging does not enable many more optimizations, although to be honest I think that claim is undersupported</p>



<a name="277483819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483819">(Apr 01 2022 at 22:04)</a>:</h4>
<p>But even more importantly, Saethlin reports that this is a nightmare to write sound programs against</p>



<a name="277483963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277483963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277483963">(Apr 01 2022 at 22:05)</a>:</h4>
<p>And that's like... an actual problem</p>



<a name="277484001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277484001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277484001">(Apr 01 2022 at 22:06)</a>:</h4>
<p>Miri checkability and the ability of people to reason about the memory model is <em>really</em> important. SB is complicated, we need to help people get their code right</p>



<a name="277484714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277484714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277484714">(Apr 01 2022 at 22:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277483500">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277483335">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277482493">said</a>:</p>
<blockquote>
<p>You seem to be under the impression that Rust can both allow non-strict provenance and have a sound memory model. I'm not so sure how you came to that conclusion; I am not at that point, and would like to see evidence of that fact</p>
</blockquote>
<p>Correct. Stacked Borrows has a notion of "exposing" pointers, like pnvi-ae, although the details are different. This is how I understand the paper and how I understand <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277321304">Ralf's message</a></p>
</blockquote>
<p>Under SB with tagged raw pointers (which is strongly favored over the alternative by a number of people right now), there is no notion of exposed raw pointers</p>
</blockquote>
<p>What does SB with tagged raw pointers think of pointers that escape into extern code?</p>
<p>Or is there no plan to ever support this, and we'll have to continue to write models of every C API we use if we want to use miri?</p>



<a name="277485001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485001">(Apr 01 2022 at 22:17)</a>:</h4>
<p>What do you mean? It doesn't really <em>think</em> anything</p>



<a name="277485072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485072">(Apr 01 2022 at 22:18)</a>:</h4>
<p>FFI functions are not permitted to influence the Rust AM in a way that sound Rust code could not</p>



<a name="277485139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485139">(Apr 01 2022 at 22:19)</a>:</h4>
<p>FFI functions can absolutely do things like cast ptrs to integers and back, and this is indistinguishable to the rust AM from them storing them in globals</p>



<a name="277485190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485190">(Apr 01 2022 at 22:19)</a>:</h4>
<p>(except that the only valid ways to do this are those extern fns instead of the builtin intrinsics)</p>



<a name="277485272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485272">(Apr 01 2022 at 22:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485139">said</a>:</p>
<blockquote>
<p>FFI functions can absolutely do things like cast ptrs to integers and back, and this is indistinguishable to the rust AM from them storing them in globals</p>
</blockquote>
<p>Yes. To be clear, I do not consider this incompatible with what I said above</p>



<a name="277485295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485295">(Apr 01 2022 at 22:21)</a>:</h4>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>



<a name="277485397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485397">(Apr 01 2022 at 22:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>Well, we still do need to say at least a few words about how FFI is allowed to touch things that the Rust AM knows about</p>



<a name="277485478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485478">(Apr 01 2022 at 22:23)</a>:</h4>
<p>because they have the same implications on anything taking advantage of provenance as a very permissive ptrtoint/inttoptr does</p>



<a name="277485481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485481">(Apr 01 2022 at 22:23)</a>:</h4>
<p>That's probably somewhat my fault, but I bring it up less in a formal model sense and more in this code should continue to work sense.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">ptrtoint</span><span class="p">(</span><span class="n">p</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">inttoptr</span><span class="p">(</span><span class="n">p</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">example</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">inttoptr</span><span class="p">(</span><span class="n">ptrtoint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277485508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485508">(Apr 01 2022 at 22:23)</a>:</h4>
<p>issue <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/291">https://github.com/rust-lang/unsafe-code-guidelines/issues/291</a> that was linked above is concerned about ptr2int casts having 'expose' like side effects. I have since come to the conclusion that this is entirely unavoidable. it's also what C does with PNVI-ae-\*. So I basically concluded I will no longer try to cater for LLVM's desire to make ptr2int casts pure and side-effect-free, and instead hold the position that LLVM needs to accept that these casts have side-effects, and be changed accordingly.</p>



<a name="277485515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485515">(Apr 01 2022 at 22:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218745">Wanja Hentze</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277484714">said</a>:</p>
<blockquote>
<p>What does SB with tagged raw pointers think of pointers that escape into extern code?</p>
<p>Or is there no plan to ever support this, and we'll have to continue to write models of every C API we use if we want to use miri?</p>
</blockquote>
<p>As far as I understand, this is too complicated for formal models. Maybe sometime in the future this can be formalized but now there's just no hope of formalizing that.</p>



<a name="277485564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485564">(Apr 01 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485397">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>Well, we still do need to say at least a few words about how FFI is allowed to touch things that the Rust AM knows about</p>
</blockquote>
<p>basically: the FFI function can have any effect that an actual inside-AM function could also have</p>



<a name="277485595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485595">(Apr 01 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>I bring it up because "treating old Rust code as thought it were called across an FFI boundary from the perspective of the model" is a possible solution, though not a great one.</p>



<a name="277485605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485605">(Apr 01 2022 at 22:24)</a>:</h4>
<p>Ralf, what would we do without you!</p>



<a name="277485657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485657">(Apr 01 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485595">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>I bring it up because "treating old Rust code as thought it were called across an FFI boundary from the perspective of the model" is a possible solution, though not a great one.</p>
</blockquote>
<p>it's a really tricky one because of things like generics and stuff -- you'd have to actually put old Rust code reliably into its own TU to use this approach</p>



<a name="277485661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485661">(Apr 01 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485508">said</a>:</p>
<blockquote>
<p>issue <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/291">https://github.com/rust-lang/unsafe-code-guidelines/issues/291</a> that was linked above is concerned about ptr2int casts having 'expose' like side effects. I have since come to the conclusion that this is entirely unavoidable. it's also what C does with PNVI-ae-\*. So I basically concluded I will no longer try to cater for LLVM's desire to make ptr2int casts pure and side-effect-free, and instead hold the position that LLVM needs to accept that these casts have side-effects, and be changed accordingly.</p>
</blockquote>
<p>TBH I've felt for a while now that this may be unavoidable as well.</p>



<a name="277485693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485693">(Apr 01 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485515">said</a>:</p>
<blockquote>
<p>As far as I understand, this is too complicated for formal models.</p>
</blockquote>
<p>No shade on you, Ralf, just trying to be realistic and integrating some intuitions from my own PhD</p>



<a name="277485752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485752">(Apr 01 2022 at 22:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485515">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="218745">Wanja Hentze</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277484714">said</a>:</p>
<blockquote>
<p>What does SB with tagged raw pointers think of pointers that escape into extern code?</p>
<p>Or is there no plan to ever support this, and we'll have to continue to write models of every C API we use if we want to use miri?</p>
</blockquote>
<p>As far as I understand, this is too complicated for formal models. Maybe sometime in the future this can be formalized but now there's just no hope of formalizing that.</p>
</blockquote>
<p>I dont think this is any different than FFI in general</p>



<a name="277485756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485756">(Apr 01 2022 at 22:25)</a>:</h4>
<p>which is tricky but something people work on</p>



<a name="277485794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485794">(Apr 01 2022 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485657">said</a>:</p>
<blockquote>
<p>it's a really tricky one because of things like generics and stuff -- you'd have to actually put old Rust code reliably into its own TU to use this approach</p>
</blockquote>
<p>Well, in practice only the optimization passes that are doing things that assume SB (or whatever) would have to worry about this.</p>



<a name="277485820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485820">(Apr 01 2022 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485508">said</a>:</p>
<blockquote>
<p>I [instead] hold the position that LLVM needs to accept that these casts have side-effects, and be changed accordingly.</p>
</blockquote>
<p>I also added it to <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277358112">my position</a>, although I phrase it as "ptr2int and int2ptr are lint-worthy because they're slowish"</p>



<a name="277485829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485829">(Apr 01 2022 at 22:26)</a>:</h4>
<p>Does anyone have all of Ralf's examples stored somewhere? I had it on my Linux install before it died miserably. I'm looking for the redundant store elimination one.</p>



<a name="277485838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485838">(Apr 01 2022 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485820">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485508">said</a>:</p>
<blockquote>
<p>I [instead] hold the position that LLVM needs to accept that these casts have side-effects, and be changed accordingly.</p>
</blockquote>
<p>I also added it to <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277358112">my position</a>, although I phrase it as "ptr2int and int2ptr are lint-worthy because they're slowish"</p>
</blockquote>
<p>that's a very different statement IMO^^</p>



<a name="277485868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485868">(Apr 01 2022 at 22:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485829">said</a>:</p>
<blockquote>
<p>Does anyone have all of Ralf's examples stored somewhere? I had it on my Linux install before it died miserably. I'm looking for the redundant store elimination one.</p>
</blockquote>
<p><a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-860189806">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-860189806</a></p>



<a name="277485886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485886">(Apr 01 2022 at 22:27)</a>:</h4>
<p>Is it a different statement? I think it expresses the same sentiment, but one is from an optimization perspective, the other is written for a developer</p>



<a name="277485971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277485971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277485971">(Apr 01 2022 at 22:28)</a>:</h4>
<p>well you're adding some value judgment to it, and we don't have data supporting its slowness <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="277486005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486005">(Apr 01 2022 at 22:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>Besides the formalization work, what about miri? If miri implemented "address escapes" semantics for any pointers that are exposed to FFI, that could potentially open us up to check the correctness of unsafe Rust that calls foreign code (albeit not the correctness of the foreign code itself).<br>
Maybe I'm being naive though.</p>



<a name="277486024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486024">(Apr 01 2022 at 22:29)</a>:</h4>
<p>It would (in some circumstances, in some hypothesized improved future version of LLVM) have worse alias analysis than strict-only provenance :D</p>



<a name="277486044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486044">(Apr 01 2022 at 22:29)</a>:</h4>
<p>FWIW I think it'd be good if you could put that summary on something like <a href="https://hackmd.io/">https://hackmd.io/</a> . right now it's burried in a huge stream. also hackmd supports comments better.</p>



<a name="277486051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486051">(Apr 01 2022 at 22:29)</a>:</h4>
<p>worse alias analysis --&gt; slower (at least not faster)</p>



<a name="277486137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486137">(Apr 01 2022 at 22:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218745">Wanja Hentze</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277486005">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>Besides the formalization work, what about miri? If miri implemented "address escapes" semantics for any pointers that are exposed to FFI, that could potentially open us up to check the correctness of unsafe Rust that calls foreign code (albeit not the correctness of the foreign code itself).<br>
Maybe I'm being naive though.</p>
</blockquote>
<p>not sure how that'd help, we still need to implement <em>all the other</em> effects of an FFI call</p>



<a name="277486185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486185">(Apr 01 2022 at 22:31)</a>:</h4>
<p>when you call into FFI, <em>some</em> transformation happens to the AM state. that transformation can do things like expose an allocation, but also just change a value stored somewhere. all of these effects need to be implemented explicitly in miri.</p>



<a name="277486194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486194">(Apr 01 2022 at 22:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277486137">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="218745">Wanja Hentze</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277486005">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277485295">said</a>:</p>
<blockquote>
<p>FFI functions act outside the Rust Abstract machine, their interaction happens on the level of the target hardware. FFI is basically irrelevant for provenance, except if we consider cross-lang LTO. Not sure why people keep bringing it up.^^</p>
</blockquote>
<p>Besides the formalization work, what about miri? If miri implemented "address escapes" semantics for any pointers that are exposed to FFI, that could potentially open us up to check the correctness of unsafe Rust that calls foreign code (albeit not the correctness of the foreign code itself).<br>
Maybe I'm being naive though.</p>
</blockquote>
<p>not sure how that'd help, we still need to implement <em>all the other</em> effects of an FFI call</p>
</blockquote>
<p>Only those pertaining to the AM, right?<br>
Which could still be a bunch I realize</p>



<a name="277486226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486226">(Apr 01 2022 at 22:31)</a>:</h4>
<p>it doesn't make sense to indiscrimnantly expose <em>all</em> pointers passed to FFI in miri; miri should reflect whether the particular FFI function being called exposes or not (just like it reflects all the other effects of the particular FFI function in question)</p>



<a name="277486277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486277">(Apr 01 2022 at 22:32)</a>:</h4>
<p>Also, FFI calls can still do arbitrary things to the AM as-if it was calling a Rust function, which could change program behavior/conditionals taken/that stuff.</p>



<a name="277486313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486313">(Apr 01 2022 at 22:32)</a>:</h4>
<p>I may be coming at this from a weird angle because of my background in symbolic execution, where it's not unheard of to spin up an ISA emulator (Or to lift foreign code into IR dynamically) for extern calls <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> But the performance story of that is even worse than what people expect from miri today</p>



<a name="277486328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486328">(Apr 01 2022 at 22:33)</a>:</h4>
<p>the compiler, OTOH, doesn't know what the FFI function does, so it has to assume it might be <em>anything</em> that a regular AM function can do. including exposing all pointers it can reach.</p>



<a name="277486361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486361">(Apr 01 2022 at 22:33)</a>:</h4>
<p>but, crucially, <em>not</em> including just faking or exposing arbitrary unique provenance that is local to the function and that the FFI function has no way of knowing about</p>



<a name="277486418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486418">(Apr 01 2022 at 22:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277486044">said</a>:</p>
<blockquote>
<p>FWIW I think it'd be good if you could put that summary on something like <a href="https://hackmd.io/">https://hackmd.io/</a> . right now it's burried in a huge stream. also hackmd supports comments better.</p>
</blockquote>
<p>Thanks for the suggestion!</p>
<p>I migrated it to <a href="https://hackmd.io/I-zHe9bZTJOY78orP1aYIA">https://hackmd.io/I-zHe9bZTJOY78orP1aYIA</a></p>



<a name="277486454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486454">(Apr 01 2022 at 22:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218745">Wanja Hentze</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277486313">said</a>:</p>
<blockquote>
<p>I may be coming at this from a weird angle because of my background in symbolic execution, where it's not unheard of to spin up an ISA emulator (Or to lift foreign code into IR dynamically) for extern calls <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> But the performance story of that is even worse than what people expect from miri today</p>
</blockquote>
<p>oh sure one could have a fun experiment with some kind of universal FFI emulation, and then we'd have to decide what happens wrt provenance as that information is not encoded in the assembly. it's also not typically given in the specs of FFI functions. so either way we'd have to make some choice...</p>



<a name="277486571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277486571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277486571">(Apr 01 2022 at 22:36)</a>:</h4>
<p>Yes, you invariably lose some precision (if you're careful, only in one direction, i.e. you only make your analysis less complete or less correct, not both)</p>



<a name="277487072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487072">(Apr 01 2022 at 22:42)</a>:</h4>
<p>We should have universal FFI in Miri at some point, but making it work is going to be pretty invasive because you have to make it possible to dereference a pointer which you got from FFI and that does not point to memory allocated by Rust.</p>



<a name="277487100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487100">(Apr 01 2022 at 22:43)</a>:</h4>
<p>I'm sure there are other problems too, but from a very practical standpoint I gave it a shot then ran straight into that and decided to do other things with my time</p>



<a name="277487191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487191">(Apr 01 2022 at 22:44)</a>:</h4>
<p>I suspect a "sanitizer" approach might be easier, which allocates shadow memory with metadata</p>



<a name="277487236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487236">(Apr 01 2022 at 22:45)</a>:</h4>
<p>I suggest you take a look at how pointers work in Miri/CTFE before suggesting solutions. It's pretty easy to grep the rust-lang/rust codebase for the type <code>Pointer</code>.</p>



<a name="277487413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487413">(Apr 01 2022 at 22:48)</a>:</h4>
<p>That sounds a bit unwelcoming, sorry</p>



<a name="277487468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487468">(Apr 01 2022 at 22:48)</a>:</h4>
<p>Reading a compiler isn't a 10-minute task</p>



<a name="277487700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277487700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277487700">(Apr 01 2022 at 22:51)</a>:</h4>
<p>That's why I said to grep for <code>Pointer</code>, because it's what I did to figure out how pointers work.</p>



<a name="277488256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277488256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277488256">(Apr 01 2022 at 22:57)</a>:</h4>
<p>I understand how SB works, but I'm not interested in navigating large codebases right now. Anyway, it was just a hunch nothing important</p>



<a name="277507183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277507183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277507183">(Apr 02 2022 at 05:08)</a>:</h4>
<p><span class="user-mention" data-user-id="465167">@Bram Geron</span> </p>
<blockquote>
<p>transmute (which I now think we should banish)<br>
<code>trasmute(ptr, int)</code>, yes, this is clearly problematic, along with any other <code>transmute_copy(&amp;ptr, int)</code> written with type punning. I just want clarification you're only taking about ptr-int transmute here? <em>Fully</em> banning transmute is typed memory and I don't think anyone's in favor of that. (i.e. <code>transmute(Vec&lt;u8&gt;, String)</code> is "fine" (modulo relying on unstable layout details))</p>
</blockquote>



<a name="277507277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277507277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277507277">(Apr 02 2022 at 05:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277487191">said</a>:</p>
<blockquote>
<p>I suspect a "sanitizer" approach might be easier, which allocates shadow memory with metadata</p>
</blockquote>
<p>Miri is already a sanitizer...</p>



<a name="277507650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277507650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277507650">(Apr 02 2022 at 05:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218745">Wanja Hentze</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277486571">said</a>:</p>
<blockquote>
<p>Yes, you invariably lose some precision (if you're careful, only in one direction, i.e. you only make your analysis less complete or less correct, not both)</p>
</blockquote>
<p>I think this interacts oddly with pointer exposing. Because if you expose a pointer you have <em>less</em> UB, so if you "conservatively" assume that all pointers passed to FFI are exposed / cast through integers, then you might miss UB because the code "actually" keeps the pointers un-exposed and then uses the result in an invalid way even though there is no evidence of this in the generated code. You can't even "conservatively" assume that pointers are not exposed because you can't tell if the provenances got permuted about in some way</p>



<a name="277507655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277507655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277507655">(Apr 02 2022 at 05:21)</a>:</h4>
<p>so I think this is a case where we have no choice but to miss some UB</p>



<a name="277520519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277520519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277520519">(Apr 02 2022 at 10:16)</a>:</h4>
<p>You can conservatively say "sorry, you called foreign code, miri can't do this" and your analysis will still be correct (but not as helpful).</p>



<a name="277525157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277525157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277525157">(Apr 02 2022 at 11:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr/near/277507277">said</a>:</p>
<blockquote>
<p>Miri is already a sanitizer...</p>
</blockquote>
<p>I mean something that compiles to machine code like rustc and thus integrates seamlessly with FFI, but still tracks stuff for Rust-allocated memory like asan.</p>
<p>Is that how Miri works?</p>



<a name="277529588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277529588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277529588">(Apr 02 2022 at 13:25)</a>:</h4>
<p>no, Miri is an interpreter. I have dreams of a stacked borrows module for valgrind. one day...</p>



<a name="277568573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277568573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277568573">(Apr 03 2022 at 03:57)</a>:</h4>
<p>this discussion is... interesting. I've been looking into playing around with some approximations of miri's memory models applied to machine code (where all of the provenance distinctions would be <em>injected</em> into the initial architectural emulator state and also generated by high-level emulation of system interfaces e.g. the <code>mmap</code> syscalls - in fact, I think <code>mmap</code> can be a primitive for the former, like the binary image and the stack)</p>



<a name="277568636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting%20ptr-int-ptr/near/277568636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Permitting.20ptr-int-ptr.html#277568636">(Apr 03 2022 at 03:58)</a>:</h4>
<p>for anything other than machine code level emulation, a LLVM sanitizer might be handy, but I doubt you can get far without e.g. Linux syscall interface emulation</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>