<html>
<head><meta charset="utf-8"><title>Why is `offset_from` an intrinsic? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html">Why is `offset_from` an intrinsic?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278262311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278262311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278262311">(Apr 08 2022 at 06:37)</a>:</h4>
<p>I was surprised to notice, today, that <code>offset_from</code> is an intrinsic, since the slice iterators demonstrate that it seemingly doesn't <em>need</em> to be one: &lt;<a href="https://github.com/rust-lang/rust/blob/e745b4ddbd05026c75aae4506aef39fdfe1603c5/library/core/src/slice/iter/macros.rs#L25-L35">https://github.com/rust-lang/rust/blob/e745b4ddbd05026c75aae4506aef39fdfe1603c5/library/core/src/slice/iter/macros.rs#L25-L35</a>&gt;</p>
<p>Am I missing something?  Should the <code>unsigned_offset_from</code> <em>also</em> be an intrinsic?</p>



<a name="278289098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278289098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278289098">(Apr 08 2022 at 11:15)</a>:</h4>
<p>That looks to miss a couple of invariants of <code>offset_of</code>. In particular, that looks closer to a <code>wrapping_offset_from</code> then <code>offset_from</code>.</p>



<a name="278325397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278325397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278325397">(Apr 08 2022 at 16:03)</a>:</h4>
<p>Well, it's not really <code>wrapping</code> because it's using <code>sub nuw</code> (and <code>udiv exact</code>) -- which is why it's actually <em>more</em> optimized than the intrinsic, in some cases.</p>
<p>The primary difference is that it's not explicitly doing a provenance check, but subtracting pointers the way it does is, while not UB, already meaningless without that.  Hmm, I would have thought that the "you can't do arbitrary things with integers from unrelated pointers" logic would have caught misuse, but apparently it doesn't: <a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=04a7cd267657f31b880e4357efccb0de">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=04a7cd267657f31b880e4357efccb0de</a></p>
<p>So I guess that's a demonstration that it ought to be an intrinsic, and my question is answered <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<p>(EDIT: Doesn't catch it for heap allocations either, <a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=50b7253d3e506d1a2ef1a62e0ff5f17c">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=50b7253d3e506d1a2ef1a62e0ff5f17c</a> )</p>



<a name="278353394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278353394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278353394">(Apr 08 2022 at 19:44)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> mostly it is an intrsic so that it can be <code>const fn</code></p>



<a name="278353486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278353486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278353486">(Apr 08 2022 at 19:45)</a>:</h4>
<blockquote>
<p>"you can't do arbitrary things with integers from unrelated pointers" logic</p>
</blockquote>
<p>not sure which logic you are referring to here</p>



<a name="278353512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278353512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278353512">(Apr 08 2022 at 19:45)</a>:</h4>
<p>integers from pointers are just integers. you can do with them whatever you can do with all integers.</p>



<a name="278358030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278358030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278358030">(Apr 08 2022 at 20:27)</a>:</h4>
<p>I guess I was thinking the CTFE execution model had something it doesn't.</p>
<p>But being <code>const</code> and having better precondition checking both seem like good reasons for this being an intrinsic.</p>



<a name="278358129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278358129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278358129">(Apr 08 2022 at 20:28)</a>:</h4>
<p>better precondition checking in Miri, you mean?</p>



<a name="278358135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278358135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278358135">(Apr 08 2022 at 20:28)</a>:</h4>
<p>for codegen nothing is checked^^</p>



<a name="278358272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278358272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278358272">(Apr 08 2022 at 20:29)</a>:</h4>
<p>yes, in miri/ctfe.</p>



<a name="278359072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278359072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278359072">(Apr 08 2022 at 20:37)</a>:</h4>
<p>speaking of offset_from, also see <a href="https://github.com/rust-lang/rust/issues/92512">https://github.com/rust-lang/rust/issues/92512</a> -- I would like to slightly weaken its precondition</p>



<a name="278359103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278359103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278359103">(Apr 08 2022 at 20:37)</a>:</h4>
<p>for the goal of having an operation that works in CTFE, it is slightly stronger than required</p>



<a name="278359995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278359995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278359995">(Apr 08 2022 at 20:45)</a>:</h4>
<p>Oh, to make it just require same provenance, not <code>inbounds</code>?</p>



<a name="278360133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360133">(Apr 08 2022 at 20:46)</a>:</h4>
<p>yes</p>



<a name="278360152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360152">(Apr 08 2022 at 20:47)</a>:</h4>
<p>I think this would be required to use this operation in slice iterators</p>



<a name="278360175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360175">(Apr 08 2022 at 20:47)</a>:</h4>
<p>where for the ZST case, dangling raw pointers are used</p>



<a name="278360273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360273">(Apr 08 2022 at 20:48)</a>:</h4>
<p>But <code>offset_from</code> doesn't work for ZSTs anyway, since it contains the <code>div exact</code> by size -- the slice iterators have a different code path for ZSTs that does something else.</p>



<a name="278360289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360289">(Apr 08 2022 at 20:48)</a>:</h4>
<p>you still have to cast to a different ptr type, yes</p>



<a name="278360296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360296">(Apr 08 2022 at 20:48)</a>:</h4>
<p>but that's possible in <code>const</code></p>



<a name="278360315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360315">(Apr 08 2022 at 20:48)</a>:</h4>
<p>casting to an integer and subtracting there is not ;)</p>



<a name="278360709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278360709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278360709">(Apr 08 2022 at 20:52)</a>:</h4>
<p>Hmm, and I guess it's unlikely that the inbounds restriction would actually be anything useful to communicate to the optimizer anyway, since it's not like it can avoid the subtraction or anything using it.</p>



<a name="278361514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278361514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278361514">(Apr 08 2022 at 20:59)</a>:</h4>
<p>The "no wrapping the address space" and "no more than isize::MAX" bytes are the important parts for anything that could really help understand the resulting value.</p>



<a name="278362847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278362847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278362847">(Apr 08 2022 at 21:11)</a>:</h4>
<p>yeah</p>



<a name="278362947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278362947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278362947">(Apr 08 2022 at 21:12)</a>:</h4>
<p>as a case in point, the only formal version of this intrinsic I am aware of is <code>ptrdiff</code> in the <a href="https://www.ralfj.de/research/twinsem/twinsem.pdf">LLVM twinsem</a> paper and it does not have that inbounds restriction either. it does show that this intrinsic is useful to avoid considering pointers as "escaped" during alias analysis.</p>



<a name="278363270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278363270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278363270">(Apr 08 2022 at 21:16)</a>:</h4>
<p>Hmm, actually, it's not obvious to me that provenance is exactly the right thing here either.</p>
<p>If I were to <code>.with_addr</code> to launder a provenance to match, I still shouldn't be able to <code>offset_from</code> between different locals, right?</p>



<a name="278363870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278363870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278363870">(Apr 08 2022 at 21:20)</a>:</h4>
<p>why not?</p>



<a name="278364019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278364019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278364019">(Apr 08 2022 at 21:22)</a>:</h4>
<p>in CTFE, <code>addr</code> doesn't work, so you cant use tricks like that</p>



<a name="278364157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278364157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278364157">(Apr 08 2022 at 21:23)</a>:</h4>
<p>for alias analysis, it'd be very syntactically obvious which two pointers flowed into this computation so all should be fine. (that LLVM twinsem model has <code>getelementptr</code> without <code>inbound</code>, so <code>with_addr</code> is expressible)</p>



<a name="278365692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278365692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278365692">(Apr 08 2022 at 21:40)</a>:</h4>
<p>I guess I was expecting the C++ rule that it's UB to do things like that (at least I think that's their rule?), but I guess we're willing to say that you can't <em>rely</em> on it, even though you can compute it?</p>



<a name="278379872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278379872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278379872">(Apr 09 2022 at 01:25)</a>:</h4>
<p>well we already differ from C++ in that you can <code>==</code> and even <code>&lt;</code> compare arbitrary pointers (including dangling pointers) in safe code</p>



<a name="278381909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278381909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278381909">(Apr 09 2022 at 02:11)</a>:</h4>
<p>If you spell <code>a &lt; b</code> as <code>std::less&lt;void*&gt;()(a, b)</code> you can do that in C++ too.</p>



<a name="278381978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278381978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278381978">(Apr 09 2022 at 02:13)</a>:</h4>
<p>ah fair. in C I think you cannot though?</p>



<a name="278382109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278382109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278382109">(Apr 09 2022 at 02:16)</a>:</h4>
<p>C has <code>==</code> but not <code>&lt;</code> unless you cast to uintptr_t (not well-behaved <code>&lt;</code>, that is)</p>



<a name="278382143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278382143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278382143">(Apr 09 2022 at 02:17)</a>:</h4>
<p>and <code>==</code> sometimes produces "indeterminate" results which might mean it is UB to <code>if</code> on them</p>



<a name="278382154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278382154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278382154">(Apr 09 2022 at 02:17)</a>:</h4>
<p>or was that C++? I keep mixing that up</p>



<a name="278382195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278382195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278382195">(Apr 09 2022 at 02:18)</a>:</h4>
<p>no, even C11 says "compare equal if and only if...."</p>



<a name="278382200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278382200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278382200">(Apr 09 2022 at 02:18)</a>:</h4>
<p>it might be C++, haven't checked its wording</p>



<a name="278382207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278382207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278382207">(Apr 09 2022 at 02:18)</a>:</h4>
<p>(or might have been C99, since I do vaguely recall == being screwy, and don't know if it was C++ or just &lt;)</p>



<a name="278383052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278383052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278383052">(Apr 09 2022 at 02:39)</a>:</h4>
<blockquote>
<p>Two pointers compare equal if and only if both are null pointers, both are pointers to the<br>
same object (including a pointer to an object and a subobject at its beginning) or function,<br>
both are pointers to one past the last element of the same array object, or one is a pointer<br>
to one past the end of one array object and the other is a pointer to the start of a different<br>
array object that happens to immediately follow the first array object in the address<br>
space.109)</p>
</blockquote>



<a name="278397166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why%20is%20%60offset_from%60%20an%20intrinsic%3F/near/278397166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Why.20is.20.60offset_from.60.20an.20intrinsic.3F.html#278397166">(Apr 09 2022 at 08:35)</a>:</h4>
<p>(PR out adding <code>unsigned_offset_from</code>: <a href="https://github.com/rust-lang/rust/pull/95837">https://github.com/rust-lang/rust/pull/95837</a> )</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>