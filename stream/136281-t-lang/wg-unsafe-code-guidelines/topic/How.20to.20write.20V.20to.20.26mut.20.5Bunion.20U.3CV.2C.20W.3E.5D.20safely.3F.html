<html>
<head><meta charset="utf-8"><title>How to write V to &amp;mut [union U&lt;V, W&gt;] safely? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html">How to write V to &amp;mut [union U&lt;V, W&gt;] safely?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263516861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263516861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263516861">(Dec 02 2021 at 23:49)</a>:</h4>
<p>You would probably need some sort of project-safe-transmute-like thing.</p>



<a name="263516863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263516863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263516863">(Dec 02 2021 at 23:49)</a>:</h4>
<p>For MaybeUninit, it's <code>repr(transparent)</code> so you have a lot of flexibility. <code>*u = MaybeUninit::new(v)</code>, <code>u.as_mut_ptr().write(v)</code>, or writing via a simd scatter intrinsic all will be fine.</p>
<p>For user unions it's hard to speak generally. Unions can have drop impls and by default will be <code>#[repr(Rust)]</code> so you really would want to do <code>*u = Union::new(val)</code>.</p>



<a name="263516884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263516884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263516884">(Dec 02 2021 at 23:50)</a>:</h4>
<p>Oof.</p>



<a name="263516961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263516961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263516961">(Dec 02 2021 at 23:50)</a>:</h4>
<p>I got good news: if you write the maybeuninit case, and the initialized slice case, then you can tell people "hey just cast the slice into one of these slice types using whatever slice casting lib you want, and use that slice with either of these functions"</p>



<a name="263516968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263516968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263516968">(Dec 02 2021 at 23:51)</a>:</h4>
<blockquote>
<p>I can already see the "scatter should allow <code>MyPersonalUnionType&lt;T: SimdElement&gt;</code>" request that would be coming on this one's heels</p>
</blockquote>
<p>I think this should be disallowed for sure. If you want I can write the github comment that says no.</p>



<a name="263516985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263516985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263516985">(Dec 02 2021 at 23:51)</a>:</h4>
<p>Yeah I basically agree with Thom</p>



<a name="263517047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263517047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263517047">(Dec 02 2021 at 23:52)</a>:</h4>
<p>Go for it, I just need a formal answer to this question so I can point someone at it later, basically.</p>



<a name="263517104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263517104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263517104">(Dec 02 2021 at 23:53)</a>:</h4>
<p>The "real" building block there is writing to the maybeuninit, but then writing to the initialized version is also easy and obvious to put on top. for anything else, well, there's a lot that's out of scope for core.</p>



<a name="263517154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263517154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263517154">(Dec 02 2021 at 23:53)</a>:</h4>
<p>I also dont think it's that likely. If they want that and know it will be fine, they have the ability to reinterpret as MaybeUninit&lt;TheSimdElement&gt; to perform the write, which will always be valid if the layout does indeed match (or, if it's invalid, it's because they bypassed the <code>Drop</code> impl on their type, which like, yeah).</p>



<a name="263517205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263517205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263517205">(Dec 02 2021 at 23:54)</a>:</h4>
<p>"the problem is in the <code>unsafe</code> code you wrote" yes.</p>



<a name="263517337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263517337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263517337">(Dec 02 2021 at 23:56)</a>:</h4>
<p>the only times I've seen MyPersonalMaybeUninit-alikes is for code that's shimming maybeuninit p much, and hopefully nobody is doing that anymore, especially if they're interested in using std::simd</p>



<a name="263517353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263517353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263517353">(Dec 02 2021 at 23:56)</a>:</h4>
<p>it would be very surprising, to say the least</p>



<a name="263558688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263558688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263558688">(Dec 03 2021 at 10:17)</a>:</h4>
<p>Any time you spot a non-<code>#[repr(C)]</code> union, open an issue / contact its author to ask them to tag it as such. There isn't that much you can do soundly with a repr-Rust union; it should actually be even linted.</p>



<a name="263559016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263559016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263559016">(Dec 03 2021 at 10:21)</a>:</h4>
<p>If you ensure that you only read the variant that is written that is fine even for non-<code>#[repr(C)]</code> unions.</p>



<a name="263574377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263574377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263574377">(Dec 03 2021 at 12:49)</a>:</h4>
<p>Yep, untagged enums is basically their only use case. But that can be covered by a <code>#[repr(C)]</code> enum as well, whereas transmutation cannot be handled by repr-Rust unions, currently. And <code>union</code>s lure people intro using them for transmutation very often, due to how much they look like a C union. So I stand by my rule of thumb; if anything, repr-Rust <code>union</code>s should be opt-in rather than the other way around:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">union</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* … */</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// warning, missing `#[repr(C)]`, which is very error-prone.</span>
<span class="w">                      </span><span class="c1">// If you did intend never to use this enum to transmute stuff,</span>
<span class="w">                      </span><span class="c1">// then add a `#[repr(Rust)]` to silence this warning.</span>
</code></pre></div>



<a name="263600528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263600528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263600528">(Dec 03 2021 at 16:06)</a>:</h4>
<p>yeah it should be a lint</p>



<a name="263628554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263628554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263628554">(Dec 03 2021 at 19:46)</a>:</h4>
<p>...could programmers who want this with their own type just use a <code>#[repr(C)]</code> union with one of the variants being <code>[MaybeUninit&lt;T&gt;; N]</code>?<br>
That would be hilarious.</p>



<a name="263628725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263628725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263628725">(Dec 03 2021 at 19:48)</a>:</h4>
<p>in fact they could. or just use <code>transmute::&lt;MaybeUninit&lt;i32&gt;, MyI32LikeType&gt;</code></p>



<a name="263628798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How%20to%20write%20V%20to%20%26mut%20%5Bunion%20U%3CV%2C%20W%3E%5D%20safely%3F/near/263628798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/How.20to.20write.20V.20to.20.26mut.20.5Bunion.20U.3CV.2C.20W.3E.5D.20safely.3F.html#263628798">(Dec 03 2021 at 19:48)</a>:</h4>
<p>or whatever similar mechanism depending, cast a slice for example</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>