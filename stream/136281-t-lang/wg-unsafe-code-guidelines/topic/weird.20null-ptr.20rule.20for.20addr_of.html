<html>
<head><meta charset="utf-8"><title>weird null-ptr rule for addr_of · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html">weird null-ptr rule for addr_of</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269942814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/269942814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#269942814">(Jan 30 2022 at 16:49)</a>:</h4>
<p>Extra language was added to addr_of by <span class="user-mention" data-user-id="120791">@RalfJ</span>  in this commit: <a href="https://github.com/rust-lang/rust/pull/83815/commits/b93137a24e0de539293a99f6bfce9855cf13679d">https://github.com/rust-lang/rust/pull/83815/commits/b93137a24e0de539293a99f6bfce9855cf13679d</a></p>
<blockquote>
<p>Note, however, that the expr in <code>addr_of!(expr)</code> is still subject to all the usual rules. In particular, <code>addr_of!(*ptr::null())</code> is Undefined Behavior because it dereferences a null pointer.</p>
</blockquote>
<p>My <em>intuition</em> is that this is specifically trying to capture the notion that you aren't allowed to use addr_of to compute the "pure offset" of a field by doing <code>addr_of!((*null).field.subfield)</code>, because addr_of lowers to <code>GEP [inbounds]</code> which requires the pointer to be in an allocation to start with. Or to stay in Rust semantics, it lowers to <code>ptr::offset</code> (which is just <code>GEP [inbounds]</code> with a sheet draped over it).</p>
<p>The <em>precise</em> case of <code>addr_of!(*ptr::null())</code> is weird because this is a no-op, and there's no reason to lower to <code>ptr.offset(0)</code>. Even if it <em>did</em>, <code>offset(0)</code> is a longstanding "uhh???" where it's like, it's <em>probably</em> fine but also hey don't do that? There <em>is</em> established precedent for the language having the notion of "things that are seemingly UB but they're fine because it's a noop" because of ZSTs.</p>
<p>We freely out-of-thin-air pointers to ZSTs and ""read"" and ""write"" to them on the grounds that it's all statically and transparently a noop the compiler can discard. To my knowledge, this claim extends to ZSTs with fields: <code>((), ())</code> is a ZST with fields. This code should work:</p>
<div class="codehilite"><pre><span></span><code>let mut x = ((), ());
let ptr = (&amp;mut x) as *mut _;
*(addr_of!((*x).1) = ();
</code></pre></div>
<p>Now I understand that <code>null</code> is special because we aren't allowed to out-out-thin-air ZSTs there, but like, it seems weird for us to not just allow this weird static noop. If you want to express that you can't do the "pure offset" trick, I suggest explicitly calling <em>that</em> out. And specifically calling out dangling pointers in general.</p>



<a name="269943081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/269943081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#269943081">(Jan 30 2022 at 16:54)</a>:</h4>
<p>"subject to all the usual rules" is also a weird thing to say because what's "usual" wrt <code>addr_of_mut!(place)</code>? clearly not <code>&amp;mut place</code>, so is it just computing the address of <code>place</code>?</p>
<p>I'm not sure where we even define anything like <code>.field</code> having the restrictions of <code>ptr::offset</code>, but we should link that to these docs, instead of a vague reference</p>



<a name="269944123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/269944123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#269944123">(Jan 30 2022 at 17:13)</a>:</h4>
<blockquote>
<p>I'm not sure where we even define anything like <code>.field</code> having the restrictions of <code>ptr::offset</code></p>
</blockquote>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> the standard library docs of <code>std::ptr</code> relates the two: <a href="https://doc.rust-lang.org/nightly/std/ptr/index.html#allocated-object">https://doc.rust-lang.org/nightly/std/ptr/index.html#allocated-object</a></p>
<blockquote>
<h2><a href="https://doc.rust-lang.org/nightly/std/ptr/index.html#allocated-object">Allocated object</a></h2>
<p>For several operations, such as <a href="https://doc.rust-lang.org/nightly/std/primitive.pointer.html#method.offset"><code>offset</code></a> or field projections (<code>expr.field</code>), the notion of an “allocated object” becomes relevant. An allocated object is a contiguous region of memory. Common examples of allocated objects include stack-allocated variables (each variable is a separate allocated object), heap allocations (each allocation created by the global allocator is a separate allocated object), and <code>static</code> variables.</p>
</blockquote>



<a name="269944178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/269944178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#269944178">(Jan 30 2022 at 17:14)</a>:</h4>
<p>great, it's even in the same module :D</p>



<a name="269944191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/269944191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#269944191">(Jan 30 2022 at 17:14)</a>:</h4>
<p>so yeah the <code>addr_of</code> macros should link to that</p>



<a name="270999136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/270999136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#270999136">(Feb 07 2022 at 15:57)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> </p>
<blockquote>
<p>The precise case of addr_of!(*ptr::null()) is weird because this is a no-op, and there's no reason to lower to ptr.offset(0). Even if it did, offset(0) is a longstanding "uhh???" where it's like, it's probably fine but also hey don't do that? There is established precedent for the language having the notion of "things that are seemingly UB but they're fine because it's a noop" because of ZSTs.</p>
</blockquote>
<p>I think the confusion arises because you are thinking in terms of "what this lowers to" (e.g. in LLVM), but these docs are written in a way that encourages to think on the level of surface Rust or maybe MIR -- I think that is the level on which we want to write the spec.<br>
On that level, <code>addr_of!(*ptr::null())</code> is definitely not a NOP. It constructs a value of ptr type (a NULL ptr), and then does a value-to-place conversion (<code>*</code>, also often called "dereferencing a pointer", but sadly "dereferencing" is rather ambiguous), and then it does a place-to-value coercion (addr_of). In my mental model, and according to what the Reference and Miri currently require, the key step here is the value-to-place coercion: the requirement is that all places always point to valid memory, so value-to-place conversion is UB if the (ptr) value is dangling or null.<br>
As <span class="user-mention" data-user-id="119009">@eddyb</span> put it in private conversion, one can think of this as an extra "validity invariant" that is imposed on all places ever constructed during program execution.</p>



<a name="271558609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/271558609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#271558609">(Feb 11 2022 at 10:47)</a>:</h4>
<p>As a side not as far as I understand references to ZST are required to not be <code>ptr::null()</code> for various reasons, but instead point to some "arbitrary assumed to hold an allocated object  place with an non-zero address". Or is that an misunderstanding on my side?</p>



<a name="271588639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/271588639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#271588639">(Feb 11 2022 at 15:02)</a>:</h4>
<p>They also need to be properly aligned</p>



<a name="271683054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/271683054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#271683054">(Feb 12 2022 at 10:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209646">Philipp Korber</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of/near/271558609">said</a>:</p>
<blockquote>
<p>As a side not as far as I understand references to ZST are required to not be <code>ptr::null()</code> for various reasons, but instead point to some "arbitrary assumed to hold an allocated object  place with an non-zero address". Or is that an misunderstanding on my side?</p>
</blockquote>
<p>yes. an <code>&amp;()</code> must be non-null and either obtained by casting an integer to a reference, or point to an actually allocated blob of memory.<br>
an <code>&amp;[i32;0]</code> must additionally be 4-aligned (on platforms where <code>i32</code> has alignment 4).</p>



<a name="272998168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird%20null-ptr%20rule%20for%20addr_of/near/272998168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/weird.20null-ptr.20rule.20for.20addr_of.html#272998168">(Feb 23 2022 at 19:18)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> also see <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/319">https://github.com/rust-lang/unsafe-code-guidelines/issues/319</a> which I just opened</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>