<html>
<head><meta charset="utf-8"><title>Iterator specialization troubles · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html">Iterator specialization troubles</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277046461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277046461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277046461">(Mar 29 2022 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span><br>
<a href="https://github.com/rust-lang/rust/issues/94231">https://github.com/rust-lang/rust/issues/94231</a></p>



<a name="277046529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277046529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277046529">(Mar 29 2022 at 18:25)</a>:</h4>
<p>I don't know if I already pinged you about this, sorry if I did</p>



<a name="277046896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277046896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277046896">(Mar 29 2022 at 18:28)</a>:</h4>
<p>Y I K E S</p>



<a name="277050812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277050812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277050812">(Mar 29 2022 at 19:01)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/94231#issuecomment-1048044145">this comment</a> is particularly amusing (for large values of 'amusing') :D</p>



<a name="277051197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277051197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277051197">(Mar 29 2022 at 19:04)</a>:</h4>
<p>Wow, almost all of those are issues with the combination of _iterator_get_unchecked and zip. wild.</p>



<a name="277052801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277052801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277052801">(Mar 29 2022 at 19:17)</a>:</h4>
<p>In light of this it would be cool to have some sort of uncovered unsafe code assessment. The standard library is tested under Miri, which trivially detects the problem. So I'm pretty sure this is unsafe code in the standard library which isn't tested. Ouch.</p>



<a name="277068208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277068208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277068208">(Mar 29 2022 at 21:41)</a>:</h4>
<p>well for aliasing issues code also sometimes needs to be invoked in a certain way (like actually using certain references) to cause UB</p>



<a name="277068237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277068237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277068237">(Mar 29 2022 at 21:41)</a>:</h4>
<p>and this will get worse when we 'improve' SB to fix things like <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/133">https://github.com/rust-lang/unsafe-code-guidelines/issues/133</a></p>



<a name="277068294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277068294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277068294">(Mar 29 2022 at 21:42)</a>:</h4>
<p>but yeah specialization is super tricky to test exhaustively</p>



<a name="277068324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277068324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277068324">(Mar 29 2022 at 21:42)</a>:</h4>
<p>might there be tests in run-pass? (which Miri does no run)</p>



<a name="277084535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277084535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277084535">(Mar 30 2022 at 01:32)</a>:</h4>
<p>Do we have any data on how many aliasing issues are discovered by invoking code in a specific way? I definitely agree that invalidate-on-write would move toward that direction, but I've just seen quite a few pieces of code which are UB due to aliasing <em>by design</em>, not because of any odd use or input. Such as the code in question, or <code>rust-argon2</code>, or <code>owning_ref</code>/<code>lru</code>/<code>string_cache</code>, or <code>color-eyre</code>.</p>
<p>Maybe this is a personal bias, but I'm just not bothered by aliasing issues due to uncommon code paths or usages such as what might be hit by a sophistocated fuzzer, because of how much trivially invalid code we already have.</p>



<a name="277298504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277298504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277298504">(Mar 31 2022 at 15:27)</a>:</h4>
<p>I am pretty sure I found at least one bug with <a href="https://github.com/rust-lang/miri/blob/master/tests/run-pass/vec.rs#L4">https://github.com/rust-lang/miri/blob/master/tests/run-pass/vec.rs#L4</a></p>



<a name="277298512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277298512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277298512">(Mar 31 2022 at 15:27)</a>:</h4>
<p>but I dont remember any details...</p>



<a name="277298656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator%20specialization%20troubles/near/277298656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Iterator.20specialization.20troubles.html#277298656">(Mar 31 2022 at 15:28)</a>:</h4>
<p>ah here you go: <a href="https://github.com/rust-lang/rust/issues/74029">https://github.com/rust-lang/rust/issues/74029</a> (it wasn't me but it found a bug)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>