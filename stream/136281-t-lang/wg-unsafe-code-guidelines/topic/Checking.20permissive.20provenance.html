<html>
<head><meta charset="utf-8"><title>Checking permissive provenance · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html">Checking permissive provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278397644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278397644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278397644">(Apr 09 2022 at 08:44)</a>:</h4>
<p>Ok, what I have is up, but tags not being contiguous because of  <code>UnsafeCell</code> made my life difficult, I've only implemented SRW from SRW reborrowing of wildcard tags one layer deep, and the diagnostics are kind of a mess.</p>
<p>My current model is what I discussed above, where int-to-ptr casts produce a Wildcard tag with permission SRW, any reborrows to SRW also have a Wildcard tag, but any other reborrows use the item at the top of the borrow stack. I've tested this on real world code and it works, but that's just getting past my implementation, and nothing more :P.</p>



<a name="278397660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278397660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278397660">(Apr 09 2022 at 08:45)</a>:</h4>
<p>Here's my attempt at "porting" <a href="https://github.com/rust-lang/rust/issues/273">#273</a> to ptr-to-int shenanigans, and what exactly this implementation allows and disallows. <a href="https://gist.github.com/carbotaniuman/223b4a797ef852257d12a6210935fa99">https://gist.github.com/carbotaniuman/223b4a797ef852257d12a6210935fa99</a></p>



<a name="278408302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278408302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278408302">(Apr 09 2022 at 12:41)</a>:</h4>
<p>nice :D</p>



<a name="278408331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278408331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278408331">(Apr 09 2022 at 12:42)</a>:</h4>
<p>in terms of reviewing I wonder if it would make sense to first land something for just the AllocId part (no SB support)? smaller PRs are significantly easier to review than big ones.</p>



<a name="278431733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278431733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278431733">(Apr 09 2022 at 21:25)</a>:</h4>
<p>Yeah that can be done, although the SB part is quite well isolated from the rest of the code. I'd like some more examples to run it on (especially on the SB side).</p>



<a name="278431879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278431879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278431879">(Apr 09 2022 at 21:28)</a>:</h4>
<p>This angelic non-determinism helps us fix some other stuff like <a href="https://github.com/rust-lang/miri/issues/1866">https://github.com/rust-lang/miri/issues/1866</a> as I could keep extending our notion of reifying pointers. (Although I think 1866 could just be replaced by changing casts to ZSTs to have <code>invalid_addr</code> semantics).</p>



<a name="278431974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278431974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278431974">(Apr 09 2022 at 21:30)</a>:</h4>
<p>And the fact that <code>UnsafeCell</code> exists is painful, I don't know how to do diagnostics at all when say the first 4 bytes are tagged normally and the last 4 are wildcard.</p>



<a name="278472032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278472032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278472032">(Apr 10 2022 at 14:47)</a>:</h4>
<p>yeah indeed fixing 1866 will be nice :D</p>



<a name="278472049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278472049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278472049">(Apr 10 2022 at 14:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278431974">said</a>:</p>
<blockquote>
<p>And the fact that <code>UnsafeCell</code> exists is painful, I don't know how to do diagnostics at all when say the first 4 bytes are tagged normally and the last 4 are wildcard.</p>
</blockquote>
<p>not sure what UnsafeCell changes here? everything is bytewise, so even a <code>&amp;mut u64</code> might encounter different borrow stacks for the first 4 and the last 4 bytes</p>



<a name="278490490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278490490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278490490">(Apr 10 2022 at 21:22)</a>:</h4>
<p>If pointers have the same permissions the full range, I can make being wildcard a property of  the pointer, and not have to make it a property of every stack.</p>



<a name="278490610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278490610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278490610">(Apr 10 2022 at 21:25)</a>:</h4>
<p>That's tricky with partial invalidation</p>



<a name="278490678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278490678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278490678">(Apr 10 2022 at 21:26)</a>:</h4>
<p>Can you explain a bit more? Not sure what that is sorry.</p>



<a name="278490704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278490704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278490704">(Apr 10 2022 at 21:27)</a>:</h4>
<p>As in casting say a u64 to a u32 and then invalidating the first 4 bytes?</p>



<a name="278490955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278490955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278490955">(Apr 10 2022 at 21:33)</a>:</h4>
<p>No I mean you can create a pointer to a u64 then remove its tag from any one of the bytes in that u64's borrow stacks, so that the pointer can only be used for 7 of the 8 bytes.</p>



<a name="278491342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491342">(Apr 10 2022 at 21:43)</a>:</h4>
<p>Hm actually I can only do this with aggregates. I wonder if I'm just uncreative.</p>



<a name="278491397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491397">(Apr 10 2022 at 21:44)</a>:</h4>
<p>Is your example something like this? (With raw pointers tagged)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span><span class="w"></span>

<span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="278491418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491418">(Apr 10 2022 at 21:45)</a>:</h4>
<p>Even without raw pointer tagging, this program is rejected.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="k">u8</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="278491468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491468">(Apr 10 2022 at 21:46)</a>:</h4>
<p>Right yeah that makes sense.</p>



<a name="278491547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491547">(Apr 10 2022 at 21:49)</a>:</h4>
<p>I guess wildcard provenance should be a property of the stack then. That makes stuff easier-ish, but I'll need to change the diagnostics to mention that.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="n">attempting</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2075</span><span class="o">&gt;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">alloc995</span><span class="p">[</span><span class="mh">0x7</span><span class="p">],</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">borrow</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">location</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">alloc995</span><span class="p">[</span><span class="mh">0x0</span><span class="o">..</span><span class="mh">0x8</span><span class="p">]</span><span class="w"></span>
</code></pre></div>



<a name="278491550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491550">(Apr 10 2022 at 21:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278490490">said</a>:</p>
<blockquote>
<p>If pointers have the same permissions the full range, I can make being wildcard a property of  the pointer, and not have to make it a property of every stack.</p>
</blockquote>
<p>wait, I am confused. of course this is a property of the pointer.<br>
on the stack side we have this "unknown stack" thing we discussed recently. I though?</p>



<a name="278491606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491606">(Apr 10 2022 at 21:50)</a>:</h4>
<p>Poor wording, it's a property of the pointer, but it has to be stored in the stacks. Aka, I can't just make an <code>SbTag::Wildcard</code>.</p>



<a name="278491626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491626">(Apr 10 2022 at 21:51)</a>:</h4>
<p>right, I thought we had reached consensus that stacks look like now but you add a <code>bool</code> flag indicating "there is more unknown stuff below the things in that <code>Vec&lt;Item&gt;</code>"</p>



<a name="278491698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491698">(Apr 10 2022 at 21:53)</a>:</h4>
<p>Ah, I'm derping. Got any implementation tips for that?</p>



<a name="278491704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491704">(Apr 10 2022 at 21:53)</a>:</h4>
<p>Right now I have something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Clone, Debug, PartialEq, Eq)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Stack</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Used *mostly* as a stack; never empty.</span>
<span class="w">    </span><span class="sd">/// Invariants:</span>
<span class="w">    </span><span class="sd">/// * Above a `SharedReadOnly` there can only be more `SharedReadOnly`.</span>
<span class="w">    </span><span class="sd">/// * Except for `Untagged`, no tag occurs in the stack more than once.</span>
<span class="w">    </span><span class="n">borrows</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Tags that should be treated as wildcards.</span>
<span class="w">    </span><span class="n">treated_as_wildcard</span>: <span class="nc">FxHashSet</span><span class="o">&lt;</span><span class="n">SbTag</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278491712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491712">(Apr 10 2022 at 21:53)</a>:</h4>
<p>oh I see</p>



<a name="278491716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491716">(Apr 10 2022 at 21:53)</a>:</h4>
<p><code>treated_as_wildcard</code> should be in <code>GlobalState</code></p>



<a name="278491763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491763">(Apr 10 2022 at 21:54)</a>:</h4>
<p>also <code>exposed</code> might be a better name</p>



<a name="278491770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491770">(Apr 10 2022 at 21:54)</a>:</h4>
<p>it's not like those tags are treated like wildcards, it's the other way around -- wildcard pointers are treated as if they are any of those tags</p>



<a name="278491787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491787">(Apr 10 2022 at 21:55)</a>:</h4>
<p>Those are two seperate things, I have this here:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GlobalStateInner</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Hashset of all pointers that have been exposed</span>
<span class="w">    </span><span class="n">exposed_tags</span>: <span class="nc">FxHashSet</span><span class="o">&lt;</span><span class="n">SbTag</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278491796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491796">(Apr 10 2022 at 21:55)</a>:</h4>
<p>Basically from a <code>*mut (u32, UnsafeCell&lt;u32&gt;)</code> to a <code>&amp;mut (u32, UnsafeCell&lt;u32&gt;)</code>, the last 4 bytes should still have wildcard provenance if we want no false positives.</p>



<a name="278491854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491854">(Apr 10 2022 at 21:56)</a>:</h4>
<p>if you have that global thing you shouldnt need anything in the <code>Stack</code> besides a <code>bool</code></p>



<a name="278491866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491866">(Apr 10 2022 at 21:57)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Stack</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Used *mostly* as a stack; never empty.</span>
<span class="w">    </span><span class="sd">/// Invariants:</span>
<span class="w">    </span><span class="sd">/// * Above a `SharedReadOnly` there can only be more `SharedReadOnly`.</span>
<span class="w">    </span><span class="sd">/// * Except for `Untagged`, no tag occurs in the stack more than once.</span>
<span class="w">    </span><span class="n">borrows</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Indicates that below the items listed above, an unknown set of further items exists.</span>
<span class="w">    </span><span class="n">unknown_bottom</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278491874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491874">(Apr 10 2022 at 21:57)</a>:</h4>
<p>and then the trick will be figuring out what that does in the existing checks. that will need some refactoring.</p>



<a name="278491916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491916">(Apr 10 2022 at 21:58)</a>:</h4>
<p>basically, if <code>find_granting</code> doesnt find anything in <code>borrows</code> but <code>unknown_bottom</code> is <code>true</code>, it has to say "yeah I think there might be a granting item but I dont know what it looks like"</p>



<a name="278491932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491932">(Apr 10 2022 at 21:59)</a>:</h4>
<p>Ah. Here's my <code>find_granting</code> right now for reference:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">is_wildcard</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="fm">matches!</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">SbTag</span>::<span class="n">Wildcard</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">treated_as_wildcard</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span><span class="w"></span>

<span class="bp">self</span><span class="p">.</span><span class="n">borrows</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="c1">// we also need to know *where* in the stack</span>
<span class="w">    </span><span class="p">.</span><span class="n">rev</span><span class="p">()</span><span class="w"> </span><span class="c1">// search top-to-bottom</span>
<span class="w">    </span><span class="c1">// Return permission of first item that grants access.</span>
<span class="w">    </span><span class="c1">// We require a permission with the right tag, ensuring U3 and F3.</span>
<span class="w">    </span><span class="p">.</span><span class="n">find_map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// a wildcard tag allows access to all exposed tags</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">wildcard_match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_wildcard</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">global</span><span class="p">.</span><span class="n">exposed_tags</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wildcard_match</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">perm</span><span class="p">.</span><span class="n">grants</span><span class="p">(</span><span class="n">access</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
</code></pre></div>



<a name="278491943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278491943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278491943">(Apr 10 2022 at 21:59)</a>:</h4>
<p>I dont even conceptually understand what you mean by treating an item in the borrow stack as a wildcard</p>



<a name="278492014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492014">(Apr 10 2022 at 22:00)</a>:</h4>
<p>Why is it <code>unknown_bottom</code> instead of an <code>Unknown</code> stack element that acts like an unknown list of borrow stack elements in the middle?</p>



<a name="278492052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492052">(Apr 10 2022 at 22:00)</a>:</h4>
<p>like shouldn't <code>[SRW a, unknown, SRW c]</code> be a possibility</p>



<a name="278492057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492057">(Apr 10 2022 at 22:00)</a>:</h4>
<p>if a wildcard pointer is used on a stack with <code>unknown_bottom == false</code> (i.e. the first time it is used), you search <code>borrows</code> and if any item there is in <code>global.exposed</code>, this matches... and you basically replace the entire stack by "unknown". (not sure if there is any information we can usefully preserve here.)</p>



<a name="278492070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492070">(Apr 10 2022 at 22:01)</a>:</h4>
<p>Yeah I may be way off-base here.</p>



<a name="278492076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492076">(Apr 10 2022 at 22:01)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> good question! I thought so, too, at first. but I dont think there is any point in preserving the part of the stack below <code>unknown</code>. it will never be relevant again.</p>



<a name="278492082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492082">(Apr 10 2022 at 22:01)</a>:</h4>
<p>But I'm not treating an items as a wildcard, I'm treating the <code>SbTag::Tagged(PtrId)</code> as a wildcard.</p>



<a name="278492085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492085">(Apr 10 2022 at 22:01)</a>:</h4>
<p><code>find_granting</code> always returns true when it hits the first <code>unknown</code>, so it'll never even look at the stuff below</p>



<a name="278492125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492125">(Apr 10 2022 at 22:02)</a>:</h4>
<p>If you have <code>[Unique a, unknown]</code> and derive a pointer from <code>a</code>, I think it will pop the <code>unknown</code></p>



<a name="278492162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492162">(Apr 10 2022 at 22:03)</a>:</h4>
<p>hm...</p>



<a name="278492204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492204">(Apr 10 2022 at 22:04)</a>:</h4>
<p>that would require an even more clever <code>find_granting</code></p>



<a name="278492209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492209">(Apr 10 2022 at 22:04)</a>:</h4>
<p>basically it has to exploit that tags in borrow stacks are unique, and so <code>a</code> can <em>not</em> be in 'unknown', and so it can be skipped</p>



<a name="278492218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492218">(Apr 10 2022 at 22:05)</a>:</h4>
<p>because naively, even when searching for <code>a</code>, it'd just say "hit" when finding the <code>unknown</code></p>



<a name="278492243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492243">(Apr 10 2022 at 22:05)</a>:</h4>
<p>I think you would search for <code>a</code>, and as you walk the stack you take note when you pass <code>unknown</code> but only use that to grant the access if you don't find the <code>a</code> tag further along</p>



<a name="278492283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492283">(Apr 10 2022 at 22:06)</a>:</h4>
<p>yeah...</p>



<a name="278492291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492291">(Apr 10 2022 at 22:06)</a>:</h4>
<p>but you are right we could be more precise here. good catch!</p>



<a name="278492324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492324">(Apr 10 2022 at 22:07)</a>:</h4>
<p>Mmm yeah <code>Unknown</code> would make some of this easier.</p>



<a name="278492375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492375">(Apr 10 2022 at 22:09)</a>:</h4>
<p>I still think we need <code>treated_as_wildcard</code> (I'm realizing this is a terrible name) for the <code>*mut (u32, UnsafeCell&lt;u32&gt;)</code> to a <code>&amp;mut (u32, UnsafeCell&lt;u32&gt;)</code> case though.</p>



<a name="278492549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278492549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278492549">(Apr 10 2022 at 22:13)</a>:</h4>
<p>Because if you just return true when hitting an <code>unknown</code>, then something like this would be allowed:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="k">u8</span><span class="p">];</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">b_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">expose_addr</span><span class="p">();</span><span class="w"></span>
<span class="o">*</span><span class="p">(</span><span class="n">b_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>

<span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="c1">// I think this should be UB</span>
</code></pre></div>



<a name="278495652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278495652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278495652">(Apr 10 2022 at 23:37)</a>:</h4>
<p>that does doesnt involve an <code>UnsafeCell</code> though?</p>



<a name="278495706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278495706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278495706">(Apr 10 2022 at 23:38)</a>:</h4>
<p>I agree that code should be UB, I dont agree we have to catch that code. don't make the perfect the enemy of the good. if you call <code>expose_addr</code>, <em>expect</em> some missed UB.</p>



<a name="278498755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278498755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278498755">(Apr 11 2022 at 00:53)</a>:</h4>
<p>If you have a global list of exposed tags (not sure if this is <code>treated_as_wildcard</code> or <code>exposed_tags</code> in your implementation), then you should be able to catch this one, since <code>a</code> is not exposed</p>



<a name="278499100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278499100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278499100">(Apr 11 2022 at 01:01)</a>:</h4>
<p>Yeah, that's <code>exposed_tags</code>. I have my <code>find_granting</code> as this right now.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">tag_is_wildcard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">wildcard_tags</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span><span class="w"></span>

<span class="bp">self</span><span class="p">.</span><span class="n">borrows</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="c1">// we also need to know *where* in the stack</span>
<span class="w">    </span><span class="p">.</span><span class="n">rev</span><span class="p">()</span><span class="w"> </span><span class="c1">// search top-to-bottom</span>
<span class="w">    </span><span class="c1">// Return permission of first item that grants access.</span>
<span class="w">    </span><span class="c1">// We require a permission with the right tag, ensuring U3 and F3.</span>
<span class="w">    </span><span class="p">.</span><span class="n">find_map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// A wildcard tag allows access to all exposed tags</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">wildcard_match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag_is_wildcard</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">global</span><span class="p">.</span><span class="n">exposed_tags</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wildcard_match</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">perm</span><span class="p">.</span><span class="n">grants</span><span class="p">(</span><span class="n">access</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
</code></pre></div>



<a name="278499229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278499229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278499229">(Apr 11 2022 at 01:04)</a>:</h4>
<p>I could refactor it so that exposing the address of a pointer pushes an <code>Unknown</code> with the same permission directly on top, and change the logic inside of the <code>find_map</code> closure.</p>



<a name="278503119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278503119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278503119">(Apr 11 2022 at 02:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278498755">said</a>:</p>
<blockquote>
<p>If you have a global list of exposed tags (not sure if this is <code>treated_as_wildcard</code> or <code>exposed_tags</code> in your implementation), then you should be able to catch this one, since <code>a</code> is not exposed</p>
</blockquote>
<p>but there'll be <code>Unknown</code> in the borrow stack of <code>x[1]</code> and <code>a</code> might match that so it should be accepted. unless we go even further and refine <code>unknown</code> by tracking which tags might be in there. but I would not do that for a first prototype.^^</p>



<a name="278503774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278503774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278503774">(Apr 11 2022 at 02:54)</a>:</h4>
<p>Is there a reason why this code doesn't put the new <code>SharedReadWrite</code> directly on top?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="c1">// SharedReadWrite can coexist with "existing loans", meaning they don't act like a write</span>
<span class="w">            </span><span class="c1">// access. Instead of popping the stack, we insert the item at the place the stack would</span>
<span class="w">            </span><span class="c1">// be popped to (i.e., we insert it above all the write-compatible items).</span>
<span class="w">            </span><span class="c1">// This ensures F2b by adding the new item below any potentially existing `SharedReadOnly`.</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">find_first_write_incompatible</span><span class="p">(</span><span class="n">granting_idx</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="278503836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278503836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278503836">(Apr 11 2022 at 02:56)</a>:</h4>
<p>Actually somewhat of a dumb question now that I think about it, because I can just push the <code>Unknown</code> using this same logic and have it still work.</p>



<a name="278504128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278504128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278504128">(Apr 11 2022 at 03:01)</a>:</h4>
<p><a href="https://github.com/rust-lang/miri/pull/727">https://github.com/rust-lang/miri/pull/727</a> looks like it changed this behavior from the obvious.</p>



<a name="278540028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278540028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278540028">(Apr 11 2022 at 11:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278503119">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278498755">said</a>:</p>
<blockquote>
<p>If you have a global list of exposed tags (not sure if this is <code>treated_as_wildcard</code> or <code>exposed_tags</code> in your implementation), then you should be able to catch this one, since <code>a</code> is not exposed</p>
</blockquote>
<p>but there'll be <code>Unknown</code> in the borrow stack of <code>x[1]</code> and <code>a</code> might match that so it should be accepted. unless we go even further and refine <code>unknown</code> by tracking which tags might be in there. but I would not do that for a first prototype.^^</p>
</blockquote>
<p>The argument I had in mind was that <code>a</code> can never appear in the <code>Unknown</code> part of a borrow stack because it is not derived from a wildcard pointer and neither it nor any of its ancestors are exposed. This is a property of the tag <code>a</code> and does not need to be tracked in the borrow stack</p>



<a name="278540453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278540453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278540453">(Apr 11 2022 at 11:38)</a>:</h4>
<p>It's true that this is a bit sophisticated for v1, but it doesn't seem like something fundamentally unreachable without a total redesign like some of the other things we've talked about, so it might fit in v2</p>



<a name="278540667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278540667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278540667">(Apr 11 2022 at 11:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278540028">said</a>:</p>
<blockquote>
<p>neither it nor any of its ancestors are exposed</p>
</blockquote>
<p>Actually, I don't think it's even necessary to care about ancestors here, since even if you got a hold of <code>a</code>'s parent you can't use it to make another pointer with tag <code>a</code>, any reborrow would result in a fresh tag. The only way to get <code>a</code> itself is if it is exposed and then picked up by a wildcard pointer</p>



<a name="278578603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278578603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278578603">(Apr 11 2022 at 16:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278504128">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/miri/pull/727">https://github.com/rust-lang/miri/pull/727</a> looks like it changed this behavior from the obvious.</p>
</blockquote>
<p>I dont see the relation between that PR and your question</p>



<a name="278578638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278578638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278578638">(Apr 11 2022 at 16:20)</a>:</h4>
<p>regarding the question, that would disallow some safe code you can write with RefCell</p>



<a name="278578680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278578680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278578680">(Apr 11 2022 at 16:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/miri/blob/master/tests/run-pass/stacked-borrows/refcell.rs">https://github.com/rust-lang/miri/blob/master/tests/run-pass/stacked-borrows/refcell.rs</a> has some nasty examples</p>



<a name="278578725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278578725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278578725">(Apr 11 2022 at 16:21)</a>:</h4>
<p>with RefCell you can have an <code>&amp;RefCell</code> and a <code>&amp;mut T</code> <em>that overlap</em> and both are active at the same time</p>



<a name="278578751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278578751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278578751">(Apr 11 2022 at 16:21)</a>:</h4>
<p>then if someone reborrows the <code>&amp;RefCell</code> we have to not destroy that <code>&amp;mut T</code></p>



<a name="278578764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278578764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278578764">(Apr 11 2022 at 16:21)</a>:</h4>
<p>so we have to be very careful when reborrowing for SRW</p>



<a name="278611509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278611509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278611509">(Apr 11 2022 at 20:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278578603">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278504128">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/miri/pull/727">https://github.com/rust-lang/miri/pull/727</a> looks like it changed this behavior from the obvious.</p>
</blockquote>
<p>I dont see the relation between that PR and your question</p>
</blockquote>
<p>When reborrowing a SRW from a SRW, why is the resulting SRW placed on top of the block of SRWs, and not on top of the  original SRW? The PR changes the behavior from the latter to the former.</p>



<a name="278617289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278617289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> riking <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278617289">(Apr 11 2022 at 21:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278384176">said</a>:</p>
<blockquote>
<p>Right now, <code>addr</code> is implemented via transmute in my experiments. Similarly, <code>invalid</code> is a transmute in the other direction.</p>
</blockquote>
<p>I mean, eventually you need to make it a lang item in order to implement an intrinsic right. Why not just jump there now.</p>



<a name="278624415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278624415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278624415">(Apr 11 2022 at 22:17)</a>:</h4>
<p>doesnt need to be a lang item, but yeah it should probably be an intrinsic</p>



<a name="278624476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278624476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278624476">(Apr 11 2022 at 22:17)</a>:</h4>
<blockquote>
<p>When reborrowing a SRW from a SRW, why is the resulting SRW placed on top of the block of SRWs, and not on top of the SRW that we derived_from? The PR changes the behavior from the latter to the former.</p>
</blockquote>
<p>the order of a bunch of SRWs in a block doesn't matter at all, so where in that block we but it is irrelevant</p>



<a name="278624595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278624595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278624595">(Apr 11 2022 at 22:18)</a>:</h4>
<p>so, this was probably a side-effect of a refactor, where now the other way is more natural to implement</p>



<a name="278624609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278624609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278624609">(Apr 11 2022 at 22:18)</a>:</h4>
<p>(or I am misunderstanding the question)</p>



<a name="278624646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278624646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278624646">(Apr 11 2022 at 22:19)</a>:</h4>
<p>Ah ok, just checking that it was indeed irrelevant.</p>



<a name="278624832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278624832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278624832">(Apr 11 2022 at 22:21)</a>:</h4>
<p>if it's all just within a block of SRW then yes it is irrelevant</p>



<a name="278679802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278679802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278679802">(Apr 12 2022 at 11:36)</a>:</h4>
<p>Is there any way to force the int2ptr casts here to not give <code>q1</code> and <code>q2</code> the same provenance? (i.e. so that <code>q1=p1</code>, <code>q2=p2</code> and <code>q1=p2</code>,<code>q2=p1</code> are sound but <code>q1=q2=p1</code> and <code>q1=q2=p2</code> is not)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">];</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">r1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="n">p2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="278681613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278681613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278681613">(Apr 12 2022 at 11:55)</a>:</h4>
<p>I mean, with angelic non-determinism, you can just choose. Pretend they have the provenance you like and go about your day like normal. I must not be understanding your goal here</p>



<a name="278682362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278682362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278682362">(Apr 12 2022 at 12:01)</a>:</h4>
<p>My goal is to find a program where angelic non-provenance is _forced_ to make such a choice, as opposed to a program where that choice is allowed.</p>



<a name="278682497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278682497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278682497">(Apr 12 2022 at 12:03)</a>:</h4>
<p>i.e. angelic non-provenance will always make a choice such that the program has defined behavior if one exists, so the choices I want should be the only ones for which the behavior is defined</p>



<a name="278682642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278682642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278682642">(Apr 12 2022 at 12:04)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// this should be UB</span>
<span class="kd">let</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// this should not be UB</span>
<span class="kd">let</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>and similarly for the two other cases</p>



<a name="278683363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278683363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278683363">(Apr 12 2022 at 12:11)</a>:</h4>
<p>(Context is that I attempted to show that making an implementation of angelic non-determinism is NP-complete, and all of my attempts required something like the above.)</p>



<a name="278684000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278684000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278684000">(Apr 12 2022 at 12:18)</a>:</h4>
<p>Unless I'm missing something, that's just (assuming tagged-raw-pointers):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">*</span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="o">*</span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="o">*</span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="278684248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278684248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278684248">(Apr 12 2022 at 12:21)</a>:</h4>
<p>This one also should not be UB, and unless I'm missing something, your example is UB here. (because you invalidated <code>r2</code> with the first write)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="278684434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278684434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278684434">(Apr 12 2022 at 12:23)</a>:</h4>
<p>Oh, I see</p>



<a name="278684455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278684455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278684455">(Apr 12 2022 at 12:23)</a>:</h4>
<p>You might be able to do this with <code>UnsafeCell</code> shenanigans</p>



<a name="278685335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278685335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278685335">(Apr 12 2022 at 12:31)</a>:</h4>
<p>Unless you're adding some runtime branching based on opaque values, I don't think that's possible. You can't dereference p2 and then p1, but you can dereference p1 and then p2. (So no single execution can be valid for both permutations)</p>



<a name="278685635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278685635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278685635">(Apr 12 2022 at 12:34)</a>:</h4>
<p>I also could not find any way to do it.</p>



<a name="278701246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278701246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278701246">(Apr 12 2022 at 14:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278682362">said</a>:</p>
<blockquote>
<p>My goal is to find a program where angelic non-provenance is _forced_ to make such a choice, as opposed to a program where that choice is allowed.</p>
</blockquote>
<p>see the <a href="https://www.ralfj.de/blog/2022/04/11/provenance-exposed.html#appendix">appendix</a> of my blog post? :)</p>



<a name="278707344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278707344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278707344">(Apr 12 2022 at 15:12)</a>:</h4>
<p>Hmm, it doesn't quite do it..</p>



<a name="278715413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278715413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278715413">(Apr 12 2022 at 16:12)</a>:</h4>
<p><span class="user-mention" data-user-id="218683">@Alice Ryhl</span> then I dont understand what you are asking for. that code is an example where, given the same integer, two different casts <em>have</em> to produce different provenance.</p>



<a name="278715473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278715473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278715473">(Apr 12 2022 at 16:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278682362">said</a>:</p>
<blockquote>
<p>My goal is to find a program where angelic non-provenance is _forced_ to make such a choice, as opposed to a program where that choice is allowed.</p>
</blockquote>
<p>isn't that what you mean here? ^</p>



<a name="278716173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278716173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278716173">(Apr 12 2022 at 16:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278715473">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance/near/278682362">said</a>:</p>
<blockquote>
<p>My goal is to find a program where angelic non-provenance is _forced_ to make such a choice, as opposed to a program where that choice is allowed.</p>
</blockquote>
<p>isn't that what you mean here? ^</p>
</blockquote>
<p>I think the goal is this: Consider two int to pointer casts yielding <code>p</code> and <code>q</code>, where the allowed provenances for each pointer are exactly <code>a, b</code>. Find a program in which <code>prov(p) = a, prov(q) = b</code> and <code>prov(p) = b, prov(q) = a</code> would both lead to defined behavior, but neither of the other two choices would</p>



<a name="278716402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278716402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278716402">(Apr 12 2022 at 16:20)</a>:</h4>
<p>uh. okay that's a fun puzzle but I dont quite understand why it's interesting.</p>



<a name="278716689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278716689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278716689">(Apr 12 2022 at 16:22)</a>:</h4>
<p>Alice said that she was attempting to prove that checking weak provenance is NP-Complete</p>



<a name="278717491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking%20permissive%20provenance/near/278717491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.html#278717491">(Apr 12 2022 at 16:28)</a>:</h4>
<p><span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>