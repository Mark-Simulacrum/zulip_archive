<html>
<head><meta charset="utf-8"><title>copy_nonoverlapping and provenance · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html">copy_nonoverlapping and provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257940959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257940959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257940959">(Oct 17 2021 at 19:08)</a>:</h4>
<p>does <code>copy_nonoverlapping</code> preserve provenance of stuff it points to even when <code>T</code> isnt a pointer?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cpd_to_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">copy_nonoverlapping</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">cpd_to_ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">cpd_to_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>miri doesn't flag this as UB even with <code>-Zmiri-track-raw-pointers</code> and i'm wondering if <code>*cpd_to_ptr = 3</code> is actually UB and miri just doesnt detect it, or if this is actually fine.</p>



<a name="257941001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257941001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257941001">(Oct 17 2021 at 19:09)</a>:</h4>
<p>(I had assumed this <em>wouldnt</em> be okay because ptr-int-ptr roundtrips lose provenance)</p>



<a name="257943611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257943611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257943611">(Oct 17 2021 at 19:50)</a>:</h4>
<p>This should be legal. Memory is not typed, so this is just a memcpy, which copies all the bytes of the pointer, and the provenance goes along for the ride when you do that.</p>



<a name="257943629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257943629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257943629">(Oct 17 2021 at 19:51)</a>:</h4>
<p>There are no ptr-int-ptr roundtrips in here AFAICT</p>



<a name="257944007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257944007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257944007">(Oct 17 2021 at 19:57)</a>:</h4>
<p>yes but if this is allowed I dont see why ptr-int-ptr round trips wouldnt be too</p>



<a name="257944038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257944038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257944038">(Oct 17 2021 at 19:57)</a>:</h4>
<p>the copy_nonoverlapping is doing a byte-by-byte copy I don't get how that could preserve provenance without "integers have provenance" being true which would imply ptr-int-ptr casts being okay</p>



<a name="257945820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257945820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257945820">(Oct 17 2021 at 20:23)</a>:</h4>
<p>I think the model is something like <a href="https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html">What's in a byte?</a></p>



<a name="257945873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/257945873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#257945873">(Oct 17 2021 at 20:24)</a>:</h4>
<p>In this case it doesn't have to be quite as complicated as pointer fragments since you are copying all the bytes of the pointer</p>



<a name="258408034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258408034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258408034">(Oct 20 2021 at 17:23)</a>:</h4>
<blockquote>
<p>Memory is not typed,</p>
</blockquote>
<p>Memory isnt typed, but accesses are... so the question is whether copy_nonoverlapping makes typed copies or untyped copies. I dont think we have a conclusive answer to that question.</p>



<a name="258408253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258408253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258408253">(Oct 20 2021 at 17:24)</a>:</h4>
<p>isnt there a MIR transform that turns <code>copy_nonoverlapping(src, dst, 1)</code> into a MIR assignment? that is only legal if copy_nonoverlapping is doing a typed copy.</p>



<a name="258408609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258408609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258408609">(Oct 20 2021 at 17:26)</a>:</h4>
<p>in this specific case (of both the code and the original code I was looking at before making this example) it's definitely not able to do a "typed" copy, we're doing <code>copy_nonoverlapping</code> of a bunch of u8's with the size set to some stored size</p>



<a name="258408698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258408698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258408698">(Oct 20 2021 at 17:27)</a>:</h4>
<p>idt there would be any way for rust to know what type was stored at the adresses</p>



<a name="258408782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258408782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258408782">(Oct 20 2021 at 17:27)</a>:</h4>
<p>well, that would just mean you are asking it to do a u8-typed-copy. whether that's what you want/need is a different question...</p>



<a name="258409038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258409038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258409038">(Oct 20 2021 at 17:28)</a>:</h4>
<p>well, what I want to know is whether doing a u8-typed-copy preserves provenance of a ptr stored at that address</p>



<a name="258409076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258409076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258409076">(Oct 20 2021 at 17:28)</a>:</h4>
<p>I'm guessing "no" but miri didnt flag it so i wanted to be sure</p>



<a name="258409721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258409721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258409721">(Oct 20 2021 at 17:32)</a>:</h4>
<ul>
<li>if the intrinsic does a typed copy, then no (and the copy might even be UB since these are effectively ptr-to-int transmutes)</li>
<li>if it does an untyped copy, then yes</li>
</ul>



<a name="258409815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258409815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258409815">(Oct 20 2021 at 17:33)</a>:</h4>
<p>which kind of copy the intrinsic does is not currently specified or decided... but I fear a lot of code will break if we decide for typed.</p>



<a name="258410065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258410065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258410065">(Oct 20 2021 at 17:34)</a>:</h4>
<p>so I guess I am hoping there is no MIR pass that would turn a CopyNonoverlapping into an assignment... currently I cannot find a pass doing that^^</p>



<a name="258410385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258410385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258410385">(Oct 20 2021 at 17:36)</a>:</h4>
<p>okay thanks that's a pretty clear answer. yeah the entire of bevy_ecs would be unsound if it's a typed copy :D</p>



<a name="258421121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258421121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258421121">(Oct 20 2021 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance/near/258410065">said</a>:</p>
<blockquote>
<p>so I guess I am hoping there is no MIR pass that would turn a CopyNonoverlapping into an assignment... currently I cannot find a pass doing that^^</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/issues/83785">#83785</a> will lower <code>copy_nonoverlapping</code> into an assignment, but only when the element count is statically known to be 1: <a href="https://github.com/rust-lang/rust/pull/83785/files#diff-8776080e5e11d6974f88b35bc52221ae26a59d91f04affa94ea2be06e0f5388fR63-R66">https://github.com/rust-lang/rust/pull/83785/files#diff-8776080e5e11d6974f88b35bc52221ae26a59d91f04affa94ea2be06e0f5388fR63-R66</a></p>



<a name="258421551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258421551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258421551">(Oct 20 2021 at 18:45)</a>:</h4>
<p>Left a comment on the PR to ensure that we don't forget about this conversation before deciding if it should be merged.</p>



<a name="258500591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258500591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258500591">(Oct 21 2021 at 07:38)</a>:</h4>
<p>I know that C compilers get a lot of value out of optimizations that inline memcpy operations that copy a small amount of memory.</p>



<a name="258500626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258500626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258500626">(Oct 21 2021 at 07:38)</a>:</h4>
<p>But that doesn't have to turn into an assignment.</p>



<a name="258725456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping%20and%20provenance/near/258725456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/copy_nonoverlapping.20and.20provenance.html#258725456">(Oct 22 2021 at 15:10)</a>:</h4>
<p>yeah -- assignment would be allowed to drop padding, which memcpy preserves, so that has to be represented separately</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>