<html>
<head><meta charset="utf-8"><title>Forging *mut w/o usize as *mut T · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html">Forging *mut w/o usize as *mut T</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276125504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276125504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276125504">(Mar 21 2022 at 23:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T/near/276124266">said</a>:</p>
<blockquote>
<p>For MMIO purposes, the assertion that no one else claims that same memory is far too strong. Particularly, any code should, at any time, be able to simply know the address of some particular MMIO thing (as a constant or whatever) and then use it without regard to who else might also use that same MMIO location before or after.</p>
</blockquote>
<p>I dislike that for both Rust and objcap reasons, but &lt;sub&gt;these margins are too small to &lt;sub&gt;advocate for objcap&lt;/sub&gt;&lt;/sub&gt;</p>



<a name="276125517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276125517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276125517">(Mar 21 2022 at 23:10)</a>:</h4>
<p>oh Zulip thou hast failed me</p>



<a name="276125578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276125578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276125578">(Mar 21 2022 at 23:11)</a>:</h4>
<p>I don't even know what "objcap" is</p>



<a name="276125651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276125651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276125651">(Mar 21 2022 at 23:12)</a>:</h4>
<p>there, is that enough of an excuse for you to give your spiel?</p>



<a name="276126025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126025">(Mar 21 2022 at 23:16)</a>:</h4>
<p>not really, since I don't have a spiel. objcap is, roughly speaking, the idea of hermetically isolating (cap)abilities and always requiring derivation, i.e. everything is obtained from something else. windows <code>HANDLE</code> and UNIX fds are sort of the "bare minimum", but the presence of "ambient" APIs limits their approach to full objcap</p>



<a name="276126050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126050">(Mar 21 2022 at 23:16)</a>:</h4>
<p>microkernels are much closer, and seL4 is the "golden standard" in this space</p>



<a name="276126100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126100">(Mar 21 2022 at 23:17)</a>:</h4>
<p>yeah MMIO is basically an entire ambient universe of things you can do out of "nothing" :P</p>



<a name="276126207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126207">(Mar 21 2022 at 23:18)</a>:</h4>
<p>right, so that violates objcap principles. on seL4, a driver (which runs in userspace, mind you) has to get a MMIO block the same way you might, say, <code>mmap</code> a file</p>



<a name="276126238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126238">(Mar 21 2022 at 23:19)</a>:</h4>
<p>it's a "chain of custody", just like Rust does with deriving <code>&amp;mut</code> from <code>&amp;mut</code></p>



<a name="276126255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126255">(Mar 21 2022 at 23:19)</a>:</h4>
<p>objcap applied to hardware resources is very much like <code>split_at_mut</code>, heh</p>



<a name="276126328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126328">(Mar 21 2022 at 23:20)</a>:</h4>
<p>you wouldn't want e.g. two drivers to access the same piece of memory without <em>having somehow both agreed</em> to it</p>



<a name="276126399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126399">(Mar 21 2022 at 23:21)</a>:</h4>
<p>CHERI puts some of those objcap ideas into low-level memory access - you can only "shrink" a CHERI pointer's bounds/permissions</p>



<a name="276126523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126523">(Mar 21 2022 at 23:22)</a>:</h4>
<p>I've relied on the ability to pull some MMIO pointers out of my hat, knowing full-well that something up the call stack is probably doing the same thing,<br>
Albeit my MMIO pointers come from extern <code>static mut</code>s which I <em>hope</em> rustc won't be doing stupid stuff to.</p>



<a name="276126630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126630">(Mar 21 2022 at 23:24)</a>:</h4>
<p>Yeah, I think shoving an MMIO pointer into a <code>static</code> is not a problem regardless of platform.</p>



<a name="276126703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126703">(Mar 21 2022 at 23:24)</a>:</h4>
<p>I mean the MMIO is via a symbol that's pull in by <code>extern{ static mut}</code> and that I <code>addr_of_mut!()</code></p>



<a name="276126720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126720">(Mar 21 2022 at 23:24)</a>:</h4>
<p>close enough.</p>



<a name="276126891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276126891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276126891">(Mar 21 2022 at 23:27)</a>:</h4>
<p>yeah, that should work even on CHERI because whatever is resolving that (e.g. bootloader relocating the kernel ELF), can compute a valid pointer to place there</p>



<a name="276127014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276127014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276127014">(Mar 21 2022 at 23:29)</a>:</h4>
<p>Well, I mean, MMIO is non-portable anyways.</p>



<a name="276127162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276127162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276127162">(Mar 21 2022 at 23:31)</a>:</h4>
<p>lmao I forgot about forging ZSTs being legit (still is, CHERI doesn't care if you make up a pointer and never deref if)</p>



<a name="276127180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276127180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276127180">(Mar 21 2022 at 23:31)</a>:</h4>
<p>gonna add an explicit method for that</p>



<a name="276127185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276127185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276127185">(Mar 21 2022 at 23:31)</a>:</h4>
<p>make up a guy</p>



<a name="276127266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276127266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276127266">(Mar 21 2022 at 23:32)</a>:</h4>
<p>I doubt <code>__counter_enable</code> works well on CHERI.</p>



<a name="276191631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276191631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276191631">(Mar 22 2022 at 13:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T/near/276126523">said</a>:</p>
<blockquote>
<p>I've relied on the ability to pull some MMIO pointers out of my hat, knowing full-well that something up the call stack is probably doing the same thing,<br>
Albeit my MMIO pointers come from extern <code>static mut</code>s which I <em>hope</em> rustc won't be doing stupid stuff to.</p>
</blockquote>
<p>Connor clearly trying to bait eddyb into delivering a screed à la <a href="https://github.com/rust-lang/rust/issues/53639">https://github.com/rust-lang/rust/issues/53639</a> :P</p>



<a name="276200956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276200956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276200956">(Mar 22 2022 at 14:57)</a>:</h4>
<p>Well, see, I used to use <code>VolatileCell</code> instead of <code>static mut</code>, but then I was told that rustc can read my <code>&amp;VolatileCell&lt;T&gt;</code> without telling me, so...</p>



<a name="276201671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276201671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276201671">(Mar 22 2022 at 15:01)</a>:</h4>
<p>I believe the fix for <code>&amp;VolatileCell&lt;T&gt;was is to replace it with a newtype over </code>*T<code> that provides the read/write methods using </code>{read,write}_volatile<code> methods on the pointer itself - AFAICT there's not really any provenance issues from interacting with an </code>extern { static mut }` directly or putting the pointer into such a newtype, all of that should "just work"</p>



<a name="276204777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276204777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276204777">(Mar 22 2022 at 15:19)</a>:</h4>
<p>Sure, but I still need to represent the symbol, hense the <code>extern {static mut}</code></p>



<a name="276207381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276207381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276207381">(Mar 22 2022 at 15:35)</a>:</h4>
<p>If the symbol is only provided via linker that's quite unfortunate for you ;_;</p>



<a name="276208494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276208494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276208494">(Mar 22 2022 at 15:42)</a>:</h4>
<p>Well, yes, I do that instead of casting magic addresses.</p>



<a name="276209231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276209231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276209231">(Mar 22 2022 at 15:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T/near/276207381">said</a>:</p>
<blockquote>
<p>If the symbol is only provided via linker that's quite unfortunate for you ;_;</p>
</blockquote>
<p>it's actually better in some ways because the linker is then the one responsible for coming up with a valid pointer :P</p>



<a name="276209306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276209306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276209306">(Mar 22 2022 at 15:47)</a>:</h4>
<p>(and if you get yourself into an unrepresentable situation by accident, you're more likely to discover it at link time than at runtime)</p>



<a name="276220235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276220235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276220235">(Mar 22 2022 at 16:55)</a>:</h4>
<p>but my lovely lovely const prop. or, more importantly, my lovely lovely register savings</p>



<a name="276220794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276220794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276220794">(Mar 22 2022 at 16:58)</a>:</h4>
<p>Either way, I strongly suggest that you give the &lt;<a href="https://docs.rs/voladdress">https://docs.rs/voladdress</a>&gt; crate a look, and see if you can get it to work with your linker &lt;3</p>



<a name="276273548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276273548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276273548">(Mar 23 2022 at 00:28)</a>:</h4>
<p><a href="https://twitter.com/arichardson___/status/1506427082737340416">https://twitter.com/arichardson___/status/1506427082737340416</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/arichardson___/status/1506427082737340416"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/01d2ec0d00cc478291d0d76be7347c373bcf1834/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313530363032363830303933333232303335342f66315f7450684a4c5f6e6f726d616c2e706e67"></a><p><a href="https://twitter.com/Gankra_">@Gankra_</a> Currently our LLVM emits .gcc_except_table targets as capabilities instead of offsets (<a href="https://t.co/HaIDj0HvFX">https://cheri-compiler-explorer.cl.cam.ac.uk/z/n6GhhW</a>). And in some cases libunwind derives provenance from program header capabilities, using dl_iterate_phdrs (RTLD sets them up to span the DSO).</p><span>- Alex Richardson (@arichardson___)</span></div></div>



<a name="276274103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276274103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276274103">(Mar 23 2022 at 00:32)</a>:</h4>
<p>OH</p>



<a name="276274106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276274106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276274106">(Mar 23 2022 at 00:32)</a>:</h4>
<p><a href="https://cheri-compiler-explorer.cl.cam.ac.uk/z/n6GhhW">https://cheri-compiler-explorer.cl.cam.ac.uk/z/n6GhhW</a></p>



<a name="276274119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276274119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276274119">(Mar 23 2022 at 00:32)</a>:</h4>
<p>They have their own godbolt???</p>



<a name="276274372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276274372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276274372">(Mar 23 2022 at 00:34)</a>:</h4>
<p>niiiice.</p>



<a name="276529476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276529476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276529476">(Mar 24 2022 at 19:42)</a>:</h4>
<blockquote>
<p>0xCAFE as *mut T is still a "noalias" promise in the sense that it must not alias with any pointer returned by an Abstract Machine allocation operation (local variables, statics, heap allocations).</p>
</blockquote>
<p>Huh, I am not sure I understand the distinction, <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="276546541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276546541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276546541">(Mar 24 2022 at 22:15)</a>:</h4>
<p>Isn't it to be able to say this is UB?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Imagine that &amp;x as usize == 0xCAFE</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="mh">0xCAFE</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Obv. just creating the pointer doesn't assert uniqueness since it's a safe operation</p>



<a name="276547650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276547650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276547650">(Mar 24 2022 at 22:28)</a>:</h4>
<p>Basically Ralf is describing a model where casting an integer to a pointer doesn't quite create an <em>invalid</em> pointer but a pointer with a fresh provenance, which is morally equivalent to calling <code>malloc</code> which of course returns a guaranteed-unaliased pointer (from within the language). This is also how I rationalize that "thin-air" ZSTs cannot be invalidated because a "real" allocation they happen to be in the range of got freed.</p>



<a name="276549013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549013">(Mar 24 2022 at 22:46)</a>:</h4>
<p>(For whatever reason my brain likes visualizing this as memory laying in a straight line where unrelated "seemingly" collide all the time, but provenance introduces a second dimension that makes unrelated pointers "obviously" unable to interact)</p>



<a name="276549219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549219">(Mar 24 2022 at 22:48)</a>:</h4>
<p>But anyway the reason I prefer to think of inttoptr casts as producing an invalid pointer by default is that although we can always generate fresh allocation/provenance ids, it is wholy unclear how to generate the <em>range</em> of the provenance. The only sensible default is "empty range" for a unary cast, at which point the pointer is only usable for talking about ZSTs or as a type pun for an integer.</p>



<a name="276549303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549303">(Mar 24 2022 at 22:49)</a>:</h4>
<p>This is why I was messing around with like fake_alloc or whatever as a way to properly specify the <em>range</em> you're claiming a stake on.</p>



<a name="276549518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549518">(Mar 24 2022 at 22:52)</a>:</h4>
<p>you can say "all non-AM memory" and that'll likely do fine for the invented pointer use cases if you aren't trying to do <code>&amp;mut *(0xCAFE as *mut Whatever)</code> (and if you are it only has issues in the way that <code>static mut</code> has issues)</p>



<a name="276549581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549581">(Mar 24 2022 at 22:53)</a>:</h4>
<p>AM?</p>



<a name="276549629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549629">(Mar 24 2022 at 22:53)</a>:</h4>
<p>abstract machine, ie all the heap/stack/etc memory (and re the &amp;mut part, probably "anything being pointed to by a reference")</p>



<a name="276549780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549780">(Mar 24 2022 at 22:55)</a>:</h4>
<p>I don't think that's the only sensible default :3 I think that "the span of the element type" is also a sensible default</p>



<a name="276549814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549814">(Mar 24 2022 at 22:55)</a>:</h4>
<p>I don't think it's the _only_ sensible default, but I think it is _a_ sensible default</p>



<a name="276549817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549817">(Mar 24 2022 at 22:56)</a>:</h4>
<p>that's fair but will probably make you very sad for *mut u8</p>



<a name="276549859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549859">(Mar 24 2022 at 22:56)</a>:</h4>
<p>and unlikely to make you lose for *mut u8, yeah</p>



<a name="276549906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549906">(Mar 24 2022 at 22:57)</a>:</h4>
<p>i mean i guess it wouldn't be the <em>worst</em> reality to require <code>*mut [u8; N]</code> lol</p>



<a name="276549914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276549914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276549914">(Mar 24 2022 at 22:57)</a>:</h4>
<p>like this is more permissive than needed, but the uses are likely either <code>global = &amp;mut *(int as *mut T);</code> or <code>*(int as *mut T) = whatever;</code> (and doing <code>global</code> without &amp;mut should be fine as well)</p>



<a name="276550016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276550016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276550016">(Mar 24 2022 at 22:58)</a>:</h4>
<p>if it is a dynamic span of memory that's just a normal "heap provenance" situation it seems like</p>



<a name="276550086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276550086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276550086">(Mar 24 2022 at 22:59)</a>:</h4>
<p>just with a heap that happens to live in a fixed address you know about because you're the kernel and you get to Know Things</p>



<a name="276550087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276550087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276550087">(Mar 24 2022 at 22:59)</a>:</h4>
<p>like you don't need the compiler to know that <code>0x1000 as *mut X</code> and <code>0x2000 as *mut Y</code> don't alias, because they're generally not being used at the same time and/or are being used via volatile ops that can't be optimized anyways</p>



<a name="276550090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276550090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276550090">(Mar 24 2022 at 22:59)</a>:</h4>
<p>yeah i punted on this usecase because it's very Not My Thing and someone who is into it needs to tackle it in earnest</p>



<a name="276550370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276550370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276550370">(Mar 24 2022 at 23:01)</a>:</h4>
<p>if you do need more alias info you're probably gonna upgrade that pointer to a reference anyway</p>



<a name="276550576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276550576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276550576">(Mar 24 2022 at 23:03)</a>:</h4>
<p>it's also fine to punt on it because after "invented pointers must not alias Abstract Machine pointers" everything else is pretty meh</p>



<a name="276728565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276728565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276728565">(Mar 26 2022 at 14:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T/near/276549219">said</a>:</p>
<blockquote>
<p>But anyway the reason I prefer to think of inttoptr casts as producing an invalid pointer by default is that although we can always generate fresh allocation/provenance ids, it is wholy unclear how to generate the <em>range</em> of the provenance. The only sensible default is "empty range" for a unary cast, at which point the pointer is only usable for talking about ZSTs or as a type pun for an integer.</p>
</blockquote>
<p>I dont think we need to generate a "range" of the provenance.</p>



<a name="276728678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276728678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276728678">(Mar 26 2022 at 14:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T/near/276529476">said</a>:</p>
<blockquote>
<blockquote>
<p>0xCAFE as *mut T is still a "noalias" promise in the sense that it must not alias with any pointer returned by an Abstract Machine allocation operation (local variables, statics, heap allocations).</p>
</blockquote>
<p>Huh, I am not sure I understand the distinction, <span class="user-mention silent" data-user-id="120791">RalfJ</span></p>
</blockquote>
<p>basically, it is totally okay to do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xabc0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>as long as you are <em>sure</em> that this will not overwrite any <code>static</code>, local variable, heap allocation, or any other memory that the Rust Abstract Machine "claims for itself". (and of course the access must not page fault either.)</p>



<a name="276728748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276728748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276728748">(Mar 26 2022 at 14:29)</a>:</h4>
<p>and in this strict model this is true for <em>any</em> pointer obtained via int-to-ptr cast, i.e., including <code>&amp;x as *mut _ as usize as *mut i32</code>. so this breaks ptr-int-ptr roundtrips. but it still permits things embedded platforms need where certain memory regions just happen at fixed addresses.</p>



<a name="276729356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276729356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276729356">(Mar 26 2022 at 14:44)</a>:</h4>
<blockquote>
<p>I dont think we need to generate a "range" of the provenance.</p>
</blockquote>
<p>well it would be very nice if we could for CHERI's sake</p>



<a name="276729450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276729450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276729450">(Mar 26 2022 at 14:47)</a>:</h4>
<p>I agree your interpretation is reasonable and useful though</p>



<a name="276731648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276731648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276731648">(Mar 26 2022 at 15:41)</a>:</h4>
<p>ah yes I keep forgetting CHERI. but the usecase here for people like <span class="user-mention" data-user-id="224471">@Lokathor</span> is typically very platform-specific, so presumably having CHERI bail on that would not be a problem</p>



<a name="276731829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276731829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276731829">(Mar 26 2022 at 15:45)</a>:</h4>
<p>I still think it would be more helpful to have a function that expresses "hello yes i am doing this" for the purposes of hanging docs off of it and either making it a compile time error in targets/configs that don't make sense (maximally strict userland CHERI) or make it do "the thing it must do" on targets where it needs to be more clever (use it as an offset off of the global "all of the process/all of the address space" capability that a non-strict process/kernel has)</p>



<a name="276731907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276731907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276731907">(Mar 26 2022 at 15:47)</a>:</h4>
<p>I agree making it explicit is a lot better than <code>as</code></p>



<a name="276731916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276731916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276731916">(Mar 26 2022 at 15:47)</a>:</h4>
<p>I just want to make sure we don't have a crowd with pitchforks that thinks we are taking their crazy embedded things away ;)</p>



<a name="276732205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732205">(Mar 26 2022 at 15:53)</a>:</h4>
<p>some function like <code>foreign_ptr(usize)-&gt;*mut T</code> would certainly be appropriate</p>



<a name="276732258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732258">(Mar 26 2022 at 15:54)</a>:</h4>
<p>well Gankra is saying it should be <code>make_alloc_at_fixed_addr(addr: usize, size: usize)</code></p>



<a name="276732270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732270">(Mar 26 2022 at 15:54)</a>:</h4>
<p>i.e., also be explicit about how big that memory region is (so CHERI or whatever can do its magic on that)</p>



<a name="276732299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732299">(Mar 26 2022 at 15:55)</a>:</h4>
<p>that's fine, but also very clumsy for single elements, though that can be fixed with some sort of wrapper function i suppose.</p>



<a name="276732349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732349">(Mar 26 2022 at 15:56)</a>:</h4>
<p>BTW, I have in some cases needed specifically an <code>as</code> cast, since I was in code that cannot have a function call in the assembly (lest my code could possibly become recursive), and I don't necessarily want to rely on <code>$RUSTC</code>doing "the right thing" and inlining the code.</p>



<a name="276732365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732365">(Mar 26 2022 at 15:56)</a>:</h4>
<p>these functions can be Officially Intrinsics which addresses that, right</p>



<a name="276732376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732376">(Mar 26 2022 at 15:57)</a>:</h4>
<p>Actually that doesn't address it :(</p>



<a name="276732379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732379">(Mar 26 2022 at 15:57)</a>:</h4>
<p>Perhaps.</p>



<a name="276732390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732390">(Mar 26 2022 at 15:57)</a>:</h4>
<p>An intrinsic doesn't <em>necessarily</em> prevent a function call from happening</p>



<a name="276732430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732430">(Mar 26 2022 at 15:58)</a>:</h4>
<p>i guess you could make it part of the spec</p>



<a name="276732474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732474">(Mar 26 2022 at 15:59)</a>:</h4>
<p>well i don't think anything in the reference or whatever says <code>foo as usize</code> has a specific impl you can rely on, so an intrinsic is just as solid footing for that?</p>



<a name="276732554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732554">(Mar 26 2022 at 16:00)</a>:</h4>
<p>true enough</p>



<a name="276732589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732589">(Mar 26 2022 at 16:00)</a>:</h4>
<p>Fair. I find it less likely that an intrinsic operation gets replaced with a function call, then if an implementation simply doesn't inline (despite <code>#[inline(always)]</code> which, albeit strong, is merely still a hint).</p>



<a name="276732669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732669">(Mar 26 2022 at 16:02)</a>:</h4>
<p>yeah, if rustc agrees that <em>it</em> will inline and cut out llvm from the process that would be fine</p>



<a name="276732701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732701">(Mar 26 2022 at 16:03)</a>:</h4>
<p>I'm not just using rustc, though (and, in some cases, inlining is in fact impossible).</p>



<a name="276732760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732760">(Mar 26 2022 at 16:04)</a>:</h4>
<p>could you give an example of when it's impossible</p>



<a name="276732794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732794">(Mar 26 2022 at 16:05)</a>:</h4>
<p>recursion is a classic case</p>



<a name="276732802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732802">(Mar 26 2022 at 16:05)</a>:</h4>
<p>Incompatible target features is one.<br>
lccc's inliner will refuse to inline when the operand stack depths in the callee or caller exceed a certain limit, or when the combined stack depth exceeds a hard limit of 2^16 (since such stack depths are not required to be supported, and some operations can't reach beyond this limit whatsoever).</p>



<a name="276732940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732940">(Mar 26 2022 at 16:08)</a>:</h4>
<p>sorry i didn't mean when inline is impossible in general, i meant specifically for the pointer cast intrinsic only</p>



<a name="276732975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276732975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276732975">(Mar 26 2022 at 16:09)</a>:</h4>
<p>If it's implemented as an intrinsic, then it probably will be effectively inlined.<br>
Of course, if it's wrapped at all, any of the no-inline cases could be hit, and the function just doesn't inline.</p>



<a name="276733057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276733057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276733057">(Mar 26 2022 at 16:11)</a>:</h4>
<p>basically if you are Writing Your Own Compiler and it's an intrinsic you get to Make Sure It Works :)</p>



<a name="276733160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276733160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276733160">(Mar 26 2022 at 16:13)</a>:</h4>
<p>yeah, as you say, <code>foo as bar</code> might actually also be a function call too, but then the pitchforks show up</p>



<a name="276735105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276735105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dante Broggi <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276735105">(Mar 26 2022 at 16:58)</a>:</h4>
<p>For primitive inlining Swift has (for stdlib use only) <a href="https://github.com/apple/swift/blob/main/docs/TransparentAttr.md"><code>@_transparent</code></a> on functions, which includes the effect "inline this first, before diagnostics, even at optimization level 0"</p>



<a name="276735170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276735170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276735170">(Mar 26 2022 at 16:59)</a>:</h4>
<p>Having an allocation size would be useful for CHERI so we could generate the bounds restriction instruction. In the OS kernel usecase, you have to keep around a capability spanning your MMIO regions somewhere, so we would almost certainly have to change that code to derive from the correct capability (also to get the desired read/write/executr/etc. Permissions). Forcing use of an explicit API would make it much easiert to audit those cases and if needed replace them with target-specific code.</p>



<a name="276793719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%2Amut%20w/o%20usize%20as%20%2Amut%20T/near/276793719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T.html#276793719">(Mar 27 2022 at 15:31)</a>:</h4>
<p><code>foo as T</code> can and does already codegen to a function call in some cases (e.g. conversions between 128 bit integers and floats)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>