<html>
<head><meta charset="utf-8"><title>Questions about extending strict prov. to AtomicPtr · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html">Questions about extending strict prov. to AtomicPtr</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277343480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277343480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277343480">(Mar 31 2022 at 21:37)</a>:</h4>
<p>Currently, the unstable strict_provenance API can express almost everything except for AtomicPtr ops. This is <a href="https://github.com/rust-lang/rust/issues/95492">https://github.com/rust-lang/rust/issues/95492</a>. I'd like to implement this (and have time to take a stab this weekend), because I have code that does int-&gt;ptr-&gt;int for atomics, and feel it might be a useful data-point. I also think answering these questions will help prove out the model in different ways.</p>
<p>However, I think the API is not as trivial as just copying the design of AtomicUsize and supergluing it onto the pointer. In particular, I've raised three questions in my comment on the issue about it. I've reproduced them here for the lazy.</p>
<ol>
<li>
<p>What should the argument type to <code>AtomicPtr::&lt;T&gt;::fetch_and(&amp;self, arg: ???) -&gt; *mut T</code> be?</p>
<p>Is there a way to make this work as a bit-clear operation? Note that this is required for many uses (one from inside <code>parking_lot_core</code> is linked).</p>
</li>
<li>
<p>I can think of uses for <code>fetch_and</code>, <code>fetch_or</code>, and <code>fetch_xor</code> (the latter sounds cursed but is useful for doing an atomic bitflip), but what about <code>fetch_nand</code>, <code>fetch_max</code>, and <code>fetch_min</code>. Are these coherent?</p>
</li>
<li>
<p>What should the units be for <code>fetch_wrapping_{add,sub,offset}</code>? I think bytes are clearly the most useful and general (especially given that you cannot turn <code>&amp;AtomicPtr&lt;T&gt;</code> into <code>&amp;AtomicPtr&lt;u8&gt;</code> easily), but this is unsymmetric with the APIs in <code>core::ptr</code></p>
</li>
</ol>
<p>Thoughts?</p>



<a name="277343944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277343944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277343944">(Mar 31 2022 at 21:42)</a>:</h4>
<p>For 3. you can easily tranamute. I think we should also get a safe cast() operation like there is on raw pointers.</p>



<a name="277344000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344000">(Mar 31 2022 at 21:43)</a>:</h4>
<p>Yeah, that seems reasonable.</p>



<a name="277344128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344128">(Mar 31 2022 at 21:45)</a>:</h4>
<p>I guess I'll answer 3 by "units of T" and do a separate PR to add <code>AtomicPtr::&lt;T&gt;::cast::&lt;U&gt;</code>. It's only really useful in the context of those functions, but isnt really related to the rest.</p>



<a name="277344133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344133">(Mar 31 2022 at 21:45)</a>:</h4>
<p>I think the arguments for <code>fetch_op</code> should all be usize</p>



<a name="277344138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344138">(Mar 31 2022 at 21:45)</a>:</h4>
<p>Hmm</p>



<a name="277344149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344149">(Mar 31 2022 at 21:45)</a>:</h4>
<p>these are all operations of the form <code>new_ptr = old_ptr OP x</code></p>



<a name="277344172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344172">(Mar 31 2022 at 21:45)</a>:</h4>
<p>I suppose that's reasonable.</p>



<a name="277344174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344174">(Mar 31 2022 at 21:45)</a>:</h4>
<p>what is the provenance of <code>new_ptr</code>?</p>



<a name="277344226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344226">(Mar 31 2022 at 21:46)</a>:</h4>
<p>the only unambiguous option is to say, the one of <code>old_ptr</code>, and <code>x</code> can't have any</p>



<a name="277344233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344233">(Mar 31 2022 at 21:46)</a>:</h4>
<p>I was thinking the old ptr might be ptr::invalid(1) and you might want to fetch_or in the new poitner or something</p>



<a name="277344242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344242">(Mar 31 2022 at 21:46)</a>:</h4>
<p>I see.</p>



<a name="277344246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344246">(Mar 31 2022 at 21:46)</a>:</h4>
<p>then you need two operations though</p>



<a name="277344250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344250">(Mar 31 2022 at 21:46)</a>:</h4>
<p>But realistically</p>



<a name="277344254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344254">(Mar 31 2022 at 21:46)</a>:</h4>
<p>one that uses provenacne-from-the-left</p>



<a name="277344256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344256">(Mar 31 2022 at 21:46)</a>:</h4>
<p>I can't imagine that being done without a cas</p>



<a name="277344257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344257">(Mar 31 2022 at 21:46)</a>:</h4>
<p>and one that uses provenance-from-the-right</p>



<a name="277344258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344258">(Mar 31 2022 at 21:46)</a>:</h4>
<p>yeah i see</p>



<a name="277344264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344264">(Mar 31 2022 at 21:46)</a>:</h4>
<p>Okay, so it would be usize</p>



<a name="277344286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344286">(Mar 31 2022 at 21:47)</a>:</h4>
<p>Thats 2/3 questions down then</p>



<a name="277344318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344318">(Mar 31 2022 at 21:47)</a>:</h4>
<p>The last question would be if those operations are coherent, I think I'll stand by "no" just to be conservative for now.</p>



<a name="277344320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344320">(Mar 31 2022 at 21:47)</a>:</h4>
<p>for 2, I mean all operations are 'coherent': <code>new_ptr = old_ptr.map_addr(|a| a OP x)</code></p>



<a name="277344324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344324">(Mar 31 2022 at 21:47)</a>:</h4>
<p>well</p>



<a name="277344328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344328">(Mar 31 2022 at 21:47)</a>:</h4>
<p>hmm</p>



<a name="277344331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344331">(Mar 31 2022 at 21:47)</a>:</h4>
<p>so it would only apply to the addr?</p>



<a name="277344334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344334">(Mar 31 2022 at 21:47)</a>:</h4>
<p>so everything AtomivUsize has, AtomicPtr can have</p>



<a name="277344345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344345">(Mar 31 2022 at 21:47)</a>:</h4>
<p>okay</p>



<a name="277344372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344372">(Mar 31 2022 at 21:48)</a>:</h4>
<p>that's all three then</p>



<a name="277344406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344406">(Mar 31 2022 at 21:48)</a>:</h4>
<p>whether that actually makes any sense I cannot tell you</p>



<a name="277344446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344446">(Mar 31 2022 at 21:48)</a>:</h4>
<p>but any <code>(usize, usize) → usize</code> is easily lifted to <code>(ptr, usize) → ptr</code> <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="277344470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344470">(Mar 31 2022 at 21:48)</a>:</h4>
<p>I dont know, but it would be a shame for someone to resort to AtomicUsize because of this. That said they'll get yeeted from the patch if I hit snags with LLVM for whatever reason</p>



<a name="277344489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344489">(Mar 31 2022 at 21:49)</a>:</h4>
<p>yeah LLVM might not like any of this</p>



<a name="277344543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344543">(Mar 31 2022 at 21:49)</a>:</h4>
<p>Well, I know how to add intrinsics more or less, so I can futz a bit with that</p>



<a name="277344552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344552">(Mar 31 2022 at 21:49)</a>:</h4>
<p>But when I poked at it before it didnt seem needed</p>



<a name="277344655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344655">(Mar 31 2022 at 21:50)</a>:</h4>
<p>I'm also willing to do crimes to make it work for now.</p>



<a name="277344666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344666">(Mar 31 2022 at 21:50)</a>:</h4>
<p>but dont expect to need to</p>



<a name="277344688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344688">(Mar 31 2022 at 21:51)</a>:</h4>
<p>Oh, I think 1b isn't answered.</p>



<a name="277344701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344701">(Mar 31 2022 at 21:51)</a>:</h4>
<p>So do all of these get compiled to a CAS? I assume hardware has support for at least some of these. Maybe the right metric is "we should add the dedicated function if we expect it to be faster than implementing the same thing via <code>.atomic_map_addr()</code>"</p>



<a name="277344704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344704">(Mar 31 2022 at 21:51)</a>:</h4>
<p>parking_lot wants to use <code>fetch_and</code> to clear a bit</p>



<a name="277344744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344744">(Mar 31 2022 at 21:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277344701">said</a>:</p>
<blockquote>
<p>So do all of these get compiled to a CAS? I assume hardware has support for at least some of these. Maybe the right metric is "we should add the dedicated function if we expect it to be faster than implementing the same thing via <code>.atomic_map_addr()</code>"</p>
</blockquote>
<p>Depends on the hardware. hardware exists that has all of these as starvation-free atomic ops (e.g. not cas loops)</p>



<a name="277344863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344863">(Mar 31 2022 at 21:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277344704">said</a>:</p>
<blockquote>
<p>parking_lot wants to use <code>fetch_and</code> to clear a bit</p>
</blockquote>
<p>E.g. it does <code>p.fetch_and(!LOCKED_BIT)</code> or something. But if ptr size &gt; usize size, then this would clear the top bits</p>



<a name="277344886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344886">(Mar 31 2022 at 21:53)</a>:</h4>
<p>e.g. cheri's special provenance stuff</p>



<a name="277344945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277344945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277344945">(Mar 31 2022 at 21:53)</a>:</h4>
<p>Actually, now that I've said it... is <code>atomic_map_addr</code> something we might want to add, gated both on this feature and on <code>#![feature(strict_provenance)]</code>?</p>



<a name="277345021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277345021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277345021">(Mar 31 2022 at 21:54)</a>:</h4>
<p>I guess but it would just be sugar for fetch_update + with_addr</p>



<a name="277345027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277345027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277345027">(Mar 31 2022 at 21:54)</a>:</h4>
<p>I don't really care about that</p>



<a name="277345344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277345344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277345344">(Mar 31 2022 at 21:57)</a>:</h4>
<p>Hmm, I guess that the bitclear operation isn't needed if these are all defined to only operate on the addr.</p>



<a name="277346830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277346830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277346830">(Mar 31 2022 at 22:11)</a>:</h4>
<p>I think this is resolved. I guess I'll mark it as such for now.</p>



<a name="277346833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277346833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277346833">(Mar 31 2022 at 22:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> has marked this topic as resolved.</p>



<a name="277348359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348359">(Mar 31 2022 at 22:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.E2.9C.94.20Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277344688">said</a>:</p>
<blockquote>
<p>Oh, I think 1b isn't answered.</p>
</blockquote>
<p>I dont know what a bit-clear operation is^^</p>



<a name="277348403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348403">(Mar 31 2022 at 22:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.E2.9C.94.20Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277344945">said</a>:</p>
<blockquote>
<p>Actually, now that I've said it... is <code>atomic_map_addr</code> something we might want to add, gated both on this feature and on <code>#![feature(strict_provenance)]</code>?</p>
</blockquote>
<p>how'd that work? it has to be <em>atomic</em></p>



<a name="277348451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348451">(Mar 31 2022 at 22:28)</a>:</h4>
<p>you can't just atomically execute an arbitrary <code>usize → usize</code> closure^^</p>



<a name="277348470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348470">(Mar 31 2022 at 22:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> has marked this topic as unresolved.</p>



<a name="277348492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348492">(Mar 31 2022 at 22:29)</a>:</h4>
<p>bit-clear is <code>a &amp; !b</code>. e.g. parking_lot wants to do <code>a.fetch_and(!LOCKED_BIT)</code> or something, to clear the locked bit</p>



<a name="277348511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348511">(Mar 31 2022 at 22:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277348403">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.E2.9C.94.20Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277344945">said</a>:</p>
<blockquote>
<p>Actually, now that I've said it... is <code>atomic_map_addr</code> something we might want to add, gated both on this feature and on <code>#![feature(strict_provenance)]</code>?</p>
</blockquote>
<p>how'd that work? it has to be <em>atomic</em></p>
</blockquote>
<p>CAS loop</p>



<a name="277348527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348527">(Mar 31 2022 at 22:29)</a>:</h4>
<p>yeah but that kinda sucks. maybe someone can add that on top of `fetch_update if they care</p>



<a name="277348541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348541">(Mar 31 2022 at 22:29)</a>:</h4>
<p>personally i do not</p>



<a name="277348617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348617">(Mar 31 2022 at 22:30)</a>:</h4>
<p>Yeah, I'm not that hung up on it to be clear, I was just thinking about it in the spirit of "APIs we can add to stop people from doing non-strict provenance stuff"</p>



<a name="277348626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348626">(Mar 31 2022 at 22:30)</a>:</h4>
<p>i actually think this one might cause more confusion</p>



<a name="277348629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348629">(Mar 31 2022 at 22:30)</a>:</h4>
<p>but about the atomicness</p>



<a name="277348635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348635">(Mar 31 2022 at 22:30)</a>:</h4>
<p>like there's good reasons to do <code>fetch_and</code> over <code>fetch_update(|a| Some(a &amp; b)).unwrap()</code></p>



<a name="277348689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348689">(Mar 31 2022 at 22:31)</a>:</h4>
<p>specifically it's much more likely to be implemented in a starvation-free manner</p>



<a name="277348793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348793">(Mar 31 2022 at 22:32)</a>:</h4>
<p>i think atomic_map_addr would just confuse people into thinking the other parts aren't provenance aware</p>



<a name="277348938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277348938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277348938">(Mar 31 2022 at 22:34)</a>:</h4>
<p>Yeah, that's fair</p>



<a name="277351521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277351521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277351521">(Mar 31 2022 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277348492">said</a>:</p>
<blockquote>
<p>bit-clear is <code>a &amp; !b</code>. e.g. parking_lot wants to do <code>a.fetch_and(!LOCKED_BIT)</code> or something, to clear the locked bit</p>
</blockquote>
<p>oh so its just another operation? sure, why would that one be special?</p>



<a name="277352156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352156">(Mar 31 2022 at 23:11)</a>:</h4>
<p>it's unclear if it needs to be another operation or if we can just get by with fetch_and</p>



<a name="277352193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352193">(Mar 31 2022 at 23:11)</a>:</h4>
<p>e.g. if <code>usize</code> is smaller then a pointer, then <code>fetch_and(!LOCKED_BIT)</code> would clear parts of the pointers bits</p>



<a name="277352204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352204">(Mar 31 2022 at 23:11)</a>:</h4>
<p>in addition to clearing LOCKED_BIT</p>



<a name="277352213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352213">(Mar 31 2022 at 23:11)</a>:</h4>
<p>right?</p>



<a name="277352275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352275">(Mar 31 2022 at 23:12)</a>:</h4>
<p>oh you are thinking of CHERI?</p>



<a name="277352282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352282">(Mar 31 2022 at 23:12)</a>:</h4>
<p>I can't help with that I am afraid...</p>



<a name="277352306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277352306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277352306">(Mar 31 2022 at 23:12)</a>:</h4>
<p>hmm.</p>



<a name="277354564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277354564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277354564">(Mar 31 2022 at 23:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277352275">said</a>:</p>
<blockquote>
<p>oh you are thinking of CHERI?</p>
</blockquote>
<p>a little, since its a motivating concern of the strict provenance work. but cheri's pointer atomics all work on a pointer-sized type.</p>



<a name="277354616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277354616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277354616">(Mar 31 2022 at 23:46)</a>:</h4>
<p>(and ofc we need to avoid mixed-size access)</p>



<a name="277354634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277354634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277354634">(Mar 31 2022 at 23:46)</a>:</h4>
<p>so the usizes need to be widened, but that changes what happens for some of them</p>



<a name="277358721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277358721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277358721">(Apr 01 2022 at 00:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277354564">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277352275">said</a>:</p>
<blockquote>
<p>oh you are thinking of CHERI?</p>
</blockquote>
<p>a little, since its a motivating concern of the strict provenance work. but cheri's pointer atomics all work on a pointer-sized type.</p>
</blockquote>
<p>hm that seems to contradict what was said in the issue though?</p>



<a name="277358850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277358850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277358850">(Apr 01 2022 at 00:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277354634">said</a>:</p>
<blockquote>
<p>so the usizes need to be widened, but that changes what happens for some of them</p>
</blockquote>
<p>ah okay, I see why min/max sound bad^^</p>



<a name="277358855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277358855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277358855">(Apr 01 2022 at 00:55)</a>:</h4>
<p>but for bit-and and bit-or there are neutral elements one could widen it to</p>



<a name="277382427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277382427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277382427">(Apr 01 2022 at 08:07)</a>:</h4>
<p>From <a href="https://github.com/rust-lang/rust/issues/95492#issuecomment-1085283380">https://github.com/rust-lang/rust/issues/95492#issuecomment-1085283380</a> it seems that on CHERI there are addr-only atomic operations, so you don't need to widen anything?</p>



<a name="277388327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277388327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277388327">(Apr 01 2022 at 09:05)</a>:</h4>
<p>For CHERI all the RMW atomics only operate on the address part of the pointer. Only (compare-and-)swap updates the full 129 bits</p>



<a name="277391400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277391400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277391400">(Apr 01 2022 at 09:35)</a>:</h4>
<p>RMW atomics would have to update the provenance too, right? Otherwise you could forge arbitrary pointers with valid provenance by using an atomic add on a pointer with a provenance allowing access to a non-zero sized memory region.</p>



<a name="277413543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277413543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277413543">(Apr 01 2022 at 13:00)</a>:</h4>
<p>if it's just <code>ptr.map_addr(|p| p + n)</code> I don't see how you can forge anything. You get the same provenance as the original value, and hence the RMW doesn't even need to touch the capability bits</p>



<a name="277413831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277413831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277413831">(Apr 01 2022 at 13:02)</a>:</h4>
<p>if you have a pointer with a capability covering 1 byte, then an atomic add on it will almost certainly make it no longer usable</p>



<a name="277418987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277418987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277418987">(Apr 01 2022 at 13:38)</a>:</h4>
<p>map_addr needs to change the capibility bits to reflected changed address, right?</p>



<a name="277420212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277420212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277420212">(Apr 01 2022 at 13:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277418987">said</a>:</p>
<blockquote>
<p>map_addr needs to change the capibility bits to reflected changed address, right?</p>
</blockquote>
<p>I guess that depends on how the capability bits are encoded, i.e. whether they are 'relative' to the address part of the pointer</p>



<a name="277433180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277433180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277433180">(Apr 01 2022 at 15:14)</a>:</h4>
<p>"kinda"</p>



<a name="277438730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277438730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277438730">(Apr 01 2022 at 15:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277420212">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr/near/277418987">said</a>:</p>
<blockquote>
<p>map_addr needs to change the capibility bits to reflected changed address, right?</p>
</blockquote>
<p>I guess that depends on how the capability bits are encoded, i.e. whether they are 'relative' to the address part of the pointer</p>
</blockquote>
<p>For far more than you probably want to know about capability encoding see our CHERI Concentrate paper <a href="https://www.cl.cam.ac.uk/research/security/ctsrd/pdfs/2019tc-cheri-concentrate.pdf">https://www.cl.cam.ac.uk/research/security/ctsrd/pdfs/2019tc-cheri-concentrate.pdf</a></p>



<a name="277439326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277439326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277439326">(Apr 01 2022 at 15:56)</a>:</h4>
<p>The TL;DR is that bounds are encoded relative to the address. If the address goes too far out of bounds the tag is cleared as you have a capability-shaped bag of bits that you can't dereference or jump to.</p>



<a name="277440474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277440474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277440474">(Apr 01 2022 at 16:04)</a>:</h4>
<p>Thanks for pointing me to that paper!</p>



<a name="277440633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277440633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277440633">(Apr 01 2022 at 16:05)</a>:</h4>
<p>It's worth noting that Morello made some slightly different choices (e.g., more bits for bounds), but fundamentally they follow the model (and found bugs in the paper while implementing)</p>



<a name="277440863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277440863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277440863">(Apr 01 2022 at 16:06)</a>:</h4>
<blockquote>
<p>(and found bugs in the paper while implementing)</p>
</blockquote>
<p>Like what?</p>



<a name="277441872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277441872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277441872">(Apr 01 2022 at 16:13)</a>:</h4>
<p>IIRC small errors in the math in some edge cases.</p>



<a name="277459370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277459370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277459370">(Apr 01 2022 at 18:19)</a>:</h4>
<p>but if the bounds are relative that means the atomic ops need to also adjust the bounds when the address is masked?</p>



<a name="277460650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277460650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277460650">(Apr 01 2022 at 18:28)</a>:</h4>
<p>The hardware has to ensure that the validity bit is cleared if the change in address is large enough to change the interpretation of the bounds. The other metadata bits remain unchanged</p>



<a name="277492177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492177">(Apr 01 2022 at 23:57)</a>:</h4>
<p>okay sounds cool :)</p>



<a name="277492188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492188">(Apr 01 2022 at 23:57)</a>:</h4>
<p>then I guess the next question is how to express that with LLVM intrinsics? not sure how far <span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span> got here</p>



<a name="277492256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492256">(Apr 01 2022 at 23:58)</a>:</h4>
<p>I haven't started yet, but when I poked around with it before, it <em>seemed</em> to just work. That said, if I need to do some hacks in LLVM-IR I'm not bothered by that</p>



<a name="277492456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492456">(Apr 02 2022 at 00:00)</a>:</h4>
<p>(well, I have my limits for how much I'll work to make this happen, if it's gonna take too long I'll just comment about why it's a mess and link to an unfinished branch or something)</p>



<a name="277492502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492502">(Apr 02 2022 at 00:01)</a>:</h4>
<p>But my hope is that as it's unstable, it can be imperfect and just good enough to experiment with</p>



<a name="277492565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492565">(Apr 02 2022 at 00:02)</a>:</h4>
<p>That said the proposed API is different now, since most things will probably just take usize/isize and be defined only to operate on the address.</p>



<a name="277492573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/277492573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#277492573">(Apr 02 2022 at 00:02)</a>:</h4>
<p>e.g. the outcome of the discussion from earlier in this thread.</p>



<a name="278054752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278054752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278054752">(Apr 06 2022 at 17:01)</a>:</h4>
<p>Actually parking_lot uses <code>fetch_sub</code> to clear a bit since that optimizes better on x86 (x86 has atomic add/sub but needs a cmpxchg loop for and/or/xor). I did that for <code>WordLock::unlock</code> but forgot to do it when releasing the queue lock.</p>



<a name="278067624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278067624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278067624">(Apr 06 2022 at 18:37)</a>:</h4>
<p>conceptually fetch_add and fetch_sub on AtomicPtr make a lot more sense than the bitwise ops anyway -- they correspond wrapping_offset, basically, whereas we dont even have the bitops for non-atomic pointers</p>



<a name="278068147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278068147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278068147">(Apr 06 2022 at 18:41)</a>:</h4>
<p>Not in this case though: we're not using <code>fetch_sub</code> to subtract a multiple of the size of the pointed type. We're using it to clear a tag bit in the low (alignment) bits of the pointer value.</p>



<a name="278070065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278070065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278070065">(Apr 06 2022 at 18:57)</a>:</h4>
<p>yeah but that's still just like <code>wrapping_offset</code>?</p>



<a name="278070355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278070355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278070355">(Apr 06 2022 at 18:59)</a>:</h4>
<p>No, <code>wrapping_offset</code> still multiplies the offset by <code>size_of::&lt;T&gt;</code>. I want to clear a tag bit (bit 0) when <code>T</code> is a large struct with an alignment of at least 4.</p>



<a name="278073407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278073407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278073407">(Apr 06 2022 at 19:23)</a>:</h4>
<p>ah sorry yes I was thinking of <code>wrapping_offset_bytes</code></p>



<a name="278073729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions%20about%20extending%20strict%20prov.%20to%20AtomicPtr/near/278073729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Questions.20about.20extending.20strict.20prov.2E.20to.20AtomicPtr.html#278073729">(Apr 06 2022 at 19:26)</a>:</h4>
<p>Yes that would work.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>