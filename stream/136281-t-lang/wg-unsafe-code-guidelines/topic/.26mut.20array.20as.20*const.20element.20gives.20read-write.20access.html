<html>
<head><meta charset="utf-8"><title>&amp;mut array as *const element gives read-write access · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html">&amp;mut array as *const element gives read-write access</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269283172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269283172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269283172">(Jan 25 2022 at 16:33)</a>:</h4>
<p>I was exploring the array-pointer cast, and noted something interesting.<br>
It is currently not possible to directly cast <code>&amp;mut [T;N] as *const T</code>, as is the same with <code>&amp;mut T as *const T</code>. However, both casts are valid because of an implicit conversion. In the latter case, this is an implicit reborrow as shared, which denies write access to the value. However, the former contains a reborrow as raw mut, which does not.<br>
See: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=61f1899effe5bc5b5e244dfcb0366835">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=61f1899effe5bc5b5e244dfcb0366835</a> (array case) vs. <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=d27c7e9218693952aa104db6e1cf9412">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=d27c7e9218693952aa104db6e1cf9412</a> (non-array) case.</p>
<p>This seems odd, if not a potential footgun. It may be useful to clarify which of these behaviours is the correct one for both: does it reborrow as <code>*mut T</code> preserving write access, or does it reborrow as <code>&amp;T</code> denying it.</p>



<a name="269467207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269467207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269467207">(Jan 26 2022 at 19:24)</a>:</h4>
<p>oh interesting... I guess this is some quirk in how the MIR is generated</p>



<a name="269467451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269467451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269467451">(Jan 26 2022 at 19:25)</a>:</h4>
<p>the array version does</p>
<div class="codehilite"><pre><span></span><code>        _4 = &amp;mut _5;                    // scope 1 at src/main.rs:3:29: 3:40
        _3 = &amp;raw mut (*_4);             // scope 1 at src/main.rs:3:29: 3:40
</code></pre></div>
<p>while the other one does</p>
<div class="codehilite"><pre><span></span><code>       _3 = &amp;mut _4;                    // scope 1 at src/main.rs:3:29: 3:38
        _2 = &amp;raw const (*_3);           // scope 1 at src/main.rs:3:29: 3:38
</code></pre></div>
<p>I am not a MIR building expert (I mostly take MIR as given and then do my best to define a precise semantics starting there), so... no idea why this happens, but indeed this should probably be changed one way or the other^^</p>



<a name="269504480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269504480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> spunit262 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269504480">(Jan 27 2022 at 00:28)</a>:</h4>
<p>Simply because it's the only non-coercion cast allowed on references, so it handled by different code.</p>
<p>The exact function is <code>check_ref_cast</code> in rustc_typeck/src/check/cast.rs</p>



<a name="269504938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269504938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269504938">(Jan 27 2022 at 00:33)</a>:</h4>
<p>Sounds like a fun thing for me to codegen. TBH, it seems easier to just derive into equivalent of <code>*const</code> from my perspective, then to do any sort of fancy tricks that makes either of them UB (I may get to handle that <em>soon</em> even).</p>



<a name="269510077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269510077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269510077">(Jan 27 2022 at 00:41)</a>:</h4>
<p>Don't they both result in different, disjoint sets of UB? You can't write through one but you can alias the other one</p>



<a name="269510193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%26mut%20array%20as%20%2Aconst%20element%20gives%20read-write%20access/near/269510193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.26mut.20array.20as.20*const.20element.20gives.20read-write.20access.html#269510193">(Jan 27 2022 at 00:42)</a>:</h4>
<p>you can alias <code>*mut</code> pointers</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>