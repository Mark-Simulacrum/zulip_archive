<html>
<head><meta charset="utf-8"><title>Optimizations that exploit strict provenance ¬∑ t-lang/wg-unsafe-code-guidelines ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html">Optimizations that exploit strict provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277492153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277492153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277492153">(Apr 01 2022 at 23:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277491603">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277491212">said</a>:</p>
<blockquote>
<p>I don't know if this is possible, but it'd be lovely if we had carrots and not just sticks here -- i.e. if there were some new MIR optimization where we could say "you only get this if you start using strict provenance"</p>
</blockquote>
<p>Yeah, I've brought this up, and definitely agree. I'm slowly working towards that goal, but there are a lot of things that need to be done before MIR opts can be at that point</p>
</blockquote>
<p>imagine all that work was done. what would even <em>be</em> an optimization that is only correct under strict provenance, but not under permissive provenance? we dont have an example of that yet I think.</p>



<a name="277492589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277492589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277492589">(Apr 02 2022 at 00:02)</a>:</h4>
<p>isn't that hard when we don't yet know exactly what the permissive provenance model is?</p>



<a name="277492750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277492750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277492750">(Apr 02 2022 at 00:05)</a>:</h4>
<p>I don't either, but this is also not quite how I'm thinking about it. The question that I'm asking is closer to "what is a strategy for doing analysis that is only correct under the strict moderl" - of course, this depends in a pretty important way on the particular implementation of the analysis.</p>
<p>In other words, even if it turns out there are no particular optimizations that are <em>illegal</em> permissive provenance, I still think that determining that they are only hard to implement is a comparably important datapoint. I don't have great intuition around this - I'd have to go write some actual code</p>



<a name="277493031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277493031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277493031">(Apr 02 2022 at 00:09)</a>:</h4>
<p>if we know that int2ptr returns a pointer that never has provenance, then you have a lot more information about the return value, which in turn could mean that existing optimizations can be used more often</p>



<a name="277493370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277493370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277493370">(Apr 02 2022 at 00:15)</a>:</h4>
<p>Well, yes, but that's sort of misleading. Presumably, people are doing int2ptr casts with the intention of dereferencing them, and so they would replace the cast with non-UB code in a strict provenance model</p>



<a name="277493380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277493380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277493380">(Apr 02 2022 at 00:15)</a>:</h4>
<p>So the real question we have to ask is whether the weak provenance int2ptr is harder to optimize than the equivalent code in strict provenance</p>



<a name="277496083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277496083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277496083">(Apr 02 2022 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277492153">said</a>:</p>
<blockquote>
<p>we dont have an example of that yet I think.</p>
</blockquote>
<p>I think I could come up with</p>
<ul>
<li>some contrived pair of higher-order functions <code>f</code>,<code>g</code> that use SB-untagged-ptr2int2ptr</li>
<li>that are distinct, i.e. for any input <code>h</code>, either <code>f(h)</code> is UB or <code>g(h)</code> is UB or <code>f(h) != g(h) : int</code></li>
<li>but if you change the ptr2int2ptr to SB-tagged-ptr2int2ptr, then <code>f'</code> and <code>g'</code> are operationally equivalent</li>
</ul>



<a name="277496126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277496126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277496126">(Apr 02 2022 at 01:10)</a>:</h4>
<p>I don't know that it would be interesting.</p>



<a name="277496565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277496565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277496565">(Apr 02 2022 at 01:19)</a>:</h4>
<p>Actually under this statement of the problem, <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277312717">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277312717</a> is already an example.</p>
<p>At the time I dismissed the example as trivial, because if I write out the strict-provenance variant of that function, it will contain <code>*std::ptr::invalid(..)</code> which is just plain UB.</p>
<p>Maybe we can find a more interesting problem statement.</p>



<a name="277496663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277496663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277496663">(Apr 02 2022 at 01:22)</a>:</h4>
<p>This is why I think it's unhelpful to use the same syntax for two kinds of ptr2int2ptr</p>



<a name="277496784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277496784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277496784">(Apr 02 2022 at 01:23)</a>:</h4>
<p>(I should credit my advisor Paul Levy, who really took this to the extreme with CBPV, introducing separate syntax for each little bit of semantics)</p>



<a name="277498485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277498485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277498485">(Apr 02 2022 at 01:54)</a>:</h4>
<p>So, just for clarity, we're looking at this example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">cond</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">.</span><span class="mi">1000000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="n">int2ptr</span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">total</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277498607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277498607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277498607">(Apr 02 2022 at 01:55)</a>:</h4>
<p>Where the strict provenance version is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">cond</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">.</span><span class="mi">1000000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">addr</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">total</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277498649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277498649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277498649">(Apr 02 2022 at 01:55)</a>:</h4>
<p>What optimization are you claiming is legal on the second but not on the first?</p>



<a name="277499916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277499916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277499916">(Apr 02 2022 at 02:21)</a>:</h4>
<p>IMO the strict provenance version would also have <code>arg: usize</code>, and then the else case is <code>total += *std::ptr::invalid(arg + i);</code> which is UB</p>



<a name="277499930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277499930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277499930">(Apr 02 2022 at 02:21)</a>:</h4>
<p>Because that‚Äôs what strict int2ptr is: <code>std::ptr::invalid</code></p>



<a name="277499963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277499963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277499963">(Apr 02 2022 at 02:22)</a>:</h4>
<p>It sounds stupid when you phrase it this way, doesn‚Äôt it ü§∑üèª</p>



<a name="277501972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277501972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277501972">(Apr 02 2022 at 03:04)</a>:</h4>
<p>Well, yes, but those functions have different behaviors</p>



<a name="277501981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277501981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277501981">(Apr 02 2022 at 03:04)</a>:</h4>
<p>Functions with different behavior might indeed optimize differently, that's not really the point</p>



<a name="277525174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277525174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277525174">(Apr 02 2022 at 11:56)</a>:</h4>
<p>I agree</p>



<a name="277529337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277529337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277529337">(Apr 02 2022 at 13:21)</a>:</h4>
<p>actually I think it is very easy to ensure that all optimizations are correct wrt permissive provenance: just treat ptr2int and int2ptr as FFI operations. even under strict provenance then, ptr2int might store that pointer 'somewhere', and int2ptr might return it.<br>
it follows that any optimization that is correct under strict provenance is also correct under permissive provenance, if it treats these casts as external/unknown operations. (we can probably do better than that, e.g. we can reorder these casts with arbitrary loads and stores. but that's details.)</p>



<a name="277529450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277529450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277529450">(Apr 02 2022 at 13:23)</a>:</h4>
<p>this is related to the ideas of implementing ptr2int2ptr casts in CHERI via a hashmap. that does not work <em>in general</em>. but the thing is, to thwart the compiler, it is enough that there exists an implementation that works <em>in any specific case</em> (like, the FFI is hard-coded for a specific program). and that is always possible.</p>



<a name="277620721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277620721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277620721">(Apr 03 2022 at 12:14)</a>:</h4>
<p>So... how does that fix the "integers can be optimized in ways that are unsound if provenance is derived from them" problem?</p>



<a name="277620993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277620993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277620993">(Apr 03 2022 at 12:17)</a>:</h4>
<p>Going back to the "double-cast" example:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">iq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">q</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iq</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">iq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which optimization would the "int2ptr is FFI" model prevent?</p>



<a name="277623195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277623195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277623195">(Apr 03 2022 at 12:38)</a>:</h4>
<p>You could still rewrite <code>*(char*)iq = 10</code> to <code>*(char*)ip = 10</code>, but you cannot simplify that to <code>*(p+1) = 10</code>.</p>



<a name="277628904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277628904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277628904">(Apr 03 2022 at 13:29)</a>:</h4>
<p>yeah, <code>ip</code> is just a thing returned from an FFI function and passed to a different FFI function, so you don't get to optimize it any further</p>



<a name="277629019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277629019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277629019">(Apr 03 2022 at 13:30)</a>:</h4>
<p>ofc FFI functions will have a big perf impact, but code that wants optimizations can 'simply' use the strict provenance APIs. :)<br>
(at least it can if we land <a href="https://github.com/rust-lang/rust/pull/95588">https://github.com/rust-lang/rust/pull/95588</a>)</p>



<a name="277865547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277865547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277865547">(Apr 05 2022 at 11:56)</a>:</h4>
<p>So... my apologies if I'm showing my ignorance, trying to figure out the rules here. Given this code:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="n">set_value</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="n">print</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Is there a possible scenario where the above prints 42?</p>



<a name="277865823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277865823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277865823">(Apr 05 2022 at 11:59)</a>:</h4>
<p>If I understand provenance correctly, the compiler might assume that, since "value" is a local variable, and no code using the provenance of value occurs after <code>value = 42</code>, value stays at 42?</p>



<a name="277865858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277865858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277865858">(Apr 05 2022 at 11:59)</a>:</h4>
<p>Well, if you make ptr2int2ptr casts UB, then the snippet you posted has UB and could print anything. If they are not UB, then it would have to print 10.</p>



<a name="277865873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277865873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277865873">(Apr 05 2022 at 11:59)</a>:</h4>
<p>Or is it assumed that <code>set_value</code> has side-effects , and side-effects can include changing arbitrary stack variables?</p>



<a name="277865965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277865965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277865965">(Apr 05 2022 at 12:00)</a>:</h4>
<blockquote>
<p>Well, if you make ptr2int2ptr casts UB, then the snippet you posted has UB and could print anything.</p>
</blockquote>
<p>I'm asking under the model where ptr2int and int2ptr are allowed and considered FFI.</p>



<a name="277866554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277866554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277866554">(Apr 05 2022 at 12:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277865873">said</a>:</p>
<blockquote>
<p>Or is it assumed that <code>set_value</code> has side-effects , and side-effects can include changing arbitrary stack variables?</p>
</blockquote>
<p>Provenance is used to assume that any local variable for which the address is not leaked or given to some specific code won't be modified or observed by it, no matter what it is.</p>
<p>Under PNVI-ae, then that code will print 10. Under strict provenance, yes, that code has undefined behaviour, and can  print anything. The most likely situtation is, of course, that 42 will be folded from <code>value</code> into <code>print</code>.</p>



<a name="277867519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277867519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277867519">(Apr 05 2022 at 12:12)</a>:</h4>
<p>Although under strict provenance, it could very easily delete the body of <code>set_value</code>, possibly replacing it with <code>ud2</code> or <code>nop</code>.</p>



<a name="277867614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277867614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277867614">(Apr 05 2022 at 12:13)</a>:</h4>
<p>I really hope we don't get in the business of doing optimizations like that. That is the sort of thing that makes devs hate compiler writers</p>



<a name="277867676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277867676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277867676">(Apr 05 2022 at 12:13)</a>:</h4>
<p>What, the "This code is unconditional UB and thus elide the entire thing into <code>ud2</code>" thing?</p>



<a name="277867684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277867684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277867684">(Apr 05 2022 at 12:13)</a>:</h4>
<p>yes</p>



<a name="277867732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277867732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277867732">(Apr 05 2022 at 12:14)</a>:</h4>
<p>I have some bad news for you.</p>



<a name="277867764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277867764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277867764">(Apr 05 2022 at 12:14)</a>:</h4>
<p>I realize it is difficult to avoid in a lot of cases, but we should try not to do it on purpose</p>



<a name="277868059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868059">(Apr 05 2022 at 12:17)</a>:</h4>
<p>Would you rather I elided functions that are unconditionally UB into an empty body, then?</p>



<a name="277868095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868095">(Apr 05 2022 at 12:17)</a>:</h4>
<p>people also hate compiler devs when optimizers miss obvious UB and emit slow asm</p>



<a name="277868108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868108">(Apr 05 2022 at 12:17)</a>:</h4>
<p>so i'd say its a lose-lose situation and just go for the fast code and tell people to stop doing UB <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="277868210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868210">(Apr 05 2022 at 12:18)</a>:</h4>
<p>Yeah.</p>



<a name="277868455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868455">(Apr 05 2022 at 12:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277868059">said</a>:</p>
<blockquote>
<p>Would you rather I elided functions that are unconditionally UB into an empty body, then?</p>
</blockquote>
<p>I would do something like compile it to a panic but also remember that it is unconditional UB and propagate this to callers</p>



<a name="277868498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868498">(Apr 05 2022 at 12:21)</a>:</h4>
<p>Inserting panics in optimization passes is a very bad idea.</p>



<a name="277868527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868527">(Apr 05 2022 at 12:21)</a>:</h4>
<p>why?</p>



<a name="277868532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868532">(Apr 05 2022 at 12:21)</a>:</h4>
<p>it's UB, it's never going to be called</p>



<a name="277868554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868554">(Apr 05 2022 at 12:21)</a>:</h4>
<p><code>ud2</code> avoids the problem of unwinding.</p>



<a name="277868621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868621">(Apr 05 2022 at 12:22)</a>:</h4>
<p>And has well-defined semantics: #UD.</p>



<a name="277868651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868651">(Apr 05 2022 at 12:22)</a>:</h4>
<p>certainly <code>nop</code> is a terrible idea if you fall off the end of the function</p>



<a name="277868672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868672">(Apr 05 2022 at 12:22)</a>:</h4>
<p>that's a short trip to actual <code>rm -rf /</code></p>



<a name="277868710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868710">(Apr 05 2022 at 12:22)</a>:</h4>
<p>That's what <code>TrapUnreachable</code> is for.</p>



<a name="277868761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868761">(Apr 05 2022 at 12:23)</a>:</h4>
<p>okay, but an abort with a message is still better</p>



<a name="277868811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868811">(Apr 05 2022 at 12:23)</a>:</h4>
<p>like compilers don't have to be adversarial when it comes to diagnosing code with UB</p>



<a name="277868856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868856">(Apr 05 2022 at 12:24)</a>:</h4>
<p>Certainly lccc's xlang_backend is very aggressive rn about const-folding and generating Unreachable code traps. It also happens to know zilch about functions called <code>printf</code>.</p>



<a name="277868891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868891">(Apr 05 2022 at 12:24)</a>:</h4>
<p>It just knows <code>self.inner.write_trap(Trap::Unreachable)</code>.</p>



<a name="277868951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868951">(Apr 05 2022 at 12:25)</a>:</h4>
<p>that could just be <code>self.inner.write_trap(Trap::Unreachable(msg))</code> and codegen that to <code>printf</code> or whatever is available on the target</p>



<a name="277868952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868952">(Apr 05 2022 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> Doing so with debug assertions is fine I think. For release mode it significantly regresses binary size and slightly regresses performance.</p>



<a name="277868974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277868974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277868974">(Apr 05 2022 at 12:25)</a>:</h4>
<p>(And the <code>inner</code> just knows <code>if self.trap_unreachable { /* ud2 */}</code> (<code>trap_unreachable</code> is currently forced on, with no way to turn it off user-side)</p>



<a name="277869029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869029">(Apr 05 2022 at 12:25)</a>:</h4>
<p>On release, <code>ud2</code> is probably the safest option that is still short</p>



<a name="277869041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869041">(Apr 05 2022 at 12:25)</a>:</h4>
<p>I used puts+ud2 in cg_clif until recently. Switching to only ud2 saved a lot on binary size.</p>



<a name="277869124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869124">(Apr 05 2022 at 12:26)</a>:</h4>
<p>The backend doesn't know enough about the target to know "whatever is available". That's a design feature.</p>



<a name="277869161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869161">(Apr 05 2022 at 12:26)</a>:</h4>
<p>(It also doesn't get the optimizer mode - against, a design feature - optimizer mode is a driver concept)</p>



<a name="277869254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869254">(Apr 05 2022 at 12:27)</a>:</h4>
<p>See <a href="https://github.com/bjorn3/rustc_codegen_cranelift/pull/1220">https://github.com/bjorn3/rustc_codegen_cranelift/pull/1220</a></p>



<a name="277869499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869499">(Apr 05 2022 at 12:28)</a>:</h4>
<p>it looks like you just took the prints out completely? Why not put it behind a compiler flag or debug setting?</p>



<a name="277869800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869800">(Apr 05 2022 at 12:30)</a>:</h4>
<p>Because cg_clif is only meant to be used in debug mode and compile fast in that case. Having a compiler flag would have been possible, but I don't think it is really worthwhile.</p>



<a name="277869827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869827">(Apr 05 2022 at 12:30)</a>:</h4>
<p>I think that supporting UB tracing properly is probably not something a compiler can do "naturally" but I can imagine something that gives you output a bit like Miri but only for assertions that can be statically baked into the executable</p>



<a name="277869956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277869956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277869956">(Apr 05 2022 at 12:32)</a>:</h4>
<p>the print statements you removed are all kind of vague, I'm sure it wouldn't help that much to see <code>[panic] Tried to get discriminant for uninhabited type.</code> without more context</p>



<a name="277870329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870329">(Apr 05 2022 at 12:34)</a>:</h4>
<p>While cg_clif was still frequently miscompiling things it was useful as a start point for debugging, but I agree it isn't very useful for end users.</p>



<a name="277870362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870362">(Apr 05 2022 at 12:34)</a>:</h4>
<p>You're going to get vague errors anyways.</p>



<a name="277870515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870515">(Apr 05 2022 at 12:35)</a>:</h4>
<p>Especially with compilers like lccc that have delayed UB</p>
<blockquote>
<p>Attempted to branch on <code>invalid</code></p>
</blockquote>



<a name="277870611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870611">(Apr 05 2022 at 12:36)</a>:</h4>
<p>It seems conceivable that you can get a "context trace" for unreachable markers that tracks where the UB came from (in source terms) and retains this through UB back-propagation</p>



<a name="277870655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870655">(Apr 05 2022 at 12:36)</a>:</h4>
<p>That's a lot of (slow) state tracking.</p>



<a name="277870703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870703">(Apr 05 2022 at 12:37)</a>:</h4>
<p>it would slow down the compiler but it's all just a static output</p>



<a name="277870744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870744">(Apr 05 2022 at 12:37)</a>:</h4>
<p>Exactly.</p>



<a name="277870764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870764">(Apr 05 2022 at 12:37)</a>:</h4>
<p>sure, it's not easy being helpful</p>



<a name="277870798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870798">(Apr 05 2022 at 12:37)</a>:</h4>
<p>Do you want a binary sometime in the next minute?</p>



<a name="277870846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870846">(Apr 05 2022 at 12:38)</a>:</h4>
<p>i don't think it has to be tremendously expensive though</p>



<a name="277870880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870880">(Apr 05 2022 at 12:38)</a>:</h4>
<p>it's just a bit of diagnostic info attached to unreachable markers</p>



<a name="277870948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277870948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277870948">(Apr 05 2022 at 12:38)</a>:</h4>
<p>it seems comparable to all the other diagnostic stuff in rustc today</p>



<a name="277871042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277871042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277871042">(Apr 05 2022 at 12:39)</a>:</h4>
<p>"unreachable markers" aka <code>Value::Invalid</code>, which isn't even the most common source of UB (<code>Value::Uninit</code> would appear far more often, and has far more cases of UB, despite not being "If you have this, undefined behaviour")</p>



<a name="277871178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277871178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277871178">(Apr 05 2022 at 12:40)</a>:</h4>
<p>Is this constant propagation you are talking about? <code>Value::Invalid</code> sounds like a runtime concept</p>



<a name="277871304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277871304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277871304">(Apr 05 2022 at 12:41)</a>:</h4>
<p>Yes. <code>Value::Invalid</code> is a constant value in xir that is "The canonical invalid value of some type <code>T</code>". It's mere production (of any type) is immediate undefined behaviour. Of course, I delay this to a few key points (such as when I actually need to determine what a value is).</p>



<a name="277871434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277871434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277871434">(Apr 05 2022 at 12:42)</a>:</h4>
<p>in that case I would attach a pointer / ID / span / whatever tracking information to the source statement that yielded a MIR/xir operation that generated the <code>Value::Invalid</code></p>



<a name="277871845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277871845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277871845">(Apr 05 2022 at 12:45)</a>:</h4>
<p>you need to be keeping track of such information anyway if you want to have, say, good post-mono errors</p>



<a name="277871954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277871954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277871954">(Apr 05 2022 at 12:45)</a>:</h4>
<p>Sure, but it won't get attached to the values.</p>



<a name="277872117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872117">(Apr 05 2022 at 12:46)</a>:</h4>
<p>but doing so is not a large cost if the tracking info is small, you just have to copy it along as it propagates</p>



<a name="277872192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872192">(Apr 05 2022 at 12:47)</a>:</h4>
<p>I would assume that the <code>Value::OtherStuff</code> is already quite a bit bigger</p>



<a name="277872322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872322">(Apr 05 2022 at 12:48)</a>:</h4>
<p>Well, the value is inside of <code>VStackValue::Constant</code> which just stores an <code>xlang_struct::Value</code>. Said value could be <code>Uninit</code> or <code>Invalid</code>, but could also be <code>int(32) 0</code>.</p>



<a name="277872539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872539">(Apr 05 2022 at 12:49)</a>:</h4>
<p>(Also, <code>Invalid</code>/<code>Uninitialized</code> both store a <code>Type</code>, which, is... uh... fairly big)</p>



<a name="277872562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872562">(Apr 05 2022 at 12:49)</a>:</h4>
<p>right, that seems to accord with what I said. For error values you can hold on to some originator info so that if you try to branch on it or something you can say "this operation &gt;here&lt; produced a value that was used &gt;here&lt; and this is UB"</p>



<a name="277872700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872700">(Apr 05 2022 at 12:50)</a>:</h4>
<p>just because there exists an invalid value somewhere during codegen doesnt mean you need to error though, it can happen in dead code and thats perfectly fine</p>



<a name="277872739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872739">(Apr 05 2022 at 12:51)</a>:</h4>
<p>I don't really understand what the goal is here</p>



<a name="277872759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872759">(Apr 05 2022 at 12:51)</a>:</h4>
<p>that's why it's just additional tracking info in the <code>Invalid</code></p>



<a name="277872857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872857">(Apr 05 2022 at 12:51)</a>:</h4>
<p>the idea is that if this <code>Invalid</code> is actually <em>used</em> in a way that is erroneous, then you know how you got the value and can report a better error than you could otherwise</p>



<a name="277872939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872939">(Apr 05 2022 at 12:52)</a>:</h4>
<p>Having <code>Invalid</code> is erroneous.</p>



<a name="277872970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277872970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277872970">(Apr 05 2022 at 12:52)</a>:</h4>
<p>and if it just goes to the binary then you can write this info in an abort message</p>



<a name="277873011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873011">(Apr 05 2022 at 12:52)</a>:</h4>
<p>The only reason it gets produced by the backend at all is because I'm lazy and want to codegen <code>Expr::Const(c)</code> as <code>push_value(VStackValue::Constant(c))</code></p>



<a name="277873088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873088">(Apr 05 2022 at 12:53)</a>:</h4>
<p>I deal with it when it get's used.</p>



<a name="277873221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873221">(Apr 05 2022 at 12:54)</a>:</h4>
<p>(It's also a fairly limited source of UB - and many other values can cause UB in later ops)</p>



<a name="277873261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873261">(Apr 05 2022 at 12:54)</a>:</h4>
<p>right, you use an <code>Invalid(info)</code> that got produced somewhere and can emit <code>Trap(format!("produced Invalid at {info}, {file}:{line}"))</code></p>



<a name="277873331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873331">(Apr 05 2022 at 12:55)</a>:</h4>
<p>(It also again comes down to "The backend doesn't know what <code>printf</code> is")</p>



<a name="277873441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873441">(Apr 05 2022 at 12:55)</a>:</h4>
<p>(And frankly, I think codegen introducing any kind of function call rather than a <code>ud2</code> is a huge issue)</p>



<a name="277873505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873505">(Apr 05 2022 at 12:56)</a>:</h4>
<p>Okay, so teach it? pass it an Option&lt;Symbol&gt; for puts or something</p>



<a name="277873559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873559">(Apr 05 2022 at 12:56)</a>:</h4>
<p>and this is a debug assert anyway, you can turn it off in release</p>



<a name="277873689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873689">(Apr 05 2022 at 12:57)</a>:</h4>
<p>I am sooo much happier writing Rust code instead of C that I get nice error messages with a source location when I use an array out of bounds instead of a silent segfault. It is <em>absolutely</em> worth it</p>



<a name="277873745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873745">(Apr 05 2022 at 12:57)</a>:</h4>
<p>That's not even remotely the same as what you're describing</p>



<a name="277873884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873884">(Apr 05 2022 at 12:58)</a>:</h4>
<p>this is extra info in panic messages about the source location of the UB value that was generated</p>



<a name="277873999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277873999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277873999">(Apr 05 2022 at 12:59)</a>:</h4>
<p>In production compilers it would be a best effort thing, not full Miri style</p>



<a name="277874036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874036">(Apr 05 2022 at 12:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277873505">said</a>:</p>
<blockquote>
<p>Okay, so teach it? pass it an Option&lt;Symbol&gt; for puts or something</p>
</blockquote>
<p>1) From where, the backend only gets the target, features, and incoming IR.  &lt;<a href="https://github.com/LightningCreations/lccc/blob/main/xlang/src/plugin.rs#L67">https://github.com/LightningCreations/lccc/blob/main/xlang/src/plugin.rs#L67</a>&gt;<br>
2) I noted above that the backend doesn't even see the optimization level. It's just a driver concept to decide what optimizer plugins to run between the frontend and the backend (in addition to user-specified ones, and ones indicated as required by the frontend)</p>



<a name="277874130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874130">(Apr 05 2022 at 13:00)</a>:</h4>
<p>For array out of bounds checks you have to use shadow state at runtime to produce the error instead of a segfault in more than a couple percent of the cases I think.</p>



<a name="277874234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874234">(Apr 05 2022 at 13:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277873441">said</a>:</p>
<blockquote>
<p>(And frankly, I think codegen introducing any kind of function call rather than a <code>ud2</code> is a huge issue)</p>
</blockquote>
<p>Also, re. this: what if the UB occurs inside a dynamic loader's resolution function.</p>



<a name="277874336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874336">(Apr 05 2022 at 13:01)</a>:</h4>
<p>Now I've turned the nice noisy "Illegal Instruction (core dumped)", into an infinite loop.</p>



<a name="277874342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874342">(Apr 05 2022 at 13:01)</a>:</h4>
<p>the main place I think you would see error messages like I'm describing would be in <em>unconditional</em> UB. Conditional UB will just be compiled out so you will just get the result of some other branch of execution</p>



<a name="277874380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874380">(Apr 05 2022 at 13:01)</a>:</h4>
<p>which is what I mean about "best-effort"</p>



<a name="277874437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874437">(Apr 05 2022 at 13:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277874342">said</a>:</p>
<blockquote>
<p>the main place I think you would see error messages like I'm describing would be in <em>unconditional</em> UB. Conditional UB will just be compiled out so you will just get the result of some other branch of execution</p>
</blockquote>
<p>That's only if the optimizer runs. Backend isn't that smart.</p>



<a name="277874498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874498">(Apr 05 2022 at 13:02)</a>:</h4>
<p>Backend optimizations are currently limited to what can be done linearily with the xir instruction stream.</p>



<a name="277874513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874513">(Apr 05 2022 at 13:02)</a>:</h4>
<p>if the optimizer doesn't run then you keep the branch and have unconditional UB with a nice panic message, and the user is happy</p>



<a name="277874592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874592">(Apr 05 2022 at 13:03)</a>:</h4>
<blockquote>
<p>Have unconditional UB with a nice panic message</p>
</blockquote>
<p>Unless of course, printing the panic message is reentrant to the statement that causes undefined behaviour.</p>



<a name="277874713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874713">(Apr 05 2022 at 13:04)</a>:</h4>
<p>Then you suddenly have a worse UX problem.</p>



<a name="277874822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874822">(Apr 05 2022 at 13:04)</a>:</h4>
<p>The existing, albeit unhelpful, diagnostic of "Illegal Instruction" has been replaced with either an infinite loop, or a loop for a while then "Segmentation Fault".</p>



<a name="277874843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874843">(Apr 05 2022 at 13:05)</a>:</h4>
<p>eh, s/panic/abort, you get the idea</p>



<a name="277874896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874896">(Apr 05 2022 at 13:05)</a>:</h4>
<p>This issue can occur on the print-and-abort version as well.</p>



<a name="277874942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277874942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277874942">(Apr 05 2022 at 13:05)</a>:</h4>
<p>again, what if the code is <code>ldresolve</code>?</p>



<a name="277875026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875026">(Apr 05 2022 at 13:06)</a>:</h4>
<p>if you call <code>puts</code> and it fails then oh well</p>



<a name="277875080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875080">(Apr 05 2022 at 13:06)</a>:</h4>
<p>I mean isn't this an issue when you do anything?</p>



<a name="277875186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875186">(Apr 05 2022 at 13:07)</a>:</h4>
<p>No, the situtation here is</p>
<ol>
<li>I'm in <code>ldresolve</code>. </li>
<li>I hit UB</li>
<li>I call <code>printf</code></li>
<li><code>printf</code> hasn't yet been resolved, so I call the plt symbol resolver</li>
<li>plt symbol resolver calls <code>ldresolve</code></li>
<li>I hit UB</li>
<li>I call <code>printf</code></li>
<li>...</li>
</ol>



<a name="277875334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875334">(Apr 05 2022 at 13:08)</a>:</h4>
<p>Is <code>ldresolve</code> being compiled by your compiler?</p>



<a name="277875357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875357">(Apr 05 2022 at 13:08)</a>:</h4>
<p>Perhaps it is.</p>



<a name="277875389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875389">(Apr 05 2022 at 13:08)</a>:</h4>
<p>If this is the <code>ldresolve</code> inside lclibc or PhantomOS, I bet it will be.</p>



<a name="277875461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875461">(Apr 05 2022 at 13:09)</a>:</h4>
<p>this is all very strange to me. You have to be able to write in some way that is not reentrant</p>



<a name="277875485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875485">(Apr 05 2022 at 13:09)</a>:</h4>
<p>do a <code>write</code> syscall if you have to</p>



<a name="277875609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875609">(Apr 05 2022 at 13:10)</a>:</h4>
<p>That's not an option on Windows and MacOS</p>



<a name="277875615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875615">(Apr 05 2022 at 13:10)</a>:</h4>
<p>make it a compiler intrinsic so that it doesn't have code the compiler generated in it</p>



<a name="277875631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875631">(Apr 05 2022 at 13:10)</a>:</h4>
<p>Well, see, <code>ldresolve</code> usually doesn't contain references to plt relocations.</p>



<a name="277875803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875803">(Apr 05 2022 at 13:11)</a>:</h4>
<p><code>ldresolve</code> likely needs <code>#![no_builtins]</code>. You can disable the printf if this attribute is used.</p>



<a name="277875944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277875944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277875944">(Apr 05 2022 at 13:12)</a>:</h4>
<p>Or I could just not generate unsolicited function calls in codegen.</p>



<a name="277876031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876031">(Apr 05 2022 at 13:13)</a>:</h4>
<p>using <code>ud2</code> is certainly an easy option for a compiler (I'm doing this too) but it's not <em>nice</em> for the user</p>



<a name="277876128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876128">(Apr 05 2022 at 13:13)</a>:</h4>
<p>You already do (eg memcpy, or other calls into compiler-builtins). <code>#![no_builtins]</code> exists precisely to disable those unsolicited function calls.</p>



<a name="277876292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876292">(Apr 05 2022 at 13:14)</a>:</h4>
<p>It's the option that runs the least risk of <br>
a) Killing Binary Size (again - codegenx86 <em>does not</em> see <code>-On</code>and this is by design)<br>
b) Creating worse situtations.</p>



<a name="277876393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876393">(Apr 05 2022 at 13:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277876128">said</a>:</p>
<blockquote>
<p>You already do (eg memcpy, or other calls into compiler-builtins). <code>#![no_builtins]</code> exists precisely to disable those unsolicited function calls.</p>
</blockquote>
<p>Only time the codegen currently does any kind of function call is:<br>
1) When codegening calls to certain builtins<br>
2) A call<br>
3) An atomic operation which is non-lock free.</p>



<a name="277876412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876412">(Apr 05 2022 at 13:15)</a>:</h4>
<p>Also, if you want to quantify the impact of a <code>ud2</code> vs a more helpful message, there is now a single place in the standard library where you can swap out what happens when you trip assertions related to detecting UB in <code>core</code>: <a href="https://github.com/rust-lang/rust/blob/634770c0a7f8598164ab825cfe419cc8b03c36e5/library/core/src/intrinsics.rs#L1995">https://github.com/rust-lang/rust/blob/634770c0a7f8598164ab825cfe419cc8b03c36e5/library/core/src/intrinsics.rs#L1995</a></p>
<p>When I implemented this, using <code>panic!</code> was <em>at least</em> a 6% regression in runtime. Just the <code>ud2</code> is &lt;1%. But those numbers are definitely minimizing the situation because I added a lot more checks after doing that measurement.</p>



<a name="277876494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876494">(Apr 05 2022 at 13:15)</a>:</h4>
<p>That sounds quite reasonable for a debug option</p>



<a name="277876571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876571">(Apr 05 2022 at 13:16)</a>:</h4>
<p>You fully misunderstand what this code does</p>



<a name="277876585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876585">(Apr 05 2022 at 13:16)</a>:</h4>
<p>It checks hardly any UB at all</p>



<a name="277876662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876662">(Apr 05 2022 at 13:17)</a>:</h4>
<p>The actual "check for UB" patch would add checks for all pointer dereferences, all pointer offsets, all matches on an enum...</p>



<a name="277876858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876858">(Apr 05 2022 at 13:18)</a>:</h4>
<p>I'm not talking about extra checks, only messages when you reach unconditional UB that the compiler saw through</p>



<a name="277876948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277876948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277876948">(Apr 05 2022 at 13:19)</a>:</h4>
<p>Yes, that is <em>everywhere</em></p>



<a name="277877066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877066">(Apr 05 2022 at 13:20)</a>:</h4>
<p>the runtime cost should be zero, except for the icache losses due to code size and the cost of writing the message itself if you happen to hit UB</p>



<a name="277877074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877074">(Apr 05 2022 at 13:20)</a>:</h4>
<p>But also, feel free to prove me wrong by writing a patch for rustc and LLVM</p>



<a name="277877126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877126">(Apr 05 2022 at 13:20)</a>:</h4>
<p>i am confused as to what you mean by "Unconditional UB"</p>



<a name="277877171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877171">(Apr 05 2022 at 13:21)</a>:</h4>
<p>Also, as I've mentioned, this would also introduce the same code to release as debug, because <em>the backend has no way to differentiate</em>.</p>



<a name="277877327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877327">(Apr 05 2022 at 13:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277877126">said</a>:</p>
<blockquote>
<p>i am confused as to what you mean by "Unconditional UB"</p>
</blockquote>
<p>Code that is determined by the compiler to be 100% in all code paths that enter it.</p>



<a name="277877341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877341">(Apr 05 2022 at 13:22)</a>:</h4>
<p>The trivial example being <code>core::hint::unreachable_unchecked()</code></p>



<a name="277877369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877369">(Apr 05 2022 at 13:22)</a>:</h4>
<p>isnt that all UB though <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="277877402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877402">(Apr 05 2022 at 13:22)</a>:</h4>
<p>Well, there can be UB the compiler can't see through.</p>



<a name="277877406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877406">(Apr 05 2022 at 13:22)</a>:</h4>
<p>Like in the code <span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> linked to, there is a call to <code>::core::intrinsics::abort()</code> that I would call "unconditional" in the sense that once we enter the branch we are committed to running the abort.</p>



<a name="277877438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877438">(Apr 05 2022 at 13:23)</a>:</h4>
<p>Well, a function that takes a <code>*mut T</code> and dereferences it is only UB if the pointer is bad, so that's not unconditional.</p>



<a name="277877446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877446">(Apr 05 2022 at 13:23)</a>:</h4>
<p>if the branch was optimized away, then okay, no more panic message</p>



<a name="277877473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877473">(Apr 05 2022 at 13:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277877438">said</a>:</p>
<blockquote>
<p>Well, a function that takes a <code>*mut T</code> and dereferences it is only UB if the pointer is bad, so that's not unconditional.</p>
</blockquote>
<p>Yeah.</p>



<a name="277877511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877511">(Apr 05 2022 at 13:23)</a>:</h4>
<p>And the compiler won't see through the function unless it inlines (or cross-function const-props)</p>



<a name="277877527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877527">(Apr 05 2022 at 13:23)</a>:</h4>
<p>hmm i guess, it feels like a subtle distinction <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="277877578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877578">(Apr 05 2022 at 13:24)</a>:</h4>
<p>im not sure if its super meaningful..</p>



<a name="277877612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877612">(Apr 05 2022 at 13:24)</a>:</h4>
<p>It means that the checks wouldn't do anything at runtime.</p>



<a name="277877618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877618">(Apr 05 2022 at 13:24)</a>:</h4>
<p>but if the compiler settings are such that for whatever reason we decided to keep that branch, then we have a bit of code where we are definitely on a crash course</p>



<a name="277877662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877662">(Apr 05 2022 at 13:24)</a>:</h4>
<p>and at that point there is no harm in printing whatever useful information we can</p>



<a name="277877699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877699">(Apr 05 2022 at 13:24)</a>:</h4>
<p>(except for code size and compile time)</p>



<a name="277877717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877717">(Apr 05 2022 at 13:25)</a>:</h4>
<p>I mean, see above.</p>



<a name="277877794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877794">(Apr 05 2022 at 13:25)</a>:</h4>
<p>(assuming you are not inside some critical infrastructure related to printing)</p>



<a name="277877851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877851">(Apr 05 2022 at 13:26)</a>:</h4>
<p>which is almost all code</p>



<a name="277877890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877890">(Apr 05 2022 at 13:26)</a>:</h4>
<p>Or you don't have any way to print.</p>



<a name="277877981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277877981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277877981">(Apr 05 2022 at 13:27)</a>:</h4>
<p>because you aren't on a hosted system, or because of an architectural flaw?</p>



<a name="277878008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878008">(Apr 05 2022 at 13:27)</a>:</h4>
<p>Because you aren't on hosted.</p>



<a name="277878040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878040">(Apr 05 2022 at 13:27)</a>:</h4>
<p>in that case, just skip it</p>



<a name="277878072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878072">(Apr 05 2022 at 13:27)</a>:</h4>
<p>"best-effort"</p>



<a name="277878229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878229">(Apr 05 2022 at 13:28)</a>:</h4>
<p>It's far easier to not have to figure that out.</p>



<a name="277878254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878254">(Apr 05 2022 at 13:28)</a>:</h4>
<p>I just remember LLVM has an option to turn the unreachable instruction into ud2. It was enabled by default for a while to mitigate loop {} being UB in LLVM in the past. I believe it has since been disabled though.</p>



<a name="277878316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878316">(Apr 05 2022 at 13:29)</a>:</h4>
<p>On x86, I only look at the operating system to determine the ABI.<br>
Currently the branches are<br>
<code>x86_64-*-windows-*</code> =&gt; <code>WIN64</code><br>
<code>x86_86-*-*</code> =&gt; <code>SysV64</code></p>



<a name="277878331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878331">(Apr 05 2022 at 13:29)</a>:</h4>
<p>LLVM still optimizes based on unreachable even with that option though.</p>



<a name="277878580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878580">(Apr 05 2022 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> I would take a page from the way panicking works in rust currently. This is a <em>language</em> feature, in that syntax like <code>[][0]</code> leads to a call to <code>print</code> somehow</p>



<a name="277878643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878643">(Apr 05 2022 at 13:31)</a>:</h4>
<p>I believe the mechanism is that the language knows how to call a library function with a name like <code>core::panicking::panic</code></p>



<a name="277878657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878657">(Apr 05 2022 at 13:31)</a>:</h4>
<p>Yeah, that panic is generated in the frontend.</p>



<a name="277878765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277878765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277878765">(Apr 05 2022 at 13:32)</a>:</h4>
<p>you could have it be a late transformation pass on the IR if it is awkward in codegen</p>



<a name="277879062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879062">(Apr 05 2022 at 13:34)</a>:</h4>
<p>Backend is: What's <code>std::panicking::panic_fmt&lt;'a&gt;(std::fmt::Arguments&lt;'a&gt;)-&gt;!</code>.</p>
<p>I know: <code>call _ZNSt9panicking9panic_fmtIU6erasedEE_ZSt3fmt9ArgumentsIT_Ev</code></p>



<a name="277879069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879069">(Apr 05 2022 at 13:34)</a>:</h4>
<p>panicking also has countermeasures to avoid reentrancy</p>



<a name="277879116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879116">(Apr 05 2022 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277878765">said</a>:</p>
<blockquote>
<p>you could have it be a late transformation pass on the IR if it is awkward in codegen</p>
</blockquote>
<p>What transformation pass?</p>



<a name="277879182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879182">(Apr 05 2022 at 13:35)</a>:</h4>
<p>replace <code>Trap(msg)</code> with <code>Call("intrinsic::abort_with_msg", msg)</code></p>



<a name="277879190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879190">(Apr 05 2022 at 13:35)</a>:</h4>
<p>Pipeline is <code>frontend</code> -&gt; <code>frontend_required</code> -&gt; <code>user</code> -&gt; <code>optimizers</code> (selected by <code>-O</code>, none at <code>-O0</code>) -&gt; backend</p>



<a name="277879286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879286">(Apr 05 2022 at 13:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277879182">said</a>:</p>
<blockquote>
<p>replace <code>Trap(msg)</code> with <code>Call("intrinsic::abort_with_msg", msg)</code></p>
</blockquote>
<p><code>Trap</code> is a concept in <code>xlang_backend</code>. It's how the generic backend instructs the raw, target-specific, backend to generate a trap.</p>



<a name="277879451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879451">(Apr 05 2022 at 13:37)</a>:</h4>
<p><a href="https://github.com/LightningCreations/lccc/blob/main/xlang/xlang_backend/src/lib.rs#L277">https://github.com/LightningCreations/lccc/blob/main/xlang/xlang_backend/src/lib.rs#L277</a> is some example code.</p>



<a name="277879727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879727">(Apr 05 2022 at 13:39)</a>:</h4>
<p>based on that code, I would try to stuff the name of the abort function in <code>TargetProperties</code></p>



<a name="277879894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277879894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277879894">(Apr 05 2022 at 13:40)</a>:</h4>
<p>TargetProperties ABI breaks <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span>.</p>



<a name="277880264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277880264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277880264">(Apr 05 2022 at 13:43)</a>:</h4>
<p>or possibly adding it to <code>FunctionRawCodegen</code> as another function or a modification of <code>write_trap</code></p>



<a name="277880530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277880530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277880530">(Apr 05 2022 at 13:45)</a>:</h4>
<p>There's not much that <code>write_trap</code> (or most of codegen-x86/others)  knows about the target:<br>
<a href="https://github.com/LightningCreations/lccc/blob/main/codegen-x86/src/lib.rs#L152">https://github.com/LightningCreations/lccc/blob/main/codegen-x86/src/lib.rs#L152</a></p>



<a name="277881872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277881872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277881872">(Apr 05 2022 at 13:54)</a>:</h4>
<p>you are right, the one in the best position to handle it would be <code>FunctionCodegen</code> itself since you want to call <code>call_fn</code>. If you can get the <code>Path</code> of lang items somehow you can call that</p>



<a name="277899248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277899248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277899248">(Apr 05 2022 at 15:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277865858">said</a>:</p>
<blockquote>
<p>Well, if you make ptr2int2ptr casts UB, then the snippet you posted has UB and could print anything. If they are not UB, then it would have to print 10.</p>
</blockquote>
<p>If uintptr_t exists it must be able to round-trip pointers, so no, that code never has UB, and we're never going to break that on CHERI</p>



<a name="277901575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277901575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277901575">(Apr 05 2022 at 15:59)</a>:</h4>
<blockquote>
<p>Or is it assumed that <code>set_value</code> has side-effects , and side-effects can include changing arbitrary stack variables?</p>
</blockquote>
<p>Wait, no, I think I get it. The compiler treats casting <code>&amp;value</code> to an <code>uintptr_t</code> as equivalent to escaping <code>value</code>'s address to a FFI function. Therefore, the compiler assumes that any function with side-effects potentially uses FFI to get the address back, therefore <code>set_value</code> must be assumed to potentially mutate <code>value</code>.</p>



<a name="277901603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277901603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277901603">(Apr 05 2022 at 15:59)</a>:</h4>
<p>I think that works.</p>



<a name="277906462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277906462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277906462">(Apr 05 2022 at 16:31)</a>:</h4>
<p>Jessica, the idea of strict provenance is to not support roundtripping, or not support it fully. And previous discussions made me realize we can‚Äôt have a perfect implementation of int2ptr ‚Äî it‚Äôs not possible to do it for ‚Äúinteger pointers‚Äù that come from C for instance</p>



<a name="277906830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277906830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277906830">(Apr 05 2022 at 16:33)</a>:</h4>
<p>I don‚Äôt think anyone wants to break anything on CHERI. But right now nothing works on CHERI (I think?) and just getting strict-only provenance working is already an accomplishment . As a next step, we can implement ‚ÄúRust-only‚Äù polyfills for permissive provenance</p>



<a name="277907104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277907104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277907104">(Apr 05 2022 at 16:35)</a>:</h4>
<p>Ah sorry, Oliver is asking about permissive provenance. It‚Äôs confusing because the topic is strict provenance. Never mind, carry on</p>



<a name="277907284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277907284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277907284">(Apr 05 2022 at 16:36)</a>:</h4>
<p>I think the ‚Äúptr2int is FFI‚Äù part is only relevant for the compiler optimization part. It doesn‚Äôt magically make int2ptr work on CHERI</p>



<a name="277907901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277907901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277907901">(Apr 05 2022 at 16:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277906462">said</a>:</p>
<blockquote>
<p>Jessica, the idea of strict provenance is to not support roundtripping, or not support it fully. And previous discussions made me realize we can‚Äôt have a perfect implementation of int2ptr ‚Äî it‚Äôs not possible to do it for ‚Äúinteger pointers‚Äù that come from C for instance</p>
</blockquote>
<p>I think Jessica's point is that Oliver's example uses <code>uintptr_t</code> which is a C type required to be able to round trip a pointer so there is no UB in that C code (though it might not compile on weird implementations). If you change it to use <code>size_t</code> analogous to <code>usize</code>then it is indeed UB.</p>



<a name="277908531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277908531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277908531">(Apr 05 2022 at 16:44)</a>:</h4>
<p>and that's because CHERI implements <code>uintptr_t</code> as actually a pointer type, right? a.k.a the <code>uptr</code> type from <code>sptr</code> crate</p>



<a name="277908609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277908609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277908609">(Apr 05 2022 at 16:45)</a>:</h4>
<p>in which case there isn't really any ptr2int2ptr roundtripping happening</p>



<a name="277910948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277910948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277910948">(Apr 05 2022 at 17:01)</a>:</h4>
<p>I personally don‚Äôt read the C17 standard that way ‚Äî in my interpretation, the result only has to be ==, not actually function the same. But Jessica‚Äôs is also a reasonable interpretation. </p>
<p>CHERI C indeed defines that uintptr_t would optionally be a capability.</p>



<a name="277911174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277911174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277911174">(Apr 05 2022 at 17:03)</a>:</h4>
<p>So no ‚Äúreal‚Äù roundtripping occurs indeed</p>



<a name="277914616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277914616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277914616">(Apr 05 2022 at 17:26)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> </p>
<blockquote>
<p>actually I think it is very easy to ensure that all optimizations are correct wrt permissive provenance: just treat ptr2int and int2ptr as FFI operations. even under strict provenance then, ptr2int might store that pointer 'somewhere', and int2ptr might return it.</p>
</blockquote>
<p>Is the idea that the FFI code could have some "oracle" which tells it which of the many possible provenances it should return? (Because as mentioned the map solution doesn't actually work in practice). I think that makes sense, although if you combined the strict provenance model with the kind of non-deterministic reasoning from your twinsem paper, then couldn't the compiler reason that such an oracle is not possible?</p>



<a name="277916660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277916660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277916660">(Apr 05 2022 at 17:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277910948">said</a>:</p>
<blockquote>
<p>I personally don‚Äôt read the C17 standard that way ‚Äî in my interpretation, the result only has to be ==, not actually function the same. But Jessica‚Äôs is also a reasonable interpretation. </p>
</blockquote>
<p>It's a reasonable interpretation, it's the interpretation of every C compiler, it's the interpretation of a lot of code both before and after the standard, it's the interpretation of literally every proposal by the working group trying to give a reasonably formal definition. Saying a unusable pointer result is a plausible interpretation of the intent of the less formal English in C17 and prior is stretching the definition of plausible. Of course, on CHERI having this work means that uintptr_t is not quite a well-behaved <em>integer</em>, but at least that empirically mostly works in practice.</p>



<a name="277920723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277920723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277920723">(Apr 05 2022 at 18:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277865547">said</a>:</p>
<blockquote>
<p>So... my apologies if I'm showing my ignorance, trying to figure out the rules here. Given this code:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="n">set_value</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="n">print</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Is there a possible scenario where the above prints 42?</p>
</blockquote>
<p>if you ignore the Rust aliasing rules (Stacked Borrows), then under my proposed semantics this will definitely print 10.</p>
<p>however, under Rust aliasing rules, when you do <code>value = 42</code>, all other pointers ("provenances") that can access this local get invalidated, making the next call to <code>set_value</code> UB.</p>



<a name="277920892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277920892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277920892">(Apr 05 2022 at 18:10)</a>:</h4>
<p>The code cant even be interpreted under strict provenance since it uses an operation that is banned in that model (int2ptr casts). So I don't think that is a well-defined question.</p>



<a name="277920995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277920995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277920995">(Apr 05 2022 at 18:11)</a>:</h4>
<p>(and also the question seems off-topic in this topic, and probably should have been a new topic. ;) generally it's probably a good idea to have a new topic for a new question, if it didnt come up in the middle of an active existing discussion.)</p>



<a name="277921639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277921639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277921639">(Apr 05 2022 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="295632">Diggsey</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277914616">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> </p>
<blockquote>
<p>actually I think it is very easy to ensure that all optimizations are correct wrt permissive provenance: just treat ptr2int and int2ptr as FFI operations. even under strict provenance then, ptr2int might store that pointer 'somewhere', and int2ptr might return it.</p>
</blockquote>
<p>Is the idea that the FFI code could have some "oracle" which tells it which of the many possible provenances it should return? (Because as mentioned the map solution doesn't actually work in practice). I think that makes sense, although if you combined the strict provenance model with the kind of non-deterministic reasoning from your twinsem paper, then couldn't the compiler reason that such an oracle is not possible?</p>
</blockquote>
<p>yes, basically. for each specific piece of code, I think there exists <em>some</em> implementation of that FFI that does the right thing. for instance, if we ignore concurrency and non-determinism, the FFI might just hard-code the sequence of provenances it will return.<br>
it's just impossible to implement this FFI once-and-for-all.</p>
<p>for that reason I dont think the compiler can do a twinsem-style argument. the twinsem argument crucially relies on the fact that if we did an alternative execution where a different base address had been picked, the unknown function we are reasoning about would <em>execute the exact same way</em> since it had no chance to actually inspect the variable where the address is stored, and the AM state is equal up to that variable. the argument does not apply here since ptr2int explicitly leaks the provenance to the outside world, meaning you can no longer just say "these two situations must behave exactly the same since the outside world cannot possibly have observed any difference".</p>



<a name="277925697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277925697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277925697">(Apr 05 2022 at 18:40)</a>:</h4>
<blockquote>
<p>meaning you can no longer just say "these two situations must behave exactly the same since the outside world cannot possibly have observed any difference".</p>
</blockquote>
<p>You can if you limit the effect of ptr2int a la stacked borrows protectors, right?</p>



<a name="277926226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277926226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277926226">(Apr 05 2022 at 18:44)</a>:</h4>
<p>I dont think so</p>



<a name="277926260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277926260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277926260">(Apr 05 2022 at 18:44)</a>:</h4>
<p>like, twinsem did all this work to make sure ptr2int is pure</p>



<a name="277926296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277926296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277926296">(Apr 05 2022 at 18:44)</a>:</h4>
<p>but we <em>know</em> it cannot be pure for us because of <a href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151521.html">https://lists.llvm.org/pipermail/llvm-dev/2021-June/151521.html</a> (blogpost upcoming Any Day Now)</p>



<a name="277926318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277926318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277926318">(Apr 05 2022 at 18:44)</a>:</h4>
<p>twinsem got away with it since it doesnt do <code>restrict</code>/<code>noalias</code>/SB</p>



<a name="277926496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277926496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277926496">(Apr 05 2022 at 18:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277926226">said</a>:</p>
<blockquote>
<p>I dont think so</p>
</blockquote>
<p>With raw pointers there would be no protectors, but for &amp;mut T and &amp;T you can limit it, right?</p>



<a name="277926547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277926547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277926547">(Apr 05 2022 at 18:46)</a>:</h4>
<p>but due to the above counterexample, I am going to claim that the twinsem approach cannot be generalized to more complicated models. I accept a concrete formal model definition as counterargument to my claim. ;) but not some vague sketch on the level of "something like twinsem".</p>



<a name="277931039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277931039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277931039">(Apr 05 2022 at 19:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277916660">said</a>:</p>
<blockquote>
<p>Saying a unusable pointer result is a plausible interpretation of the intent of the less formal English in C17 and prior is stretching the definition of plausible.</p>
</blockquote>
<p>I agree that C compilers are extremely unlikely to give you an invalid pointer here. I guess the standard is simply underspecified. But C17 is pretty formal here:</p>
<blockquote>
<p>any valid pointer to <code>void</code> can be converted to this type, then converted back to pointer to <code>void</code>, and the result will compare equal to the original pointer</p>
</blockquote>
<p>If "equality comparison" here doesn't refer to <code>==</code>, I don't know what it is. And by <a href="https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html">https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html</a> , we know that <code>==</code> pointers are in general definitely not equivalent.</p>
<p>Probably just an unfortunate formulation by the authors, and my expectations w.r.t. formality of the standard are too high :3</p>



<a name="277955951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277955951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277955951">(Apr 05 2022 at 23:04)</a>:</h4>
<blockquote>
<p>I really hope we don't get in the business of doing optimizations like that. That is the sort of thing that makes devs hate compiler writers</p>
</blockquote>
<p>Yes but in Rust we're at much better position than C to do that (or even not emit <code>ud2</code>).</p>



<a name="277962101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277962101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> riking <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277962101">(Apr 06 2022 at 00:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="340138">Chayim Refael Friedman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/277955951">said</a>:</p>
<blockquote>
<p>Yes but in Rust we're at much better position than C to do that (or even not emit <code>ud2</code>).</p>
</blockquote>
<p>One of the things I like most about Rust is the recognition that "No diagnostic is required" is bad!</p>



<a name="277966582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/277966582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#277966582">(Apr 06 2022 at 01:54)</a>:</h4>
<blockquote>
<p>One of the things I like most about Rust is the recognition that "No diagnostic is required" is bad!</p>
</blockquote>
<p>Are you talking about diagnosing UBs? Because this is hard to impossible to do reliably at compile time.</p>



<a name="278381483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381483">(Apr 09 2022 at 02:01)</a>:</h4>
<p>I have an optimization that exploits strict provenance AIUI:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">xpi</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">xp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span><span class="p">(</span><span class="n">xpi</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278381537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381537">(Apr 09 2022 at 02:02)</a>:</h4>
<p>Is it OK to optimize the last statement to the constant 1764 (42 * 42)?</p>



<a name="278381546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381546">(Apr 09 2022 at 02:02)</a>:</h4>
<p>that one does a ptr-to-int transmute. as I keep saying, those are just Cursed.</p>



<a name="278381562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381562">(Apr 09 2022 at 02:03)</a>:</h4>
<p>Note that you could replace transmute with a call to an opaque C function <code>transmewt()</code> that just does a transmute under the hood.</p>



<a name="278381573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381573">(Apr 09 2022 at 02:03)</a>:</h4>
<p>So the compiler can't special case the name <code>mem::transmute</code>.</p>



<a name="278381580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381580">(Apr 09 2022 at 02:03)</a>:</h4>
<p>yeah sure</p>



<a name="278381588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381588">(Apr 09 2022 at 02:04)</a>:</h4>
<p>well it can if you do call <code>transmute</code></p>



<a name="278381629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381629">(Apr 09 2022 at 02:04)</a>:</h4>
<p>hmm, I suppose this is special in a sense because it's a newly created reference</p>



<a name="278381660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381660">(Apr 09 2022 at 02:05)</a>:</h4>
<p>literal <code>let x: something with an int = mem::transmute(something with a pointer)</code> is the easy case that could be special cased in general</p>



<a name="278381663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381663">(Apr 09 2022 at 02:05)</a>:</h4>
<p>this is all covered by what I wrote <a href="https://www.reddit.com/r/rust/comments/tu5bw4/new_experimental_unsafe_rust_api_in_nightly/i3469k8/">before</a> which I thought you agreed with ;)<br>
if you do ptr-to-int transmutes, that is "wild provenance", not "permissive provenance". my claim about it being easy to ensure we dont do any optimizations that break code is for "permissive provenance". I think "wild provenance" is fundamentally impossible to support without global cost -- as in, <em>the entire program</em> has to be pessimized if wild provenance is to be used anywhere. there is no "gradual migration" or so.</p>



<a name="278381719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381719">(Apr 09 2022 at 02:06)</a>:</h4>
<p>but in general that example could just be <code>fn uninlined_foo(x: *mut i32) -&gt; usize</code> if you are thinking of it as an opaque C function</p>



<a name="278381730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381730">(Apr 09 2022 at 02:06)</a>:</h4>
<p>if you call an opaque function the compiler ofc has to be correct for <em>any</em> possible implementation of that function that can be expressed in the Rust AM. the Rust AM can express <code>expose_addr</code>, so the compilation has to be correct if that C function does the equivalent of <code>expose_addr</code>, and hence the optimization cannot happen.</p>



<a name="278381733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381733">(Apr 09 2022 at 02:07)</a>:</h4>
<p>But isn't all code wild provenance if you have an FFI? Because you could launder a ptr-to-int transmute through FFI.</p>



<a name="278381741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381741">(Apr 09 2022 at 02:07)</a>:</h4>
<p>no FFI is a complete red herring</p>



<a name="278381742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381742">(Apr 09 2022 at 02:07)</a>:</h4>
<p>no idea why people keep bringing it up^^</p>



<a name="278381744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381744">(Apr 09 2022 at 02:07)</a>:</h4>
<p>the name <code>transmute</code> is a red herring tbh</p>



<a name="278381749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381749">(Apr 09 2022 at 02:07)</a>:</h4>
<p>the issue is the pointer pun case</p>



<a name="278381759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381759">(Apr 09 2022 at 02:07)</a>:</h4>
<p>well those are both issues, just orthogonal ones ;)</p>



<a name="278381762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381762">(Apr 09 2022 at 02:08)</a>:</h4>
<p>(and thus since transmute is defined somewhat as a pun, it's an issue)</p>



<a name="278381813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381813">(Apr 09 2022 at 02:09)</a>:</h4>
<p>when you call an FFI function (a truly opaque one, no xLTO), the promise you make to the compiler is that "the effects of this function on the AM state can be described by <em>some</em> regular AM code. that's it.</p>



<a name="278381822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381822">(Apr 09 2022 at 02:09)</a>:</h4>
<p>so if that thing is implemented in assembly as the identity function, and you declare that the effect on the AM state is the expose the input pointer and then return its address -- that is coherent, and compilation has to be correct for that case.</p>



<a name="278381829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381829">(Apr 09 2022 at 02:09)</a>:</h4>
<p>anyways, if you replace that transmute with <code>ffi(&amp;mut *xp)</code> or <code>&amp;mut *xp as *mut i32 as usize</code> then that snippet very much cannot be optimized without strict provenance</p>



<a name="278381873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381873">(Apr 09 2022 at 02:10)</a>:</h4>
<p>if you declare that the effect on the AM state is just to return the address without exposing, that is also coherent.<br>
its your choice though, and you are not telling the compiler your choice, so as long as <em>any</em> choice does what you want, you are good.</p>



<a name="278381884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381884">(Apr 09 2022 at 02:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278381829">said</a>:</p>
<blockquote>
<p>anyways, if you replace that transmute with <code>ffi(&amp;mut *xp)</code> or <code>&amp;mut *xp as *mut i32 as usize</code> then that snippet very much cannot be optimized without strict provenance</p>
</blockquote>
<p>with <code>ffi</code> it cannot be optimized even with strict provenance</p>



<a name="278381887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381887">(Apr 09 2022 at 02:11)</a>:</h4>
<p>I guess I'm not understanding what your proposed semantics for <code>mem::transmute</code> are. Does <code>mem::transmute</code> expose addresses that are transmuted?</p>



<a name="278381899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381899">(Apr 09 2022 at 02:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278381887">said</a>:</p>
<blockquote>
<p>I guess I'm not understanding what your proposed semantics for <code>mem::transmute</code> are. Does <code>mem::transmute</code> expose addresses that are transmuted?</p>
</blockquote>
<p>no</p>



<a name="278381907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381907">(Apr 09 2022 at 02:11)</a>:</h4>
<p>the proposed semantics for your transmute are that it's UB because you are producing an integer value that has provenance</p>



<a name="278381951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278381951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278381951">(Apr 09 2022 at 02:12)</a>:</h4>
<p>(yes we could add special exceptions for very particular monomorphizations of transmute, that doesnt change the general point)</p>



<a name="278382025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382025">(Apr 09 2022 at 02:14)</a>:</h4>
<p>OK, so <code>mem::transmute::&lt;*mut T, usize&gt;</code> is different from <code>expose_addr</code>.</p>



<a name="278382036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382036">(Apr 09 2022 at 02:14)</a>:</h4>
<p><em>yes</em></p>



<a name="278382047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382047">(Apr 09 2022 at 02:15)</a>:</h4>
<p>maybe I should have said that more explicitly? I kept saying ptr-to-int transmutes should be UB so I thought them being different from <code>expose_addr</code> was implied ;)</p>



<a name="278382291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382291">(Apr 09 2022 at 02:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278382025">said</a>:</p>
<blockquote>
<p>OK, so <code>mem::transmute::&lt;*mut T, usize&gt;</code> is different from <code>expose_addr</code>.</p>
</blockquote>
<p>and while we could hack around that by special-casing <code>mem::transmute</code> for certain types, the issue remains with the following function that is still different from <code>expose_addr</code> (and I dont know how to fix that without a global cost):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">my_transmute</span><span class="p">(</span><span class="n">x</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">usize</span><span class="p">).</span><span class="n">read</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278382347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382347">(Apr 09 2022 at 02:22)</a>:</h4>
<p>OK, I get it now, thanks. I think you're right that under a permissive provenance model, strict provenance optimizations work as long as they treat <code>ptr as usize</code>/<code>usize as ptr</code> as effectively opaque function calls.</p>



<a name="278382378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382378">(Apr 09 2022 at 02:23)</a>:</h4>
<p>strict provenance optimizations, including the ones LLVM has been doing since forever ;)</p>



<a name="278382423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382423">(Apr 09 2022 at 02:24)</a>:</h4>
<p>I'm not 100% sure LLVM isn't paying that cost already modulo bugs, but that would require more clarity on what are bugs and what are unplanned changes to the spec</p>



<a name="278382434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382434">(Apr 09 2022 at 02:24)</a>:</h4>
<p>well, it's certainly possible to have an LLVM where we dont pay that cost</p>



<a name="278382451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382451">(Apr 09 2022 at 02:25)</a>:</h4>
<p>ofc, there is no telling where LLVM will actually move, and as you say its current spec isnt precise enough to distinguish this</p>



<a name="278382502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382502">(Apr 09 2022 at 02:26)</a>:</h4>
<p>yeah, LangRef certainly permits it afaict, but that doesn't mean optimization passes might not intentionally break code that does it</p>



<a name="278382508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382508">(Apr 09 2022 at 02:26)</a>:</h4>
<p>and if they fix the bugs by treating <code>ptrtoint</code> as a side-effecting operation, we can lobby for them to add a variant that does <em>not</em> have the side-effect so that Rust's <code>addr</code> can still get All The Optimizations ;)</p>



<a name="278382511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382511">(Apr 09 2022 at 02:26)</a>:</h4>
<p>I guess under a "global strict provenance" regime, where we can assume the entire codebase uses strict provenance, you could imagine doing the optimization on this code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">xpi</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">addr</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span><span class="p">(</span><span class="n">xpi</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278382514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382514">(Apr 09 2022 at 02:26)</a>:</h4>
<p>on <code>addr</code> I think we can always do it</p>



<a name="278382516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382516">(Apr 09 2022 at 02:26)</a>:</h4>
<p>but not on <code>expose_addr</code></p>



<a name="278382517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382517">(Apr 09 2022 at 02:26)</a>:</h4>
<p>Right</p>



<a name="278382519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382519">(Apr 09 2022 at 02:26)</a>:</h4>
<p>well, you can do that even without global strict provenance as long as <code>addr()</code> has its own intrinsic to lower to</p>



<a name="278382520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382520">(Apr 09 2022 at 02:27)</a>:</h4>
<p>since it would be illegal under global-strict-provenance for <code>bar</code> to dereference <code>xpi</code>.</p>



<a name="278382526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382526">(Apr 09 2022 at 02:27)</a>:</h4>
<p>the <code>addr</code> docs now even explicilty say that you cannot cast this int back to a dereferencable ptr</p>



<a name="278382529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382529">(Apr 09 2022 at 02:27)</a>:</h4>
<p>Also that nobody else can, not even C code you call.</p>



<a name="278382530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382530">(Apr 09 2022 at 02:27)</a>:</h4>
<p>(or the OS kernel.)</p>



<a name="278382535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382535">(Apr 09 2022 at 02:27)</a>:</h4>
<p>so I think it is illegal period. that's just what the docs for that method say.</p>



<a name="278382540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382540">(Apr 09 2022 at 02:27)</a>:</h4>
<p>yes. as I said above, FFI operations have to be describable by something <em>that AM code could do</em></p>



<a name="278382581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382581">(Apr 09 2022 at 02:28)</a>:</h4>
<p>that's like how not even FFI code can write to data behind <code>&amp;T</code></p>



<a name="278382586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382586">(Apr 09 2022 at 02:28)</a>:</h4>
<p>(in the sense of, if FFI code does that it's UB)</p>



<a name="278382591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382591">(Apr 09 2022 at 02:28)</a>:</h4>
<p>(UnsafeCell exceptions apply)</p>



<a name="278382597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382597">(Apr 09 2022 at 02:28)</a>:</h4>
<p>But old code couldn't be using <code>addr</code> because it didn't exist, so there shouldn't be a back compat hazard in this case.</p>



<a name="278382603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382603">(Apr 09 2022 at 02:29)</a>:</h4>
<p>yes that is exactly the plan :)</p>



<a name="278382606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382606">(Apr 09 2022 at 02:29)</a>:</h4>
<p>Cool, I like it :)</p>



<a name="278382610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382610">(Apr 09 2022 at 02:29)</a>:</h4>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="278382618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382618">(Apr 09 2022 at 02:29)</a>:</h4>
<p>Thanks for patiently explaining it to me as always :)</p>



<a name="278382688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382688">(Apr 09 2022 at 02:30)</a>:</h4>
<p>sure. :) happy to get more stakeholders on board :D</p>



<a name="278382692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382692">(Apr 09 2022 at 02:31)</a>:</h4>
<p>I think this is an example of a "carrot and not stick" optimization that I was talking about. Since <code>addr</code> didn't exist before, we can actually tell programmers that you can get new optimizations by migrating your <code>ptr as usize</code> to <code>.addr()</code>.</p>



<a name="278382702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382702">(Apr 09 2022 at 02:31)</a>:</h4>
<p>When it's safe to do so, of course.</p>



<a name="278382709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382709">(Apr 09 2022 at 02:31)</a>:</h4>
<p>the main backcompat hazard I am worried about are those cursed ptr-to-int transmutes. I dont have a good fallback plan for those, if it somehow turns out we absolutely must allow them.</p>



<a name="278382760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382760">(Apr 09 2022 at 02:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278382692">said</a>:</p>
<blockquote>
<p>I think this is an example of a "carrot and not stick" optimization that I was talking about. Since <code>addr</code> didn't exist before, we can actually tell programmers that you can get new optimizations by migrating your <code>ptr as usize</code> to <code>.addr()</code>.</p>
</blockquote>
<p>yes, indeed. I thought I had tried to express that when you brought up carrots and sticks a few days ago but maybe I imagined it, or I didnt express myself very clearly.</p>



<a name="278382772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382772">(Apr 09 2022 at 02:32)</a>:</h4>
<p>I'm guessing treating transmute as implicitly exposing the addresses of any pointers transmuted is just way too imprecise?</p>



<a name="278382775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382775">(Apr 09 2022 at 02:32)</a>:</h4>
<p>though its not new optimizations you get. its the ones you already got but shouldnt have gotten. ;)</p>



<a name="278382797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382797">(Apr 09 2022 at 02:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278382772">said</a>:</p>
<blockquote>
<p>I'm guessing treating transmute as implicitly exposing the addresses of any pointers transmuted is just way too imprecise?</p>
</blockquote>
<p>consider the <code>my_transmute</code> -- that's just a raw ptr load. the compiler doesn't even know that a transmute is going on.<br>
do we want every raw ptr load to expose things? that means even if the result of the load is unused, we have to preserve this expose side-effect since some other code might rely on it!</p>



<a name="278382802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382802">(Apr 09 2022 at 02:33)</a>:</h4>
<p>Yeah, too imprecise</p>



<a name="278382875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382875">(Apr 09 2022 at 02:35)</a>:</h4>
<p>FWIW, that is kinda what PNVI-ae-udi says C should do. I am curious how that will pan out.</p>



<a name="278382889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382889">(Apr 09 2022 at 02:35)</a>:</h4>
<p>C is in a slightly better position since <code>my_transmute</code> is already UB due to strict provenance</p>



<a name="278382891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382891">(Apr 09 2022 at 02:35)</a>:</h4>
<p>so it's not <em>every</em> pointer load for them</p>



<a name="278382938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382938">(Apr 09 2022 at 02:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278382775">said</a>:</p>
<blockquote>
<p>though its not new optimizations you get. its the ones you already got but shouldnt have gotten. ;)</p>
</blockquote>
<p>Are you sure LLVM is aggressive here? I just tried this in C++ and LLVM was conservative: <a href="https://godbolt.org/z/fT14a9Pdf">https://godbolt.org/z/fT14a9Pdf</a></p>



<a name="278382946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278382946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278382946">(Apr 09 2022 at 02:36)</a>:</h4>
<p>Which I would expect: treating the address of <code>x</code> as not exposed would probably break C++ code left and right</p>



<a name="278383033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383033">(Apr 09 2022 at 02:38)</a>:</h4>
<p>it's very hard to explore this with concrete examples</p>



<a name="278383040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383040">(Apr 09 2022 at 02:39)</a>:</h4>
<p>the best I got is a series of transformations all of which LLVM considers legal, that would break some such code</p>



<a name="278383043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383043">(Apr 09 2022 at 02:39)</a>:</h4>
<p>and Rust doesn't either: <a href="https://godbolt.org/z/bqox7Yx4x">https://godbolt.org/z/bqox7Yx4x</a></p>



<a name="278383046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383046">(Apr 09 2022 at 02:39)</a>:</h4>
<p>actually making LLVM do all these optimizations in the right order could be very tricky</p>



<a name="278383048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383048">(Apr 09 2022 at 02:39)</a>:</h4>
<p>but that's an accident, not for any good reason</p>



<a name="278383050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383050">(Apr 09 2022 at 02:39)</a>:</h4>
<p>Yeah, I think because LLVM is conservative about provenance out of fear of breaking working code.</p>



<a name="278383057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383057">(Apr 09 2022 at 02:39)</a>:</h4>
<p>But if we have <code>addr</code>, then we don't have to be as conservative. I hope anyway!</p>



<a name="278383062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383062">(Apr 09 2022 at 02:40)</a>:</h4>
<p>Which is great, it means we can go fast</p>



<a name="278383096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383096">(Apr 09 2022 at 02:40)</a>:</h4>
<p>we do have <em>some</em> concrete examples where it is not conservative enough</p>



<a name="278383106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383106">(Apr 09 2022 at 02:40)</a>:</h4>
<p>Yeah, I don't doubt it</p>



<a name="278383109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383109">(Apr 09 2022 at 02:40)</a>:</h4>
<p><a href="https://bugs.llvm.org/show_bug.cgi?id=35229">https://bugs.llvm.org/show_bug.cgi?id=35229</a><br>
<a href="https://bugs.llvm.org/show_bug.cgi?id=34548">https://bugs.llvm.org/show_bug.cgi?id=34548</a></p>



<a name="278383113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383113">(Apr 09 2022 at 02:40)</a>:</h4>
<p>but those are all artificially crafted</p>



<a name="278383117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383117">(Apr 09 2022 at 02:40)</a>:</h4>
<p>It would be basically this <a href="https://godbolt.org/z/qr54WdGz3">https://godbolt.org/z/qr54WdGz3</a></p>



<a name="278383119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383119">(Apr 09 2022 at 02:40)</a>:</h4>
<p>it's super hard to have real-world code examples as I doubt any real code affected by this would even notice that's what is going on</p>



<a name="278383122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383122">(Apr 09 2022 at 02:40)</a>:</h4>
<p>I suspect there's real code out there that would go faster if we could be more aggressive about provenance-based optimizations.</p>



<a name="278383124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383124">(Apr 09 2022 at 02:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383048">said</a>:</p>
<blockquote>
<p>but that's an accident, not for any good reason</p>
</blockquote>
<p>Note that lccc has a similar thing, but as a design feature - plugins should be valid to run in any order as long as the frontend is first and codegen is last.</p>



<a name="278383127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383127">(Apr 09 2022 at 02:41)</a>:</h4>
<p>Which would be a lovely outcome of this work, and I think it would excite people :)</p>



<a name="278383128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383128">(Apr 09 2022 at 02:41)</a>:</h4>
<p>they'd just assume it's UB in their code and fiddle with it until it works</p>



<a name="278383136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383136">(Apr 09 2022 at 02:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383124">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383048">said</a>:</p>
<blockquote>
<p>but that's an accident, not for any good reason</p>
</blockquote>
<p>Note that lccc has a similar thing, but as a design feature - plugins should be valid to run in any order as long as the frontend is first and codegen is last.</p>
</blockquote>
<p>yeah I think that's in theory also true for LLVM. but in practice...</p>



<a name="278383202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383202">(Apr 09 2022 at 02:42)</a>:</h4>
<p>so I hope lccc does <em>not</em> have the thing where sequencing optimizations in the right order (even if they dont ever actually happen in that order) leads to buggy results :D</p>



<a name="278383205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383205">(Apr 09 2022 at 02:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383122">said</a>:</p>
<blockquote>
<p>I suspect there's real code out there that would go faster if we could be more aggressive about provenance-based optimizations.</p>
</blockquote>
<p>yeah, I hope it can help in particular around ptr tagging code</p>



<a name="278383208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383208">(Apr 09 2022 at 02:43)</a>:</h4>
<p>And because you opt in, not opt out, we can introduce these optimizations without fear of breakage. (I guess C++ could too by introducing new types of casts, like <code>addr_cast</code> or whatever.)</p>



<a name="278383215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383215">(Apr 09 2022 at 02:43)</a>:</h4>
<p>but I am not an expert on what limits compilers when analyzing such code</p>



<a name="278383223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383223">(Apr 09 2022 at 02:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383202">said</a>:</p>
<blockquote>
<p>so I hope lccc does <em>not</em> have the thing where sequencing optimizations in the right order (even if they dont ever actually happen in that order) leads to buggy results :D</p>
</blockquote>
<p>I'll make sure to run the builtin optimizers in random configurations as a test suite.</p>



<a name="278383224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383224">(Apr 09 2022 at 02:43)</a>:</h4>
<p>Main thing is that an ptr-to-int transmute is UB in C without <code>-f-no-strict-aliasing</code>.</p>



<a name="278383265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383265">(Apr 09 2022 at 02:44)</a>:</h4>
<p>But even with, clang miscompiles this, weird</p>



<a name="278383267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383267">(Apr 09 2022 at 02:44)</a>:</h4>
<p>Come to think of it, that would be a nice blog post to write, maybe I'll do that.</p>



<a name="278383272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383272">(Apr 09 2022 at 02:44)</a>:</h4>
<p>"Why you should use <code>.addr()</code>: better optimizations in the future"</p>



<a name="278383273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383273">(Apr 09 2022 at 02:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383223">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383202">said</a>:</p>
<blockquote>
<p>so I hope lccc does <em>not</em> have the thing where sequencing optimizations in the right order (even if they dont ever actually happen in that order) leads to buggy results :D</p>
</blockquote>
<p>I'll make sure to run the builtin optimizers in random configurations as a test suite.</p>
</blockquote>
<p>now you just need the test suite to decide whether the performed optimization is correct. which is only a little harder than the halting problem. ;)</p>



<a name="278383294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383294">(Apr 09 2022 at 02:45)</a>:</h4>
<p>Because sometimes you just want the address of a pointer because you're printing it or using it as a hash table key or something, but you aren't ever going to turn that address back into a pointer, and right now we have at least one example of LLVM pessimizing such code because it doesn't know what you're going to do with it.</p>



<a name="278383295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383295">(Apr 09 2022 at 02:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383224">said</a>:</p>
<blockquote>
<p>Main thing is that an ptr-to-int transmute is UB in C without <code>-f-no-strict-aliasing</code>.</p>
</blockquote>
<p>no that's not true. there are some legal ways to type-pun.</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">uintptr_t</span><span class="w"> </span><span class="nf">my_transmute</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is allowed. does it 'expose' <code>x</code>? no idea.</p>



<a name="278383360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383360">(Apr 09 2022 at 02:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383273">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383223">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383202">said</a>:</p>
<blockquote>
<p>so I hope lccc does <em>not</em> have the thing where sequencing optimizations in the right order (even if they dont ever actually happen in that order) leads to buggy results :D</p>
</blockquote>
<p>I'll make sure to run the builtin optimizers in random configurations as a test suite.</p>
</blockquote>
<p>now you just need the test suite to decide whether the performed optimization is correct. which is only a little harder than the halting problem. ;)</p>
</blockquote>
<p>Well, probably it will just be handed the language test suites.</p>



<a name="278383365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383365">(Apr 09 2022 at 02:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383267">said</a>:</p>
<blockquote>
<p>Come to think of it, that would be a nice blog post to write, maybe I'll do that.</p>
</blockquote>
<p>yeah, having blog posts on this from more parts of the community would be great :D</p>



<a name="278383505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383505">(Apr 09 2022 at 02:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383265">said</a>:</p>
<blockquote>
<p>But even with, clang miscompiles this, weird</p>
</blockquote>
<p>I cant read assembly. can you tell me where there is a miscompilation in your example? :D</p>



<a name="278383526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383526">(Apr 09 2022 at 02:51)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1764</span><span class="w"></span>
<span class="n">pop</span><span class="w">     </span><span class="n">rcx</span><span class="w"></span>
</code></pre></div>
<p>Basically clang optimizes out the x * x into 42 * 42.</p>



<a name="278383532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383532">(Apr 09 2022 at 02:51)</a>:</h4>
<p>WIth standard C it works tho, <a href="https://godbolt.org/z/aYTh7KaKa">https://godbolt.org/z/aYTh7KaKa</a></p>



<a name="278383675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383675">(Apr 09 2022 at 02:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278383117">said</a>:</p>
<blockquote>
<p>It would be basically this <a href="https://godbolt.org/z/qr54WdGz3">https://godbolt.org/z/qr54WdGz3</a></p>
</blockquote>
<p>But wait, that doesn't pass the address of <code>x</code>, that dereferences <code>xp</code>, right?</p>



<a name="278383682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383682">(Apr 09 2022 at 02:56)</a>:</h4>
<p>Seems like a straightforward case of deleting UB, not provenance</p>



<a name="278383735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383735">(Apr 09 2022 at 02:56)</a>:</h4>
<p>Derp, yeah the actual one is fine <a href="https://godbolt.org/z/c55r43Tsq">https://godbolt.org/z/c55r43Tsq</a></p>



<a name="278383738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383738">(Apr 09 2022 at 02:56)</a>:</h4>
<p>You loaded 64 bits of a 32-bit stack address.</p>



<a name="278383740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383740">(Apr 09 2022 at 02:56)</a>:</h4>
<p>OK :)</p>



<a name="278383758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383758">(Apr 09 2022 at 02:57)</a>:</h4>
<p>(I love the way LLVM was just "yeah, no" and deleted the invalid load) :)</p>



<a name="278383815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383815">(Apr 09 2022 at 02:59)</a>:</h4>
<p>Another obvious, though probably silly, theoretical optimization that would depend on strict provenance would be to delete any ptr-to-int transmutes, as well as <code>ptr as usize</code>, as dead code. :)</p>



<a name="278383822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383822">(Apr 09 2022 at 02:59)</a>:</h4>
<p>(Not suggesting we do this for obvious reasons, though it would be valid)</p>



<a name="278383897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383897">(Apr 09 2022 at 03:00)</a>:</h4>
<p>Or just replace <code>ptr as usize</code> with <code>0</code>, I guess.</p>



<a name="278383938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383938">(Apr 09 2022 at 03:00)</a>:</h4>
<p>ptr-to-int transmutes are still <em>sometimes</em> okay. like, you can transmute <code>ptr::invalid</code> to an int just fine. ;)</p>



<a name="278383964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383964">(Apr 09 2022 at 03:01)</a>:</h4>
<p>It's the int-to-ptr transmute that's more painful, because we could just allow ptr-to-int and say its <code>addr()</code>.</p>



<a name="278383970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278383970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278383970">(Apr 09 2022 at 03:02)</a>:</h4>
<p>no that's not trivial either</p>



<a name="278384010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384010">(Apr 09 2022 at 03:02)</a>:</h4>
<p>Oh?</p>



<a name="278384016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384016">(Apr 09 2022 at 03:02)</a>:</h4>
<p>Deleting obvious UB <em>can</em> be useful if it can never happen dynamically (perhaps due to monomorphized code where the types are constant only during monomorphized codegen), just as a code size win, though I expect the effects would be small.</p>



<a name="278384017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384017">(Apr 09 2022 at 03:02)</a>:</h4>
<p>it violates the property that tranmsute T ‚Üí U ‚Üí T can be replaced by just doing nothing. or at least, it makes that argument a lot more complicated.</p>



<a name="278384035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384035">(Apr 09 2022 at 03:03)</a>:</h4>
<p>also I expect people doing such transmutes will expect that after transmuting back they can dereference that pointer</p>



<a name="278384036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384036">(Apr 09 2022 at 03:03)</a>:</h4>
<p>And sometimes replacing obvious UB with <code>ud2</code> can be a last-ditch security win, though you never want to rely on it.</p>



<a name="278384040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384040">(Apr 09 2022 at 03:03)</a>:</h4>
<p>so while it allows more code, it still defies user expectations</p>



<a name="278384043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384043">(Apr 09 2022 at 03:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278384040">said</a>:</p>
<blockquote>
<p>so while it allows more code, it still defies user expectations</p>
</blockquote>
<p>Agreed</p>



<a name="278384087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384087">(Apr 09 2022 at 03:04)</a>:</h4>
<p>Definitely</p>



<a name="278384367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384367">(Apr 09 2022 at 03:12)</a>:</h4>
<p>I think a more realistic optimization opportunity would look like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">spawn_monster</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Box</span><span class="o">&lt;</span><span class="n">Monster</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">monster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">Monster</span>::<span class="n">new</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">monster</span><span class="p">.</span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"monster at address {} spawned"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">monster</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">monster</span><span class="p">.</span><span class="n">hp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">monster</span><span class="p">.</span><span class="n">level</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">monster</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278384380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384380">(Apr 09 2022 at 03:13)</a>:</h4>
<p>where the compiler should be able to optimize <code>monster.hp = monster.level * 10</code> to <code>monster.hp = 100</code>, but in practice often will not because it doesn't know that the <code>println</code> won't dereference the address</p>



<a name="278384390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384390">(Apr 09 2022 at 03:14)</a>:</h4>
<p>whereas if you use <code>.addr()</code>, the compiler should be able to do that optimization</p>



<a name="278384743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384743">(Apr 09 2022 at 03:23)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="278384865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278384865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278384865">(Apr 09 2022 at 03:26)</a>:</h4>
<p>That reminds me of an issue that pointed out how printing something after a loop makes the loop slower (because the print takes an address, and the address being taken reduced optimization) -- maybe it was <a href="https://github.com/rust-lang/rust/issues/49457">https://github.com/rust-lang/rust/issues/49457</a></p>
<p>I don't think that strict provenance fixes that, though.</p>



<a name="278444667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278444667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278444667">(Apr 10 2022 at 03:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278384367">said</a>:</p>
<blockquote>
<p>I think a more realistic optimization opportunity would look like this:</p>
</blockquote>
<p>And it's even more interesting if you say <code>println!("monster at address {:p} spawned", &amp;monster)</code> (imho) because the <code>.addr()</code> is in stdlib not user code</p>



<a name="278444684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278444684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278444684">(Apr 10 2022 at 03:03)</a>:</h4>
<p>(ah didn't realize that was yesterday I didn't get on yesterday)</p>



<a name="278472264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278472264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278472264">(Apr 10 2022 at 14:52)</a>:</h4>
<p>we need to specify whether <code>{:p}</code> does <code>addr</code> or <code>expose_addr</code>...</p>



<a name="278475784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278475784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278475784">(Apr 10 2022 at 16:09)</a>:</h4>
<p>I don‚Äôt see a reason to make it <code>expose_addr</code></p>



<a name="278477218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477218">(Apr 10 2022 at 16:36)</a>:</h4>
<p>let's hope <span class="user-mention" data-user-id="384014">@Patrick Walton</span> doesn't tell us they use <code>{:p}</code> and then parse back the address and deref that pointer and expect that to work for some unspeakable reason ;)</p>



<a name="278477270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477270">(Apr 10 2022 at 16:37)</a>:</h4>
<p>well, at least there isn't <code>impl FromStr for *mut T</code> to justify it like there is <code>scanf("%p")</code></p>



<a name="278477344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477344">(Apr 10 2022 at 16:38)</a>:</h4>
<p>I don't see a reason to <em>not</em> make it <code>expose_addr</code>. It's almost the definition of exposing an address (literally, to the user)</p>



<a name="278477377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477377">(Apr 10 2022 at 16:39)</a>:</h4>
<p>sure we could make it UB but it seems like a natural thing for a user to try</p>



<a name="278477455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477455">(Apr 10 2022 at 16:41)</a>:</h4>
<p>the main difference between <code>addr</code> and <code>expose_addr</code> from the compiler's end is that the latter is less likely to be optimized away, but in <code>{:p}</code> it's definitely not going anywhere</p>



<a name="278477460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477460">(Apr 10 2022 at 16:41)</a>:</h4>
<p>implementation-wise it's almost certainly going to be an expose and fmt certainly isn't super fast to start with</p>



<a name="278477523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477523">(Apr 10 2022 at 16:42)</a>:</h4>
<p>(fmt would have to add a feature to make <code>.addr()</code> called before virtualization and uninlined fmt machinery)</p>



<a name="278477528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477528">(Apr 10 2022 at 16:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278477455">said</a>:</p>
<blockquote>
<p>the main difference between <code>addr</code> and <code>expose_addr</code> from the compiler's end is that the latter is less likely to be optimized away, but in <code>{:p}</code> it's definitely not going anywhere</p>
</blockquote>
<p>there's also the key difference whether the compiler does have to account for the possibility that other code might to accesses with this pointer. and with <code>addr</code>, it doesn't. that can help a lot for alias analysis.</p>



<a name="278477554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477554">(Apr 10 2022 at 16:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278477523">said</a>:</p>
<blockquote>
<p>(fmt would have to add a feature to make <code>.addr()</code> called before virtualization and uninlined fmt machinery)</p>
</blockquote>
<p>hm okay that is fair, even with <code>addr</code> the compiler might have a real hard time telling that <code>expose_addr</code> isnt being called...</p>



<a name="278477690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477690">(Apr 10 2022 at 16:46)</a>:</h4>
<p>if the fmt traits weren't stable, it could instead be something like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Repr</span>: <span class="nc">Pointer2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">early_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Repr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">Pointer2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">same</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278477727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278477727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278477727">(Apr 10 2022 at 16:47)</a>:</h4>
<p>maybe if specialization ever becomes usable for associated types that could be added with backcompat and not needing magic trait lookup in format_args!()</p>



<a name="278480255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278480255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278480255">(Apr 10 2022 at 17:36)</a>:</h4>
<p>Having it be <code>expose_addr</code> could make it quite slow on CHERI.</p>



<a name="278480957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278480957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278480957">(Apr 10 2022 at 17:50)</a>:</h4>
<p><code>expose_addr</code> basically means it doesn't work on CEHRI (yes I know there are some ideas for getting <code>from_exposed_addr</code> to work on CHERI but they dont sound very realistic to me -- I'd be happy to be proven wrong though ;)</p>



<a name="278480967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278480967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278480967">(Apr 10 2022 at 17:50)</a>:</h4>
<p>as in, on CHERI <code>from_exposed_addr</code> cannot be called -- which means <code>addr</code> and <code>expose_addr</code> are the same</p>



<a name="278482493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278482493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278482493">(Apr 10 2022 at 18:23)</a>:</h4>
<p>And <code>expose_addr</code> would mean that <code>{:p}</code> doesn‚Äôt pass the <code>strict_provenance</code> lint. I expect that that would annoy users quite a bit</p>



<a name="278482577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278482577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278482577">(Apr 10 2022 at 18:25)</a>:</h4>
<p>‚Ä¶I think? Depends on how the lint is implemented</p>



<a name="278482742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278482742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278482742">(Apr 10 2022 at 18:29)</a>:</h4>
<p>I mentioned this on Ralf's PR but there is no need to consider <code>expose_addr</code> as violating <code>strict_provenance</code> and we shouldn't lint on it</p>



<a name="278482756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278482756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278482756">(Apr 10 2022 at 18:29)</a>:</h4>
<p><code>from_exposed_addr</code> is the only one to watch out for</p>



<a name="278482854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278482854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278482854">(Apr 10 2022 at 18:31)</a>:</h4>
<p>similarly we don't need to lint on <code>*const T as usize</code> except for the reason "stop using <code>as</code>, use these library functions instead to declare your intent" (which is not quite the same as violating <code>strict_provenance</code>)</p>



<a name="278482932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278482932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278482932">(Apr 10 2022 at 18:33)</a>:</h4>
<p>what's the point in <code>expose_addr</code> if there is no <code>from_exposed_addr</code> though ^^ If I want my code to be "strict provenance compliant" I would want to not be allowed to do <code>expose_addr</code>since it is meaningless</p>



<a name="278483157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278483157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278483157">(Apr 10 2022 at 18:38)</a>:</h4>
<p>because a library can be strict provenance compliant while also supporting non-SP user code</p>



<a name="278483173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278483173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278483173">(Apr 10 2022 at 18:39)</a>:</h4>
<p>if your code is strict provenance compliant then you don't have to care about <code>expose_addr</code> and can just pretend they are all <code>addr</code></p>



<a name="278483251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278483251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278483251">(Apr 10 2022 at 18:41)</a>:</h4>
<p>I think it  is quite reasonable for a conscientious library to choose explicitly to use <code>expose_addr</code> because they don't want to cause surprising UB for users, and also enable <code>strict_provenance</code> linting</p>



<a name="278485755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278485755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278485755">(Apr 10 2022 at 19:35)</a>:</h4>
<p>The biggest reason to be strict provenance compliant but use <code>expose_addr</code> would be that you previously used <code>as usize</code> and don't want to change the existing behavior</p>



<a name="278485827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278485827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278485827">(Apr 10 2022 at 19:36)</a>:</h4>
<p>E.g. there's nothing violating strict provenance in the implementation of <code>{:p}</code>, the point at which strict provenance is when you turn that representation back into a pointer and use it</p>



<a name="278486032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278486032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278486032">(Apr 10 2022 at 19:40)</a>:</h4>
<p>With the current formatting traits, it is possible to format a pointer without type erasing it</p>



<a name="278486295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278486295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278486295">(Apr 10 2022 at 19:46)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=1dcca7b6bf8b2ef2a29eebdb71e90dbb">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=1dcca7b6bf8b2ef2a29eebdb71e90dbb</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Evil</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Display</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Evil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">to_raw_parts</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">addr</span><span class="p">(),</span><span class="w"> </span><span class="n">meta</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Pointer</span>::<span class="n">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"> </span><span class="c1">// expose?</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span>::<span class="n">from_exposed_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span>::<span class="n">from_raw_parts</span>::<span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Display</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">ptr</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278486328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278486328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278486328">(Apr 10 2022 at 19:47)</a>:</h4>
<p>This is <em>very</em> artificial of course, but it shows that this <em>is</em> possible</p>



<a name="278490409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490409">(Apr 10 2022 at 21:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278477218">said</a>:</p>
<blockquote>
<p>let's hope <span class="user-mention silent" data-user-id="384014">Patrick Walton</span> doesn't tell us they use <code>{:p}</code> and then parse back the address and deref that pointer and expect that to work for some unspeakable reason ;)</p>
</blockquote>
<p><a href="https://zakaluka.github.io/2019/12/14/daily-coding-problem-6.html">https://zakaluka.github.io/2019/12/14/daily-coding-problem-6.html</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">address</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">elt</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">usize</span>::<span class="n">from_str_radix</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"{:p}"</span><span class="p">,</span><span class="w"> </span><span class="n">elt</span><span class="p">).</span><span class="n">trim_start_matches</span><span class="p">(</span><span class="s">"0x"</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278490435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490435">(Apr 10 2022 at 21:21)</a>:</h4>
<p>lol</p>
<blockquote>
<p>Problem 6 - XOR Linked List</p>
</blockquote>
<p>there's your problem...</p>



<a name="278490527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490527">(Apr 10 2022 at 21:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278477554">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278477523">said</a>:</p>
<blockquote>
<p>(fmt would have to add a feature to make <code>.addr()</code> called before virtualization and uninlined fmt machinery)</p>
</blockquote>
<p>hm okay that is fair, even with <code>addr</code> the compiler might have a real hard time telling that <code>expose_addr</code> isnt being called...</p>
</blockquote>
<p>If we are going to do inter-procedural analysis for address escaping, then this becomes no longer true</p>



<a name="278490534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490534">(Apr 10 2022 at 21:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278475784">said</a>:</p>
<blockquote>
<p>I don‚Äôt see a reason to make it <code>expose_addr</code></p>
</blockquote>
<p>Here's a reason: C does it.<br>
The rules for <code>scanf</code> (7.19.6.2 12) say that you can round-trip a pointer through <code>%p</code>.<br>
Granted, they only say that it must compare equal to the one that was passed to <code>printf</code>, but the current standard revision does not yet have a concept of provenance, so that's the best you can get.</p>
<p>We are of course not bound to do as C does, and in this case I think it's quite niche.</p>



<a name="278490576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490576">(Apr 10 2022 at 21:24)</a>:</h4>
<p>Although... if the <code>{:p}</code> ends up in libc, the analysis might end up having to conservatively assume it escapes</p>



<a name="278490603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490603">(Apr 10 2022 at 21:25)</a>:</h4>
<p>barring a magic "this doesn't escape" attribute on the FFI binding or something</p>



<a name="278490665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278490665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278490665">(Apr 10 2022 at 21:26)</a>:</h4>
<p>Yeah</p>



<a name="278491484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491484">(Apr 10 2022 at 21:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278490409">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278477218">said</a>:</p>
<blockquote>
<p>let's hope <span class="user-mention silent" data-user-id="384014">Patrick Walton</span> doesn't tell us they use <code>{:p}</code> and then parse back the address and deref that pointer and expect that to work for some unspeakable reason ;)</p>
</blockquote>
<p><a href="https://zakaluka.github.io/2019/12/14/daily-coding-problem-6.html">https://zakaluka.github.io/2019/12/14/daily-coding-problem-6.html</a></p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">address</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">elt</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">usize</span>::<span class="n">from_str_radix</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">"{:p}"</span><span class="p">,</span><span class="w"> </span><span class="n">elt</span><span class="p">).</span><span class="n">trim_start_matches</span><span class="p">(</span><span class="s">"0x"</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>uh... but.... WHY???  <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span></p>



<a name="278491531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491531">(Apr 10 2022 at 21:48)</a>:</h4>
<blockquote>
<p>Here's a reason: C does it.</p>
</blockquote>
<p>I'm already planning to diverge from C on the ptr-to-int transmute side, so -- not sure if that's a good enough argument</p>



<a name="278491540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491540">(Apr 10 2022 at 21:49)</a>:</h4>
<p>TBF they were a) learning Rust for the first time and b) implementing an XOR linked list</p>



<a name="278491607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491607">(Apr 10 2022 at 21:50)</a>:</h4>
<p>right but something must be <em>seriously</em> wrong with our docs if they go for <em>that</em> rather than <code>elt as *const _ as usize</code>...</p>



<a name="278491703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491703">(Apr 10 2022 at 21:53)</a>:</h4>
<p>Given they typically were using python, it looks like, it's not unlikely that it was an already known pattern for getting the address of an object</p>



<a name="278491711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491711">(Apr 10 2022 at 21:53)</a>:</h4>
<p>I'm not trying to justify it, just to guess why they would've used that as a solution</p>



<a name="278491789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491789">(Apr 10 2022 at 21:55)</a>:</h4>
<p>yeah</p>



<a name="278491799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491799">(Apr 10 2022 at 21:55)</a>:</h4>
<p>well, not sure if that is a good argument for <code>expose_addr</code> but indeed interesting to see what people will do. I expect people with so little Rust experience will break all of the aliasing rules so that code is probably a lost cause anyway in terms of UB...</p>



<a name="278491868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491868">(Apr 10 2022 at 21:57)</a>:</h4>
<p>It's typical for beginners to write UB in C, I think the only way we can definitely make things better is with warnings in the compiler <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="278491917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278491917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278491917">(Apr 10 2022 at 21:58)</a>:</h4>
<p>I can say run Miri all I want but it doesn't work on all code and it's not beginner-friendly, and it's possible to just miss that it exists</p>



<a name="278498263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278498263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wanja Hentze <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278498263">(Apr 11 2022 at 00:40)</a>:</h4>
<p>Warnings in the compiler and best-effort checks in debug mode</p>



<a name="278498960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278498960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278498960">(Apr 11 2022 at 00:58)</a>:</h4>
<p>I don't know how to do provenance checks in debug mode. I recently added a bunch of debug checks to the standard library so I'm up for adding more such things if you have ideas</p>



<a name="278499417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278499417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278499417">(Apr 11 2022 at 01:09)</a>:</h4>
<p>you can't...? Provenance checks can only be inserted by the compiler if you get lucky and can prove some static UB, or by a dynamic checker like Miri</p>



<a name="278499489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278499489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278499489">(Apr 11 2022 at 01:11)</a>:</h4>
<p>Yeah, unless you're on CHERI, MIRI, or some other high-level interpreter, Provenance is pure magic compiler shadow state that you can't really view at runtime.</p>



<a name="278500001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278500001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278500001">(Apr 11 2022 at 01:23)</a>:</h4>
<p>You totally could check it by altering codegen to emit something like all the shadow state that ASan uses</p>



<a name="278500051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278500051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278500051">(Apr 11 2022 at 01:24)</a>:</h4>
<p>It would not be easy and it would probably be slow, but that's different from impossible</p>



<a name="278500122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278500122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278500122">(Apr 11 2022 at 01:26)</a>:</h4>
<p>And if this is something like debug assertions which don't have any obligation to be sound, there may be enormous corners you can cut to make it more efficient</p>



<a name="278609115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278609115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278609115">(Apr 11 2022 at 20:06)</a>:</h4>
<p>I think <code>{:p}</code> should be <code>addr</code>. I highly doubt anyone is parsing addresses at runtime :)</p>



<a name="278609305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278609305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278609305">(Apr 11 2022 at 20:08)</a>:</h4>
<p>The closest thing that people actually do is dynamic linkers, or Apple's old implementation of GCC precompiled headers (which coredumps GCC after parsing the headers so that that coredump can be read in later and resumed), but in those cases the addresses are binary, not ASCII</p>



<a name="278611322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278611322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278611322">(Apr 11 2022 at 20:22)</a>:</h4>
<p>In a CHERI C world, the runtime linker (and the C startup code for static binaries) does the equivalent of with_addr to create all global pointers, PLTs, GOTs, etc in the relocation phase. The source pointers are provided by the ELF auxargs array or mmap depending on which part of the program you're dealing with.</p>



<a name="278624871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations%20that%20exploit%20strict%20provenance/near/278624871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance.html#278624871">(Apr 11 2022 at 22:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Optimizations.20that.20exploit.20strict.20provenance/near/278609115">said</a>:</p>
<blockquote>
<p>I think <code>{:p}</code> should be <code>addr</code>. I highly doubt anyone is parsing addresses at runtime :)</p>
</blockquote>
<p>you mean besides <a href="https://zakaluka.github.io/2019/12/14/daily-coding-problem-6.html">this example someone found in the wild</a> ;)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>