<html>
<head><meta charset="utf-8"><title>Atomic for function pointers? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html">Atomic for function pointers?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277230520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277230520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277230520">(Mar 31 2022 at 03:58)</a>:</h4>
<p>I have library code that casts an <code>extern "C" fn()</code> pointer into an <code>AtomicUsize</code> and back. I looked into making it work under strict provenance using <code>AtomicPtr</code>, but it seems that's limited to <code>*mut T</code> pointers, and there's currently no <code>AtomicFn</code>. Are there any other options?</p>



<a name="277540725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277540725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277540725">(Apr 02 2022 at 17:12)</a>:</h4>
<p>If an Oxford cast to <code>usize</code> was sufficiently good so far, an Oxford cast to <code>*mut ()</code> would be a provenance preserving alternative (which doesn't necessarily work for harvards)</p>



<a name="277540739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277540739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277540739">(Apr 02 2022 at 17:12)</a>:</h4>
<p><code>AtomicFn</code> isn't a thing because there isn't a (yet) type that allows arbitrary code pointers.</p>



<a name="277568212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277568212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277568212">(Apr 03 2022 at 03:48)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> ah you haven't seen my <del>joke</del> <del>non-</del>proposal of <code>unsafe fn(!)</code>,</p>



<a name="277568221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277568221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277568221">(Apr 03 2022 at 03:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="404395">Dan Gohman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F/near/277230520">said</a>:</p>
<blockquote>
<p>I have library code that casts an <code>extern "C" fn()</code> pointer into an <code>AtomicUsize</code> and back. I looked into making it work under strict provenance using <code>AtomicPtr</code>, but it seems that's limited to <code>*mut T</code> pointers, and there's currently no <code>AtomicFn</code>. Are there any other options?</p>
</blockquote>
<p>I would actually want <span class="user-mention" data-user-id="120791">@RalfJ</span>'s input on whether it's okay to <code>transmute</code> from <code>*mut u8</code> back to <code>fn()</code> - my intuition says "yes" but there might be caveats wrt how we might want to distinguish provenance between those two</p>



<a name="277568297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277568297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277568297">(Apr 03 2022 at 03:51)</a>:</h4>
<p>(alternatively, the question could be "do we want to assume <code>(f: fn()) as *mut u8</code> is equivalent to <code>transmute</code> or is there cause to avoid that?")</p>



<a name="277570239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277570239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277570239">(Apr 03 2022 at 04:23)</a>:</h4>
<p>given provenance is practically a compile time thing, is there any reason for fn pointers to have provenance in the first place? Any valid use on say x86 requires inline asm as a barrier as well, and in general any platform-specific effects you might want to fold into provenance aren't going to be automatically handled anyways.</p>



<a name="277570535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277570535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277570535">(Apr 03 2022 at 04:25)</a>:</h4>
<p>(actually I suppose it's not even inline asm, you need an mprotect syscall to go from RW to RX, and a compiler certainly can't migrate writes past the mprotect)</p>



<a name="277570853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277570853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277570853">(Apr 03 2022 at 04:28)</a>:</h4>
<p>(All of this is assuming self-modifying code / JIT, otherwise provenance is entirely irrelevant for readonly data)</p>



<a name="277627554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277627554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277627554">(Apr 03 2022 at 13:17)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I dont see any issue with allowing provenance in <code>fn()</code>. so yeah I'd think transmuting and casting from <code>fn()</code> to <code>*mut</code> or vice versa is completely lossless.</p>



<a name="277627628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277627628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277627628">(Apr 03 2022 at 13:18)</a>:</h4>
<p>but indeed as <span class="user-mention" data-user-id="143798">@Talchas</span> says there is also the question of whether <code>fn()</code> even have provenance. right now I dont think they need it on the AM. maybe they need they need it for CHERI. it seems safer to say yes they do have provenance, we can always relax this later if it becomes a problem.</p>



<a name="277627699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277627699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277627699">(Apr 03 2022 at 13:18)</a>:</h4>
<p>(in Miri they do have provenance and with strict provenance checking it will detect when you lose that)</p>



<a name="277641308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic%20for%20function%20pointers%3F/near/277641308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F.html#277641308">(Apr 03 2022 at 15:22)</a>:</h4>
<p>Function pointers definitely need provenance (bounds and execute permissions) for CHERI, but since we always represent them the same way as data pointers we can just cast between function and data pointers in C/C++. Well they are slightly different: function pointers have execute permissions and are generally marked as immutable, so any address manipulation will trap. But casting still works fine.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>