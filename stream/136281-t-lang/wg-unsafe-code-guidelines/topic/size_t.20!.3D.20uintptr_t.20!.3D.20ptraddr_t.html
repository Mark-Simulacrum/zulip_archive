<html>
<head><meta charset="utf-8"><title>size_t != uintptr_t != ptraddr_t · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html">size_t != uintptr_t != ptraddr_t</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274031585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274031585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274031585">(Mar 03 2022 at 20:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Int.20to.20pointer.20casts.20-.20union.20provenance.3F/near/274022959">said</a>:</p>
<blockquote>
<p>there are already stabilized things that imply that usize = uintptr, one more isn't going to hurt</p>
</blockquote>
<p>I'm vaguely curious, which such things do we have in stable? (Leaving aside the extensive code in the ecosystem making such an assumption.)</p>



<a name="274031704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274031704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274031704">(Mar 03 2022 at 20:07)</a>:</h4>
<p>Because while I have serious doubts that we could fix this, I also think <em>if</em> we decided to separate the two, for didactic reasons the path we'd want to take is <code>usize == size_t</code>, <code>uptr == uintptr_t</code>, rather than making <code>usize</code> not <code>size_t</code>.</p>



<a name="274033670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274033670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274033670">(Mar 03 2022 at 20:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Int.20to.20pointer.20casts.20-.20union.20provenance.3F/near/274031704">said</a>:</p>
<blockquote>
<p>Because while I have serious doubts that we could fix this, I also think <em>if</em> we decided to separate the two, for didactic reasons the path we'd want to take is <code>usize == size_t</code>, <code>uptr == uintptr_t</code>, rather than making <code>usize</code> not <code>size_t</code>.</p>
</blockquote>
<p>Okay so I have done some thought on this and the answer is <code>usize</code> is not necessarily <code>size_t</code> but it isn't necessarily <code>uintptr_t</code> either.<br>
It is a type that was not named before CHERI gave it one:<br>
<code>ptraddr_t</code></p>



<a name="274033835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274033835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274033835">(Mar 03 2022 at 20:22)</a>:</h4>
<p>It is <strong>almost</strong> always the case that <code>type_shape_eq(ptraddr_t, size_t)</code>.</p>



<a name="274033900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274033900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274033900">(Mar 03 2022 at 20:23)</a>:</h4>
<p>But it is also <strong>almost</strong> always the case that <code>type_shape_eq(ptraddr_t, uintptr_t)</code>.</p>



<a name="274034288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274034288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274034288">(Mar 03 2022 at 20:25)</a>:</h4>
<p>(should this be moved to a different topic/stream?)</p>



<a name="274034401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274034401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274034401">(Mar 03 2022 at 20:26)</a>:</h4>
<p>probably. :P I don't have authority to move it to another stream.</p>



<a name="274034641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274034641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274034641">(Mar 03 2022 at 20:27)</a>:</h4>
<p>There, another topic.</p>



<a name="274035418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274035418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274035418">(Mar 03 2022 at 20:32)</a>:</h4>
<p>CHERI is not actually the first architecture to say that a pointer is not just its memory address... but the last time that was a more <strong>typical</strong> attitude to take even on the <strong>hardware</strong> level was before, frankly, a wave of hackers who insisted that C is just a macro assembler arrived.</p>



<a name="274036598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274036598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274036598">(Mar 03 2022 at 20:41)</a>:</h4>
<p>If you can't turn a <code>ptraddr_t</code> back into a valid pointer, then it doesn't seem obvious that what people are doing with <code>usize</code> is equivalent to <code>ptraddr_t</code>. People often treat <code>usize</code> as a numeric type you can <em>round-trip</em> a pointer through losslessly. Assuming I'm understanding CHERI's distinction correctly, that would be <code>uintptr_t</code>, not <code>ptraddr_t</code>, right?</p>



<a name="274036756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274036756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274036756">(Mar 03 2022 at 20:42)</a>:</h4>
<p>You can find a ton of older systems where a pointer and an address are different, depending on the model, and what an "address" is defined as.<br>
A near pointer in 8086 isn't the same as a linear address.</p>



<a name="274036944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274036944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274036944">(Mar 03 2022 at 20:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274036598">said</a>:</p>
<blockquote>
<p>If you can't turn a <code>ptraddr_t</code> back into a valid pointer, then it doesn't seem obvious that what people are doing with <code>usize</code> is equivalent to <code>ptraddr_t</code>. People often treat <code>usize</code> as a numeric type you can <em>round-trip</em> a pointer through losslessly. Assuming I'm understanding CHERI's distinction correctly, that would be <code>uintptr_t</code>, not <code>ptraddr_t</code>, right?</p>
</blockquote>
<p>correct.<br>
the subtle distinction is that on a hypothetical combination of CHERI + segmented memory:<br>
size_t &lt; ptr_addr_t &lt; uintptr_t</p>



<a name="274036972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274036972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274036972">(Mar 03 2022 at 20:44)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> While I can <em>imagine</em> such a system, I sincerely hope nobody ever builds one.</p>



<a name="274037006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037006">(Mar 03 2022 at 20:44)</a>:</h4>
<p>w65 technically is that, because you could call <code>ptr_addr_t</code> there as <code>uint24_t</code>.</p>



<a name="274037007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037007">(Mar 03 2022 at 20:44)</a>:</h4>
<p>I agree fully that we can treat the difference as largely academic.</p>



<a name="274037069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037069">(Mar 03 2022 at 20:45)</a>:</h4>
<p>Also, likewise for 8086, if pointers are far pointers - <code>size_t</code> would be <code>uint16_t</code>, <code>ptr_addr_t</code> would be <code>uint20_t</code>, and <code>uintptr_t</code> would be <code>uint32_t</code>.</p>



<a name="274037105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037105">(Mar 03 2022 at 20:45)</a>:</h4>
<p>And while I am aware of and programmed for x86 segmented memory systems, I also think it's reasonable to write off segmented memory systems as something we simply don't support, or at least don't support using our standard types. I think it'd be fine if making Rust run on such a system required very careful code that avoided such assumptions, even while the Rust ecosystem <em>did</em> assume no segmentation.</p>



<a name="274037119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037119">(Mar 03 2022 at 20:46)</a>:</h4>
<p>(in a variant different form from the case of w65, where <code>uintptr_t</code> is just a zero-extended <code>ptr_addr_t</code>.</p>



<a name="274037261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037261">(Mar 03 2022 at 20:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274037069">said</a>:</p>
<blockquote>
<p>Also, likewise for 8086, if pointers are far pointers - <code>size_t</code> would be <code>uint16_t</code>, <code>ptr_addr_t</code> would be <code>uint20_t</code>, and <code>uintptr_t</code> would be <code>uint32_t</code>.</p>
</blockquote>
<p>I think both <code>ptraddr_t</code> and <code>uintptr_t</code> would be technically 20-bits, and I don't see why zero extension to 32-bits would be applied to one and not the other. Zero-extension in both cases would be a convenience, and zero-extension in neither case would make sense if trying to pack things as small as possible.</p>



<a name="274037345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037345">(Mar 03 2022 at 20:47)</a>:</h4>
<p>Yeah, the way I think of it as,<br>
usize != uintptr_t<br>
usize ≈ size_t</p>



<a name="274037533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037533">(Mar 03 2022 at 20:49)</a>:</h4>
<p>I think the only thing we should do is be careful of embedding "usize exactly equals size_t" into core.<br>
For the typical Rust programmer, usize <strong>is</strong> size_t.</p>



<a name="274037547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037547">(Mar 03 2022 at 20:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274037345">said</a>:</p>
<blockquote>
<p>Yeah, the way I think of it as,<br>
usize != uintptr_t<br>
usize ≈ size_t</p>
</blockquote>
<p>Right. I think that's the path we'd take forward iff we decide to make the tradeoff of supporting systems where size_t and uintptr_t aren't the same at the expense of breaking a lot of existing code.</p>



<a name="274037649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037649">(Mar 03 2022 at 20:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274037261">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274037069">said</a>:</p>
<blockquote>
<p>Also, likewise for 8086, if pointers are far pointers - <code>size_t</code> would be <code>uint16_t</code>, <code>ptr_addr_t</code> would be <code>uint20_t</code>, and <code>uintptr_t</code> would be <code>uint32_t</code>.</p>
</blockquote>
<p>I think both <code>ptraddr_t</code> and <code>uintptr_t</code> would be technically 20-bits, and I don't see why zero extension to 32-bits would be applied to one and not the other. Zero-extension in both cases would be a convenience, and zero-extension in neither case would make sense if trying to pack things as small as possible.</p>
</blockquote>
<p>Not zero extension here. If pointers are being treated as far pointers, then they'd be a (segment,offset) tuple, both <code>u16</code>s, so <code>uintptr_t</code> would be the <code>segment&lt;&lt;16|offset</code>, whereas <code>ptr_addr_t</code> would (in my mind) be a linear address from <code>segment+offset</code> or (in the case of protected mode, <code>GDT[segment].base+offset</code> (the latter makes it a uint36_t on 386+)</p>



<a name="274037653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037653">(Mar 03 2022 at 20:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274037533">said</a>:</p>
<blockquote>
<p>I think the only thing we should do is be careful of embedding "usize exactly equals size_t" into core.<br>
For the typical Rust programmer, usize <strong>is</strong> size_t.</p>
</blockquote>
<p>I agree with "be careful", but personally I think we <em>should</em> embed that assumption into core, precisely because it's what people widely assume, including from the name.</p>



<a name="274037807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037807">(Mar 03 2022 at 20:50)</a>:</h4>
<p>oh to be clear</p>



<a name="274037855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037855">(Mar 03 2022 at 20:51)</a>:</h4>
<p>what I mean is that I think libcore should compile for such a hypothetical Extremely Wonky system, not that its functions are useful</p>



<a name="274037875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037875">(Mar 03 2022 at 20:51)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> Ah, I see; you're treating uintptr_t as the <code>(u16, u16)</code> version, where you <em>might</em> have meaningful differences between two different segment/address pairs that map to the same linear address?</p>



<a name="274037900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274037900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274037900">(Mar 03 2022 at 20:51)</a>:</h4>
<p>Yes.</p>



<a name="274038044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038044">(Mar 03 2022 at 20:52)</a>:</h4>
<p>(And in that case, a roundtrip through <code>ptraddr_t</code> would be lossy at runtime, as it is for CHERI, notably "canonicalizing" the address)</p>



<a name="274038060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038060">(Mar 03 2022 at 20:52)</a>:</h4>
<p>importantly, usize == ptraddr_t means that usize can still contain the answer to<br>
"do these two pointers point at the same place in memory or not?"</p>



<a name="274038075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038075">(Mar 03 2022 at 20:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274038044">said</a>:</p>
<blockquote>
<p>(And in that case, a roundtrip through <code>ptraddr_t</code> would be lossy at runtime, as it is for CHERI, notably "canonicalizing" the address)</p>
</blockquote>
<p>(Assuming that canonicalizing is actually semantically lossy.)</p>



<a name="274038104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038104">(Mar 03 2022 at 20:53)</a>:</h4>
<p>if the answer is 0, then yes.</p>



<a name="274038133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038133">(Mar 03 2022 at 20:53)</a>:</h4>
<p>it doesn't say they're the <strong>same</strong> pointer</p>



<a name="274038159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038159">(Mar 03 2022 at 20:53)</a>:</h4>
<p>it just says they are looking at the same spot.</p>



<a name="274038294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038294">(Mar 03 2022 at 20:54)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> That's true, but at the same time, in a hypothetical world in which we're distinguishing between size_t and uintptr_t, it's not obvious if we gain much in the way of reduced breakage by allowing people to assume size_t and ptraddr_t are the same.</p>



<a name="274038388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038388">(Mar 03 2022 at 20:55)</a>:</h4>
<p>We do, actually.</p>



<a name="274038434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038434">(Mar 03 2022 at 20:55)</a>:</h4>
<p>/me is interested to hear what breakage that avoids.</p>



<a name="274038515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038515">(Mar 03 2022 at 20:56)</a>:</h4>
<p>Almost all the currently existing methods on <code>*const T</code> and <code>*mut T</code>.</p>



<a name="274038662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038662">(Mar 03 2022 at 20:57)</a>:</h4>
<p><em>oh</em>.</p>



<a name="274038677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038677">(Mar 03 2022 at 20:57)</a>:</h4>
<p>yes, now do you see. :D</p>



<a name="274038694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038694">(Mar 03 2022 at 20:57)</a>:</h4>
<p>I see. Because <code>ptraddr_t</code> and <code>ptrdiff_t</code> are the same?</p>



<a name="274038810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038810">(Mar 03 2022 at 20:58)</a>:</h4>
<p>The CHERI people say no but uh<br>
only in a lunatic world, yes. ptrdiff_t is isize</p>



<a name="274038831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038831">(Mar 03 2022 at 20:58)</a>:</h4>
<p>Yeah, that's the confusion I was experiencing.</p>



<a name="274038892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038892">(Mar 03 2022 at 20:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274038810">said</a>:</p>
<blockquote>
<p>The CHERI people say no but uh<br>
only in a lunatic world, yes. ptrdiff_t is isize</p>
</blockquote>
<p>I say no, as well, in general.</p>



<a name="274038915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274038915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274038915">(Mar 03 2022 at 20:59)</a>:</h4>
<p>(Aside: I <em>can</em> imagine a world in which they're different, but it'd be something like "all addresses are linear 128-bit addresses, processes get a 64-bit address space to themselves, all addresses are unique even between processes". And it's not obvious to me that we need to cater to that. In particular, we <em>could</em> support that, if suboptimally, by just making usize 128-bit.)</p>



<a name="274039231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039231">(Mar 03 2022 at 21:00)</a>:</h4>
<p>I do agree that it's a minority of systems, with a minority of users, that the answer is "no" on, though.</p>



<a name="274039280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039280">(Mar 03 2022 at 21:00)</a>:</h4>
<p>Like they added <code>sptraddr_t</code> and say <code>ptrdiff_t</code> is different than that but my attitude towards the silicon it is untrue on is basically uh</p>



<a name="274039323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039323">(Mar 03 2022 at 21:01)</a>:</h4>
<p>What actual silicon and systems <em>is</em> it untrue for?</p>



<a name="274039333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039333">(Mar 03 2022 at 21:01)</a>:</h4>
<p>Hypotheticals aside.</p>



<a name="274039348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039348">(Mar 03 2022 at 21:01)</a>:</h4>
<p><a href="/user_uploads/4715/P7VCuj7PUX5wvS4y5KouIRXx/these_are_not_made.jpg">these_are_not_made.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/P7VCuj7PUX5wvS4y5KouIRXx/these_are_not_made.jpg" title="these_are_not_made.jpg"><img src="/user_uploads/4715/P7VCuj7PUX5wvS4y5KouIRXx/these_are_not_made.jpg"></a></div>



<a name="274039530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039530">(Mar 03 2022 at 21:02)</a>:</h4>
<p>( Also I am assuming the C23 definition of <code>ptrdiff_t</code> where they caved and admitted it's fine to have <code>ptrdiff_t</code> be 16 bits. )</p>



<a name="274039570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039570">(Mar 03 2022 at 21:02)</a>:</h4>
<p>(Huh, I'm surprised that wasn't true before.)</p>



<a name="274039618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039618">(Mar 03 2022 at 21:03)</a>:</h4>
<p>It had a minimum width of 17 up until 23.</p>



<a name="274039644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039644">(Mar 03 2022 at 21:03)</a>:</h4>
<p>which everyone ignored.</p>



<a name="274039710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039710">(Mar 03 2022 at 21:03)</a>:</h4>
<p>Yep. Even I did (and I've been very careful to design my w65 abi arround complying with the C/++ standards)</p>



<a name="274039849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039849">(Mar 03 2022 at 21:04)</a>:</h4>
<p>This doesn't really solve the "I want a type for C interop", but for Rust itself, <code>usize</code> isn't that great of a type for indexing anyway, so I kinda would like a different type for indexing and size_of and such anyway.  <code>x[usize::MAX]</code> only ever works for ZSTs, for example, so just not being able to represent that would be totally ok.</p>
<p>So something like a <code>uindex</code> type that's <code>u31</code> on a 32-bit platform would actually be rather nice to have.  But I have no idea how to actually add that nicely (because of all the APIs) without a time machine, though.</p>



<a name="274039862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039862">(Mar 03 2022 at 21:04)</a>:</h4>
<p>Like in the case of Rust we have users who may disagree with our ivory tower perspective and may wish to deploy our most virulent memes against them, but the C Standard has been losing that battle for 24 years. At that time you pack it in.</p>



<a name="274039957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274039957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274039957">(Mar 03 2022 at 21:05)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> Can you clarify why <code>usize</code> <em>isn't</em> great for indexing? That seems like the one case it <em>is</em> great for under any possible change we might make about its interactions with pointers.</p>



<a name="274040026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040026">(Mar 03 2022 at 21:06)</a>:</h4>
<p>people actually do use ptrdiff_t for indexing sometimes</p>



<a name="274040056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040056">(Mar 03 2022 at 21:06)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> And on at least <em>some</em> systems it may be possible to <code>x[usize::MAX-1]</code>; there's no fundamental reason you can't have a full 64-bit (virtual) address space.</p>



<a name="274040122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040122">(Mar 03 2022 at 21:07)</a>:</h4>
<p>in general our allocations break if they exceed isize::MAX</p>



<a name="274040127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040127">(Mar 03 2022 at 21:07)</a>:</h4>
<p>Isn't there some text in the pointer docs saying that this is not allowed?</p>



<a name="274040173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040173">(Mar 03 2022 at 21:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040056">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> And on at least <em>some</em> systems it may be possible to <code>x[usize::MAX-1]</code>; there's no fundamental reason you can't have a full 64-bit address space.</p>
</blockquote>
<p>Except llvm, lccc, probably gcc, and I think rust itself, says that indexing occurs in signed integers.</p>



<a name="274040174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040174">(Mar 03 2022 at 21:07)</a>:</h4>
<p>^ what jubilee said, that's an LLVM limitation IIRC</p>



<a name="274040264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040264">(Mar 03 2022 at 21:08)</a>:</h4>
<p>Fair, and I'm not saying that's entirely viable with current toolchains or systems. I more meant, it's not obvious what we'd <em>gain</em> by doing indexing with a u31/u63.</p>



<a name="274040272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040272">(Mar 03 2022 at 21:08)</a>:</h4>
<p>it does seem like a silly restriction though</p>



<a name="274040303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040303">(Mar 03 2022 at 21:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040272">said</a>:</p>
<blockquote>
<p>it does seem like a silly restriction though</p>
</blockquote>
<p>It's because you can do negative indexing on pointers.</p>



<a name="274040364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040364">(Mar 03 2022 at 21:09)</a>:</h4>
<p>I don't see why that matters</p>



<a name="274040395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040395">(Mar 03 2022 at 21:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274039231">said</a>:</p>
<blockquote>
<p>I do agree that it's a minority of systems, with a minority of users, that the answer is "no" on, though.</p>
</blockquote>
<p>cough up their names and addresses, Connor.</p>



<a name="274040401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040401">(Mar 03 2022 at 21:09)</a>:</h4>
<p>you can just use different operations to say what you want</p>



<a name="274040407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040407">(Mar 03 2022 at 21:09)</a>:</h4>
<p>I JUST WANT TO TALK.</p>



<a name="274040514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040514">(Mar 03 2022 at 21:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040395">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274039231">said</a>:</p>
<blockquote>
<p>I do agree that it's a minority of systems, with a minority of users, that the answer is "no" on, though.</p>
</blockquote>
<p>cough up their names and addresses, Connor.</p>
</blockquote>
<p>w65 with the abi defined by SNES-Dev. 8086 in far pointer segmented model are the ones I can think of off the top of my head.</p>



<a name="274040572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040572">(Mar 03 2022 at 21:10)</a>:</h4>
<p>With 8086 in far-pointer segmented, ptrdiff_t and ptraddr_t would still be the same (20 bits), as far as I can tell.</p>



<a name="274040626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040626">(Mar 03 2022 at 21:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040401">said</a>:</p>
<blockquote>
<p>you can just use different operations to say what you want</p>
</blockquote>
<p>I can't speak for llvm (though it doesn't have signed integers at the ir level), but I really like the consistency of <em>one</em> <code>add</code> instruction.</p>



<a name="274040683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040683">(Mar 03 2022 at 21:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040572">said</a>:</p>
<blockquote>
<p>With 8086 in far-pointer segmented, ptrdiff_t and ptraddr_t would still be the same (20 bits), as far as I can tell.</p>
</blockquote>
<p>ptrdiff_t and size_t would be 16-bit, since objects wouldn't be able to cross segments (and you can't semantically index accross segments efficiently with a far pointer)</p>



<a name="274040684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040684">(Mar 03 2022 at 21:11)</a>:</h4>
<p>At the hardware level, it <em>is</em> one <code>add</code> instruction</p>



<a name="274040694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040694">(Mar 03 2022 at 21:11)</a>:</h4>
<p><a href="https://github.com/SNES-Dev/abi">https://github.com/SNES-Dev/abi</a><br>
CONNOR</p>



<a name="274040760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040760">(Mar 03 2022 at 21:12)</a>:</h4>
<p>Hello.</p>



<a name="274040823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040823">(Mar 03 2022 at 21:12)</a>:</h4>
<p>I chose ptrdiff_t and size_t to be 16-bit because<br>
a) Objects can't be more than 64k in size<br>
b) I like the efficient codegen of memcpy when size_t is 16-bit</p>



<a name="274040849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040849">(Mar 03 2022 at 21:13)</a>:</h4>
<p>32-bit size_t actually makes memcpy quite less than viable.</p>



<a name="274040871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040871">(Mar 03 2022 at 21:13)</a>:</h4>
<p>ptrdiff_t should still be 20 bits, though, so it can represent any location in memory.</p>



<a name="274040888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040888">(Mar 03 2022 at 21:13)</a>:</h4>
<p>It's not <em>completely</em> invalid to make <code>size_t</code> different than <code>ptrdiff_t</code>/<code>ptraddr_t</code>, though that doesn't mean we should support such systems. But I think it <em>is</em> completely invalid to make <code>ptrdiff_t</code> not able to represent the difference between two arbitrary pointers.</p>



<a name="274040891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040891">(Mar 03 2022 at 21:13)</a>:</h4>
<p>I don't mind if you lower usize ops to 16 bits though.</p>



<a name="274040966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274040966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274040966">(Mar 03 2022 at 21:14)</a>:</h4>
<p>ptrdiff_t does not proport to represent any location in memory.<br>
It's defined as the difference between two indecies of an array.</p>



<a name="274041053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041053">(Mar 03 2022 at 21:15)</a>:</h4>
<p>uuugh</p>



<a name="274041066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041066">(Mar 03 2022 at 21:15)</a>:</h4>
<p>I am going to ask Jean-Heyd if you are right.</p>



<a name="274041071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041071">(Mar 03 2022 at 21:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040888">said</a>:</p>
<blockquote>
<p>It's not <em>completely</em> invalid to make <code>size_t</code> different than <code>ptrdiff_t</code>/<code>ptraddr_t</code>, though that doesn't mean we should support such systems. But I think it <em>is</em> completely invalid to make <code>ptrdiff_t</code> not able to represent the difference between two arbitrary pointers.</p>
</blockquote>
<p>You can't get the difference between two arbitrary pointers, at least, not in C.<br>
Also, I really like the assumption that <code>ptrdiff_t</code>==<code>signed size_t</code></p>



<a name="274041105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041105">(Mar 03 2022 at 21:15)</a>:</h4>
<p>c2x:</p>
<blockquote>
<p>The types are <code>ptrdiff_t</code> which is the signed integer type of the result of subtracting two pointers</p>
</blockquote>



<a name="274041132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041132">(Mar 03 2022 at 21:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274041105">said</a>:</p>
<blockquote>
<p>c2x:</p>
<blockquote>
<p>The types are <code>ptrdiff_t</code> which is the signed integer type of the result of subtracting two pointers</p>
</blockquote>
</blockquote>
<p>Yes, but you can't subtract <em>arbitrary</em> pointers.</p>



<a name="274041196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041196">(Mar 03 2022 at 21:16)</a>:</h4>
<p>Chapter and verse of the C standard, please, to determine whether C is wrong or just your ABI? ;)</p>



<a name="274041197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041197">(Mar 03 2022 at 21:16)</a>:</h4>
<p>that's some classic C reasoning there</p>



<a name="274041250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041250">(Mar 03 2022 at 21:16)</a>:</h4>
<p>20 bits - 20 bits = 16 bits but it's not broken math, it's the magic of UB <span aria-label="rainbow" class="emoji emoji-1f308" role="img" title="rainbow">:rainbow:</span></p>



<a name="274041252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041252">(Mar 03 2022 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274041196">said</a>:</p>
<blockquote>
<p>Chapter and verse of the C standard, please, to determine whether C is wrong or just your ABI? ;)</p>
</blockquote>
<p>Already searching.</p>



<a name="274041278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041278">(Mar 03 2022 at 21:16)</a>:</h4>
<p>Ah, found it. J.2 on UB includes "— Pointers that do not point into, or just beyond, the same array object are subtracted (6.5.6)."</p>



<a name="274041302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041302">(Mar 03 2022 at 21:17)</a>:</h4>
<p>So C is wrong, and your ABI is technically compliant with C's incorrectness. ;)</p>



<a name="274041306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041306">(Mar 03 2022 at 21:17)</a>:</h4>
<p>It's under the definition of <code>-</code>.</p>



<a name="274041453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041453">(Mar 03 2022 at 21:18)</a>:</h4>
<p>6.5.6#9</p>
<blockquote>
<p>When two pointers are subtracted, both shall point to elements of the same array object,<br>
or one past the last element of the array object; the result is the difference of the<br>
subscripts of the two array elements.</p>
</blockquote>



<a name="274041552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041552">(Mar 03 2022 at 21:19)</a>:</h4>
<p>All pointer arithmetic in C is defined in terms of indecies of elements in an array.</p>



<a name="274041574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041574">(Mar 03 2022 at 21:19)</a>:</h4>
<p>/shrug</p>



<a name="274041611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041611">(Mar 03 2022 at 21:19)</a>:</h4>
<p>Hypothesis: most uses of pointer subtraction are when the sign of the result is known (probably nonnegative). I would love a version of offset_from that returns a usize</p>



<a name="274041614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041614">(Mar 03 2022 at 21:19)</a>:</h4>
<p>Same paragram also has</p>
<blockquote>
<p>The size of the result is implementation-defined, and its type (a signed integer type) is ptrdiff_t defined in the &lt;stddef.h&gt; header.<br>
If the result is not representable in an object of that type, the behavior is undefined</p>
</blockquote>



<a name="274041748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041748">(Mar 03 2022 at 21:20)</a>:</h4>
<p>Anyways: <code>isize</code> is <strong>morally</strong> our equivalent to <code>ptrdiff_t</code></p>



<a name="274041759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041759">(Mar 03 2022 at 21:20)</a>:</h4>
<p>(Which means that you can allow arrays of <code>unsigned char</code> larger than <code>PTRDIFF_MAX</code> in size without breaking anything)</p>



<a name="274041783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041783">(Mar 03 2022 at 21:20)</a>:</h4>
<p>And I must admit that in any well-behaved Rust code, Connor should never have to worry about this issue.</p>



<a name="274041798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041798">(Mar 03 2022 at 21:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274040056">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> And on at least <em>some</em> systems it may be possible to <code>x[usize::MAX-1]</code>; there's no fundamental reason you can't have a full 64-bit (virtual) address space.</p>
</blockquote>
<p><code>ptr::offset</code> says you can't, though.  As do <code>slice::from_raw_parts</code> and such.</p>
<p>And making that a niche would be great for <code>Option&lt;usize&gt;</code>.</p>



<a name="274041865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041865">(Mar 03 2022 at 21:21)</a>:</h4>
<p><code>Layout</code> constructors being safe does as well.</p>



<a name="274041990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274041990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274041990">(Mar 03 2022 at 21:22)</a>:</h4>
<p>Like,<br>
I don't think, morally speaking, that we should care about the w65 as far as our overall Rust model goes.</p>



<a name="274042029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042029">(Mar 03 2022 at 21:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274041865">said</a>:</p>
<blockquote>
<p><code>Layout</code> constructors being safe does as well.</p>
</blockquote>
<p>How do you figure? Doesn't it return a result and check bounds?</p>



<a name="274042085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042085">(Mar 03 2022 at 21:23)</a>:</h4>
<p>It just should incidentally be the case that you can use Rust, if you are very careful with it, to emit correct code for an SNES.</p>



<a name="274042096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042096">(Mar 03 2022 at 21:23)</a>:</h4>
<p><code>Layout::of::&lt;T&gt;()</code> is safe and returns a <code>Layout</code></p>



<a name="274042161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042161">(Mar 03 2022 at 21:23)</a>:</h4>
<p>I'm not seeing the contradiction</p>



<a name="274042265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042265">(Mar 03 2022 at 21:24)</a>:</h4>
<p><code>Layout::of::&lt;[u8;usize::MAX]&gt;()</code> safely returns an illegal Layout</p>



<a name="274042345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042345">(Mar 03 2022 at 21:24)</a>:</h4>
<p>I would have assumed that would produce a post-mono error</p>



<a name="274042401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042401">(Mar 03 2022 at 21:25)</a>:</h4>
<p>and from a practical perspective, even if ptraddr_t != size_t on the SNES,<br>
you should be able to almost always use 16 bit types.<br>
functionally, the detail though is that we should consider that an optimization, like how if you cast a u8 to usize to index then LLVM can ignore the cast.</p>



<a name="274042773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042773">(Mar 03 2022 at 21:28)</a>:</h4>
<p>Layout::of for <code>[u8; usize::MAX]</code> gives a compile error.</p>



<a name="274042900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042900">(Mar 03 2022 at 21:29)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Also it's worth noting that subtracting pointers from outside the same segment causes UB in C.</p>



<a name="274042935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274042935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274042935">(Mar 03 2022 at 21:30)</a>:</h4>
<p>There's also <code>Layout::from_val</code>, if you could produce a value of <code>[u8;usize::MAX]</code> anywhere.</p>



<a name="274043149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274043149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274043149">(Mar 03 2022 at 21:30)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error: values of the type `[u8; 18446744073709551615]` are too big for the current architecture
</code></pre></div>



<a name="274043211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274043211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274043211">(Mar 03 2022 at 21:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274042900">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> Also it's worth noting that subtracting pointers from outside the same segment causes UB in C.</p>
</blockquote>
<p>Yep, since objects won't ever cross segments (in segmented 8086)</p>



<a name="274043231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274043231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274043231">(Mar 03 2022 at 21:31)</a>:</h4>
<p>No, you can't produce such a value.</p>



<a name="274043382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274043382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274043382">(Mar 03 2022 at 21:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274043231">said</a>:</p>
<blockquote>
<p>No, you can't produce such a value.</p>
</blockquote>
<p>Currently. Above was a discussion of the theoretical possibility of allowing it, and I'm offering a reason that wouldn't be possible.</p>



<a name="274043715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274043715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274043715">(Mar 03 2022 at 21:35)</a>:</h4>
<p>If this were to be a legal type, then I don't see why it couldn't be a legal <code>Layout</code> as well</p>



<a name="274043970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274043970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274043970">(Mar 03 2022 at 21:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274042900">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> Also it's worth noting that subtracting pointers from outside the same segment causes UB in C.</p>
</blockquote>
<p>As a general rule, I'm much <em>less</em> interested in spec-UB, and much more interested in what compilers actually break and have good reason to break.</p>



<a name="274044002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044002">(Mar 03 2022 at 21:37)</a>:</h4>
<p>indeed.</p>



<a name="274044092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044092">(Mar 03 2022 at 21:38)</a>:</h4>
<p>I don't know how existing C compilers address SNES.</p>



<a name="274044174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044174">(Mar 03 2022 at 21:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274043970">said</a>:</p>
<blockquote>
<p>As a general rule, I'm much <em>less</em> interested in spec-UB, and much more interested in what compilers actually break and have good reason to break.</p>
</blockquote>
<p>I like spec-ub because it means I can some back to things that are considered UB but not previously exploited.<br>
That being said, disallowing cross-segment subtraction means that subtraction on e.g. 8086 can be compiled to a sub+and.</p>



<a name="274044318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044318">(Mar 03 2022 at 21:40)</a>:</h4>
<p>Any compiler developer talking about "UB but not previously exploited" is perpetuating the issue that UB is perceived (correctly in some cases) as a weapon compiler authors use against developers in that language.</p>



<a name="274044344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044344">(Mar 03 2022 at 21:40)</a>:</h4>
<p>lmao</p>



<a name="274044403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044403">(Mar 03 2022 at 21:41)</a>:</h4>
<p>w65 aside, I'm genuinely interested in how we <em>can</em> handle CHERI without breaking half the Rust ecosystem's uses of usize.</p>



<a name="274044415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044415">(Mar 03 2022 at 21:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274044092">said</a>:</p>
<blockquote>
<p>I don't know how existing C compilers address SNES.</p>
</blockquote>
<p>They don't. I was working on gcc, but I'm probably going to focus on SNES-Dev support in lccc, mostly because gcc is highly confusing.</p>



<a name="274044567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044567">(Mar 03 2022 at 21:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274044318">said</a>:</p>
<blockquote>
<p>Any compiler developer talking about "UB but not previously exploited" is perpetuating the issue that UB is perceived (correctly in some cases) as a weapon compiler authors use against developers in that language.</p>
</blockquote>
<p>It really is. Although there are other parts of it, such as allowing significant implementation differences (more than would be expected for implementation-defined or unspecified), it really is. I've held this belief since long before I've worked on a compiler</p>



<a name="274044665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044665">(Mar 03 2022 at 21:43)</a>:</h4>
<p>/me is not successfully parsing that statement. "it really is" used as a weapon? "it really is" UB?</p>



<a name="274044745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044745">(Mar 03 2022 at 21:44)</a>:</h4>
<p>"It really is a weapon".</p>



<a name="274044759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044759">(Mar 03 2022 at 21:44)</a>:</h4>
<p>Or rather, a tool.</p>



<a name="274044790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274044790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274044790">(Mar 03 2022 at 21:44)</a>:</h4>
<p>A tool to produce fast code because people want their poorly written code to run fast even though it's poorly written.</p>



<a name="274045130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274045130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274045130">(Mar 03 2022 at 21:47)</a>:</h4>
<p>To the extent it's used a weapon, that's an excellent argument for specs having <em>less</em> of it, and certainly a reason why I hope the term appears as little as it possibly can in any Rust spec that may or may not exist in the future. To the extent it's <em>not</em> used as a weapon, it might have value.</p>



<a name="274045198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274045198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274045198">(Mar 03 2022 at 21:48)</a>:</h4>
<p>To the extent you successfully make the case that UB is a weapon, I'm going to take that as a case for disarmament. :)</p>



<a name="274045278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274045278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274045278">(Mar 03 2022 at 21:48)</a>:</h4>
<p>I also think we're drifting <em>massively</em> off topic from the hope of future support for unusual targets.</p>



<a name="274045332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274045332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274045332">(Mar 03 2022 at 21:49)</a>:</h4>
<p>Every weapon to one is a tool to another. Every tool to one is a weapon to another.</p>



<a name="274045345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274045345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274045345">(Mar 03 2022 at 21:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274044403">said</a>:</p>
<blockquote>
<p>w65 aside, I'm genuinely interested in how we <em>can</em> handle CHERI without breaking half the Rust ecosystem's uses of usize.</p>
</blockquote>
<p>So, as mentioned, all our existing pointer methods depend on usize being capable of addressing everything in memory. They <strong>do not</strong> depend on usize being capable of handling existing metadata tags, etc.<br>
And for CHERI, I believe the correct approach is to introduce ways to make it easy to handle pointers directly.<br>
I have already mentioned we might need a new type roughly equivalent to <code>void *</code>, but things like the <code>map</code> solution I proposed also help.</p>
<p>I believe this is a minimal breakage path.<br>
If we wish to cleave apart <code>size_t</code> and <code>ptraddr_t</code>, fully, then I believe we <strong>could</strong> do that, but we would really need to deploy some aggressive code transformation tools to even think about it.</p>



<a name="274046151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274046151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274046151">(Mar 03 2022 at 21:57)</a>:</h4>
<p>I think that seems reasonable.</p>



<a name="274046287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274046287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274046287">(Mar 03 2022 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> I definitely don't think we should separate <code>usize</code>/<code>size_t</code>/<code>ptrdiff_t</code>/<code>ptraddr_t</code>; that'd be too high a cost to the ecosystem.<br>
I think we <em>could</em> manage to handle <code>usize</code> != <code>uintptr_t</code>.<br>
Or, perhaps, at least make it <em>possible</em> to handle systems like that while also making it possible to say "hey, my code wants to assume those are the same, let me declare that up front", such as via the portability lint or similar.</p>



<a name="274046400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274046400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274046400">(Mar 03 2022 at 21:59)</a>:</h4>
<p>Code that calls the methods on pointers would mostly still work. Code that uses <code>usize</code> in FFI would still work. Code that uses <code>usize</code> to handle arbitrary pointers as numbers wouldn't on CHERI, but we could potentially decide to say "that works on most systems, we're not saying it works everywhere but you <em>could</em> assume that and just not work on systems where it's not true".</p>



<a name="274046739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274046739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274046739">(Mar 03 2022 at 22:00)</a>:</h4>
<p>And then, yeah, we could introduce the "numeric pointer" type (what's the leading candidate name for that, BTW?), and codebases that migrate to that <em>would</em> work on CHERI, while old code would continue to work everywhere else.</p>



<a name="274046889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274046889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274046889">(Mar 03 2022 at 22:02)</a>:</h4>
<p>I've seen <code>uptr</code> before, at least.<br>
It's also not <strong>necessarily</strong> the case that we need it, we could just do things like exposing methods that allow tweaking or introspecting on the bits of the address directly on pointers.</p>



<a name="274047013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047013">(Mar 03 2022 at 22:02)</a>:</h4>
<p>But however that interface goes down, we should make it sufficiently ergonomic that we don't have to actually worry about anyone doing that in legacy code, IMO, and basically treat attempts to reduce a pointer to a usize as a mistake.</p>



<a name="274047056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047056">(Mar 03 2022 at 22:03)</a>:</h4>
<p>There should be a clippy restriction lint for that if there isn't already</p>



<a name="274047093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047093">(Mar 03 2022 at 22:03)</a>:</h4>
<p>the main issue being that there is no current alternative</p>



<a name="274047101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047101">(Mar 03 2022 at 22:03)</a>:</h4>
<p>Yes. If we make it well-defined behavior and easy to use, people should feel most inclined to write the <strong>correct</strong> code.</p>



<a name="274047220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047220">(Mar 03 2022 at 22:04)</a>:</h4>
<p>It's a little funny to me that Rust is lagging behind C here in modeling reality, I'm used to the reverse situation</p>



<a name="274047266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047266">(Mar 03 2022 at 22:05)</a>:</h4>
<p>I believe less code actually relies on the "a pointer is definitely a usize, right?" thing than the claims we are commonly sold, I just believe that it's definitely a case we straight-up made a mistake here, and there's no good alternative, and there should be.</p>



<a name="274047557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047557">(Mar 03 2022 at 22:08)</a>:</h4>
<p>I do agree though that if we are considering this level of breakage... even though I noted that it offers less breakage, I will admit: We <strong>can</strong> consider making it so <code>usize</code> really does just mean <code>size_t</code> always, and deploy the aggressive code transformation tools to author a new reality, and a new type.</p>



<a name="274047954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274047954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274047954">(Mar 03 2022 at 22:11)</a>:</h4>
<p>For safe code that only uses <code>usize</code> as "that thing that <code>len()</code> returns and <code>arr[_]</code> takes", am I right in understanding that you would only ever interact with the <code>size_t</code> version and <code>uintptr_t</code> and <code>ptrdiff_t</code> would never appear?</p>



<a name="274048054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048054">(Mar 03 2022 at 22:12)</a>:</h4>
<p>I know I have definitely assumed <code>usize</code> = <code>uintptr_t</code> before</p>



<a name="274048126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048126">(Mar 03 2022 at 22:13)</a>:</h4>
<p>I assume the main place <code>usize</code> meaning <code>uintptr_t</code> appears is in code that does <code>*const T as usize</code></p>



<a name="274048140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048140">(Mar 03 2022 at 22:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274047557">said</a>:</p>
<blockquote>
<p>I do agree though that if we are considering this level of breakage... even though I noted that it offers less breakage, I will admit: We <strong>can</strong> consider making it so <code>usize</code> really does just mean <code>size_t</code> always, and deploy the aggressive code transformation tools to author a new reality, and a new type.</p>
</blockquote>
<p>At the moment, what I'd love to do is incrementally ratchet one thing we guarantee: I'd like to ratify a consensus that <code>usize == size_t = ptrdiff_t</code>, <em>without</em> yet definitively settling the question of whether <code>usize == uintptr_t</code>.</p>



<a name="274048249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048249">(Mar 03 2022 at 22:14)</a>:</h4>
<blockquote>
<p>I assume the main place <code>usize</code> meaning <code>uintptr_t</code> appears is in code that does <code>*const T as usize</code></p>
</blockquote>
<p>yes, or <code>usize as *mut T</code></p>



<a name="274048270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048270">(Mar 03 2022 at 22:14)</a>:</h4>
<p>which is bad for other reasons (see the thread this one split from)</p>



<a name="274048363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048363">(Mar 03 2022 at 22:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274048249">said</a>:</p>
<blockquote>
<blockquote>
<p>I assume the main place <code>usize</code> meaning <code>uintptr_t</code> appears is in code that does <code>*const T as usize</code></p>
</blockquote>
<p>yes, or <code>usize as *mut T</code></p>
</blockquote>
<p>Or <code>math(*mut T as usize) as *mut T</code>, with a later <code>unmath(*mut T as usize) as *mut T</code>. (With the outer <code>as *mut T</code> casts appearing or not appearing depending on whether storage/serialization is as a pointer or a <code>usize</code>.)</p>



<a name="274048384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048384">(Mar 03 2022 at 22:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274047954">said</a>:</p>
<blockquote>
<p>For safe code that only uses <code>usize</code> as "that thing that <code>len()</code> returns and <code>arr[_]</code> takes", am I right in understanding that you would only ever interact with the <code>size_t</code> version and <code>uintptr_t</code> and <code>ptrdiff_t</code> would never appear?</p>
</blockquote>
<p>correct.</p>



<a name="274048609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048609">(Mar 03 2022 at 22:17)</a>:</h4>
<p>If we somehow transition to a world where those math-casts are expressed as <code>(_: *mut T).map(|addr| math(addr))</code>, the type of <code>addr</code> can potentially be a smaller integer type than <code>uintptr_t</code> (<del>not sure what it would be called here</del> I guess this is <code>ptraddr_t</code>), which for CHERI pointers would mean just the address without the capability part</p>



<a name="274048716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048716">(Mar 03 2022 at 22:18)</a>:</h4>
<p>in which case we might not need <code>uintptr_t</code> as a concept</p>



<a name="274048750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048750">(Mar 03 2022 at 22:19)</a>:</h4>
<p>certainly for CHERI it is pretty suspicious, <code>u128</code> isn't doing what we want</p>



<a name="274048961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274048961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274048961">(Mar 03 2022 at 22:20)</a>:</h4>
<p>My position is, essentially:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">type_nonequal</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">uintptr_t</span><span class="p">)</span><span class="w"></span>
<span class="n">bitsize_of</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bitsize_of</span><span class="p">(</span><span class="n">ptraddr_t</span><span class="p">)</span><span class="w"></span>
<span class="n">bitsize_of</span><span class="p">(</span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bitsize_of</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="274049223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274049223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274049223">(Mar 03 2022 at 22:23)</a>:</h4>
<p>yes, CHERI pointers are essentially a struct with an address inside them and then a bunch of fields specifying the allowed range, type, etc. of the pointer, collectively referred to as a "capability"</p>



<a name="274049461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274049461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274049461">(Mar 03 2022 at 22:25)</a>:</h4>
<p>Other ABIs in the past have also encoded ideas like offsets, etc. directly into the pointer.</p>



<a name="274050490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274050490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274050490">(Mar 03 2022 at 22:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274048140">said</a>:</p>
<blockquote>
<p>At the moment, what I'd love to do is incrementally ratchet one thing we guarantee: I'd like to ratify a consensus that <code>usize == size_t = ptrdiff_t</code>, <em>without</em> yet definitively settling the question of whether <code>usize == uintptr_t</code>.</p>
</blockquote>
<p>unsure if that is what you were looking for re: this matter</p>



<a name="274050695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274050695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274050695">(Mar 03 2022 at 22:36)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> I'd prefer to delete the <code>&gt;</code> and <code>&lt;</code> from your pseudocode above. And I don't actually want to ratify <code>type_nonequal(usize, uintptr_t)</code> yet, I'd like to settle that <em>separately</em> from incrementally saying a bit more about usize.</p>



<a name="274052759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274052759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274052759">(Mar 03 2022 at 22:56)</a>:</h4>
<p>Well, my lingering question regarding the <code>ptraddr_t</code> vs <code>size_t</code> matter is if we ever <strong>do</strong> want to support segmented memory architectures and if so how.</p>



<a name="274053686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274053686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274053686">(Mar 03 2022 at 23:02)</a>:</h4>
<p>Fair.</p>



<a name="274053787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274053787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274053787">(Mar 03 2022 at 23:03)</a>:</h4>
<p>I think rust <em>should</em> support segmented memory architectures in <code>void*</code>=<code>void* _near</code> mode, and it should be a separate question whether it supports <code>void* _far</code>. <br>
The only thing that gives me pause with allowing the first as-is, is that you could have pointers to different segments (data vs. stack), but if that's not the case, I think rust can already (since it doesn't guarantee that converting between function and data pointers are meaningful).</p>



<a name="274054586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274054586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274054586">(Mar 03 2022 at 23:10)</a>:</h4>
<p>cursed memory architecture secrets <a href="https://www.kernel.org/doc/html/latest/x86/x86_64/fsgs.html">https://www.kernel.org/doc/html/latest/x86/x86_64/fsgs.html</a></p>



<a name="274054667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274054667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274054667">(Mar 03 2022 at 23:11)</a>:</h4>
<p>I'm just glad that in 64-bit mode those are <em>just</em> an offset, nothing more.</p>



<a name="274054760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274054760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274054760">(Mar 03 2022 at 23:12)</a>:</h4>
<p><em>runs program in compatibility mode</em></p>



<a name="274056250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274056250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274056250">(Mar 03 2022 at 23:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274047266">said</a>:</p>
<blockquote>
<p>I believe less code actually relies on the "a pointer is definitely a usize, right?" thing than the claims we are commonly sold, I just believe that it's definitely a case we straight-up made a mistake here, and there's no good alternative, and there should be.</p>
</blockquote>
<p>I don't know how many you expect. But currently, I can tell you that out of the top 4379 crates, 157 of them execute an int-to-pointer cast which is within the reach of Miri through their test suite. I think 76 of those 157 crates actually contain the cast, the rest do it via a dependency.</p>
<p>I think the far more interesting question is whether all of those can get the functionality they need without doing this cast. I've only audited a few, but I have yet to see any that do something other than bit-packing into the alignment bits of a pointer, or just wanted to use <code>+</code> on <code>*mut u8</code>, so they converted them to <code>usize</code>.</p>



<a name="274056347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274056347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274056347">(Mar 03 2022 at 23:29)</a>:</h4>
<p>The numbers are a bit muddied by the fact that <code>bytes</code> does this cast, and therefore basically all the web ecosystem does.</p>



<a name="274060768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274060768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274060768">(Mar 04 2022 at 00:17)</a>:</h4>
<p>there are also cases where I need <code>0x12345678 as *mut T</code>, mostly for embedded stuff</p>



<a name="274060835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274060835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274060835">(Mar 04 2022 at 00:18)</a>:</h4>
<p>I think we should have a way to declare certain "well-known addresses" to the compiler, explicitly.</p>



<a name="274061019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061019">(Mar 04 2022 at 00:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274060768">said</a>:</p>
<blockquote>
<p>there are also cases where I need <code>0x12345678 as *mut T</code>, mostly for embedded stuff</p>
</blockquote>
<p>Embedded stuff is non-portable anyways.<br>
<code>0x12345678 as *mut T</code> will have zero meaning on w65.</p>



<a name="274061028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061028">(Mar 04 2022 at 00:21)</a>:</h4>
<p>yeah.</p>



<a name="274061198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061198">(Mar 04 2022 at 00:22)</a>:</h4>
<p>(Also, TBH, using casts for this is <span aria-label="neutral" class="emoji emoji-1f610" role="img" title="neutral">:neutral:</span>, I prefer using magic linker symbols to magic numbers)</p>



<a name="274061222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061222">(Mar 04 2022 at 00:23)</a>:</h4>
<p>yes.</p>



<a name="274061366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061366">(Mar 04 2022 at 00:24)</a>:</h4>
<p>well...that doesn't cover stuff like (UB, but people need it anyway):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">debugger_main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">read_commands</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">cmd</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Command</span>::<span class="n">ReadMem</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="o">?</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)})</span><span class="o">?</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274061430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061430">(Mar 04 2022 at 00:25)</a>:</h4>
<p>(I do understand the code that already does this and expects to be able to do it, though, so I will begrudingly support it)</p>



<a name="274061467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061467">(Mar 04 2022 at 00:25)</a>:</h4>
<p>lol????</p>



<a name="274061602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061602">(Mar 04 2022 at 00:27)</a>:</h4>
<p>Yeah, I've been told that I can't just make <code>addr as *mut u8</code> non-dereferenceable(n) for n&gt;0.</p>



<a name="274061778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061778">(Mar 04 2022 at 00:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274061366">said</a>:</p>
<blockquote>
<p>well...that doesn't cover stuff like (UB, but people need it anyway):</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">debugger_main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">read_commands</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">cmd</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Command</span>::<span class="n">ReadMem</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="o">?</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)})</span><span class="o">?</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>uhhh I can't tell what you're trying to do here</p>



<a name="274061811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061811">(Mar 04 2022 at 00:29)</a>:</h4>
<p>It's reading an address out of a command, and using it to poke arbitrary memory.</p>



<a name="274061825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274061825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274061825">(Mar 04 2022 at 00:29)</a>:</h4>
<p>Which is horrible, horrible UB.</p>



<a name="274062052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062052">(Mar 04 2022 at 00:30)</a>:</h4>
<p>isn't this PEEK not POKE</p>



<a name="274062058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062058">(Mar 04 2022 at 00:30)</a>:</h4>
<p>Oh yeah PEEK.</p>



<a name="274062065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062065">(Mar 04 2022 at 00:30)</a>:</h4>
<p>POKE is even worse.</p>



<a name="274062082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062082">(Mar 04 2022 at 00:31)</a>:</h4>
<p>debuggers often need memory writing too</p>



<a name="274062161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062161">(Mar 04 2022 at 00:31)</a>:</h4>
<p>it would be sad if we had to resort to inline asm to get the compiler to behave how we want there</p>



<a name="274062163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062163">(Mar 04 2022 at 00:32)</a>:</h4>
<p>I was thrown by the write not matching <code>write!</code> syntax</p>



<a name="274062217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062217">(Mar 04 2022 at 00:32)</a>:</h4>
<p>You're reading/writing to arbitrary memory within the context of that process.<br>
If you run into memory owned by the compiler, it will demolish you.</p>



<a name="274062237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062237">(Mar 04 2022 at 00:32)</a>:</h4>
<p>anyways <span class="user-mention" data-user-id="229517">@Jacob Lifshay</span>, I don't see why addr can't simply be a pointer</p>



<a name="274062240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062240">(Mar 04 2022 at 00:32)</a>:</h4>
<p>Not least of which if you have any <code>&amp;mut</code>/<code>&amp;</code> to said memory (but even without it).</p>



<a name="274062242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062242">(Mar 04 2022 at 00:32)</a>:</h4>
<p>a raw pointer yes</p>



<a name="274062253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062253">(Mar 04 2022 at 00:33)</a>:</h4>
<p>but why not</p>



<a name="274062273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062273">(Mar 04 2022 at 00:33)</a>:</h4>
<p>(Also, debuggers of any kind are frankly cursed when surrounded by pointer optimizations of any kind. They're basically manifestly undefined behaviour just attaching)</p>



<a name="274062284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062284">(Mar 04 2022 at 00:33)</a>:</h4>
<p>because we have to parse the address from text/some communication protocol at some point, might as well do it in the example code</p>



<a name="274062296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062296">(Mar 04 2022 at 00:33)</a>:</h4>
<p>oh.</p>



<a name="274062352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062352">(Mar 04 2022 at 00:34)</a>:</h4>
<p>yeah I am assuming you can still try to deserialize bytes into a pointer.</p>



<a name="274062356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062356">(Mar 04 2022 at 00:34)</a>:</h4>
<p>Address from communciation protocol?</p>



<a name="274062360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062360">(Mar 04 2022 at 00:34)</a>:</h4>
<p>And I am assuming you don't need to go through usize</p>



<a name="274062366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062366">(Mar 04 2022 at 00:34)</a>:</h4>
<p>Sounds like a CVE waiting to happen.</p>



<a name="274062372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062372">(Mar 04 2022 at 00:34)</a>:</h4>
<p>and yes</p>



<a name="274062377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062377">(Mar 04 2022 at 00:34)</a>:</h4>
<p>like gdb's debugger protocol</p>



<a name="274062383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062383">(Mar 04 2022 at 00:35)</a>:</h4>
<p>Free ACE/RCE.</p>



<a name="274062391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062391">(Mar 04 2022 at 00:35)</a>:</h4>
<p>I am assuming that like</p>



<a name="274062399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062399">(Mar 04 2022 at 00:35)</a>:</h4>
<p>"try"<br>
may be the active word here</p>



<a name="274062408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062408">(Mar 04 2022 at 00:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274062377">said</a>:</p>
<blockquote>
<p>like gdb's debugger protocol</p>
</blockquote>
<p>Debugger Protocol doesn't go into process memory.</p>



<a name="274062470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062470">(Mar 04 2022 at 00:36)</a>:</h4>
<p>being able to access all the programs' internals and run arbitrary code is the whole point of a debugger...a CVE for that would be silly</p>



<a name="274062486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062486">(Mar 04 2022 at 00:36)</a>:</h4>
<p>But this isn't happening inside the context of <em>the</em> process.</p>



<a name="274062522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062522">(Mar 04 2022 at 00:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274062470">said</a>:</p>
<blockquote>
<p>being able to access all the programs' internals and run arbitrary code is the whole point of a debugger...a CVE for that would be silly</p>
</blockquote>
<p>Meanwhile, the compiler is assuming nothing is looking at the internals or changing the code being run at all.</p>



<a name="274062523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062523">(Mar 04 2022 at 00:37)</a>:</h4>
<p>Can gdb debug itself?</p>



<a name="274062525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062525">(Mar 04 2022 at 00:37)</a>:</h4>
<p>well...in embedded, there may not be a way to do out-of-process debugging</p>



<a name="274062527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062527">(Mar 04 2022 at 00:37)</a>:</h4>
<p>well, as far as I am concerned, a debugger that isn't considering the merits of twiddling machine code directly is not cutting it as far as debugging goes. I don't think it should be UB to try to serialize or deserialize a pointer, though, oddly enough.</p>



<a name="274062545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274062545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274062545">(Mar 04 2022 at 00:37)</a>:</h4>
<p>And I don't think it necessarily needs to have anything to do with usize</p>



<a name="274063739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274063739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274063739">(Mar 04 2022 at 00:53)</a>:</h4>
<p>I wonder if the solution is using some moral equivalent of <em>conditionally-support</em>, where by default this doesn't happen, and it's the implementation's (and users' thereof) problem to sort out if they do target a platform that this doesn't hold.</p>



<a name="274063813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274063813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274063813">(Mar 04 2022 at 00:54)</a>:</h4>
<p>I also have used <code>size_of::&lt;usize&gt;() * 3</code> or something as an offset past a struct containing stuff like mixed <code>usize</code> and <code>*mut T</code>. I couldn't find it in published code, but I'm certain I've done it, rather than spell out <code>size_of::&lt;usize&gt;() * 2 + size_of::&lt;*mut T&gt;()</code> or similar, to offset past len/cap/ptr or something. Given that its guaranteed, I assumed it would be fine.</p>



<a name="274063827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274063827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274063827">(Mar 04 2022 at 00:54)</a>:</h4>
<p>that's the kind of code that seems liable to break in a subtle and unfortunate way.</p>



<a name="274063987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274063987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274063987">(Mar 04 2022 at 00:56)</a>:</h4>
<blockquote>
<p>I wonder if the solution is using some moral equivalent of <em>conditionally-support</em>...</p>
</blockquote>
<p>that seems very likely to make a large amount of Rust code unusable on those platforms, like everyone assuming everything is little-endian, but worse (probably more UB)</p>



<a name="274064069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274064069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274064069">(Mar 04 2022 at 00:57)</a>:</h4>
<p>Given the rarity and how niche they are, I don't think that's a huge issue.</p>



<a name="274064187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274064187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274064187">(Mar 04 2022 at 00:58)</a>:</h4>
<p>Core language types and core language semantics is a bad place for "conditionally support" to be a phrase.</p>



<a name="274064517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274064517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274064517">(Mar 04 2022 at 01:00)</a>:</h4>
<p>Although <code>core</code> itself would need to be mindful of this.</p>



<a name="274064539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274064539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274064539">(Mar 04 2022 at 01:01)</a>:</h4>
<p>I do not necessarily mean in the libcore sense.</p>



<a name="274065066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065066">(Mar 04 2022 at 01:09)</a>:</h4>
<blockquote>
<p>I wonder if the solution is using some moral equivalent of conditionally-support, where by default this doesn't happen, and it's the implementation's (and users' thereof) problem to sort out if they do target a platform that this doesn't hold.</p>
</blockquote>
<p>It will likely already be this way for those platforms for a lot of software (with rusts help or not), so to some extent I suspect this will happen anyway. We also sort of already have targets like these, in so far as people frequently hardcode lists of targets in <a href="http://build.rs">build.rs</a>, ignoring the existence of target json files (admittedly unstable, although this may add to my point in a sense). I think this is something we want to avoid/reduce though, and it would be a bad precedent to start explicitly making decisions that way.</p>
<p>That said, I also don't really want us to go back on our usize promises, since I don't like the pattern of "well, only unsafe code depends on this so we can change it". Which it feels like we do a lot, tbh.</p>
<p>I do get that unsafe code can depend on literally any implementation detail of something -- stable and intentional or not -- but I don't think that means the things we make promises about should be considered any less binding than if it were a breaking change in any other API... honestly, I feel like it's <em>worse</em> -- in many cases the outcome for breaking <code>unsafe</code> guarantees is UB, rather than the compile error we'd get for most of the API breakage we try so hard to avoid (and if I were picking, I'd rather the compile error).</p>



<a name="274065254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065254">(Mar 04 2022 at 01:12)</a>:</h4>
<blockquote>
<p>We also sort of already have targets like these, in so far as people frequently hardcode lists of targets in <a href="http://build.rs">build.rs</a>, ignoring the existence of target json files (admittedly unstable, although this may add to my point in a sense).</p>
</blockquote>
<p>Or implementations that just have their own targets.</p>



<a name="274065309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065309">(Mar 04 2022 at 01:12)</a>:</h4>
<p>I do get that its not always that cut and dry (in some cases there's no reasonable way to support the things we told unsafe it was okay to do, I suppose), but... part of my feeling is: yeah, it is indeed a consequence of making a stability guarantee that there are some changes you may want to make in the future, which you don't get to make.</p>



<a name="274065356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065356">(Mar 04 2022 at 01:13)</a>:</h4>
<p>I said it before and I will say it again:<br>
Choosing the status quo is choosing an incoherent wasteland of UB which makes it harder, not easier, to write unsafe Rust.</p>



<a name="274065384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065384">(Mar 04 2022 at 01:13)</a>:</h4>
<p>And that is why I scrambled last month to fix asm.<br>
The issue here is that we're caught between a rock and a hard place.</p>
<p>We either pick the thing that's <em>de jur</em> breaking or the thing that's <em>de facto</em> breaking.</p>



<a name="274065445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065445">(Mar 04 2022 at 01:14)</a>:</h4>
<p>Or we make impossible legitimate, albeit niche, uses for rust.</p>



<a name="274065453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065453">(Mar 04 2022 at 01:14)</a>:</h4>
<p>Well, actually, we don't actually get to pick.</p>



<a name="274065481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065481">(Mar 04 2022 at 01:15)</a>:</h4>
<p>People will take the Rust toolchain and LLVM and they will modify it until it compiles for their target and then complain to us when our language doesn't allow a coherent story for doing so.</p>



<a name="274065518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065518">(Mar 04 2022 at 01:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274065481">said</a>:</p>
<blockquote>
<p>People will take the Rust toolchain and LLVM and they will modify it until it compiles for their target and then complain to us when our language doesn't allow a coherent story for doing so.</p>
</blockquote>
<p>Well, the choice I presented is for how to make this not a thing, at least in still-mostly-normal-target land.</p>



<a name="274065582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065582">(Mar 04 2022 at 01:16)</a>:</h4>
<p>(If someone's trying to compile rust to  the PDP-11, they'd be 100% SOL)</p>



<a name="274065605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065605">(Mar 04 2022 at 01:16)</a>:</h4>
<p>Sometimes we have a good answer for why we can tell them to, ah, accept they have done this to themselves, but other times we don't, and the answer is because a series of mistakes were made and every time someone tried to fix this everyone said "buuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuut if we actually pick something that has a coherent result, then we break something...?????"</p>



<a name="274065715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065715">(Mar 04 2022 at 01:18)</a>:</h4>
<p>If rust accepts <code>usize</code> as not simulateneously <code>size_t</code> and <code>uintptr_t</code>, then we either break the technically incorrect assumptions of a lot of code (including the interface of the standard library), or we break the actual guaranteed behaviour prescribed by the RFC.</p>



<a name="274065780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065780">(Mar 04 2022 at 01:20)</a>:</h4>
<p>This is actually <a href="https://github.com/rust-lang/lang-team/issues/125">lang-team#125</a>.</p>



<a name="274065822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065822">(Mar 04 2022 at 01:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274065445">said</a>:</p>
<blockquote>
<p>Or we make impossible legitimate, albeit niche, uses for rust.</p>
</blockquote>
<p>In various ways the decision to not support these was explicit. In the past I saw a modest amount of writing about the decision not to support targets without 8bit bytes -- yes, this does limit the situations where you can use rust, but it simplifies programming for everybody else enough to justify it.</p>
<p>If it were just w65, I would be more inclined to lump it in the same category (...especially given that it's a custom ABI), but CHERI does seem like it may become a platform that is hard to ignore.</p>



<a name="274065864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065864">(Mar 04 2022 at 01:21)</a>:</h4>
<blockquote>
<p>This is actually <a href="https://github.com/rust-lang/rust-lang/issues/125">rust-lang#125</a>.</p>
</blockquote>
<p>http 404</p>



<a name="274065938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065938">(Mar 04 2022 at 01:22)</a>:</h4>
<p>I don't think it was an explicit decision to not support size_t!=uintptr_t. RFC 0544 actually explicitly says that usize is not the same as size_t.</p>



<a name="274065993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065993">(Mar 04 2022 at 01:23)</a>:</h4>
<blockquote>
<p>especially given that it's a custom ABI</p>
</blockquote>
<p>To be fair, it's the only ABI for w65 that I've seen exist in any meaningful capacity. Any others probably existed in the 90s and ceased existing also in the 90s.</p>



<a name="274065994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274065994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274065994">(Mar 04 2022 at 01:23)</a>:</h4>
<p>Right, I didn't mean to imply the platform couldn't be supported, just that rust won't be quite as efficient on them.</p>



<a name="274066691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066691">(Mar 04 2022 at 01:30)</a>:</h4>
<p>Arm is going to be designing a new extension for Arm hardware based on CHERI, after they are done with Morello.</p>



<a name="274066720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066720">(Mar 04 2022 at 01:31)</a>:</h4>
<p>So yes, CHERI is going to become a lot harder to ignore.</p>



<a name="274066727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066727">(Mar 04 2022 at 01:31)</a>:</h4>
<p>Yeah, that seems to follow given the direction many of their extensions have been going recently.</p>



<a name="274066791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066791">(Mar 04 2022 at 01:32)</a>:</h4>
<p>(MTE, TBI, ptrauth, etc)</p>



<a name="274066797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066797">(Mar 04 2022 at 01:32)</a>:</h4>
<p>Yes.</p>



<a name="274066810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066810">(Mar 04 2022 at 01:32)</a>:</h4>
<p>And this has been an open request for Rust since, frankly, <del>2017</del> 2019.</p>



<a name="274066857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066857">(Mar 04 2022 at 01:33)</a>:</h4>
<p>The problem with the declaration is that the assumptions under which the promise was made do not actually hold.</p>



<a name="274066918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066918">(Mar 04 2022 at 01:34)</a>:</h4>
<p>I suppose, but it's not like CHERI can't be supported, just that it won't be as efficient.</p>



<a name="274066936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066936">(Mar 04 2022 at 01:34)</a>:</h4>
<p>Not really, it generates frankly UB because the datapath is still 64 bits.</p>



<a name="274066938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066938">(Mar 04 2022 at 01:34)</a>:</h4>
<p>Well, it breaks the code that assumes that <code>usize</code> is <code>size_t</code>.</p>



<a name="274066970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066970">(Mar 04 2022 at 01:35)</a>:</h4>
<p>(Particularily FFI code)</p>



<a name="274066974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066974">(Mar 04 2022 at 01:35)</a>:</h4>
<p>It is not like CHERI simply has "128 bit pointers".</p>



<a name="274066977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066977">(Mar 04 2022 at 01:35)</a>:</h4>
<p>It is not RV128.</p>



<a name="274066992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274066992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274066992">(Mar 04 2022 at 01:35)</a>:</h4>
<p>It actually has the memory address and the rest of the pointer as distinct concepts.</p>



<a name="274067078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067078">(Mar 04 2022 at 01:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274066938">said</a>:</p>
<blockquote>
<p>Well, it breaks the code that assumes that <code>usize</code> is <code>size_t</code>.</p>
</blockquote>
<p>There's a lot of rust code that assumes weird/wrong things about size_t already. Also, most of the code where that matters is calling into  C, and far more C code has issues here than Rust. (Even rather portable C codebases have trouble with CHERI)</p>



<a name="274067126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067126">(Mar 04 2022 at 01:37)</a>:</h4>
<p>So that does make manipulations that assume usize is the memory address... and there are many <strong>in std</strong>, some of them safe code... do undefined things if they try to use a u128 to interact with a 64-bit memory address.</p>



<a name="274067255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067255">(Mar 04 2022 at 01:39)</a>:</h4>
<p>Well, definitely if the platform has UB for safe code thats a huge problem. But the cases I'm most concerned about here is using size_of::&lt;usize&gt;() (or align_of::&lt;usize&gt;()) as a stand-in for pointer size/alignment in calculations, which I think wouldn't have a problem with what you describe.</p>



<a name="274067268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067268">(Mar 04 2022 at 01:39)</a>:</h4>
<p>Since those cases are the ones I don't really see a possible way to lint</p>



<a name="274067537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067537">(Mar 04 2022 at 01:42)</a>:</h4>
<blockquote>
<p>rustc tries to index into LLVM intrinsics such as memcpy with 128-bit integers. This isn't defined in the backend, and arguably shouldn't be defined.</p>
</blockquote>
<p>—Nicholas Wei Sheng Sim, author of "Strengthening memory safety in Rust: exploring<br>
CHERI capabilities for a safe language"</p>



<a name="274067672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067672">(Mar 04 2022 at 01:44)</a>:</h4>
<p>To quote a Rust programmer who has nothing to do with any of this nonsense, but who does write unsafe code from time to time:</p>
<blockquote>
<p>I'm happy to write different code<br>
I'm not happy to spend years living in a land of uncertainty where a shadowy cabal of undefined behavior knowers silently judge me for not writing the code they approve of but aren't documenting (because it's hard)</p>
</blockquote>



<a name="274067793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067793">(Mar 04 2022 at 01:45)</a>:</h4>
<p>Or worse, silently judge them for not writing the code they approve of but that isn't supported in current / stable rust</p>



<a name="274067876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067876">(Mar 04 2022 at 01:46)</a>:</h4>
<p>So our options are:</p>
<ul>
<li>Go back and fix our mistake</li>
<li>Demand LLVM support us indexing a 64-bit address space with 128-bit integers</li>
<li>Somehow rework our entire backend interface to make it so we somehow magically don't break this</li>
<li>Try to ignore CHERI, which has gotten harder every year and will continue growing harder</li>
</ul>



<a name="274067933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274067933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274067933">(Mar 04 2022 at 01:47)</a>:</h4>
<p>I believe it is our prerogative to say "eh, whatever" to non-flat address spaces.</p>



<a name="274068029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068029">(Mar 04 2022 at 01:49)</a>:</h4>
<p>But all the statements that <code>usize == uintptr_t</code> were premised on it also <strong>addressing the entire address space</strong>.</p>



<a name="274068232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068232">(Mar 04 2022 at 01:52)</a>:</h4>
<p>I don't think we should have <code>uintptr_t</code> at all. If we're thinking about CHERI, it doesn't make sense to do arithmetic on capabilities. Can someone give an example that requires specifically an <em>arithmetic type</em> which is <em>the size of a pointer</em>?</p>



<a name="274068337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068337">(Mar 04 2022 at 01:54)</a>:</h4>
<p>The CHERI C impl makes their uintptr_t a union of a pointer and integer for programmer convenience. I do not pretend there is any better reason. <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="274068341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068341">(Mar 04 2022 at 01:54)</a>:</h4>
<p>I'm imagining some C ABI that decides to use 128 bit integers to store rust slice pointers and just... no, you're doing it wrong</p>



<a name="274068440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068440">(Mar 04 2022 at 01:56)</a>:</h4>
<p>They have two reasons actually but I remember reading the first one and the second one (which explicitly states it's for convenience) and thinking "ah, so, programmer convenience both times."</p>



<a name="274068500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068500">(Mar 04 2022 at 01:57)</a>:</h4>
<p>but those are C reasons. The only reason they would affect rust is if we want ABI compatibility in FFI, and there are other ways to accomodate that</p>



<a name="274068789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274068789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274068789">(Mar 04 2022 at 02:00)</a>:</h4>
<p>yeah, NWWS said as much. We don't have to.</p>



<a name="274069052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069052">(Mar 04 2022 at 02:01)</a>:</h4>
<p>and we really do have to rework everything to make this happen, it's not really just a pessimization, because:</p>
<blockquote>
<p>The address space is 64 bits. ptr as int gives an LLVM i64, which can't be cast/isn't comparable to an i128; again there is no good reason to manipulate 128-bit integers here. Likewise when calling inttoptr, which is a valid instruction even if the result can't be dereferenced [5].</p>
</blockquote>



<a name="274069111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069111">(Mar 04 2022 at 02:02)</a>:</h4>
<p>what are you quoting?</p>



<a name="274069117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069117">(Mar 04 2022 at 02:02)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/65473">https://github.com/rust-lang/rust/issues/65473</a></p>



<a name="274069146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069146">(Mar 04 2022 at 02:02)</a>:</h4>
<p>I have also read his paper and a fair number of the other CHERI papers.</p>



<a name="274069394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069394">(Mar 04 2022 at 02:06)</a>:</h4>
<p>but as far as pessimizations go, 3.5 times as many instructions to do a bounds check, in <strong>Rust</strong>, is pretty bad.</p>



<a name="274069483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069483">(Mar 04 2022 at 02:08)</a>:</h4>
<p>Rust code does a nontrivial number of bounds checks but is fast because branch predictors are pretty damn good in the 2020s.</p>



<a name="274069715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069715">(Mar 04 2022 at 02:11)</a>:</h4>
<p>As a first attempt at a solution or at least progress on this issue, what about introducing type aliases like <code>uintptr_t</code> and friends to std, so that they can be used as vocabulary types? This will at least let people be more explicit when they want to be, and maybe that massive automatic code refactor will be more effective if they exist</p>



<a name="274069866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069866">(Mar 04 2022 at 02:13)</a>:</h4>
<p>This would also be painful on w65, where a register by register transfer (3 cycles) followed by a usually-constant (6 cycles) or else memory (7 cycles) comparison is being replaced by two memory-memory or memory constant comparisons, which requires a register load (6 cycles), comparison (6 or 7 cycles), branch (2 or 3 cycles), register load (6 cycles), comparison (6 or 7 cycles). <br>
So, 9-10 cycles vs. 22-29 cycles.</p>



<a name="274069933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069933">(Mar 04 2022 at 02:14)</a>:</h4>
<p>eh, 64kb should be enough for anyone</p>



<a name="274069959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069959">(Mar 04 2022 at 02:15)</a>:</h4>
<p>13 cycles is the difference between missing an hblank and not. 19 cycles is enough to take a serious bite out of the VBLANK time.</p>



<a name="274069970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069970">(Mar 04 2022 at 02:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274069933">said</a>:</p>
<blockquote>
<p>eh, 64kb should be enough for anyone</p>
</blockquote>
<p>Heh.</p>



<a name="274069988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274069988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274069988">(Mar 04 2022 at 02:15)</a>:</h4>
<p>Object size or AS Size.</p>



<a name="274070272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274070272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274070272">(Mar 04 2022 at 02:20)</a>:</h4>
<p>everything's an object &lt;/java&gt;</p>



<a name="274070314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274070314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274070314">(Mar 04 2022 at 02:21)</a>:</h4>
<p>Or C++.</p>



<a name="274070441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274070441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274070441">(Mar 04 2022 at 02:23)</a>:</h4>
<p>Even still, removing the second half of the comparison, there's still an extra 6 cycle load that didn't need  to exist for <code>usize</code>=6 <em>per bounds</em> check.</p>



<a name="274070876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274070876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274070876">(Mar 04 2022 at 02:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274069715">said</a>:</p>
<blockquote>
<p>As a first attempt at a solution or at least progress on this issue, what about introducing type aliases like <code>uintptr_t</code> and friends to std, so that they can be used as vocabulary types? This will at least let people be more explicit when they want to be, and maybe that massive automatic code refactor will be more effective if they exist</p>
</blockquote>
<p>we do have <code>core::ffi</code> now</p>



<a name="274071227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274071227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274071227">(Mar 04 2022 at 02:31)</a>:</h4>
<p>So, one of the objections to having those types (in either std or core) is precisely that if we have them that gives the implication that you're supposed to use them <em>instead</em> of <code>usize</code>.</p>



<a name="274071284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274071284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274071284">(Mar 04 2022 at 02:32)</a>:</h4>
<p>I don't think we're going to be able to successfully stabilize those without consensus on at least the question of whether <code>usize</code> is <code>size_t</code>.</p>



<a name="274071309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274071309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274071309">(Mar 04 2022 at 02:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274071227">said</a>:</p>
<blockquote>
<p>So, one of the objections to having those types (in either std or core) is precisely that if we have them that gives the implication that you're supposed to use them <em>instead</em> of <code>usize</code>.</p>
</blockquote>
<p>Yes, I'd argue that's the intention.</p>



<a name="274071380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274071380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274071380">(Mar 04 2022 at 02:33)</a>:</h4>
<p>I would agree this is squarely inside the <a href="https://github.com/rust-lang/lang-team/issues/125">lang-team#125</a> proposal, though.</p>



<a name="274072074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072074">(Mar 04 2022 at 02:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274071284">said</a>:</p>
<blockquote>
<p>I don't think we're going to be able to successfully stabilize those without consensus on at least the question of whether <code>usize</code> is <code>size_t</code>.</p>
</blockquote>
<p>I think it is not in question that <code>usize</code> is <code>size_t</code> on all currently supported platforms. So presumably we should start thinking about ways to incorporate compile time checks like <code>cfg(usize_is_size_t)</code> that are true today on all platforms but might become false on future platforms</p>



<a name="274072112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072112">(Mar 04 2022 at 02:43)</a>:</h4>
<p>Adding such mechanisms is not itself a breaking change</p>



<a name="274072178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072178">(Mar 04 2022 at 02:44)</a>:</h4>
<p>and we can't properly address the breaking part of the change until those mechanisms have had some time to stew in the ecosystem</p>



<a name="274072358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072358">(Mar 04 2022 at 02:47)</a>:</h4>
<p>This might be a good idea.</p>



<a name="274072380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072380">(Mar 04 2022 at 02:47)</a>:</h4>
<p>Although it leads to the bikeshedding of "Is <code>usize</code> <code>size_t</code> or <code>uintptr_t</code>" all over again.</p>



<a name="274072659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072659">(Mar 04 2022 at 02:51)</a>:</h4>
<p><code>cfg(usize_is_size_t_and_also_uintptr_t)</code></p>



<a name="274072732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072732">(Mar 04 2022 at 02:52)</a>:</h4>
<p><code>..._and_dont_forget_ptraddr_t_and_ptrdiff_t)</code></p>



<a name="274072756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072756">(Mar 04 2022 at 02:53)</a>:</h4>
<p>lmao</p>



<a name="274072757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072757">(Mar 04 2022 at 02:53)</a>:</h4>
<p>...</p>



<a name="274072779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072779">(Mar 04 2022 at 02:53)</a>:</h4>
<p><code>cfg(ptr_width_is_size_width)</code></p>



<a name="274072832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072832">(Mar 04 2022 at 02:54)</a>:</h4>
<p>Along with <code>cfg(target_size_width = "*")</code></p>



<a name="274072871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072871">(Mar 04 2022 at 02:54)</a>:</h4>
<p><code>if c_size_t::BITS == usize::BITS &amp;&amp; c_uintptr_t::BITS == usize::BITS {</code></p>



<a name="274072907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072907">(Mar 04 2022 at 02:55)</a>:</h4>
<p>I think you will need cfgs for some of this since you will get type errors if a type synonym isn't one anymore</p>



<a name="274072999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274072999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274072999">(Mar 04 2022 at 02:56)</a>:</h4>
<p>that's comparing u32s</p>



<a name="274073095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274073095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274073095">(Mar 04 2022 at 02:57)</a>:</h4>
<p>Yes that check itself is fine (and can even be done in a const fn) but it might be guarding some <code>foo(*const T as usize: uintptr_t)</code> stuff that would not compile even if it is on a compile time skipped branch</p>



<a name="274073180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274073180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274073180">(Mar 04 2022 at 02:58)</a>:</h4>
<p>ohhh</p>



<a name="274073231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274073231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274073231">(Mar 04 2022 at 02:59)</a>:</h4>
<p>I have managed to make Rust accept some surprising things gated by an <code>if</code>, but fair enough.</p>



<a name="274076984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274076984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274076984">(Mar 04 2022 at 03:55)</a>:</h4>
<p>Yeah, reading the actual RFCs, the justification for "usize == uintptr_t" is continuously predicated on "Rust assumes a flat address space."</p>



<a name="274077050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274077050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274077050">(Mar 04 2022 at 03:56)</a>:</h4>
<p>So yes, we can resolve to say "meh" to segmented memory if we want, but we don't actually have the same argument against CHERI pointers.</p>



<a name="274080611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274080611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274080611">(Mar 04 2022 at 04:58)</a>:</h4>
<p>...absolutely magnificent.</p>



<a name="274080679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274080679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274080679">(Mar 04 2022 at 04:59)</a>:</h4>
<p>On CHERI, these are both true:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="n">UINTPTR_MAX</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UINT64_MAX</span><span class="w"></span>
</code></pre></div>
<p>beautiful</p>



<a name="274254493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274254493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274254493">(Mar 05 2022 at 17:15)</a>:</h4>
<p>FWIW I fully agree with treating CHERI as "its a 64bit address and then some other stuff so the entire pointer has size 128bits", and interpreting ptr &lt;-&gt; usize casts as extracting the address from a pointer and synthesizing a pointer from an address. I said as much already back in <a href="https://internals.rust-lang.org/t/pre-rfc-usize-is-not-size-t/15369/52?u=ralfjung">https://internals.rust-lang.org/t/pre-rfc-usize-is-not-size-t/15369/52?u=ralfjung</a>. :)<br>
and indeed the API <code>ptr.map(|addr| addr | BITFLAG)</code> that already came up in the discussion around provenance would neatly handle the case of preserving CHERI permissions while manipulating the address.</p>



<a name="274254559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274254559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274254559">(Mar 05 2022 at 17:16)</a>:</h4>
<p>(that is not too surprising because one way to view CHERI is as a machine where something like Rust's Abstract Machine provenance <em>exists even on the physical machine</em>)</p>



<a name="274889516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274889516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274889516">(Mar 10 2022 at 20:16)</a>:</h4>
<p>One thing I'd note.<br>
If we do support this, I'd strongly recommend that ptraddr_t be exposition only (and not actually defined).<br>
Consider the 8086 example: ptraddr_t is a u20, containing a 20-bit linear address, simple.<br>
But what if it's i386 16-bit protected mode (cr0.PE=1, css.Sz=0), which leaves linear addresses up to 32-bit, even after segmentation. Or Even i286 protected mode (msw.PE=1), which is 24-bit. Additionally, in these modes, it's generally impossible for unprivileged code to compute the segment base (it requires finding the global descriptor table, which may not exist in the available address space or segment space)</p>
<p>In all cases, uintptr_t would still be 32-bit (seg,offset), and the difference is nearly transparent, and the codegen is largely the same: load the segment into ds, es, or (where available) gs, load the offset into bx, execute the instruction with the appropriate segment override prefix (if needed). However, computing the linear address in these modes is different (and, as mentioned, potentially impossible).</p>



<a name="274912023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274912023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274912023">(Mar 10 2022 at 23:42)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> I'm not very familiar with 8086 architecture, but I don't understand how it could be impossible to convert a pointer to an integer in principle (although I agree on the main point that we don't need this type to exist). Unless the memory is protected in some way, wouldn't you always be able to take a pointer, write it to memory and then read the 32-bits just written as an integer value? If some part of the address is hidden from user code, then presumably it is also hidden from writes to memory so the pointer type would end up just being the linear address part.</p>



<a name="274915742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274915742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274915742">(Mar 11 2022 at 00:23)</a>:</h4>
<p>It's fine to convert to uintptr_t,  that's just segment&lt;&lt;16|offset.<br>
The issue is ptraddr_t, which would be the linear address (as noted above).</p>



<a name="274915834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274915834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274915834">(Mar 11 2022 at 00:24)</a>:</h4>
<p>It's either <code>segment_base&lt;&lt;4+offset</code> or <code>segment_selector.base+offset</code>, and the latter may be impossible to get.</p>



<a name="274916032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274916032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274916032">(Mar 11 2022 at 00:26)</a>:</h4>
<p><code>segment_base&lt;&lt;4+offset</code> -- don't forget the optional <code>% 0x100000</code>, A20 shenanigans!</p>



<a name="274916065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274916065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274916065">(Mar 11 2022 at 00:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/274916032">said</a>:</p>
<blockquote>
<p><code>segment_base&lt;&lt;4+offset</code> -- don't forget the optional <code>% 0x100000</code>, A20 shenanigans!</p>
</blockquote>
<p>Or on an actual 8086/80186.</p>



<a name="274916335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274916335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274916335">(Mar 11 2022 at 00:29)</a>:</h4>
<p>so...on 80286+ in real mode, you get addresses from <code>0x0</code> to <code>0x10FFEF</code></p>



<a name="274916397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274916397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274916397">(Mar 11 2022 at 00:30)</a>:</h4>
<p>so just <code>u20</code> isn't sufficient</p>



<a name="274916420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274916420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274916420">(Mar 11 2022 at 00:30)</a>:</h4>
<p>Yep, if the A20 gate is enabled (or DNE).</p>



<a name="274916645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274916645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274916645">(Mar 11 2022 at 00:32)</a>:</h4>
<p>And that's even more impossible to figure out.</p>



<a name="274917049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917049">(Mar 11 2022 at 00:36)</a>:</h4>
<p>it's like if <code>ptraddr_t</code> were Rust's <code>char</code>, but worse and more obscure</p>



<a name="274917211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917211">(Mar 11 2022 at 00:38)</a>:</h4>
<p>Welcome to old x86.<br>
I don't know why I have a fixation on supporting it, but I mostly already do, so...</p>



<a name="274917255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917255">(Mar 11 2022 at 00:38)</a>:</h4>
<p>I believe we call that "sunk cost fallacy"</p>



<a name="274917272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917272">(Mar 11 2022 at 00:39)</a>:</h4>
<p>Not even.</p>



<a name="274917289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917289">(Mar 11 2022 at 00:39)</a>:</h4>
<p>The "mostly already do" is 85% coincidence (and 15% I was bored and it's right there, so why not).</p>



<a name="274917379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917379">(Mar 11 2022 at 00:40)</a>:</h4>
<p>(I also like technology that's older than I am, so...)</p>



<a name="274917462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917462">(Mar 11 2022 at 00:41)</a>:</h4>
<p>maybe because a huge number of people have hardware that can natively run it (basically all x86 computers), and because both gcc and llvm don't really support it?</p>



<a name="274917574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274917574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274917574">(Mar 11 2022 at 00:43)</a>:</h4>
<p>Maybe. Beating llvm and gcc in something in version 1.0 of lccc would be very nice.</p>



<a name="274919929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/274919929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#274919929">(Mar 11 2022 at 01:15)</a>:</h4>
<p>I am reminded of the Data General Eclipse <a href="https://www.youtube.com/watch?v=ok1pTr2i5BE">https://www.youtube.com/watch?v=ok1pTr2i5BE</a><br>
from <a href="https://begriffs.com/posts/2018-11-15-c-portability.html">https://begriffs.com/posts/2018-11-15-c-portability.html</a></p>
<div class="youtube-video message_inline_image"><a data-id="ok1pTr2i5BE" href="https://www.youtube.com/watch?v=ok1pTr2i5BE"><img src="https://uploads.zulipusercontent.net/76e373b3a76252f4c3c18b67594d5c1645ce9643/68747470733a2f2f692e7974696d672e636f6d2f76692f6f6b3170547232693542452f64656661756c742e6a7067"></a></div><blockquote>
<p>This machine uses a different numbering scheme for character- and integer-pointers. The same location in memory must be referred to by different addresses depending on the pointer type. A cast between char* and int* actually changes the address inside the pointer.</p>
</blockquote>



<a name="275126463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275126463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275126463">(Mar 13 2022 at 01:31)</a>:</h4>
<p>Anyways I agree that if we mention <code>ptraddr_t</code> we don't invest deeply into a rigid definition of it, it's mostly indicating the concept is Out There.</p>
<p>Also, I dug around and found out that RV128's C data model will have both "far" pointers and "near" pointers, indicated by an <code>[[attribute]]</code>.</p>



<a name="275126586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275126586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275126586">(Mar 13 2022 at 01:35)</a>:</h4>
<p>The way I'd define it is</p>
<blockquote>
<p><code>ptraddr_t</code>is an <em>exposition-only</em> integer type that can uniquely represent an address in memory, but might not exactly represent the entire value of a pointer.</p>
</blockquote>



<a name="275128870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275128870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275128870">(Mar 13 2022 at 02:41)</a>:</h4>
<p>that doesn't hold up to actual inspection unfortunately, the same way trying to have our cake and eat it too for "<code>usize</code> is not <code>size_t</code>" didn't work out. it would be fairly minor since it's just non-normative RFC verbiage but</p>



<a name="275942957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275942957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275942957">(Mar 20 2022 at 02:42)</a>:</h4>
<p>I've been under the impression that the CHERI folks implementing intptr_t like that is less "ah yes this is good and desirable" and more "god damnit there's so much bad code we need to get to work, ok fine we'll do this hack".</p>
<p>In that vein if we replaced intptr casts with cheri_address_set, it's unclear if we would at all need an intptr_t equivalent. usize==size_t/ptrdiff_t would be adequate for any application I can imagine (I can only really imagine Reasonable tagged pointer shenanigans and Dubious serialization schemes)</p>



<a name="275969685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275969685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275969685">(Mar 20 2022 at 14:24)</a>:</h4>
<p>I have updated my article to more clearly discuss this: <a href="https://gankra.github.io/blah/fix-rust-pointers/#redefining-usize">https://gankra.github.io/blah/fix-rust-pointers/#redefining-usize</a></p>



<a name="275972187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972187">(Mar 20 2022 at 15:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275969685">said</a>:</p>
<blockquote>
<p>I have updated my article to more clearly discuss this: <a href="https://gankra.github.io/blah/fix-rust-pointers/#redefining-usize">https://gankra.github.io/blah/fix-rust-pointers/#redefining-usize</a></p>
</blockquote>
<p>In that section you state that <code>usize</code> can "represent all addresses in all address spaces". If I'm understanding correctly, that would be <code>ptraddr_t</code>? <br>
As mentioned above, on non-flat 8086, <code>ptraddr_t</code> would store a linear address which is not portable (and, as mentioned, may not be possible in all cases) to compute between 16-bit address modes of x86, so I'd prefer rust not expose a mechanism to obtain that.</p>



<a name="275972230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972230">(Mar 20 2022 at 15:25)</a>:</h4>
<p>Anything in reference to segmenting is definitely a big handwave, but I think it's fair to say there can still be some segmented architectures where we should be willing to say "sorry no that's too cursed, do better"</p>



<a name="275972301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972301">(Mar 20 2022 at 15:27)</a>:</h4>
<p>Never thought I'd see the day when x86 is the architecture being called "too cursed" <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span>.</p>



<a name="275972308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972308">(Mar 20 2022 at 15:27)</a>:</h4>
<p>from what i've heard of non-flat 8086 (the fact that segments actually <em>overlap</em> <span aria-label="scream cat" class="emoji emoji-1f640" role="img" title="scream cat">:scream_cat:</span>) it legit sounds kinda cursed lol</p>



<a name="275972375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972375">(Mar 20 2022 at 15:28)</a>:</h4>
<p>Still, I wonder if this wouldn't be a more general problem.<br>
Real/v8086 mode x86 is easy. Simply do u20/u21 arithmetic with segment&lt;&lt;4 and offset.<br>
16-bit protected mode on both the 286 and 386+ are <em>fun</em> though.</p>



<a name="275972390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972390">(Mar 20 2022 at 15:29)</a>:</h4>
<p>(And in all other respects, 16-bit protected mode is basically transparent to real mode)</p>



<a name="275972469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275972469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275972469">(Mar 20 2022 at 15:31)</a>:</h4>
<p>but like I said, this is outside my domain of expertese and I'm trying to just use the "well we need to fuck with this anyway for CHERI" situation as a chance to maybe open the door to segmentation getting better support. someone more in-the-know needs to figure out if that's possible.</p>



<a name="275974672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275974672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275974672">(Mar 20 2022 at 16:22)</a>:</h4>
<p>interesting context/feedback from actual CHERI person: <a href="https://lobste.rs/s/mptezc/rust_s_unsafe_pointer_types_need_overhaul#c_qbamrf">https://lobste.rs/s/mptezc/rust_s_unsafe_pointer_types_need_overhaul#c_qbamrf</a></p>



<a name="275975385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275975385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275975385">(Mar 20 2022 at 16:39)</a>:</h4>
<p>CHERI is fundamentally incompatible with the existing C-based world by spec, and in practice for most anything doing anything seriously low level. Even segmented x86 targets are probably more compatible, and that's starting at "by accident" and "without too much modification". If rust still wants to claim to be a good replacement for low level code, "need to support CHERI" as an excuse for ripping out features is uhhh... a choice.</p>



<a name="275976320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976320">(Mar 20 2022 at 16:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275972301">said</a>:</p>
<blockquote>
<p>Never thought I'd see the day when x86 is the architecture being called "too cursed" <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span>.</p>
</blockquote>
<p>x86 in real mode is absolutely the most cursed architecture we practically deal with.</p>



<a name="275976417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976417">(Mar 20 2022 at 16:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275975385">said</a>:</p>
<blockquote>
<p>CHERI is fundamentally incompatible with the existing C-based world by spec, and in practice for most anything doing anything seriously low level. Even segmented x86 targets are probably more compatible, and that's starting at "by accident" and "without too much modification". If rust still wants to claim to be a good replacement for low level code, "need to support CHERI" as an excuse for ripping out features is uhhh... a choice.</p>
</blockquote>
<p>Precise compatibility with C, at the end of the day, is not actually a strict goal of Rust.</p>



<a name="275976532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976532">(Mar 20 2022 at 16:52)</a>:</h4>
<p>And C is incompatible in actual fact with many things, in spite of the advertisements otherwise. When we actually turn the lights on, we find that almost no compiler actually implements "Standard C" for all supported architectures, and that doing so in a strict sense often can and does make the compiler incompatible with many architectures.</p>



<a name="275976814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976814">(Mar 20 2022 at 16:58)</a>:</h4>
<p>Having less "features" <em>stricto sensu</em> but having more features you can actually <strong>rely on</strong> because they aren't something pulled directly out of a compiler writer's ass and subject to change upon the next compiler revision is, in fact, an actual selling point. Enormous amounts of embedded software programmers simply do not upgrade compilers because doing so often utterly and completely shatters their entire program's functionality. And all of the "things C can do" people are talking about when we discuss these are in fact within that domain.</p>



<a name="275976826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976826">(Mar 20 2022 at 16:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275976417">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275975385">said</a>:</p>
<blockquote>
<p>CHERI is fundamentally incompatible with the existing C-based world by spec, and in practice for most anything doing anything seriously low level. Even segmented x86 targets are probably more compatible, and that's starting at "by accident" and "without too much modification". If rust still wants to claim to be a good replacement for low level code, "need to support CHERI" as an excuse for ripping out features is uhhh... a choice.</p>
</blockquote>
<p>Precise compatibility with C, at the end of the day, is not actually a strict goal of Rust.</p>
</blockquote>
<p>Right, but rust should be useful for systems programming as it does at least somewhat claim (and people do use it for).</p>



<a name="275976952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976952">(Mar 20 2022 at 17:00)</a>:</h4>
<p>Yeah the C standard is in some sense irrelevant insofar as it is more <em>descriptive</em> than <em>prescriptive</em> since there are a billion jacked up compilers in production, most notably msvc</p>



<a name="275976959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976959">(Mar 20 2022 at 17:01)</a>:</h4>
<p>Indeed.<br>
I reserve my withering criticism simply for the "but C does this!" excuse.</p>



<a name="275976977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976977">(Mar 20 2022 at 17:01)</a>:</h4>
<p>what matters is compatibility with actual platform ABIs, which are expressed in C, but only given actual meaning by <em>the blessed C compiler of that platform</em></p>



<a name="275976988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275976988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275976988">(Mar 20 2022 at 17:01)</a>:</h4>
<p>"Show me the money", in other words. Or, well, actual use cases. Then we can talk.</p>



<a name="275977126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977126">(Mar 20 2022 at 17:04)</a>:</h4>
<p>My use cases for 8086 is largely the same as for w65, aka mountain climber reasoning.</p>



<a name="275977143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977143">(Mar 20 2022 at 17:04)</a>:</h4>
<p>That being said, it would be useful for writing pre-protected mode bootloaders in not pure assembly.</p>



<a name="275977168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977168">(Mar 20 2022 at 17:05)</a>:</h4>
<p>out of curiosity does much code <em>actually</em> run in that mode? i would have assumed you spend basically 0 time going "fuck fuck fuck please by 32-bit" and are good to go</p>



<a name="275977229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977229">(Mar 20 2022 at 17:06)</a>:</h4>
<p>(assuming we're talking about the bootloader for a modern PC and not an actual 8086)</p>



<a name="275977302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977302">(Mar 20 2022 at 17:08)</a>:</h4>
<p>There is some setup that needs to be done before you an go to 32-bit protected mode.<br>
Legacy BIOS bootloaders also sometimes will revert to real mode to do disk I/O.</p>



<a name="275977305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977305">(Mar 20 2022 at 17:08)</a>:</h4>
<p>Yeah what would that bootloader actually look like?</p>



<a name="275977318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977318">(Mar 20 2022 at 17:09)</a>:</h4>
<p>At least some of the bootloader code I have actually read has been "something that can only be expressed in pure assembly anyways".</p>



<a name="275977385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977385">(Mar 20 2022 at 17:10)</a>:</h4>
<p>That being said, I don't see a huge amount of code doing this. 8086 is mostly mountain climber reasoning, aka. because it's there.</p>



<a name="275977403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977403">(Mar 20 2022 at 17:10)</a>:</h4>
<p>(Even moreso than w65, which could legitimately be used to write SNES homebrew)</p>



<a name="275977562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977562">(Mar 20 2022 at 17:14)</a>:</h4>
<p>With <em>that</em> being said, though, I still don't think rust should place unreasonable restrictions on targets, and that if it accepts CHERI and w65 it should reasonably accept <code>-mfar-ptr</code> 8086.</p>



<a name="275977574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977574">(Mar 20 2022 at 17:14)</a>:</h4>
<p>(Unless there's a fairly good reason not to)</p>



<a name="275977679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977679">(Mar 20 2022 at 17:17)</a>:</h4>
<p>Oh so we probably may have to think, unfortunately, about far pointers and near pointers, into the future as well. Did I mention that?</p>



<a name="275977763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275977763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275977763">(Mar 20 2022 at 17:19)</a>:</h4>
<p>RV128's ABI, as it is currently being described, has <code>[[far]] void *</code> and <code>[[near]] void *</code>. The model still uses a flat address space, as I understand it? But they are differently sized because you almost never need to actually use the full address space.</p>



<a name="275978470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275978470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275978470">(Mar 20 2022 at 17:35)</a>:</h4>
<p>Nice.</p>



<a name="275979473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275979473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275979473">(Mar 20 2022 at 17:56)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> the doc is very unclear but it sounds a lot like they're just describing the same thing that x32 is and that far pointers aren't something you would really use (but they decided to define because they can, or maybe they show up as like types for syscalls or something)</p>



<a name="275979723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275979723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275979723">(Mar 20 2022 at 18:01)</a>:</h4>
<p><em>nod.</em><br>
Yes, it basically is more like x32 than anything.</p>



<a name="275979795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275979795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275979795">(Mar 20 2022 at 18:02)</a>:</h4>
<p>well i kind of specified that backwards: far pointers aren't a thing to use <em>because near pointers are the default and would span your process' memory anyway</em></p>



<a name="275979810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275979810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275979810">(Mar 20 2022 at 18:03)</a>:</h4>
<p>as in they are not near pointers in like, the 8086 "completely unsound to handle" sense</p>



<a name="275982101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275982101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275982101">(Mar 20 2022 at 18:54)</a>:</h4>
<p>Right.</p>



<a name="275985858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275985858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275985858">(Mar 20 2022 at 20:23)</a>:</h4>
<p>well, i'm hoping rust will eventually be able to compile code for <a href="https://www.freedos.org/">https://www.freedos.org/</a></p>



<a name="275986320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275986320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275986320">(Mar 20 2022 at 20:35)</a>:</h4>
<p>...what's <code>size_t</code> on FreeDOS, pray tell</p>



<a name="275987175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275987175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275987175">(Mar 20 2022 at 20:53)</a>:</h4>
<p>I assume u16</p>



<a name="275989910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275989910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275989910">(Mar 20 2022 at 21:56)</a>:</h4>
<p>is it UB in C to have objects that straddle address spaces in cases where the segmentation allows that <strong>in theory</strong>?</p>



<a name="275989941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275989941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275989941">(Mar 20 2022 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> I could go check the standard but I think asking you is a touch faster.</p>



<a name="275990196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990196">(Mar 20 2022 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275989910">said</a>:</p>
<blockquote>
<p>is it UB in C to have objects that straddle address spaces in cases where the segmentation allows that <strong>in theory</strong>?</p>
</blockquote>
<p>I don't think it is <em>per se</em> but C compilers get a lot of freedom in where it puts objects, so it could just have that not happen and just assume it to not be possible.</p>



<a name="275990199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990199">(Mar 20 2022 at 22:02)</a>:</h4>
<p>ahkay.</p>



<a name="275990207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990207">(Mar 20 2022 at 22:03)</a>:</h4>
<p>Address spaces aren't even a concept in C.</p>



<a name="275990297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990297">(Mar 20 2022 at 22:05)</a>:</h4>
<p>Right, C doesn't ever look directly at a lot of things, just handwave a lot to allow enough freedom to implementers to cope with that stuff... and even then, people often can't encode it without breaking the standard and such (or at least a lot of compiler extensions... sometimes you drive past ISO C, sometimes you drive through it).</p>
<p>Okay, so, tell me how your compiler intends to handle the entire memory segmentation dealio.</p>



<a name="275990423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990423">(Mar 20 2022 at 22:08)</a>:</h4>
<p>An object can only be allocated entirely within a segment, and cannot rely on intra-segment wrapping. <br>
Pointers are either near (simply offset) or far (segment:offset), near data pointers resolved using ds, near function pointers using cs, far pointers store the segment or segment selector in the upper word of the dword pointer, with offset in lower word. <br>
The model picks the default pointer kind (<code>-mnear-ptr</code>/<code>-mflat</code> vs. <code>-mfar-ptr</code>), and on everything other than flat, <code>_near</code> and <code>_far</code> override the default (in C, idk how this would be represented in rust).</p>



<a name="275990443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990443">(Mar 20 2022 at 22:09)</a>:</h4>
<p><code>-mflat</code>?</p>



<a name="275990498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990498">(Mar 20 2022 at 22:10)</a>:</h4>
<p><code>-mflat</code> is ss.base==cs.base==ds.base (or ss==cs==ds in actual real mode). IE. no segmentation (other than for TLS)</p>



<a name="275990508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990508">(Mar 20 2022 at 22:10)</a>:</h4>
<p>Worth nothing that C of yore is very different from today's C. I don't think people back then had the time to worry about provenance and whatnot when they had to fit everything into kilobytes.</p>



<a name="275990512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990512">(Mar 20 2022 at 22:11)</a>:</h4>
<p>Correct.</p>



<a name="275990568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990568">(Mar 20 2022 at 22:12)</a>:</h4>
<p>So: How big do you think a <code>*const T</code> should be?</p>



<a name="275990602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990602">(Mar 20 2022 at 22:13)</a>:</h4>
<p>(I myself only had an opportunity to write some assembly for x86_16, it was an interesting experience) I would say 16 bits. Carrying around segment information alongside pointers would be prohibitively expensive for that sort of architecture.</p>



<a name="275990641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990641">(Mar 20 2022 at 22:14)</a>:</h4>
<p>On <code>-mfar-ptr</code>, 32, being 16:16.</p>



<a name="275990651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990651">(Mar 20 2022 at 22:14)</a>:</h4>
<p>I could see a <code>target-feature</code> which enables -mfar-ptr equivalent, though, sure.</p>



<a name="275990653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990653">(Mar 20 2022 at 22:14)</a>:</h4>
<p>On <code>-mnear-ptr</code>/<code>-mflat</code> it's 16 (just the offset).</p>



<a name="275990671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990671">(Mar 20 2022 at 22:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275990651">said</a>:</p>
<blockquote>
<p>I could see a <code>target-feature</code> which enables -mfar-ptr equivalent, though, sure.</p>
</blockquote>
<p>It wouldn't be a target-feature. I'd expect it to either be part of the sys component, or a separate (probably <code>-Z</code>) option.</p>



<a name="275990679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990679">(Mar 20 2022 at 22:15)</a>:</h4>
<p>...actually a target feature might be a good idea.</p>



<a name="275990716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990716">(Mar 20 2022 at 22:16)</a>:</h4>
<p>(Also technically <code>-mnear-ptr</code> and <code>-mfar-ptr</code> aren't the whole extend, since lccc will allow separate defaults for fn vs. data pointers, <code>-mnear-data-ptr</code>/<code>-mfar-fn-ptr</code>)</p>



<a name="275990722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990722">(Mar 20 2022 at 22:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275990679">said</a>:</p>
<blockquote>
<p>...actually a target feature might be a good idea.</p>
</blockquote>
<p>It's not really a binary choice, though.</p>



<a name="275990731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990731">(Mar 20 2022 at 22:16)</a>:</h4>
<p>Well, it is, but it's not "enable/disable" it's pick one of two options.</p>



<a name="275990732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990732">(Mar 20 2022 at 22:16)</a>:</h4>
<p><code>#[target_feature(enable)]</code></p>



<a name="275990736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990736">(Mar 20 2022 at 22:17)</a>:</h4>
<p>(Also, it affects ABI, so the entire crate would need to be compiled with the same option)</p>



<a name="275990744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990744">(Mar 20 2022 at 22:17)</a>:</h4>
<p>nah, you can have divergent ABI internally.</p>



<a name="275990751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990751">(Mar 20 2022 at 22:17)</a>:</h4>
<p>Well, not if you want to be able to call functions</p>



<a name="275990795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990795">(Mar 20 2022 at 22:18)</a>:</h4>
<p>you can call functions without function pointers in Rust.</p>



<a name="275990797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990797">(Mar 20 2022 at 22:18)</a>:</h4>
<p>it'd be problematic if you implicitly lose the information about segment as a result of returning/passing in as an arugment a pointer.</p>



<a name="275990805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990805">(Mar 20 2022 at 22:19)</a>:</h4>
<p>Fair (although xir needs a function pointer for it's <code>call</code> instruction). But function pointers need to be callable.</p>



<a name="275990816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990816">(Mar 20 2022 at 22:19)</a>:</h4>
<p>Right, of course.<br>
You can choose to mix up <code>*const T</code> and <code>*mut T</code> repr based on <code>T</code>, though.</p>



<a name="275990858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990858">(Mar 20 2022 at 22:20)</a>:</h4>
<p><em>shudders</em></p>



<a name="275990860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990860">(Mar 20 2022 at 22:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275990797">said</a>:</p>
<blockquote>
<p>it'd be problematic if you implicitly lose the information about segment as a result of returning/passing in as an arugment a pointer.</p>
</blockquote>
<p>Worse still, you don't lose the segment, but you pass two near pointers and a size_t into memcpy, and memcpy reads out two far ptrs and an size_t.</p>



<a name="275990861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990861">(Mar 20 2022 at 22:20)</a>:</h4>
<p>:3</p>



<a name="275990880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990880">(Mar 20 2022 at 22:21)</a>:</h4>
<p>heh.</p>



<a name="275990899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990899">(Mar 20 2022 at 22:21)</a>:</h4>
<p>And then you realise that you passed 0x8730:0x8770. 0x3333:0x0010, 0x3333 to memcpy.</p>



<a name="275990935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990935">(Mar 20 2022 at 22:22)</a>:</h4>
<p>hahahaha.</p>



<a name="275990938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275990938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275990938">(Mar 20 2022 at 22:22)</a>:</h4>
<p>Where <code>0x3333</code> is just a stand in for an uninitialized register, or stack slot.</p>



<a name="275991023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991023">(Mar 20 2022 at 22:24)</a>:</h4>
<p>I am growing into the notion of some kind of <code>Far&lt;T&gt;</code> for the niche cases where we have to cope with it.</p>



<a name="275991027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991027">(Mar 20 2022 at 22:24)</a>:</h4>
<p>at that point two distinct targets make most sense to me, just like there are targets for <code>x86_64-...-gnu</code> and <code>x86_64-...-gnu32</code>.</p>



<a name="275991034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991034">(Mar 20 2022 at 22:25)</a>:</h4>
<p>Yeah.</p>



<a name="275991039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991039">(Mar 20 2022 at 22:25)</a>:</h4>
<p>Although technically it's 5 distinct targets.</p>



<a name="275991041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991041">(Mar 20 2022 at 22:25)</a>:</h4>
<p>And yes, from our perspective these are different target tuples.</p>



<a name="275991047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991047">(Mar 20 2022 at 22:26)</a>:</h4>
<p><code>flat</code>, <code>near-data-near-fn</code> (<code>near-ptr</code>), <code>near-data-far-fn</code>, <code>far-data-near-fn</code>, <code>far-data-far-fn</code> (<code>far-ptr</code>)</p>



<a name="275991087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991087">(Mar 20 2022 at 22:26)</a>:</h4>
<p>To a certain degree, a target feature is already "a different target tuple but one you can interact with in a sufficiently well-defined way".</p>



<a name="275991096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991096">(Mar 20 2022 at 22:26)</a>:</h4>
<p>isn't flat a subset of <code>near-ptr</code> given that all segments are made the same anyway?</p>



<a name="275991107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991107">(Mar 20 2022 at 22:27)</a>:</h4>
<p>that is “near-ptr” code should work equally well where flat is expected.</p>



<a name="275991108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991108">(Mar 20 2022 at 22:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275991096">said</a>:</p>
<blockquote>
<p>isn't flat a subset of <code>near-ptr</code> given that all segments are made the same anyway?</p>
</blockquote>
<p>From lccc's perspective, it would be a separate target with separate properties (Since it sets <code>farptrbits</code>=<code>nearptrbits</code>=<code>ptrbits</code>=16)</p>



<a name="275991111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991111">(Mar 20 2022 at 22:27)</a>:</h4>
<p>Whereas <code>near-ptr</code> is <code>farptrbits</code>=32, <code>nearptrbits</code>=<code>ptrbits</code>=16.</p>



<a name="275991113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991113">(Mar 20 2022 at 22:27)</a>:</h4>
<p>okay.</p>



<a name="275991165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991165">(Mar 20 2022 at 22:28)</a>:</h4>
<p>(<code>flat</code> is "there is no segmentation it's all the same", vs. <code>near-tr</code> with "There is segmentation, but you don't see it by default")</p>



<a name="275991296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991296">(Mar 20 2022 at 22:32)</a>:</h4>
<p>And yeah, to handle this, rust would probably want a <code>NearPtr&lt;T&gt;</code> and <code>FarPtr&lt;T&gt;</code>, which would be pure compiler magic basically.</p>



<a name="275991362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991362">(Mar 20 2022 at 22:34)</a>:</h4>
<p>But logically be a <code>#[repr(transparent)] struct NearPtr&lt;T: ?Sized&gt;(u16,/*as-near*/&lt;&lt;T as Pointee&gt;::Metadata&gt;);</code> and <code>#[repr(transparent)] struct FarPtr&lt;T: ?Sized&gt;(u16,u16,/*as-far*/&lt;&lt;T as Pointee&gt;::Metadata&gt;);</code> resp.</p>



<a name="275991371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991371">(Mar 20 2022 at 22:34)</a>:</h4>
<p>(At least, on 8086 non-flat)</p>



<a name="275991382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991382">(Mar 20 2022 at 22:35)</a>:</h4>
<p>I suspect we would want to say <code>*const T</code> and <code>*mut T</code> are either <code>Far&lt;P&gt;</code> or <code>Near&lt;P&gt;</code> by default.</p>



<a name="275991394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991394">(Mar 20 2022 at 22:35)</a>:</h4>
<p>Yeah.</p>



<a name="275991451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991451">(Mar 20 2022 at 22:36)</a>:</h4>
<p>On lccc (in xir), the wrappers would be translated to be transparent over <code>*near [const] T</code>/<code>*far [const] T</code>.</p>



<a name="275991455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991455">(Mar 20 2022 at 22:37)</a>:</h4>
<p>(Hense the <code>#[repr(transparent)]</code> that isn't even valid)</p>



<a name="275991530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991530">(Mar 20 2022 at 22:39)</a>:</h4>
<p>...memcpy is a good question.</p>



<a name="275991538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991538">(Mar 20 2022 at 22:39)</a>:</h4>
<p>do you just<br>
have four different memcpys?</p>



<a name="275991589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991589">(Mar 20 2022 at 22:40)</a>:</h4>
<p>memcpy would be defined as <code>void* memcpy(void* dest,const void* src,size_t  s);</code>, whatever <code>void*</code> and <code>const void*</code> happen to be</p>



<a name="275991600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991600">(Mar 20 2022 at 22:41)</a>:</h4>
<p>so the answer is that you do indeed have 4 different versions of memcpy.</p>



<a name="275991612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991612">(Mar 20 2022 at 22:41)</a>:</h4>
<p>Well, two, but only one at a time. There probably could be a <code>__memcpy_far</code> for near-ptr mode that takes two <code>void* _far</code>s, but meh.</p>



<a name="275991653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991653">(Mar 20 2022 at 22:42)</a>:</h4>
<p>nod.</p>



<a name="275991813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275991813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275991813">(Mar 20 2022 at 22:46)</a>:</h4>
<p>(Note that most of this impl work isn't done yet - the state of lccc's x86 codegen is x86_64-linux, and I think it does need some tearing up for 8086 support, but I need to tear it up anyways lest I keep reading locals into parameters by <code>mov ecx, eax; mov edi, ecx</code>)</p>



<a name="275994319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275994319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275994319">(Mar 20 2022 at 23:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t/near/275986320">said</a>:</p>
<blockquote>
<p>...what's <code>size_t</code> on FreeDOS, pray tell</p>
</blockquote>
<p>FreeDOS requires all C code to compile under OpenWatcom, <code>size_t</code> is <code>unsigned int</code> there, <code>unsigned int</code> is <code>u16</code> for 16-bit targets (most FreeDOS programs) and <code>u32</code> for 32-bit targets (some &gt;i386 FreeDOS programs).</p>



<a name="275994395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275994395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275994395">(Mar 20 2022 at 23:59)</a>:</h4>
<p>OpenWatcom supports huge pointers, which allow you to have objects larger than 64kiB, which is larger than <code>size_t</code> supports</p>



<a name="275994549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275994549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275994549">(Mar 21 2022 at 00:01)</a>:</h4>
<p>do we need <em>multiple</em> <code>size_t</code>s?!</p>



<a name="275998587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t%20%21%3D%20uintptr_t%20%21%3D%20ptraddr_t/near/275998587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/size_t.20!.3D.20uintptr_t.20!.3D.20ptraddr_t.html#275998587">(Mar 21 2022 at 01:44)</a>:</h4>
<p>It looks like, in huge pointer mode, it uses i32s as its <code>ptrdiff_t</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>