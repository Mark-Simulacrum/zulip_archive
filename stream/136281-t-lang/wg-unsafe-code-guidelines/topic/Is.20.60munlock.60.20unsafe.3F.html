<html>
<head><meta charset="utf-8"><title>Is `munlock` unsafe? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html">Is `munlock` unsafe?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251908422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251908422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251908422">(Sep 03 2021 at 16:37)</a>:</h4>
<p>Is <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/munlock.html"><code>munlock</code></a> unsafe?</p>
<ul>
<li>On one hand, it operates on a raw pointer</li>
<li>But on the other, it never mutates memory or segfaults or does anything else observable within the program, so arguably there's no UB</li>
<li>But on the first, it bypasses ownership and potentially compromises security invariants.</li>
</ul>
<p>I think the answer is yes, it's <code>unsafe</code>, even though there's no UB, but I'm curious what others think.</p>



<a name="251919624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251919624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251919624">(Sep 03 2021 at 17:59)</a>:</h4>
<p>I've written a decent ammount of FFI code where the SAFETY comment on the unsafe block is <code>//SAFETY: &lt;relevent standard&gt; prescribes no undefined behaviour for &lt;function&gt;</code>. You could thus write a trivial safe wrapper for such a function (which would just accept the arguments verbaitum, and forward them directly to the FFI function). <br>
I would <em>assume</em> that (from looking at the POSIX spec for it), <code>munlock</code>would qualify as one of these functions, so you could call it "safe" insofar as a safe wrapper for it would be trivial. The question is whether other (unsafe) code may rely on having locked memory, and whether unlocking memory could cause that code to have undefined behaviour.</p>



<a name="251929922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251929922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251929922">(Sep 03 2021 at 19:22)</a>:</h4>
<p>Yes, locking/unlocking memory isn't observable from within the process. It never causes UB.</p>



<a name="251929988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251929988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251929988">(Sep 03 2021 at 19:23)</a>:</h4>
<p>So it's "safe" in the sense of "no possible UB". But making a safe wrapper like that would mean that one crate with a dangling pointer could accidentally <code>munlock</code> another crate's memory, violating their external security stance.</p>



<a name="251943794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251943794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251943794">(Sep 03 2021 at 21:22)</a>:</h4>
<blockquote>
<p>violating their external security stance</p>
</blockquote>
<p>I think safety in Rust is only related to UB and is not intended to prevent that.</p>



<a name="251946276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251946276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251946276">(Sep 03 2021 at 21:47)</a>:</h4>
<p>Consider a function like <code>pub fn peek(addr: *const u8) -&gt; Result&lt;u8, ()&gt;</code> that can read any byte in memory, using a system call that it always has defined behavior (no segfaults, and no UB on races). Should it be safe to peek at arbitrary addresses?</p>



<a name="251946867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251946867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251946867">(Sep 03 2021 at 21:53)</a>:</h4>
<p>That would have rust-level undefined behaviour, from races (as any non-atomicwrites from rust code will assume nothing currently reads them without a <em>happens-before</em> relationship) , or from violating <code>&amp;mut</code> aliasing (or both).</p>



<a name="251947484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251947484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251947484">(Sep 03 2021 at 21:59)</a>:</h4>
<p>On the security point, it is noted <em>somewhere</em> (I can't remember where off the top of my head) that <code>unsafe</code> is not intended as a security boundary, though the fact that non-local code can violate other, non-local code's security invariants, may be cause for concern (in which case, <code>unsafe</code> may be useful as a <em>lint</em> against this).</p>



<a name="251947817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251947817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251947817">(Sep 03 2021 at 22:01)</a>:</h4>
<p>Another potential argument for an <code>munlock</code> wrapper being unsafe could be that any operation, other than conversion to <code>usize</code>; equality comparision, which would be unspecified; and wrapping arithmetic, on a deallocated pointer is undefined behaviour (even if the underlying operation would not have undefined behaviour - for example, it's valid to read a value of an inhabited 1-ZST from any pointer, except a null pointer or a deallocated pointer).</p>



<a name="251948158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251948158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251948158">(Sep 03 2021 at 22:05)</a>:</h4>
<p>I completely agree that <code>unsafe</code> is not a security boundary. My observation is that, in both examples above, there's a hazard related to memory pointed to by raw pointers, and Rust already has this great system for protecting memory pointed to by raw pointers.</p>



<a name="251949307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251949307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251949307">(Sep 03 2021 at 22:19)</a>:</h4>
<p>So I'm not thinking attackers reading secrets from elsewhere in the process; my main concern here is just accidental misuse of dangling pointers&mdash;one of the very things that Rust is already designed to help with.</p>



<a name="251950045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251950045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251950045">(Sep 03 2021 at 22:28)</a>:</h4>
<p>if I were writing a safe API, I don't think I'd expose <code>munlock</code> at all. More like <code>fn lock(...) -&gt; Guard</code> which unlocks itself on <code>Drop</code>.</p>



<a name="251950630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251950630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251950630">(Sep 03 2021 at 22:34)</a>:</h4>
<p>I agree, that's a nicer API than bare <code>munlock</code>. That also suggests that requiring <code>munlock</code>-like functions to be unsafe shouldn't be a significant burden, because the higher-level API is what most people will want anyway.</p>



<a name="251952618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251952618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251952618">(Sep 03 2021 at 23:00)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> Ooh, your observation about <code>peek</code> being unsafe gives me an idea. On a practical level, OS's can always read arbitrary program bytes without "UB" if they want to, because OS's are outside the reach of userspace compilers, and OS's can Do Magic. But if we say that any userspace function that specifically requests that the OS read certain bytes, or even make certain bytes readable in ways they weren't readable before, we'll treat that like a userspace read, and that function needs to be <code>unsafe</code>, I think that solves my problem.</p>



<a name="251952815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251952815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251952815">(Sep 03 2021 at 23:02)</a>:</h4>
<p>Yeah. Rust can't do anything about kernel space reading from it's own data (unless the possibility of a hardware race exists, in which case, unless the OS ensures synchronization on both sides, <em>any unrequested</em> read from userspace would be potentially invalid). But the OS is never guaranteed to see anything other than garbage, which, at the userspace level, would at the very least be <code>uninit</code>.</p>



<a name="251953102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251953102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251953102">(Sep 03 2021 at 23:06)</a>:</h4>
<p>Then we can say, <code>munlock</code> is effectively userspace requesting the OS make certain bytes swappable, which means they could be read--by the kernel swapper, and written to a physical medium, with physical consequences, in ways that they wouldn't have been before, so therefore <code>munlock</code> is unsafe too. :-)</p>



<a name="251987592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251987592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251987592">(Sep 04 2021 at 09:34)</a>:</h4>
<p>If the effect of <code>munlock</code> is not observable from userspace, I still think it should be safe. I think this is different from <code>peek</code> that the effect of <code>peek</code> is actually observable by its return value.</p>



<a name="251988457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251988457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251988457">(Sep 04 2021 at 09:50)</a>:</h4>
<blockquote>
<p>which means they could be read--by the kernel swapper, and written to a physical medium, with physical consequences</p>
</blockquote>
<p>This can also happen on memory that is never locked without involving <code>munlock</code> though.</p>



<a name="251988475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251988475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251988475">(Sep 04 2021 at 09:51)</a>:</h4>
<p>The only situation where <code>munlock</code> might cause issues is if you're doing some low-level DMA access, but in theory the kernel should take care of locking the pages for you in that case.</p>



<a name="251988531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251988531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251988531">(Sep 04 2021 at 09:52)</a>:</h4>
<p>I would argue that <code>peek</code> is also safe: it might return garbage data but it can never cause UB.</p>



<a name="251990630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251990630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251990630">(Sep 04 2021 at 10:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="374396">hyd-dev</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F/near/251988457">said</a>:</p>
<blockquote>
<blockquote>
<p>which means they could be read--by the kernel swapper, and written to a physical medium, with physical consequences</p>
</blockquote>
<p>This can also happen on memory that is never locked without involving <code>munlock</code> though.</p>
</blockquote>
<p>That said, I'm not sure if it's possible to observe the effect of <code>munlock</code> by reading the physical medium.</p>



<a name="251996736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is%20%60munlock%60%20unsafe%3F/near/251996736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Is.20.60munlock.60.20unsafe.3F.html#251996736">(Sep 04 2021 at 12:19)</a>:</h4>
<p><code>mlock</code> can be used to ensure that secret keys don't leak to swap I believe. In that case using <code>munlock</code> on the secret keys is a security issue.q</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>