<html>
<head><meta charset="utf-8"><title>vec max length · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html">vec max length</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276392353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec%20max%20length/near/276392353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html#276392353">(Mar 23 2022 at 20:07)</a>:</h4>
<p>According to docs</p>
<blockquote>
<p>"For instance, Vec and Box ensure they never allocate more than isize::MAX"</p>
</blockquote>
<p>Should the comparison at <a href="https://github.com/rust-lang/rust/blob/5bd1ec3283874b97b27da4539b2950fbd01c4b0e/library/alloc/src/raw_vec.rs#L390">https://github.com/rust-lang/rust/blob/5bd1ec3283874b97b27da4539b2950fbd01c4b0e/library/alloc/src/raw_vec.rs#L390</a> be against len as isize?</p>
<p>Or maybe <code>(additional as isize) &lt; 0 || (len as isize).checked_add(additional as isize).is_none()</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">try_reserve</span><span class="p">(</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">.</span><span class="n">unsigned_abs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{r:?}"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Err(TryReserveError { kind: AllocError { layout: Layout { size_: 9223372036854775808, align_: 1 }, non_exhaustive: () } })</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">try_reserve</span><span class="p">(</span><span class="kt">usize</span>::<span class="n">MAX</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{r:?}"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Err(TryReserveError { kind: AllocError { layout: Layout { size_: 18446744073709551615, align_: 1 }, non_exhaustive: () } })</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">try_reserve</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{r:?}"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Ok(())</span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">try_reserve</span><span class="p">(</span><span class="kt">usize</span>::<span class="n">MAX</span><span class="p">);</span><span class="w"> </span><span class="c1">// Err(TryReserveError { kind: CapacityOverflow })</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{r:?}"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276392541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec%20max%20length/near/276392541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html#276392541">(Mar 23 2022 at 20:08)</a>:</h4>
<p>That doesn't help for elements that aren't exactly 1 byte.</p>



<a name="276392639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec%20max%20length/near/276392639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html#276392639">(Mar 23 2022 at 20:09)</a>:</h4>
<p>it's been a <em>very</em> long time but on paper  grow_amortized gets to be less strict because of its ~doubling behaviour</p>



<a name="276392967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec%20max%20length/near/276392967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html#276392967">(Mar 23 2022 at 20:11)</a>:</h4>
<p>oh this isn't a soundness question, but a consistency-in-error-question?</p>



<a name="276393347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec%20max%20length/near/276393347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html#276393347">(Mar 23 2022 at 20:14)</a>:</h4>
<p>Right, <code>let array_size = mem::size_of::&lt;T&gt;().checked_mul(n).ok_or(LayoutError)?;</code> comes after that.</p>
<p>It's definitely inconsistent about returning  Err(CapacityOverflow).</p>



<a name="276395141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec%20max%20length/near/276395141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/vec.20max.20length.html#276395141">(Mar 23 2022 at 20:26)</a>:</h4>
<p>That checkes if it overflows <code>usize</code> though. The actual check for <code>isize::MAX</code> is:</p>
<ul>
<li>for 32 bit architectures there's a <code>if usize::BITS &lt; 64 &amp;&amp; alloc_size &gt; isize::MAX as usize {</code>in <code>alloc_guard</code></li>
<li>for 64 bit architectures the actual address space is less than 63 bits so an allocation of <code>isize::MAX</code> will always fail</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>