<html>
<head><meta charset="utf-8"><title>Problems with integer provenance · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html">Problems with integer provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278325026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278325026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278325026">(Apr 08 2022 at 16:00)</a>:</h4>
<p>Does integers having provenance solve the problem of int&lt;-&gt;ptr transmutes and ptr-&gt;int being a side effect?</p>
<p>It also seems to add complexity for integer optimization, but do we have a list of ones which will no longer work?</p>



<a name="278327326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278327326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278327326">(Apr 08 2022 at 16:17)</a>:</h4>
<p>It does solve the problem, but it means you can no longer treat integers as equal just because they have the same value, which is pretty catastrophic AIUI</p>



<a name="278327429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278327429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278327429">(Apr 08 2022 at 16:18)</a>:</h4>
<p>it's also ambiguous what is provenance of the result of various integer operations (like addition)</p>



<a name="278330959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278330959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278330959">(Apr 08 2022 at 16:44)</a>:</h4>
<p>The relevant search term here is “PVI” (provenance via integers)</p>



<a name="278330960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278330960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278330960">(Apr 08 2022 at 16:44)</a>:</h4>
<p>It's not immediately obvious to me how it is catastrophic, since you can still treat them as having the same <em>integer</em> value.</p>



<a name="278331040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331040">(Apr 08 2022 at 16:45)</a>:</h4>
<p>It prevents a lot of potential optimizations from working well</p>



<a name="278331179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331179">(Apr 08 2022 at 16:46)</a>:</h4>
<p><a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20PVI.20-.20What.20optimizations.20does.20it.20break.3F">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20PVI.20-.20What.20optimizations.20does.20it.20break.3F</a></p>



<a name="278331214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331214">(Apr 08 2022 at 16:46)</a>:</h4>
<p>Maybe it could work with a Sufficiently Smart Compiler (which is a bit of a well-known joke term because such a thing does not exist in practice)</p>



<a name="278331303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331303">(Apr 08 2022 at 16:47)</a>:</h4>
<p>I'm just asking for some specific examples to reason about.</p>



<a name="278331349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331349">(Apr 08 2022 at 16:47)</a>:</h4>
<p>the challenge that all this provenance stuff is trying to solve is that certain optimizations cannot be done even by a <em>perfect</em> compiler, because they would change observable behavior under the model</p>



<a name="278331367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331367">(Apr 08 2022 at 16:47)</a>:</h4>
<p>Is PVI some specific model or just a generic term? I tried to google it, unsuccessfully.</p>



<a name="278331458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331458">(Apr 08 2022 at 16:48)</a>:</h4>
<p>It's a class of models considered in the paper on C pointer provenance that is making the rounds</p>



<a name="278331811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278331811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278331811">(Apr 08 2022 at 16:50)</a>:</h4>
<p><a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2364.pdf">http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2364.pdf</a></p>



<a name="278334170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278334170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278334170">(Apr 08 2022 at 17:06)</a>:</h4>
<p>Is there a paper which discusses the tradeoffs between them? That may contain the example I'm looking for.</p>



<a name="278334406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278334406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278334406">(Apr 08 2022 at 17:08)</a>:</h4>
<p>in practice the way you'd probably want to do PVI to start with is just "do PNVI, but do an early pass turning 'obvious' ptrtoint+inttoptr pairs into something that marks it as not-an-escape"</p>



<a name="278334561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278334561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278334561">(Apr 08 2022 at 17:09)</a>:</h4>
<p>(though rust codegen might still run into "sufficiently non-obvious" because of inserting overflow checks)</p>



<a name="278334795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278334795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278334795">(Apr 08 2022 at 17:11)</a>:</h4>
<p>(and also somehow dodging issues with ptr/int punning, for which you'd have some more options)</p>



<a name="278338331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278338331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278338331">(Apr 08 2022 at 17:40)</a>:</h4>
<p>Specifically, PVI breaks the Global Value Numbering (GVN) pass, which sees when <code>x==y</code> and can replace <code>x</code> by <code>y</code> or reversely in downstream expressions. As I understand it, it’s important for unlocking other optimization opportunities. For instance then <code>x - y</code> simplifies to <code>x - x</code>, which simplifies to <code>0</code>, which can cut a branch from an if..then..else, etc.</p>
<p>I don’t think there’s a theoretical reason that those optimizations couldn’t be done in PVI.  Like we could replace <code>y</code> by <code>x</code> in contexts where only the number part matters. But GVN with !PVI is just a very convenient way to express those optimizations and it removes a huge complication from the compiler.</p>



<a name="278338384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278338384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278338384">(Apr 08 2022 at 17:41)</a>:</h4>
<p>(PNVI being the term for !PVI)</p>



<a name="278341026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278341026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278341026">(Apr 08 2022 at 18:03)</a>:</h4>
<p>Are you suggesting it would make GVN less general or that it would make GVN more complex? Certainly the latter is true, and would be expected for an integer optimization.</p>



<a name="278342840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278342840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278342840">(Apr 08 2022 at 18:18)</a>:</h4>
<p>the issue is that it can affect optimization of integer operations even when pointers aren't even mentioned in the function, it just globally makes all sorts of algebraic identities not hold anymore</p>



<a name="278343753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278343753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278343753">(Apr 08 2022 at 18:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278341026">said</a>:</p>
<blockquote>
<p>Are you suggesting it would make GVN less general or that it would make GVN more complex? Certainly the latter is true, and would be expected for an integer optimization.</p>
</blockquote>
<p>Pick at least one of {worse, more complex} :)</p>



<a name="278344072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278344072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278344072">(Apr 08 2022 at 18:28)</a>:</h4>
<p>A programming language doesn't need provenance at all. Take for instance x64 assembly — it doesn't care* about silly concepts like provenance. Same with "C without optimizations". But typically people want a high level language that <em>also</em> compiles to run reasonably fast</p>
<p><code>*</code> ignoring cache coherency and instruction vs. data cache for a minute</p>



<a name="278344275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278344275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278344275">(Apr 08 2022 at 18:30)</a>:</h4>
<p>Python doesn't really have provenance either.</p>



<a name="278347829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278347829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278347829">(Apr 08 2022 at 18:59)</a>:</h4>
<p>well, if you don't have actual numeric pointers provenance is irrelevant (and if you use python-ffi pointers, you aren't expecting fully C-like performance and optimization)</p>



<a name="278356532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278356532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278356532">(Apr 08 2022 at 20:13)</a>:</h4>
<p>besides what was said above, and as discussed earlier this week in <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20PVI.20-.20What.20optimizations.20does.20it.20break.3F">the previous copy of this same discussion</a>, PVI also makes memory models a lot more complicated because defining operations like <code>+</code> when both operands have provenance is tricky (one needs to be able to form a kind of "union provenance"). in contrast, there is no operation that takes 2 pointers as input and creates a pointer, so provenance is always unambiguously propagated in pointer operations.</p>



<a name="278357737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278357737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278357737">(Apr 08 2022 at 20:24)</a>:</h4>
<p>Is there a problem with just requiring that integer have a singular provenance like pointers? That seems like a simpler PVI model and seems to be what the C model does if I glanced it correctly (the output of + has no provenance if both inputs have provenance). Would that rule out common pointer as integer manipulations?</p>



<a name="278358016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278358016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278358016">(Apr 08 2022 at 20:27)</a>:</h4>
<p>"the C model"? "the C model" arguably is PNVI-ae-udi, where integers have <em>no</em> provenance</p>



<a name="278358050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278358050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278358050">(Apr 08 2022 at 20:27)</a>:</h4>
<p>the problem is deciding whether <code>+</code> gets its provenance from the left or the right operand. no matter which one you pick, <code>+</code> becomes non-commutative.</p>



<a name="278358631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278358631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278358631">(Apr 08 2022 at 20:32)</a>:</h4>
<p>I meant PVI as defined here by "the C model", <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2364.pdf">http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2364.pdf</a></p>



<a name="278359217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278359217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278359217">(Apr 08 2022 at 20:38)</a>:</h4>
<blockquote>
<p>the output of + has no provenance if both inputs have provenance</p>
</blockquote>
<p>so this means <code>x</code> and <code>x+0</code> are no longer equivalent</p>



<a name="278359251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278359251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278359251">(Apr 08 2022 at 20:38)</a>:</h4>
<p>ah no I guess <code>0</code> has no provenance so that still works</p>



<a name="278359287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278359287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278359287">(Apr 08 2022 at 20:39)</a>:</h4>
<p>but <code>x+(y-x)</code> is not equivalent to <code>x</code> under this model</p>



<a name="278359454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278359454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278359454">(Apr 08 2022 at 20:40)</a>:</h4>
<p>also <code>x+x+...+x</code> has provenance iff there are an odd number of <code>x</code>'s, which is... odd</p>



<a name="278360293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278360293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278360293">(Apr 08 2022 at 20:48)</a>:</h4>
<p>The odd example might be fixable by preserving provenance if both inputs have the same provenance.</p>



<a name="278360414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278360414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278360414">(Apr 08 2022 at 20:49)</a>:</h4>
<p>you can't do that because you probably want <code>y[(int)&amp;x[1] - (int)&amp;x[0]]</code> to work more than that case</p>



<a name="278360540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278360540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278360540">(Apr 08 2022 at 20:50)</a>:</h4>
<p>I think it is kind of inevitable given that provenance has no reasonable algebraic structure that anything you do will be ad hoc and unpredictable</p>



<a name="278360767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278360767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278360767">(Apr 08 2022 at 20:53)</a>:</h4>
<p>quick fixes and patches to the model don't cut it. If it's not "obviously the only answer" it will be difficult for programmers to work with and it will end up contributing to rust's reputation for being tricky to get unsafe code right</p>



<a name="278361456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278361456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278361456">(Apr 08 2022 at 20:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278360414">said</a>:</p>
<blockquote>
<p>you can't do that because you probably want <code>y[(int)&amp;x[1] - (int)&amp;x[0]]</code> to work more than that case</p>
</blockquote>
<p>Probably needs more integer casts to actually break, but that rule doesn't seem like a good idea for subtraction. No idea if it's useful for addition either. Adding pointers together doesn't seem like a common operation.</p>



<a name="278363268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278363268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278363268">(Apr 08 2022 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278359287">said</a>:</p>
<blockquote>
<p>but <code>x+(y-x)</code> is not equivalent to <code>x</code> under this model</p>
</blockquote>
<p>I would expect <code>x+(y-x)</code> to optimize to <code>prov(x, prov_of(x+(y-x)))</code>. A "shadow" of the original program is carried to peek at if the integer is used as a pointer. Probably doesn't make for efficient or terribly fun to write integer optimizations though.</p>



<a name="278364015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278364015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278364015">(Apr 08 2022 at 21:22)</a>:</h4>
<p>So at the IR level, we'd split up integer and provenance parts of values to allow for integer optimizations.</p>



<a name="278364244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278364244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278364244">(Apr 08 2022 at 21:24)</a>:</h4>
<p>yeah I doubt that is going to make anyone happy...</p>



<a name="278410377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278410377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278410377">(Apr 09 2022 at 13:31)</a>:</h4>
<p>Consider a stricter model then, where we define integer operations to be UB if they have provenance. We also add exposing for explicit casts. That makes integer optimizations much more practical. Storing pointers as integers by transmutes is still allowed, as long as you don't mess with them while they're integers.</p>



<a name="278413369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278413369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278413369">(Apr 09 2022 at 14:44)</a>:</h4>
<p>If you're saying "otherwise safe operations on <em>some</em> values of a type become not-obviously unsound" that also seems Not Good.</p>



<a name="278413795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278413795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278413795">(Apr 09 2022 at 14:52)</a>:</h4>
<p>You'd need to be able to transmute a pointer to integer in safe code for it to be bad though.</p>



<a name="278414455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278414455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278414455">(Apr 09 2022 at 15:09)</a>:</h4>
<p>that would make a lot of real world code UB, including some things that are defined by strict provenance with the current set of epicycles: if you transmute a pointer to an integer and then add 3 then you will get an integer value, but your proposal would make it UB</p>



<a name="278414564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278414564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278414564">(Apr 09 2022 at 15:11)</a>:</h4>
<p>With strict provenance the transmute would be immediately UB. You need to use <code>addr()</code> there.</p>



<a name="278414616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278414616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278414616">(Apr 09 2022 at 15:12)</a>:</h4>
<p>My aim here is to delay the UB until you actually use it as an integer.</p>



<a name="278414777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278414777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278414777">(Apr 09 2022 at 15:16)</a>:</h4>
<p>I believe the transmute acts like <code>addr()</code>, there is no cost in doing so so I don't see a need for it to be UB</p>



<a name="278414790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278414790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278414790">(Apr 09 2022 at 15:16)</a>:</h4>
<p>the problematic one is to make it act like <code>expose_addr()</code></p>



<a name="278414824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278414824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278414824">(Apr 09 2022 at 15:17)</a>:</h4>
<p>(well, it's not strictly the same as <code>addr()</code> if usize != uintptr_t)</p>



<a name="278415070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278415070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278415070">(Apr 09 2022 at 15:23)</a>:</h4>
<p>I assumed based on <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286">https://github.com/rust-lang/unsafe-code-guidelines/issues/286</a> that we'd need the transmutes to be UB to allow the optimizations we'd want.</p>



<a name="278416224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278416224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278416224">(Apr 09 2022 at 15:51)</a>:</h4>
<p>We can't add UB to this code because it is all safe, which as far as I can tell is what you're suggesting</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">some_ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</code></pre></div>



<a name="278416290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278416290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278416290">(Apr 09 2022 at 15:52)</a>:</h4>
<p>Arithmetic on integers created from pointers is extremely widespread currently to do alignment checks</p>



<a name="278416425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278416425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278416425">(Apr 09 2022 at 15:54)</a>:</h4>
<p>The cast would strip provenance so that's fine. Only transmutes and type punning preserves that.</p>



<a name="278417020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278417020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278417020">(Apr 09 2022 at 16:06)</a>:</h4>
<p>So this function executes UB depending on how I got the integer:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I can't point to any particular rule that this is breaking, but this just seems like really bad API design. It reminds me of the crates which are never used without UB but the authors dance around "but it's technically sound" because they made everything <code>unsafe fn</code>.</p>



<a name="278417047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278417047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278417047">(Apr 09 2022 at 16:07)</a>:</h4>
<p>I suppose that is to say, that I don't think an <code>unsafe fn</code>'s requirements should extend to what safe code does with what it returns</p>



<a name="278418768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278418768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278418768">(Apr 09 2022 at 16:44)</a>:</h4>
<p>We kind of have things like already that on the LLVM IR level with poison values.</p>



<a name="278418806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278418806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278418806">(Apr 09 2022 at 16:45)</a>:</h4>
<p>But also you cannot claim that your API is safe if it returns integer values with provenance, because they must support any possible use from safe code without UB.</p>



<a name="278419260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278419260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278419260">(Apr 09 2022 at 16:54)</a>:</h4>
<p>UB in an IR is quite different</p>



<a name="278419471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278419471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278419471">(Apr 09 2022 at 16:59)</a>:</h4>
<p>One issue with UB in integer operations is that it becomes illegal to <em>introduce</em> integer operations on integer values, i.e. transforming <code>x</code> to <code>x + 0</code> if <code>x: usize</code> is a parameter</p>



<a name="278419488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278419488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278419488">(Apr 09 2022 at 16:59)</a>:</h4>
<p>or more realistically, lifting an addition or other integer operation from inside a loop</p>



<a name="278419494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278419494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278419494">(Apr 09 2022 at 16:59)</a>:</h4>
<p>which I think is a pretty important optimization</p>



<a name="278419628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278419628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278419628">(Apr 09 2022 at 17:01)</a>:</h4>
<p>in fact I think the whole reason <code>poison</code> exists is to allow exactly this kind of loop invariant code motion for operations that would otherwise need to cause UB</p>



<a name="278420151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278420151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278420151">(Apr 09 2022 at 17:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278419488">said</a>:</p>
<blockquote>
<p>or more realistically, lifting an addition or other integer operation from inside a loop</p>
</blockquote>
<p>Isn't that fixed by defining integer operations to be <code>poison</code> on the LLVM IR level if provenance is involved?</p>



<a name="278421006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278421006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278421006">(Apr 09 2022 at 17:29)</a>:</h4>
<p>It's certainly fine to have sound operations be unsound if you pass them "impossible" data as long as the impossible data can only be made unsafely. That's how library UB works with <code>&amp;str</code> after all, so I don't want us to think that we must reject the idea entirely.</p>
<p>However, with <em>math on integers</em> being the operations in question... that just seems like it's just going too far.</p>



<a name="278421180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278421180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278421180">(Apr 09 2022 at 17:33)</a>:</h4>
<p>Can you explain the library UB with <code>&amp;str</code> more? As far as I can tell, the only issue with <code>&amp;str</code> is doing a <code>from_utf8_unchecked</code> with something that is not actually UTF-8, but that's defined as a <em>precondition</em> of the function, which is very different to my mind. The UB is documented to occur at the call to <code>from_utf8_unchecked</code>, regardless of what you do afterwards.</p>



<a name="278421409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278421409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278421409">(Apr 09 2022 at 17:37)</a>:</h4>
<p>A <code>&amp;str</code> value should always be utf8, but it <em>can</em> contain non-utf8 bytes, and it's "just" library UB to actually call any function that accepts a <code>&amp;str</code> value while it contains malformed data.</p>
<p>Example: the intermediate steps of zeroing out a string that contains a 4 byte emoji to be four \0 values aren't themselves UB, even though it has to travel through an illegal state to get between two legal states.</p>



<a name="278422289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278422289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278422289">(Apr 09 2022 at 17:57)</a>:</h4>
<blockquote>
<p>This function is unsafe because it does not check that the bytes passed to it are valid UTF-8. If this constraint is violated, undefined behavior results, as the rest of Rust assumes that &amp;strs are valid UTF-8.</p>
</blockquote>
<p>Wow that is wobbly and I do not like it one bit.</p>



<a name="278422372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278422372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278422372">(Apr 09 2022 at 17:59)</a>:</h4>
<p>are you okay with <code>NonZeroU32</code> ?</p>



<a name="278422389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278422389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278422389">(Apr 09 2022 at 17:59)</a>:</h4>
<p>Of course. It documents</p>
<blockquote>
<p>Creates a non-zero without checking whether the value is non-zero. This results in undefined behaviour if the value is zero.</p>
</blockquote>



<a name="278422441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278422441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278422441">(Apr 09 2022 at 18:00)</a>:</h4>
<p>I'm starting another thread for this</p>



<a name="278422834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278422834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278422834">(Apr 09 2022 at 18:07)</a>:</h4>
<p>One neat thing is that this model would allow compressed pointers without using exposing allocations or having to add special small pointer types. Adding such special types to other models wouldn't be terribly hard though.</p>



<a name="278473481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278473481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278473481">(Apr 10 2022 at 15:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278414777">said</a>:</p>
<blockquote>
<p>I believe the transmute acts like <code>addr()</code>, there is no cost in doing so so I don't see a need for it to be UB</p>
</blockquote>
<p>I dont think it should act like <code>addr</code>. there is a cost at least in terms of making it much harder to justify removing <code>x=x;</code> assignments. (the load of <code>x</code> might be a transmute, so this might store back a different list of Abstract Bytes than it loaded. this is probably still okay but it's subtle.) it also doesn't make any real-world code I know of work, so I think there is no good reason to have this complexity in the model.</p>
<p>this is the exact same discussion at <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085186517">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1085186517</a> .</p>



<a name="278473558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278473558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278473558">(Apr 10 2022 at 15:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278410377">said</a>:</p>
<blockquote>
<p>Consider a stricter model then, where we define integer operations to be UB if they have provenance. We also add exposing for explicit casts. That makes integer optimizations much more practical. Storing pointers as integers by transmutes is still allowed, as long as you don't mess with them while they're integers.</p>
</blockquote>
<p>I hope this includes <code>==</code> in "integer operations", otherwise it's not enough.</p>
<p>this <em>might</em> work. it still means you cannot optimize <code>x</code> to <code>x+0</code> (not sure if anyone would do that, but it's a footgun).<br>
at this point you have "values at integer type that you can literally only forward, not do anything with them". we have a type for that in Rust: <code>MaybeUninit&lt;$int&gt;</code>. I think instead of going through hoops to let you do this with int types, we should just get everyone to use <code>MaybeUninit</code> and then the problem is equally solved.</p>



<a name="278473560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278473560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278473560">(Apr 10 2022 at 15:20)</a>:</h4>
<p>I do wonder if this would make integer types equivalent to C's <code>char</code>. I have no idea what C specifies for <code>char</code>s with provenance though.</p>



<a name="278473579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278473579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278473579">(Apr 10 2022 at 15:21)</a>:</h4>
<p>Yeah, I had <code>==</code> in mind too.</p>



<a name="278473618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278473618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278473618">(Apr 10 2022 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278473560">said</a>:</p>
<blockquote>
<p>I do wonder if this would make integer types equivalent to C's <code>char</code>. I have no idea what C specifies for <code>char</code>s with provenance though.</p>
</blockquote>
<p>well, given a lack of a precise spec for C this is hard to say. ;) but yes, C's <code>char</code> also attempts to play the role of <code>MaybeUninit&lt;u8&gt;</code>. in Rust we dont need to let our int (or char) types do double-duty like that.</p>



<a name="278473847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278473847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278473847">(Apr 10 2022 at 15:26)</a>:</h4>
<p>Not sure how <code>MaybeUninit</code> relates, except for compressed pointers note. I guess compressed pointers can use that assuming it allows provenance. It's not an important justification. The aim here is to allow ptr&lt;-&gt;int transmutes if there's on integer operations on the pointers.</p>



<a name="278474012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474012">(Apr 10 2022 at 15:30)</a>:</h4>
<p>I think this may be better suited as a IR semantic to support legacy code than Rust. I do support making integer loads UB if they contain provenance. It gives a bit more room for compiler IRs as there are other reasonable weaker options.</p>



<a name="278474057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474057">(Apr 10 2022 at 15:31)</a>:</h4>
<p>So a question would be if this is a good idea for LLVM instead of introducing a new <code>byte</code> type?</p>



<a name="278474104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474104">(Apr 10 2022 at 15:32)</a>:</h4>
<p><code>MaybeUninit</code> is very related, also see the discussion starting at <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1086218649">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1086218649</a></p>



<a name="278474125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474125">(Apr 10 2022 at 15:33)</a>:</h4>
<p>if you want to just have "opaque values you cant touch or compare", you absolutely should use <code>MaybeUninit</code> in Rust as then you also support padding. uninit bytes in an integer will most likely be UB, we want to make use of those nice <code>noundef</code> attributes LLVM now has.</p>



<a name="278474188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474188">(Apr 10 2022 at 15:34)</a>:</h4>
<p>so for Rust I see no reason (other than maybe backwards compatibility) to allow such "opaque provenance in integer"</p>



<a name="278474190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474190">(Apr 10 2022 at 15:34)</a>:</h4>
<p>I think to properly support _real_ "any data could be here" you'd need to use <code>UnsafeCell&lt;MaybeUninit&lt;u8&gt;&gt;</code>? assuming that <code>&amp;T</code> -&gt; <code>&amp;UnsafeCell&lt;T&gt;</code> becomes allowed at some point</p>



<a name="278474226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474226">(Apr 10 2022 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278474057">said</a>:</p>
<blockquote>
<p>So a question would be if this is a good idea for LLVM instead of introducing a new <code>byte</code> type?</p>
</blockquote>
<p>yeah that's what I was wondering. however LLVM still needs a byte type to support holding arbitrary data including undef/poison.</p>



<a name="278474287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474287">(Apr 10 2022 at 15:36)</a>:</h4>
<p>e.g., if you implement memcpy by copying a bunch of <code>i64</code> in a loop, then if any one byte is poison, the entire <code>i64</code> chunk will become poison, which is not what you want</p>



<a name="278474316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474316">(Apr 10 2022 at 15:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278474190">said</a>:</p>
<blockquote>
<p>I think to properly support _real_ "any data could be here" you'd need to use <code>UnsafeCell&lt;MaybeUninit&lt;u8&gt;&gt;</code>? assuming that <code>&amp;T</code> -&gt; <code>&amp;UnsafeCell&lt;T&gt;</code> becomes allowed at some point</p>
</blockquote>
<p><code>UnsafeCell</code> has nothing to do with the data that could be there, but with how you (and others) access it</p>



<a name="278474319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474319">(Apr 10 2022 at 15:37)</a>:</h4>
<p>so this is orthogonal</p>



<a name="278474324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474324">(Apr 10 2022 at 15:37)</a>:</h4>
<p>IOW, sometimes you might need the extra <code>UnsafeCell</code>, sometimes not</p>



<a name="278474413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474413">(Apr 10 2022 at 15:39)</a>:</h4>
<p>Yea but if im trying to support "any data could be here" i must conservatively assume there is an unsafe cell in the data I think</p>



<a name="278474422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474422">(Apr 10 2022 at 15:39)</a>:</h4>
<p>like how i must assume there might be padding or uninit memory in there so I use <code>MaybeUninit&lt;u8&gt;</code> over <code>u8</code></p>



<a name="278474750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474750">(Apr 10 2022 at 15:47)</a>:</h4>
<p>unsafe cell isnt a property of the data</p>



<a name="278474759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474759">(Apr 10 2022 at 15:47)</a>:</h4>
<p>so, "there is unsafe cell in the data" is a category error. this statement doesnt typecheck.</p>



<a name="278474837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474837">(Apr 10 2022 at 15:49)</a>:</h4>
<p>if you are given arbitrary data and you dont want to do shared mutable things to it, you dont need to worry about <code>UnsafeCell</code></p>



<a name="278474925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474925">(Apr 10 2022 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278474287">said</a>:</p>
<blockquote>
<p>e.g., if you implement memcpy by copying a bunch of <code>i64</code> in a loop, then if any one byte is poison, the entire <code>i64</code> chunk will become poison, which is not what you want</p>
</blockquote>
<p>I may need to read up on the LangRef again. The argument here is that moving poison around (including memory) may not widen it?</p>



<a name="278474950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474950">(Apr 10 2022 at 15:51)</a>:</h4>
<p>the issue is that memcpy should not widen poison, but <code>load</code> at type <code>i64</code> does</p>



<a name="278474995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278474995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278474995">(Apr 10 2022 at 15:52)</a>:</h4>
<p>I dont _know_ if shared mutable things will be done to the data if its arbitrary data- if someone has given me an <code>&amp;T</code> and I turn that into <code>&amp;MaybeUninit&lt;u8&gt;</code> despite the fact that that <code>T</code> was <code>UnsafeCell&lt;u8&gt;</code> then i've likely broken someones lovely interior mutablility sound abstraction</p>



<a name="278475032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475032">(Apr 10 2022 at 15:53)</a>:</h4>
<p><code>&amp;Mutex&lt;u8&gt;</code> is probably a good example of a thing that would break if you then made an <code>&amp;[MaybeUninit&lt;u8&gt;]</code> out of it</p>



<a name="278475036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475036">(Apr 10 2022 at 15:53)</a>:</h4>
<p>Could <code>memcpy</code> be implemented by say something like a vector load to work around that?</p>



<a name="278475072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475072">(Apr 10 2022 at 15:54)</a>:</h4>
<blockquote>
<p>I dont _know_ if shared mutable things will be done to the data if its arbitrary data-</p>
</blockquote>
<p>?!? that is just entirely orthogonal</p>



<a name="278475085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475085">(Apr 10 2022 at 15:54)</a>:</h4>
<p>when you implement <code>memcpy</code>, you have arbitrary data but you know for sure there's no shared mutable things done to it</p>



<a name="278475087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475087">(Apr 10 2022 at 15:54)</a>:</h4>
<p>this is a common situation</p>



<a name="278475112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475112">(Apr 10 2022 at 15:55)</a>:</h4>
<p>"arbitrary data" means someone gives you a <code>T</code> and you want to turn it into <code>[MaybeUninit&lt;u8&gt;; N]</code></p>



<a name="278475130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475130">(Apr 10 2022 at 15:55)</a>:</h4>
<p>..i am shocked that is even allowed</p>



<a name="278475137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475137">(Apr 10 2022 at 15:55)</a>:</h4>
<p>does that not destroy pointers on cheri?</p>



<a name="278475180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475180">(Apr 10 2022 at 15:56)</a>:</h4>
<p>of course if someone gives you a <code>&amp;T</code> you have to also account for whatever sharing might be going on, but at this point we're talking about the aliasing model, not ptr-int-transmutes. it's a totally independent discussion.</p>



<a name="278475202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475202">(Apr 10 2022 at 15:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278475137">said</a>:</p>
<blockquote>
<p>does that not destroy pointers on cheri?</p>
</blockquote>
<p>well memcpy works for them so they figured out something I guess ;)</p>



<a name="278475602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475602">(Apr 10 2022 at 16:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278475130">said</a>:</p>
<blockquote>
<p>..i am shocked that is even allowed</p>
</blockquote>
<p><span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> me, too. ;) but that's literally what all these discussions about transmutation the last days were all about</p>



<a name="278475613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475613">(Apr 10 2022 at 16:05)</a>:</h4>
<p>we need <em>some</em> way to store arbitrary data in a buffer of fixed type, and then recover the original data unchanged later</p>



<a name="278475672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278475672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278475672">(Apr 10 2022 at 16:06)</a>:</h4>
<p>and some people want to use integer types for that buffer. what I keep saying is that we should use <code>MaybeUninit</code>, not integer types. let's be explicit and tell the compiler what's going on, then we'll all be happier.</p>



<a name="278484374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278484374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278484374">(Apr 10 2022 at 19:06)</a>:</h4>
<p>Would allowing casting a pointer from <code>malloc</code> to <code>&amp;mut MaybeUninit&lt;T&gt;</code> require that <code>MaybeUninit</code> is able to hold provenance?</p>



<a name="278484782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278484782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278484782">(Apr 10 2022 at 19:14)</a>:</h4>
<p><code>MaybeUninit</code> is able to hold anything that can be stored in AM memory, including in particular bytes with pointer provenancce</p>



<a name="278489234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489234">(Apr 10 2022 at 20:56)</a>:</h4>
<p>It probably make sense to make it so. I was just wondering if it possible to not have it have provenance. <span class="user-mention" data-user-id="120791">@RalfJ</span> didn't sound very confident that it did in <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286">https://github.com/rust-lang/unsafe-code-guidelines/issues/286</a>.</p>



<a name="278489323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489323">(Apr 10 2022 at 20:57)</a>:</h4>
<p>MaybeUninit definitely can carry provenance</p>



<a name="278489328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489328">(Apr 10 2022 at 20:57)</a>:</h4>
<p>it would make no sense to let it be uninit but disallow provenance...</p>



<a name="278489373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489373">(Apr 10 2022 at 20:58)</a>:</h4>
<p>not sure which of my statements in that thread you are going off of</p>



<a name="278489513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489513">(Apr 10 2022 at 21:00)</a>:</h4>
<p><code>I think we already have that type: MaybeUninit.</code><br>
<a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-869177433">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-869177433</a></p>
<p>That may be a statement about something more general though.</p>



<a name="278489638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489638">(Apr 10 2022 at 21:02)</a>:</h4>
<p>that sentence says that we have a type that can carry provenance</p>



<a name="278489660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278489660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278489660">(Apr 10 2022 at 21:03)</a>:</h4>
<p>not sure what "didn't sound very confident that it did" refers to, but to hopefully remove ambiguity -- I am pretty confident that MaybeUninit can carry provenance :)</p>



<a name="278492084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492084">(Apr 10 2022 at 22:01)</a>:</h4>
<p>I consider <code>I think</code> to be a bit weaker than <code>I am pretty confident</code> :)</p>



<a name="278492127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492127">(Apr 10 2022 at 22:02)</a>:</h4>
<p>yeah fair. I am using different amounts of hedging over time. ;)</p>



<a name="278492129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492129">(Apr 10 2022 at 22:02)</a>:</h4>
<p>nothing in this space is absolutely certain until the lang team blesses it</p>



<a name="278492141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492141">(Apr 10 2022 at 22:03)</a>:</h4>
<p>however, interpreting "I think" as "I am not confident that" is also quite a stretch ;)</p>



<a name="278492148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492148">(Apr 10 2022 at 22:03)</a>:</h4>
<p>As of now, I really cant imagine a reason for why MaybeUninit cannot hold provenance.</p>



<a name="278492163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492163">(Apr 10 2022 at 22:03)</a>:</h4>
<p>It seems like these C "exceptions" are handled well for my model, <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1086706207">https://github.com/rust-lang/unsafe-code-guidelines/issues/286#issuecomment-1086706207</a></p>



<a name="278492201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492201">(Apr 10 2022 at 22:04)</a>:</h4>
<p>Almost at the bottom of that thread now!</p>



<a name="278492322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492322">(Apr 10 2022 at 22:07)</a>:</h4>
<p>hm now I need to re-think what I say about that in my blog post ;)</p>



<a name="278492360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278492360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278492360">(Apr 10 2022 at 22:08)</a>:</h4>
<p>and I thought I was <em>finally</em> done writing :P</p>



<a name="278495933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278495933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278495933">(Apr 10 2022 at 23:45)</a>:</h4>
<p>wow that blog post got a bit longer than I expected. even longer than the previous provenance blog post. ;)<br>
I considered splitting it into 2, but there is some constant per-blogpost cost (with the surge of discussions it often creates etc) that I want to minimize, so one big blog post it is...</p>



<a name="278496630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278496630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278496630">(Apr 11 2022 at 00:01)</a>:</h4>
<p>Maybe your blog has union provenance semantics</p>



<a name="278497241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278497241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278497241">(Apr 11 2022 at 00:16)</a>:</h4>
<p>oh gosh please no dont do that to me^^</p>



<a name="278498031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278498031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278498031">(Apr 11 2022 at 00:34)</a>:</h4>
<p>Speaking of increasing provenance, that's something my model doesn't generally allow since it could cause UB in integer operations.</p>



<a name="278498352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278498352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278498352">(Apr 11 2022 at 00:43)</a>:</h4>
<p>ah yes, that is a good point. I am not sure if anything <em>needs</em> that (it came up in an alternative proposal for what to do on a ptr2int transmutation), but it is a kind of monotonicity one might intuitively expect.</p>



<a name="278498956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278498956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278498956">(Apr 11 2022 at 00:58)</a>:</h4>
<p>Yeah, another example where that would add UB is if we decide that if some of a pointer's bytes have no provenance and some bytes have provenance, the resulting pointer gets the provenance that is there (as long as everything agrees) See here for related discussion: <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance</a> . I don't actually think we have any need to support this though, but it does pose a very interesting problem for C...</p>



<a name="278503596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278503596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278503596">(Apr 11 2022 at 02:50)</a>:</h4>
<p>hm, actually my proposed solution of making it UB to load data with provenance at integer type also is non-monotone...</p>



<a name="278503644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278503644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278503644">(Apr 11 2022 at 02:50)</a>:</h4>
<p>looks like implicitly stripping (but not exposing) provenance on load both <em>relies on</em> monotonicity (if we want to still be allowed to remove <code>x=x;</code>) but also is required to <em>achieve</em> monotonicity</p>



<a name="278509079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278509079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278509079">(Apr 11 2022 at 05:02)</a>:</h4>
<p>Hold on, why is it non monotone?</p>



<a name="278543159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278543159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278543159">(Apr 11 2022 at 12:05)</a>:</h4>
<p>I've been thinking about supporting <code>memcpy</code> with arbitrary sized integers and I have come to the conclusion that that requires loads and stores to preserve bytewise poison. It seems to be a general requirement for models where poison cannot be widened and not specific to mine.</p>
<p>If changing loads and stores to have bitwise poison is reasonable, then my model can support such <code>memcpy</code>s. I think LLVM wants to lower <code>memcpy</code> to regular integer loads and stores which is another reason to support it besides user defined <code>memcpy</code> implementations.</p>



<a name="278544640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278544640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278544640">(Apr 11 2022 at 12:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278509079">said</a>:</p>
<blockquote>
<p>Hold on, why is it non monotone?</p>
</blockquote>
<p>an integer load on data without provenance is fine. if you add provenance to it, the integer load becomes UB (or produces poison).<br>
clearly that's not monotone, is it?</p>



<a name="278544862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278544862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278544862">(Apr 11 2022 at 12:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278543159">said</a>:</p>
<blockquote>
<p>I've been thinking about supporting <code>memcpy</code> with arbitrary sized integers and I have come to the conclusion that that requires loads and stores to preserve bytewise poison. It seems to be a general requirement for models where poison cannot be widened and not specific to mine.</p>
<p>If changing loads and stores to have bitwise poison is reasonable, then my model can support such <code>memcpy</code>s. I think LLVM wants to lower <code>memcpy</code> to regular integer loads and stores which is another reason to support it besides user defined <code>memcpy</code> implementations.</p>
</blockquote>
<p><code>memcpy</code> should be implemented with <code>MaybeUninit&lt;$int&gt;</code> in Rust, so I assume you are talking about LLVM here.<br>
one plan that has been floated in LLVM for this is to use <code>[i8 x 8]</code> rather than <code>i64</code>. <code>[i8 x 8]</code> <em>does</em> handle poison per-byte. the "only" problem is that backends currently choke and produce terrible code when you write things like that.</p>



<a name="278544940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278544940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278544940">(Apr 11 2022 at 12:22)</a>:</h4>
<p>I forgot the arguments for why <code>i64</code> can only be entirely poison or not poison at all, but there were some good arguments IIRC. that's why people have been proposing the byte type to make this distinction explicit.</p>



<a name="278544992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278544992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278544992">(Apr 11 2022 at 12:22)</a>:</h4>
<p>(also you proposed multiple models, so not sure which one you are referring to with "my model" here)</p>



<a name="278545368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278545368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278545368">(Apr 11 2022 at 12:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278544640">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278509079">said</a>:</p>
<blockquote>
<p>Hold on, why is it non monotone?</p>
</blockquote>
<p>an integer load on data without provenance is fine. if you add provenance to it, the integer load becomes UB (or produces poison).<br>
clearly that's not monotone, is it?</p>
</blockquote>
<p>Isn't it? I suppose I don't know the definition of monotone you're using</p>



<a name="278546025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278546025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278546025">(Apr 11 2022 at 12:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278544862">said</a>:</p>
<blockquote>
<p><code>memcpy</code> should be implemented with <code>MaybeUninit&lt;$int&gt;</code> in Rust, so I assume you are talking about LLVM here.<br>
one plan that has been floated in LLVM for this is to use <code>[i8 x 8]</code> rather than <code>i64</code>. <code>[i8 x 8]</code> <em>does</em> handle poison per-byte. the "only" problem is that backends currently choke and produce terrible code when you write things like that.</p>
</blockquote>
<p>Yeah I was expecting using arrays or vectors may cause some problems, even if it technically works.</p>



<a name="278546204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278546204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278546204">(Apr 11 2022 at 12:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278544992">said</a>:</p>
<blockquote>
<p>(also you proposed multiple models, so not sure which one you are referring to with "my model" here)</p>
</blockquote>
<p>The integer operations are UB with provenance one.</p>



<a name="278546910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278546910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278546910">(Apr 11 2022 at 12:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278544940">said</a>:</p>
<blockquote>
<p>I forgot the arguments for why <code>i64</code> can only be entirely poison or not poison at all, but there were some good arguments IIRC. that's why people have been proposing the byte type to make this distinction explicit.</p>
</blockquote>
<p>It seems like C's <code>char</code> would require bitwise loads at least. These arguments may also apply against <code>char</code> with the promotion to integer trick.</p>



<a name="278569794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278569794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278569794">(Apr 11 2022 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="310518">@Jak{e,ob} Degen</span> by "monotone" I mean: is it an allowed program transformation to "increase" the provenance of a pointer/value, i.e., change its provenance such that it can access more memory?</p>



<a name="278569848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278569848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278569848">(Apr 11 2022 at 15:19)</a>:</h4>
<p>this is not the case if loading a value with provenance at int type is poison, since then adding provenance to a provenance-free value can introduce UB</p>



<a name="278570094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278570094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278570094">(Apr 11 2022 at 15:21)</a>:</h4>
<p>Ah, yes, I see</p>



<a name="278570978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278570978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278570978">(Apr 11 2022 at 15:26)</a>:</h4>
<blockquote>
<p>If changing loads and stores to have bitwise poison is reasonable, then my model can support such memcpys.</p>
</blockquote>
<p>In that case you'd have to even allow "mixed provenance" on an <code>i64</code> -- basically it has to be able to hold anything that 8 consecutive bytes in memory can hold.<br>
if LLVM doesn't want a byte type, I think they need to do this (or make <code>[i8 x 8]</code> work better -- making codegen backends still treat this as a single 64bit register).</p>



<a name="278571054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278571054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278571054">(Apr 11 2022 at 15:27)</a>:</h4>
<p>but for a Rust discussion this is all very speculative. we'll just have to see what they end up deciding. or rather, we'll have to hope that they even consider this worth discussing at some point, and then we can be part of the discussion...</p>



<a name="278571136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278571136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278571136">(Apr 11 2022 at 15:28)</a>:</h4>
<p>given how long "easy" issues like <a href="https://bugs.llvm.org/show_bug.cgi?id=34548">https://bugs.llvm.org/show_bug.cgi?id=34548</a> have been open, I am not extremely hopeful about LLVM moving to anything more coherently defined any time soon :(</p>



<a name="278571522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278571522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278571522">(Apr 11 2022 at 15:30)</a>:</h4>
<p>So to summarize, this seems to imply that we have two options:<br>
 a) Either we make ptr bytes at int type UB, in which case we need to ensure we have monotonicity everywhere (I don't see why not, but clearly this has surprised us at least once)<br>
 b) Or ptr to int strips provenance, in which case... we also need to ensure that we have monotonicity everywhere else</p>



<a name="278571842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278571842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278571842">(Apr 11 2022 at 15:32)</a>:</h4>
<p>At least this makes the question of "which one do we want" somewhat simpler, since we can take the monotonicity problem out of the equation</p>



<a name="278572248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278572248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278572248">(Apr 11 2022 at 15:35)</a>:</h4>
<p>that doesnt seem right. a) implies non-monotonicity!</p>



<a name="278572409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278572409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278572409">(Apr 11 2022 at 15:36)</a>:</h4>
<p>so either we make ptr bytes at int type UB and give up on monotonicity, or we make them strip provenance implicitly and then we have to be <em>sure</em> everything else is monotone</p>



<a name="278572520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278572520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278572520">(Apr 11 2022 at 15:37)</a>:</h4>
<p>Ehh... yes. I got my wires crossed</p>



<a name="278572664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278572664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278572664">(Apr 11 2022 at 15:38)</a>:</h4>
<p>Edited to fix</p>



<a name="278575421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278575421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278575421">(Apr 11 2022 at 15:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278570978">said</a>:</p>
<blockquote>
<p>In that case you'd have to even allow "mixed provenance" on an <code>i64</code> -- basically it has to be able to hold anything that 8 consecutive bytes in memory can hold.</p>
</blockquote>
<p>Even ignoring poison, "mixed provenance" pointers and integers are fine as long as they are not dereferenced? Integer operations are unaffected compared to singular provenance.</p>



<a name="278578148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278578148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278578148">(Apr 11 2022 at 16:16)</a>:</h4>
<p>if we allow uniform provenance in ints (until they are operated on) there is no reason to forbid mixed provenance, yeah</p>



<a name="278578168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278578168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278578168">(Apr 11 2022 at 16:17)</a>:</h4>
<p>less sure about pointers</p>



<a name="278698512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278698512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278698512">(Apr 12 2022 at 14:14)</a>:</h4>
<p>Nuno Lopes seemed to have considered a different model for bitwise poison which had problems. We'll see if he can come up with some problems.</p>



<a name="278698850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278698850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278698850">(Apr 12 2022 at 14:16)</a>:</h4>
<p>If not I may try to model it in Alive2. It does seem to fit well with LLVM's existing behavior, which could make adoption easier.</p>



<a name="278699385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278699385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278699385">(Apr 12 2022 at 14:20)</a>:</h4>
<p>So to solve the problem of the 3 (seemingly) correct optimizations in <a href="https://www.ralfj.de/blog/2020/12/14/provenance.html">https://www.ralfj.de/blog/2020/12/14/provenance.html</a> we answer that Clang lowered the program incorrectly to LLVM IR by not using side effecting instructions for casts.</p>



<a name="278699777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278699777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278699777">(Apr 12 2022 at 14:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116466">@Zoxc</span> the side-effect is not the problem in that example</p>



<a name="278699916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278699916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278699916">(Apr 12 2022 at 14:24)</a>:</h4>
<p>I may need to consider that argument more carefully :)</p>



<a name="278699930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278699930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278699930">(Apr 12 2022 at 14:24)</a>:</h4>
<p>even if we had the side-effect, if LLVM optimized</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">%</span><span class="n">ptr2</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="n">inttoptr</span><span class="p">(</span><span class="n">ptrtoint_exposed</span><span class="p">(</span><span class="o">%</span><span class="n">ptr</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">ptrtoint_exposed</span><span class="p">(</span><span class="o">%</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="o">%</span><span class="n">ptr2</span><span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="n">ptr</span><span class="w"></span>
</code></pre></div>
<p>it would still be wrong</p>



<a name="278700017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700017">(Apr 12 2022 at 14:25)</a>:</h4>
<p>are you privately chatting with Nuno or is there some public discussion I can follow somewhere?</p>



<a name="278700164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700164">(Apr 12 2022 at 14:26)</a>:</h4>
<p>I just emailed him.</p>



<a name="278700318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700318">(Apr 12 2022 at 14:27)</a>:</h4>
<p>My point was more a general vague idea that LLVM is correct, but we lower to LLVM IR incorrectly. If this is true, could we fix miscompilations by adding dummy asm statements to casts? So force LLVM to consider them to have a side effect, and if you want fast code, use strict provenance APIs.</p>



<a name="278700347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700347">(Apr 12 2022 at 14:27)</a>:</h4>
<p>I dont think that LLVM is correct</p>



<a name="278700375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700375">(Apr 12 2022 at 14:27)</a>:</h4>
<p><code>inttoptr(ptrtoint(_))</code> can fundamentally not be reduced away</p>



<a name="278700448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700448">(Apr 12 2022 at 14:28)</a>:</h4>
<p>even the LLVM twinsem model doesn't allow that</p>



<a name="278700472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700472">(Apr 12 2022 at 14:28)</a>:</h4>
<p>I dont think there is any model that allows that</p>



<a name="278700501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700501">(Apr 12 2022 at 14:28)</a>:</h4>
<p>even if this is the non-side-effecting <code>ptrtoint</code></p>



<a name="278700598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700598">(Apr 12 2022 at 14:29)</a>:</h4>
<p>also doing replacement of <code>==</code>-equal pointers is likewise fundamentally broken</p>



<a name="278700622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700622">(Apr 12 2022 at 14:29)</a>:</h4>
<p>so those two things LLVM <em>has</em> to fix</p>



<a name="278700772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700772">(Apr 12 2022 at 14:30)</a>:</h4>
<p>of course one can always add enough optimization barriers so that these LLVM bugs do not surface any more. but that doesn't fix the bugs.</p>



<a name="278700830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700830">(Apr 12 2022 at 14:30)</a>:</h4>
<p>also if LLVM says <code>ptrtoint</code> is like Rust's <code>addr</code>, it really should add something that is like <code>expose_addr</code>. leaving it to the frontends to somehow encode that seems terrible.</p>



<a name="278700893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems%20with%20integer%20provenance/near/278700893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance.html#278700893">(Apr 12 2022 at 14:31)</a>:</h4>
<p>and that still leaves the question of whether <code>inttoptr</code> is like <code>ptr::invalid</code> or <code>ptr::from_exposed_addr</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>