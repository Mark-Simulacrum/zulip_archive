<html>
<head><meta charset="utf-8"><title>aliasing and unsafe cell · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html">aliasing and unsafe cell</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276732862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276732862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276732862">(Mar 26 2022 at 16:06)</a>:</h4>
<p>As I understand it, <code>UnsafeCell</code> bends the rules of aliasing. Normally a <code>&amp;T</code> to the outside of a structure assumes no mutable references exist to the inside of it. However with an <code>UnsafeCell</code> you can have a <code>&amp;UnsafeCell&lt;T&gt;</code> and a <code>&amp;mut T</code> coexist. Does the reciprocal of this also apply? Can you have a <code>&amp;mut UnsafeCell&lt;T&gt;</code> coexist with a <code>&amp;T</code>? Normally you can't have a mutable reference to the outside of a struct and a reference to the inside the whole thing is guaranteed unique.</p>



<a name="276733138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733138">(Mar 26 2022 at 16:12)</a>:</h4>
<p>You can trivially  do this, in fact, in purely safe code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnsafeCell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">get_mut</span><span class="p">();</span><span class="w"></span>
<span class="c1">// `z` and `y` point to the same location</span>
</code></pre></div>
<p>Of course, if you mean unrelated references, no, the SRO from the <code>&amp;T</code> would either invalidate or be invalidated by the <code>Unique</code>of the <code>&amp;mut UnsafeCell&lt;T&gt;</code>.</p>
<p><code>UnsafeCell&lt;T&gt;</code> is only special wrt. <code>&amp;UnsafeCell&lt;T&gt;</code> (Shared Read/Write instead of Shared Read-only). <code>&amp;mut UnsafeCell&lt;T&gt;</code> is functionally the same as any other <code>&amp;mut U</code>, and the inner <code>T</code> is just covered by the same borrow stack item.</p>



<a name="276733387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733387">(Mar 26 2022 at 16:18)</a>:</h4>
<p><span class="user-mention" data-user-id="421643">@Troy</span> <code>&amp;mut UnsafeCell&lt;T&gt;</code> is the same as <code>&amp;mut T</code>, basically (and the docs should say that)</p>



<a name="276733400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733400">(Mar 26 2022 at 16:18)</a>:</h4>
<p>we might want to have <code>UnsafeAlias</code> that is special for <code>&amp;mut</code> (and not <code>&amp;</code>), that seems to nicely complement <code>UnsafeCell</code> and might be useful for self-referential types</p>



<a name="276733405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733405">(Mar 26 2022 at 16:19)</a>:</h4>
<p>Has that been proposed before?</p>



<a name="276733412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733412">(Mar 26 2022 at 16:19)</a>:</h4>
<p>indeed the docs do say that:</p>
<blockquote>
<p>Note that whilst mutating the contents of an &amp;UnsafeCell&lt;T&gt; (even while other &amp;UnsafeCell&lt;T&gt; references alias the cell) is ok (provided you enforce the above invariants some other way), it is still undefined behavior to have multiple &amp;mut UnsafeCell&lt;T&gt; aliases. That is, UnsafeCell is a wrapper designed to have a special interaction with shared accesses (i.e., through an &amp;UnsafeCell&lt;_&gt; reference); there is no magic whatsoever when dealing with exclusive accesses (e.g., through an &amp;mut UnsafeCell&lt;_&gt;): neither the cell nor the wrapped value may be aliased for the duration of that &amp;mut borrow. This is showcased by the .get_mut() accessor, which is a safe getter that yields a &amp;mut T.</p>
</blockquote>



<a name="276733417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733417">(Mar 26 2022 at 16:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421643">Troy</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell/near/276733405">said</a>:</p>
<blockquote>
<p>Has that been proposed before?</p>
</blockquote>
<p><code>UnsafeAlias</code> you mean? yes in some UCG discussions around self-referential types and generators</p>



<a name="276733430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733430">(Mar 26 2022 at 16:19)</a>:</h4>
<p>not sure which name it was given</p>



<a name="276733474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733474">(Mar 26 2022 at 16:20)</a>:</h4>
<p>the main issues to check would be <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/148">https://github.com/rust-lang/unsafe-code-guidelines/issues/148</a> and <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/194">https://github.com/rust-lang/unsafe-code-guidelines/issues/194</a></p>



<a name="276733499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733499">(Mar 26 2022 at 16:21)</a>:</h4>
<p>thanks. It seems the only way to opt of out of <code>noalias</code> is implementing <code>!UnPin</code> which is a pretty terrible hack</p>



<a name="276733514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733514">(Mar 26 2022 at 16:21)</a>:</h4>
<p>that's also not a guarantee</p>



<a name="276733565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733565">(Mar 26 2022 at 16:22)</a>:</h4>
<p>basically currently only rustc-generated generators (<code>async</code> blocks) get to do this kind of stuff since they are in the compiler and can exploit compiler-private features like the <code>Unpin</code> and <code>noalias</code> interaction</p>



<a name="276733587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733587">(Mar 26 2022 at 16:22)</a>:</h4>
<p>right, just a work around until something official is made</p>



<a name="276733682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276733682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276733682">(Mar 26 2022 at 16:25)</a>:</h4>
<p>The issue I am looking at is that I am trying to port some garbage collectors to rust. When collection starts we need to trace through all the root structures, which are mutable. But doing so is a vilolation of mutable aliasing (we are reading data that rust thinks is unique). Wanted to see if there was a way to make it workable without the <code>!UnPin</code> hack to prevent miscompilations.</p>



<a name="276734049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276734049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276734049">(Mar 26 2022 at 16:33)</a>:</h4>
<p>why would Rust ever think that data behind a <code>Gc&lt;T&gt;</code> is unique?</p>



<a name="276734393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276734393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276734393">(Mar 26 2022 at 16:41)</a>:</h4>
<p>How would you mark it as not unique? <code>Gc</code> is not a Std lib type.</p>



<a name="276734666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276734666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276734666">(Mar 26 2022 at 16:48)</a>:</h4>
<p>Raw pointers are allowed to alias other raw pointers (if you do things right), the default assumption is that Gc&lt;T&gt; accesss would be based around a raw pointer and not a reference, so the compiler would know to not get smart about aliasing</p>



<a name="276734685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276734685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276734685">(Mar 26 2022 at 16:49)</a>:</h4>
<p>you may be interested in <a href="https://manishearth.github.io/blog/2015/09/01/designing-a-gc-in-rust/">https://manishearth.github.io/blog/2015/09/01/designing-a-gc-in-rust/</a></p>



<a name="276734902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing%20and%20unsafe%20cell/near/276734902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell.html#276734902">(Mar 26 2022 at 16:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421643">Troy</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/aliasing.20and.20unsafe.20cell/near/276734393">said</a>:</p>
<blockquote>
<p>How would you mark it as not unique? <code>Gc</code> is not a Std lib type.</p>
</blockquote>
<p>don't use <code>Box</code> or <code>&amp;mut</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>