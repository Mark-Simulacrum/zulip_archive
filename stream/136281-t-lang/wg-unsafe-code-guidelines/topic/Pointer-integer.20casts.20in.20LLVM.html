<html>
<head><meta charset="utf-8"><title>Pointer-integer casts in LLVM · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html">Pointer-integer casts in LLVM</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278702068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278702068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278702068">(Apr 12 2022 at 14:39)</a>:</h4>
<p>Under my model we can define LLVM's <code>inttoptr</code> and <code>ptrtoint</code> as transmutes (no effect on the bits) which makes the <code>inttoptr(ptrtoint(p)) &lt;-&gt; p</code> transformation legal.</p>



<a name="278702531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278702531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278702531">(Apr 12 2022 at 14:42)</a>:</h4>
<p>Formally I'd add <code>expose_addr</code> / <code>from_exposed_addr</code> as additional new instructions or intrinsics, but <code>asm</code> should work in practice as a placeholder for those.</p>



<a name="278702839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278702839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278702839">(Apr 12 2022 at 14:44)</a>:</h4>
<p>then how do I write Rust's <code>addr</code> in LLVM?</p>



<a name="278702945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278702945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278702945">(Apr 12 2022 at 14:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Problems.20with.20integer.20provenance/near/278702068">said</a>:</p>
<blockquote>
<p>Under my model we can define LLVM's <code>inttoptr</code> and <code>ptrtoint</code> as transmutes (no effect on the bits) which makes the <code>inttoptr(ptrtoint(p)) &lt;-&gt; p</code> transformation legal.</p>
</blockquote>
<p>that will make a huge fraction of existing code with these instructions UB, since that code will do stuff like pointer tagging.<br>
and that UB can <em>not</em> be fixed by adding <code>asm</code>. maybe we can get the compiler to stop exploiting it but that's miles away from a fix. so, this sounds like a bad idea to me.</p>



<a name="278703076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278703076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278703076">(Apr 12 2022 at 14:46)</a>:</h4>
<p>LLVM already has <code>bitcast</code> for transmutation; it seems very odd to me that the evocatively named <code>ptrtoint</code>/<code>inttoptr</code> would be the operations you'd basically never want to use for these casts</p>



<a name="278703496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278703496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278703496">(Apr 12 2022 at 14:49)</a>:</h4>
<p>I think the only backwards compatible thing to do is to make <code>ptrtoint := expose_addr</code>, <code>inttoptr := from_exposed_addr</code>, and then add new operations/intrinsics for <code>addr</code> and <code>with_addr</code>. so IMO that's the best option.</p>



<a name="278703747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278703747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278703747">(Apr 12 2022 at 14:51)</a>:</h4>
<p>(I moved this to a new thread since i moved quite far away from where "problems with PVI" started)</p>



<a name="278704432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278704432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278704432">(Apr 12 2022 at 14:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278702839">said</a>:</p>
<blockquote>
<p>then how do I write Rust's <code>addr</code> in LLVM?</p>
</blockquote>
<p>Not sure if it can be written in LLVM now without lowering to a new cast instruction, but adding a intrinsic / operation for it would make sense for optimization purposes.</p>



<a name="278704777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278704777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278704777">(Apr 12 2022 at 14:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278703076">said</a>:</p>
<blockquote>
<p>LLVM already has <code>bitcast</code> for transmutation; it seems very odd to me that the evocatively named <code>ptrtoint</code>/<code>inttoptr</code> would be the operations you'd basically never want to use for these casts</p>
</blockquote>
<p>Yes, they should probably be removed and have their uses replaced with <code>bitcast</code>, but that requires actual work ^.^.  It doesn't make them wrong though.</p>



<a name="278704971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278704971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278704971">(Apr 12 2022 at 14:58)</a>:</h4>
<p>I mean technically you are right but in terms of the intention of people that emit these instructions your change makes everything wrong</p>



<a name="278705103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278705103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278705103">(Apr 12 2022 at 14:59)</a>:</h4>
<p>like, this will literally make safe Rust unsound. that's a huge breaking change on the side of LLVM.</p>



<a name="278705915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278705915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278705915">(Apr 12 2022 at 15:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278702945">said</a>:</p>
<blockquote>
<p>that will make a huge fraction of existing code with these instructions UB, since that code will do stuff like pointer tagging.<br>
and that UB can <em>not</em> be fixed by adding <code>asm</code>. maybe we can get the compiler to stop exploiting it but that's miles away from a fix. so, this sounds like a bad idea to me.</p>
</blockquote>
<p>My argument is that in practice it already is UB and is causing miscompilations. LLVM IR is not a stable language so it can and does change its semantics and expect front ends to adapt. This change doesn't cause more miscompilations than LLVM currently does. Clang could keep using inttoptr/ptrtoint and say they will fix end to end miscompilations (sometimes). Effectively the change preserves the status quo, but we gain formal semantics and frontends like Rust can adapt to avoid miscompilations.</p>



<a name="278706087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278706087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278706087">(Apr 12 2022 at 15:04)</a>:</h4>
<p>So Rust gains some formal correctness and LLVM / Clang doesn't need to change their behavior or implementation much.</p>



<a name="278708509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278708509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278708509">(Apr 12 2022 at 15:20)</a>:</h4>
<p>Nuno Lopes didn't have any immediate objections to my semantics for bitwise poison. The previous attempt was trying to define integer operations to return bitwise poison too, perhaps to avoid freeze.</p>



<a name="278711144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278711144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278711144">(Apr 12 2022 at 15:41)</a>:</h4>
<p>Another way you could phrase things is that Clang adheres to the C standard and doesn't formally support ptr&lt;-&gt;int, but tries to on a best effort basis.</p>



<a name="278715537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278715537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278715537">(Apr 12 2022 at 16:12)</a>:</h4>
<p>it causes miscompilations because LLVM is buggy :) I dont think it is good style to outsource that problem to the frontends. this is a common problem across all frontends since it's actually an LLVM IR problem.<br>
it's true that LLVM IR doesn't <em>technically</em> guarantee ptr-int roundtrips, but that's because nobody thought that would even need stating. it's also entirely clear that the <em>intention</em> of ptrtoint and inttoptr is to support these round-trips (and doing integer ops in between), given that clang and LLVM IR were co-designed.</p>



<a name="278715713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278715713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278715713">(Apr 12 2022 at 16:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278711144">said</a>:</p>
<blockquote>
<p>Another way you could phrase things is that Clang adheres to the C standard and doesn't formally support ptr&lt;-&gt;int, but tries to on a best effort basis.</p>
</blockquote>
<p>that sounds like a cheap excuse but is totally unrealistic. clang definitely intends to support them. I bet there's even documentation along those lines...</p>



<a name="278715885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278715885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278715885">(Apr 12 2022 at 16:15)</a>:</h4>
<p>I also dont see which problem this change solves. like, we <em>need</em> an operation like <code>expose_addr</code>/<code>from_exposed_addr</code> to support the kind of code people write in C (and Rust). no matter the journey, at its end such an operation should exist. what do we gain by "burning" the names <code>inttoptr</code> and <code>ptrtoint</code> (which every frontend already expects to work like that!) by making them equivalent to <code>bitcast</code>, and then coming up with <em>new</em> names for the operations we <em>actually</em> want?</p>



<a name="278715994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278715994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278715994">(Apr 12 2022 at 16:16)</a>:</h4>
<p>Rust doesnt gain any formal correctness at all until <code>addr</code> and <code>expose_addr</code> can be expressed in LLVM IR. adding <code>asm</code> blocks as optimization barriers and then hoping that's enough is the antithesis of formal correctness.^^</p>



<a name="278722467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278722467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278722467">(Apr 12 2022 at 17:06)</a>:</h4>
<p>I don't disagree with the intent of <code>ptrtoint</code> and <code>inttoptr</code> and Clang's intent in using them. The reason I'm not redefining them as casts is that it allows gradual adoption of them in LLVM without first removing all existing uses and optimizations of <code>ptrtoint</code> and <code>inttoptr</code>. Frontends can opt in to the new casts when LLVM optimizes them sufficiently for their needs. This seems to make adoption much more practical and it does not cause additional miscompiles or lost performance during a transition period.</p>



<a name="278722586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278722586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278722586">(Apr 12 2022 at 17:07)</a>:</h4>
<p>breaking all frontends doesn't sound like "gradual adoption" to me. rather the opposite.</p>



<a name="278722945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278722945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278722945">(Apr 12 2022 at 17:10)</a>:</h4>
<p>What would break? I'm not proposing any changes to LLVM's implementation (ignoring the new addition of casts)</p>



<a name="278723425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278723425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278723425">(Apr 12 2022 at 17:14)</a>:</h4>
<p>It does shifts the blame for the current broken behavior from LLVM to Clang (and other frontends). Changing the frontends to emit something different for casts seems much easier than changing LLVM itself.</p>



<a name="278732284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278732284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278732284">(Apr 12 2022 at 18:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278723425">said</a>:</p>
<blockquote>
<p>It does shifts the blame for the current broken behavior from LLVM to Clang (and other frontends). Changing the frontends to emit something different for casts seems much easier than changing LLVM itself.</p>
</blockquote>
<p>why is changing <em>all</em> frontends easier than changing their single shared backend? I'd expect the exact opposite.</p>



<a name="278732894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278732894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278732894">(Apr 12 2022 at 18:24)</a>:</h4>
<p>Maybe just incrementally fixing existing <code>inttoptr</code> and <code>ptrtoint</code> is fine. I'd prefer some better naming though. They don't sound very side-effecty. Things get a bit odd with <code>addr()</code> in the mix too.</p>



<a name="278732956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278732956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278732956">(Apr 12 2022 at 18:24)</a>:</h4>
<blockquote>
<p>They don't sound very side-effecty.</p>
</blockquote>
<p>yeah, we have to fight years or decades of incorrect intuition here</p>



<a name="278733126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278733126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278733126">(Apr 12 2022 at 18:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278723425">said</a>:</p>
<blockquote>
<p>It does shifts the blame for the current broken behavior from LLVM to Clang (and other frontends).</p>
</blockquote>
<p>FWIW I think "shift the burden" might be okay, but if LLVM starts claiming that Rust "should have known better" or so and not expect LLVM <code>ptrtoint</code> to do the job that it says on the tin -- if LLVM starts to put the blame on the Rust frontend for this -- then I'm going to be in strong disagreement.^^</p>



<a name="278733383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278733383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278733383">(Apr 12 2022 at 18:27)</a>:</h4>
<p>but I still think it'd make a lot more sense to make <code>inttoptr</code>/<code>ptrtoint</code> <em>not</em> equivalent to <code>bitcast</code>. there's no reason to have alternative names for <code>bitcast</code>.<br>
in fact I'd say the fact that these are separate operations indicates that the LLVM designers might have had a hunch that this is <em>not</em> the same as a bitcast.</p>



<a name="278733710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278733710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278733710">(Apr 12 2022 at 18:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278732956">said</a>:</p>
<blockquote>
<blockquote>
<p>They don't sound very side-effecty.</p>
</blockquote>
<p>yeah, we have to fight years or decades of incorrect intuition here</p>
</blockquote>
<p>from a frontend perspective though, these names are probably the ones we want (for the expose-related operations). some part of this discussion boils down to whether the API is designed for frontends or for optimizations...</p>



<a name="278733882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278733882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278733882">(Apr 12 2022 at 18:30)</a>:</h4>
<p>on <code>ptrtoint</code> we might have a flag that indicates whether exposing happens or not, and old bitcode <code>ptrtoint</code> might be migrated to <code>ptrtoint expose</code>. maybe that would help remind optimization authors that there is a side-effect here?<br>
that's harder for <code>from_exposed_addr</code> vs <code>with_addr</code> as these operations have different sigantures.</p>



<a name="278736286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278736286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278736286">(Apr 12 2022 at 18:49)</a>:</h4>
<p>I think it just make sense to have separate ptr&lt;-&gt;int instructions for exposed and strict provenance things. Make it easier to see that the former has global reads/writes. LLVM IR definitely seems designed for optimizations to me.</p>



<a name="278736573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278736573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278736573">(Apr 12 2022 at 18:51)</a>:</h4>
<p>I also had in mind a <code>clearptr</code> instruction which just removes provenance from any value. Combined with <code>bitcast</code> it can implement <code>addr()</code>. You could also use <code>with_addr</code> on an integer.</p>



<a name="278736746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278736746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278736746">(Apr 12 2022 at 18:52)</a>:</h4>
<p>So strict provenance instructions doesn't need to cast between IR types. It's possible that <code>clearptr</code> would be helpful for other things to remove poison from integer operations too.</p>



<a name="278736810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278736810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278736810">(Apr 12 2022 at 18:53)</a>:</h4>
<p>even with making <code>inttoptr</code> and <code>ptrtoint</code> aliases for <code>bitcast</code>, there's still something that needs to be fixed in LLVM: replacing one <code>icmp eq</code>-equal pointer by another. that's <a href="https://github.com/llvm/llvm-project/issues/34577">https://github.com/llvm/llvm-project/issues/34577</a>.<br>
there's no way to avoid acknowledging that <em>some</em> things LLVM did are definitely wrong. so I dont see why you want to maintain <code>inttoptr(ptrtoint(_))</code> simplification so badly.</p>



<a name="278736920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278736920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278736920">(Apr 12 2022 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278736286">said</a>:</p>
<blockquote>
<p>I think it just make sense to have separate ptr&lt;-&gt;int instructions for exposed and strict provenance things. Make it easier to see that the former has global reads/writes.</p>
</blockquote>
<p>fair. but <code>bitcast</code> is neither of them. :D</p>



<a name="278737697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278737697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278737697">(Apr 12 2022 at 18:59)</a>:</h4>
<p>Actually I think you only need an <code>replaceprov</code> instruction with <code>addr(x)</code> being <code>replaceprov(x, 0)</code>.</p>



<a name="278738160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278738160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278738160">(Apr 12 2022 at 19:02)</a>:</h4>
<p>there are many ways to skin that cat</p>



<a name="278738209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278738209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278738209">(Apr 12 2022 at 19:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM/near/278736810">said</a>:</p>
<blockquote>
<p>even with making <code>inttoptr</code> and <code>ptrtoint</code> aliases for <code>bitcast</code>, there's still something that needs to be fixed in LLVM: replacing one <code>icmp eq</code>-equal pointer by another. that's <a href="https://github.com/llvm/llvm-project/issues/34577">https://github.com/llvm/llvm-project/issues/34577</a>.<br>
there's no way to avoid acknowledging that <em>some</em> things LLVM did are definitely wrong. so I dont see why you want to maintain <code>inttoptr(ptrtoint(_))</code> simplification so badly.</p>
</blockquote>
<p>Yeah. We have to make sure that LLVM does not change the type used for <code>icmp</code>.</p>



<a name="278738210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278738210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278738210">(Apr 12 2022 at 19:02)</a>:</h4>
<p>that said, I would usually expect <code>replaceprov</code> to return a pointer, not an integer</p>



<a name="278738467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer%20casts%20in%20LLVM/near/278738467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer-integer.20casts.20in.20LLVM.html#278738467">(Apr 12 2022 at 19:04)</a>:</h4>
<p>It can operate on any value here so it preserves the input type. It may be more efficient to integrate casting though.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>