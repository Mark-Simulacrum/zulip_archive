<html>
<head><meta charset="utf-8"><title>wasm and &quot;function pointers&quot; · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html">wasm and &quot;function pointers&quot;</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276411301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276411301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276411301">(Mar 23 2022 at 22:40)</a>:</h4>
<p>from <a href="https://github.com/rust-lang/rust/pull/95241#issuecomment-1076769919">bjorn3</a>:</p>
<blockquote>
<blockquote>
<p>wasm is less weird in that its function pointers are just usize indices (in a table of function pointers), so raw pointers can represent all function addresses even if the resulting pointer isn't itself valid for any memory access.</p>
</blockquote>
<p>Actually it seems they are always 32bit indices, even if you use a 64bit memory:</p>
<p><a href="https://github.com/WebAssembly/memory64/blob/main/proposals/memory64/Overview.md">https://github.com/WebAssembly/memory64/blob/main/proposals/memory64/Overview.md</a></p>
<blockquote>
<p>The <a href="https://webassembly.github.io/spec/core/syntax/types.html#table-types">table type</a> continues to use i32 indices</p>
</blockquote>
</blockquote>
<p>re: wasm's table type, it makes sense that its "function pointers" continue to be u32 no matter what, because uhh who the f needs more than 4294967296 symbols?</p>



<a name="276411691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276411691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276411691">(Mar 23 2022 at 22:43)</a>:</h4>
<p>this really illustrates the need for something for function pointers/Harvard architectures tho'<br>
however wasm kind of is a true "language model without provenance", as I understand it.</p>



<a name="276411842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276411842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276411842">(Mar 23 2022 at 22:44)</a>:</h4>
<p>wasm itself is a genuine case of my "a language that is little more than an assembler"</p>



<a name="276411880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276411880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276411880">(Mar 23 2022 at 22:45)</a>:</h4>
<p>right.</p>



<a name="276420819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276420819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276420819">(Mar 24 2022 at 00:37)</a>:</h4>
<p>at least fn pointer <em>addresses</em> fit in data pointers (even if invalid for data usage) heh</p>



<a name="276420877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276420877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276420877">(Mar 24 2022 at 00:38)</a>:</h4>
<p>most of the interesting (hardware) Harvard stuff I keep coming across has larger code pointers, because you may need a large program but it always operate with constrained RAM</p>



<a name="276420888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/276420888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#276420888">(Mar 24 2022 at 00:39)</a>:</h4>
<p>8051 is really cute with its 16-bit code pointers and 8-bit data pointers :3</p>



<a name="277538801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538801">(Apr 02 2022 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> you worked with amdgpu a lot a little while ago? I know it is also a harvard (has distinct address spaces for code and data.) but is it doing anything special otherwise?</p>



<a name="277538813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538813">(Apr 02 2022 at 16:30)</a>:</h4>
<p>I haven't done anything that low-level (yet), sorry</p>



<a name="277538823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538823">(Apr 02 2022 at 16:30)</a>:</h4>
<p>the ISA docs are public, so I suppose I could go look</p>



<a name="277538840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538840">(Apr 02 2022 at 16:31)</a>:</h4>
<p>No worries, I'll do it myself if anything really forces the evaluation of that question thunk ^^</p>



<a name="277538841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538841">(Apr 02 2022 at 16:31)</a>:</h4>
<p>(OTOH I wouldn't expect GPUs to be doing any von Neumann shenanigans any time soon, so I would assume they're all Harvard)</p>



<a name="277538894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538894">(Apr 02 2022 at 16:32)</a>:</h4>
<p>amdgpu just popped in my mind as an example of harvard one of these days I was walking my dog <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="277538900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277538900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277538900">(Apr 02 2022 at 16:32)</a>:</h4>
<p>(god just imagine the massive stalls a GPU core would go through if it had to account for self-modifying code)</p>



<a name="277539027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277539027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277539027">(Apr 02 2022 at 16:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22/near/276411301">said</a>:</p>
<blockquote>
<p>re: wasm's table type, it makes sense that its "function pointers" continue to be u32 no matter what, because uhh who the f needs more than 4294967296 symbols?</p>
</blockquote>
<p>WebAssembly is also interesting in that most VMs and parsers introduce limits stricter than the spec on the number of instances. In practice you won't really get more than a million distinct functions in a core module. Tables, though are somewhat different in that nobody prevents a producer from putting a function in the table more than once.</p>



<a name="277542709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277542709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277542709">(Apr 02 2022 at 17:58)</a>:</h4>
<p>Something folks here may find interesting: There is work underway on wasm64, where linear-memory indices are 64-bit, however function tables will remain 32-bit. So there's a question: in the C ABI, should function pointers be 32-bit or 64-bit?</p>



<a name="277542935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277542935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277542935">(Apr 02 2022 at 18:02)</a>:</h4>
<p>Right now, it looks like they're going to be 64-bit, because that's the default behavior of LLVM for 64-bit targets, and it avoids potential compatibility problems.</p>



<a name="277543564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277543564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277543564">(Apr 02 2022 at 18:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22/near/276411842">said</a>:</p>
<blockquote>
<p>wasm itself is a genuine case of my "a language that is little more than an assembler"</p>
</blockquote>
<p>That reminds me of this comment <a href="https://github.com/rust-lang/rust/pull/95583#issuecomment-1086613300">https://github.com/rust-lang/rust/pull/95583#issuecomment-1086613300</a></p>
<p>They're trying to pass serialized pointers from WASM to the browser and back to WASM again where they deserialize them.  Is there any provenance-preserving API between a browser and WASM?</p>



<a name="277543817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277543817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277543817">(Apr 02 2022 at 18:21)</a>:</h4>
<p>The wasm module could have a function taking <code>*mut ...</code> and thus having provenance. On wasm level this lowers to i32/i64 so the browser can pass an integer address.</p>



<a name="277629709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277629709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277629709">(Apr 03 2022 at 13:37)</a>:</h4>
<p>generally if you give <code>[MaybeUninit&lt;u8&gt;; N]</code> to an FFI and get it back later you can assume provenance was preserved</p>



<a name="277629791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277629791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277629791">(Apr 03 2022 at 13:38)</a>:</h4>
<p>if you give it to the FFI as integers then you already stripped provenance on the Rust side before handing it out so you don't get it back</p>



<a name="277629813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm%20and%20%22function%20pointers%22/near/277629813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/wasm.20and.20.22function.20pointers.22.html#277629813">(Apr 03 2022 at 13:38)</a>:</h4>
<p>but if you use <em>casts</em> from ptr 2 int and back, you are still fine under permissive provenance (but you are leaving the strict provenance fragment of the language)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>