<html>
<head><meta charset="utf-8"><title>Forging `*mut T` w/o `usize as *mut T` · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html">Forging `*mut T` w/o `usize as *mut T`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276120846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276120846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276120846">(Mar 21 2022 at 22:13)</a>:</h4>
<p>also good. I think at very least this is a good way to mark an address as "this is what i'm doing" during this experimental phase</p>



<a name="276120968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276120968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276120968">(Mar 21 2022 at 22:14)</a>:</h4>
<p>True! And probably covering only MMIO needs is a bit too narrow.<br>
But yeah it was discussed a little in <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.22creative.22.20Rust.20in.20embedded</a></p>



<a name="276123367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276123367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276123367">(Mar 21 2022 at 22:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60/near/276115309">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> I think that's exactly the right approach for synthesizing a pointer out of nothing. That's not quite the use case I was asking about, but I'm hugely in favor of that as an API for things like "make up an MMIO pointer" or "access a fixed-offset hardware table".</p>
</blockquote>
<p>ftr at least for MMIO it would be good to look at how you'd do it on CHERI because, well, it's portable: there's a custody chain from hardware-&gt;firmware-&gt;bootloader-&gt;kernel of "full address space capability" (or maybe most of it - presumably firmware could be cheeky and reserve some for itself)</p>
<p>so you can imagine this as "your kernel entry-point gets something you can further fragment into MMIO regions"</p>
<p>you can then emulate this by using inline <code>asm!</code> to produce a <code>*mut T</code> (the value doesn't really matter outside of CHERI) that you call <code>.with_addr</code> on</p>



<a name="276123445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276123445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276123445">(Mar 21 2022 at 22:46)</a>:</h4>
<p>the main thing is I am not sure how much microcontroller stuff tries to excessively const-prop fixed hardware addresses</p>



<a name="276123470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276123470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276123470">(Mar 21 2022 at 22:46)</a>:</h4>
<p>anything parsing a DTB, enumerating PCI config space, etc. can already do all of this quite nicely</p>



<a name="276123474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276123474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276123474">(Mar 21 2022 at 22:47)</a>:</h4>
<p>I honestly imagine very little.</p>



<a name="276123481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276123481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276123481">(Mar 21 2022 at 22:47)</a>:</h4>
<p>I mean, in C it's really easy to do so by default, because the default is often <code>#define</code></p>



<a name="276123497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276123497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276123497">(Mar 21 2022 at 22:47)</a>:</h4>
<p>right, I'm much more worried about the embedded Rust ecosystem</p>



<a name="276124266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276124266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276124266">(Mar 21 2022 at 22:57)</a>:</h4>
<p>For MMIO purposes, the assertion that no one else claims that same memory is far too strong. Particularly, any code should, at any time, be able to simply know the address of some particular MMIO thing (as a constant or whatever) and then use it without regard to who else might also use that same MMIO location before or after.</p>



<a name="276124388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276124388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276124388">(Mar 21 2022 at 22:58)</a>:</h4>
<p>Yeah, I suspected something like that might be the problem, which is why I approached the MMIO thing from the idea of a "well-known address" concept.</p>



<a name="276124533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging%20%60%2Amut%20T%60%20w/o%20%60usize%20as%20%2Amut%20T%60/near/276124533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Forging.20.60*mut.20T.60.20w.2Fo.20.60usize.20as.20*mut.20T.60.html#276124533">(Mar 21 2022 at 23:00)</a>:</h4>
<p>The MMIO that I generally see has all addresses known at compile time, but it's not unthinkable that MMIO might take place using addresses that are dynamically assigned.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>