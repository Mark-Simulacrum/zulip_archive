<html>
<head><meta charset="utf-8"><title>`usize` vs `size_t` · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html">`usize` vs `size_t`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250655201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250655201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250655201">(Aug 25 2021 at 17:50)</a>:</h4>
<p>Is <code>usize</code> guaranteed to be the same as C's <code>size_t</code>? Even on weirder platforms? I've always thought "yes" (and I believe it's currently true on all supported platforms), but I've also always mostly ignored the discussions around potential future w65-support.</p>
<p>If it's not, we should probably have a <code>std::os::raw::c_size_t</code> (or maybe something in libcore)</p>



<a name="250656111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250656111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250656111">(Aug 25 2021 at 17:56)</a>:</h4>
<p><code>usize</code> is <code>uintptr_t</code>.<code>size_t</code> and <code>uintptr_t</code> may not be the same for all platforms.</p>



<a name="250656170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250656170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250656170">(Aug 25 2021 at 17:57)</a>:</h4>
<p>It's the same for all currently supported platforms though.</p>



<a name="250658781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250658781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250658781">(Aug 25 2021 at 18:16)</a>:</h4>
<p>nards. I expect that will break some people.</p>



<a name="250660762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250660762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250660762">(Aug 25 2021 at 18:30)</a>:</h4>
<p>i filed <a href="https://github.com/rust-lang/rust/pull/88340">https://github.com/rust-lang/rust/pull/88340</a> for this.</p>



<a name="250661276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250661276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250661276">(Aug 25 2021 at 18:34)</a>:</h4>
<p>this will absolutely break some people because bindgen has a flag to just plain convert size_t to usize in generated code.</p>



<a name="250661706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250661706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250661706">(Aug 25 2021 at 18:37)</a>:</h4>
<p>It's not on by default, although TBH it should be, since I see way more libraries that pregenerate incorrectly as a result of this. (for example, <a href="https://github.com/Rust-SDL2/rust-sdl2/blob/master/sdl2-sys/sdl_bindings.rs#L951">https://github.com/Rust-SDL2/rust-sdl2/blob/master/sdl2-sys/sdl_bindings.rs#L951</a> is definitely not a thing that works on win64, where ulong is 32 bits but size_t is 64)</p>



<a name="250663470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250663470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250663470">(Aug 25 2021 at 18:49)</a>:</h4>
<p>TBH I am not particularly worried about <code>usize</code> and <code>size_t</code> not being the same. Many other things will break as well :)</p>



<a name="250663525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250663525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250663525">(Aug 25 2021 at 18:49)</a>:</h4>
<p>There are a lot C code in the wild assuming <code>size_t</code> and <code>uintptr_t</code> equivalence</p>



<a name="250664026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250664026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250664026">(Aug 25 2021 at 18:53)</a>:</h4>
<p>In Linux world pretty much everything assume <code>long</code> being the same as these as well, and kernel also makes that assumption. For that reason I believe a new architecture would choose an ABI that makes these all the same to aid portability.</p>



<a name="250666014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250666014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250666014">(Aug 25 2021 at 19:05)</a>:</h4>
<p>I agree new architectures will, but people are working on getting rust on less-new architectures that don't: <a href="https://internals.rust-lang.org/t/abi-discussion-for-w65/15092">https://internals.rust-lang.org/t/abi-discussion-for-w65/15092</a></p>



<a name="250672401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250672401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250672401">(Aug 25 2021 at 19:47)</a>:</h4>
<p>Indeed - I specified the abi mentioned in that post, and chose to differ size_t and uintptr_t for a particular reason, which I believe I noted in a post (particularily, it significantly penalizes codegen, especially of the commonly used memcpy).</p>



<a name="250673581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250673581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250673581">(Aug 25 2021 at 19:56)</a>:</h4>
<p>I'm not, at this time, going to say non-viably so, but I would <em>strongly prefer</em> the separation exist.</p>



<a name="250673966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250673966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250673966">(Aug 25 2021 at 19:58)</a>:</h4>
<p>I mean, i'm not really a fan of repeating C's complexities here, especially given that most C code gets this wrong. I think its better to have worse codegen (or even fail to support) very niche platforms, if it makes things simpler and safer for 99.99% of users.</p>



<a name="250674275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250674275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250674275">(Aug 25 2021 at 20:00)</a>:</h4>
<p>Well, in this case, I'm talking potentially 20+ cycles per iteration of memcpy extra.</p>



<a name="250674486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250674486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250674486">(Aug 25 2021 at 20:02)</a>:</h4>
<p>cant you just implement a better memcpy by hand (even if it takes doing it in asm)?</p>



<a name="250675742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250675742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250675742">(Aug 25 2021 at 20:11)</a>:</h4>
<p>Depends really, if the allocation size is also extended (otherwise, it could be fine). One thing that can't be fixed is the abi of usize, which costs an extra 15 cycles to load (though it is only a one time cost), since it has to copy the value into a memory location, then if it's generating code for the non-extended ptrdiff_t, it has to load the value into a hardware register (whereas current would just already be passed in that hardware register).</p>



<a name="250677582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250677582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250677582">(Aug 25 2021 at 20:26)</a>:</h4>
<p>I think it's technically possible to have <code>usize</code> and <code>size_t</code> differ. I do think that doing so invites a world of incompatibilities with C FFI. I don't think <em>Rust</em> will break, in general, just C FFI. So a platform that's prepared to not care very much about interoperability with some C code (which seems likely to be true anyway for an unusual constrained platform) can do that, and we should just document "this is allowed but unusual and may cause issues such as ...".</p>



<a name="250678314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250678314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250678314">(Aug 25 2021 at 20:32)</a>:</h4>
<p>Or, in the case of such platforms, you'd likely not be mapping to portable C code anyways, so ensuring to map the types correctly (usize=&gt;uintptr_t, size_t=&gt;u16 in the case of w65). <br>
Another possibility is a separation of freestanding/hosted targets (where freestanding isn't guaranteed or likely to have libstd support), and guarantee they are equivalent on hosted.</p>



<a name="250678819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250678819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250678819">(Aug 25 2021 at 20:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60/near/250677582">said</a>:</p>
<blockquote>
<p>I think it's technically possible to have <code>usize</code> and <code>size_t</code> differ. I do think that doing so invites a world of incompatibilities with C FFI. I don't think <em>Rust</em> will break, in general, just C FFI. So a platform that's prepared to not care very much about interoperability with some C code (which seems likely to be true anyway for an unusual constrained platform) can do that, and we should just document "this is allowed but unusual and may cause issues such as ...".</p>
</blockquote>
<p>I guess, although this puts library code in a somewhat awkward place, unfortunately — both in the case of c-to-rust and rust-to-c.</p>
<p>For example, it motivates bindgen not defaulting to --size_t-is-usize, which causes problems like the one I linked above (on very real/common platforms like win64).</p>



<a name="250679308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250679308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250679308">(Aug 25 2021 at 20:40)</a>:</h4>
<p>Bindgen may just not be useful in generating code targetting w65 and similar platforms with the distinction, I'd honestly be fine with that, as I do most of my C binding by hand anyways.</p>



<a name="250679628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250679628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250679628">(Aug 25 2021 at 20:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60/near/250678819">said</a>:</p>
<blockquote>
<p>For example, it motivates bindgen not defaulting to --size_t-is-usize, which causes problems like the one I linked above (on very real/common platforms like win64).</p>
</blockquote>
<p>I think the bindings generated by bindgen are only valid for the particular platform. Bindings generated for Linux won't work for Windows, and <code>size_t</code> isn't the only problem here.</p>



<a name="250679854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250679854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250679854">(Aug 25 2021 at 20:45)</a>:</h4>
<p>I agree, but build-time bindgen is particularly painful on windows, and that's why very few people do it. Also, bindgen being a CLI application somewhat disagrees with you.</p>
<p>Not to mention, there are other non-bindgen problems here, for sure. It's just an example.</p>



<a name="250723381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250723381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250723381">(Aug 26 2021 at 05:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60/near/250678819">said</a>:</p>
<blockquote>
<p>For example, it motivates bindgen not defaulting to --size_t-is-usize, which causes problems like the one I linked above (on very real/common platforms like win64).</p>
</blockquote>
<p>I think it'd be perfectly reasonable for bindgen to default to supporting <code>usize</code>, and then people on unusual platforms can pass a non-default option to generate bindings.</p>



<a name="250752533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250752533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250752533">(Aug 26 2021 at 10:39)</a>:</h4>
<p>As people already stated, <code>usize</code> and <code>size_t</code> are not the same everywhere, <br>
See also: <a href="https://github.com/rust-lang/rust-bindgen/issues/1671">https://github.com/rust-lang/rust-bindgen/issues/1671</a> for relevant discussion</p>



<a name="250787153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250787153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250787153">(Aug 26 2021 at 15:05)</a>:</h4>
<p>Yes, I'm aware. I linked that discussion in <a href="https://github.com/rust-lang/rust/issues/88345">https://github.com/rust-lang/rust/issues/88345</a>, which is probably relevant to anybody interested here.</p>



<a name="250981139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/250981139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#250981139">(Aug 27 2021 at 19:14)</a>:</h4>
<p>Sorry, missed that :)</p>



<a name="252033475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252033475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252033475">(Sep 04 2021 at 23:21)</a>:</h4>
<p>AFAIK CHERI (a very new, unusual, but also interesting architecture) has uintptr_t != size_t</p>



<a name="252033531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252033531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252033531">(Sep 04 2021 at 23:22)</a>:</h4>
<p>Yes, from our lab</p>



<a name="252033543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252033543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252033543">(Sep 04 2021 at 23:23)</a>:</h4>
<p>ah nice :)</p>



<a name="252033562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252033562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252033562">(Sep 04 2021 at 23:23)</a>:</h4>
<p>It has wider uintptr_t because the pointers also have all bound information encoded</p>



<a name="252033690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252033690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252033690">(Sep 04 2021 at 23:25)</a>:</h4>
<p>I am not personally involved with CHERI, so I could be wrong, but IIRC pointer arithmetic is complex with CHERI</p>



<a name="252033765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252033765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252033765">(Sep 04 2021 at 23:26)</a>:</h4>
<p>If you cast pointer to integer and do some arithmetic, you might not be able to cast it back while retaining all the permission</p>



<a name="252451202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252451202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252451202">(Sep 08 2021 at 12:32)</a>:</h4>
<p>Hence, in CHERI C/C++, <code>uintptr_t</code> and <code>size_t</code> are very different types. The former holds a full capability and can do normal pointer arithmetic (more-or-less), preserving capability provenance, whilst <code>size_t</code> is just a 64-bit integer, and suffers from the problem you describe. A problem for CHERI in Rust is that we have only <code>usize</code>, but no <code>uptr</code> or similar.<br>
There's an <a href="#narrow/stream/242906-t-compiler.2Farm/topic/CHERI.2FMorello.20capability.20support">old thread</a> on CHERI in particular. Notably: <a href="https://github.com/rust-lang/rust/issues/65473">https://github.com/rust-lang/rust/issues/65473</a><br>
I'm not aware of any fundamental changes in any of the topics discussed there, but it's quite possible that I've missed something. I'm hoping to do some work in the area but I'm not sure exactly what, or when, or with whom!</p>



<a name="252459888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/252459888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#252459888">(Sep 08 2021 at 13:34)</a>:</h4>
<p>I'd be willing to help with that, depending on what it entails. Resolving this is basically a prerequesite to supporting w65 in rust.</p>



<a name="253623632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/253623632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#253623632">(Sep 16 2021 at 18:01)</a>:</h4>
<p>Would saying this is not the required to be the case require an RFC? Or would it just be a T-lang MCP? I would typically assume not since it's really just affirming what is already the case, but given that some stuff does rely on it, perhaps a full RFC may be warranted.</p>



<a name="253625615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/253625615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#253625615">(Sep 16 2021 at 18:13)</a>:</h4>
<p>There should be an RFC about any change here because 99% of the rust world doesn't follow lang MCP stuff.</p>



<a name="253653454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/253653454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#253653454">(Sep 16 2021 at 21:23)</a>:</h4>
<p>One reason I could think of that it wouldn't be is because we aren't really changing anything, it's just a clarification, since  this is (presumably) already the case. The second point is fair, though.</p>



<a name="254304510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/254304510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#254304510">(Sep 22 2021 at 01:59)</a>:</h4>
<p>I'm going to write up a Pre-RFC on IRLO soon-ish. <br>
To be honest, I'm not even sure how this would be structured, since typically RFCs define something, and the thing we are defining is that something isn't necessarily guaranteed.</p>



<a name="254461034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/%60usize%60%20vs%20%60size_t%60/near/254461034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/.60usize.60.20vs.20.60size_t.60.html#254461034">(Sep 23 2021 at 00:26)</a>:</h4>
<p>Posted: <a href="https://internals.rust-lang.org/t/pre-rfc-usize-is-not-size-t/15369">https://internals.rust-lang.org/t/pre-rfc-usize-is-not-size-t/15369</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>