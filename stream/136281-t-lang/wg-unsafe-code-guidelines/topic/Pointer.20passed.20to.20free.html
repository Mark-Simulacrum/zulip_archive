<html>
<head><meta charset="utf-8"><title>Pointer passed to free · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html">Pointer passed to free</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278453599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278453599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278453599">(Apr 10 2022 at 07:28)</a>:</h4>
<p>When freeing an allocation, does the pointer have to be a copy of the original pointer, or is passing a raw pointer you got from an <code>&amp;</code> to the allocation ok? What about an <code>&amp;mut</code>? I have always followed the rule that you should free the original pointer, but miri doesn't seem to care:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">b</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">r</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">drop</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278453666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278453666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278453666">(Apr 10 2022 at 07:30)</a>:</h4>
<p>Ah, right. The playground doesn't use the stricter flags. Miri does complain when using stricter options.</p>



<a name="278453890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278453890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278453890">(Apr 10 2022 at 07:36)</a>:</h4>
<p>Still, if the pointer is derived from a mutable reference, then that's still fine.</p>



<a name="278472105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278472105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278472105">(Apr 10 2022 at 14:48)</a>:</h4>
<p>Stacked Borrows says any pointer that can mutate the memory, can also deallocate it</p>



<a name="278472112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278472112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278472112">(Apr 10 2022 at 14:48)</a>:</h4>
<p>also there can't be any active "protected" items anywhere on the stack</p>



<a name="278472237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278472237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278472237">(Apr 10 2022 at 14:52)</a>:</h4>
<p>but this is tied up with quite a few other discussions... like <a href="https://github.com/rust-lang/miri/issues/1909">https://github.com/rust-lang/miri/issues/1909</a> and <a href="https://github.com/rust-lang/rust/issues/55005">https://github.com/rust-lang/rust/issues/55005</a></p>



<a name="278481924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278481924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278481924">(Apr 10 2022 at 18:10)</a>:</h4>
<p>I <em>think</em> <span class="user-mention" data-user-id="218683">@Alice Ryhl</span> you're asking about this because of <a href="https://github.com/tokio-rs/tokio/pull/4608">https://github.com/tokio-rs/tokio/pull/4608</a> right? I'm just trying to make sure I'm following everything.</p>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> you said this in the (lengthy) discussion about Arc above. tokio-utils is doing basically the same thing as far as I can tell:</p>
<blockquote>
<p>References generally only have to be "valid when used" -- though "used" is interpreted very coarsely and includes reborrows and (typed) copies, not just dereferences. The only exception are references passed as function arguments.</p>
</blockquote>
<p>Alice has now pointed out <em>two</em> cases that I missed in my PR where a <code>&amp;mut</code> is passed to a function which accepts <code>*mut</code> and which may deallocate the pointer. My (I now think incorrect) expectation was that Miri should have generated a protector error on the call which freed it. So from my reading of the issue about <code>Arc</code> it sounds like this code pattern is not invalid according to Stacked Borrows, but it's in some unknown territory where we're not sure if it's UB or not because the reference is dangling, but it's not used. Is that right?</p>



<a name="278488690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278488690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278488690">(Apr 10 2022 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span>  if the function has argument type <code>*mut</code> then it doesn't generate protectors</p>



<a name="278488702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278488702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278488702">(Apr 10 2022 at 20:43)</a>:</h4>
<p>the issue with deallocation is with functions that take references, and those references are deallocated (or otherwise invalidated) while the function runs</p>



<a name="278488854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278488854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278488854">(Apr 10 2022 at 20:46)</a>:</h4>
<p>But if the function converts a *mut somewhere into a &amp;mut then passes the &amp;mut to a function accepting a *mut which deallocates, is there any problem with the now-dangling reference? That is, the reference dangling but unused after the deallocating function returns.</p>



<a name="278488915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278488915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278488915">(Apr 10 2022 at 20:48)</a>:</h4>
<p>It feels like the reference definitely dangles but if nobody uses it, this feels like it's in some murky area between safety and validity invariants</p>



<a name="278489206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278489206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278489206">(Apr 10 2022 at 20:54)</a>:</h4>
<p>whether a protector is created depends on the declared type of the function</p>



<a name="278489214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278489214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278489214">(Apr 10 2022 at 20:54)</a>:</h4>
<p>how you compute the argument is irrelevant</p>



<a name="278489231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278489231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278489231">(Apr 10 2022 at 20:55)</a>:</h4>
<blockquote>
<p>That is, the reference dangling but unused after the deallocating function returns.</p>
</blockquote>
<p>Isn't that possible in safe code?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">xref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="c1">// now xref dangles, but is not used any more. this is fine.</span>
</code></pre></div>



<a name="278490886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278490886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278490886">(Apr 10 2022 at 21:31)</a>:</h4>
<p>Ah, of course. Thanks for the explanation.</p>



<a name="278491104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20passed%20to%20free/near/278491104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20passed.20to.20free.html#278491104">(Apr 10 2022 at 21:37)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> It was your PR that prompted me to open this thread, yes, but it is a question I have pondered for a long time before that.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>