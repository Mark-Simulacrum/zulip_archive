<html>
<head><meta charset="utf-8"><title>Create pointer to fixed-address memory region (MMIO, ...) · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html">Create pointer to fixed-address memory region (MMIO, ...)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278355752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278355752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278355752">(Apr 08 2022 at 20:06)</a>:</h4>
<p><span class="user-mention" data-user-id="491181">@Zoey</span> indeed as <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> says, this is an operation that existed in an earlier draft of strict provenance but got cut to be able to get things landed quicker. most people involved are not embedded system experts. also there was the question of whether the operation should take a ptr+size for its new "fake" allocation, or just a ptr. (the latter would probably be required for CHERI, OTOH this is for low-level code that probably has no intention of being very portable anyway.)</p>



<a name="278355885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278355885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278355885">(Apr 08 2022 at 20:07)</a>:</h4>
<p>See <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Forging.20*mut.20w.2Fo.20usize.20as.20*mut.20T</a> for prior discussion</p>



<a name="278358737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278358737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278358737">(Apr 08 2022 at 20:33)</a>:</h4>
<p>I think that we should include the length in <code>fake_alloc</code> because it is better for static/dynamic analysis, although we could also just use the size of the pointer type for this (and use <code>*const [u8]</code> for dynamic length allocations)</p>



<a name="278358817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278358817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278358817">(Apr 08 2022 at 20:34)</a>:</h4>
<p>I am less sure about whether we should allow multiple overlapping <code>fake_alloc</code>s</p>



<a name="278359428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278359428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278359428">(Apr 08 2022 at 20:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20.28MMIO.2C.20.2E.2E.2E.29/near/278358817">said</a>:</p>
<blockquote>
<p>I am less sure about whether we should allow multiple overlapping <code>fake_alloc</code>s</p>
</blockquote>
<p>overlapping with each other? hm then we couldnt annotate it <code>noalias</code> like <code>malloc</code> is annotated. but from a model perspective we could say there is a single FAKE_PROVENANCE used by all of them so as long as it doesnt overlap anything else that would still be fine.</p>



<a name="278359629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278359629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278359629">(Apr 08 2022 at 20:42)</a>:</h4>
<p>hm, those both sound like reasonable models with their own use cases</p>



<a name="278359727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278359727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278359727">(Apr 08 2022 at 20:43)</a>:</h4>
<p>like you could either consider different <code>fake_alloc</code>s as different allocations with known bounds and fresh allocation IDs, or as all coming from a single allocation called FAKE_PROVENANCE that rust doesn't know the full extent of</p>



<a name="278363125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363125">(Apr 08 2022 at 21:14)</a>:</h4>
<p>In terms of "do we take a size or not", the answer i would propose is that we have both versions supported in the public API. The version with an address+size is the "real" way to do it, and then we also have a version that just lets you pass in only an address and it will just assume a size of one element and forward the call.</p>
<p>It's certainly <em>correct</em> to track memory spans on mmio addresses, but a majority of the time an mmio "object" is a single int big, and then the next int in memory is "some other object" that is considered separately. For the common case of 1-element ranges we should provide library helpers.</p>



<a name="278363325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363325">(Apr 08 2022 at 21:16)</a>:</h4>
<p>As to <code>noalias</code>, doesn't that mean that outside forces aren't ever manipulating the value? In the general case that would be a very incorrect assumption.</p>



<a name="278363531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363531">(Apr 08 2022 at 21:18)</a>:</h4>
<p>Yeah, I think the easy way should ideally return references to some <code>VolatileUnsafeCell</code> or a raw pointer, and make it as little of a footgun as possible.</p>



<a name="278363656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363656">(Apr 08 2022 at 21:19)</a>:</h4>
<p>Oh no, I've spent over a year telling people to stop using the <code>&amp;VolatileCell</code> model in their code XD</p>



<a name="278363827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363827">(Apr 08 2022 at 21:20)</a>:</h4>
<p>Well, an actual <code>VolatileCell</code> that doestherightthingTM, not one that pretends to :P</p>



<a name="278363875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363875">(Apr 08 2022 at 21:21)</a>:</h4>
<p>Also a raw pointer isn't great because then you get unsafe all over the program</p>



<a name="278363884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278363884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278363884">(Apr 08 2022 at 21:21)</a>:</h4>
<p>we want unsafe creation and then safe use thereafter</p>



<a name="278364261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278364261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278364261">(Apr 08 2022 at 21:24)</a>:</h4>
<p>Someday I'll get around to working on some Deref traits that work well with raw pointers and unsafe code...</p>



<a name="278364511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278364511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278364511">(Apr 08 2022 at 21:27)</a>:</h4>
<p>I don't know that such a thing is necessary. There's already the amazing and fantastic technicolor wonder of a crate that's <code>voladdress</code> (and please don't check who wrote it, no no).</p>
<p>But more seriously, I think that if the "make pointers not so terrible" plans from granka get added, specifically the ones for syntax for accessing fields of pointed-to values, then that same syntax should be made to work with volatile address values.</p>



<a name="278380864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278380864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278380864">(Apr 09 2022 at 01:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20.28MMIO.2C.20.2E.2E.2E.29/near/278363656">said</a>:</p>
<blockquote>
<p>Oh no, I've spent over a year telling people to stop using the <code>&amp;VolatileCell</code> model in their code XD</p>
</blockquote>
<p>I would like to have one that works, though. It makes doing things with magic symbols easier.</p>



<a name="278410106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create%20pointer%20to%20fixed-address%20memory%20region%20%28MMIO%2C%20...%29/near/278410106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Create.20pointer.20to.20fixed-address.20memory.20region.20(MMIO.2C.20.2E.2E.2E).html#278410106">(Apr 09 2022 at 13:25)</a>:</h4>
<p>I know that it would make accessing a field offset from a base address easier. Is there anything else?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>