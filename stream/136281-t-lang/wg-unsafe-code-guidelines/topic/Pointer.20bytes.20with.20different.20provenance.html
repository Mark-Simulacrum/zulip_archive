<html>
<head><meta charset="utf-8"><title>Pointer bytes with different provenance · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html">Pointer bytes with different provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277929107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277929107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277929107">(Apr 05 2022 at 19:05)</a>:</h4>
<p>So, I don't know what is currently implemented (am about to go check), but wanted to ask about people's intuition anyway. Imagine that we write a bunch of pointer bytes to memory, and the provenance of those bytes is different (ie they have different SB tags). What are people's intuition for what should happen when the pointer is loaded? It gets the provenance of the lowest byte? The highest byte? UB if the bytes don't all agree? <code>invalid_ptr()</code> if they don't all agree?</p>
<p>Relatedly, are there any issues in terms of optimizations or the memory model with any of these choices? I can't think of any</p>



<a name="277929684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277929684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277929684">(Apr 05 2022 at 19:09)</a>:</h4>
<p>My intuition is that if the bytes don't all have the same provenance, that makes the provenance invalid, similar to how a whole <code>usize</code> is considered uninitialized if any of the bytes are uninitialized.</p>



<a name="277929725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277929725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277929725">(Apr 05 2022 at 19:10)</a>:</h4>
<p>That is also mine</p>



<a name="277930882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277930882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277930882">(Apr 05 2022 at 19:19)</a>:</h4>
<p>In the XOR list discussion, Ralf mentioned that we could have a function that maps the provenance onto all 8 bytes individually. I suppose we could also specify that this is already the case - all 8 bytes of a pointer carry the full provenance of that pointer. That would in particular imply that this is defined:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">42_</span><span class="k">u32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span>: <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span><span class="p">(</span><span class="n">MaybeUninit</span>::<span class="n">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span><span class="w"></span>
<span class="n">bytes</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// or   bytes = [bytes[0]; 8];</span>
<span class="kd">let</span><span class="w"> </span><span class="n">mangled_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">MaybeUninit</span><span class="o">&lt;*</span><span class="k">const</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">bytes</span><span class="p">).</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mangled_ptr</span><span class="p">.</span><span class="n">with_addr</span><span class="p">(</span><span class="n">ptr</span><span class="p">.</span><span class="n">addr</span><span class="p">()));</span><span class="w"></span>
</code></pre></div>



<a name="277931665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277931665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277931665">(Apr 05 2022 at 19:25)</a>:</h4>
<p>Indeed</p>



<a name="277931676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277931676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277931676">(Apr 05 2022 at 19:25)</a>:</h4>
<p>The implementation of this in CTFE right now is... weird</p>



<a name="277932103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277932103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277932103">(Apr 05 2022 at 19:29)</a>:</h4>
<p>it certainly seems easier to specify provenance this way than to have to talk about bytes being "4th from the left of a pointer value" like in <a href="https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html">https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html</a></p>



<a name="277932106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277932106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277932106">(Apr 05 2022 at 19:29)</a>:</h4>
<p>CTFE has a variety of restrictions around pointers right now.  One that jumps to mind (<a href="https://github.com/rust-lang/rust/issues/94371#issue-1150822966">https://github.com/rust-lang/rust/issues/94371#issue-1150822966</a>) is that chunked copying of unaligned-because-packed pointers doesn't work even in cases where it tends to for aligned pointers.  But that's tends not to be an issue in practice because <code>repr(packed)</code> pointers are so rare.</p>



<a name="277932756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277932756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277932756">(Apr 05 2022 at 19:35)</a>:</h4>
<p>Yeah, I'm seeing that right now. I have some ideas for how to approach some of these, but definitely off topic here and I also don't have the time to work on this probably</p>



<a name="277932865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277932865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277932865">(Apr 05 2022 at 19:36)</a>:</h4>
<p>For the purpose of this conversation, the tldr is that CTFE will probably have to change around this anyway, and so we can ignore it for now (as long as whatever we choose remains implementable)</p>



<a name="277959672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277959672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277959672">(Apr 05 2022 at 23:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance/near/277930882">said</a>:</p>
<blockquote>
<p>In the XOR list discussion, Ralf mentioned that we could have a function that maps the provenance onto all 8 bytes individually. I suppose we could also specify that this is already the case - all 8 bytes of a pointer carry the full provenance of that pointer. That would in particular imply that this is defined:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">42_</span><span class="k">u32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span>: <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span><span class="p">(</span><span class="n">MaybeUninit</span>::<span class="n">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span><span class="w"></span>
<span class="n">bytes</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// or   bytes = [bytes[0]; 8];</span>
<span class="kd">let</span><span class="w"> </span><span class="n">mangled_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">MaybeUninit</span><span class="o">&lt;*</span><span class="k">const</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">bytes</span><span class="p">).</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mangled_ptr</span><span class="p">.</span><span class="n">with_addr</span><span class="p">(</span><span class="n">ptr</span><span class="p">.</span><span class="n">addr</span><span class="p">()));</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>note that I did <em>not</em> say that you can have such a multi-provenance value <em>at pointer type</em></p>



<a name="277959722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277959722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277959722">(Apr 05 2022 at 23:57)</a>:</h4>
<p>I could totally imagine saying that the validity invariant of pointer values says they must be initialized (that much is hopefully uncontroversial if integers have to be initialized) <em>and furthermore all their bytes must have the same provenance</em></p>



<a name="277959854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277959854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277959854">(Apr 05 2022 at 23:58)</a>:</h4>
<p>that would make your code UB at the <code>assume_init</code></p>



<a name="277959936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277959936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277959936">(Apr 05 2022 at 23:59)</a>:</h4>
<p>I don't think that would mean this is UB. All the bytes still have the right provenance, they just got shuffled around a little</p>



<a name="277960048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960048">(Apr 06 2022 at 00:00)</a>:</h4>
<p>oh, right. so yeah that's fine then.</p>



<a name="277960062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960062">(Apr 06 2022 at 00:00)</a>:</h4>
<p>but what I said should answer your original question :)</p>



<a name="277960083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960083">(Apr 06 2022 at 00:01)</a>:</h4>
<p>using this validity invariant would surely help CTFE/Miri to accurately implement the semantics. :D like, <a href="https://github.com/rust-lang/rust/issues/87184">https://github.com/rust-lang/rust/issues/87184</a> still needs to be resolved, but at least I have in my head a very clear idea for how to do that.<br>
supporting multi-provenance values at pointer type, OTOH, would require a whole different set of extra changes, and I dont even have a good idea for how to do that in the current architecture...</p>



<a name="277960172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960172">(Apr 06 2022 at 00:02)</a>:</h4>
<p>so, this should be UB I think</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">42_</span><span class="k">u32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span>: <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span><span class="p">(</span><span class="n">MaybeUninit</span>::<span class="n">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span><span class="w"></span>
<span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">mangled_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">MaybeUninit</span><span class="o">&lt;*</span><span class="k">const</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">bytes</span><span class="p">).</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>because one of the bytes has a different provenance (in this case, no provenance).</p>



<a name="277960202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960202">(Apr 06 2022 at 00:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance/near/277932103">said</a>:</p>
<blockquote>
<p>it certainly seems easier to specify provenance this way than to have to talk about bytes being "4th from the left of a pointer value" like in <a href="https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html">https://www.ralfj.de/blog/2018/07/24/pointers-and-bytes.html</a></p>
</blockquote>
<p>yeah... I wanted to make <code>Pointer</code> as opaque at possible, but it might be better to just make <code>Provenance</code> opaque and keep <code>Pointer</code> as <code>(Address, Provenance)</code>.</p>



<a name="277960359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960359">(Apr 06 2022 at 00:05)</a>:</h4>
<p>the amusing thing about that specific example is that that is pretty much exactly one of the reference examples that the C WG wants to allow for some reason, because I guess some old code did their bit packing specifically on individual bytes?</p>



<a name="277960459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960459">(Apr 06 2022 at 00:07)</a>:</h4>
<p>What is the motivation for making this UB instead of just yielding a pointer with null provenance?</p>



<a name="277960555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960555">(Apr 06 2022 at 00:09)</a>:</h4>
<p><span class="user-mention" data-user-id="143798">@Talchas</span> am I ever glad I don't have their job</p>



<a name="277960785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960785">(Apr 06 2022 at 00:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance/near/277960459">said</a>:</p>
<blockquote>
<p>What is the motivation for making this UB instead of just yielding a pointer with null provenance?</p>
</blockquote>
<p>funny I would have expected it should yield a pointer with the provenance of the other bytes ;)</p>



<a name="277960804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960804">(Apr 06 2022 at 00:13)</a>:</h4>
<p>like, "if some subset of bytes have a given provenance and the rest has none, use that provenance"</p>



<a name="277960896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960896">(Apr 06 2022 at 00:14)</a>:</h4>
<p>that would be... still implementable fairly easily with the current general Miri/CTFE architecture but (like other proposals you made before that I disliked for similar reasons) violates the property that byte-value-byte roundtrips are a 'widening', i.e., can always return the original value (a "Galois connection" if you want to use fancy terms ;)</p>



<a name="277960924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277960924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277960924">(Apr 06 2022 at 00:14)</a>:</h4>
<p>so, again one has to be very careful when justifying a removal of <code>x=x;</code></p>



<a name="277961131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277961131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277961131">(Apr 06 2022 at 00:18)</a>:</h4>
<p>Yeah, I see that</p>



<a name="277980871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277980871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sewell <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277980871">(Apr 06 2022 at 06:39)</a>:</h4>
<p>"In PNVI*, when constructing a pointer value, if the third components of the bytes all carry the appropriate index,<br>
and all have the same provenance (which will be guaranteed if pointer types all have the same size), the provenance<br>
of the result is that provenance. Otherwise, [it does basically the same as an integer-to-pointer cast]".  p35 of <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2577.pdf">N2577</a></p>



<a name="277984585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/277984585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#277984585">(Apr 06 2022 at 07:27)</a>:</h4>
<p>FWIW on CHERI these are totally busted. Any time you write to any of a pointer’s bytes, any time you store it in unaligned memory, it becomes invalid / useless for provenance</p>



<a name="278020186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/278020186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#278020186">(Apr 06 2022 at 13:05)</a>:</h4>
<p>oh hi <span class="user-mention" data-user-id="490957">@Peter Sewell</span> :)</p>



<a name="278020292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/278020292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#278020292">(Apr 06 2022 at 13:06)</a>:</h4>
<p>integer-to-pointer casts are impure in general (they generate a freshly guessed provenance) so I dont think we want that to ever happen "implicitly" as part of e.g. a pointer-typed load</p>



<a name="278027285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/278027285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sewell <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#278027285">(Apr 06 2022 at 13:59)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="120791">@RalfJ</span>  :)   I was just clarifying what PNVI-* does there, which we chose to get bytewise user memcpy and some horrible futzing-with-unused-bytes C idioms to work; you might very well want something much tighter.</p>



<a name="278027668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/278027668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sewell <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#278027668">(Apr 06 2022 at 14:01)</a>:</h4>
<p>(I'm just dipping into these infinite conversations)</p>



<a name="278031208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/278031208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#278031208">(Apr 06 2022 at 14:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="490957">Peter Sewell</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance/near/278027668">said</a>:</p>
<blockquote>
<p>(I'm just dipping into these infinite conversations)</p>
</blockquote>
<p>let me know if you want a summary of my take on it ;) might be easier in a synchronous call though</p>



<a name="278033789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer%20bytes%20with%20different%20provenance/near/278033789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sewell <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Pointer.20bytes.20with.20different.20provenance.html#278033789">(Apr 06 2022 at 14:43)</a>:</h4>
<p>probably it'd be good to have a translator :-)   maybe best let this settle first, though - I've no spare cycles for the next few days</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>