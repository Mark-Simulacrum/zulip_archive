<html>
<head><meta charset="utf-8"><title>Bikeshedding time: &amp;mut Vec&lt;u8&gt;/String for partial writes · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html">Bikeshedding time: &amp;mut Vec&lt;u8&gt;/String for partial writes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276878606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding%20time%3A%20%26mut%20Vec%3Cu8%3E/String%20for%20partial%20writes/near/276878606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html#276878606">(Mar 28 2022 at 14:10)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write_escaped</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">TryReserveError</span><span class="o">&gt;</span><span class="w"></span>
<span class="c1">//or</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write_escaped</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">TryReserveError</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>If TryReserveError is returned, dst could be invalid utf8 because it might end in a multi byte char that got truncated. Alternatively the public api could be a wrapper function with a cold error path that decreases dst len back to valid utf8 with floor_char_boundary.</p>



<a name="276878907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding%20time%3A%20%26mut%20Vec%3Cu8%3E/String%20for%20partial%20writes/near/276878907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html#276878907">(Mar 28 2022 at 14:13)</a>:</h4>
<p>If the allocation reservation fails why does the Vec or String change at all? Shouldn't that happen once before any bytes are written, and then if it works you'd know all bytes can be written?</p>



<a name="276880333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding%20time%3A%20%26mut%20Vec%3Cu8%3E/String%20for%20partial%20writes/near/276880333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html#276880333">(Mar 28 2022 at 14:23)</a>:</h4>
<p>Not all characters are escaped. I could always allocate <code>src.len() * longest_escape_sequence.len()</code> but that would be wasteful. Point of write_escaped is to read src only once so dst len is unknown. (I use escape() that returns a COW for values written multiple times)</p>



<a name="276884101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding%20time%3A%20%26mut%20Vec%3Cu8%3E/String%20for%20partial%20writes/near/276884101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html#276884101">(Mar 28 2022 at 14:48)</a>:</h4>
<p>Another option is to reduce the length of <code>dst</code> back down to its original length on allocation failure. Then it is unchanged, except for the potentially increased capacity.</p>



<a name="276884707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding%20time%3A%20%26mut%20Vec%3Cu8%3E/String%20for%20partial%20writes/near/276884707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html#276884707">(Mar 28 2022 at 14:52)</a>:</h4>
<p>Yeah that seems like the right approach. Also be Very Careful to avoid panics, or set up a panic guard that does the same thing.</p>



<a name="276888075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding%20time%3A%20%26mut%20Vec%3Cu8%3E/String%20for%20partial%20writes/near/276888075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Bikeshedding.20time.3A.20.26mut.20Vec.3Cu8.3E.2FString.20for.20partial.20writes.html#276888075">(Mar 28 2022 at 15:11)</a>:</h4>
<p>or just don't even change the len until the end, after you've done all writing successfully</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>