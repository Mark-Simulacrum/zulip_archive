<html>
<head><meta charset="utf-8"><title>ptr-&gt;int-&gt;ptr as side effect destroys modular reasoning · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html">ptr-&gt;int-&gt;ptr as side effect destroys modular reasoning</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274318796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274318796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274318796">(Mar 06 2022 at 17:45)</a>:</h4>
<p>That's all I've got, really.</p>
<p>If the full ptr-&gt;int-&gt;ptr cycle is allowed as a side effect on any pointer and any integer... I'm ignoring the discussion of constants, here... then any <code>fn(ptr, int) -&gt; ptr</code> no longer preserves any benefits of modular reasoning. The pointer may now be fully based on the integer, and we are being asked to somehow derive the provenance from a previous program state involving a stack. And we must now inspect the contents of every function we call in order to see whether it is affecting the global pointer state. It doesn't matter if you can salvage it with "broadcasting" or whatever other model.</p>
<p>I assert this will make it functionally almost impossible to write <code>unsafe</code> code that exploits this correctly, while also making any model that tries to incorporate such an insanely complex design take at least twice as much time to get off the ground and also prove itself as sound... if it succeeds at all. By comparison, banning the cycle makes Rust optimization models almost trivial to implement. If you think that it will still take an enormous amount of work... you're right!</p>



<a name="274319411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274319411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274319411">(Mar 06 2022 at 18:00)</a>:</h4>
<p>Suppose, for the sake of argument, ptr-&gt;int-&gt;ptr casts are allowed but only with arcane safety invariants tailored for miri / an executable AM, that no user can reasonably keep track of. What are the benefits and drawbacks compared to banning ptr-&gt;int-&gt;ptr entirely? As I see it:</p>
<ol>
<li>Drawback: the model is more complex. It is unclear how much to weight this factor; all things being equal simpler is better, but all other things are not equal here.</li>
<li>Users can't use ptr-&gt;int-&gt;ptr sensibly: not a distinguishing factor, since you can't use them in either case. Having them available but difficult to use means that it is at least possible to put in the legwork if you need to.</li>
<li>Formal models are impacted: I'm not really convinced by this. If you are verifying specific code, you always have the option to avoid it if there are alternatives, just the same as in (2). In particular, re: "prove itself as sound", I don't see how this is an issue if the safety invariant is sufficiently generous to provide all the needed hypotheses. It might be a hideous nonlocal condition but there is always a weakest precondition for correctness that we can use, for which correctness is trivially satisfied by construction.</li>
</ol>
<p>I am exaggerating the complexity of the safety invariant here, but even in the worst case it doesn't seem like a huge problem. Certainly there are libraries with these kinds of nonlocal safety invariants, like <code>memmap</code>.</p>



<a name="274319582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274319582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274319582">(Mar 06 2022 at 18:01)</a>:</h4>
<p>Regarding modular reasoning: yes, it is completely non-modular and should be avoided whenever possible. Unfortunately Rust programmers today are not given the tools to do this in most cases, so I think we should first try to work on that aspect before legislating them away. Concrete things we can do to make int-&gt;ptr a less attractive option:</p>
<ul>
<li>Put <code>int_to_ptr_with_provenance</code> and <code>ptr::map</code> in std</li>
<li>Add atomic algebraic operations on <code>AtomicPtr</code></li>
<li>Add a function for creating pointers to memory which <em>cannot</em> be used for rust memory</li>
<li>Separate the "broadcast" and "non-broadcast" variants of ptr-&gt;int (unsure which one can become <code>as</code>)</li>
</ul>



<a name="274320227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274320227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274320227">(Mar 06 2022 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/274319411">said</a>:</p>
<blockquote>
<p>Suppose, for the sake of argument, ptr-&gt;int-&gt;ptr casts are allowed but only with arcane safety invariants tailored for miri / an executable AM, that no user can reasonably keep track of. What are the benefits and drawbacks compared to banning ptr-&gt;int-&gt;ptr entirely? As I see it:</p>
<ol start="2">
<li>Users can't use ptr-&gt;int-&gt;ptr sensibly: not a distinguishing factor, since you can't use them in either case. Having them available but difficult to use means that it is at least possible to put in the legwork if you need to.</li>
</ol>
</blockquote>
<p>(Also in reply <span class="user-mention silent" data-user-id="120791">RalfJ</span> in the old thread)</p>
<p>The thing is, AIUI union provenance is <em>not</em> this. It is ridiculous if you care about all the possible provenances a given inttoptr-produced pointer might have, but a user never cares about <em>all</em> of them. A user wants precisely <em>one</em> of those many provenances, and so long as that one is always part of the union (via the straightforward rule "the provenance of any escaped raw pointer which is a) still valid by SB and b) covers/one-past-the-end this memory address" or similar) , all the other provenances are irrelevant and are just optimization loss.</p>
<p>Implementing miri or other checkers via this model may be too impractical because they don't know which provenance the user wants, but a user only has to verify the SB raw pointer rules for the one escaped raw pointer that they care about.</p>



<a name="274320322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274320322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274320322">(Mar 06 2022 at 18:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/274318796">said</a>:</p>
<blockquote>
<p>I'm ignoring the discussion of constants, here... then any <code>fn(ptr, int) -&gt; ptr</code> no longer preserves any benefits of modular reasoning.</p>
</blockquote>
<p>But mutable globals exist, so this is already true. What's the difference between the body being <code>int_x as *const X</code> and <code>global[int_x]</code>?</p>



<a name="274320477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274320477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274320477">(Mar 06 2022 at 18:22)</a>:</h4>
<p>You know that <code>global</code> doesn't alias <code>ptr</code> if <code>ptr</code> is derived from the stack. You don't know that <code>int_x as *const X</code> doesn't alias <code>ptr</code> even if <code>ptr</code> is derived from the stack unless there exists a broadcasting operation.</p>



<a name="274321077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274321077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274321077">(Mar 06 2022 at 18:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/274319582">said</a>:</p>
<blockquote>
<p>Regarding modular reasoning: yes, it is completely non-modular and should be avoided whenever possible. Unfortunately Rust programmers today are not given the tools to do this in most cases, so I think we should first try to work on that aspect before legislating them away. Concrete things we can do to make int-&gt;ptr a less attractive option:</p>
<ul>
<li>Put <code>int_to_ptr_with_provenance</code> and <code>ptr::map</code> in std</li>
<li>Add atomic algebraic operations on <code>AtomicPtr</code></li>
<li>Add a function for creating pointers to memory which <em>cannot</em> be used for rust memory</li>
<li>Separate the "broadcast" and "non-broadcast" variants of ptr-&gt;int (unsure which one can become <code>as</code>)</li>
</ul>
</blockquote>
<p>Yes, I should note that even if we do wind up with whatever is approximately equal to "retire ptr-&gt;int-&gt;ptr entirely" it would be the absolute last step after we draft up other replacements for things. I mostly am making my case now because I have already seen that <strong>many</strong> people will speak out against even adding tools that make it easier to write <code>unsafe</code> code in a modular way if they see it as being done in furtherance of a model they dislike.</p>



<a name="274321234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274321234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274321234">(Mar 06 2022 at 18:38)</a>:</h4>
<p>I believe that <code>global[i]</code> can alias <code>ptr</code> in exactly the same sorts of situations it can for an int cast? <code>global[i]</code> requires a previous store, and <code>i as *const X</code> requires a previous <code>as usize</code>? (Unless you mean "<code>as usize</code> is a side effect" as "exists a broadcasting operation", in which case yes I agree) (there's also the full PVI option and just leave it up to the compiler implementation when to give up, but that's also "fun")</p>



<a name="274321316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274321316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274321316">(Mar 06 2022 at 18:40)</a>:</h4>
<blockquote>
<p>Unless you mean "as usize is a side effect" as "exists a broadcasting operation"</p>
</blockquote>
<p>Yes that.</p>



<a name="274324224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324224">(Mar 06 2022 at 19:40)</a>:</h4>
<p>In an ideal world, I would like to make <code>*const T as usize</code> a <em>non</em>-broadcasting operation, and instead there is a function (in the semantics and possibly also in real code) <code>fn broadcast(ptr: *const T) { /* side-effect */ }</code> such that any broadcasting ptr-&gt;int is desugared to <code>broadcast(ptr); ptr as usize</code>. Then the <code>as usize</code> can be optimized away if the result is unused as usual.</p>
<p>The <code>broadcast()</code> operation can be viewed as <code>BROADCASTED.push(ptr)</code> where <code>BROADCASTED</code> is a global array of all broadcasted pointers. (Doing this literally has <code>static mut</code> issues, which also relate to the complications of doing this concurrently...) Then int-&gt;ptr just searches this array for the best pointer which covers the target address. AFAICT there is no additional magic to the operation beyond this, so I agree that this is exactly as non-modular as other uses of global mutable state.</p>



<a name="274324312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324312">(Mar 06 2022 at 19:42)</a>:</h4>
<blockquote>
<p>Then int-&gt;ptr just searches this array for the best pointer which covers the target address.</p>
</blockquote>
<p>Selecting the best pointer is one of the problems. What is the <em>best</em> pointer when multiple pointers have the same address but different permissions and ranges?</p>



<a name="274324320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324320">(Mar 06 2022 at 19:42)</a>:</h4>
<p>Registers are different than stacks.<br>
A global mutable variable is not the same as a global mutable stack.</p>



<a name="274324406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324406">(Mar 06 2022 at 19:44)</a>:</h4>
<p>Frankly, most of this discussion has been repeated enough times it is extremely close to</p>
<blockquote>
<p>Please keep unstructured critique to a minimum. If you have solid ideas you want to experiment with, make a fork and see how it works.</p>
</blockquote>
<p>Nonetheless I am having it anyways because I believe, quite simply, that anyone who opens a PR to improve the situation risks having their PR bogged down by this argument anyways.</p>



<a name="274324554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324554">(Mar 06 2022 at 19:47)</a>:</h4>
<p>There isn't really a "best". So we pick something that looks best-ish and call it a day, and if the user didn't arrange for their pointer to be the best-ish then they will get some undesirable UB. And then maybe they will listen to Jubilee's advice and maybe stay away from ptr-&gt;int-&gt;ptr</p>



<a name="274324695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324695">(Mar 06 2022 at 19:50)</a>:</h4>
<p>One option that is slightly less evil to the user (but still kind of unhelpful) is to declare UB if there is no single best pointer</p>



<a name="274324708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274324708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274324708">(Mar 06 2022 at 19:50)</a>:</h4>
<p>that is at least a bit more principled and still executable</p>



<a name="274325382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274325382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274325382">(Mar 06 2022 at 20:03)</a>:</h4>
<p>That's still absolutely execrable and will be rightly treated by programmers as effectively no better than C, possibly less.</p>



<a name="274325528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274325528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274325528">(Mar 06 2022 at 20:06)</a>:</h4>
<p>Also I want to put forward that I am both pretty happy to work on implementing the model I proposed and likely will have a reasonable amount of time for it over the next year, even if it might not be my first priority. Nonetheless it matters to my existing work for hopefully somewhat obvious reasons, and I have managed to put time into that and also a bit of time into all the little side issues that touches.</p>
<p>That also is why I cannot pretend I am keen on semantics that resist parallelization for this.</p>



<a name="274325945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274325945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274325945">(Mar 06 2022 at 20:16)</a>:</h4>
<p>As someone's who read N2676 but still doesn't quite understand the model, what's the general overview of it and its differences from N2676? There have been quite a few different points and models/semantics raised that I'm not quite sure which one you proposed.</p>



<a name="274327542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274327542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274327542">(Mar 06 2022 at 20:55)</a>:</h4>
<p>Union provenance is roughly equivalent to PNVI-ae-udi, though there's likely to be more overlap available rather than merely one-past-the-end. I believe PNVI-ae makes inttoptr of one-past-the-end be UB, which is debatable in C, but doesn't save you in rust since there's more metadata in provenance than just the original allocation (and more use of ZSTs, though who knows about ZST-pointers-cast-to-int).</p>
<p>Picking a "best" pointer could be similar to PNVI-ae if the heuristic is good enough, but if it's not it could be nearly as bad as "remove inttoptr, but with more footguns". <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/273">UCG #273</a> has an example of where the heuristic chosen matters.</p>
<p>Removing inttoptr is equivalent to none of them, though combined with adding more math options to pointers/AtomicPtr you can keep all the more obvious align+bitset stuff. (And since ptrtoint isn't a side effect, <code>from_usize(provenance: *const T, address: usize) -&gt; *const T</code> can be a library function that could optimized well for wrappers that do <code>from_usize(ptr, ptr as usize | 1)</code> and such)</p>



<a name="274328314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274328314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274328314">(Mar 06 2022 at 21:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/274325528">said</a>:</p>
<blockquote>
<p>Also I want to put forward that I am both pretty happy to work on implementing the model I proposed and likely will have a reasonable amount of time for it over the next year, even if it might not be my first priority. Nonetheless it matters to my existing work for hopefully somewhat obvious reasons, and I have managed to put time into that and also a bit of time into all the little side issues that touches.</p>
<p>That also is why I cannot pretend I am keen on semantics that resist parallelization for this.</p>
</blockquote>
<p>Can you clarify what model you mean here (just a link to a message or such)? I'm also somewhat lost in this conversation</p>



<a name="274328878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/274328878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#274328878">(Mar 06 2022 at 21:22)</a>:</h4>
<p>Functionally, "implement enough of an interface that ptr-&gt;int-&gt;ptr is technically unnecessary", yes.<br>
which in relation to the ISO C provenance papers functionally somewhat resembles "definitely not <code>PNVI-ae*</code> or <code>PVI</code>, but possibly looks like <code>PNVI-plain</code>, if you first do a headstand (that is to say: invert the problem)."</p>



<a name="275934176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275934176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275934176">(Mar 19 2022 at 22:46)</a>:</h4>
<p><a href="https://gankra.github.io/blah/fix-rust-pointers/">https://gankra.github.io/blah/fix-rust-pointers/</a> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275939763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275939763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275939763">(Mar 20 2022 at 01:09)</a>:</h4>
<p>look llvm and rust have been playing the bUt mAyBe iT mAkEs SeNsE game for like a decade maybe we should just accept that int-ptr is nonsene <span aria-label="smiling devil" class="emoji emoji-1f608" role="img" title="smiling devil">:smiling_devil:</span></p>



<a name="275939823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275939823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275939823">(Mar 20 2022 at 01:11)</a>:</h4>
<p>plus i just wrote most of the RFC and user docs for you so :3c</p>



<a name="275943056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275943056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275943056">(Mar 20 2022 at 02:45)</a>:</h4>
<blockquote>
<p>This section can be skipped entirely if you know everything about computers.</p>
</blockquote>



<a name="275951405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275951405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275951405">(Mar 20 2022 at 06:34)</a>:</h4>
<p>I love it when people do even worse things by accident like cast pointers to u8s.</p>



<a name="275964411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275964411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275964411">(Mar 20 2022 at 12:27)</a>:</h4>
<p>By the way, AFAIK, the <code>cheri_address_set</code> operation can already be written in Rust:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">ptr_address_set</span><span class="o">&lt;</span><span class="n">Pointee</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="c1">// "capability" / "base"</span>
<span class="w">    </span><span class="n">provenance</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Pointee</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">new_address</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Pointee</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">provenance</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">wrapping_add</span><span class="p">(</span><span class="n">new_address</span><span class="p">.</span><span class="n">wrapping_sub</span><span class="p">(</span><span class="n">provenance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">cast</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>which, by the way, given the "returns a changed pointer" signature, would be more idiomatic to name <code>.with_address()</code> rather than <code>set…</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">new_bit</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="err">…</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">addr_without_bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">!</span><span class="mb">0b1</span><span class="p">;</span><span class="w"></span>
<span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">with_address</span><span class="p">(</span><span class="n">addr_without_bit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">new_bit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">));</span><span class="w"></span>
</code></pre></div>



<a name="275969782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275969782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275969782">(Mar 20 2022 at 14:26)</a>:</h4>
<p>Yes I believe this is a pattern Ralf has shared a few different times for helping miri users explicitly reestablish pointer provenance, which is all cheri_address_set <em>is</em> as far as I know</p>



<a name="275969811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275969811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275969811">(Mar 20 2022 at 14:27)</a>:</h4>
<p>One interesting thing I've noticed is that XOR lists appear to be fundamentally incompatible with CHERI and therefore my strict definition of provenance. IMO they are a meme but people <em>do</em> use them...</p>



<a name="275969956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/275969956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#275969956">(Mar 20 2022 at 14:30)</a>:</h4>
<p>well specifically "XOR lists where each pointer is genuinely its own box allocation" if you have like a XOR list in an arena you can get it to work by keeping around a pointer to the arena to "reconstitute" the XOR'd addresses</p>



<a name="276090080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276090080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276090080">(Mar 21 2022 at 17:55)</a>:</h4>
<p><a href="https://twitter.com/Gankra_/status/1505966152115277829">https://twitter.com/Gankra_/status/1505966152115277829</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/Gankra_/status/1505966152115277829"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/37663fd2872232bfa24553d81b8b079cdd79fc11/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313233373135353532323631343336363230382f6c68686b554158395f6e6f726d616c2e6a7067"></a><p><a href="https://twitter.com/brooksdavis">@brooksdavis</a> <a href="https://twitter.com/MSpondee">@MSpondee</a> hrm this actually has nasty semantic consequences, because it means

good_ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE) is not in general a sound operation!

<a href="https://t.co/xOXX7QKsGQ">https://doc.rust-lang.org/std/primitive.pointer.html#method.wrapping_offset</a> <a href="https://t.co/0pRgN31cmK">https://twitter.com/Gankra_/status/1505966152115277829/photo/1</a></p><span>- Aria the Cat (@Gankra_)</span><div class="twitter-image"><a href="https://t.co/0pRgN31cmK"><img src="https://uploads.zulipusercontent.net/e15055ad48d6984cb7c6198c5c2222a7a6c8d815/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f464f5a446b6665584d4149744247562e6a70673a6d656469756d"></a></div><div class="twitter-image"><a href="https://t.co/0pRgN31cmK"><img src="https://uploads.zulipusercontent.net/e9b0a1d913da160125ae6276c5748068321bf1a5/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f464f5a454d5739584541455579556d2e6a70673a7468756d62"></a></div></div></div>



<a name="276092152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276092152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276092152">(Mar 21 2022 at 18:10)</a>:</h4>
<p>That might be the straw that breaks the camel's back insofar as CHERI is concerned.</p>



<a name="276092368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276092368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276092368">(Mar 21 2022 at 18:12)</a>:</h4>
<p>idk, rust very universally discourages wrapping_offset, and we can potentially formalize "wrapping_offset is not Free Real Estate and has platform-specific restrictions"</p>



<a name="276092469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276092469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276092469">(Mar 21 2022 at 18:13)</a>:</h4>
<p>like any pointer tagging scheme is already doing Platform Specific Fuckery and wrapping_offset can be conceptualized as that</p>



<a name="276092714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276092714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276092714">(Mar 21 2022 at 18:14)</a>:</h4>
<p>also it's very nice that due to the nature of CHERI you are guaranteed to fault if you fuck up</p>



<a name="276092919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276092919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276092919">(Mar 21 2022 at 18:16)</a>:</h4>
<p>like yes the language generally models "faulting" as UB but we <em>can</em> just let it be a Safe Fuck You</p>



<a name="276092933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276092933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276092933">(Mar 21 2022 at 18:16)</a>:</h4>
<p>just like blowing the stack</p>



<a name="276093307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276093307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276093307">(Mar 21 2022 at 18:19)</a>:</h4>
<p><a href="https://twitter.com/Gankra_/status/1505972146291593227">https://twitter.com/Gankra_/status/1505972146291593227</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/Gankra_/status/1505972146291593227"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/37663fd2872232bfa24553d81b8b079cdd79fc11/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313233373135353532323631343336363230382f6c68686b554158395f6e6f726d616c2e6a7067"></a><p><a href="https://twitter.com/brooksdavis">@brooksdavis</a> <a href="https://twitter.com/MSpondee">@MSpondee</a> one interesting interpretation of this is that it's exactly the same as blowing the stack: rust pretends like you have infinite stack but we install a guard page/probes that fault when you run out.

CHERI *guarantees* a fault if you fuck this up, so it's kinda the same thing?</p><span>- Aria the Cat (@Gankra_)</span></div></div>



<a name="276094032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276094032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276094032">(Mar 21 2022 at 18:24)</a>:</h4>
<p>That just completely kills top-bit tagging though right?</p>



<a name="276094109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276094109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276094109">(Mar 21 2022 at 18:24)</a>:</h4>
<p>yes</p>



<a name="276094222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276094222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276094222">(Mar 21 2022 at 18:25)</a>:</h4>
<p>but pointer-tagging is <em>always</em> a platform-specific trick, <em>especially</em> high-bit stuff</p>



<a name="276095710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276095710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276095710">(Mar 21 2022 at 18:34)</a>:</h4>
<p>Right, that's fine. The bigger issue is as you said there's no way to make <code>with_addr</code> be general, which means instead of killing  <code>as</code> casts and replacing them with methods we'll have to nuke them with no replacement.</p>



<a name="276097874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276097874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276097874">(Mar 21 2022 at 18:51)</a>:</h4>
<p>with_addr defers to wrapping_offset's semantics already, so we just need a clear story for wrapping_offset</p>



<a name="276098410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098410">(Mar 21 2022 at 18:55)</a>:</h4>
<p>(with_addr doesn't actually let you cheat on provenance, but provenance only "matters" when you load/store, as far as I know -- certainly that's CHERI's interpretation)</p>



<a name="276098500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098500">(Mar 21 2022 at 18:56)</a>:</h4>
<p>Is it a recoverable fault</p>



<a name="276098555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098555">(Mar 21 2022 at 18:56)</a>:</h4>
<p>Like, the OS then has the option to kill the process or not, yes?</p>



<a name="276098592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098592">(Mar 21 2022 at 18:56)</a>:</h4>
<p>The OS might, but an application surely can't</p>



<a name="276098602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098602">(Mar 21 2022 at 18:57)</a>:</h4>
<p>Ah I see.</p>



<a name="276098617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098617">(Mar 21 2022 at 18:57)</a>:</h4>
<p>(absolutely no idea, pure guess)</p>



<a name="276098663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098663">(Mar 21 2022 at 18:57)</a>:</h4>
<p>like, what happens when you hit the stack's guard page</p>



<a name="276098675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098675">(Mar 21 2022 at 18:57)</a>:</h4>
<p>i assume this is wholy identical</p>



<a name="276098856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276098856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276098856">(Mar 21 2022 at 18:59)</a>:</h4>
<p>Right.</p>



<a name="276099828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276099828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276099828">(Mar 21 2022 at 19:06)</a>:</h4>
<p>I think it's a fun issue if <code>p.wrapping_offset(o).wrapping_offset(-o)</code> isn't guaranteed to yield p, because that is already guaranteed.</p>



<a name="276099922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276099922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276099922">(Mar 21 2022 at 19:07)</a>:</h4>
<p>we're already writing a lot of checks with our mouth that our ass can't cash</p>



<a name="276099937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276099937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276099937">(Mar 21 2022 at 19:07)</a>:</h4>
<p>Yeah.</p>



<a name="276100031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100031">(Mar 21 2022 at 19:08)</a>:</h4>
<p>so like one more on the pile tbh just further illustrates the need to declare bankruptcy.</p>



<a name="276100175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100175">(Mar 21 2022 at 19:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276098663">said</a>:</p>
<blockquote>
<p>like, what happens when you hit the stack's guard page</p>
</blockquote>
<p><code>SIGSEGV</code>, which <code>std</code> turns into an abort</p>



<a name="276100353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100353">(Mar 21 2022 at 19:11)</a>:</h4>
<p>Ah yes, and we have an absolutely godawful story for signal handling.</p>



<a name="276100375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100375">(Mar 21 2022 at 19:11)</a>:</h4>
<p>on that note, I wonder how untyped pointer access like stack-probing will work in CHERI</p>



<a name="276100377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100377">(Mar 21 2022 at 19:11)</a>:</h4>
<p>Mind, I very rarely, almost never, actually see C programs try to do signal handling either.</p>



<a name="276100467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100467">(Mar 21 2022 at 19:12)</a>:</h4>
<p>or is stack probing just not a thing, given the stronger pointer protections already?</p>



<a name="276100737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100737">(Mar 21 2022 at 19:14)</a>:</h4>
<p>I think from our perspective "yes, there is a guard page, it's called the capability management itself."</p>



<a name="276100894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100894">(Mar 21 2022 at 19:15)</a>:</h4>
<p>the thing is, stack overflow is not necessarily a bad pointer at all, just recursion gone too far most of the time</p>



<a name="276100981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100981">(Mar 21 2022 at 19:16)</a>:</h4>
<p>okay but<br>
stack pointers</p>



<a name="276100989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100989">(Mar 21 2022 at 19:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276092368">said</a>:</p>
<blockquote>
<p>idk, rust very universally discourages wrapping_offset, and we can potentially formalize "wrapping_offset is not Free Real Estate and has platform-specific restrictions"</p>
</blockquote>
<p>Whoa, what? Rust discourages <code>wrapping_offset</code>? Since when?</p>



<a name="276100990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276100990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276100990">(Mar 21 2022 at 19:16)</a>:</h4>
<p>and probing is just protecting against going too far with a frame size greater than the guard page</p>



<a name="276101067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101067">(Mar 21 2022 at 19:17)</a>:</h4>
<p>I have no idea how CHERI manages stack pointers and its size. I guess this must have been thought through already.</p>



<a name="276101133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101133">(Mar 21 2022 at 19:18)</a>:</h4>
<p>I am not entirely sure, I am just saying that the stack pointer is in fact a pointer into memory also.</p>



<a name="276101175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101175">(Mar 21 2022 at 19:18)</a>:</h4>
<p>And that the "high-level" idea of a pointer need not apply.</p>



<a name="276101201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101201">(Mar 21 2022 at 19:18)</a>:</h4>
<p>Anyways, on CHERI, we can read the metadata and detect whether the pointer would actually go out of bounds, couldn't we?</p>



<a name="276101212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101212">(Mar 21 2022 at 19:19)</a>:</h4>
<p>yeah, ok. a probe is just an offset from that stack pointer.</p>



<a name="276101276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101276">(Mar 21 2022 at 19:19)</a>:</h4>
<blockquote>
<p>An out of bounds access produces a hardware fault. In a simple program running in CheriBSD it’s usually turned into a SIGPROT which defaults to killing the process, but can be caught.</p>
</blockquote>
<p>Aha.</p>



<a name="276101371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101371">(Mar 21 2022 at 19:20)</a>:</h4>
<p>I have no idea what we would do with that lmao.</p>



<a name="276101494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276101494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276101494">(Mar 21 2022 at 19:21)</a>:</h4>
<p>just give it a nicer <code>rtabort!</code> message, I suppose, like we do for stack overflow</p>



<a name="276102065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102065">(Mar 21 2022 at 19:27)</a>:</h4>
<p>Also I feel I should note, as I have a few times before: The idea you can just shuffle-puck a pointer around in C is in fact depending on</p>
<blockquote>
<h3>6.3.2.3 Pointers</h3>
<p>[...]<br>
5. An integer may be converted to any pointer type. Except as previously specified, the result is<br>
   implementation-defined, might not be correctly aligned, might not point to an entity of the referenced<br>
   type, and might be a trap representation.</p>
</blockquote>
<p>having a consistent definition, and not merely a compiler-defined one... and how closely have you read your compiler manual, exactly? <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="276102457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102457">(Mar 21 2022 at 19:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276099828">said</a>:</p>
<blockquote>
<p>I think it's a fun issue if <code>p.wrapping_offset(o).wrapping_offset(-o)</code> isn't guaranteed to yield p, because that is already guaranteed.</p>
</blockquote>
<p>it <em>does</em> yield p, it just <em>also</em> sets a flag somewhere in the ~hardware that says "if they dereference this i WILL fault"</p>



<a name="276102528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102528">(Mar 21 2022 at 19:32)</a>:</h4>
<p>That's not yielding <code>p</code>, though.</p>



<a name="276102559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102559">(Mar 21 2022 at 19:32)</a>:</h4>
<p>Its yielding <code>invalidate(p)</code>.</p>



<a name="276102577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102577">(Mar 21 2022 at 19:32)</a>:</h4>
<p>CHERI disagrees lol.</p>



<a name="276102645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102645">(Mar 21 2022 at 19:33)</a>:</h4>
<p>p isn't just the memory representation of p, but also it's provenance, both in-memory and outside of memory.</p>



<a name="276102650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102650">(Mar 21 2022 at 19:33)</a>:</h4>
<p>I mean in a technical sense yes, you are right, Connor, but I don't think users can observe the difference.</p>



<a name="276102691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102691">(Mar 21 2022 at 19:33)</a>:</h4>
<p>They can, because it faults on dereference when <code>p</code> does not.</p>



<a name="276102795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102795">(Mar 21 2022 at 19:34)</a>:</h4>
<p>yes but a program has a hard time observing it has terminated.</p>



<a name="276102796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102796">(Mar 21 2022 at 19:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276100989">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276092368">said</a>:</p>
<blockquote>
<p>idk, rust very universally discourages wrapping_offset, and we can potentially formalize "wrapping_offset is not Free Real Estate and has platform-specific restrictions"</p>
</blockquote>
<p>Whoa, what? Rust discourages <code>wrapping_offset</code>? Since when?</p>
</blockquote>
<p>literally always? It took until 1.16.0 for us to even be willing to add it.</p>



<a name="276102842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102842">(Mar 21 2022 at 19:34)</a>:</h4>
<p>Which is a crucial guarantee of <code>p.wrapping_offset(o)</code> -&gt; that <code>p.wrapping_offset(o).wrapping_offset(-o)</code> is <code>p</code> and has the same effects as <code>p</code>, in paticular, it's validity.</p>



<a name="276102859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102859">(Mar 21 2022 at 19:35)</a>:</h4>
<p>At least under <em>my</em> tenure all of std was <em>incredibly</em> meticulous about <em>always</em> using <code>offset</code></p>



<a name="276102875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102875">(Mar 21 2022 at 19:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276102795">said</a>:</p>
<blockquote>
<p>yes but a program has a hard time observing it has terminated.</p>
</blockquote>
<p>It alters the observable behaviour, though. It prevents output that would otherwise have occured.</p>



<a name="276102885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102885">(Mar 21 2022 at 19:35)</a>:</h4>
<p>Right, I mean that the program is the user.</p>



<a name="276102900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102900">(Mar 21 2022 at 19:35)</a>:</h4>
<p>Sorry, confusion in terms.</p>



<a name="276102903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276102903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276102903">(Mar 21 2022 at 19:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276102796">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276100989">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276092368">said</a>:</p>
<blockquote>
<p>idk, rust very universally discourages wrapping_offset, and we can potentially formalize "wrapping_offset is not Free Real Estate and has platform-specific restrictions"</p>
</blockquote>
<p>Whoa, what? Rust discourages <code>wrapping_offset</code>? Since when?</p>
</blockquote>
<p>literally always? It took until 1.16.0 for us to even be willing to add it.</p>
</blockquote>
<p>Interesting. I post-date 1.16 by a fair margin.<br>
My experience is that <code>wrapping_offset</code> is the only way to stick provenance back onto a pointer in Miri, and also it is useful for some kinds of creative code that I think cuviper has maintained in <code>primal</code></p>



<a name="276103006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103006">(Mar 21 2022 at 19:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276102796">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276100989">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276092368">said</a>:</p>
<blockquote>
<p>idk, rust very universally discourages wrapping_offset, and we can potentially formalize "wrapping_offset is not Free Real Estate and has platform-specific restrictions"</p>
</blockquote>
<p>Whoa, what? Rust discourages <code>wrapping_offset</code>? Since when?</p>
</blockquote>
<p>literally always? It took until 1.16.0 for us to even be willing to add it.</p>
</blockquote>
<p>MaybeUninit was 1.31. <code>addr_of</code> was 1.51. <code>asm</code> was 1.59. Are all of those "discouraged"?</p>



<a name="276103032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103032">(Mar 21 2022 at 19:36)</a>:</h4>
<p>to be clear: wrapping_offset is useful and necessary but you should <em>definitely</em> always start off by trying to use normal offset, because it is Better and Right</p>



<a name="276103034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103034">(Mar 21 2022 at 19:36)</a>:</h4>
<p>chadyes.jpg</p>



<a name="276103054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103054">(Mar 21 2022 at 19:36)</a>:</h4>
<p>wrapping_offset is the "i am doing crimes" offset</p>



<a name="276103103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103103">(Mar 21 2022 at 19:37)</a>:</h4>
<p>Really, one of the problems we're running into is this:<br>
LLVM has not done the best job of keeping its own house clean and its own semantics in order.</p>



<a name="276103118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103118">(Mar 21 2022 at 19:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103054">said</a>:</p>
<blockquote>
<p>wrapping_offset is the "i am doing crimes" offset</p>
</blockquote>
<p>I'm worried that it is the "the offset contract is too narrow for the way I think about pointers" offset</p>



<a name="276103157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103157">(Mar 21 2022 at 19:37)</a>:</h4>
<p>And they adhere to <strong>much</strong> less strict stability guarantees than we do.</p>



<a name="276103187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103187">(Mar 21 2022 at 19:37)</a>:</h4>
<p>And cheri will happily and safely abort!() your program if you are wrong, just like index-out-of-bounds :)</p>



<a name="276103286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103286">(Mar 21 2022 at 19:38)</a>:</h4>
<p>it's not necessarily useful to complain about llvm here, since gcc has similar wonkyness around e.g. not actually being able to have offsets larger than isize aiui</p>



<a name="276103306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103306">(Mar 21 2022 at 19:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103187">said</a>:</p>
<blockquote>
<p>And cheri will happily and safely abort!() your program if you are wrong, just like index-out-of-bounds :)</p>
</blockquote>
<p>Except the difference here is that CHERI is aborting on <code>[].get(0)</code> instead of <code>[][0]</code>/<code>[].get_unchecked(0)</code>.</p>



<a name="276103335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103335">(Mar 21 2022 at 19:39)</a>:</h4>
<p>no?</p>



<a name="276103343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103343">(Mar 21 2022 at 19:39)</a>:</h4>
<p>pointer loads can <em>always</em> fault</p>



<a name="276103426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103426">(Mar 21 2022 at 19:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103286">said</a>:</p>
<blockquote>
<p>it's not necessarily useful to complain about llvm here, since gcc has similar wonkyness around e.g. not actually being able to have offsets larger than isize aiui</p>
</blockquote>
<p>My indictments of LLVM can be considered applicable to all C compilers, tbh.</p>



<a name="276103441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103441">(Mar 21 2022 at 19:40)</a>:</h4>
<p>A pointer load from a pointer that the language guarantees is valid cannot ever fault on a valid implementation, period, not in any way that affects the observable behaviour of the program in contradiction of the as-if rule.</p>



<a name="276103493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103493">(Mar 21 2022 at 19:40)</a>:</h4>
<p>that's an exceptionally strong claim that sounds extremely untrue in practice</p>



<a name="276103527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103527">(Mar 21 2022 at 19:41)</a>:</h4>
<p>Yeah where does that claim come from?</p>



<a name="276103545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103545">(Mar 21 2022 at 19:41)</a>:</h4>
<p>like at a minimum this is objectively false for CoW memory</p>



<a name="276103564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103564">(Mar 21 2022 at 19:41)</a>:</h4>
<p>It comes from the fact that the as-if rule guarantees the observable behaviour of the program be preserved unless undefined behaviour,</p>



<a name="276103581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103581">(Mar 21 2022 at 19:41)</a>:</h4>
<p>what as-if rule?</p>



<a name="276103584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103584">(Mar 21 2022 at 19:41)</a>:</h4>
<p>Literally what "as-if" rule?</p>



<a name="276103887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103887">(Mar 21 2022 at 19:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103545">said</a>:</p>
<blockquote>
<p>like at a minimum this is objectively false for CoW memory</p>
</blockquote>
<p>If the fault doesn't affect the observable behaviour, then it's fine. But if I have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">println!</span><span class="p">(</span><span class="s">"foo"</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">);</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"bar: {}"</span><span class="p">,</span><span class="k">unsafe</span><span class="p">{</span><span class="o">*</span><span class="n">q</span><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>Then it's required to print </p>
<blockquote>
<p>foo<br>
bar: 0</p>
</blockquote>



<a name="276103923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103923">(Mar 21 2022 at 19:44)</a>:</h4>
<p>well no, stdout could be missing</p>



<a name="276103932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103932">(Mar 21 2022 at 19:44)</a>:</h4>
<p>or you could run out of stack</p>



<a name="276103933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103933">(Mar 21 2022 at 19:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103584">said</a>:</p>
<blockquote>
<p>Literally what "as-if" rule?</p>
</blockquote>
<p>The one that's at the very least implied in the fact that the language makes any guarantees of behaviour.,</p>



<a name="276103979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103979">(Mar 21 2022 at 19:45)</a>:</h4>
<p>Yeah you have two panics there.</p>



<a name="276103993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276103993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276103993">(Mar 21 2022 at 19:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103923">said</a>:</p>
<blockquote>
<p>well no, stdout could be missing</p>
</blockquote>
<p>Print as in write to w/e stdout is.</p>



<a name="276104085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104085">(Mar 21 2022 at 19:46)</a>:</h4>
<p>If there's no stdout, then it panics, yes. If there is a stdout, though, it writes to it. This is the observable behaviour of the program.</p>



<a name="276104154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104154">(Mar 21 2022 at 19:46)</a>:</h4>
<p>And yes, stack overflow is an implementation limit, but a clearly known one (and likely unapplicable if that code is written inside of <code>main</code>)</p>



<a name="276104196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104196">(Mar 21 2022 at 19:47)</a>:</h4>
<p>I am pretty sure <code>println!</code> can panic if <code>stdout</code> is present but it can't be acquired.</p>



<a name="276104217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104217">(Mar 21 2022 at 19:47)</a>:</h4>
<p>There is currently some ambiguity about whether programs are allowed to close stdout. <code>std::io::Stdout</code> handles <code>EBADF</code>, but nothing prevents an unrelated <code>File::open</code> from later reusing fd value 1.</p>



<a name="276104314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104314">(Mar 21 2022 at 19:48)</a>:</h4>
<p>laughing.</p>



<a name="276104333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104333">(Mar 21 2022 at 19:48)</a>:</h4>
<p>Programming languages will <em>always</em> be "i'm just doing my best!"</p>



<a name="276104429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104429">(Mar 21 2022 at 19:49)</a>:</h4>
<p>... Allow me to be more precise. Rust does not allow the read from <code>q</code> to be the cause of a crash, if any, because dereferencing a pointer does not panic and in that code is well-defined from a language perspective.</p>



<a name="276104444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104444">(Mar 21 2022 at 19:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276104154">said</a>:</p>
<blockquote>
<p>And yes, stack overflow is an implementation limit, but a clearly known one (and likely unapplicable if that code is written inside of <code>main</code>)</p>
</blockquote>
<p>i mean, this exact same argument would have applied when computers started introducing memory protection, right? like "everyone knows you can just access all of memory whenever you want!"</p>



<a name="276104506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104506">(Mar 21 2022 at 19:50)</a>:</h4>
<p>It would be the same if linux decided to unmap my stack out from under me, and hand my program a SIGSEGV on the read. That isn't a valid implementation.</p>



<a name="276104597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104597">(Mar 21 2022 at 19:50)</a>:</h4>
<p>rust largely does not guarantee forward progress, only what happens if we <em>do</em> make progress</p>



<a name="276104654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104654">(Mar 21 2022 at 19:51)</a>:</h4>
<p>We have deprecated methods before because they proved to be rotten on the mere premise of them. You are advancing an excellent argument in favor of deprecating <code>wrapping_offset</code>.</p>



<a name="276104669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104669">(Mar 21 2022 at 19:51)</a>:</h4>
<p>So... I can't rely on my program doing anything at all other then crash? That makes rust a very difficult language to use.</p>



<a name="276104688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104688">(Mar 21 2022 at 19:51)</a>:</h4>
<p>this is the exact guarantee all programming languages make, I regret to inform you</p>



<a name="276104690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104690">(Mar 21 2022 at 19:51)</a>:</h4>
<p>Well i dont know we all seem to be doing a pretty good job at using it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="276104712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104712">(Mar 21 2022 at 19:51)</a>:</h4>
<p>I think we can read the metadata though.</p>



<a name="276104777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104777">(Mar 21 2022 at 19:52)</a>:</h4>
<p>And thus it might be possible to write <code>try_map_addr</code>.</p>



<a name="276104847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104847">(Mar 21 2022 at 19:52)</a>:</h4>
<p>(proof: task manager exists and wins all arguments)</p>



<a name="276104869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104869">(Mar 21 2022 at 19:52)</a>:</h4>
<p>From what I read it looks like we might be getting Rust 2 sooner than we thought.</p>



<a name="276104901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104901">(Mar 21 2022 at 19:53)</a>:</h4>
<p>lol</p>



<a name="276104911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104911">(Mar 21 2022 at 19:53)</a>:</h4>
<p>Outside manipulation is very out of scope.</p>



<a name="276104915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104915">(Mar 21 2022 at 19:53)</a>:</h4>
<p><span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="276104930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104930">(Mar 21 2022 at 19:53)</a>:</h4>
<p>AHA.</p>



<a name="276104961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104961">(Mar 21 2022 at 19:53)</a>:</h4>
<p>But this is internal manipulation by the implementation of rust in play.</p>



<a name="276104975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276104975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276104975">(Mar 21 2022 at 19:53)</a>:</h4>
<p>But you see, from the perspective of Rust, the CHERI hardware <strong>is</strong> outside intervention.</p>



<a name="276105006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105006">(Mar 21 2022 at 19:54)</a>:</h4>
<p>Your program is terminated by force majeure.</p>



<a name="276105048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105048">(Mar 21 2022 at 19:54)</a>:</h4>
<p>Not "I'm the OS and I'm being told to kill this process".</p>



<a name="276105075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105075">(Mar 21 2022 at 19:54)</a>:</h4>
<p>...except that's exactly what happens!</p>



<a name="276105082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105082">(Mar 21 2022 at 19:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276104975">said</a>:</p>
<blockquote>
<p>But you see, from the perspective of Rust, the CHERI hardware <strong>is</strong> outside intervention.</p>
</blockquote>
<p>The same argument would see x86 hardware faults as outside intervention as well, though.</p>



<a name="276105083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105083">(Mar 21 2022 at 19:54)</a>:</h4>
<p>At that point /proc/self/mem comes back into play and we lose the ability to actually reason about things.</p>



<a name="276105138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105138">(Mar 21 2022 at 19:54)</a>:</h4>
<p>You dereference the pointer, the hardware gets <del>God</del> the OS on the line, and the OS decides what happens next.</p>



<a name="276105146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105146">(Mar 21 2022 at 19:55)</a>:</h4>
<p>So can I have gcc just insert a call to mprotect that deallocates the stack? Oh, well, the #PF the kernel turns into SIGSEGV is outside intervention.</p>



<a name="276105254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105254">(Mar 21 2022 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276100990">said</a>:</p>
<blockquote>
<p>and probing is just protecting against going too far with a frame size greater than the guard page</p>
</blockquote>
<p>funny thing about not needing a guard page is you can make the stack some arbitrary size, like 777 bytes, with byte granularity allocations before and after (say, <code>String</code>s' contents) and be perfectly safe</p>



<a name="276105331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105331">(Mar 21 2022 at 19:57)</a>:</h4>
<p>Forgive me if I find the argument that the CPU trapping, being caused precisely by the precise rust code that rust prescribes to be a functional no-op, is outside intervention and not in scope for the semantics of rust unconvincing.</p>



<a name="276105544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105544">(Mar 21 2022 at 19:59)</a>:</h4>
<p>lccc is not required to support <code>wrapping_offset</code> nor CHERI. <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="276105610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105610">(Mar 21 2022 at 19:59)</a>:</h4>
<p>This isn't from my perspective as an implementor, this from my perspective as a user.</p>



<a name="276105704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105704">(Mar 21 2022 at 20:00)</a>:</h4>
<p>Well that's fair.</p>



<a name="276105748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105748">(Mar 21 2022 at 20:00)</a>:</h4>
<p>Anyways,</p>
<blockquote>
<p>The delayed check only considers the value of the pointer that was dereferenced, not the intermediate values used during the computation of the final result. For example, <code>x.wrapping_offset(o).wrapping_offset(o.wrapping_neg())</code> is always the same as <code>x</code>. In other words, leaving the allocated object and then re-entering it later is permitted.</p>
</blockquote>
<p>I think we simply got this wrong tho'.</p>



<a name="276105762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105762">(Mar 21 2022 at 20:00)</a>:</h4>
<p>We have done <em>far</em> more extreme changes in the past with basically no problems -- mem::unitialized is the most notable one here</p>



<a name="276105802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105802">(Mar 21 2022 at 20:00)</a>:</h4>
<p>And all code that runs on all supported platforms will be unaffected</p>



<a name="276105835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105835">(Mar 21 2022 at 20:01)</a>:</h4>
<p>This is carving out "but on weird platforms, the world is more complicated"</p>



<a name="276105842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105842">(Mar 21 2022 at 20:01)</a>:</h4>
<p>This also goes to soundness.</p>



<a name="276105858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105858">(Mar 21 2022 at 20:01)</a>:</h4>
<p>And it should be noted that <code>wrapping_offset</code> basically still works if you use it "as intended"... you can push a pointer VERY far out of bounds on CHERI without breaking The Law.</p>



<a name="276105946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105946">(Mar 21 2022 at 20:02)</a>:</h4>
<p>no one in std would ever argue that adding an abort!() for a degenerate situation is unsound</p>



<a name="276105950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105950">(Mar 21 2022 at 20:02)</a>:</h4>
<p>at least, very far out of bounds relatively speaking if T is to something less than 4kb in stride.</p>



<a name="276105971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276105971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276105971">(Mar 21 2022 at 20:02)</a>:</h4>
<p>As a random user who tries to undersand SB/miri/etc and unsafe (And def. not a compiler writer) I share that perspective. I think there's a difference between outside intervention and the machine code rust lowers itself having the problem. This sounds more like "This target/hardware has semantics that are incompatible with the rust abstract machine". And sure, rust could change what wrapping_offset means but wouldn't that be a breaking change? I'm pretty sure I've seen wrapping_offset used multiple times to create a ptr with an arbitrary addr and a given provenance, and I think I've seen Ralf suggest that too</p>



<a name="276106064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106064">(Mar 21 2022 at 20:03)</a>:</h4>
<p>Note that <em>this will still be allowed on CHERI</em> there will just be restrictions on how large the offset can be, dependent on how large the allocation is</p>



<a name="276106069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106069">(Mar 21 2022 at 20:03)</a>:</h4>
<p>The clauses of our stability contract add up to something more precisely phrased as "breaking changes aren't breaking it if's necessary for soundness".</p>



<a name="276106073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106073">(Mar 21 2022 at 20:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103118">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276103054">said</a>:</p>
<blockquote>
<p>wrapping_offset is the "i am doing crimes" offset</p>
</blockquote>
<p>I'm worried that it is the "the offset contract is too narrow for the way I think about pointers" offset</p>
</blockquote>
<p>as in, you leave the allocation and come back? or do you hop <em>between</em> allocations? (the latter being UB to actually access memory through)</p>
<p>what CHERI and miri do is they more concretely define the concept of "object" from the C standard (as "allocation") and effectively deny "allocation hopping", at various levels - a lot of misunderstanding around pointers as they exist in C or Rust is due to being fuzzy about that "allocation" concept</p>



<a name="276106139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106139">(Mar 21 2022 at 20:03)</a>:</h4>
<p>Yeah, this straight up seems to be a fundamental incompatibility between the prescribed semantics of the rust abstract machine and the emulation that is <em>insert-compiler-here</em> on cheri-<em>os</em>.</p>



<a name="276106145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106145">(Mar 21 2022 at 20:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219940">Nick12</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276105971">said</a>:</p>
<blockquote>
<p>I'm pretty sure I've seen wrapping_offset used multiple times to create a ptr with an arbitrary addr and a given provenance, and I think I've seen Ralf suggest that too</p>
</blockquote>
<p>that's only within the same allocation, which is the only valid use for that operation (if you plan to use the resulting pointer for memory access), and that will <em>never</em> trap by definition</p>



<a name="276106148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106148">(Mar 21 2022 at 20:03)</a>:</h4>
<p>The standard "I am tagging the low bits based on my knowledge of alignment" stuff all works</p>



<a name="276106209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106209">(Mar 21 2022 at 20:04)</a>:</h4>
<p>There's no formal Rust abstract machine prescription stuff tho'.</p>



<a name="276106210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106210">(Mar 21 2022 at 20:04)</a>:</h4>
<p>Anything based on high bits was <em>always</em> platform-specific and unportable</p>



<a name="276106233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106233">(Mar 21 2022 at 20:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106209">said</a>:</p>
<blockquote>
<p>There's no formal Rust abstract machine prescription stuff tho'.</p>
</blockquote>
<p>stdlib docs FTW.</p>



<a name="276106287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106287">(Mar 21 2022 at 20:04)</a>:</h4>
<p>Also, the "things are weird on weird machines" argument only goes so far.</p>



<a name="276106334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106334">(Mar 21 2022 at 20:05)</a>:</h4>
<p>If every update to documentation has to be treated as a strict behavior guarantee forever, then we need to FCP every single documentation change.</p>



<a name="276106363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106363">(Mar 21 2022 at 20:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106069">said</a>:</p>
<blockquote>
<p>The clauses of our stability contract add up to something more precisely phrased as "breaking changes aren't breaking it if's necessary for soundness".</p>
</blockquote>
<p>Does this apply if there is no soundness issue in existing platforms? I thought this was meant to fix bugs, not add new platforms where sound things can't be lowered</p>



<a name="276106377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106377">(Mar 21 2022 at 20:05)</a>:</h4>
<p>Which we have not been doing.</p>



<a name="276106409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106409">(Mar 21 2022 at 20:05)</a>:</h4>
<p>please give me some <em>useful</em> code that you believe is good and should work but won't work under CHERI so we can have a productive conversation. ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE) is not code anyone <em>actually</em> has a reason to care about</p>



<a name="276106464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106464">(Mar 21 2022 at 20:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276102065">said</a>:</p>
<blockquote>
<p>Also I feel I should note, as I have a few times before: The idea you can just shuffle-puck a pointer around in C is in fact depending on</p>
<blockquote>
<h3>6.3.2.3 Pointers</h3>
<p>[...]<br>
5. An integer may be converted to any pointer type. Except as previously specified, the result is<br>
   implementation-defined, might not be correctly aligned, might not point to an entity of the referenced<br>
   type, and might be a trap representation.</p>
</blockquote>
<p>having a consistent definition, and not merely a compiler-defined one... and how closely have you read your compiler manual, exactly? <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>
</blockquote>
<p>This is (effectively) not true, you are missing the (placed later, lol C standard) statement:</p>
<blockquote>
<p>The following type designates an unsigned integer type with the property that any valid pointer to void can be converted to this type, then converted back to pointer to void, and the result will compare equal to the original pointer. <code>uintptr_t</code></p>
</blockquote>
<p>So that's only true in the sense that uintptr_t is optional, and thus is irrelevant to these arguments.</p>



<a name="276106554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106554">(Mar 21 2022 at 20:06)</a>:</h4>
<p>Ahh, but there's a caveat: that only covers exact round-trips.</p>



<a name="276106590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106590">(Mar 21 2022 at 20:07)</a>:</h4>
<p>Manipulating <code>uintptr_t</code> does not provide the same guarantee, obviously.</p>



<a name="276106598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106598">(Mar 21 2022 at 20:07)</a>:</h4>
<p>yes, it's technically allowed to have a uselessly different representation, because indeed, lol C</p>



<a name="276106622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106622">(Mar 21 2022 at 20:07)</a>:</h4>
<p>Rust prescribes twos-compliment for signed integers. You can't just pick a platform that does ones-compliment arithmetic, throw rust on it, and say "Oh weird platforms are weird" to avoid the fact you've altered the prescribed behaviour of the language.<br>
This may or may not be comparable, but the argument is not all-defeating.</p>



<a name="276106710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106710">(Mar 21 2022 at 20:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276104712">said</a>:</p>
<blockquote>
<p>I think we can read the metadata though.</p>
</blockquote>
<p>yeah, CHERI doesn't make any effort to hide the metadata (at least right now, would be cool if the perms bits could control it), I <em>think</em> you can literally transmute <code>*T</code> to <code>u128</code></p>
<p>however, I would still try to make such an API work with the most restrictive form of miri (i.e. the one use for CTFE) though, and some kind of metadata-hiding CHERI variant, it's easy to be too platform-specific D:</p>



<a name="276106758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106758">(Mar 21 2022 at 20:08)</a>:</h4>
<p>CHERI explicitly notes: <a href="https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-947.pdf#page=28">https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-947.pdf#page=28</a></p>
<blockquote>
<p>In general, programmers should not rely on support for arbitrary out-of-bounds pointers.<br>
Nevertheless, in practice, we have found that the CHERI capability compression scheme sup-<br>
ports almost all in-the-field out-of-bounds behavior in widely used software such as FreeBSD,<br>
PostgreSQL, and WebKit.</p>
</blockquote>
<p>Are you interested in hairier code than "an entire operation system, a major database, and the most complicated webbrowser"?</p>



<a name="276106819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106819">(Mar 21 2022 at 20:09)</a>:</h4>
<p>Lower bit pointer tagging would work fine for CHERI due to needing to go less than 1KiB out of bounds, right?</p>



<a name="276106835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106835">(Mar 21 2022 at 20:09)</a>:</h4>
<p>yes</p>



<a name="276106853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106853">(Mar 21 2022 at 20:09)</a>:</h4>
<p>(the link I posted formally describes the constraint)</p>



<a name="276106937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106937">(Mar 21 2022 at 20:10)</a>:</h4>
<p>alignment tagging in particular will <em>always work</em> on <em>any bounds-checking system</em> for a relatively simple reason: <code>align_of::&lt;T&gt;() &lt;= size_of::&lt;T&gt;()</code> (I guess outside of ZSTs heh)</p>



<a name="276106939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106939">(Mar 21 2022 at 20:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106334">said</a>:</p>
<blockquote>
<p>If every update to documentation has to be treated as a strict behavior guarantee forever, then we need to FCP every single documentation change.</p>
</blockquote>
<p>I think it would be a huge issue if users could not rely on the documentation of the standard library, especially the safety constraints and allowances that unsafe code relies upon to avoid undefined behaviour.</p>



<a name="276106952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106952">(Mar 21 2022 at 20:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106409">said</a>:</p>
<blockquote>
<p>please give me some <em>useful</em> code that you believe is good and should work but won't work under CHERI so we can have a productive conversation. ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE) is not code anyone <em>actually</em> has a reason to care about</p>
</blockquote>
<p>This <em>only</em> matters because of an intention/desire to deprecate and remove ptr-int-ptr roundtrips. This isn't something that's come up normally because rust just lets you do <code>as</code>.</p>



<a name="276106966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276106966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276106966">(Mar 21 2022 at 20:10)</a>:</h4>
<p>Can we say that ptr2int2ptr is not valid and introduce an operation that can only do pointer tagging with less than 10bits?</p>



<a name="276107053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107053">(Mar 21 2022 at 20:11)</a>:</h4>
<p>if you make it alignment-oriented it will be quite reliable IMO</p>



<a name="276107062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107062">(Mar 21 2022 at 20:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106622">said</a>:</p>
<blockquote>
<p>Rust prescribes twos-compliment for signed integers. You can't just pick a platform that does ones-compliment arithmetic, throw rust on it, and say "Oh weird platforms are weird" to avoid the fact you've altered the prescribed behaviour of the language.<br>
This may or may not be comparable, but the argument is not all-defeating.</p>
</blockquote>
<p>this changes the behaviour under forward progress, not whether forward progress is made</p>
<p>now you have a fair complaint that supporting CHERI <em>strongly</em> encourages us to decouple usize and *mut</p>



<a name="276107154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107154">(Mar 21 2022 at 20:12)</a>:</h4>
<p>In CHERI's case, it's adding undefined behaviour to the program.</p>



<a name="276107184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107184">(Mar 21 2022 at 20:12)</a>:</h4>
<p>no the behaviour is <em>extremely</em> defined</p>



<a name="276107205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107205">(Mar 21 2022 at 20:13)</a>:</h4>
<p>Maybe at the hardware level, but not at any other level.</p>



<a name="276107221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107221">(Mar 21 2022 at 20:13)</a>:</h4>
<p>And compilers will assume that it won't trap.</p>



<a name="276107230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107230">(Mar 21 2022 at 20:13)</a>:</h4>
<p>aborting is pretty defined behavior tbh.</p>



<a name="276107241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107241">(Mar 21 2022 at 20:13)</a>:</h4>
<p>It's not what I would like, mind.</p>



<a name="276107280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107280">(Mar 21 2022 at 20:14)</a>:</h4>
<p>llvm I know presumes that any memory access at all other than a volatile write will continue execution.</p>



<a name="276107350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107350">(Mar 21 2022 at 20:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106966">said</a>:</p>
<blockquote>
<p>Can we say that ptr2int2ptr is not valid and introduce an operation that can only do pointer tagging with less than 10bits?</p>
</blockquote>
<p>well, that depends, do you care about anything where pointers are being stored in usize/uintptr_t for various "bad" reasons, mostly C FFI reasons: C pointers have Ord gotchas, vaguely reasonable C styles ("if you can't deref it right now don't put it in a pointer"), ancient backcompat (is there some old windows API that only takes an int that you want a pointer in? I know there's terrible posix ones), etc.</p>



<a name="276107351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107351">(Mar 21 2022 at 20:14)</a>:</h4>
<p>i maintain that this is identical behaviour to getting random stack overflows. library code cannot possibly know what stack size it will be run on. it just has to do it's best and sometimes the configuration it was run under means it gets shot and dies.</p>



<a name="276107364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107364">(Mar 21 2022 at 20:14)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> IOW, if <code>(ptr: *T).offset(align_of::&lt;T&gt;())</code> is not UB, and <code>ptr.addr() % align_of::&lt;T&gt;() == 0</code> (both of them true for a pointer obtained from <code>&amp;T</code> or any other safe pointer with <code>size_of::&lt;T&gt;() &gt; 0</code>), you can use those lower bits as much as you want</p>



<a name="276107393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107393">(Mar 21 2022 at 20:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276107351">said</a>:</p>
<blockquote>
<p>i maintain that this is identical behaviour to getting random stack overflows. library code cannot possibly know what stack size it will be run on. it just has to do it's best and sometimes the configuration it was run under means it gets shot and dies.</p>
</blockquote>
<p>Now program code can't rely on it, though.</p>



<a name="276107410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107410">(Mar 21 2022 at 20:14)</a>:</h4>
<p>uhh, stack overflow is not even remotely the same</p>



<a name="276107456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107456">(Mar 21 2022 at 20:15)</a>:</h4>
<p>If I plop my example code into main, can I not rely on it running to completion, presuming I don't send it any signals and my computer doesn't HCF?</p>



<a name="276107661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107661">(Mar 21 2022 at 20:17)</a>:</h4>
<p>Also, is llvm allowed to move the I/O past the read?</p>



<a name="276107663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107663">(Mar 21 2022 at 20:17)</a>:</h4>
<p>your example code tries to acquire the lock on stdout sooooo</p>



<a name="276107671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107671">(Mar 21 2022 at 20:17)</a>:</h4>
<p><em>please</em> specify code that won't still have that property that is <em>actually useful</em></p>



<a name="276107723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107723">(Mar 21 2022 at 20:17)</a>:</h4>
<p>what's kind of sad is that this discussion would be moot if we were willing to accept a 4x increase in pointer size instead of 2x, because then all bytes would be byte granularity</p>



<a name="276107791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107791">(Mar 21 2022 at 20:18)</a>:</h4>
<p>I don't have any specific useful code, but that doesn't mean it doesn't exist.</p>



<a name="276107792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107792">(Mar 21 2022 at 20:18)</a>:</h4>
<p>(it's even better than that because it's actually the same size for slices, since byte granularity CHERI lets you fit a whole <code>&amp;[T]</code> in one <code>*T</code>)</p>



<a name="276107851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107851">(Mar 21 2022 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276107723">said</a>:</p>
<blockquote>
<p>... if <strong>we</strong> were willing to accept ...</p>
</blockquote>
<p>well, not Rust devs, but "everyone with an interest in CHERI"</p>



<a name="276107880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276107880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276107880">(Mar 21 2022 at 20:19)</a>:</h4>
<p>I am actually very, very sympathetic to your positions in general, Connor, but this is the point at which I feel concern-trolled, to be quite honest.</p>



<a name="276108019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108019">(Mar 21 2022 at 20:20)</a>:</h4>
<p>My concern is on the stability of rust and not fundamentally sidestepping it.<br>
It may be reasonable to change the guarantees of the function ex-post-facto, but I would advise extraordinary caution, since this fundamentally alters soundness of programs.</p>



<a name="276108026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108026">(Mar 21 2022 at 20:20)</a>:</h4>
<p>i agree, there is no useful progress to be made if you're unwilling to specify a usecase</p>



<a name="276108061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108061">(Mar 21 2022 at 20:20)</a>:</h4>
<p>I promise you, I will do my best to make sure this does not harm any existing programs.</p>



<a name="276108096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108096">(Mar 21 2022 at 20:21)</a>:</h4>
<p>NB: it's not unsound unless you optimize assuming it doesn't happen. randomly killing the process is not unsound, that's why we inject panics for various things</p>



<a name="276108155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108155">(Mar 21 2022 at 20:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276108096">said</a>:</p>
<blockquote>
<p>NB: it's not unsound unless you optimize assuming it doesn't happen. randomly killing the process is not unsound, that's why we inject panics for various things</p>
</blockquote>
<p>At least llvm assumes a memory read can't kill the process.</p>



<a name="276108230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108230">(Mar 21 2022 at 20:22)</a>:</h4>
<p>it cannot affect the soundness of existing programs, rust does not run on any architecture where wrapping_offset would need restrictions</p>



<a name="276108278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108278">(Mar 21 2022 at 20:22)</a>:</h4>
<p>lccc will likely as well unless the read has an access class contianing <code>volatile</code>.</p>



<a name="276108351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108351">(Mar 21 2022 at 20:23)</a>:</h4>
<p>LLVM assumes no such thing? it assumes that code executing <em>after</em> a <code>load</code> (<strong>EDIT</strong>: after it "becomes inevitable") can <code>load</code> again from the same address without trapping</p>



<a name="276108388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108388">(Mar 21 2022 at 20:23)</a>:</h4>
<p>?</p>



<a name="276108455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108455">(Mar 21 2022 at 20:24)</a>:</h4>
<p>or, sorry, I forgot the "inevitability" thing</p>



<a name="276108487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108487">(Mar 21 2022 at 20:24)</a>:</h4>
<p>Also, this case <em>is</em> the same address.</p>



<a name="276108609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108609">(Mar 21 2022 at 20:25)</a>:</h4>
<p>I mean, the real problem, tbh</p>



<a name="276108672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108672">(Mar 21 2022 at 20:26)</a>:</h4>
<p>if a memory access is "inevitable" (whatever the exact UB-wording is), it assumes that it won't trap. there might be some interesting things here wrt removing software bounds-checking on e.g. Rust slices</p>



<a name="276108689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108689">(Mar 21 2022 at 20:26)</a>:</h4>
<blockquote>
<p>The allowed side-effects for volatile accesses are limited. If a non-volatile store to a given address would be legal, a volatile operation may modify the memory at that address. A volatile operation may not modify any other memory accessible by the module being compiled. A volatile operation may not call any code in the current module.</p>
<p>The compiler may assume execution will continue after a volatile operation, so operations which modify memory or may have undefined behavior can be hoisted past a volatile operation.</p>
</blockquote>
<p><a href="https://llvm.org/docs/LangRef.html#volatile-memory-accesses">https://llvm.org/docs/LangRef.html#volatile-memory-accesses</a><br>
I'd be suprised if non-volatile accesses have <em>less</em> guarantees to the optimizer than volatile-guarantees.</p>



<a name="276108716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108716">(Mar 21 2022 at 20:26)</a>:</h4>
<p>but we were talking about <code>wrapping_offset</code> not <code>load</code>/<code>store</code> anyway</p>



<a name="276108765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108765">(Mar 21 2022 at 20:26)</a>:</h4>
<p>wrapping_offset into a read (in the example case, from a println)</p>



<a name="276108850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108850">(Mar 21 2022 at 20:27)</a>:</h4>
<p><code>wrapping_offset</code> (non-<code>inbounds</code> GEP) makes LLVM lose any guarantees about the pointer being useful, that it might've had before. unless it's constant-folded out, ofc</p>



<a name="276108942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108942">(Mar 21 2022 at 20:28)</a>:</h4>
<p>the real problematic code, IMO, is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">];</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">cap</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xs</span><span class="p">.</span><span class="n">into_raw_parts</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">ptr_wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="n">HUGE</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="n">HUGE</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>under optimization.</p>



<a name="276108962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276108962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276108962">(Mar 21 2022 at 20:28)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="c1">// p is created from a Rust reference, dereferencable</span>
<span class="kd">let</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">);</span><span class="w"> </span><span class="c1">// equality replaces p with q, sound because same provenance and value.</span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="p">{</span><span class="o">*</span><span class="n">q</span><span class="p">};</span><span class="w"> </span><span class="c1">// crash</span>
<span class="n">platform_call</span><span class="p">(</span><span class="n">z</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Again, this is all a bit lost in the weeds. The main problem is that we're trying to deprecate not just fundamental parts of Rust but a fundamental mental model, to support a weird platform, and claiming that this somehow doesn't de facto break backwards compatibility.</p>



<a name="276109022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109022">(Mar 21 2022 at 20:29)</a>:</h4>
<p>CHERI's C++ implementation is built on top of clang, so seemingly this llvm boogeyman is not actually a problem</p>



<a name="276109032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109032">(Mar 21 2022 at 20:29)</a>:</h4>
<p>Yeah.</p>



<a name="276109072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109072">(Mar 21 2022 at 20:29)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> optimizing the <code>wrapping_offset</code>s, the <code>read</code>s, or both?</p>



<a name="276109091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109091">(Mar 21 2022 at 20:29)</a>:</h4>
<p>"lol, lmao".</p>



<a name="276109147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109147">(Mar 21 2022 at 20:30)</a>:</h4>
<p>Pick any or both.</p>



<a name="276109194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109194">(Mar 21 2022 at 20:30)</a>:</h4>
<p>I can think of so many possibilities of that.</p>



<a name="276109198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109198">(Mar 21 2022 at 20:30)</a>:</h4>
<p>(I was just asking for clarification of "under optimization", to be clear)</p>



<a name="276109239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109239">(Mar 21 2022 at 20:31)</a>:</h4>
<p>Uhh, I think optimizing either would remove the SIGSEGV.</p>



<a name="276109247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109247">(Mar 21 2022 at 20:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276108962">said</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="c1">// p is created from a Rust reference, dereferencable</span>
<span class="kd">let</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="kt">isize</span>::<span class="n">MAX</span><span class="p">);</span><span class="w"> </span><span class="c1">// equality replaces p with q, sound because same provenance and value.</span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="p">{</span><span class="o">*</span><span class="n">q</span><span class="p">};</span><span class="w"> </span><span class="c1">// crash</span>
<span class="n">platform_call</span><span class="p">(</span><span class="n">z</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Again, this is all a bit lost in the weeds. The main problem is that we're trying to deprecate not just fundamental parts of Rust but a fundamental mental model, to support a weird platform, and claiming that this somehow doesn't de facto break backwards compatibility.</p>
</blockquote>
<p>You misunderstand: Rust (and C, and C++) are already foundationally <em>broken</em> because pointer provenance is genuinely gibberish. CHERI is just the "excuse" to sit down and fix it because people who harumph about "real" things and "hardware" now lose the argument</p>



<a name="276109251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109251">(Mar 21 2022 at 20:31)</a>:</h4>
<p>Like <strong>my</strong> only concern is really "this code runs fine under optimization but crashes under debug???" issues.</p>



<a name="276109252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109252">(Mar 21 2022 at 20:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109022">said</a>:</p>
<blockquote>
<p>CHERI's C++ implementation is built on top of clang, so seemingly this llvm boogeyman is not actually a problem</p>
</blockquote>
<p>C++ doesn't have <code>wrapping_offset</code>.</p>



<a name="276109309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109309">(Mar 21 2022 at 20:31)</a>:</h4>
<p>Yes but there is no such language as "C" or "C++" only a pile of weird implementations that code vaguely works on</p>



<a name="276109368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109368">(Mar 21 2022 at 20:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109198">said</a>:</p>
<blockquote>
<p>(I was just asking for clarification of "under optimization", to be clear)</p>
</blockquote>
<p>I don't know which LLVM would consider valid optimizations though, fwiw.</p>



<a name="276109443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109443">(Mar 21 2022 at 20:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109251">said</a>:</p>
<blockquote>
<p>Like <strong>my</strong> only concern is really "this code runs fine under optimization but crashes under debug???" issues.</p>
</blockquote>
<p>right, I keep trying to formulate something similar myself. this optimization is <em>not</em> the kind of UB I was thinking about though</p>



<a name="276109470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109470">(Mar 21 2022 at 20:33)</a>:</h4>
<p>I consider it less UB and more confusing.</p>



<a name="276109486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109486">(Mar 21 2022 at 20:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109251">said</a>:</p>
<blockquote>
<p>Like <strong>my</strong> only concern is really "this code runs fine under optimization but crashes under debug???" issues.</p>
</blockquote>
<p>tbf that's also just true of all integer overflow</p>



<a name="276109491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109491">(Mar 21 2022 at 20:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276105946">said</a>:</p>
<blockquote>
<p>no one in std would ever argue that adding an abort!() for a degenerate situation is unsound</p>
</blockquote>
<p>I don't think anyone would argue against that statement as made; the argument will always be over what is considered "degenerate". :)</p>



<a name="276109496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109496">(Mar 21 2022 at 20:33)</a>:</h4>
<p>fair.</p>



<a name="276109522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109522">(Mar 21 2022 at 20:33)</a>:</h4>
<p><del>what if integer overflow was a mistake</del></p>



<a name="276109593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109593">(Mar 21 2022 at 20:34)</a>:</h4>
<p>we _do_ have an option for that and its on by default in nonrelease :P</p>



<a name="276109595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109595">(Mar 21 2022 at 20:34)</a>:</h4>
<p>Swift agrees, convince apple to make it a hardware trap :)</p>



<a name="276109605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109605">(Mar 21 2022 at 20:34)</a>:</h4>
<p>ha.</p>



<a name="276109612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109612">(Mar 21 2022 at 20:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109251">said</a>:</p>
<blockquote>
<p>Like <strong>my</strong> only concern is really "this code runs fine under optimization but crashes under debug???" issues.</p>
</blockquote>
<p>Oh look</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">uninitialized</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>On lccc with overflow checks on vs. off (Although we don't yet have have overflow checks yet... or callable<code>core::mem::uninitialized</code>).</p>



<a name="276109653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109653">(Mar 21 2022 at 20:34)</a>:</h4>
<p><code>core::mem::uninitialized</code> is deprecated like hella.</p>



<a name="276109687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109687">(Mar 21 2022 at 20:35)</a>:</h4>
<p>it is the canonical example of what we are doing</p>



<a name="276109705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109705">(Mar 21 2022 at 20:35)</a>:</h4>
<p>Now I can understand this mental model being wrong and working to fix it, but even the C standard writers understand that their standards have real power when declaring things UB, and TS 6010 has been much more loathe to declare existing practices "wrong". I've seen talks about how PNVI-ae-uni is not enough for dealing with restrict, but nobody talks outright about banning these casts outright.</p>



<a name="276109732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109732">(Mar 21 2022 at 20:35)</a>:</h4>
<p>me. I do.</p>



<a name="276109756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109756">(Mar 21 2022 at 20:35)</a>:</h4>
<p>(For context, in debug this generates an <code>add checked</code> then a branch to a panic, and the constant propagater in the codegen gets <code>unint</code> as the branch control, which causes it to generate <code>ud2</code>, in release it just generates <code>add wrapping</code>)</p>



<a name="276109760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109760">(Mar 21 2022 at 20:35)</a>:</h4>
<p>like Mongols, I am the exception.</p>



<a name="276109761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109761">(Mar 21 2022 at 20:35)</a>:</h4>
<p>Sorry, missing the in C-land qualifier</p>



<a name="276109811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109811">(Mar 21 2022 at 20:36)</a>:</h4>
<p>Ah fair... oh uhhhh.</p>



<a name="276109813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109813">(Mar 21 2022 at 20:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106334">said</a>:</p>
<blockquote>
<p>If every update to documentation has to be treated as a strict behavior guarantee forever, then we need to FCP every single documentation change.</p>
</blockquote>
<p>...we kinda do, or at least try to. I've regularly seen both lang and libs FCPs to documentation changes on the basis of "do we want to make this commitment".</p>
<p>That doesn't mean we don't change those commitments, on the crater-based basis of "if breakage happens in a Rust and nobody in <a href="http://crates.io">crates.io</a> is around to hear it, did it really break", but we do at least attempt to review those commitments.</p>



<a name="276109822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109822">(Mar 21 2022 at 20:36)</a>:</h4>
<p>...I have seen them actually.</p>



<a name="276109846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109846">(Mar 21 2022 at 20:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276108962">said</a>:</p>
<blockquote>
<p>Again, this is all a bit lost in the weeds. The main problem is that we're trying to deprecate not just fundamental parts of Rust but a fundamental mental model, to support a weird platform, and claiming that this somehow doesn't de facto break backwards compatibility.</p>
</blockquote>
<p>so functionally, the problem with <code>wrapping_offset</code> is that, according to LLVM semantics, it creates a possibly-invalid pointer the moment we touch it, so we probably were wrong to say that it's a no-op to put it back in place.</p>



<a name="276109864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109864">(Mar 21 2022 at 20:36)</a>:</h4>
<p>Rust is <em>extremely</em> willing to say "this is just wrong".</p>
<p>C is not making an honourable stance, they are acknowledging that the C standard has no power and is defacto descriptive of the bajillion compilers in existence which absolutely will not change</p>



<a name="276109880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109880">(Mar 21 2022 at 20:36)</a>:</h4>
<p>Oh mind giving me a link? (Not trying to call you out, genuinely interested in this kinda stuff).</p>



<a name="276109911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109911">(Mar 21 2022 at 20:37)</a>:</h4>
<p>I would have to go digging, my apologies. (if you mean people talking about banning pointer casts)</p>



<a name="276109936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109936">(Mar 21 2022 at 20:37)</a>:</h4>
<p>I mean, you can always have PNVI-ae-udi and then plop down the existing hilarious restrict rules, at very least if you don't care about restrict's optimization potential</p>



<a name="276109977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276109977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276109977">(Mar 21 2022 at 20:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109813">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276106334">said</a>:</p>
<blockquote>
<p>If every update to documentation has to be treated as a strict behavior guarantee forever, then we need to FCP every single documentation change.</p>
</blockquote>
<p>...we kinda do, or at least try to. I've regularly seen both lang and libs FCPs to documentation changes on the basis of "do we want to make this commitment".</p>
<p>That doesn't mean we don't change those commitments, on the crater-based basis of "if breakage happens in a Rust and nobody in <a href="http://crates.io">crates.io</a> is around to hear it, did it really break", but we do at least attempt to review those commitments.</p>
</blockquote>
<p>Although this one will be a really difficult change to trace. After all, it's silently adding UB that does anything at all on all of 1 platform. At least with <code>core::mem::uninitialized()</code> compilers start doing weird stuff everywhere.</p>



<a name="276110043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110043">(Mar 21 2022 at 20:38)</a>:</h4>
<p><em>headtilt</em></p>



<a name="276110046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110046">(Mar 21 2022 at 20:38)</a>:</h4>
<p>I have not seen the links to whatever it is that is supposed to break restrict + PNVI-ae-udi, but it's plausible</p>



<a name="276110058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110058">(Mar 21 2022 at 20:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109846">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276108962">said</a>:</p>
<blockquote>
<p>Again, this is all a bit lost in the weeds. The main problem is that we're trying to deprecate not just fundamental parts of Rust but a fundamental mental model, to support a weird platform, and claiming that this somehow doesn't de facto break backwards compatibility.</p>
</blockquote>
<p>so functionally, the problem with <code>wrapping_offset</code> is that, according to LLVM semantics, it creates a possibly-invalid pointer the moment we touch it, so we probably were wrong to say that it's a no-op to put it back in place.</p>
</blockquote>
<p>yeah I think this is the crux of it. calling it <code>wrapping_</code> suggests modular arithmetic which... I'm not sure LLVM <em>requires</em>?</p>



<a name="276110059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110059">(Mar 21 2022 at 20:38)</a>:</h4>
<p>No no.</p>



<a name="276110123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110123">(Mar 21 2022 at 20:39)</a>:</h4>
<p>I would be very interested in saturating pointer arithmetic (with the top of the address space unmapped just like the null page :P)</p>



<a name="276110137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110137">(Mar 21 2022 at 20:39)</a>:</h4>
<p>The UB is at the point of dereference.</p>



<a name="276110147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110147">(Mar 21 2022 at 20:39)</a>:</h4>
<p>At very least I think we can all agree that all the PNVI stuff is extremely "this is a weird hack that maybe makes things vaguely work" and not "this is a good model we all love"</p>



<a name="276110162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110162">(Mar 21 2022 at 20:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276109522">said</a>:</p>
<blockquote>
<p><del>what if integer overflow was a mistake</del></p>
</blockquote>
<p>I'd be <em>entirely</em> in favor of turning integer overflow checking on by default if we have a hardware implementation that adds near-zero overhead. The argument against it was primarily one of performance.</p>



<a name="276110165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110165">(Mar 21 2022 at 20:39)</a>:</h4>
<p>we require modular arithmetic for actual ints, require that usize is an actual int and the size of a pointer, and if we don't require usize to sanely map to pointer operations I'd call that a spec bug</p>



<a name="276110203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110203">(Mar 21 2022 at 20:39)</a>:</h4>
<p>Honestly I think the central question is how much forgeability we want pointers to have. Keep in mind we still allow (without diagnosis of any kind) transmutes from integers to pointers, which are much more of a mess.</p>



<a name="276110263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110263">(Mar 21 2022 at 20:40)</a>:</h4>
<p><code>usize</code> is <code>size_t</code>/<code>ptraddr_t</code> not <code>uintptr_t</code> under the model in <span class="user-mention" data-user-id="137587">@Gankra</span>'s blog post (which I support) FWIW</p>



<a name="276110321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110321">(Mar 21 2022 at 20:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276108942">said</a>:</p>
<blockquote>
<p>the real problematic code, IMO, is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">];</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">cap</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xs</span><span class="p">.</span><span class="n">into_raw_parts</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">ptr_wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="n">HUGE</span><span class="p">).</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="o">-</span><span class="n">HUGE</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>under optimization.</p>
</blockquote>
<p>added the <code>unsafe</code> blocks I was eliding (or I guess assuming that the code was in the context of one already) to reassert: these are the points at which an <code>unsafe</code> assertion entered the program.</p>



<a name="276110367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110367">(Mar 21 2022 at 20:41)</a>:</h4>
<p>I mean, that there is already a breaking change (or at least blaming the ecosystem when for breaking CHERI when they don't change their code)</p>



<a name="276110382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110382">(Mar 21 2022 at 20:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276110263">said</a>:</p>
<blockquote>
<p><code>usize</code> is <code>size_t</code>/<code>ptraddr_t</code> not <code>uintptr_t</code> under the model in <span class="user-mention silent" data-user-id="137587">Gankra</span>'s blog post (which I support) FWIW</p>
</blockquote>
<p>Please don't make <code>usize</code> into <code>ptraddr_t</code>. Please, anything else. I'll take the 13 cycle overhead for <code>uintptr_t</code> on w65, just don't make <code>p as usize</code> impossible on 8086.</p>



<a name="276110388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110388">(Mar 21 2022 at 20:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276110162">said</a>:</p>
<blockquote>
<p>I'd be <em>entirely</em> in favor of turning integer overflow checking on by default if we have a hardware implementation that adds near-zero overhead. The argument against it was primarily one of performance.</p>
</blockquote>
<p>my opinion is actually the reverse.</p>



<a name="276110470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110470">(Mar 21 2022 at 20:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276110382">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276110263">said</a>:</p>
<blockquote>
<p><code>usize</code> is <code>size_t</code>/<code>ptraddr_t</code> not <code>uintptr_t</code> under the model in <span class="user-mention silent" data-user-id="137587">Gankra</span>'s blog post (which I support) FWIW</p>
</blockquote>
<p>Please don't make <code>usize</code> into <code>ptraddr_t</code>. Please, anything else. I'll take the 13 cycle overhead for <code>uintptr_t</code> on w65, just don't make <code>p as usize</code> impossible on 8086.</p>
</blockquote>
<p>8086 is just not supported by this model, it would require further expansion</p>



<a name="276110487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110487">(Mar 21 2022 at 20:42)</a>:</h4>
<p>there's not much else to say about it, IMO it's offtopic</p>



<a name="276110524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110524">(Mar 21 2022 at 20:42)</a>:</h4>
<p>note that the model in question is a <em>relaxation</em>. we currently effectively require <code>size_t</code> == <code>uintptr_t</code> == <code>ptraddr_t</code> and whatnot</p>



<a name="276110552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110552">(Mar 21 2022 at 20:43)</a>:</h4>
<p>(we may have specified it more imprecisely than that but we simply do not support anything else)</p>



<a name="276110603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110603">(Mar 21 2022 at 20:43)</a>:</h4>
<p>it is a relaxation on implementations, which is an increase in burden on crates</p>



<a name="276110717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110717">(Mar 21 2022 at 20:44)</a>:</h4>
<p>Depends on what those crates want to support.</p>



<a name="276110729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110729">(Mar 21 2022 at 20:44)</a>:</h4>
<p>The portability lint <em>appears</em> to be making good progress, from the POV of someone who's looked at the issue once.</p>



<a name="276110787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110787">(Mar 21 2022 at 20:45)</a>:</h4>
<p>Yeah, half the reason I want to get more precise semantics here is so we know what we actually should lint on.</p>



<a name="276110810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110810">(Mar 21 2022 at 20:45)</a>:</h4>
<p>making a uptr type or whatever is definitely implying "if you don't support these being different that is a failing on your part"</p>



<a name="276110880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110880">(Mar 21 2022 at 20:46)</a>:</h4>
<p>Ehhh we're leaning away from that by this point.</p>



<a name="276110895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110895">(Mar 21 2022 at 20:46)</a>:</h4>
<p>I mean, requiring literally <code>uintptr_t</code> is infeasible on CHERI because they defined <code>uintptr_t</code> to be an integer mimic wrapping a <code>void*</code>, not a real integer type, and it only works in a handwavey sense</p>



<a name="276110911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110911">(Mar 21 2022 at 20:46)</a>:</h4>
<p>I mean that's kind of a community problem to an extent, but we do have crates that say, don't work on ARM, and I don't think this will be any  different.</p>



<a name="276110922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110922">(Mar 21 2022 at 20:46)</a>:</h4>
<p>Right.</p>



<a name="276110923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276110923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276110923">(Mar 21 2022 at 20:46)</a>:</h4>
<p>CHERI C support also tries to do pointer-vs-integer inference in fuzzy ways that Rust mostly doesn't need</p>



<a name="276111012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111012">(Mar 21 2022 at 20:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276110911">said</a>:</p>
<blockquote>
<p>I mean that's kind of a community problem to an extent, but we do have crates that say, don't work on ARM, and I don't think this will be any  different.</p>
</blockquote>
<p>funny thing about that, I am aware of crates meant for wasm that, when I looked at them, didn't stop you from compiling to other targets, but were not concurrency-safe</p>



<a name="276111117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111117">(Mar 21 2022 at 20:48)</a>:</h4>
<p>(the good 'ol "we wanted a thread-local but we didn't bother and instead made an unlocked mutable global")</p>



<a name="276111185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111185">(Mar 21 2022 at 20:48)</a>:</h4>
<p>&lt;_&lt;</p>



<a name="276111194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111194">(Mar 21 2022 at 20:48)</a>:</h4>
<p>so you should be able to turn them into UAFs</p>



<a name="276111233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111233">(Mar 21 2022 at 20:49)</a>:</h4>
<p>frankly I'm accumulating an increased amount of "broken stuff I know about but can't do much about so it just sits in the back of my head", it's unhealthy</p>



<a name="276111282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111282">(Mar 21 2022 at 20:49)</a>:</h4>
<p>(also some of the proposals at least have suggested warn/deprecate/error on ptr/usize casts so those versions would _definitely_ cause breakage)</p>



<a name="276111321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111321">(Mar 21 2022 at 20:50)</a>:</h4>
<p>more relevant to this discussion, 32-bit userspace on 64-bit kernels (or 32-bit w/ PAE) can too easily break the <code>GEPi</code>/<code>&lt;*T&gt;::offset</code> invariants</p>



<a name="276111352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111352">(Mar 21 2022 at 20:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276111282">said</a>:</p>
<blockquote>
<p>(also some of the proposals at least have suggested warn/deprecate/error on ptr/usize casts so those versions would _definitely_ cause breakage)</p>
</blockquote>
<p>that would require an edition change.</p>



<a name="276111414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111414">(Mar 21 2022 at 20:51)</a>:</h4>
<p>(which my article always said)</p>



<a name="276111538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111538">(Mar 21 2022 at 20:52)</a>:</h4>
<p>you need more than 32-bit userspace, you need _x32_ userspace, which is indeed cursed</p>



<a name="276111556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111556">(Mar 21 2022 at 20:52)</a>:</h4>
<p>anyway unlike the concern trolls I am actually prototyping this so we can experiment with this on the ecosystem + miri to understand what the material fallout is</p>



<a name="276111653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111653">(Mar 21 2022 at 20:53)</a>:</h4>
<p>worst case we could keep ptr2int2ptr around on CHERI by doing the good 'ol "global concurrent btree of <code>ptr2int</code>'d pointers" and "just" warning that it will be quite inefficient :P</p>



<a name="276111685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111685">(Mar 21 2022 at 20:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276111538">said</a>:</p>
<blockquote>
<p>you need more than 32-bit userspace, you need _x32_ userspace, which is indeed cursed</p>
</blockquote>
<p>nope, plain i686 Linux on a x64 host can do UB with safe Rust (and I think one <a href="http://crates.io">crates.io</a> dependency?)</p>



<a name="276111710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111710">(Mar 21 2022 at 20:53)</a>:</h4>
<p>I had a hard time weaponizing the UB into a miscompilation and it was 3-4 rabbit hole levels deep so I gave up on it</p>



<a name="276111898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111898">(Mar 21 2022 at 20:54)</a>:</h4>
<p>I... think I would rather simply say that code before <code>format!("edition = \"202{N}\"");</code>does not run on CHERI. &lt;_&lt;</p>



<a name="276111955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276111955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276111955">(Mar 21 2022 at 20:55)</a>:</h4>
<p>anyways, I definitely object to CHERI as a motivating example because a) it hard rules out some solutions and b) it's super special in irretrievable ways that make pandering to it on point a questionable</p>



<a name="276112115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112115">(Mar 21 2022 at 20:55)</a>:</h4>
<p>On that note, where is the work on the portability lint? Would love to see how feasible some of my ideas are before spending this week writing my thoughts down.</p>



<a name="276112172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112172">(Mar 21 2022 at 20:55)</a>:</h4>
<blockquote>
<p>(the good 'ol "we wanted a thread-local but we didn't bother and instead made an unlocked mutable global")</p>
</blockquote>
<p>the <code>gba</code> crate does this but the crate docs clearly ask that you <em>please don't</em></p>



<a name="276112248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112248">(Mar 21 2022 at 20:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276111685">said</a>:<br>
nope, plain i686 Linux on a x64 host can do UB with safe Rust (and I think one <a href="http://crates.io">crates.io</a> dependency?)</p>
<p>Do you have a short summary offhand?</p>



<a name="276112316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112316">(Mar 21 2022 at 20:56)</a>:</h4>
<p><a href="/user_uploads/4715/E0CG8Qk6XUlEOBZqwdyXEgXk/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/E0CG8Qk6XUlEOBZqwdyXEgXk/image.png" title="image.png"><img src="/user_uploads/4715/E0CG8Qk6XUlEOBZqwdyXEgXk/image.png"></a></div>



<a name="276112408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112408">(Mar 21 2022 at 20:56)</a>:</h4>
<p>I was trying to find this again. this is all you need (with the <code>wee_alloc</code> dependency)</p>



<a name="276112475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112475">(Mar 21 2022 at 20:56)</a>:</h4>
<p>ohh, because the &gt;isize allocations can succeed and all the C allocation functions take unsigned</p>



<a name="276112508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112508">(Mar 21 2022 at 20:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112115">said</a>:</p>
<blockquote>
<p>On that note, where is the work on the portability lint? Would love to see how feasible some of my ideas are before spending this week writing my thoughts down.</p>
</blockquote>
<p>I am not sure, to be quite frank. last I checked it was Kinda Stuck.</p>



<a name="276112587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112587">(Mar 21 2022 at 20:57)</a>:</h4>
<p>portability lint stabilizes the release after the never type</p>



<a name="276112590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112590">(Mar 21 2022 at 20:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112408">said</a>:</p>
<blockquote>
<p>I was trying to find this again. this is all you need (with the <code>wee_alloc</code> dependency)</p>
</blockquote>
<p>has the missing guard in Rc not been fixed yet?</p>



<a name="276112602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112602">(Mar 21 2022 at 20:57)</a>:</h4>
<p>I think in that sense it could happen in just 32/32 depending on the kernel code model</p>



<a name="276112674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112674">(Mar 21 2022 at 20:58)</a>:</h4>
<p>as long as the kernel isn't eating 2G that can happen</p>



<a name="276112691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112691">(Mar 21 2022 at 20:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112590">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112408">said</a>:</p>
<blockquote>
<p>I was trying to find this again. this is all you need (with the <code>wee_alloc</code> dependency)</p>
</blockquote>
<p>has the missing guard in Rc not been fixed yet?</p>
</blockquote>
<p>I never reported it because I didn't have time to write an exploit <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="276112735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112735">(Mar 21 2022 at 20:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112602">said</a>:</p>
<blockquote>
<p>I think in that sense it could happen in just 32/32 depending on the kernel code model</p>
</blockquote>
<p>yeah I think you can do almost 4G userspace w/ PAE, and 3G w/o maybe?</p>



<a name="276112766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112766">(Mar 21 2022 at 20:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112508">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276112115">said</a>:</p>
<blockquote>
<p>On that note, where is the work on the portability lint? Would love to see how feasible some of my ideas are before spending this week writing my thoughts down.</p>
</blockquote>
<p>I am not sure, to be quite frank. last I checked it was Kinda Stuck.</p>
</blockquote>
<p><span class="user-mention" data-user-id="310399">@Mara</span> has a credible plan for reviving it in terms of where clauses: <code>where Target: Posix</code> or similar.</p>



<a name="276112839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112839">(Mar 21 2022 at 20:59)</a>:</h4>
<p>ahhh nulary typeclasses aka axioms :D</p>



<a name="276112871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112871">(Mar 21 2022 at 20:59)</a>:</h4>
<p>yeah, I don't remember the state of affairs on 32-bit linux, I know windows has flags for that, but don't recall if they require PAE</p>



<a name="276112925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112925">(Mar 21 2022 at 21:00)</a>:</h4>
<p>I'm super excited to be able to write <code>where Target: Is64Bit</code> or similar at the top of my program, and then <code>let x: usize = some_u64.into()</code> and vice versa.</p>



<a name="276112956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276112956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276112956">(Mar 21 2022 at 21:00)</a>:</h4>
<p>(this trick is p common in proof assistants, and you can often scope them out really nicely)</p>



<a name="276113031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276113031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276113031">(Mar 21 2022 at 21:00)</a>:</h4>
<p>cool we're getting generic modules too then :P?</p>



<a name="276113072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276113072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276113072">(Mar 21 2022 at 21:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276113031">said</a>:</p>
<blockquote>
<p>cool we're getting generic modules too then :P?</p>
</blockquote>
<p>That's the main bit of design work that needs to happen to make the <code>where</code>-based portability mechanism work well. :)</p>



<a name="276113155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276113155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276113155">(Mar 21 2022 at 21:01)</a>:</h4>
<p>I suppose if you don't need to monomorphize over them, just scope some <code>where</code> clauses, it's very easy!</p>



<a name="276113764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276113764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276113764">(Mar 21 2022 at 21:06)</a>:</h4>
<p>(moved my reply to the portability stuff to <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/portability.20lint.20using.20where.20clauses/near/276112839">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/portability.20lint.20using.20where.20clauses/near/276112839</a>)</p>



<a name="276113830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276113830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276113830">(Mar 21 2022 at 21:07)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> (can't figure out how to reply on mobile) what exactly are you prototyping, and how does it relate to Miri?</p>



<a name="276113943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276113943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276113943">(Mar 21 2022 at 21:08)</a>:</h4>
<p>the APIs in my proposal + deprecating all ptr&lt;-&gt;int casts, to see how bad the fallout is and how many changes actual codebases need to compile without warnings</p>



<a name="276114018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114018">(Mar 21 2022 at 21:09)</a>:</h4>
<p>miri should automatically get Perfect Provenance due to all usize -&gt; ptr casts being replaced with</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">with_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// FIXME: I am magic and should be a compiler intrinsic.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// In the mean-time, this operation is defined to be "as if" it was</span>
<span class="w">        </span><span class="c1">// a wrapping_offset, so we can emulate it as such. This should properly</span>
<span class="w">        </span><span class="c1">// restore pointer provenance even under today's compiler.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">self_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">addr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">isize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dest_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">isize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dest_addr</span><span class="p">.</span><span class="n">wrapping_sub</span><span class="p">(</span><span class="n">self_addr</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// This is the canonical desugarring of this operation</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">().</span><span class="n">wrapping_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">).</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276114063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114063">(Mar 21 2022 at 21:09)</a>:</h4>
<p>(assuming I remember that this makes miri happy)</p>



<a name="276114088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114088">(Mar 21 2022 at 21:09)</a>:</h4>
<p>Mmmmmm interesting</p>



<a name="276114164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114164">(Mar 21 2022 at 21:10)</a>:</h4>
<p>my first blocker is that my rustc checkout has corrupted itself because submodules continue to be the worst design in the universe</p>



<a name="276114178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114178">(Mar 21 2022 at 21:10)</a>:</h4>
<p>time to reclone i guess</p>



<a name="276114191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114191">(Mar 21 2022 at 21:10)</a>:</h4>
<p>I'm doing this thing (again) where I run Miri on like 10,000 crates so if you need examples of crates that do things let me know</p>



<a name="276114236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114236">(Mar 21 2022 at 21:11)</a>:</h4>
<p>nice thanks</p>



<a name="276114421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114421">(Mar 21 2022 at 21:12)</a>:</h4>
<p>the ones you probably most want for this are ones that won't work at all under miri though (except for all the helper lib crates, which might or might not)</p>



<a name="276114454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114454">(Mar 21 2022 at 21:12)</a>:</h4>
<p>(or rather, the ones most likely to break and have trouble fixing it)</p>



<a name="276114509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114509">(Mar 21 2022 at 21:13)</a>:</h4>
<p>Even there I have examples <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="276114748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114748">(Mar 21 2022 at 21:14)</a>:</h4>
<p>FWIW, while I made some comments upthread about documentation and committments, I should clarify that I'm entirely in favor of testing and carefully transitioning (over an edition) to a model in which usize is not pointer-sized.</p>



<a name="276114911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114911">(Mar 21 2022 at 21:14)</a>:</h4>
<p>I do still want it to be possible to do pointer tagging and other such tricks, but I like the idea of introducing a new "pointer container" integer type that is capable of doing such operations while making it easier on the compiler to compile that code correctly.</p>



<a name="276114936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114936">(Mar 21 2022 at 21:15)</a>:</h4>
<p><span class="user-mention" data-user-id="143798">@Talchas</span> FWIW I'm sure I would have more of those examples if bindgen didn't just emit UB as a matter of course</p>



<a name="276114955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276114955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276114955">(Mar 21 2022 at 21:15)</a>:</h4>
<p>I think, often, "make that more contained" gets conflated with "make that impossible", and I'm in favor of the former as long as we don't do the latter.</p>



<a name="276115082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115082">(Mar 21 2022 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276114911">said</a>:</p>
<blockquote>
<p>I do still want it to be possible to do pointer tagging and other such tricks, but I like the idea of introducing a new "pointer container" integer type that is capable of doing such operations while making it easier on the compiler to compile that code correctly.</p>
</blockquote>
<p>you would still allowed to do all those things, you just use <code>addr()</code> and <code>with_addr()</code> instead of <code>as usize</code> and <code>as ptr</code></p>



<a name="276115142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115142">(Mar 21 2022 at 21:16)</a>:</h4>
<p>pointer tagging is the trivial part implementation-wise (but also the most defensible), and there's a fine argument for adding it regardless of what the model winds up being</p>



<a name="276115150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115150">(Mar 21 2022 at 21:17)</a>:</h4>
<p>That sounds generally reasonable, modulo "what do you do when you don't have a pointer to call <code>with_addr</code> on".</p>



<a name="276115200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115200">(Mar 21 2022 at 21:17)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="sd">/// Claim that you have "allocated" and have unique access to the range</span>
<span class="w">    </span><span class="sd">/// of memory `address .. address + len * size_of::&lt;T&gt;()`.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// (This is an extremely "shot in the dark" design, but throwing it out</span>
<span class="w">    </span><span class="sd">/// here as a possible sketch of an answer to the problem.)</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// When dealing with low-level situations like memory-mapped peripherals,</span>
<span class="w">    </span><span class="sd">/// the programmer typically needs to just blindly assume a specific address</span>
<span class="w">    </span><span class="sd">/// can be interpretted as a pointer and read/written.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This is a problem for Pointer Provenance and Segmenting, because there</span>
<span class="w">    </span><span class="sd">/// is no "chain of custody" to an allocation. One possible solution to this</span>
<span class="w">    </span><span class="sd">/// is for the programmer to Pretend To Be Malloc and "allocate" the address.</span>
<span class="w">    </span><span class="sd">/// See [`with_addr`] for more details.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// Just as with *real* malloc, the compiler is free to assume the pointer</span>
<span class="w">    </span><span class="sd">/// returned from this function is completely unaliased, and that all accesses</span>
<span class="w">    </span><span class="sd">/// to this range of memory occur *only* from pointers with provenance derived</span>
<span class="w">    </span><span class="sd">/// from this one. These assumptions can be loosened with operations like</span>
<span class="w">    </span><span class="sd">/// [`read_volatile`][] which you were probably going to use already.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This is only sound to do if:</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// * You are actually allowed to access that specified range of memory</span>
<span class="w">    </span><span class="sd">/// * All future accesses to this range of memory are through this pointer</span>
<span class="w">    </span><span class="sd">/// * You never `claim_alloc` this memory again (Maybe? Should we have claim_dealloc?)</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// Basically, pretend you're `malloc` and think about how bad it would be</span>
<span class="w">    </span><span class="sd">/// if `malloc` returned the same pointer twice (without any freeing).</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// This design needs to be workshopped but needless to say it is Extremely</span>
<span class="w">    </span><span class="sd">/// Undefined Behaviour to do wrong things with this.</span>
<span class="w">    </span><span class="cp">#[unstable(feature = </span><span class="s">"robust_pointer_provenance"</span><span class="cp">, issue = </span><span class="s">"99999999"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">claim_alloc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">_len</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// FIXME: I am magic and should be a compiler intrinsic.</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="bp">Self</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276115256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115256">(Mar 21 2022 at 21:18)</a>:</h4>
<p>(well, except for high-bits tagging and models that want to explicitly lowest-common-denominator including CHERI more than "it's obviously platform-defined if any high bits are available")</p>



<a name="276115276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115276">(Mar 21 2022 at 21:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276115082">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276114911">said</a>:</p>
<blockquote>
<p>I do still want it to be possible to do pointer tagging and other such tricks, but I like the idea of introducing a new "pointer container" integer type that is capable of doing such operations while making it easier on the compiler to compile that code correctly.</p>
</blockquote>
<p>you would still allowed to do all those things, you just use <code>addr()</code> and <code>with_addr()</code> instead of <code>as usize</code> and <code>as ptr</code></p>
</blockquote>
<p>I think any model here would have to consider the whole group of pointer-weird platforms.</p>



<a name="276115309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115309">(Mar 21 2022 at 21:18)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> I think that's exactly the right approach for synthesizing a pointer out of nothing. That's not quite the use case I was asking about, but I'm hugely in favor of that as an API for things like "make up an MMIO pointer" or "access a fixed-offset hardware table".</p>



<a name="276115419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115419">(Mar 21 2022 at 21:19)</a>:</h4>
<p>that one is definitely _not_ the model always used, in the sense that it asserts that you don't claim it again</p>



<a name="276115501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115501">(Mar 21 2022 at 21:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276115419">said</a>:</p>
<blockquote>
<p>that one is definitely _not_ the model always used, in the sense that it asserts that you don't claim it again</p>
</blockquote>
<p>I'm reading the "Should we have <code>claim_dealloc</code>" part of that comment with great interest. :)</p>



<a name="276115586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115586">(Mar 21 2022 at 21:21)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> Hypothetically, if we <em>don't</em> have any backwards compatibility constraints at all, and we only have the requirement to make something <em>possible</em> without making it use the <em>same code</em> as it did before, and we're fine with requiring unsafe operations but we need to provide a well-defined non-UB way to do something, what APIs <em>would</em> we want people to use for something like an XOR linked list that stores only one pointer-sized value in each node (plus the data)?</p>



<a name="276115597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115597">(Mar 21 2022 at 21:21)</a>:</h4>
<p>the sketch is useful if only to force the kind of people who "need" it under this model to come out of the woodwork and explain why it is Insufficient</p>



<a name="276115648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115648">(Mar 21 2022 at 21:21)</a>:</h4>
<p>Forget for a moment what horrible cursed things people <em>currently</em> do to implement XOR linked lists and similar. What would be the <em>right</em> way to support those?</p>



<a name="276115709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115709">(Mar 21 2022 at 21:22)</a>:</h4>
<p>xorlist is cursed anyways.</p>



<a name="276115720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115720">(Mar 21 2022 at 21:22)</a>:</h4>
<p>Yeah XOR list is the real "this is seemingly impossible" thing unless you build your XOR list in an ~arena and use the arena ptr to rehydrate your addresses</p>



<a name="276115747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115747">(Mar 21 2022 at 21:22)</a>:</h4>
<p>I don't think you can do xorlist without union provenance? (or cheating and requiring an arena, yeah)</p>



<a name="276115761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115761">(Mar 21 2022 at 21:22)</a>:</h4>
<p>I've heard that in C++ some people used <code>volatile</code> to avoid the compiler eliding the data structure.</p>



<a name="276115774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115774">(Mar 21 2022 at 21:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276115747">said</a>:</p>
<blockquote>
<p>I don't think you can do xorlist without union provenance? (or cheating and requiring an arena, yeah)</p>
</blockquote>
<p>What would union provenance look like for an XOR linked list? (I can guess what it <em>means</em> from the name, but what would the API look like?)</p>



<a name="276115846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115846">(Mar 21 2022 at 21:23)</a>:</h4>
<p>provenance(a xor b) = provenance(a) union provenance(b) (really maybe s/xor/bitop/ at that point)</p>



<a name="276115849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115849">(Mar 21 2022 at 21:23)</a>:</h4>
<p><code>x as *mut T</code></p>



<a name="276115851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115851">(Mar 21 2022 at 21:23)</a>:</h4>
<p>XOR lists are the kind of thing I think of when I think about cursed things people do that don't <em>have</em> to work exactly as they did before but do still need to have some recommended code pattern other than "don't".</p>



<a name="276115878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115878">(Mar 21 2022 at 21:23)</a>:</h4>
<p>provenance tracking size goes to the moon</p>



<a name="276115961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115961">(Mar 21 2022 at 21:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276115846">said</a>:</p>
<blockquote>
<p>provenance(a xor b) = provenance(a) union provenance(b) (really maybe s/xor/bitop/ at that point)</p>
</blockquote>
<p>Also not quite since it's <code>provenance(a xor b) = provenance(a) | provenance(b)</code></p>



<a name="276115963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276115963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276115963">(Mar 21 2022 at 21:24)</a>:</h4>
<p>union find is a good algorithm, it'll be fine, right? (oops SB)</p>



<a name="276116030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116030">(Mar 21 2022 at 21:24)</a>:</h4>
<p>for xorlists to work you need it to actually be union I think</p>



<a name="276116051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116051">(Mar 21 2022 at 21:25)</a>:</h4>
<p>(Union here being the union of possible provenance<strong>s</strong>, not the union of the available provenance)</p>



<a name="276116108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116108">(Mar 21 2022 at 21:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116030">said</a>:</p>
<blockquote>
<p>for xorlists to work you need it to actually be union I think</p>
</blockquote>
<p>Or just straight up PNVI-ae w/ union provenance on backcasting.</p>



<a name="276116174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116174">(Mar 21 2022 at 21:26)</a>:</h4>
<p>I'm pretty sure xorlist is UB in every language you can theoretically write it in that isn't assembly, so IDK if we have to worry about breaking it.</p>



<a name="276116265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116265">(Mar 21 2022 at 21:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116174">said</a>:</p>
<blockquote>
<p>I'm pretty sure xorlist is UB in every language you can theoretically write it in that isn't assembly, so IDK if we have to worry about breaking it.</p>
</blockquote>
<p>I don't subscribe to the "it's UB so we can just break it" theory of compiler design. :)</p>



<a name="276116275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116275">(Mar 21 2022 at 21:26)</a>:</h4>
<p>yeah, I was thinking of PVI unnecessarily</p>



<a name="276116306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116306">(Mar 21 2022 at 21:27)</a>:</h4>
<p>/me looks up and reads the PNVI-ae-udi paper.</p>



<a name="276116335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116335">(Mar 21 2022 at 21:27)</a>:</h4>
<p>(recommendations welcome for the best starting point for that)</p>



<a name="276116439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116439">(Mar 21 2022 at 21:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116335">said</a>:</p>
<blockquote>
<p>(recommendations welcome for the best starting point for that)</p>
</blockquote>
<p>N2676 is the latest one and is pretty approachable (for someone versed in compiler lingo), and is favored by WG14 (or 21 I forget) to move forward, even without any changes.</p>



<a name="276116528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116528">(Mar 21 2022 at 21:29)</a>:</h4>
<p>/me is still of the belief that PNVI-ae w/o union provenance isn't valid for rust b/c of <a href="https://doc.rust-lang.org/nightly/core/ptr/index.html#safety">https://doc.rust-lang.org/nightly/core/ptr/index.html#safety</a></p>



<a name="276116593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116593">(Mar 21 2022 at 21:29)</a>:</h4>
<p>Which part of that</p>



<a name="276116601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116601">(Mar 21 2022 at 21:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116439">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116335">said</a>:</p>
<blockquote>
<p>(recommendations welcome for the best starting point for that)</p>
</blockquote>
<p>N2676 is the latest one and is pretty approachable (for someone versed in compiler lingo), and is favored by WG14 (or 21 I forget) to move forward, even without any changes.</p>
</blockquote>
<p>WG14. WG21 is C++, which last I heard was still clinging onto int2ptr model.</p>



<a name="276116676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116676">(Mar 21 2022 at 21:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116593">said</a>:</p>
<blockquote>
<p>Which part of that</p>
</blockquote>
<p>Access for zero sized allocations being valid for <code>non-zero-const as *mut ()</code></p>



<a name="276116773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116773">(Mar 21 2022 at 21:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276115720">said</a>:</p>
<blockquote>
<p>Yeah XOR list is the real "this is seemingly impossible" thing unless you build your XOR list in an ~arena and use the arena ptr to rehydrate your addresses</p>
</blockquote>
<p>Well... depending on the semantics we decide on for splitting provenance between pointer bytes... You could certainly store the provenance for the next element in the lowest byte and the provenance for the previous element in the next lowest byte and then do some cursed thing for reconstructing the full pointer</p>



<a name="276116830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116830">(Mar 21 2022 at 21:31)</a>:</h4>
<p>(Currently miri errors if you leak an allocation, guess it's address in a constant and cast back, deallocate, then access the new pointer as <code>()</code>)</p>



<a name="276116913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116913">(Mar 21 2022 at 21:32)</a>:</h4>
<p>We could always define an extension to the spec for ZSTs to the tune of everything is valid with proper alignment, but LLVM rears its head.</p>



<a name="276116934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116934">(Mar 21 2022 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> BTW, in response to one item in your blog post, I would be <em>entirely</em> in favor of just adding native syntax to get the field offset of a struct, and once we have that, I don't mind if we break existing ways of writing that as a macro or similar (over an edition boundary).</p>



<a name="276116937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116937">(Mar 21 2022 at 21:32)</a>:</h4>
<p>Same with me, since I'd like consistent semantics for reads in a generic function.</p>



<a name="276116966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116966">(Mar 21 2022 at 21:33)</a>:</h4>
<p>I don't think we need to make it possible to hack offsetof together in a macro the way C does, it's fine if it needs native language support.</p>



<a name="276116993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276116993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276116993">(Mar 21 2022 at 21:33)</a>:</h4>
<p>afaik you can write offsetof fine today with MaybeUninit&lt;T&gt;, no?</p>



<a name="276117054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117054">(Mar 21 2022 at 21:34)</a>:</h4>
<p>it's just that everyone thinks they're very Smart and tries to do it off null because it's so elegant</p>



<a name="276117066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117066">(Mar 21 2022 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116993">said</a>:</p>
<blockquote>
<p>afaik you can write offsetof fine today with MaybeUninit&lt;T&gt;, no?</p>
</blockquote>
<p>As long as your type isn't larger than your stack, sure</p>



<a name="276117084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117084">(Mar 21 2022 at 21:34)</a>:</h4>
<p>sure</p>



<a name="276117093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117093">(Mar 21 2022 at 21:34)</a>:</h4>
<p>With the next beta, memoffset works in const, avoiding the need to have it on the stack.</p>



<a name="276117122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117122">(Mar 21 2022 at 21:34)</a>:</h4>
<p>and in release i would be <em>very</em> surprised if llvm didn't const-fold it all away</p>



<a name="276117136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117136">(Mar 21 2022 at 21:34)</a>:</h4>
<p>But a lot of people are concerned about supply-chain attacks or minimizing dependencies or w/e and handcode offset_of.</p>



<a name="276117139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117139">(Mar 21 2022 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276116993">said</a>:</p>
<blockquote>
<p>afaik you can write offsetof fine today with MaybeUninit&lt;T&gt;, no?</p>
</blockquote>
<p>I'm not sure what the non-UB version looks like exactly.</p>



<a name="276117207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117207">(Mar 21 2022 at 21:35)</a>:</h4>
<p><code>addr_of!((*MaybeUninit&lt;T&gt;::uninit().as_mut_ptr()).field.subfield)</code></p>
<p>I think</p>



<a name="276117208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117208">(Mar 21 2022 at 21:35)</a>:</h4>
<p>I think if there were a native version in the language people wouldn't have any cause to open-code it anymore.</p>



<a name="276117223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117223">(Mar 21 2022 at 21:35)</a>:</h4>
<p>i would not do it as one expression</p>



<a name="276117275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117275">(Mar 21 2022 at 21:36)</a>:</h4>
<p>because I am paranoid about temporaries, but that's the gist</p>



<a name="276117293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117293">(Mar 21 2022 at 21:36)</a>:</h4>
<p>const technically isn't a guarantee though, right? (at very least not without too much pain)<br>
though it's probably good enough</p>



<a name="276117318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117318">(Mar 21 2022 at 21:36)</a>:</h4>
<p>oh whoops sorry you also subtract the pointer from as_mut_ptr</p>



<a name="276117319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117319">(Mar 21 2022 at 21:36)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="o">&lt;</span><span class="cp">$ty</span><span class="o">&gt;</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="p">{</span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">addr_of</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">ptr</span><span class="p">).</span><span class="cp">$field</span><span class="p">)};</span><span class="w"></span>
<span class="n">field</span><span class="p">.</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">().</span><span class="n">offset_from</span><span class="p">(</span><span class="n">ptr</span><span class="p">.</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">())</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</code></pre></div>



<a name="276117323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117323">(Mar 21 2022 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276117207">said</a>:</p>
<blockquote>
<p><code>addr_of!((*MaybeUninit&lt;T&gt;::uninit().as_mut_ptr()).field.subfield)</code></p>
<p>I think</p>
</blockquote>
<p>Ah, of course, why didn't I think of that? (I'd forgotten about <code>addr_of!</code>.)</p>



<a name="276117355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117355">(Mar 21 2022 at 21:36)</a>:</h4>
<p>yeah, builtin would let you dodge all the Deref/Index issues that at least for Deref are doable but are ugly</p>



<a name="276117391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117391">(Mar 21 2022 at 21:37)</a>:</h4>
<p>(With appropriate checks to make sure that <code>(*ptr).$field</code> isn't calling <code>Deref</code>.</p>



<a name="276117594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276117594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276117594">(Mar 21 2022 at 21:39)</a>:</h4>
<p>yeah addr_of! is actually useful and it's good we have it, it's just Jank</p>



<a name="276118966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276118966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276118966">(Mar 21 2022 at 21:52)</a>:</h4>
<p>I think the xorlist trick only works consistently between compilers in practice with the addition of the arena and arena pointer.</p>



<a name="276119557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276119557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276119557">(Mar 21 2022 at 21:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning/near/276115200">said</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="sd">/// Claim that you have "allocated" and have unique access to the range</span>
<span class="w">    </span><span class="sd">/// of memory `address .. address + len * size_of::&lt;T&gt;()`.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// (This is an extremely "shot in the dark" design, but throwing it out</span>
<span class="w">    </span><span class="sd">/// here as a possible sketch of an answer to the problem.)</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// When dealing with low-level situations like memory-mapped peripherals,</span>
<span class="w">    </span><span class="sd">/// the programmer typically needs to just blindly assume a specific address</span>
<span class="w">    </span><span class="sd">/// can be interpretted as a pointer and read/written.</span>
<span class="w">    </span><span class="sd">///</span>
<span class="w">    </span><span class="sd">/// [...]</span>
<span class="w">    </span><span class="cp">#[unstable(feature = </span><span class="s">"robust_pointer_provenance"</span><span class="cp">, issue = </span><span class="s">"99999999"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">claim_alloc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">_len</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// FIXME: I am magic and should be a compiler intrinsic.</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="bp">Self</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am not sure that in practice we wouldn't want to canonize something like a nicer <code>VolAddr</code>, see:<br>
<a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/265#issuecomment-761587844">https://github.com/rust-lang/unsafe-code-guidelines/issues/265#issuecomment-761587844</a></p>



<a name="276121213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276121213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276121213">(Mar 21 2022 at 22:17)</a>:</h4>
<p>Apologies to anyone confused by all the messages suddenly disappearing, this had diverged even further than it already had so I sliced up the subtopics into new threads.</p>



<a name="276122568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276122568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276122568">(Mar 21 2022 at 22:35)</a>:</h4>
<p>So on my quest to find real-world use cases I came across this very cursed thing. On a side note, I really should figure out how to ripgrep GH:</p>
<p><a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2012.htm#clarifying-the-c-memory-object-model-pointer-provenance">http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2012.htm#clarifying-the-c-memory-object-model-pointer-provenance</a></p>
<blockquote>
<p>2.6.1 Q19. Can one make a usable pointer via IO?<br>
This is used in practice: in graphics code for marshalling/unmarshalling (using %p), in xlib (using SCNuPTR), and in debuggers.</p>
</blockquote>



<a name="276122760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276122760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276122760">(Mar 21 2022 at 22:37)</a>:</h4>
<p>I've seen real-world code that walks a data structure, subtracts an offset from every pointer in that data structure, and then serializes the data structure to disk. Then, when reading it back off disk, it adds the offset back to every pointer.</p>



<a name="276122799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276122799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276122799">(Mar 21 2022 at 22:37)</a>:</h4>
<p>IIRC that code <em>effectively</em> used an arena though.</p>



<a name="276122850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276122850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276122850">(Mar 21 2022 at 22:38)</a>:</h4>
<p>oh is this like chrome JS runtime fastboot stuff</p>



<a name="276122894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276122894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276122894">(Mar 21 2022 at 22:38)</a>:</h4>
<p>cuz yeah that apply an offset part sounds a lot like "load it into the big slab of memory for the runtime"</p>



<a name="276122923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276122923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276122923">(Mar 21 2022 at 22:39)</a>:</h4>
<p>in which case the pointers are actually the ones that are offsets and strict-provenance would be quite fine with that</p>



<a name="276123012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276123012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276123012">(Mar 21 2022 at 22:40)</a>:</h4>
<p>Yeah, I didn't anticipate that case being a problem.</p>



<a name="276124372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-%3Eint-%3Eptr%20as%20side%20effect%20destroys%20modular%20reasoning/near/276124372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/ptr-.3Eint-.3Eptr.20as.20side.20effect.20destroys.20modular.20reasoning.html#276124372">(Mar 21 2022 at 22:58)</a>:</h4>
<p>Does provenance apply,  de facto or de jure,  for loads of ZSTs? It would have to be no right, or are we doing the whole there's an allocated object behind each address that could be a ZST?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>