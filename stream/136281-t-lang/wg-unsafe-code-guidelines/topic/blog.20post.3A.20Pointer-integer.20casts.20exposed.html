<html>
<head><meta charset="utf-8"><title>blog post: Pointer-integer casts exposed · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html">blog post: Pointer-integer casts exposed</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278578427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278578427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278578427">(Apr 11 2022 at 16:18)</a>:</h4>
<p>I finally finished writing that blog post that I kept mentioning: <a href="https://www.ralfj.de/blog/2022/04/11/provenance-exposed.html">https://www.ralfj.de/blog/2022/04/11/provenance-exposed.html</a>.<br>
I am sorry that it got so long...</p>



<a name="278586811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278586811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278586811">(Apr 11 2022 at 17:16)</a>:</h4>
<p>Hmm, I'd disagree about <code>union</code> really being all over the place, and if it were just accesses directly through the union I think it would be fine. It would be reasonably straightforward to specify at a source language level rules that could reasonably only stop optimizations when you actually do a pun or are already having the union escape.</p>
<p>But you can take pointers to union members and then you get into the pointer pun issue and so you still lose, just one step beyond what you said in the post (and currently unions get to LLVM just as pointer puns, so you lose there anyways as well).</p>



<a name="278588020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278588020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278588020">(Apr 11 2022 at 17:26)</a>:</h4>
<p>Is it widely agreed that the initial definition of <code>uwu()</code> has defined behaviour in C?</p>



<a name="278589033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278589033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278589033">(Apr 11 2022 at 17:33)</a>:</h4>
<p>it is definitely not UB by the spec's (exceedingly generous) <code>restrict</code> rule, it does no pointer math at <code>uintptr_t</code> (implementation defined iirc), and doesn't go OOB of the original array when doing <code>y-1</code>. <code>restrict</code> pointers are allowed to overlap as long as the execution does not have a write conflict through them.</p>



<a name="278593001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278593001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278593001">(Apr 11 2022 at 17:59)</a>:</h4>
<p>There is a write to the same object through two pointers: <code>x</code> and <code>ptr</code>.  The standard says <code>ptr</code> must be "based on" <code>x</code> in this case, because <code>x</code> is <code>restrict</code> qualified.  Is it?</p>



<a name="278593185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278593185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278593185">(Apr 11 2022 at 18:00)</a>:</h4>
<p>The meaning of "based on" is something like "if the value of <code>x</code> was changed, would the value of <code>ptr</code> be different?"</p>



<a name="278593222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278593222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278593222">(Apr 11 2022 at 18:01)</a>:</h4>
<p>But if the value of <code>x</code> was changed, we would no longer enter that block...</p>



<a name="278594304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278594304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278594304">(Apr 11 2022 at 18:08)</a>:</h4>
<p>I think it would have to, as otherwise something like <code>x[1] = 1; if (x == (void*)0xDEADBEEF) x[1] = 2;</code> wouldn't qualify</p>



<a name="278594502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278594502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278594502">(Apr 11 2022 at 18:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278586811">said</a>:</p>
<blockquote>
<p>Hmm, I'd disagree about <code>union</code> really being all over the place, and if it were just accesses directly through the union I think it would be fine. It would be reasonably straightforward to specify at a source language level rules that could reasonably only stop optimizations when you actually do a pun or are already having the union escape.</p>
<p>But you can take pointers to union members and then you get into the pointer pun issue and so you still lose, just one step beyond what you said in the post (and currently unions get to LLVM just as pointer puns, so you lose there anyways as well).</p>
</blockquote>
<p>yeah I know. it didnt feel worth spelling that all out in the post...</p>



<a name="278594576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278594576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278594576">(Apr 11 2022 at 18:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="306504">Tavian Barnes</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278593222">said</a>:</p>
<blockquote>
<p>But if the value of <code>x</code> was changed, we would no longer enter that block...</p>
</blockquote>
<p>yes. that's exactly why the definition in the C standard is a terrible definition. ;)</p>



<a name="278594649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278594649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278594649">(Apr 11 2022 at 18:11)</a>:</h4>
<p>but if <code>(int*)(uintptr_t)x</code> is <em>not</em> "based on" <code>x</code>, then that means pointer-integer roundtrips are forbidden for <code>restrict</code> pointers. I cant imagine that is anyone's intention.</p>



<a name="278594734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278594734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278594734">(Apr 11 2022 at 18:12)</a>:</h4>
<p>basically, this is the one axiom I am assuming in the post: if I could have used <code>x</code> to do something, then I am also allowed to use <code>(int*)(uintptr_t)x</code> to do the same thing.</p>



<a name="278595038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278595038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278595038">(Apr 11 2022 at 18:14)</a>:</h4>
<p>RIP no cautions</p>



<a name="278595122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278595122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278595122">(Apr 11 2022 at 18:15)</a>:</h4>
<p>someone is looking at my edit diffs? ;)</p>



<a name="278595801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278595801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278595801">(Apr 11 2022 at 18:20)</a>:</h4>
<p>No, spotted a typo and checked if F5 fixed it</p>



<a name="278595823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278595823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278595823">(Apr 11 2022 at 18:20)</a>:</h4>
<p>:D</p>



<a name="278598052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278598052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278598052">(Apr 11 2022 at 18:34)</a>:</h4>
<blockquote>
<p>it becomes near impossible to write a tool like Miri that precisely matches the specification, since Miri cannot possibly implement this “guessing” accurately.</p>
</blockquote>
<p>Why is this? Can't you just give the pointer returned by the <code>i</code>th int2ptr cast the provenance <code>angelic(i)</code>, and then if the pointer is ever used, replace <code>angelic(i)</code> with whatever provenance you need for that particular use, failing if the target provenance hasn't previously been exposed.</p>



<a name="278598743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278598743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278598743">(Apr 11 2022 at 18:38)</a>:</h4>
<p>The problem is there might be more than one legal provenance for the use</p>



<a name="278598839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278598839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278598839">(Apr 11 2022 at 18:39)</a>:</h4>
<p>It could pick up 2 provenences and narrow by further operations still?</p>



<a name="278599035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599035">(Apr 11 2022 at 18:40)</a>:</h4>
<p>Hmm. How can you get multiple provenances?</p>



<a name="278599055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599055">(Apr 11 2022 at 18:41)</a>:</h4>
<p>You very quickly get exponential growth in the state space though. It might never be the case that one of the choices leads to UB, so you have to permanently keep both around</p>



<a name="278599077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599077">(Apr 11 2022 at 18:41)</a>:</h4>
<p>Actually, what is the case with multiple legal provenances?</p>



<a name="278599116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599116">(Apr 11 2022 at 18:41)</a>:</h4>
<p>each of those provenances could invalidate different other provenances I think, so if you want to precisely check things that causes branching states</p>



<a name="278599358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599358">(Apr 11 2022 at 18:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278599035">said</a>:</p>
<blockquote>
<p>Hmm. How can you get multiple provenances?</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="n">p2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Is this `p` or `p2`</span>
<span class="kd">let</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="278599617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599617">(Apr 11 2022 at 18:45)</a>:</h4>
<p>Ah, right, I see. Okay I understand why it is difficult now.</p>



<a name="278599815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599815">(Apr 11 2022 at 18:46)</a>:</h4>
<p>To be clear, I don't see a fundamental reason that this is actually impossible. Like, it totally might be the case that there's some super smart algorithm here that can represent the exponentially many states in some compact way that allows for execution to continue quickly. I just don't know one</p>



<a name="278599887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599887">(Apr 11 2022 at 18:47)</a>:</h4>
<p>Wouldn't both <code>p</code> and <code>p2</code> have the provenance of <code>x</code>'s allocation? Or are you assuming some more fancy provenance model?</p>



<a name="278599910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599910">(Apr 11 2022 at 18:47)</a>:</h4>
<p>I'm assuming SB</p>



<a name="278599927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278599927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278599927">(Apr 11 2022 at 18:48)</a>:</h4>
<p>Which I suppose is that fancy provenance model</p>



<a name="278600039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600039">(Apr 11 2022 at 18:48)</a>:</h4>
<p>Indeed other provenance models might have it easier (although PNVI-ae-udi has the UDI part that causes the same thing just in a slightly harder to hit way)</p>



<a name="278600123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600123">(Apr 11 2022 at 18:49)</a>:</h4>
<p>I had forgotten to take into account that you get a tree of provenances by using SB, and that it wasn't just "which allocation does it come from?"</p>



<a name="278600130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600130">(Apr 11 2022 at 18:49)</a>:</h4>
<p>the main thing I'm not 100% sure about is if you can do some approximation that doesn't detect all UB but is simpler (like letting you use a pointer with provenance for X then Y then X again); the fact that using a pointer for X can invalidate things is the issue though</p>



<a name="278600267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600267">(Apr 11 2022 at 18:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143798">Talchas</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278600130">said</a>:</p>
<blockquote>
<p>the main thing I'm not 100% sure about is if you can do some approximation that doesn't detect all UB but is simpler (like letting you use a pointer with provenance for X then Y then X again); the fact that using a pointer for X can invalidate things is the issue though</p>
</blockquote>
<p>If I'm not mistaken this is what's being done in <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance</a></p>



<a name="278600358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600358">(Apr 11 2022 at 18:51)</a>:</h4>
<p>The proposal there is an under-approximation of SB + Rust-PNVI that allows miri to not completely bail on permissive provenance and also catch all SB UB on strict provenance - again, if I'm not mistaken</p>



<a name="278600720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600720">(Apr 11 2022 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278600123">said</a>:</p>
<blockquote>
<p>I had forgotten to take into account that you get a tree of provenances by using SB, and that it wasn't just "which allocation does it come from?"</p>
</blockquote>
<p>Even if it was just that though, C hits it on pointers that are either at the beginning of one allocation or one-past-the-end of another, and Rust would hit it on even more casts because when you do int2ptr it's not even clear which allocation the pointer belongs to (since there's no requirement to be in bounds)</p>



<a name="278600741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278600741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278600741">(Apr 11 2022 at 18:54)</a>:</h4>
<p>I think there is an error in the "Integer-pointer casts are not pure, either" section. <code>y2copy</code> is presumably a pointer with provenance over <code>i[1]</code>, but it is out of bounds when it is created. You could do this trick in the other direction however, creating a one-past-the-end pointer to <code>i[0]</code> and then subtracting 1 to make it inbounds before reading from it</p>



<a name="278604481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278604481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278604481">(Apr 11 2022 at 19:27)</a>:</h4>
<p>I dont think there is any rule that pointers have to be "in-bounds of their <code>restrict</code> provenance"</p>



<a name="278604493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278604493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278604493">(Apr 11 2022 at 19:27)</a>:</h4>
<p>in fact, I dont think that is even well-defined</p>



<a name="278604525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278604525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278604525">(Apr 11 2022 at 19:27)</a>:</h4>
<p><code>restrict</code> just says that these two pointers cannot be used to access the same memory</p>



<a name="278604670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278604670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278604670">(Apr 11 2022 at 19:28)</a>:</h4>
<p>the following is legal, even though <code>x</code> and <code>y</code> are equal:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">uwu</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="kr">restrict</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">uwu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278608334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278608334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278608334">(Apr 11 2022 at 20:00)</a>:</h4>
<p>when you mentioned in the post that <code>restrict</code> is more complicated than <code>&amp;mut</code>, I was hoping you or someone would point me to a comprehensible description of what it actually means, because I don't really have any concept of what <code>restrict</code> does except by analogy to rust</p>



<a name="278609726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278609726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278609726">(Apr 11 2022 at 20:12)</a>:</h4>
<p>If non-deterministic int-&gt;ptr casts simplify Stacked Borrows vs intptrcast (which I assume is the comparison here)? Does that result in a blog post describing a simplified Stacked Borrows?</p>



<a name="278611213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278611213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278611213">(Apr 11 2022 at 20:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278608334">said</a>:</p>
<blockquote>
<p>when you mentioned in the post that <code>restrict</code> is more complicated than <code>&amp;mut</code>, I was hoping you or someone would point me to a comprehensible description of what it actually means, because I don't really have any concept of what <code>restrict</code> does except by analogy to rust</p>
</blockquote>
<p>I am not aware of any precise description. the C standard tries to be precise but fails at that (IMO).<br>
so the best thing I can offer is: <code>restrict</code> promises that this pointer, and all pointers derived from it, will not be used to perform memory accesses that <em>conflict</em> with any access done by pointers outside of that set. A "conflict" arises when two memory accesses overlap and at least one of them is a write.</p>



<a name="278611348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278611348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278611348">(Apr 11 2022 at 20:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116466">Zoxc</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278609726">said</a>:</p>
<blockquote>
<p>If non-deterministic int-&gt;ptr casts simplify Stacked Borrows vs intptrcast (which I assume is the comparison here)? Does that result in a blog post describing a simplified Stacked Borrows?</p>
</blockquote>
<p>it's just good ol' stacked borrows without <code>Untagged</code> :)</p>



<a name="278612056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278612056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278612056">(Apr 11 2022 at 20:27)</a>:</h4>
<p>I've yet to page in stacked borrows ;)</p>



<a name="278612441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278612441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278612441">(Apr 11 2022 at 20:30)</a>:</h4>
<p>fair ;)</p>



<a name="278612489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278612489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278612489">(Apr 11 2022 at 20:30)</a>:</h4>
<p>but no I am not planning a new SB blog post</p>



<a name="278673734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278673734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278673734">(Apr 12 2022 at 10:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278599815">said</a>:</p>
<blockquote>
<p>To be clear, I don't see a fundamental reason that this is actually impossible. Like, it totally might be the case that there's some super smart algorithm here that can represent the exponentially many states in some compact way that allows for execution to continue quickly. I just don't know one</p>
</blockquote>
<p>The keyword to look for is "state reduction", <a href="https://docs.rs/loom/latest/loom/">loom</a> uses such an approach to compactly represent all the possible thread-interleavings, maybe such techniques could be ported to pointer provenance, too. (although I'm no expert in that area and would not know where to start :D )</p>



<a name="278675298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278675298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278675298">(Apr 12 2022 at 10:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="400735">Pointerbender</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278673734">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed/near/278599815">said</a>:</p>
<blockquote>
<p>To be clear, I don't see a fundamental reason that this is actually impossible. Like, it totally might be the case that there's some super smart algorithm here that can represent the exponentially many states in some compact way that allows for execution to continue quickly. I just don't know one</p>
</blockquote>
<p>The keyword to look for is "state reduction", <a href="https://docs.rs/loom/latest/loom/">loom</a> uses such an approach to compactly represent all the possible thread-interleavings, maybe such techniques could be ported to pointer provenance, too. (although I'm no expert in that area and would not know where to start :D )</p>
</blockquote>
<p>State reduction like techniques might be one approach, but what I meant was that I don't even see a fundamental reason that there can't exist a data structure that can just represent the result of int2ptr operations without increasing the execution time of all future operations</p>



<a name="278699461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278699461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278699461">(Apr 12 2022 at 14:20)</a>:</h4>
<p>that depends a lot on the details of the aliasing model</p>



<a name="278699484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278699484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278699484">(Apr 12 2022 at 14:21)</a>:</h4>
<p>the great thing about the nondet approach is that it is agnostic about the aliasing model</p>



<a name="278699581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278699581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278699581">(Apr 12 2022 at 14:21)</a>:</h4>
<p>so we can first figure out the perfect aliasing model for Rust, knowing that it will at least be coherent also for pointer-integer round-trips, and then we can see if we find algorithms for checking that model that are more efficient</p>



<a name="278699666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog%20post%3A%20Pointer-integer%20casts%20exposed/near/278699666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/blog.20post.3A.20Pointer-integer.20casts.20exposed.html#278699666">(Apr 12 2022 at 14:22)</a>:</h4>
<p>and maybe one of those algorithms is so good that we can make <em>it</em> the official memory model for Rust, even if i has a bit less UB than the nondeterministic approach</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>