<html>
<head><meta charset="utf-8"><title>Max size of a type · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html">Max size of a type</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276730543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276730543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276730543">(Mar 26 2022 at 15:12)</a>:</h4>
<p>So while preparing <a href="https://github.com/rust-lang/miri/pull/2039">https://github.com/rust-lang/miri/pull/2039</a> I realized that the actual check Miri is doing for the "maximal size of a type" is different from what we all expect... Cc <span class="user-mention" data-user-id="137587">@Gankra</span> <span class="user-mention" data-user-id="132829">@Christopher Durham</span> <br>
Specifically, Miri uses <code>tcx.data_layout.obj_size_bound()</code>, which on 64bit systems is 2^47-1, not isize::MAX.</p>



<a name="276730564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276730564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276730564">(Mar 26 2022 at 15:13)</a>:</h4>
<p>I am not sure of the exact role of <code>obj_size_bound</code>, but -- we probably want to stick to isize::MAX, I assume?</p>



<a name="276730853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276730853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276730853">(Mar 26 2022 at 15:20)</a>:</h4>
<p>being consistent is safe yeah. i think it could vaguely be coherent to allow an implementation to not allow some smaller types "as an implementation detail" but that it's probably a more consistent/usable system if that is just handled by the part where you actually try to allocate memory for it and oom/fault</p>



<a name="276730932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276730932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276730932">(Mar 26 2022 at 15:22)</a>:</h4>
<p>anything bigger than a few MB is presumably "I believe you have made a mistake" so once you're up into GB nothing really matters anyway and you might as well pretend it works until they try to allocate</p>



<a name="276730977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276730977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276730977">(Mar 26 2022 at 15:24)</a>:</h4>
<p>*mut T where you're only accessing a prefix or something is the only plausible place where you can get far with such a type</p>



<a name="276731267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731267">(Mar 26 2022 at 15:31)</a>:</h4>
<p>normal brain: use a private field so that this type can't be constructed by external code<br>
expanding brain: use an empty enum so no one can construct it<br>
galaxy brain: make the type contain [u8; isize::MAX] to make it impossible for a variable to even gesture at the possibility of its runtime existence (i.e. with Option&lt;T&gt;)</p>



<a name="276731615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731615">(Mar 26 2022 at 15:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type/near/276730853">said</a>:</p>
<blockquote>
<p>being consistent is safe yeah. i think it could vaguely be coherent to allow an implementation to not allow some smaller types "as an implementation detail" but that it's probably a more consistent/usable system if that is just handled by the part where you actually try to allocate memory for it and oom/fault</p>
</blockquote>
<p>yeah but presumably we shouldnt let implementations make that UB^^</p>



<a name="276731719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731719">(Mar 26 2022 at 15:42)</a>:</h4>
<p>Indeed. This seems like something that would be fairly easy to enforce via static checks (for static/stack/thread allocations) or OOM (for dynamic allocations).</p>



<a name="276731806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731806">(Mar 26 2022 at 15:44)</a>:</h4>
<p>well my only concern is that something somewhere might actually assume <code>obj_size_bound</code> is useful for optimizations</p>



<a name="276731812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731812">(Mar 26 2022 at 15:44)</a>:</h4>
<p>but it seems we generally agree that would be a bug we should fix? and the only bound allowable for optimizations is <code>isize::MAX</code>?</p>



<a name="276731892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731892">(Mar 26 2022 at 15:46)</a>:</h4>
<p>Well, there are some implicit ways that an implementation-specific limit on object sizes could be used for optimization, most notably that <code>p.offset(n)</code> will produce a canonical address on something like x86_64.</p>



<a name="276731917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731917">(Mar 26 2022 at 15:47)</a>:</h4>
<p>But if it's being enforced statically/dynamically (rather than merely assumed), then it shouldn't be a problem to assume in that case.</p>



<a name="276731985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731985">(Mar 26 2022 at 15:49)</a>:</h4>
<p>I do think it's reasonable to assume that an object that could not possible exist in memory does not, in fact, exist in memory.</p>



<a name="276731986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731986">(Mar 26 2022 at 15:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type/near/276731892">said</a>:</p>
<blockquote>
<p>Well, there are some implicit ways that an implementation-specific limit on object sizes could be used for optimization, most notably that <code>p.offset(n)</code> will produce a canonical address on something like x86_64.</p>
</blockquote>
<p>yes and what I am saying is it would be a bug to assume obj_size_bound when optimizing <code>offset</code></p>



<a name="276731993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731993">(Mar 26 2022 at 15:49)</a>:</h4>
<p>unless we have some other way of knowing that no allocation that large can exist</p>



<a name="276731998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276731998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276731998">(Mar 26 2022 at 15:49)</a>:</h4>
<p>but the burden of proof for that is on the compiler, not the programmer</p>



<a name="276732061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276732061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276732061">(Mar 26 2022 at 15:50)</a>:</h4>
<p>The easiest example would be on w65, if <code>{u,i}size</code> has to be 32-bits like pointers. It's fairly clear that a 2^31 byte object cannot exist on a platform with a 24-bit address bus.</p>



<a name="276732063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276732063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276732063">(Mar 26 2022 at 15:50)</a>:</h4>
<p>the compiler can always do whatever it wants when it can prove it correct. :) the only part we have to talk about is the part that it expects <em>the programmer</em> to prove.</p>



<a name="276732090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276732090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276732090">(Mar 26 2022 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type/near/276731993">said</a>:</p>
<blockquote>
<p>unless we have some other way of knowing that no allocation that large can exist</p>
</blockquote>
<p>We'll I'd just assume that <code>max_obj_size</code> would be the provably maxmimum size for objects on the platform.</p>



<a name="276732199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276732199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276732199">(Mar 26 2022 at 15:53)</a>:</h4>
<p>sure, as long as you as compiler author take responsibility for that and never blame your users if it turns out wrong :)</p>



<a name="276808574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276808574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276808574">(Mar 27 2022 at 21:22)</a>:</h4>
<p>hm, there is an odd comment in the <code>Size</code> type that makes me unsure if we can use it to represent isize::MAX on 64bit targets...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Size</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// The top 3 bits are ALWAYS zero.</span>
<span class="w">    </span><span class="n">raw</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> any idea what that is about?</p>



<a name="276808659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276808659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276808659">(Mar 27 2022 at 21:24)</a>:</h4>
<p>looks like it was added in this PR <a href="https://github.com/rust-lang/rust/pull/80042">https://github.com/rust-lang/rust/pull/80042</a></p>



<a name="276809774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276809774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276809774">(Mar 27 2022 at 21:48)</a>:</h4>
<p>this has big llvm energy</p>



<a name="276809779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276809779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276809779">(Mar 27 2022 at 21:48)</a>:</h4>
<p>extremely practical but also fuuuuck consistency</p>



<a name="276814555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max%20size%20of%20a%20type/near/276814555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Max.20size.20of.20a.20type.html#276814555">(Mar 27 2022 at 23:55)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95388">https://github.com/rust-lang/rust/pull/95388</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>