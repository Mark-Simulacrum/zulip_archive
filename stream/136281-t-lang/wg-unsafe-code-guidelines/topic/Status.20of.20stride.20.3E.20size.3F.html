<html>
<head><meta charset="utf-8"><title>Status of stride &gt; size? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html">Status of stride &gt; size?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278649074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278649074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> alercah <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278649074">(Apr 12 2022 at 05:11)</a>:</h4>
<p>So I have had the "pleasure" in recent memory of being in several conversations that ended up coming back to the topic of whether stride of an array could ever be greater than the array's type, pointing in particular to the possibility that structs and tuples could end up having an effective data size smaller than their alignment. Effectively dropping padding.</p>



<a name="278649140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278649140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> alercah <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278649140">(Apr 12 2022 at 05:13)</a>:</h4>
<p>Is this not precluded by <code>size_of</code>'s docs, though, which explicitly <em>define</em> the size of a time as being its stride?</p>



<a name="278649144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278649144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> alercah <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278649144">(Apr 12 2022 at 05:13)</a>:</h4>
<p><a href="https://doc.rust-lang.org/stable/std/mem/fn.size_of.html">https://doc.rust-lang.org/stable/std/mem/fn.size_of.html</a></p>



<a name="278649230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278649230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> alercah <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278649230">(Apr 12 2022 at 05:15)</a>:</h4>
<p>As far as I can tell, the only two paths to making stride &gt; size would be:</p>
<ol>
<li>Break the current contract of <code>size_of</code>, which is probably unacceptable due to stability guarantee (I have a hard time envisioning a migration path, sadly).</li>
<li>Deprecate <code>size_of</code> as-is because it's really <code>stride_of</code>, and declare UB any code which foolishly believes it actually represents the true data size of <code>T</code></li>
</ol>



<a name="278649472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278649472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> alercah <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278649472">(Apr 12 2022 at 05:20)</a>:</h4>
<p>Note that <code>std::alloc::Layout</code> doesn't make the same mistake in its design, but when provided with a specific type in its implementation for a particular type <code>T</code> it does use <code>size_of</code>.</p>



<a name="278649486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278649486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> alercah <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278649486">(Apr 12 2022 at 05:21)</a>:</h4>
<p>I would love for there to be a path to change this, but I'm not sure I see a good one.</p>



<a name="278650708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278650708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278650708">(Apr 12 2022 at 05:49)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/std/array/fn.from_mut.html">https://doc.rust-lang.org/nightly/std/array/fn.from_mut.html</a> is stable, which most directly means that said requirement has to apply for anything where you have a reference</p>



<a name="278650808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278650808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278650808">(Apr 12 2022 at 05:50)</a>:</h4>
<p>As you say, changing this is effectively impossible because existing unsafe code depends on being able to read/write <code>sizeof(T)</code> bytes behind a pointer or reference to <code>T</code>.</p>



<a name="278651037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278651037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278651037">(Apr 12 2022 at 05:55)</a>:</h4>
<p>The only feasible thing that we can do, I think, is have a "sufficient copy length" API that tells people "well, you can copy this N-byte prefix instead of the full <code>size_of</code> for this type/value, if you want".  (Or it could be more generally "these subranges", at code of a much more complex API.)</p>
<p>Then that could be used to copy less sometimes, but one still couldn't <em>allocate</em> less, because code would always be able to copy the full <code>size_of</code>.</p>



<a name="278651126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278651126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278651126">(Apr 12 2022 at 05:57)</a>:</h4>
<p>(Well, there's the "just make all existing code invalid" cop-out of a <code>?SizeEqualStride</code> thing, but lang really doesn't want any more of those, and I don't think saving a few bytes of padding occasionally comes anywhere close to being important enough to do it.)</p>



<a name="278678244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278678244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278678244">(Apr 12 2022 at 11:19)</a>:</h4>
<p>I also don't see a reason to allow this.<br>
This could not be taken advantage of for <code>repr(C)</code>, so thus only <code>repr(Rust)</code>, thus it would be an implementation's choice whether to have a type with size &lt; stride, and I can't really see many implementations even having the machinery to support it, let alone utilising it.</p>



<a name="278678344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278678344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278678344">(Apr 12 2022 at 11:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F/near/278651126">said</a>:</p>
<blockquote>
<p>(Well, there's the "just make all existing code invalid" cop-out of a <code>?SizeEqualStride</code> thing, but lang really doesn't want any more of those, and I don't think saving a few bytes of padding occasionally comes anywhere close to being important enough to do it.)</p>
</blockquote>
<p>I also think my point makes that even more problematic, since whether or not a type satisfies the bound is not only a question of the definition of the struct, but also the implementation.</p>



<a name="278701088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278701088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278701088">(Apr 12 2022 at 14:32)</a>:</h4>
<p>also see <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/306">https://github.com/rust-lang/unsafe-code-guidelines/issues/306</a>, <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/176">https://github.com/rust-lang/unsafe-code-guidelines/issues/176</a></p>



<a name="278701128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278701128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278701128">(Apr 12 2022 at 14:32)</a>:</h4>
<p>I dont have a strong opinion myself, other than that I'd prefer if we made <em>some</em> proper decision on this :D</p>



<a name="278738371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status%20of%20stride%20%3E%20size%3F/near/278738371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dante Broggi <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Status.20of.20stride.20.3E.20size.3F.html#278738371">(Apr 12 2022 at 19:04)</a>:</h4>
<p>One thing of note is that Swift 5's defined ABI includes a layout algorithm which distinguishes size and stride.<br>
However, Swift also uses stride (min 1) when allocating and laying out <code>Array</code>(<code>Vec</code>) elements.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>