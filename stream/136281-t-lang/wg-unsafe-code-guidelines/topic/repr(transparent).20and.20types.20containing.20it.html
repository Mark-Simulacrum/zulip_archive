<html>
<head><meta charset="utf-8"><title>repr(transparent) and types containing it · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html">repr(transparent) and types containing it</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271556535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271556535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271556535">(Feb 11 2022 at 10:27)</a>:</h4>
<blockquote>
<p>However remember that a type containing a <code>MaybeUninit&lt;T&gt;</code> is not necessarily the same layout;</p>
</blockquote>
<p>Though as far as I understand there is are exceptions to it as a implicit consequence of the guarantees it gives.</p>
<p>We probably should document that, as far as I know it holds for following types (<code>MT</code> = <code>T</code> or <code>MaybeUninit&lt;T&gt;</code>):</p>
<ul>
<li>allocation, mainly <code>Box&lt;MT&gt;</code> (only if <code>T: Sized</code>??)</li>
<li><code>[MT; N]</code> and as consequence <code>[MT]</code> and <code>Vec&lt;MT&gt;</code> used for vecs unstable uninit apis</li>
</ul>
<p>Is that correct? Did I miss anything?</p>



<a name="271558784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271558784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271558784">(Feb 11 2022 at 10:49)</a>:</h4>
<p>Also is the assumtion correct that this also upholds for types containing the listed types, e.g. <code>Box&lt;[T]&gt;</code> having guaranteed same layout as <code>Box&lt;[MyabeUninit&lt;T&gt;]&gt;</code>?</p>



<a name="271583721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271583721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271583721">(Feb 11 2022 at 14:25)</a>:</h4>
<p>MaybeUninit&lt;T&gt; must be the same layout as T because of repr(transparent), yes.</p>
<p>If the quote meant that a generic type with repr(rust) could somehow have separate layouts for TheStruct&lt;T&gt; compared to TheStruct&lt;MaybeUninit&lt;T&gt;&gt;, that part is also true.</p>



<a name="271586663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271586663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271586663">(Feb 11 2022 at 14:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209646">Philipp Korber</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/repr.28transparent.29.20and.20types.20containing.20it/near/271558784">said</a>:</p>
<blockquote>
<p>Also is the assumtion correct that this also upholds for types containing the listed types, e.g. <code>Box&lt;[T]&gt;</code> having guaranteed same layout as <code>Box&lt;[MyabeUninit&lt;T&gt;]&gt;</code>?</p>
</blockquote>
<p>No. It really doesn't. Likewise, it doesn't guarantee it for <code>Vec&lt;MT&gt;</code>. The layout of <code>[MaybeUninit&lt;T&gt;]</code> and <code>[T]</code> are the same (matches the underlying array), but this doesn't extend to pointers to such types. You can't transmute between <code>&amp;[MaybeUninit&lt;T&gt;]</code> and <code>&amp;[T]</code> or the other way arround,  but you can decompose the slice using <code>as_ptr()</code> and <code>len()</code> or <code>&lt;*const [T]&gt;::into_raw_parts</code> (unstable), then perform the pointer cast, and reconstruct into the appropriate type using <code>core::slice::from_raw_parts</code> or <code>core::ptr::slice_from_raw_parts</code> (or <code>core::ptr::from_raw_parts</code>).<br>
Likewise for <code>Vec</code>: You can't just blindly transmute, but you can deconstruct it into raw parts, then reconstruct a new one.</p>



<a name="271587104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271587104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271587104">(Feb 11 2022 at 14:51)</a>:</h4>
<p>Also note that just because the standard library relies on some layout detail, does not mean that user code can. The standard library is directly intertwined with the compiler, and can rely on said compiler doing what it wants.</p>



<a name="271593728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271593728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271593728">(Feb 11 2022 at 15:39)</a>:</h4>
<p>(note that current rustc does work in practice with a direct transmute between slice types of a repr(transparent) type and the inner type, it just isn't <strong>guaranteed</strong> to always work properly in future rustc versions)</p>



<a name="271597075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271597075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271597075">(Feb 11 2022 at 16:02)</a>:</h4>
<p>For example Option&lt;&amp;T&gt; and Option&lt;MaybeUninit&lt;&amp;T&gt;&gt; can't have the same layout due to an uninit value potentially being the niche used for None.</p>



<a name="271597236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271597236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271597236">(Feb 11 2022 at 16:02)</a>:</h4>
<p>Then is <code>Box::new(MaybeUninit::&lt;T&gt;::unit())</code> which is not transmuted but ptr-cast and then later dropped as an <code>Box&lt;T&gt;</code> sound?</p>
<p>Because that is way more ergonomic then directly interacting with the allocation API.</p>



<a name="271597497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271597497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271597497">(Feb 11 2022 at 16:04)</a>:</h4>
<p>if you don't initialize it, no. if you do I would expect it to be sound. not sure about what we guarantee though.</p>



<a name="271597616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271597616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271597616">(Feb 11 2022 at 16:05)</a>:</h4>
<p>yes, initialized <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  Else that would be an problem.</p>



<a name="271598189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271598189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271598189">(Feb 11 2022 at 16:09)</a>:</h4>
<p>If <code>[T;1]</code> is guaranteed to have the same layout as <code>T</code> (at least in absence of things like <code>packed</code>) and  if <code>[MaybeUninit&lt;T&gt;]</code> is guaranteed to have the same layout as <code>[T]</code> then I guess it needs to be sound <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> Not sure about the first part though.</p>



<a name="271598258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271598258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Korber <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271598258">(Feb 11 2022 at 16:09)</a>:</h4>
<p>thanks btw.</p>



<a name="271608612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr%28transparent%29%20and%20types%20containing%20it/near/271608612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/repr(transparent).20and.20types.20containing.20it.html#271608612">(Feb 11 2022 at 17:23)</a>:</h4>
<p>Also, in general <code>Foo&lt;T&gt;</code> can hold a <code>&lt;T as SomeTrait&gt;::AssocType</code>, so <code>Foo&lt;T&gt;</code> and <code>Foo&lt;U&gt;</code> can be arbitrarily different regardless of any similarities between <code>T</code> and <code>U</code>.</p>
<p>For arrays, though, <code>[T; 1]</code> is definitely the same as <code>T</code> in layout.  There's a couple of ways to see that -- one is via <a href="https://doc.rust-lang.org/nightly/std/slice/fn.from_ref.html">https://doc.rust-lang.org/nightly/std/slice/fn.from_ref.html</a> + <code>TryInto&lt;&amp;[T;1]&gt;</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>