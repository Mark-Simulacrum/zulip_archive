<html>
<head><meta charset="utf-8"><title>calling conventions that handle int+ptr different? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html">calling conventions that handle int+ptr different?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276797780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276797780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276797780">(Mar 27 2022 at 17:09)</a>:</h4>
<p>FFI is a struggle for strict-provenance whenever system APIs freely pun ints and pointers. </p>
<p>The "obvious" solution to this is to just fix the signature on the Rust side so Rust understands Pointers Are Happening. On all the ABIs and Calling Conventions <em>I</em> know, a pointer-sized-integer and an actual pointer have identical ABIs in the standard calling conventions, making this fixup perfectly fine.</p>
<p>It would be good to know on what platforms/conventions this trick does/doesn't work, as that determines how viable it is. CHERI is exempt from this discussion because if it has wrong signatures then the OS is busted and not our problem.</p>



<a name="276798125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798125">(Mar 27 2022 at 17:17)</a>:</h4>
<p>WASM has <code>funcref</code> type IIRC.</p>



<a name="276798242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798242">(Mar 27 2022 at 17:20)</a>:</h4>
<p>The SNES-Dev abi for w65 currently treats the pointer-sized integer (u32) and pointers as having different alignment requirements, which impacts the abi when parameters spill to the stack. This may or may not be changed, though (except on lccc, which has been designed with this in mind, it seems that making that work may be more trouble than its worth).</p>



<a name="276798361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798361">(Mar 27 2022 at 17:23)</a>:</h4>
<p>Yeah, never mind. WASM arguments are <code>I32 | i64 | f32 | f64</code> and function pointers are passed through as i32.</p>



<a name="276798437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798437">(Mar 27 2022 at 17:25)</a>:</h4>
<p>Though the draft expands the set to include reftypes too: <a href="https://webassembly.github.io/spec/core/bikeshed/#syntax-valtype">https://webassembly.github.io/spec/core/bikeshed/#syntax-valtype</a></p>



<a name="276798560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798560">(Mar 27 2022 at 17:28)</a>:</h4>
<p>I believe it may also be tautologically true that this works for all conventions Rust supports, because I vaguely recall the code we use for actually computing the way to pass args explicitly just says a pointer has Integer Type Kind</p>



<a name="276798563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798563">(Mar 27 2022 at 17:28)</a>:</h4>
<p>So if you do end up with a module which says that a function signature is a funcref and another that specifies <code>i32</code>, module validation/linking/etc will fail.</p>



<a name="276798649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276798649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276798649">(Mar 27 2022 at 17:30)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span> who wrote a lot of this code, iirc</p>



<a name="276799931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276799931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276799931">(Mar 27 2022 at 18:02)</a>:</h4>
<p>yeah there is some conflation in e.g. RegKind only having Int|Float|Vector: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/abi/call/mod.rs#L136">https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/abi/call/mod.rs#L136</a></p>



<a name="276799942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276799942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276799942">(Mar 27 2022 at 18:03)</a>:</h4>
<p>but it's possible an ABI could e.g. always pass pointers on the stack</p>



<a name="276800017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276800017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276800017">(Mar 27 2022 at 18:05)</a>:</h4>
<p>(eddyb is explaining this is more complex to me... ABIs are messes who would have guessed)</p>



<a name="276800438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276800438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276800438">(Mar 27 2022 at 18:14)</a>:</h4>
<p>(eddyb agrees they have never seen an ABI where just Fixing The Extern would actually mess up the FFI)</p>



<a name="276800847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276800847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276800847">(Mar 27 2022 at 18:24)</a>:</h4>
<p>for struct layout you'd need to switch some ints to union { int; pointer } after bindgen, but that's doable of course</p>



<a name="276801951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276801951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276801951">(Mar 27 2022 at 18:49)</a>:</h4>
<p>I think you can/should just make them only "pointer", making non-aggregates into aggregates is... sketchier (not 100% sure how unions get classified)</p>



<a name="276802867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276802867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276802867">(Mar 27 2022 at 19:10)</a>:</h4>
<p>that would /actually/ break the layout for the "use u64 for pointers so that the syscall can be the same on 32bit" kernel ones</p>



<a name="276803056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276803056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276803056">(Mar 27 2022 at 19:15)</a>:</h4>
<p>Oh! yes sorry very good point</p>



<a name="276803301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276803301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276803301">(Mar 27 2022 at 19:21)</a>:</h4>
<p>yeah, in general going to union is potentially sketchy for ABI</p>



<a name="276803306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276803306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276803306">(Mar 27 2022 at 19:21)</a>:</h4>
<p>but for these uses is almost certainly more correct</p>



<a name="276803384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276803384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276803384">(Mar 27 2022 at 19:23)</a>:</h4>
<p>It might still be worth providing a Blessed/Magic Ptr64, Ptr128, etc type to express this in a way that doesn't mess with ABI ever</p>



<a name="276804635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276804635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276804635">(Mar 27 2022 at 19:54)</a>:</h4>
<p>I asked some of my C friends and also found that there were APIs that did the whole use an integer for ABI, but made it 32bit. And you need to get a properly low pointer to pass it. Sigh. Luckily I think it's just a library API and not a platform one.</p>



<a name="276804714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276804714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276804714">(Mar 27 2022 at 19:56)</a>:</h4>
<p>Actually, if they get the proper low pointer from elsewhere they might just be fine, since that pointer can carry the provenance</p>



<a name="276805292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276805292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276805292">(Mar 27 2022 at 20:09)</a>:</h4>
<p>I mean, you have a valid pointer already whether it's low-required or not; the question is about getting it to C (and for io_uring or similar things, getting it back from C)</p>



<a name="276805306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276805306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276805306">(Mar 27 2022 at 20:09)</a>:</h4>
<p>(and in the latter case "you can store the pointer elsewhere" is not a solution; PtrN types are)</p>



<a name="276805393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276805393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276805393">(Mar 27 2022 at 20:11)</a>:</h4>
<p>(the PtrN types of course being equivalent to bN byte types or other sorts of limited PVI, though limiting it to FFI might let you cheat)</p>



<a name="276805396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276805396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276805396">(Mar 27 2022 at 20:11)</a>:</h4>
<p>I just really hope no one is a smartass and wants the pointer part in the high bits</p>



<a name="276811470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811470">(Mar 27 2022 at 22:31)</a>:</h4>
<p>Wait till you see somebody shifting pointers…</p>



<a name="276811804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811804">(Mar 27 2022 at 22:41)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> oh you mean rustc? <a href="https://github.com/rust-lang/rust/blob/ab0c2e18dceb7140626a158affb983ae81039bd0/compiler/rustc_data_structures/src/tagged_ptr/copy.rs#L67">https://github.com/rust-lang/rust/blob/ab0c2e18dceb7140626a158affb983ae81039bd0/compiler/rustc_data_structures/src/tagged_ptr/copy.rs#L67</a></p>



<a name="276811860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811860">(Mar 27 2022 at 22:42)</a>:</h4>
<p>This is shifting in the wrong direction <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="276811876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811876">(Mar 27 2022 at 22:43)</a>:</h4>
<p>i mean either way seems equally fucked up lol</p>



<a name="276811942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811942">(Mar 27 2022 at 22:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/276805396">said</a>:</p>
<blockquote>
<p>I just really hope no one is a smartass and wants the pointer part in the high bits</p>
</blockquote>
<p>i do this sometimes but just via #[rep(align(N))], it might not be what you mean though</p>



<a name="276811953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811953">(Mar 27 2022 at 22:45)</a>:</h4>
<p>yeah i mean like, they have a 32-bit pointer and store it in 64-bit int by doing <code>ptr as u64</code> &lt;&lt; 32</p>



<a name="276811993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811993">(Mar 27 2022 at 22:46)</a>:</h4>
<p>which like, is a decision you can make</p>



<a name="276811995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811995">(Mar 27 2022 at 22:46)</a>:</h4>
<p>i have done it with #[repr(align(256))] to stick a whole byte in there and then read that byte separately, but that code was UB (for more reasons than just this)</p>



<a name="276811998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276811998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276811998">(Mar 27 2022 at 22:46)</a>:</h4>
<p>oh, yeah, i see</p>



<a name="276812011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812011">(Mar 27 2022 at 22:47)</a>:</h4>
<p>i suppose that byte trick wouldn't work anymore, since its morally a ptr/int transmute. the only case i can think of where you "need" to do this is a mixed-size atomic access though</p>



<a name="276812016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812016">(Mar 27 2022 at 22:47)</a>:</h4>
<p>which is forbidden on x86 (... where it works perfectly and the linux kernel's spinlocks use it so it probably cant break)</p>



<a name="276812055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812055">(Mar 27 2022 at 22:48)</a>:</h4>
<p>mixed-size atomic? 0.o</p>



<a name="276812064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812064">(Mar 27 2022 at 22:49)</a>:</h4>
<p>yeah basically where you turn a AtomicFoo into an [AtomicU8; size_of::&lt;AtomicFoo&gt;()]</p>



<a name="276812065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812065">(Mar 27 2022 at 22:49)</a>:</h4>
<p>and read one of the bytes</p>



<a name="276812071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812071">(Mar 27 2022 at 22:49)</a>:</h4>
<p>...huh</p>



<a name="276812072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812072">(Mar 27 2022 at 22:49)</a>:</h4>
<p>in this case AtomicFoo is AtomicPtr&lt;T&gt; where T is #[repr(align(256))]</p>



<a name="276812073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812073">(Mar 27 2022 at 22:49)</a>:</h4>
<p>and then the bottom byte is read as a AtomicU8</p>



<a name="276812076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812076">(Mar 27 2022 at 22:49)</a>:</h4>
<p>anyway i dont expect this to be allowed</p>



<a name="276812079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812079">(Mar 27 2022 at 22:50)</a>:</h4>
<p>it literally is forbidden by the x86 arch manual</p>



<a name="276812123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812123">(Mar 27 2022 at 22:50)</a>:</h4>
<p>lmao</p>



<a name="276812129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812129">(Mar 27 2022 at 22:50)</a>:</h4>
<p>(even though it works and is used everywhere)</p>



<a name="276812130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812130">(Mar 27 2022 at 22:50)</a>:</h4>
<p>"I am the kernel i win arguments with even the cpu vendor"</p>



<a name="276812141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812141">(Mar 27 2022 at 22:50)</a>:</h4>
<p>libstdc++ merged a patch that used it recently to optimize shared pointers</p>



<a name="276812148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812148">(Mar 27 2022 at 22:51)</a>:</h4>
<p>according to <a href="https://twitter.com/davidtgoldblatt/status/1501725130765975553">https://twitter.com/davidtgoldblatt/status/1501725130765975553</a> the fact that it's disallowed even came up in review</p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/davidtgoldblatt/status/1501725130765975553"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/10505c6822ea679ab52748ead753f0100140a004/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f3837393536393934323638343734353732382f39757553387934565f6e6f726d616c2e6a7067"></a><p><a href="https://twitter.com/at_tcsc">@at_tcsc</a> Yeah, I think you're right that it's officially disallowed (we talked about it in review too IIRC). I always end up being OK with this sort of thing because:
- It's too widely used for Intel to break without breaking the world
- I think the real intent of that section is to (1/2)</p><span>- David Goldblatt (@davidtgoldblatt)</span></div></div>



<a name="276812246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812246">(Mar 27 2022 at 22:53)</a>:</h4>
<p>hmm interesting, I'm surprised this is compelling in Rust given ownership lets you avoid the kind of pointless traffic that Swift is constantly weeping over</p>



<a name="276812291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812291">(Mar 27 2022 at 22:54)</a>:</h4>
<p>i'm not sure it actually is that compelling in rust</p>



<a name="276812329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812329">(Mar 27 2022 at 22:55)</a>:</h4>
<p>that said for async code you often need Arc&lt;T&gt; even if the synch version of the api would be &amp;T</p>



<a name="276812347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812347">(Mar 27 2022 at 22:56)</a>:</h4>
<p>just to avoid the pain of lifetime shenanigans with futures</p>



<a name="276812379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812379">(Mar 27 2022 at 22:56)</a>:</h4>
<p>sounds believable, yeah</p>



<a name="276812380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812380">(Mar 27 2022 at 22:56)</a>:</h4>
<p>and more generally Arc is heavily used in async code</p>



<a name="276812396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812396">(Mar 27 2022 at 22:57)</a>:</h4>
<p>i just expect "just kinda getting my job done"-quality rust code to have an order of magnitude less ARC traffic than equivalent C++ (and maybe Swift) for the same reason I've come to expect that for String vs std::string copies</p>



<a name="276812453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812453">(Mar 27 2022 at 22:58)</a>:</h4>
<p>hm, depends on the codebase. some places refcounting is more heavily used than others</p>



<a name="276812603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812603">(Mar 27 2022 at 23:01)</a>:</h4>
<p>specifically here I mean that C++/Swift will Do What I Mean lots of "needless" refcount traffic because it's genuinely pretty hard to notice all that places where implicit copy/assign ctors show up and properly insert the std::moves -- and even if you can you might decide not to for the sake of defense in depth against complicated pointer bugs. whereas in rust you are doing trivial moves by default and can pretty confidently just mess with references wherever and know the compiler has your back (and the clone being explicit makes you "feel bad" for using it)</p>



<a name="276812669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812669">(Mar 27 2022 at 23:02)</a>:</h4>
<p>maybe this effect is more dramatic with Strings because string_view stuff is relatively new and messy tho (and cstrings don't like being subsliced), while rust slices are very first-class</p>



<a name="276812833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812833">(Mar 27 2022 at 23:06)</a>:</h4>
<p>anyway i mostly said that offhand</p>



<a name="276812835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812835">(Mar 27 2022 at 23:06)</a>:</h4>
<p>in the tweet</p>



<a name="276812844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276812844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276812844">(Mar 27 2022 at 23:07)</a>:</h4>
<p>it's possible it's not as compelling for us. i think its certainly not compelling enouhg to go against something the cpu vendor says, even if it Works In Practice</p>



<a name="276813709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276813709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276813709">(Mar 27 2022 at 23:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/276812079">said</a>:</p>
<blockquote>
<p>it literally is forbidden by the x86 arch manual</p>
</blockquote>
<p>wait really? that seems like a cheap cap-out^^</p>



<a name="276815461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276815461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276815461">(Mar 28 2022 at 00:18)</a>:</h4>
<p>I cite (and screenshot) the specific part here: <a href="https://twitter.com/at_tcsc/status/1501712444451741696">https://twitter.com/at_tcsc/status/1501712444451741696</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/at_tcsc/status/1501712444451741696"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/9492b1a49a185414e8d7f67b9ac7f5b5324fd2ce/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313337323036383434393439373734373435362f306f524c7a4b394f5f6e6f726d616c2e6a7067"></a><p>it'd be great to get this opt in Rust, since "Arc&lt;T&gt; but in practice a Box&lt;T&gt;" is common (it can be needed to make an API safe, even if the issue requires deliberate misuse).

Sadly, IDK how the algo isn't violating this rule from x86 architecture manual (from 3A/I 8.1.2.2): <a href="https://t.co/WX5uI92dDW">https://twitter.com/davidtgoldblatt/status/1477728140600307714</a> <a href="https://t.co/JTXAUNVof2">https://twitter.com/at_tcsc/status/1501712444451741696/photo/1</a></p><span>- thom, supposedly (@at_tcsc)</span><div class="twitter-image"><a href="https://t.co/JTXAUNVof2"><img src="https://uploads.zulipusercontent.net/db4439f895e81f5e9f23da69c20cf588d32f3886/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f464e636d5752415655414531434b672e706e673a6c61726765"></a></div></div></div>



<a name="276815474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276815474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276815474">(Mar 28 2022 at 00:18)</a>:</h4>
<p>anyway this has gotten off topic</p>



<a name="276832032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276832032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276832032">(Mar 28 2022 at 06:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/276797780">said</a>:</p>
<blockquote>
<p>The "obvious" solution to this is to just fix the signature on the Rust side so Rust understands Pointers Are Happening.</p>
</blockquote>
<p>At least one such system function, <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowlongptrw">GetWindowLongPtrW</a>, happily mixes function pointers, data pointers, and integers, all as a single "accessor" function. They're all returned through an <code>isize</code> value, and the caller is expected to convert to the correct form.</p>
<p>So, some sort of union for that too?</p>



<a name="276873328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/276873328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#276873328">(Mar 28 2022 at 13:32)</a>:</h4>
<p>as long as it's ptr-sized, we can use a ptr type as that union type</p>



<a name="277004403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277004403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277004403">(Mar 29 2022 at 13:29)</a>:</h4>
<p>I really dislike the usability impact of having to declare things with different signatures than they have in C.  Especially if you're using bindgen to automatically bind to C headers…</p>



<a name="277006362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006362">(Mar 29 2022 at 13:44)</a>:</h4>
<p><span class="user-mention" data-user-id="198590">@comex</span> i've already added CHERI-style uptr/iptr to the stable Polyfill (sptr) and you can use that in the worst-case</p>



<a name="277006420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006420">(Mar 29 2022 at 13:44)</a>:</h4>
<p>Would it work to use an <code>isize</code> value that is actually a transmuted pointer or fn pointer, in a world where int2ptr doesn't exist? I'm not sure if calling the FFI function causes a read at the wrong type</p>



<a name="277006669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006669">(Mar 29 2022 at 13:46)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> that is the exact thing i just described</p>



<a name="277006680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006680">(Mar 29 2022 at 13:46)</a>:</h4>
<p><a href="https://docs.rs/sptr/0.2.1/sptr/int/struct.uptr.html">https://docs.rs/sptr/0.2.1/sptr/int/struct.uptr.html</a></p>



<a name="277006704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006704">(Mar 29 2022 at 13:46)</a>:</h4>
<p><code>uptr</code> is just a wrapper around <code>*mut ()</code> though, right?</p>



<a name="277006729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006729">(Mar 29 2022 at 13:46)</a>:</h4>
<p>it's not actually a <code>usize</code></p>



<a name="277006766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006766">(Mar 29 2022 at 13:47)</a>:</h4>
<p>they have identical ABIs, the only difference is the compiler knows to track provenance</p>



<a name="277006942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006942">(Mar 29 2022 at 13:48)</a>:</h4>
<p>all known supported ABIs (outside CHERI where this issue should be irrelevant) pass pointers and pointer-sized-integers identically</p>



<a name="277006946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277006946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277006946">(Mar 29 2022 at 13:48)</a>:</h4>
<p>I read <span class="user-mention" data-user-id="198590">@comex</span> 's point as saying that we want to be able to mechanically turn the C definition into a rust extern spec and there wouldn't be a way to make <code>uptr</code> come out unless there was an annotation on the C side</p>



<a name="277007064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007064">(Mar 29 2022 at 13:49)</a>:</h4>
<p>if this hack is deemed necessary, it can be a built-in type with built-in magic</p>



<a name="277007116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007116">(Mar 29 2022 at 13:49)</a>:</h4>
<p>Could rust/rustc simply mark every single pointer-sized integer in extern's as actually a pointer?</p>



<a name="277007196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007196">(Mar 29 2022 at 13:50)</a>:</h4>
<p>it could, but this would be a Very Sad Outcome</p>



<a name="277007286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007286">(Mar 29 2022 at 13:50)</a>:</h4>
<p>certainly you could imagine having it as a -C option, in the same vein of people compiling their code with strict-aliasing disabled in C++ because it's "too hard"</p>



<a name="277007336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007336">(Mar 29 2022 at 13:51)</a>:</h4>
<p>Having the implicit transmute happening across the FFI boundary is pretty sketch though</p>



<a name="277007344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007344">(Mar 29 2022 at 13:51)</a>:</h4>
<p>actually, no</p>



<a name="277007366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007366">(Mar 29 2022 at 13:51)</a>:</h4>
<p>rustc just marking the API isn't really helpful</p>



<a name="277007407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007407">(Mar 29 2022 at 13:51)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> all FFI is implict transmutes lol</p>



<a name="277007477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007477">(Mar 29 2022 at 13:52)</a>:</h4>
<p>it's just "hope the ABI matches"</p>



<a name="277007532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007532">(Mar 29 2022 at 13:52)</a>:</h4>
<p>Auditing FFI is hard when you are doing magical things at the same time</p>



<a name="277007625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007625">(Mar 29 2022 at 13:53)</a>:</h4>
<p>so bindgen is very useful and I hope we can find a solution that is compatible with it</p>



<a name="277007637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007637">(Mar 29 2022 at 13:53)</a>:</h4>
<p>Auditing FFI would be even harder if instead of translating a C declaration you <em>also</em> had to account for "this is an integer but <em>actually</em> its a pointer so I need to use another type"</p>



<a name="277007901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277007901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277007901">(Mar 29 2022 at 13:55)</a>:</h4>
<p>tbc, if the pointer <em>comes from</em> FFI and <em>goes back to</em> FFI and Rust never thought about it as a pointer (like most cases of HANDLE) then that's totally fine, since provenance is only within rust's abstract machine. The abstract machine doesn't care if someone on the other side is roundtripping lying pointers through us.</p>



<a name="277008030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008030">(Mar 29 2022 at 13:56)</a>:</h4>
<p>that's what I meant about transmuted pointers</p>



<a name="277008045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008045">(Mar 29 2022 at 13:56)</a>:</h4>
<p>If it's <em>not</em> roundtripping then attempting to use the API will inevitably result in "oh fuck I need to do a ptr&lt;-&gt;int cast" and boom there's your audit</p>



<a name="277008153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008153">(Mar 29 2022 at 13:57)</a>:</h4>
<p>like literally you <em>already</em> have to cast to deal with these kinds of APIs</p>



<a name="277008231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008231">(Mar 29 2022 at 13:57)</a>:</h4>
<p>we can just use <code>isize</code> even though it stores <code>*mut ()</code> data, even if performing any operation on that data is considered UB (either immediately or later when someone on the other end of the FFI derefs it) as long as it is only ever handled opaquely</p>



<a name="277008332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008332">(Mar 29 2022 at 13:58)</a>:</h4>
<p>I'm not sure we can just call that provenance "someone else's problem" though, the AM execution includes that FFI stuff too</p>



<a name="277008510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008510">(Mar 29 2022 at 13:59)</a>:</h4>
<p>You cannot have stuff outside of Rust in the abstract machine. It does not make sense to discuss. Provenance modeling must end at the FFI boundary.</p>



<a name="277008742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008742">(Mar 29 2022 at 14:00)</a>:</h4>
<p>What if you pass a pointer to C and it passes the pointer back? We don't want to consider that as a ptr2int2ptr, I think</p>



<a name="277008799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008799">(Mar 29 2022 at 14:01)</a>:</h4>
<p>if you erase all provenance at the door then that's what you get</p>



<a name="277008891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277008891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277008891">(Mar 29 2022 at 14:02)</a>:</h4>
<p>please explicitly write out what you're describing as code so that we can have a coherent discussion</p>



<a name="277009113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009113">(Mar 29 2022 at 14:03)</a>:</h4>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="nf">foo</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">p</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">example</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This should not be UB</p>



<a name="277009229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009229">(Mar 29 2022 at 14:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277008742">said</a>:</p>
<blockquote>
<p>What if you pass a pointer to C and it passes the pointer back? We don't want to consider that as a ptr2int2ptr, I think</p>
</blockquote>
<p>No, but if it can't analyze the function it has to assume it returns either any parameter or any escaped pointer.</p>



<a name="277009305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009305">(Mar 29 2022 at 14:04)</a>:</h4>
<p>I'm not talking about what the compiler can optimize with, I'm talking about the AM semantics</p>



<a name="277009330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009330">(Mar 29 2022 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> agreed, this code works perfectly under strict provenance</p>



<a name="277009411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009411">(Mar 29 2022 at 14:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277009305">said</a>:</p>
<blockquote>
<p>I'm not talking about what the compiler can optimize with, I'm talking about the AM semantics</p>
</blockquote>
<p>AM Semantics arround FFI are hard to specify.</p>



<a name="277009496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009496">(Mar 29 2022 at 14:06)</a>:</h4>
<p>I know, I've been wondering about this issue for a long time since it seems to be the elephant in the room</p>



<a name="277009533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009533">(Mar 29 2022 at 14:06)</a>:</h4>
<p>but I don't see how we are supposed to avoid every other language spec being a part of the Rust AM if it has FFI</p>



<a name="277009755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009755">(Mar 29 2022 at 14:08)</a>:</h4>
<p>...or, you know, we could just keep ignoring it</p>



<a name="277009773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009773">(Mar 29 2022 at 14:08)</a>:</h4>
<p>AM semantics for FFI seem very clear unless you expect the compiler to Have To reason globally. This is no different than a native Rust API that goes (*const) -&gt; *const</p>



<a name="277009838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009838">(Mar 29 2022 at 14:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277009533">said</a>:</p>
<blockquote>
<p>but I don't see how we are supposed to avoid every other language spec being a part of the Rust AM if it has FFI</p>
</blockquote>
<p>The issue is that every other language spec can't be part of the Rust AM.</p>



<a name="277009899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009899">(Mar 29 2022 at 14:09)</a>:</h4>
<p>in a rust API, there is someone to pick up the phone on the other end, and AFAIK the AM semantics go right on through that barrier</p>



<a name="277009935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009935">(Mar 29 2022 at 14:09)</a>:</h4>
<p>even if the compiler can't see / optimize through that barrier</p>



<a name="277009939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277009939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277009939">(Mar 29 2022 at 14:09)</a>:</h4>
<p>Some of them do.</p>



<a name="277010140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277010140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277010140">(Mar 29 2022 at 14:11)</a>:</h4>
<p>for C and C++ I think we want at least some sharing of execution semantics since there is language about panicking vs C++ exception handling, repr(C) and all that</p>



<a name="277012689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277012689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277012689">(Mar 29 2022 at 14:27)</a>:</h4>
<p>I think it might be possible to formally define a nondeterministic transition to "any state you could possibly get to by non-UB unsafe rust code" (not defined literally like that but closer to setting all accessible memory to nondeterministic values) which would be the AM equivalent of "run an opaque function", which could be used for modeling FFI calls and possibly also external rust calls in a shared library</p>



<a name="277012784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277012784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277012784">(Mar 29 2022 at 14:28)</a>:</h4>
<p>it would be pretty impossible for miri to execute that though</p>



<a name="277013071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013071">(Mar 29 2022 at 14:30)</a>:</h4>
<p>Well, I mean, miri can't execute unknown FFI anyways, so...</p>



<a name="277013148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013148">(Mar 29 2022 at 14:30)</a>:</h4>
<p>what about known FFI?</p>



<a name="277013349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013349">(Mar 29 2022 at 14:32)</a>:</h4>
<p>Nondeterminstic=Unspecified.<br>
If MIRI knows about the FFI, it can make the appropriate choice for the unspecified behaviour.</p>



<a name="277013415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013415">(Mar 29 2022 at 14:32)</a>:</h4>
<p>I'm suggesting to use that kind of semantics for all FFI, even if it is to a "known" function (whatever that means). In particular that means that compilers are not permitted to optimize or inline across FFI even if they git gud</p>



<a name="277013528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013528">(Mar 29 2022 at 14:33)</a>:</h4>
<p>the alternative would be throwing the C / C++ specs into the rust spec which is... undesirable</p>



<a name="277013581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013581">(Mar 29 2022 at 14:33)</a>:</h4>
<p>I'd define it as some ellaboration on:</p>
<blockquote>
<p>Places the abstract machine in some unspecified state, or the behaviour is undefined.</p>
</blockquote>
<p>Which means compilers can most certainly optimize/inline accross FFI.</p>



<a name="277013795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013795">(Mar 29 2022 at 14:34)</a>:</h4>
<p>no see that's not the nondeterminism I mean. "Unspecified" has the wrong behavior since the compiler can just make up a function and do that instead of the real one</p>



<a name="277013851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013851">(Mar 29 2022 at 14:35)</a>:</h4>
<p>I mean, how do you specify what "the real one" is.</p>



<a name="277013953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013953">(Mar 29 2022 at 14:35)</a>:</h4>
<p>You log a call to the function and the current state of (accessible) memory to the Observable Behavior trace</p>



<a name="277013994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277013994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277013994">(Mar 29 2022 at 14:35)</a>:</h4>
<p>like IO</p>



<a name="277014173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014173">(Mar 29 2022 at 14:36)</a>:</h4>
<p>You can limit it's choices somewhat, for example</p>
<blockquote>
<p>If some crate defines a function with an export-name that matches the link_name of an external declaration, then the result of calling the declaration is the same as the result of calling that definition as-if the definition was accessible to the current crate. The behaviour is undefined if the definitions is not compatible with the declaration.</p>
</blockquote>



<a name="277014238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014238">(Mar 29 2022 at 14:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277013953">said</a>:</p>
<blockquote>
<p>You log a call to the function and the current state of (accessible) memory to the Observable Behavior trace</p>
</blockquote>
<p>Realistically, this will never fly.</p>



<a name="277014272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014272">(Mar 29 2022 at 14:37)</a>:</h4>
<p>And as an implementor... No, definately not.</p>



<a name="277014287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014287">(Mar 29 2022 at 14:37)</a>:</h4>
<p>how so? It's entirely a theoretical concept</p>



<a name="277014332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014332">(Mar 29 2022 at 14:37)</a>:</h4>
<p>FFI-inlining happens with LTO.</p>



<a name="277014405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014405">(Mar 29 2022 at 14:38)</a>:</h4>
<p>Good luck convincing llvm not to inline function definitions in LTO mode.</p>



<a name="277014484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014484">(Mar 29 2022 at 14:38)</a>:</h4>
<p>Good luck convincing any optimizing compiler that supports LTO to not inline definitions with LTO.</p>



<a name="277014504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014504">(Mar 29 2022 at 14:38)</a>:</h4>
<p>hm... does LLVM have LLVM IR for both sides of the FFI in this scenario?</p>



<a name="277014539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014539">(Mar 29 2022 at 14:39)</a>:</h4>
<p>It might.</p>



<a name="277014551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014551">(Mar 29 2022 at 14:39)</a>:</h4>
<p>that concern is 5-10 years away from being reality given LLVM <em>already</em> doesn't have a coherent notion of aliasing and PNVI and strict-aliasing are both just proposed concepts</p>



<a name="277014647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014647">(Mar 29 2022 at 14:39)</a>:</h4>
<p>the "virtue" of strict-aliasing is that basically any coherent model must be a weakening of it, afaict</p>



<a name="277014681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014681">(Mar 29 2022 at 14:40)</a>:</h4>
<p>so if we make all <em>our</em> code conform to it, it will "always" be right</p>



<a name="277014794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014794">(Mar 29 2022 at 14:40)</a>:</h4>
<p>(well specifically stacked-borrows-with-strict-aliasing)</p>



<a name="277014841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014841">(Mar 29 2022 at 14:40)</a>:</h4>
<p>I actually have plans to build all of lccc's libraries (including the rust libraries) in mixed-LTO mode, which means that the static archives will contain both machine code and xir bytecode, so turning on LTO gets LTO to all of the rt and standard libraries.</p>



<a name="277014905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014905">(Mar 29 2022 at 14:41)</a>:</h4>
<p>sure, but "compiling any code on LLVM" is already conceptually unsound because it simply does not have a coherent model</p>



<a name="277014941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014941">(Mar 29 2022 at 14:41)</a>:</h4>
<p>I think I will return to my original position of "this seems impossible to specify unless you make every spec be part of rust"</p>



<a name="277014994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277014994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277014994">(Mar 29 2022 at 14:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277014941">said</a>:</p>
<blockquote>
<p>I think I will return to my original position of "this seems impossible to specify unless you make every spec be part of rust"</p>
</blockquote>
<p>Just make it unspecified and place some limitations on it.</p>



<a name="277015116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277015116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277015116">(Mar 29 2022 at 14:42)</a>:</h4>
<p>You're never going to get anything better than that.</p>



<a name="277015435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277015435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277015435">(Mar 29 2022 at 14:44)</a>:</h4>
<p>basically I am suggesting a tower of weakenings:</p>
<ul>
<li>strictest: the model people write code against</li>
<li>stricter: whatever weakening of this model we think we can make coherent</li>
<li>shrug-emoji: whatever annotations and transforms compilers actually define and provide</li>
</ul>



<a name="277015818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277015818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277015818">(Mar 29 2022 at 14:46)</a>:</h4>
<p>i cannot imagine there ever being a coherent system that would miscompile code conforming to strict-provenance</p>



<a name="277015902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277015902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277015902">(Mar 29 2022 at 14:47)</a>:</h4>
<p>what the <em>compiler</em> actually emits in the face of FFI and Evil is its business</p>



<a name="277015971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277015971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277015971">(Mar 29 2022 at 14:47)</a>:</h4>
<p>right?</p>



<a name="277016511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277016511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277016511">(Mar 29 2022 at 14:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277015818">said</a>:</p>
<blockquote>
<p>i cannot imagine there ever being a coherent system that would miscompile code conforming to strict-provenance</p>
</blockquote>
<p><code>ptr.wrapping_offset(HUGE).wrapping_offset(-HUGE)</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="277016752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277016752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277016752">(Mar 29 2022 at 14:53)</a>:</h4>
<p>that code is safe under strict-provenance rules and CHERI has coherent arguments for breaking it</p>



<a name="277016861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277016861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277016861">(Mar 29 2022 at 14:54)</a>:</h4>
<p>that's a hardware/system limitation, not a compiler "bug"</p>



<a name="277016921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277016921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277016921">(Mar 29 2022 at 14:54)</a>:</h4>
<p>if an OS had 128-byte stacks a bunch of Rust code would explode on it but it's not being "miscompiled"</p>



<a name="277017502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277017502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277017502">(Mar 29 2022 at 14:58)</a>:</h4>
<p>like we don't hand-wring about someone targetting rust to some low-end embedded hardware having to be careful to not exhaust the thing's resources, or having to be nostd. some code isn't as portable as you'd like. it happens.</p>



<a name="277017755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277017755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277017755">(Mar 29 2022 at 14:59)</a>:</h4>
<p>the current docs i have do say wrapping_offset is still chill, but just mentions that some platforms may fall over if you push it too hard. just like rust lets you say <code>let x: [u8; 100000000] = [0; 100000000]</code> and we will faithfully try to do that and then your program falls over immediately.</p>



<a name="277018079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277018079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277018079">(Mar 29 2022 at 15:01)</a>:</h4>
<p>hell we #[cfg] out random parts of std for WASM, it's fine.</p>



<a name="277018269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277018269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277018269">(Mar 29 2022 at 15:02)</a>:</h4>
<p>(by the way, small stacks isn't just an embedded problem, it can happen on userspace linux too. A while back I investigated whether it is possible to compile code without faulting on stack overflow if you precalculate the total required stack space, and I was gobsmacked to discover that you can set the stack limit such that you get a stack overflow before running the first line of <code>_start</code>)</p>



<a name="277018460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277018460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277018460">(Mar 29 2022 at 15:03)</a>:</h4>
<p>(and also the user can be a jerk and put a ton of stuff in the environment variables and use up your stack)</p>



<a name="277019918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277019918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277019918">(Mar 29 2022 at 15:13)</a>:</h4>
<p>The "tower of weakenings" concept makes sense to me.  But it comes at the cost of usability, since it implies imposing stricter requirements than the compiler actually takes advantage of or, most likely IMO, will ever take advantage of.  (There's no possible future where LLVM starts imposing strict provenance on C.  There's a possible future where we have important Rust-specific optimizations that rely on strict provenance, but it seems pretty distant to me, given that the amount of contribution from the Rust project to LLVM is still relatively limited.  Besides, it's not clear to me that optimizing based on strict provenance will actually be necessary to avoid losing significant performance compared to today's unsound behavior.)</p>



<a name="277020072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277020072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277020072">(Mar 29 2022 at 15:14)</a>:</h4>
<p>That said, there's definitely a possible future where CHERI is everywhere and Rust can have a better story than C does for avoiding accidental provenance loss.  I'm a fan of strict provenance to that extent.</p>



<a name="277020475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277020475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277020475">(Mar 29 2022 at 15:17)</a>:</h4>
<p>Still, <em>today</em>, from my perspective, the most important problem with Rust pointers is usability issues caused by Stacked Borrows being too strict.  Trying to improve the situation by making some closely-related semantics <em>stricter</em> just seems completely backwards to me…</p>



<a name="277020636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277020636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277020636">(Mar 29 2022 at 15:18)</a>:</h4>
<p>I think it's entirely possible a rust-specific compiler and optimization framework could take advantage of strict provenance.</p>



<a name="277020712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277020712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277020712">(Mar 29 2022 at 15:18)</a>:</h4>
<p>I agree it's unlikely to appear on any general compilation frameworks any time soon.</p>



<a name="277020924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277020924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277020924">(Mar 29 2022 at 15:20)</a>:</h4>
<p>I think imposing strict semantics that can be adopted by the community to help them express what they mean better than the multi-purpose <code>as usize</code> is a good thing even if the functions have definitions in terms of <code>as usize</code> and such</p>



<a name="277020989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277020989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277020989">(Mar 29 2022 at 15:20)</a>:</h4>
<p>This is my example for the issues we have with FFI. What would the actual limits on what FFI would be capable of? It's easy to say FFI is undefined in the AM (and probably necessary to actually have a coherent spec), but not very useful for actually reasoning about code.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">ptrtoint</span><span class="p">(</span><span class="n">p</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">inttoptr</span><span class="p">(</span><span class="n">p</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">example</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">inttoptr</span><span class="p">(</span><span class="n">ptrtoint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277022428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277022428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277022428">(Mar 29 2022 at 15:30)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> True.  In some ways stricter semantics could actually improve usability by being easier to understand, easier to explicitly reason about, and easier for miri to reason about.  But you could say the same about Stacked Borrows; that doesn't stop it from being a source of a lot of frustration.  In its case, noalias is very nice to have, and so would be the additional optimizations that are allowed under Stacked Borrows even if rustc doesn't perform them today.  In strict provenance's case… well, it might be necessary to avoid a significant performance loss in the name of soundness, or it might not be; there's still a lack of data.</p>



<a name="277022750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277022750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277022750">(Mar 29 2022 at 15:33)</a>:</h4>
<p>With the "tower of weakenings" approach, it is possible to get <em>most</em> code to meet the high standard, and thereby tolerate more performance degredation in the few places that absolutely need to commit Pointer Crimes</p>



<a name="277023007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277023007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277023007">(Mar 29 2022 at 15:35)</a>:</h4>
<p>it doesn't have to be all or nothing, although I am dubious about the only function in strict-provenance for int2ptr being called <code>invalid()</code></p>



<a name="277023701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277023701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277023701">(Mar 29 2022 at 15:39)</a>:</h4>
<p>because people keep bringing it up I have added an entry to the FAQ for wrapping_offset: <a href="https://github.com/rust-lang/rust/issues/95228#issuecomment-1075881238">https://github.com/rust-lang/rust/issues/95228#issuecomment-1075881238</a></p>



<a name="277024062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277024062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277024062">(Mar 29 2022 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="198590">comex</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277020475">said</a>:</p>
<blockquote>
<p>Still, <em>today</em>, from my perspective, the most important problem with Rust pointers is usability issues caused by Stacked Borrows being too strict.  Trying to improve the situation by making some closely-related semantics <em>stricter</em> just seems completely backwards to me…</p>
</blockquote>
<p>I agree, which is why my work and article are entirely focused on introducing new APIs that make using raw pointers in a "strictly right" way easier / the default. I am not pushing for the ~ ergonomics stuff because that's syntax/compiler stuff and I cannot "do" that stuff and it will bikeshedded into oblivion.</p>



<a name="277024066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277024066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277024066">(Mar 29 2022 at 15:41)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span>  That is true.  As I was going to say to <span class="user-mention" data-user-id="303115">@Quy Nguyen</span>, in theory, rustc could allow such FFI calls to have the expected 'provenance broadcast' semantics but be more conservative with optimizations in their presence.  There could be similar functions in the standard library too.  At least then, if you know you're committing Crimes, you have some kind of escape clause (that doesn't work on CHERI).  But a major component of the usability issues with SB is not knowing which things are Crimes in the first place.  Perhaps that's less of an issue with integer&lt;-&gt;pointer casts.</p>



<a name="277024325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277024325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277024325">(Mar 29 2022 at 15:43)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> Fair enough.  I definitely agree that these new APIs are helpful (pretty much regardless of what provenance semantics we end up imposing!).</p>



<a name="277024400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277024400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277024400">(Mar 29 2022 at 15:43)</a>:</h4>
<p>But yes part of the motivation of strict provenance is that it is an absolute nightmare to "teach" a less strict model</p>



<a name="277024985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277024985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277024985">(Mar 29 2022 at 15:46)</a>:</h4>
<p>like, "ok so if you do these 5 things then it triggers a special rule that lets you do a Special Crime" is a lot harder than "just do this. if you always do this then you win"</p>



<a name="277025652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277025652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277025652">(Mar 29 2022 at 15:51)</a>:</h4>
<p>(I <em>really</em> would strongly encourage folks with ties to lang/compiler to push for something like ~ because it has the exact same "every question has an easy answer" effect as strict provenance, but I am not touching that project with a ten-foot pole)</p>



<a name="277025958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277025958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277025958">(Mar 29 2022 at 15:52)</a>:</h4>
<p>I like ~ but i worry it has a bit of an uphil battle in terms of the syntax. But probably not as much of one as <code>.await</code> had (presumably fewer people will have Opinions)</p>



<a name="277026248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277026248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277026248">(Mar 29 2022 at 15:54)</a>:</h4>
<p>yeah the syntax is whatever, it was just funny to me to "resurrect" the friend i never got to have</p>



<a name="277026569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277026569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277026569">(Mar 29 2022 at 15:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="198590">comex</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277004403">said</a>:</p>
<blockquote>
<p>I really dislike the usability impact of having to declare things with different signatures than they have in C.  Especially if you're using bindgen to automatically bind to C headers…</p>
</blockquote>
<p>yeah it's not great. but also C is just wrong... like even C itself is moving to PNVI, as in "provenance <em>not</em> via integers", which means an integer type is <em>not</em> a universal type that holds all kinds of data. sadly this realization comes a bit too late for some existing APIs, so there will be some amount of friction.</p>



<a name="277026870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277026870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277026870">(Mar 29 2022 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277015818">said</a>:</p>
<blockquote>
<p>i cannot imagine there ever being a coherent system that would miscompile code conforming to strict-provenance</p>
</blockquote>
<p>FWIW I agree, all the wild miscompilation examples I know involve int2ptr casts and expecting the ptr to somehow obtain "useful" provenance through magic or so</p>



<a name="277027053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277027053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277027053">(Mar 29 2022 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277026569">said</a>:</p>
<blockquote>
<p>yeah it's not great. but also C is just wrong... like even C itself is moving to PNVI, as in "provenance <em>not</em> via integers", which means an integer type is <em>not</em> a universal type that holds all kinds of data. sadly this realization comes a bit too late for some existing APIs, so there will be some amount of friction.</p>
</blockquote>
<p>Eh, under PNVI it's still a universal type in every practical sense, just one that might block optimizations you probably don't care about.  (CHERI is a different matter…)</p>



<a name="277027209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277027209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277027209">(Mar 29 2022 at 16:00)</a>:</h4>
<p>well it is not universal in the sense that converting a ptr to int and back is lossy</p>



<a name="277027347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277027347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277027347">(Mar 29 2022 at 16:00)</a>:</h4>
<p>though I guess you are right that on the surface level that loss only means fewer optimizations (and a more complicated memory model)</p>



<a name="277027420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277027420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277027420">(Mar 29 2022 at 16:00)</a>:</h4>
<p>in the optimizer this is super relevant though, LLVM regularly assumes that <code>iN</code> is universal in a non-lossy way</p>



<a name="277027474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277027474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277027474">(Mar 29 2022 at 16:01)</a>:</h4>
<p>and being able to do things that are "obviously" UB like smuggled UAFs</p>



<a name="277027768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277027768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277027768">(Mar 29 2022 at 16:02)</a>:</h4>
<p>I should actually mention this "tower of weakenings" concept in the FAQ</p>



<a name="277028469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277028469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> comex <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277028469">(Mar 29 2022 at 16:07)</a>:</h4>
<p>Sidenote: When it comes to C API design, I used to think that <code>uintptr_t</code> was <em>better</em> than <code>void *</code> for opaque values and should be preferred for new APIs, because the C standard says that converting arbitrary integers to pointers is implementation-defined and (depending on the implementation) might produce trap representations.  It's also UB to cast pointers to another type if they're misaligned, which is easier to do by accident if you start with <code>void *</code>.  On the other hand, if <code>uintptr_t</code> exists, round tripping <code>void *</code> to <code>uintptr_t</code> and back is at least guaranteed to produce a pointer that compares equal to the original, so it seems like it would be preferable.  But then I learned CHERI was a thing and realized that 'compares equal' isn't necessarily the same thing as 'is equivalent', if the round trip strips runtime provenance. (Though in practice CHERI uses 128-bit <code>uintptr_t</code> and tries not to strip runtime provenance, I think?)  Oh well.  I guess it's a good thing that <code>void *</code> is more common in existing usage.</p>



<a name="277029617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277029617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277029617">(Mar 29 2022 at 16:15)</a>:</h4>
<p>ok added under "Isn't This Model WAY Too Strict?"</p>



<a name="277029804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277029804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277029804">(Mar 29 2022 at 16:16)</a>:</h4>
<p>Yeah the CHERI interpretation is basically "the only really valid use of intptr_t is pointer crimes, so let's assume it is in fact just a pointer"</p>



<a name="277030030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277030030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277030030">(Mar 29 2022 at 16:17)</a>:</h4>
<p>with magic analysis to try to propagate the "correct" provenance when you have operations like lhs + rhs</p>



<a name="277030082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277030082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277030082">(Mar 29 2022 at 16:18)</a>:</h4>
<p>(fallback is just "lhs wins" aiui)</p>



<a name="277030392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277030392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277030392">(Mar 29 2022 at 16:20)</a>:</h4>
<p>one nice detail of that approach is that because all of intptr_t's "typical aliases" (uint64_t, size_t, ptrdiff_t, ...) are <em>genuinely</em> different sizes from intptr_t so like, anywhere that is using the wrong one can be "found" and fixed in porting something to it</p>



<a name="277030959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277030959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277030959">(Mar 29 2022 at 16:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277026569">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="198590">comex</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277004403">said</a>:</p>
<blockquote>
<p>I really dislike the usability impact of having to declare things with different signatures than they have in C.  Especially if you're using bindgen to automatically bind to C headers…</p>
</blockquote>
<p>yeah it's not great. but also C is just wrong... like even C itself is moving to PNVI, as in "provenance <em>not</em> via integers", which means an integer type is <em>not</em> a universal type that holds all kinds of data. sadly this realization comes a bit too late for some existing APIs, so there will be some amount of friction.</p>
</blockquote>
<p>It's also impossible for some apis to update, as stated previously, since sometimes you need a consistent ABI for both 32-bit and 64-bit pointer ABIs.</p>



<a name="277031317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031317">(Mar 29 2022 at 16:27)</a>:</h4>
<p>yes indeed we are lacking in expressivity here -- we dont have arbitrarily-sized data with provenance, only ptr-sized data with provenance</p>



<a name="277031343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031343">(Mar 29 2022 at 16:27)</a>:</h4>
<p>that's where the seams of this are showing. a lot.</p>



<a name="277031483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031483">(Mar 29 2022 at 16:28)</a>:</h4>
<p>in Rust we have <code>MaybeUninit&lt;u64&gt;</code> as something that can also hold provenance but it's super clunky</p>



<a name="277031510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031510">(Mar 29 2022 at 16:28)</a>:</h4>
<p><code>union { u64, *const () }</code> is probably our best bet. plus hacks to ensure it has the right ABI.</p>



<a name="277031642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031642">(Mar 29 2022 at 16:29)</a>:</h4>
<p>Hm, why can MaybeUninit&lt;u64&gt; hold provenance?</p>



<a name="277031801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031801">(Mar 29 2022 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277031642">said</a>:</p>
<blockquote>
<p>Hm, why can MaybeUninit&lt;u64&gt; hold provenance?</p>
</blockquote>
<p><code>MaybeUninit&lt;T&gt;</code> can hold any bytes at all.</p>



<a name="277031991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277031991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277031991">(Mar 29 2022 at 16:32)</a>:</h4>
<p>Hmm... What happens if you <code>transmute_copy</code> from a pointer over <code>MaybeUninit&lt;u8&gt;</code>?</p>



<a name="277032805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277032805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277032805">(Mar 29 2022 at 16:38)</a>:</h4>
<p>That's useful to know. Is that something that can be relied on though?</p>
<p>Like, it feels like the kind of thing where if I wrote code to rely on this, then in 3 years we'd be talking about how we need to break that code because it's Always Been Broken <span aria-label="tm" class="emoji emoji-2122" role="img" title="tm">:tm:</span> anyway.</p>



<a name="277033876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277033876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277033876">(Mar 29 2022 at 16:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277031991">said</a>:</p>
<blockquote>
<p>Hmm... What happens if you <code>transmute_copy</code> from a pointer over <code>MaybeUninit&lt;u8&gt;</code>?</p>
</blockquote>
<p>there generally needs to be a "memcopy exception" in any provenance model, and how well that can be defined formally partially depends on things like llvm's "byte" type proposal.</p>



<a name="277036201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277036201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277036201">(Mar 29 2022 at 17:05)</a>:</h4>
<p>just assume your AM has Arm's memcpy instructions</p>



<a name="277036302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277036302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277036302">(Mar 29 2022 at 17:05)</a>:</h4>
<p>oh? does ARM do something special?</p>



<a name="277036420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277036420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277036420">(Mar 29 2022 at 17:06)</a>:</h4>
<p>I am joking but only somewhat. They literally added memcpy instructions that have like exactly the signature of memcpy so that the processor can turn it into a DMA.</p>



<a name="277036460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277036460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277036460">(Mar 29 2022 at 17:06)</a>:</h4>
<p>oh lol ok</p>



<a name="277036489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277036489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277036489">(Mar 29 2022 at 17:07)</a>:</h4>
<p>i thought you meant it did some cute stuff with the v8.3 ptr auth stuff</p>



<a name="277036890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277036890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277036890">(Mar 29 2022 at 17:09)</a>:</h4>
<p><a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/arm-a-profile-architecture-developments-2021">https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/arm-a-profile-architecture-developments-2021</a></p>



<a name="277041660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277041660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277041660">(Mar 29 2022 at 17:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277032805">said</a>:</p>
<blockquote>
<p>Like, it feels like the kind of thing where if I wrote code to rely on this, then in 3 years we'd be talking about how we need to break that code because it's Always Been Broken <span aria-label="tm" class="emoji emoji-2122" role="img" title="tm">:tm:</span> anyway.</p>
</blockquote>
<p>that's why I want a normative formal model, so there are no more excuses like that :D</p>



<a name="277047365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277047365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277047365">(Mar 29 2022 at 18:32)</a>:</h4>
<p>yeah.</p>



<a name="277209731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277209731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277209731">(Mar 30 2022 at 22:05)</a>:</h4>
<blockquote>
<p>On all the ABIs and Calling Conventions I know, a pointer-sized-integer and an actual pointer have identical ABIs in the standard calling conventions, making this fixup perfectly fine.</p>
</blockquote>
<p>m68k is the thorn in your side here; pointers are returned in %a0, integers are returned in %d0. Arguments are at least the same though, all passed on the stack (yay old hardware...). <a href="https://trofi.github.io/posts/191-ghc-on-m68k.html">https://trofi.github.io/posts/191-ghc-on-m68k.html</a> is an example of this becoming a problem in the real world. Specifically, to quote the psABI (page 3-16, <a href="https://m680x0.github.io/ref/sysv-m68k-abi-part2.pdf">https://m680x0.github.io/ref/sysv-m68k-abi-part2.pdf</a>):</p>
<blockquote>
<p>A function that returns an integral value places its result in %d0. A function that returns a pointer value places its result in %a0.</p>
</blockquote>
<p>FFI is the one place where I believe you truly do need a uintptr_t-like thing to exist in Rust, even if you can get away without one in the land of pure untainted Rust.</p>
<p>The m68k psABI is a whole bunch of fun, not least because the official SysV psABI spec is not _quite_ what's implemented in GCC...</p>



<a name="277209816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277209816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277209816">(Mar 30 2022 at 22:06)</a>:</h4>
<p>oooh nice nice ty</p>



<a name="277209944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277209944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277209944">(Mar 30 2022 at 22:07)</a>:</h4>
<p>well,  actually "fuck god damnit" but, y'know,</p>



<a name="277209958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277209958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277209958">(Mar 30 2022 at 22:07)</a>:</h4>
<p>(the de-facto ABI also being the one that brings you fun like <code>alignof(int, long, void *) == 2</code> but <code>sizeof(int, long, void *) == 4</code>; ponder how that goes down with (a) low-bit pointer tagging (b) Linux's "On all platforms, futexes are four-byte integers that must be aligned on a four-byte boundary."...)</p>



<a name="277210311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277210311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277210311">(Mar 30 2022 at 22:11)</a>:</h4>
<p><code>m68k-unknown-linux-gnu</code> is tier3, I should <code>cfg</code> sptr::uptr off on the platform</p>



<a name="277212772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277212772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277212772">(Mar 30 2022 at 22:48)</a>:</h4>
<p>lmao</p>



<a name="277234210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277234210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277234210">(Mar 31 2022 at 05:14)</a>:</h4>
<p>I think a more flexible approach for FFI specifically would be something like <code>fn f(#[abi(usize)] x: *const ())</code> which would allow some type punning at the ABI level for a small whitelist of type pairs, perhaps replaced by safe-transmute at some point</p>



<a name="277237224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277237224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277237224">(Mar 31 2022 at 06:12)</a>:</h4>
<p>Yeah, I would be happier to have the raw ABI represented somehow.</p>



<a name="277240602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277240602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277240602">(Mar 31 2022 at 07:01)</a>:</h4>
<p>I've actually wanted to write some functions even without FFI that transmute their arguments implicitly on the boundaries -- though it's for some <code>ManuallyDrop</code> things where ideally optimizations will fix it eventually</p>



<a name="277317792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277317792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277317792">(Mar 31 2022 at 17:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="439664">Jessica Clarke</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277209958">said</a>:</p>
<blockquote>
<p>(the de-facto ABI also being the one that brings you fun like <code>alignof(int, long, void *) == 2</code> but <code>sizeof(int, long, void *) == 4</code>; ponder how that goes down with (a) low-bit pointer tagging (b) Linux's "On all platforms, futexes are four-byte integers that must be aligned on a four-byte boundary."...)</p>
</blockquote>
<p>FWIW, I looked into this a little -- the kernel will simply fail <code>EINVAL</code> if your futex is not 4-byte aligned. And it looks like glibc, musl, and uClibc all get this wrong in their <code>pthread_mutex_t</code>. There is a gcc flag <code>-malign-int</code> for 32-bit alignment, but it's not the default, and it changes your whole ABI.</p>



<a name="277336599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277336599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277336599">(Mar 31 2022 at 20:36)</a>:</h4>
<p>Yes, on m68k you need <code>__attribute__((aligned(4)))</code> for any futexes. In languages without such a thing it gets more awkward (Go has such issues).</p>



<a name="277351226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277351226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277351226">(Mar 31 2022 at 22:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F/near/277317792">said</a>:</p>
<blockquote>
<p>FWIW, I looked into this a little -- the kernel will simply fail <code>EINVAL</code> if your futex is not 4-byte aligned. And it looks like glibc, musl, and uClibc all get this wrong in their <code>pthread_mutex_t</code>. There is a gcc flag <code>-malign-int</code> for 32-bit alignment, but it's not the default, and it changes your whole ABI.</p>
</blockquote>
<p>this is hilarious to me.</p>



<a name="277433965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277433965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277433965">(Apr 01 2022 at 15:19)</a>:</h4>
<p>Looks like glibc gets it right actually: <a href="https://github.com/bminor/glibc/blob/master/sysdeps/nptl/bits/pthreadtypes.h#L67-L72">pthread_mutex_t is a union</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">typedef</span><span class="w"> </span><span class="k">union</span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span> <span class="nc">__pthread_mutex_s</span><span class="w"> </span><span class="n">__data</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">__size</span><span class="p">[</span><span class="n">__SIZEOF_PTHREAD_MUTEX_T</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">long</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">__align</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">pthread_mutex_t</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>And <a href="https://github.com/bminor/glibc/blob/master/sysdeps/nptl/bits/struct_mutex.h#L29">__pthread_mutex_s</a> has this field:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">int</span><span class="w"> </span><span class="n">__lock</span><span class="w"> </span><span class="n">__LOCK_ALIGNMENT</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>And <a href="https://github.com/bminor/glibc/blob/master/sysdeps/m68k/nptl/bits/pthreadtypes-arch.h#L33">__LOCK_ALIGNMENT forces 4-byte alignment on m68k</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="n">define</span><span class="w"> </span><span class="n">__LOCK_ALIGNMENT</span><span class="w"> </span><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">__aligned__</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>



<a name="277439456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling%20conventions%20that%20handle%20int%2Bptr%20different%3F/near/277439456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/calling.20conventions.20that.20handle.20int.2Bptr.20different.3F.html#277439456">(Apr 01 2022 at 15:57)</a>:</h4>
<p>aha! I was distracted by the insufficient <code>long int __align</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>