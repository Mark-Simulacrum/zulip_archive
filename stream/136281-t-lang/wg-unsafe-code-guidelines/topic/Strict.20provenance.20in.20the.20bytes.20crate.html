<html>
<head><meta charset="utf-8"><title>Strict provenance in the bytes crate · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html">Strict provenance in the bytes crate</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278049778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278049778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278049778">(Apr 06 2022 at 16:25)</a>:</h4>
<p>I just submitted a PR to the bytes crate that should make it strict provenance compatible. Unfortunately, it seems like the blessed version of <code>map_addr</code> doesn't optimize as well. Any thoughts on whether it's possible to get it to optimize better?<br>
PR is: &lt;<a href="https://github.com/tokio-rs/bytes/pull/542">https://github.com/tokio-rs/bytes/pull/542</a>&gt;</p>



<a name="278066646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278066646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278066646">(Apr 06 2022 at 18:29)</a>:</h4>
<p>Do the <code>.wrapping_add(HUGE).wrapping_sub(HUGE)</code> complications also apply to stuff like <code>ptr.wrapping_sub(old_addr).wrapping_add(new_addr)</code>?</p>



<a name="278067264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278067264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278067264">(Apr 06 2022 at 18:34)</a>:</h4>
<p>On CHERI, yes, but there's apparently some provision for top-bit pointer tagging Gankra was talking about.</p>



<a name="278067682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278067682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278067682">(Apr 06 2022 at 18:37)</a>:</h4>
<p>Are you saying there is an issue or there is not?</p>



<a name="278067993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278067993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278067993">(Apr 06 2022 at 18:40)</a>:</h4>
<p>In the general case yes, and from looking at the PR that's why std's <code>map_addr</code> is formulated like that. (I didn't see your new changes with my last response, that's my bad)</p>



<a name="278068287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278068287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278068287">(Apr 06 2022 at 18:42)</a>:</h4>
<p>Oh <em>that's</em> why you did that diff thing at first</p>



<a name="278069342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278069342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278069342">(Apr 06 2022 at 18:51)</a>:</h4>
<p>If there's a cfg for CHERI, I suppose I can just do it the other way when running on CHERI. Do you know if there's already a cfg for CHERI?</p>



<a name="278074417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278074417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278074417">(Apr 06 2022 at 19:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate/near/278067993">said</a>:</p>
<blockquote>
<p>In the general case yes, and from looking at the PR that's why std's <code>map_addr</code> is formulated like that. (I didn't see your new changes with my last response, that's my bad)</p>
</blockquote>
<p>not sure what you mean, which other way could <code>map_addr</code> have been formulated?</p>



<a name="278074688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278074688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278074688">(Apr 06 2022 at 19:33)</a>:</h4>
<p>oh you mean starting with <code>a.wrapping_sub(a as usize)</code>. hm, that's an interesting alternative.</p>



<a name="278074798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278074798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278074798">(Apr 06 2022 at 19:34)</a>:</h4>
<p>might be worth a report with LLVM so that it can recognize the other pattern and optimize it equally well?</p>



<a name="278074930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278074930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278074930">(Apr 06 2022 at 19:35)</a>:</h4>
<p>For CHERI the easiest way to avoid unrepresentable values without optimizations would be to calculate the address difference and do a single wrapping_add</p>



<a name="278074997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278074997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278074997">(Apr 06 2022 at 19:36)</a>:</h4>
<p>yeah that's the way that doesnt seem to optimize well</p>



<a name="278075137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278075137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278075137">(Apr 06 2022 at 19:37)</a>:</h4>
<p>at least some of these can be written entirely without <code>map_addr</code> though, like the <code>let data = ptr_map(ptr, |addr| addr | KIND_VEC);</code> where we know <code>ptr as usize &amp; 0x1 == 0</code> (and <code>KIND_VEC==1</code>) so you can also do <code>let data = ptr.wrapping_add(KIND_VEC)</code>.</p>



<a name="278075269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278075269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278075269">(Apr 06 2022 at 19:38)</a>:</h4>
<p>Hmm that's annoying. I guess for CHERI it would make sense to use the @llvm.cheri.cap.address.set intrinsic directly and just use whatever is the fastest implementation for non-CHERI until there is actually CHERI support in upstream rust.</p>



<a name="278076911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278076911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278076911">(Apr 06 2022 at 19:52)</a>:</h4>
<p>C++ also has the issue according to this test:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">test</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">old_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">new_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">new_value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_value</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278079630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278079630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278079630">(Apr 06 2022 at 20:12)</a>:</h4>
<p>yeah, why would anyone write such code in C++? ;)</p>



<a name="278079944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278079944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278079944">(Apr 06 2022 at 20:14)</a>:</h4>
<p>Where do you report it if you want to report this kind of thing to LLVM?</p>



<a name="278086694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278086694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278086694">(Apr 06 2022 at 21:11)</a>:</h4>
<p>I feel like I heard a lot about LLVM moving to GitHub: <a href="https://github.com/llvm/llvm-project/issues">https://github.com/llvm/llvm-project/issues</a><br>
Though they still do reviews elsewhere, so I'm not certain</p>



<a name="278089201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20in%20the%20bytes%20crate/near/278089201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20in.20the.20bytes.20crate.html#278089201">(Apr 06 2022 at 21:32)</a>:</h4>
<p>yeah that seems to be their issue tracker. they also have a discourse forum.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>