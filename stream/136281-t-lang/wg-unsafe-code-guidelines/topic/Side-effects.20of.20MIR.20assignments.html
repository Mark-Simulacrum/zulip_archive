<html>
<head><meta charset="utf-8"><title>Side-effects of MIR assignments · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html">Side-effects of MIR assignments</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276750806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750806">(Mar 26 2022 at 23:01)</a>:</h4>
<p>Sure</p>



<a name="276750847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750847">(Mar 26 2022 at 23:02)</a>:</h4>
<p><del>for your original question as I said above, provenance changing or not <em>makes no difference</em></del></p>



<a name="276750851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750851">(Mar 26 2022 at 23:02)</a>:</h4>
<p>since <em>all</em> pointers to that memory are read-only, making the write UB</p>



<a name="276750867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750867">(Mar 26 2022 at 23:03)</a>:</h4>
<p>ah oh wait I might have misread</p>



<a name="276750936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750936">(Mar 26 2022 at 23:04)</a>:</h4>
<p>so the MIR code is like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_of</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Retag</span><span class="p">([</span><span class="n">raw</span><span class="p">]</span><span class="w"> </span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="276750947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750947">(Mar 26 2022 at 23:04)</a>:</h4>
<p>and the retag <em>is</em> the key operation here since a retag to a const raw ptr creates a provenance with read-only permission</p>



<a name="276750977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276750977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276750977">(Mar 26 2022 at 23:06)</a>:</h4>
<p><code>addr_of!(*r)</code> (in MIR!) returns a ptr that is wholly identical (addr and provenance) to the value stored in <code>r</code></p>



<a name="276751036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751036">(Mar 26 2022 at 23:06)</a>:</h4>
<p>it is the subsequent <code>Retag</code> that "adjusts" the provenance of <code>p</code>, as part of Stacked Borrows</p>



<a name="276751041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751041">(Mar 26 2022 at 23:06)</a>:</h4>
<p>sorry for the confusion. I hope this makes sense <span class="user-mention" data-user-id="310518">@Jak{e,ob} Degen</span> ?</p>



<a name="276751295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751295">(Mar 26 2022 at 23:12)</a>:</h4>
<p>So referring back to this Rust code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// Line A</span>
<span class="w">    </span><span class="c1">// `r`s memory now contains a `&amp;mut x`.</span>

<span class="w">    </span><span class="c1">// The `r as *const i32` is lowered to `&amp;raw *r` in MIR</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="c1">// Line B</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the relevant MIR for the <code>r as *const i32</code> on Line B is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">_12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">raw</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">_1</span><span class="p">);</span><span class="w">          </span><span class="c1">// scope 3 at test.rs:9:13: 9:14</span>
<span class="w">        </span><span class="n">Retag</span><span class="p">([</span><span class="n">raw</span><span class="p">]</span><span class="w"> </span><span class="n">_12</span><span class="p">);</span><span class="w">                </span><span class="c1">// scope 3 at test.rs:9:13: 9:14</span>
</code></pre></div>
<p>Importantly, before that, the memory of <code>_1</code>, ie the memory you would be touching if you did <code>load(_1)</code> contains the bytes that were created on Line A by the write of the value yielded by <code>&amp;mut x</code> to the memory at <code>*rp</code>. This write happens at type <code>&amp;mut i32</code>, and so the resulting pointer in memory should have SRW provenance. Because of the way <code>*rp</code>is constructed, writing to writes to the same memory that <code>load(_1)</code> would load.</p>
<p>Then, in Line B, we begin by performing a <code>load(_1)</code> at type <code>&amp;i32</code>. Keep in mind that the actual memory that is being loaded currently contains a pointer with a tag having Unique provenance. My confusion is about the semantics of this load. Assuming it does not affect borrow stacks and the provenance of the resulting pointer value is the same as the provenance of the pointer bytes in memory, we should get out a value that looks like a <code>&amp;mut x</code> (since that is what was written to that memory). Then, we dereference that value creating a <code>Place(&amp;mut x)</code>, for which we subsequently do a <code>&amp;raw</code> on. This means that the pointer yielded by <code>&amp;raw *(load(_1))</code> (stored in <code>_12</code>) has SRW provenance. We can then retag it without issue. Afterwards we should be able to use it to perform a <code>*_12 = 5;</code> operation without causing UB</p>



<a name="276751298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751298">(Mar 26 2022 at 23:13)</a>:</h4>
<p>(I made this a new thread since it's somewhat separate from the old one, sorry <span class="user-mention" data-user-id="137587">@Gankra</span> I couldnt exclude your 2 messages)</p>



<a name="276751309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751309">(Mar 26 2022 at 23:13)</a>:</h4>
<p><span class="user-mention" data-user-id="310518">@Jak{e,ob} Degen</span> regarding the original example, it doesnt even contain a <code>x=x</code> so I am not sure how it even relates to our previous discussion</p>



<a name="276751379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751379">(Mar 26 2022 at 23:14)</a>:</h4>
<blockquote>
<p>This means that the pointer yielded by &amp;raw *(load(_1)) (stored in _12) has SRW provenance.</p>
</blockquote>
<p>Yes, everything is correct until here.</p>
<blockquote>
<p>We can then retag it without issue. Afterwards we should be able to use it to perform a *_12 = 5; operation without causing UB</p>
</blockquote>
<p>This is where things go wrong. The retag adjusts _12 to have SRO provenance.</p>



<a name="276751389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751389">(Mar 26 2022 at 23:15)</a>:</h4>
<p>But how does it know to do that?</p>



<a name="276751392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751392">(Mar 26 2022 at 23:15)</a>:</h4>
<p>(thanks for the very detailed explanation with the example!)</p>



<a name="276751395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751395">(Mar 26 2022 at 23:15)</a>:</h4>
<p>ie based on what information?</p>



<a name="276751400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751400">(Mar 26 2022 at 23:15)</a>:</h4>
<p>based on whether its raw-retagging a <code>*const</code> or <code>*mut</code></p>



<a name="276751456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751456">(Mar 26 2022 at 23:16)</a>:</h4>
<p>oh what... that wasn't in my mind as a possibility at all. I thought these were equivalent</p>



<a name="276751465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751465">(Mar 26 2022 at 23:16)</a>:</h4>
<p>they are almost :/</p>



<a name="276751469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751469">(Mar 26 2022 at 23:17)</a>:</h4>
<p>but when a value crosses from being a reference to being a raw ptr, at that moment the kind of raw ptr matters</p>



<a name="276751476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751476">(Mar 26 2022 at 23:17)</a>:</h4>
<p>i.e., at the cast</p>



<a name="276751479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751479">(Mar 26 2022 at 23:17)</a>:</h4>
<p>that's not just a Miri thing, even the borrow checker makes a distinction there</p>



<a name="276751481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751481">(Mar 26 2022 at 23:17)</a>:</h4>
<p>Oh hmm. Ok, I had no idea about that. That's surprising</p>



<a name="276751482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751482">(Mar 26 2022 at 23:17)</a>:</h4>
<p>yes it is</p>



<a name="276751507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751507">(Mar 26 2022 at 23:18)</a>:</h4>
<p>see <a href="https://github.com/rust-lang/rust/issues/56604">https://github.com/rust-lang/rust/issues/56604</a> for a looong discussion</p>



<a name="276751549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751549">(Mar 26 2022 at 23:19)</a>:</h4>
<p>Alright, I agree that there's no issues around <code>x = x;</code> then</p>



<a name="276751550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751550">(Mar 26 2022 at 23:19)</a>:</h4>
<p>but basically (a) with current SB, it's hard to implement anything else (Cc <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/227">https://github.com/rust-lang/unsafe-code-guidelines/issues/227</a>), and (b) given that the borrow checker distinguishes them, maybe this makes some sense?</p>



<a name="276751596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751596">(Mar 26 2022 at 23:20)</a>:</h4>
<p>How does the borrow checker distinguish?</p>



<a name="276751598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751598">(Mar 26 2022 at 23:20)</a>:</h4>
<p>specifically, for <code>x: &amp;mut T</code> with outstanding shared loans the borrow checker will allow <code>x as *const _</code> but not <code>x as *mut _</code></p>



<a name="276751603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751603">(Mar 26 2022 at 23:20)</a>:</h4>
<p>Ah, interesting</p>



<a name="276751611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751611">(Mar 26 2022 at 23:20)</a>:</h4>
<p>essentially, <code>x as *const _</code> is equivalent to <code>(&amp;*x) as *const _</code></p>



<a name="276751614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751614">(Mar 26 2022 at 23:20)</a>:</h4>
<p>and <code>&amp;*x</code> is ofc allowed when there are outstanding shared loans</p>



<a name="276751625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751625">(Mar 26 2022 at 23:21)</a>:</h4>
<p>Yeah, I'm not super happy about that, but I don't mind too much either</p>



<a name="276751628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751628">(Mar 26 2022 at 23:21)</a>:</h4>
<p>but that is a very good question, since indeed if raw ptr types truly did not matter then that code would not be UB</p>



<a name="276751686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects%20of%20MIR%20assignments/near/276751686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Side-effects.20of.20MIR.20assignments.html#276751686">(Mar 26 2022 at 23:22)</a>:</h4>
<p>now I need to get dinner :D see y'all!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>