<html>
<head><meta charset="utf-8"><title>Should with_addr stay in object bounds? ¬∑ t-lang/wg-unsafe-code-guidelines ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html">Should with_addr stay in object bounds?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278037792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278037792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278037792">(Apr 06 2022 at 15:07)</a>:</h4>
<p>Currently, you can use ptr.with_addr(..) to change the pointer to some wild address, then back to the original address, and the pointer will work again. But this doesn‚Äôt work on CHERI ‚Äî a capability must always point to within the range that it allows access to.</p>
<p>(There is no way around this information-theoretically, because of the compressed 129-bit representation.)</p>
<p>Should we maybe spec with_addr differently so you can‚Äôt leave the provenance / the valid accessible range of the the pointer? If yes, then we should perhaps also spec from_exposed_addr so that the returned pointer has provenance that can potentially be valid in the future.</p>
<p>Are there common coding patterns that people use in practice that change the address of a pointer to outside of the allocation (more than ‚Äúone past‚Äù the allocation), and back again to inside the allocation?</p>



<a name="278038973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278038973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278038973">(Apr 06 2022 at 15:14)</a>:</h4>
<p>Nan boxing, for example</p>



<a name="278039651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278039651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278039651">(Apr 06 2022 at 15:18)</a>:</h4>
<p>But also, what does this get us besides some cheri compliance? From what I understand it's already clear that cheri will not be able to deal with everything that strict provenance Rust allows (shuffling around and reorganizing pointer bytes, for example), so I'm not sure why this particular issue should be special</p>



<a name="278040558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278040558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278040558">(Apr 06 2022 at 15:25)</a>:</h4>
<p>Boxing of u128 works 100% on CHERI, and you can even differentiate between a boxed integer and a functioning capability</p>



<a name="278040740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278040740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278040740">(Apr 06 2022 at 15:26)</a>:</h4>
<p>I guess we get some extra compliance indeed. My understanding was that making a subset of Rust mostly ‚Äújust work‚Äù on CHERI was a major component of this experiment</p>



<a name="278040853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278040853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278040853">(Apr 06 2022 at 15:27)</a>:</h4>
<p>Ideally so that you can pretty much use Miri on normal computers to check that your code will be CHERI-compatible</p>



<a name="278049902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278049902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278049902">(Apr 06 2022 at 16:26)</a>:</h4>
<blockquote>
<p>But this doesn‚Äôt work on CHERI ‚Äî a capability must always point to within the range that it allows access to</p>
</blockquote>
<p>AIUI, this is not correct? There are limits on what CHERI can represent, but I thought CHERI allowed the pointer to leave the allowed range as long as it is sufficiently close</p>



<a name="278049942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278049942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278049942">(Apr 06 2022 at 16:26)</a>:</h4>
<p>where "sufficiently" depends on the size of the allowed range</p>



<a name="278051400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278051400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278051400">(Apr 06 2022 at 16:36)</a>:</h4>
<p>If someone could find a way to perform an experiment with a broad array of Rust software to see how far out of bounds pointers tend to go, that would be extremely useful for future (production) CHERI capability encoding decisions.</p>



<a name="278051821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278051821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278051821">(Apr 06 2022 at 16:39)</a>:</h4>
<p>The bytes crate will set the lowest bit to zero on some pointers that come from an allocation with an odd address, which would make it go out of bounds backwards.</p>



<a name="278054087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278054087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278054087">(Apr 06 2022 at 16:56)</a>:</h4>
<p>That's fine as long as you don't access the out-of-bounds byte.<br>
(We've had to modify some C str/mem functions that do word accesses for optimization to avoid that when targeting CHERI)</p>



<a name="278073830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278073830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278073830">(Apr 06 2022 at 19:27)</a>:</h4>
<p>this does not just pertain to with_addr, it pertains to wrapping_offset in general</p>



<a name="278073861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278073861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278073861">(Apr 06 2022 at 19:27)</a>:</h4>
<p>and that on CHERI was discussed at great length last week in this very Zulip :D no need to re-hash everything...</p>



<a name="278083138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278083138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278083138">(Apr 06 2022 at 20:41)</a>:</h4>
<p>(deleted)</p>



<a name="278091035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278091035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278091035">(Apr 06 2022 at 21:49)</a>:</h4>
<p>Ah sorry, I didn‚Äôt realize that that was what was being discussed there üòÅ I‚Äôll check it out, thanks for the pointer üëÜ</p>



<a name="278104560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278104560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gereeter <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278104560">(Apr 07 2022 at 00:33)</a>:</h4>
<p>Regardless of CHERI details, I'd be very interested in having a <code>with_addr_inbounds</code> prominently available for experimentation. It seems like a surprisingly large class of applications can use it, and especially with how regularly people are unsure about the status of out-of-bounds pointers, having a designated and miri-enforced way to entirely avoid that realm seems useful.</p>
<p>It certainly isn't necessary as an extension to the model (as it is just, e.g. <code>with_addr(addr).offset(0)</code>), and I expect few optimizations will benefit from the extra information. This is just interesting for data gathering and communicating intent.</p>



<a name="278238000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278238000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278238000">(Apr 07 2022 at 23:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="295632">Diggsey</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278049902">said</a>:</p>
<blockquote>
<blockquote>
<p>But this doesn‚Äôt work on CHERI ‚Äî a capability must always point to within the range that it allows access to</p>
</blockquote>
<p>AIUI, this is not correct? There are limits on what CHERI can represent, but I thought CHERI allowed the pointer to leave the allowed range as long as it is sufficiently close</p>
</blockquote>
<p>Correct, I was wrong. There's a bunch of nuance to CHERI Concentrate that I just read up on :3 The address can go approximately 15% below base of the range of the capability, and 25% above the top.</p>



<a name="278238992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278238992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278238992">(Apr 07 2022 at 23:21)</a>:</h4>
<hr>
<p>Perhaps the "tower of weakenings" will have an additional layer near the bottom, which is "only stuff that works on CHERI" like <code>with_addr_inbounds</code></p>



<a name="278239353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278239353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278239353">(Apr 07 2022 at 23:26)</a>:</h4>
<p>Although this would conflict with <a href="https://gankra.github.io/blah/tower-of-weakenings/">Gankra's blog post</a>, which says that <code>strict_provenance</code> is supported by CHERI</p>
<blockquote>
<p>Oh also strict provenance is basically actually implemented in hardware by CHERI, so uh, doing this also just makes your code portable to CHERI. </p>
</blockquote>
<p>I would be in favor of a lint somehow against bare <code>with_addr</code> and <code>wrapping_offset</code>, which seem currently specced to allow going out of bounds and back again (see <a class="stream-topic" data-stream-id="136281" href="/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F">#t-lang/wg-unsafe-code-guidelines &gt; Does wrapping_offset fizzle in cherry soda?</a> ). I see that <code>offset</code> is the "in-bounds" version of <code>wrapping_offset</code>. </p>
<p>I'm not sure about the specifics of the lint.</p>



<a name="278354740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278354740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278354740">(Apr 08 2022 at 19:56)</a>:</h4>
<p>I still hold my position from <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20wrapping_offset.20fizzle.20in.20cherry.20soda.3F">the previous instance of this discussion</a>: this is a platform limitation in CHERI that leads to incorrect behavior of some correct programs, similar to floating point bugs we are seeing on other platforms.<br>
the fact that almost-but-not-quite conformant platforms exist is unfortunate but such is life. at least (unlike with the floating point issues) the fault is very apparent, the program will segfault and that should point at the place where the pointer with the 'mangled' provenance is used.</p>



<a name="278354835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278354835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278354835">(Apr 08 2022 at 19:57)</a>:</h4>
<p>I don't think we can meaningfully lint against <code>with_addr</code>, what alternative would you recommend to people? <code>map_addr</code> has the same problem. we <em>just</em> started telling people to use those APIs rather than bare casts. now do you want to develop and document "even stricter provenance" APIs that can replace them? not sure what they would even look like.</p>



<a name="278369501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278369501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278369501">(Apr 08 2022 at 22:23)</a>:</h4>
<p>In my view, the <code>strict_provenance</code> experiment is still fluid. I think it would be best if we redefined <code>with_addr</code> and <code>map_addr</code> to use <code>offset</code> instead of <code>wrapping_offset</code> ‚Äî the same but with a little more UB.</p>
<p>In my view,</p>
<blockquote>
<p><code>strict_provenance</code> should be the subset of Rust that people aim for because it's future-proof. It also has great tooling. </p>
</blockquote>
<p>So, more than "the subset that is good for compiling/checking". It would be great if "the designated lint and runtime checker for future-proof code" happen to also validate that my Unsafe Rust will work on CHERI.</p>



<a name="278369799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278369799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278369799">(Apr 08 2022 at 22:27)</a>:</h4>
<p>Gankra writes,</p>
<blockquote>
<p><code>wrapping_offset</code> was never the "good" <code>offset</code></p>
</blockquote>
<p>But implicitly with <em>the current version</em> of <code>strict_provenance</code>, with <code>with_addr</code> and <code>map_addr</code> defined in terms of <code>wrapping_offset</code>, we're <em>still pretending</em> that that's the "right" <code>offset</code>.</p>
<p>I see this as a mistake.</p>



<a name="278369908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278369908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278369908">(Apr 08 2022 at 22:29)</a>:</h4>
<p><code>with_addr</code> is (morally) an intrinsic, it doesn't use <code>wrapping_offset</code></p>



<a name="278370385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278370385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278370385">(Apr 08 2022 at 22:34)</a>:</h4>
<p>the point is there are two possible versions of strict provenance: one where "with_addr" is only guaranteed to work for inbounds addresses and one where it is guaranteed to work for any address</p>



<a name="278370415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278370415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278370415">(Apr 08 2022 at 22:35)</a>:</h4>
<p>I think it's at least worth asking the question of which is preferable</p>



<a name="278370537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278370537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278370537">(Apr 08 2022 at 22:36)</a>:</h4>
<p>The UB behavior of <code>with_addr</code> is defined in terms of <code>wrapping_offset</code>. Stdlib docs:</p>
<blockquote>
<p>This is equivalent to using <code>wrapping_offset</code> to offset <code>self</code> to the given address, and therefore has all the same capabilities and restrictions.</p>
</blockquote>
<p>I think this means that it's fine to <code>with_addr</code> to a large offset, and <code>with_addr</code> back to inside the object. Not UB. But the whole CHERI story is much nicer if it would be UB and checked against by Miri.</p>



<a name="278371048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278371048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278371048">(Apr 08 2022 at 22:44)</a>:</h4>
<p>the point is with_addr is an unstable method that was just added, and it's arguable what the semantics there /should/ be</p>



<a name="278373543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278373543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278373543">(Apr 08 2022 at 23:20)</a>:</h4>
<p>if you had something like <code>#[repr(align(1048576))]</code>, would it be wrong to use <code>with_addr</code> with a large offset due to the 9 bits of masking? (i'm just a noob following along at home, in case this is a silly question)</p>



<a name="278373657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278373657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brooks Davis <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278373657">(Apr 08 2022 at 23:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278370537">said</a>:</p>
<blockquote>
<p>I think this means that it's fine to <code>with_addr</code> to a large offset, and <code>with_addr</code> back to inside the object. Not UB. But the whole CHERI story is much nicer if it would be UB and checked against by Miri.</p>
</blockquote>
<p>It would certainly be more convenient for going out of bounds and then coming back in to be UB (it technically is in C). <span class="user-mention" data-user-id="473929">@Alexander Richardson</span> added a sanitizer to catch such cases at runtime in CHERI-LLVM because they are awkward to debug. IIRC the motivating use case was provenance bugs where pointers into a realloc'd buffer were incremented by the offset of the buffers rather than rederived from the new buffer's pointer.<br>
There's a bit more information on the sanitizer and another compiler warning that I think is less relevant to Rust in this report <a href="https://www.capabilitieslimited.co.uk/pdfs/20210917-capltd-cheri-desktop-report-version1-FINAL.pdf">https://www.capabilitieslimited.co.uk/pdfs/20210917-capltd-cheri-desktop-report-version1-FINAL.pdf</a></p>



<a name="278373873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278373873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexander Richardson <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278373873">(Apr 08 2022 at 23:26)</a>:</h4>
<p>So far the sanitizer only checks if the pointer had become unrepresentable, but adjusting it to detect out of bounds pointers instead is pretty simple, it just means emitting more checks and branches.</p>



<a name="278378267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278378267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278378267">(Apr 09 2022 at 00:50)</a>:</h4>
<p>remember that <code>with_addr</code> is similar/equivalent to doing it via usize, or uintptr_t casts in C - going out of bounds in uintptr_t and then back for the cast is _not_ UB in typical C implementations (the spec doesn't technically require <code>(char*)((uintptr_t)p + 1)</code> or any other modification to be valid afaict, so we're already out of spec territory)</p>



<a name="278378316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278378316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278378316">(Apr 09 2022 at 00:51)</a>:</h4>
<p>(CHERI does care, but that's CHERI where you no longer have <code>uintptr_t</code> <code>==</code> meaning equivalence in general)</p>



<a name="278380152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278380152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278380152">(Apr 09 2022 at 01:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278369501">said</a>:</p>
<blockquote>
<p>In my view, the <code>strict_provenance</code> experiment is still fluid. I think it would be best if we redefined <code>with_addr</code> and <code>map_addr</code> to use <code>offset</code> instead of <code>wrapping_offset</code> ‚Äî the same but with a little more UB.</p>
</blockquote>
<p>I disagree strongly; that would make them unsafe</p>



<a name="278397266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278397266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278397266">(Apr 09 2022 at 08:36)</a>:</h4>
<p>What does unsafe mean in this context?</p>



<a name="278397307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278397307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278397307">(Apr 09 2022 at 08:37)</a>:</h4>
<p>"would need to be <code>unsafe fn</code>", which they're not right now: <a href="https://doc.rust-lang.org/nightly/std/primitive.pointer.html#method.with_addr">https://doc.rust-lang.org/nightly/std/primitive.pointer.html#method.with_addr</a></p>



<a name="278397362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278397362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278397362">(Apr 09 2022 at 08:38)</a>:</h4>
<p>Ah. I forgot‚Ä¶ that‚Äôs a good point</p>



<a name="278397477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278397477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278397477">(Apr 09 2022 at 08:41)</a>:</h4>
<p>Bummer</p>



<a name="278409231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278409231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278409231">(Apr 09 2022 at 13:02)</a>:</h4>
<p>If we have both <code>offset</code> and <code>wrapping_offset</code>, it would make sense to have both <code>with_addr</code> and an unsafe <code>with_inbounds_addr</code>. That does assume that say LLVM could make use of the latter.</p>
<p>I don't recall what optimizations <code>offset</code> allows. It's possible we could just define <code>with_inbounds_addr</code> to be <code>with_addr(...).offset(0)</code>.</p>



<a name="278410464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278410464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278410464">(Apr 09 2022 at 13:33)</a>:</h4>
<p>offset is the inbounds version, so it does the normal inbounds optimizations when possible. But using an offset of 0 when you're possibly out of bounds sounds very-not-good.</p>



<a name="278410816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278410816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278410816">(Apr 09 2022 at 13:43)</a>:</h4>
<p><code>null.offset(0)</code> should be valid, but <code>&lt;invalid&gt;.offset(0)</code> I believe is not.</p>



<a name="278410821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278410821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278410821">(Apr 09 2022 at 13:43)</a>:</h4>
<p>The point is you're using <code>with_inbounds_addr</code> to declare that you're in bounds.</p>



<a name="278410940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278410940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278410940">(Apr 09 2022 at 13:45)</a>:</h4>
<p>You could probably be clearer about that with <code>p.with_inbounds_addr(addr)</code> being implemented (or intrinsic'd as) <code>p.offset((addr-p.addr()).try_into().unwrap_unchecked())</code></p>



<a name="278411009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278411009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278411009">(Apr 09 2022 at 13:46)</a>:</h4>
<p>This would also mean that <code>p.with_inbounds_addr(0)</code> is only valid for a null pointer.</p>



<a name="278411111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278411111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278411111">(Apr 09 2022 at 13:48)</a>:</h4>
<p>(And should be clear to llvm, IDK if otherwise)</p>



<a name="278411378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278411378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278411378">(Apr 09 2022 at 13:55)</a>:</h4>
<p>Seems like it would make a terrible IR mess. It's quite possible LLVM will get a <code>with_addr</code> instruction with an <code>inbounds</code> flag though.</p>



<a name="278416286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278416286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278416286">(Apr 09 2022 at 15:52)</a>:</h4>
<p>For CHERI, the important thing IMO is to express intention, so that you can tell which crates are supposed to be compatible just from the source. </p>
<p>But for this, an alias of with_addr could technically suffice. It doesn‚Äôt need to introduce UB</p>



<a name="278416332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278416332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278416332">(Apr 09 2022 at 15:53)</a>:</h4>
<p>Independently, I‚Äôm sympathetic to an unsafe variant of with_addr if that helps LLVM optimize better</p>



<a name="278444328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278444328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278444328">(Apr 10 2022 at 02:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278416286">said</a>:</p>
<blockquote>
<p>For CHERI, the important thing IMO is to express intention, so that you can tell which crates are supposed to be compatible just from the source. </p>
<p>But for this, an alias of with_addr could technically suffice. It doesn‚Äôt need to introduce UB</p>
</blockquote>
<p>Even on CHERI, you don't want to use a <code>with_inbounds_addr</code> <em>most</em> of the time, because <code>with_addr</code> is mostly for doing pointer tricks like alignment tagging which <em>do</em> go out of bounds of the object (for size &lt; align).</p>



<a name="278444453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278444453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278444453">(Apr 10 2022 at 02:58)</a>:</h4>
<p>I'm sympathetic to the desire to be able to statically know whether things are "supposed to" work with a CHERI C style limited safe offset range, but <code>map_addr</code> already can't be used under miri to check if a use works on CHERI C without just running it on a CHERI C implementation.</p>



<a name="278472308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278472308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278472308">(Apr 10 2022 at 14:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278410816">said</a>:</p>
<blockquote>
<p><code>null.offset(0)</code> should be valid, but <code>&lt;invalid&gt;.offset(0)</code> I believe is not.</p>
</blockquote>
<p>IMO <code>offset(0)</code> should be valid iff a ZST access at that ptr is valid.<br>
so, <code>ptr::invalid(...).offset(0)</code> is fine. <code>null.offset(0)</code> is not.</p>



<a name="278472384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278472384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278472384">(Apr 10 2022 at 14:55)</a>:</h4>
<p>that's what Miri does, anyway, as this code shows</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(strict_provenance)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">invalid</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">13</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// fine</span>
<span class="w">   </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">invalid</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// UB</span>
<span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278472526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278472526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278472526">(Apr 10 2022 at 14:59)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> what types have size &lt; align?</p>



<a name="278472812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278472812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278472812">(Apr 10 2022 at 15:04)</a>:</h4>
<p>We could (eventually) just add a Miri flag which does an <code>offset</code> check also on <code>with_addr</code> and <code>map_addr</code>.</p>



<a name="278472908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278472908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278472908">(Apr 10 2022 at 15:06)</a>:</h4>
<p>By the way the ‚ÄúCHERI C‚Äù safe offset range is built into CHERI, it isn‚Äôt C-specific. It‚Äôs possible that there will be a different capability encoding in the future ‚Äî Presumably it would still allow going under and over by similar amounts</p>



<a name="278473292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473292">(Apr 10 2022 at 15:14)</a>:</h4>
<p>CHERI Concentrate (the current scheme) allows going &gt;= 2kB below range and &gt;=4kB above, on 64-bit, but it would be very awkward to put such numbers in a definition of Rust :(</p>



<a name="278473373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473373">(Apr 10 2022 at 15:16)</a>:</h4>
<p>The term ‚ÄúZST access‚Äù on Miri confuses me. Surely Miri has borrow stacks per byte of the memory, and a one-past pointer couldn‚Äôt be accessed ü§îü§î</p>



<a name="278473393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473393">(Apr 10 2022 at 15:17)</a>:</h4>
<p>ZST stands for zero sized type so there isnt really any bytes to access its basically a no-op</p>



<a name="278473781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473781">(Apr 10 2022 at 15:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278473373">said</a>:</p>
<blockquote>
<p>The term ‚ÄúZST access‚Äù on Miri confuses me. Surely Miri has borrow stacks per byte of the memory, and a one-past pointer couldn‚Äôt be accessed ü§îü§î</p>
</blockquote>
<p>Stacked Borrows indeed has nothing to say about ZST accesses</p>



<a name="278473789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473789">(Apr 10 2022 at 15:25)</a>:</h4>
<p>but other checks do; they still need to be 'in-bounds'</p>



<a name="278473834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473834">(Apr 10 2022 at 15:26)</a>:</h4>
<p>in that sense it is not entirely a NOP; it can still cause UB</p>



<a name="278473837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278473837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278473837">(Apr 10 2022 at 15:26)</a>:</h4>
<p>e.g. <code>std::ptr::invalid::&lt;()&gt;(0).load()</code> is UB</p>



<a name="278475714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278475714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278475714">(Apr 10 2022 at 16:07)</a>:</h4>
<p>Cool, thanks. I suppose that ZST access is valid if there‚Äôs an allocated byte on that address or on the address before it</p>



<a name="278475774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278475774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278475774">(Apr 10 2022 at 16:08)</a>:</h4>
<p>yes but there are more cases where it is valid... the <code>ptr</code> module docs explain this in more detail</p>



<a name="278475776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278475776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278475776">(Apr 10 2022 at 16:08)</a>:</h4>
<p>this is allowed: <code>std::ptr::invalid::&lt;()&gt;(1).load()</code></p>



<a name="278475858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278475858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278475858">(Apr 10 2022 at 16:10)</a>:</h4>
<p>Cool, thanks for the pointer. Complicated stuff.</p>



<a name="278488103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278488103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278488103">(Apr 10 2022 at 20:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278473292">said</a>:</p>
<blockquote>
<p>CHERI Concentrate (the current scheme) allows going &gt;= 2kB below range and &gt;=4kB above, on 64-bit, but it would be very awkward to put such numbers in a definition of Rust :(</p>
</blockquote>
<p>It's not that simple. Morello uses a tweaked version of CHERI Concentrate with more bits dedicated to the bounds than our 64-bit encoding scheme (used on CHERI-RISC-V, and the now-abandoned CHERI-MIPS), and how far you can go out of bounds is a function of the length of the bounds themselves, just with a minimum based on the number of bounds bits you have. CHERI on 32-bit architectures has much tighter requirements (though we've not tried to optimise it, just do the simple thing of making it work with the existing scheme down-sized). Future versions of CHERI+Arm-A, should they exist, may well change the bit allocation again. This is always going to be architecture-specific and you should never put precise guarantees in the language unless you're very sure every implementation will be able to meet them; C's banning of everything other than one-past-the-end is very attractive in that regard.</p>



<a name="278488285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278488285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278488285">(Apr 10 2022 at 20:33)</a>:</h4>
<p>That‚Äôs why I‚Äôm curious if alignment &lt; size ever happens ‚Äî does it really not work on CHERI?</p>



<a name="278488329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278488329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278488329">(Apr 10 2022 at 20:34)</a>:</h4>
<p>It does work, but there are limits to how unaligned your allocation can be for large sizes</p>



<a name="278488338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278488338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278488338">(Apr 10 2022 at 20:34)</a>:</h4>
<p>The short answer is on CHERI-RISC-V you get I think ~12 leading significant bits before the rest of the length must be 0</p>



<a name="278488349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278488349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278488349">(Apr 10 2022 at 20:35)</a>:</h4>
<p>12 or 14, I forget the exact details</p>



<a name="278488767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278488767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jessica Clarke <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278488767">(Apr 10 2022 at 20:44)</a>:</h4>
<p>Ok, CHERI Clang rounds up to 10 significant bits on CHERI-RISC-V and 12 on Morello</p>



<a name="278489042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278489042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278489042">(Apr 10 2022 at 20:51)</a>:</h4>
<p>As far as I understand, this is a restriction on how the allocation should be aligned ‚Äî not what addresses are representable. So from the view of pointer tagging ((mis)using low-order bits of the address), there seems to be nothing different about CHERI</p>



<a name="278489193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278489193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278489193">(Apr 10 2022 at 20:54)</a>:</h4>
<p>CAD97 said that with_addr_inbounds wouldn‚Äôt work for pointer taking on CHERI ‚Äî but I suspect it does</p>



<a name="278491160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491160">(Apr 10 2022 at 21:38)</a>:</h4>
<p><span class="user-mention" data-user-id="465167">@Bram Geron</span> the difference is what "inbounds" means</p>



<a name="278491169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491169">(Apr 10 2022 at 21:38)</a>:</h4>
<p>Pointer tagging definitely works on CHERI</p>



<a name="278491179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491179">(Apr 10 2022 at 21:39)</a>:</h4>
<p>But <code>inbounds</code> w.r.t. Rust pointers means inbounds in the C manner</p>



<a name="278491186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491186">(Apr 10 2022 at 21:39)</a>:</h4>
<p>That is, only one-byte-past-the-end</p>



<a name="278491243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491243">(Apr 10 2022 at 21:40)</a>:</h4>
<p>Rust guarantees that size is a multiple of alignment, but 0 is a multiple of any alignment</p>



<a name="278491251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491251">(Apr 10 2022 at 21:40)</a>:</h4>
<p>And doing an inbounds offset on a pointer to a zero-sized allocation with nonzero offset is UB</p>



<a name="278491262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491262">(Apr 10 2022 at 21:41)</a>:</h4>
<p>Thus, using non-<code>wrapping_offest</code> to tag pointers breaks for ZSTs</p>



<a name="278491268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491268">(Apr 10 2022 at 21:41)</a>:</h4>
<p>That's a pure Rust AM restriction, nothing to do with CHERI</p>



<a name="278491802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278491802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278491802">(Apr 10 2022 at 21:55)</a>:</h4>
<p>Right. Thanks for the explanation</p>



<a name="278514977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278514977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278514977">(Apr 11 2022 at 07:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="465167">Bram Geron</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F/near/278472526">said</a>:</p>
<blockquote>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> what types have size &lt; align?</p>
</blockquote>
<p>Size is always a multiple of align, so the only ones with <code>size &lt; align</code> are those with <code>size == 0</code>.  (Which can have non-1 alignment, see <code>[i32; 0]</code> for example.)</p>
<p>As for validity of <code>offset</code>, I have a hypothesis in <a href="#narrow/stream/219381-t-libs/topic/Behavior.20of.20dangling.20pointer.20arithmetic.20operations/near/277190943">https://rust-lang.zulipchat.com/#narrow/stream/219381-t-libs/topic/Behavior.20of.20dangling.20pointer.20arithmetic.20operations/near/277190943</a> , though I don't know if it makes sense to actually have it that way.</p>



<a name="278531333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should%20with_addr%20stay%20in%20object%20bounds%3F/near/278531333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Should.20with_addr.20stay.20in.20object.20bounds.3F.html#278531333">(Apr 11 2022 at 10:00)</a>:</h4>
<p>There can be allocations where size is not a multiple of align, even if that's true of Rust types.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>