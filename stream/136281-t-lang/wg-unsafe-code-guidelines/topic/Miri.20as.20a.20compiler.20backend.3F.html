<html>
<head><meta charset="utf-8"><title>Miri as a compiler backend? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html">Miri as a compiler backend?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278059402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278059402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278059402">(Apr 06 2022 at 17:36)</a>:</h4>
<p>How feasible do you think it would be to make a rustc backend that essentially does the same checks as MIRI, but is compiled instead of interpreted? Perhaps it could even be a compiler middleware, so it transforms the MIR into new MIR which emulates the rust abstract machine, and then that MIR can be passed through to a real backend like LLVM.</p>



<a name="278069817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278069817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278069817">(Apr 06 2022 at 18:55)</a>:</h4>
<p>That sounds like what <a href="https://github.com/viperproject/prusti-dev">Prusti</a>, <a href="https://github.com/xldenis/creusot">Cruseot</a> and <a href="https://github.com/secure-foundations/verus">Verus</a> do.</p>



<a name="278070382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278070382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278070382">(Apr 06 2022 at 18:59)</a>:</h4>
<p>I think that it may be possible, but I'm not sure you'd see particularly significant optimizations. At least in SB with raw pointer tagging, the majority of the runtime of Miri is in the Stacked Borrows implementation, not interpreting of Rust. The situation is significantly less dire without raw pointer tagging.</p>



<a name="278073528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278073528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278073528">(Apr 06 2022 at 19:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="400735">Pointerbender</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F/near/278069817">said</a>:</p>
<blockquote>
<p>That sounds like what <a href="https://github.com/viperproject/prusti-dev">Prusti</a>, <a href="https://github.com/xldenis/creusot">Cruseot</a> and <a href="https://github.com/secure-foundations/verus">Verus</a> do.</p>
</blockquote>
<p>no, those tools (at least the first 2) do verification. that's a very different problem statement. they want to show that <em>all</em> executions of a program are correct; Miri (like sanitizers) wants to show that <em>the one execution currently happenig</em> is fine (not causing UB).</p>



<a name="278073621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278073621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278073621">(Apr 06 2022 at 19:25)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggsey</span> that's basically the ubsan approach. no idea how hard that is for the kinds of checks Miri does...</p>



<a name="278089404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278089404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278089404">(Apr 06 2022 at 21:35)</a>:</h4>
<p>This is always possible because we can just embed in the machine code everything Miri does, but Miri does a lot and it may cause even slower execution (because of instruction cache). I'm also not sure what optimizations we'll be able to do without breaking the checks. So we can't rely on LLVM for optimized codegen.</p>



<a name="278089534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278089534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278089534">(Apr 06 2022 at 21:36)</a>:</h4>
<p>well we can still assume LLVM is bug-free and only optimizes away checks that are actually redundant</p>



<a name="278089555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278089555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278089555">(Apr 06 2022 at 21:36)</a>:</h4>
<p>sure, there is a higher risk of false results than with plain Miri, but it's also faster, so -- it's a tradeoff</p>



<a name="278090482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278090482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278090482">(Apr 06 2022 at 21:44)</a>:</h4>
<blockquote>
<p>well we can still assume LLVM is bug-free and only optimizes away checks that are actually redundant</p>
</blockquote>
<p>I don't think LLVM is buggy but Miri may do things that if compiled into LLVM IR are UB (I have to admit I'm don't know much about Miri's code, though).</p>



<a name="278090755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278090755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278090755">(Apr 06 2022 at 21:46)</a>:</h4>
<p>I suspect an LLVM IR Miri would just look like ASan from a great distance</p>



<a name="278090778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278090778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278090778">(Apr 06 2022 at 21:47)</a>:</h4>
<p>Just doing an extra function call here there and everywhere which may crash</p>



<a name="278090911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278090911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278090911">(Apr 06 2022 at 21:48)</a>:</h4>
<p>My biggest concern is that the fact that function calls and returns have meaning to SB will wreck inlining... And there go all the optimizations</p>



<a name="278091146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278091146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278091146">(Apr 06 2022 at 21:50)</a>:</h4>
<p>I don't want to tell people not to do this, I just think that between the sheer number of checks that Miri does compared to ASan and the amount of time in the SB runtime (which is compiled Rust) we have better opportunities for improvement elsewhere.</p>



<a name="278094426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278094426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278094426">(Apr 06 2022 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="340138">Chayim Refael Friedman</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F/near/278090482">said</a>:</p>
<blockquote>
<blockquote>
<p>well we can still assume LLVM is bug-free and only optimizes away checks that are actually redundant</p>
</blockquote>
<p>I don't think LLVM is buggy but Miri may do things that if compiled into LLVM IR are UB (I have to admit I'm don't know much about Miri's code, though).</p>
</blockquote>
<p>well that would be a bug in the instrumentation pass...</p>



<a name="278102937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278102937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278102937">(Apr 07 2022 at 00:07)</a>:</h4>
<p>Yeah I imagine the main benefits would come from inlining the MIRI checks into the source code itself</p>



<a name="278102956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278102956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278102956">(Apr 07 2022 at 00:07)</a>:</h4>
<p>since there may be cases where the check is not necessary given knowledge of values at that point in the code</p>



<a name="278103066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278103066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278103066">(Apr 07 2022 at 00:09)</a>:</h4>
<p>it's also possible there's a lot of redundant checking of constraints, which can't actually be violated given knowledge of the code being executed</p>



<a name="278103076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278103076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278103076">(Apr 07 2022 at 00:09)</a>:</h4>
<p>and llvm could take advantage of that</p>



<a name="278103352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278103352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278103352">(Apr 07 2022 at 00:14)</a>:</h4>
<p>I do not think that any of the stacked borrows checks will inline</p>



<a name="278103379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri%20as%20a%20compiler%20backend%3F/near/278103379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Miri.20as.20a.20compiler.20backend.3F.html#278103379">(Apr 07 2022 at 00:14)</a>:</h4>
<p>Alignment checks will probably clean up a bit</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>