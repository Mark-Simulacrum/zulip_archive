<html>
<head><meta charset="utf-8"><title>abomonation and strict provenance · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html">abomonation and strict provenance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276297244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276297244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276297244">(Mar 23 2022 at 07:43)</a>:</h4>
<p>I'm curious if <a href="https://github.com/TimelyDataflow/abomonation">https://github.com/TimelyDataflow/abomonation</a> will work with strict provenance or requires changes.</p>



<a name="276313414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276313414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276313414">(Mar 23 2022 at 10:35)</a>:</h4>
<p>I don't think abomonation was ever considered "sound", because AFAICT it already does the no-go "transmute between pointers and integers", and whatnot</p>



<a name="276315695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276315695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276315695">(Mar 23 2022 at 10:54)</a>:</h4>
<p>As far as I understand abomonation is wildly unsound. As in "none of its tests pass under miri" unsound.</p>



<a name="276338877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276338877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276338877">(Mar 23 2022 at 14:13)</a>:</h4>
<p>Abomonation is so wildly unsound that its test suite doesn't even get to the aliasing checking parts of Miri, so I don't think it is worth considering.</p>



<a name="276339077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276339077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276339077">(Mar 23 2022 at 14:15)</a>:</h4>
<p>It fails because of alignment problems, and in any case I wouldn't suggest using abomonation because everywhere I've seen it used also trips over the same alignment problems, and the whole design encourages leaking pointer addresses into serialized data.</p>



<a name="276388028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276388028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> krdln <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276388028">(Mar 23 2022 at 19:31)</a>:</h4>
<blockquote>
<p>transmute between pointers and integers</p>
</blockquote>
<p>I looked at abomonation and it looks like it's actually isn't <em>that</em> bad – looks like all the pointer casts are just between different kinds of pointers. <a href="https://github.com/TimelyDataflow/abomonation/pull/43">With some tweaks</a> I was even able to make tests pass under miri (well, needed to disable alignment checking (and validation, which turns out also checks alignment))</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">env</span><span class="w"> </span><span class="n">MIRIFLAGS</span><span class="o">='-</span><span class="n">Zmiri</span><span class="o">-</span><span class="n">disable</span><span class="o">-</span><span class="n">alignment</span><span class="o">-</span><span class="n">check</span><span class="w"> </span><span class="o">-</span><span class="n">Zmiri</span><span class="o">-</span><span class="n">disable</span><span class="o">-</span><span class="n">validation</span><span class="w"> </span><span class="o">-</span><span class="n">Zmiri</span><span class="o">-</span><span class="n">tag</span><span class="o">-</span><span class="n">raw</span><span class="o">-</span><span class="n">pointers</span><span class="o">'</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">miri</span><span class="w"> </span><span class="n">test</span><span class="w"></span>
</code></pre></div>
<p>So... while abomonation has its sins (mostly reading padding &amp; totally ignoring alignment), I think it's actually well-behaved wrt aliasing &amp; provenance (or at least, there's nothing inherent in its design that would prevent that)</p>



<a name="276390631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276390631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276390631">(Mar 23 2022 at 19:54)</a>:</h4>
<p>hmm if it removes provenance first by replacing pointers in memory with plain integers, maybe it could work, though then it can't use Rust types because it would be creating invalid <code>&amp;T</code>s and whatnot</p>



<a name="276390681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276390681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276390681">(Mar 23 2022 at 19:54)</a>:</h4>
<p>(I was misremembering its design as "it serializes the data as-is and then patches it up when loading", but I guess that's wrong?)</p>



<a name="276390833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276390833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276390833">(Mar 23 2022 at 19:55)</a>:</h4>
<p>Not sure about abomonation. That design is what blender does though. It even fixes structs when fields are added or removed or when the byte order or pointer sizes change.</p>



<a name="276391080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276391080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276391080">(Mar 23 2022 at 19:57)</a>:</h4>
<p>if you limit yourself to well-aligned pointers you can treat the entire chunk of memory as a <code>[MaybeUninit&lt;*mut T&gt;]</code> (and basically replace every pointer with <code>ptr::invalid(p.offset_from(chunk_base))</code>) which simplifies the problem massively</p>



<a name="276391100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276391100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276391100">(Mar 23 2022 at 19:57)</a>:</h4>
<p>downside is... you have to know where the pointers are - but you should be able to derive that</p>



<a name="276391359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276391359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276391359">(Mar 23 2022 at 19:59)</a>:</h4>
<p>I sketched something recently that would let you efficiently "rehydrate" ridiculous amounts of data generated by a build script, into a <code>static</code>, which did the inverse of that (using <code>union { *T, usize }</code>, which isn't the best option sadly but it works well enough)</p>



<a name="276391565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276391565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276391565">(Mar 23 2022 at 20:00)</a>:</h4>
<p>(the build script thing is worse because you have a harder time guaranteeing you know where the fields are, and you want to avoid generating ASTs in the first place)</p>



<a name="276395711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276395711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> krdln <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276395711">(Mar 23 2022 at 20:31)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Abomonation actually doesn't care at all what values of the serialized pointers are (i thought before it needs to know at least offset, but instead, it just relies on ordering), so they could all have the same value, like <code>dangling</code> (true uninit won't fly as it could eg. break tags in options). So, I guess the only problem is "patching data up when loading", but when loading, the whole provenance case seems very simple as all pointers are derived from the same allocation.</p>



<a name="276399043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276399043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276399043">(Mar 23 2022 at 20:55)</a>:</h4>
<p>Gah sorry I misread an error at first</p>



<a name="276399220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276399220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276399220">(Mar 23 2022 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="125261">@krdln</span> I'm not sure exactly what you're doing to make the <code>abomonation</code> tests pass. They don't pass due to a provenance problem on this line <a href="https://github.com/TimelyDataflow/abomonation/blob/c2b23534549a5aa09a70bb471379bd436a2f27e1/src/lib.rs#L127">https://github.com/TimelyDataflow/abomonation/blob/c2b23534549a5aa09a70bb471379bd436a2f27e1/src/lib.rs#L127</a></p>
<p>The problem is that the reference from <code>get_unchecked_mut</code> is a <code>&amp;mut u8</code>, so it can't be reborrowed into a reference where the referent is any larger than 1.</p>



<a name="276399425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276399425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276399425">(Mar 23 2022 at 20:58)</a>:</h4>
<p>This is the error (not sure if this Miri commit is available on nightly Rust yet)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="o">-</span>-&gt; <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">abomonation</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">127</span>:<span class="mi">30</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">127</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">split1</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                              </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                              </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                              </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reborrow</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1469878</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Unique</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">alloc310690</span><span class="p">[</span><span class="mh">0x1</span><span class="p">],</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">borrow</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">location</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                              </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">reborrow</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">alloc310690</span><span class="p">[</span><span class="mh">0x0</span><span class="o">..</span><span class="mh">0x18</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
</code></pre></div>



<a name="276400178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276400178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> krdln <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276400178">(Mar 23 2022 at 21:03)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> <a href="https://github.com/TimelyDataflow/abomonation/pull/43">I've linked a PR</a> with the changes I needed to make (which also gets rids of transmutes, but that's kinda orthogonal). So that line in <code>as_ref</code> should simply use <code>as_mut_ref</code> (oh, I see you've edited :)), the other fix was to ditch casting these "pointers to the first element" (<code>get_unchecked(0)</code>) and cast a pointer to the whole slice instead. And these two fixes were enough</p>



<a name="276401968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276401968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276401968">(Mar 23 2022 at 21:18)</a>:</h4>
<p>That is very cool! In my experience, there are a lot of provenance issues in libraries that are not fundamental so personally I'm much more worried about teaching the rules and working through the backlog of issues we have.</p>
<p>I think <code>abomonation</code> needs some breaking changes to be usable, but at least this PR fixes some things.</p>



<a name="276402034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276402034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276402034">(Mar 23 2022 at 21:18)</a>:</h4>
<p>Also if people are interested, I think <code>rkyv</code> is a bit complicated from a provenance perspective. It does a bunch of stuff with relative pointers, and it's unclear to me if there's any way to support those.</p>



<a name="276414627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276414627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276414627">(Mar 23 2022 at 23:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance/near/276401968">said</a>:</p>
<blockquote>
<p>I think <code>abomonation</code> needs some breaking changes to be usable, but at least this PR fixes some things.</p>
</blockquote>
<p>Given that they haven't released (or even made a commit) in years I'm doubtful they want changes, let alone breaking changes.</p>



<a name="276415184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276415184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276415184">(Mar 23 2022 at 23:19)</a>:</h4>
<p>Idk how to feel about that.<br>
Tbh I would be equally happy to see the whole thing abandoned as I would be to see it patched. At least it has a RustSec advisory, so people who care can't miss that the implementation has problems.</p>



<a name="276415373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276415373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276415373">(Mar 23 2022 at 23:21)</a>:</h4>
<p>Oh, dtolnay is using it. That's unfortunate.</p>



<a name="276732186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732186">(Mar 26 2022 at 15:52)</a>:</h4>
<blockquote>
<p>ditch casting these "pointers to the first element" (get_unchecked(0)) and cast a pointer to the whole slice instead</p>
</blockquote>
<p><code>as_ptr</code> is a thing on slices, no need to reach for casts ;)</p>



<a name="276732244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732244">(Mar 26 2022 at 15:54)</a>:</h4>
<p>Though <code>&lt;&amp;mut [T]&gt;::as_ptr</code> is functionally different from <code>&amp;mut [T] as *const T</code> currently.</p>



<a name="276732303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732303">(Mar 26 2022 at 15:55)</a>:</h4>
<p>if you want to mutate, use <code>as_mut_ptr</code></p>



<a name="276732342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732342">(Mar 26 2022 at 15:56)</a>:</h4>
<p>if you dont mutate they should be equivalent</p>



<a name="276732435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732435">(Mar 26 2022 at 15:58)</a>:</h4>
<p>if you're using *const T for anything other than Implementing NonNull you're clowning on yourself imo</p>



<a name="276732459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732459">(Mar 26 2022 at 15:59)</a>:</h4>
<p>Isn't NonNull a *mut T internally though?</p>



<a name="276732467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732467">(Mar 26 2022 at 15:59)</a>:</h4>
<p>Nope, since covariance.</p>



<a name="276732567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732567">(Mar 26 2022 at 16:00)</a>:</h4>
<p>it provides a facade of *mut T but contains *const T</p>



<a name="276732590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732590">(Mar 26 2022 at 16:00)</a>:</h4>
<p>because *const T is ~useless but has covariance</p>



<a name="276732611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732611">(Mar 26 2022 at 16:01)</a>:</h4>
<p>I've certainly used *const in foreign function signatures</p>



<a name="276732618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732618">(Mar 26 2022 at 16:01)</a>:</h4>
<p>yeah that's the other motivation</p>



<a name="276732624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732624">(Mar 26 2022 at 16:01)</a>:</h4>
<p>I've used <code>*const T</code> in PhantomData for variance xlang_abi::traits::DynPtr.</p>



<a name="276732628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732628">(Mar 26 2022 at 16:01)</a>:</h4>
<p>basically if I could go back in time I would make rust only have *T but you could add the mut and const in a function signature for reflecting the FFI API</p>



<a name="276732703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732703">(Mar 26 2022 at 16:03)</a>:</h4>
<p>this and other great new features in rust 3.2</p>



<a name="276732765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/276732765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#276732765">(Mar 26 2022 at 16:04)</a>:</h4>
<p>this would of course result in disaster in 10 years when someone insists that it's very important for supporting this bespoke architecture where they use that distinction to have totally different reprs/semantics for rodata and actual data <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="277302755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/277302755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#277302755">(Mar 31 2022 at 15:56)</a>:</h4>
<p>I wonder about ignominie <a href="https://github.com/nox/ignominie">https://github.com/nox/ignominie</a></p>
<p>Though I wrote it forever ago to scratch an itch, so I would need to revisit it, write tests that run under miri, etc</p>



<a name="277302945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/277302945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#277302945">(Mar 31 2022 at 15:58)</a>:</h4>
<p><a href="https://github.com/nox/ignominie/blob/master/src/lib.rs#L114">https://github.com/nox/ignominie/blob/master/src/lib.rs#L114</a></p>
<p>So old it even cares about signaling NaNs. Anyway it's like abomonation IIRC but the input blob contains offsets to the start instead of pointers, etc</p>



<a name="277321020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/277321020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> riking <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#277321020">(Mar 31 2022 at 18:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance/near/276732765">said</a>:</p>
<blockquote>
<p>this would of course result in disaster in 10 years when someone insists that it's very important for supporting this bespoke architecture where they use that distinction to have totally different reprs/semantics for rodata and actual data <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>
</blockquote>
<p>Arduino (C++) famously has constant address-space problems with beginners using string constants</p>



<a name="277331880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation%20and%20strict%20provenance/near/277331880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance.html#277331880">(Mar 31 2022 at 19:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263648">nox</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/abomonation.20and.20strict.20provenance/near/277302755">said</a>:</p>
<blockquote>
<p>I wonder about ignominie <a href="https://github.com/nox/ignominie">https://github.com/nox/ignominie</a></p>
<p>Though I wrote it forever ago to scratch an itch, so I would need to revisit it, write tests that run under miri, etc</p>
</blockquote>
<p>I'll do the Miri thing if you write tests or just code in general that exercises it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>