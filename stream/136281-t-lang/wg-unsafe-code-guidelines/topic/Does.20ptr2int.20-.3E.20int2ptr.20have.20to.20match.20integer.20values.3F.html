<html>
<head><meta charset="utf-8"><title>Does ptr2int -&gt; int2ptr have to match integer values? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html">Does ptr2int -&gt; int2ptr have to match integer values?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278109752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278109752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278109752">(Apr 07 2022 at 02:09)</a>:</h4>
<p>What I read from this is that you can have an allocation <code>a..b</code>, use <code>wrapping_offset</code> to produce an out of bounds pointer and apply ptr2int to get value <code>c</code>, then later apply <code>int2ptr(d)</code> and get a pointer with access over <code>a..b</code>, where all of <code>a, c, d</code> are not related to each other in any way.</p>
<p>Even C/C++, which has the "roundtrip rule" and PNVI-ae-udi, does not allow anything like this kind of lack of spacial locality due to other rules in the standard: because pointers have to be inbounds at all times, we can say that <code>c</code> and <code>d</code> are both in <code>a..=b</code>, and AFAICT the roundtrip rule actually requires <code>c == d</code> as well:</p>
<p><a href="https://eel.is/c++draft/expr.reinterpret.cast#5">https://eel.is/c++draft/expr.reinterpret.cast#5</a></p>
<blockquote>
<p>A value of integral type or enumeration type can be explicitly converted to a pointer. A pointer converted to an integer of sufficient size (if any such exists on the implementation) and back to the same pointer type will have its original value; mappings between pointers and integers are otherwise implementation-defined.</p>
</blockquote>



<a name="278110393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278110393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278110393">(Apr 07 2022 at 02:22)</a>:</h4>
<p>It isn't completely a loss for static/dynamic analyzers, since you could say that each int2ptr constructs a new variable in the analyzer representing the provenance that was picked up, initially unconstrained, and then on first use almost all possible provenances are excluded (i.e. if you take the <code>int2ptr(d)</code> from above and offset it to <code>e</code> before reading from it, then you can deduce that <code>e</code> is in <code>a..b</code>).</p>
<p>There is one special case: if no pointers have ever been exposed then <code>int2ptr(d)</code> is UB on its own, even if you just discard the value. That is an undesirable property if you don't want false negatives in an analyzer, since it is hard to tell if exposed pointers have been created in the past if you can't see all the startup code and so on. It is also an optimization issue since then you can't lift it past if statements. An easy fix here is to say that <code>int2ptr</code> is <em>also</em> allowed to act like <code>invalid</code> (as one of its nondeterministic options), so that if no pointers have been exposed then it is just equivalent to <code>invalid</code>.</p>



<a name="278127411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278127411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278127411">(Apr 07 2022 at 07:42)</a>:</h4>
<blockquote>
<p>There is one special case: if no pointers have ever been exposed then int2ptr(d) is UB on its own, even if you just discard the value.</p>
</blockquote>
<p>Surely <code>int2ptr</code> in this situation would just result in a pointer with invalid provenance and not be UB.</p>



<a name="278157607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278157607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278157607">(Apr 07 2022 at 12:41)</a>:</h4>
<p>That's what I would suggest as well. I'm calling it out explicitly as part of the working model for this stuff</p>



<a name="278198306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278198306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278198306">(Apr 07 2022 at 17:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278127411">said</a>:</p>
<blockquote>
<blockquote>
<p>There is one special case: if no pointers have ever been exposed then int2ptr(d) is UB on its own, even if you just discard the value.</p>
</blockquote>
<p>Surely <code>int2ptr</code> in this situation would just result in a pointer with invalid provenance and not be UB.</p>
</blockquote>
<p>hm, yeah we probably want that. a naive implementation of angelic nondeterminism would do something odd here; we can just say that the invalid provenance is always 'exposed' and hence avoid that pitfall. (i.e., exactly what <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> said.)</p>



<a name="278198433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278198433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278198433">(Apr 07 2022 at 17:25)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> I am sorry the docs were not clear; it was definitely my intent for this to be <em>any</em> (exposed) provenance. that is a very easy to describe model, and relatively straight-forward to describe formally as well.<br>
As far as I am concerned, if you use <code>from_exposed_addr</code> you opted out of proper checking, so I dont mind that.</p>



<a name="278198689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278198689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278198689">(Apr 07 2022 at 17:27)</a>:</h4>
<p>if we ignore stacked borrows, it is also not that hard to check actually, in a style similar to PNVI-ae-udi: for each <code>from_exposed_addr</code>, create a fresh "symbolic" provenance. the AM state carries a table mapping symbolic provenance to possible <code>AllocId</code>s. each time a pointer with this provenance has to be in-bounds of some allocation, narrow down that set in the table appropriately. if the set ever becomes empty, we have UB.</p>



<a name="278198717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278198717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278198717">(Apr 07 2022 at 17:27)</a>:</h4>
<p>with SB it becomes a total disaster, but honestly I think it's a disaster even if we limited it to inside one allocation so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="278199067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278199067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278199067">(Apr 07 2022 at 17:30)</a>:</h4>
<p>static analyses should just treat <code>ptr2int</code> as giving the pointer away to arbitrary unknown code (something they have to support anyway) and int2ptr as obtaining an unknown pointer from unknown code. this is sound even under my "can pick up any provenance" model.</p>



<a name="278199133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278199133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278199133">(Apr 07 2022 at 17:31)</a>:</h4>
<p>the roundtrip rule requires <code>c==d</code>, yes, but I think that's unrealistic. casting to an int, doing arithmetic there, and casting back is something people would expect to work, so we should make it work. most C/C++ programmers will think this is okay, so it is allowed in "de-facto C".</p>



<a name="278202421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278202421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278202421">(Apr 07 2022 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278198717">said</a>:</p>
<blockquote>
<p>with SB it becomes a total disaster, but honestly I think it's a disaster even if we limited it to inside one allocation so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
</blockquote>
<p>Yes, I'm worried about SB + weak provenance, as that <em>is</em> the working model. I think it is not a total disaster if you restrict to c==d, since then the set of previous ptr2ints on that exact location will probably be quite small and possibly in a nontrivial fraction of cases there will be only one possibility, meaning that a naive tree search approach can probably work.</p>



<a name="278202799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278202799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278202799">(Apr 07 2022 at 17:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278199133">said</a>:</p>
<blockquote>
<p>the roundtrip rule requires <code>c==d</code>, yes, but I think that's unrealistic. casting to an int, doing arithmetic there, and casting back is something people would expect to work, so we should make it work. most C/C++ programmers will think this is okay, so it is allowed in "de-facto C".</p>
</blockquote>
<p>I know it's a hard ask, but I would <em>really</em> like to see some evidence that this is really a bridge too far, given that C/C++ seem to have gotten away with it. Because this is a rule that could make or break a Miri-like tool, so it's unusual to see you on the other side of the fence on this one.</p>



<a name="278202908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278202908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278202908">(Apr 07 2022 at 17:58)</a>:</h4>
<p>Do any LLVM passes assume a pointer must point to only one allocation?</p>



<a name="278203053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278203053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278203053">(Apr 07 2022 at 17:59)</a>:</h4>
<p>It's in the spec, but I assume you mean actual "miscompilation"?</p>



<a name="278203261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278203261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278203261">(Apr 07 2022 at 18:00)</a>:</h4>
<p>Either or would be helpful.</p>



<a name="278204126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278204126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278204126">(Apr 07 2022 at 18:07)</a>:</h4>
<p><a href="https://llvm.org/docs/LangRef.html#pointeraliasing">https://llvm.org/docs/LangRef.html#pointeraliasing</a> uses the term "a pointer is associated with an address range" for this, but based on the definition there it is clear that every pointer is associated with exactly one range (or the empty set) of addresses</p>



<a name="278205363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278205363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278205363">(Apr 07 2022 at 18:18)</a>:</h4>
<p>I have no idea if any real optimization exploits this, but an example optimization that uses convexity would be that if you observe a read at <code>p</code> and <code>p+99</code> then you can deduce <code>dereferenceable(100) p</code></p>



<a name="278205508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278205508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278205508">(Apr 07 2022 at 18:19)</a>:</h4>
<p>Right, I guess universal provenance would be weaker than the FFI cast model, so we do need UDI after all. </p>
<p>I don't think supporting arbitrary values is difficult though, because of one past the end pointers you still have to disambiguate when the user performs a load.</p>
<p>And even under strict roundtrip rules, you don't get any help in SB differentiating a pointer to the first element vs to the array versus which tag you're using exactly.</p>



<a name="278205946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278205946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278205946">(Apr 07 2022 at 18:23)</a>:</h4>
<p>that's true, but it's still a small bounded number of options, limited by the things in the borrow stack at the first read through the new pointer, and restricted further to values which were exposed at the location you picked up the wild pointer if you use the <code>c==d</code> rule</p>



<a name="278205995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278205995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278205995">(Apr 07 2022 at 18:23)</a>:</h4>
<p>if it's possible to reduce the possibilities to just 1 in most cases then that's a huge win, because it means you can keep doing the miri thing with no branching</p>



<a name="278240053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278240053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278240053">(Apr 07 2022 at 23:36)</a>:</h4>
<p>I used to think this liberal reading of <code>from_exposed_addr</code> was terrible for CHERI. But actually, if <code>with_addr</code> / <code>wrapping_offset</code> are unsupported in favor of <code>with_addr_inbounds</code>, and additionally we specify that the _source pointer_ is inside or just past the object, then things stay good. We can look up a capability when the address corresponds to an exposed capability, and make an invalid pointer otherwise.</p>



<a name="278355349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278355349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278355349">(Apr 08 2022 at 20:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278202799">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278199133">said</a>:</p>
<blockquote>
<p>the roundtrip rule requires <code>c==d</code>, yes, but I think that's unrealistic. casting to an int, doing arithmetic there, and casting back is something people would expect to work, so we should make it work. most C/C++ programmers will think this is okay, so it is allowed in "de-facto C".</p>
</blockquote>
<p>I know it's a hard ask, but I would <em>really</em> like to see some evidence that this is really a bridge too far, given that C/C++ seem to have gotten away with it. Because this is a rule that could make or break a Miri-like tool, so it's unusual to see you on the other side of the fence on this one.</p>
</blockquote>
<p>I dont think C/C++ are getting away with it. compilers support this in practice -- IOW, in "de-facto C", roundtrips with <code>c != d</code> are definitely allowed. this is just a case of the C/C++ spec not having much to do with reality.</p>



<a name="278357845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278357845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278357845">(Apr 08 2022 at 20:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278202799">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F/near/278199133">said</a>:</p>
<blockquote>
<p>the roundtrip rule requires <code>c==d</code>, yes, but I think that's unrealistic. casting to an int, doing arithmetic there, and casting back is something people would expect to work, so we should make it work. most C/C++ programmers will think this is okay, so it is allowed in "de-facto C".</p>
</blockquote>
<p>I know it's a hard ask, but I would <em>really</em> like to see some evidence that this is really a bridge too far, given that C/C++ seem to have gotten away with it. Because this is a rule that could make or break a Miri-like tool, so it's unusual to see you on the other side of the fence on this one.</p>
</blockquote>
<p>yeah I am as surprised as you are. ;)<br>
basically I gave up on having a Miri-like tool for permissive provenance. "if you want sound and complete tooling, use strict provenance". that goal is actually achievable, and it is extremely liberating to not constantly worry about integer roundtrips when thinking about aliasing models. assuming strict provenance pans out for the majority of code, this seems like an overall win to me.</p>
<p>we should ofc still think about ways to get tooling for permissive provenance code, but I am okay with false negatives there. I think a reasonable approximation is to give <code>from_exposed_addr</code> pointers a "wildcard" provenance that can simultaneously do everything any previously exposed provenance can. something broadly like <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Checking.20permissive.20provenance.20with.20SMT/near/278116149">this</a> (but I have not yet checked the details of those patches). I don't think this strategy is much impeded by allowing roundtrips that cast back from a different integer.</p>



<a name="278507387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278507387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278507387">(Apr 11 2022 at 04:21)</a>:</h4>
<p>Here's a fun miscompile related to this:</p>
<p><a href="https://rust.godbolt.org/z/5EcfeqT83">https://rust.godbolt.org/z/5EcfeqT83</a></p>



<a name="278507521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278507521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278507521">(Apr 11 2022 at 04:25)</a>:</h4>
<p>I'm not sure LLVM GEP gives us the guarantees we need to actually pull off these semantics.</p>



<a name="278508052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278508052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278508052">(Apr 11 2022 at 04:38)</a>:</h4>
<p>Although this works, so I don't know if GEP is the one to blame or LLVM's busted intptr cast handling. <a href="https://rust.godbolt.org/z/rfTMKc1jd">https://rust.godbolt.org/z/rfTMKc1jd</a></p>



<a name="278545073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278545073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278545073">(Apr 11 2022 at 12:23)</a>:</h4>
<p>miscompile examples without any explanation are so incredibly hard to decipher... could you add some comments, rather than expecting every reader to figure this all out by themselves?^^</p>



<a name="278614884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278614884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278614884">(Apr 11 2022 at 20:51)</a>:</h4>
<p><a href="https://rust.godbolt.org/z/EfhEvWGcz">https://rust.godbolt.org/z/EfhEvWGcz</a> here's one with comments<br>
sorry about that, i forget stuff that is obvious to me after spending 20 minutes staring at it isn't obvious to others</p>



<a name="278614898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278614898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278614898">(Apr 11 2022 at 20:51)</a>:</h4>
<p>Hold on... it's a MIR opt</p>



<a name="278615804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278615804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278615804">(Apr 11 2022 at 20:58)</a>:</h4>
<p>Doesn't look like it's in MIR, the generated MIR looks correct</p>



<a name="278615920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278615920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278615920">(Apr 11 2022 at 20:59)</a>:</h4>
<p>Hmm yeah I got trolled by the generated LLVM IR being after optimization</p>



<a name="278616167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278616167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278616167">(Apr 11 2022 at 21:01)</a>:</h4>
<p>You can pass <code>-Cno-prepopulate-passes</code></p>



<a name="278616567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278616567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278616567">(Apr 11 2022 at 21:04)</a>:</h4>
<p>Yup that compiles fine, so def LLVM.</p>



<a name="278617122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278617122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278617122">(Apr 11 2022 at 21:08)</a>:</h4>
<p>ah, that's probably <a href="https://bugs.llvm.org/show_bug.cgi?id=34548">https://bugs.llvm.org/show_bug.cgi?id=34548</a> then</p>



<a name="278619950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278619950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278619950">(Apr 11 2022 at 21:31)</a>:</h4>
<p>-&gt; <a href="https://github.com/llvm/llvm-project/issues/33896">https://github.com/llvm/llvm-project/issues/33896</a></p>



<a name="278620177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278620177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278620177">(Apr 11 2022 at 21:33)</a>:</h4>
<p>ah right, I need to re-subscribe to all relevant LLVM issues :/</p>



<a name="278621879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278621879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278621879">(Apr 11 2022 at 21:50)</a>:</h4>
<p>you should be CC-subscribed based on the top migration header, no?</p>



<a name="278622275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278622275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278622275">(Apr 11 2022 at 21:54)</a>:</h4>
<p>using <code>mentions:cuviper</code> finds nothing, but <code>cuviper</code> alone works...</p>



<a name="278622410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278622410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278622410">(Apr 11 2022 at 21:56)</a>:</h4>
<p>I was definitely not subscribed to the GH issue</p>



<a name="278622430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278622430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278622430">(Apr 11 2022 at 21:56)</a>:</h4>
<p>the importer did some magic to avoid emailing everyone 100 times during the import process, but I guess it also did not preserve the "subscribed" state</p>



<a name="278622463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does%20ptr2int%20-%3E%20int2ptr%20have%20to%20match%20integer%20values%3F/near/278622463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Does.20ptr2int.20-.3E.20int2ptr.20have.20to.20match.20integer.20values.3F.html#278622463">(Apr 11 2022 at 21:57)</a>:</h4>
<p>oops, I lost one of my replies to "draft"... yeah, my own "soft" mentions aren't subscribed now either</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>