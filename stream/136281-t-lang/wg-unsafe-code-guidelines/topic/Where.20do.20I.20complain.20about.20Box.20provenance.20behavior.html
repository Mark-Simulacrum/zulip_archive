<html>
<head><meta charset="utf-8"><title>Where do I complain about Box provenance behavior · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html">Where do I complain about Box provenance behavior</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278423944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278423944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278423944">(Apr 09 2022 at 18:31)</a>:</h4>
<p>You can't round-trip a Box for example from <code>Box&lt;u64&gt;</code> -&gt; <code>Box&lt;()&gt;</code> -&gt; <code>Box&lt;u64&gt;</code>, because as a <code>Box&lt;()&gt;</code> it has provenance over fewer bytes. Can I complain about this in <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/258">https://github.com/rust-lang/unsafe-code-guidelines/issues/258</a> or should I create a new UCG issue?</p>



<a name="278426934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278426934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278426934">(Apr 09 2022 at 19:40)</a>:</h4>
<p>Maybe use non-ZST for both? Regardless of provenance, <code>Box&lt;()&gt;</code> doesn't actually hit the allocator at all.</p>



<a name="278426937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278426937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278426937">(Apr 09 2022 at 19:40)</a>:</h4>
<p>I think that's <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/134">https://github.com/rust-lang/unsafe-code-guidelines/issues/134</a></p>



<a name="278427199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427199">(Apr 09 2022 at 19:46)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> The problem is that <code>eyre</code> does actually attempt to do this round-trip in order to type-erase a generic parameter inside the <code>Box</code></p>



<a name="278427373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427373">(Apr 09 2022 at 19:50)</a>:</h4>
<p>Ugh... by what means? I thought all the raw box conversions required compatible <code>Layout</code>.</p>



<a name="278427481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427481">(Apr 09 2022 at 19:53)</a>:</h4>
<p>well, <em>technically</em> only if you drop that Box, otherwise it's just the pointer uniqueness-asserting rules you need to worry about when moving the box</p>



<a name="278427500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427500">(Apr 09 2022 at 19:53)</a>:</h4>
<p>oh, and alignment of the target i suppose</p>



<a name="278427506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427506">(Apr 09 2022 at 19:53)</a>:</h4>
<p>all the normal "reference cast" rules basically</p>



<a name="278427642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427642">(Apr 09 2022 at 19:56)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <code>transmute</code></p>



<a name="278427657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427657">(Apr 09 2022 at 19:57)</a>:</h4>
<p>I commented with code snippets on the link Tavian provided</p>



<a name="278427707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427707">(Apr 09 2022 at 19:58)</a>:</h4>
<p>Why do it in this way?</p>



<a name="278427729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427729">(Apr 09 2022 at 19:59)</a>:</h4>
<p>Well if "erase the generic" is the goal... actually that sounds tricky.</p>



<a name="278427735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427735">(Apr 09 2022 at 20:00)</a>:</h4>
<p>I <em>think</em> it makes bubbling up errors a lot simpler when they all have the same type. Do you have another way to type-erase? I found one other way to fix this: Boxing the E so that the transmutee has the same provenance</p>



<a name="278427823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427823">(Apr 09 2022 at 20:00)</a>:</h4>
<p><code>Box::into_raw</code> and cast to a <code>*mut ()</code>?</p>



<a name="278427830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427830">(Apr 09 2022 at 20:00)</a>:</h4>
<p>Hmm, even <code>Box::from_raw</code> is fuzzier about this than I would like, only talking about safety for destruction. I would have preferred to require matching layout immediately.</p>



<a name="278427833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427833">(Apr 09 2022 at 20:00)</a>:</h4>
<p>You know what, that's a good idea</p>



<a name="278427836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427836">(Apr 09 2022 at 20:00)</a>:</h4>
<p>But I'm not sure it's easy to implement</p>



<a name="278427857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427857">(Apr 09 2022 at 20:01)</a>:</h4>
<p>It's quite similar to what Tokio does to type-erase the futures you spawn.</p>



<a name="278427926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427926">(Apr 09 2022 at 20:02)</a>:</h4>
<p>For deallocating, you can store a function pointer that knows how to deallocate it together with it.</p>



<a name="278427991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278427991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278427991">(Apr 09 2022 at 20:04)</a>:</h4>
<p>Yeah, rayon does this too</p>



<a name="278428549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278428549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278428549">(Apr 09 2022 at 20:18)</a>:</h4>
<p>(That's what c++ <code>shared_ptr</code> does all the time, as well)</p>



<a name="278428954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278428954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278428954">(Apr 09 2022 at 20:28)</a>:</h4>
<p>Ah, yeah if you keep it as a pointer to () instead of a box that's probably fine</p>



<a name="278429426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278429426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278429426">(Apr 09 2022 at 20:39)</a>:</h4>
<p>Yeah, because Box is special to SB which I intensely dislike</p>



<a name="278443352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278443352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278443352">(Apr 10 2022 at 02:25)</a>:</h4>
<p>It's worth noting that <code>Box</code> is a std-internal <code>ptr::Unique</code>, not <code>ptr::NonNull</code>, and we actively tag <code>Box</code> with <code>noalias</code> because of it</p>



<a name="278443404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278443404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278443404">(Apr 10 2022 at 02:26)</a>:</h4>
<p>we may be able to make <code>Box</code> less special in the future (e.g. <code>DerefMove</code>) but it's inherently more restricted than a userspace implementation on top of <code>ptr::NonNull</code> because of the uniqueness</p>



<a name="278443779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278443779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278443779">(Apr 10 2022 at 02:36)</a>:</h4>
<p>I think userspace could implement <code>Box</code> by using "<code>&amp;'unsafe mut T</code>". Or, using today's Rust, <code>&amp;'static mut T</code> and being <em>verrry</em> careful.</p>



<a name="278444733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278444733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278444733">(Apr 10 2022 at 03:04)</a>:</h4>
<p>Yes? My concern is that nobody expects Box to have SB-unique properties. There's an entire crate devoted to enshrining that fact. And C++ has an owning pointer which uses "unique" to mean something very different.</p>
<p>I think that regardless of whether users can implement Box, they won't want to.</p>



<a name="278444955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278444955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278444955">(Apr 10 2022 at 03:11)</a>:</h4>
<p>I could have sworn that the fact <code>Box</code> was unique was stated somewhere, but I can't find it</p>



<a name="278444963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278444963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278444963">(Apr 10 2022 at 03:11)</a>:</h4>
<p>The only note is in the reference where it's noted that it's a validity requirement for <code>Box</code> to point at a valid value</p>



<a name="278445001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445001">(Apr 10 2022 at 03:12)</a>:</h4>
<p>But <code>Box</code> has also been <code>ptr::Unique</code> since the start</p>



<a name="278445020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445020">(Apr 10 2022 at 03:13)</a>:</h4>
<p>So?</p>



<a name="278445063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445063">(Apr 10 2022 at 03:14)</a>:</h4>
<p>In any case, <code>stable_deref_trait</code> also implements <code>StableDeref</code> for <code>&amp;mut</code> which is definitely wrong</p>



<a name="278445071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445071">(Apr 10 2022 at 03:14)</a>:</h4>
<p>So supporting a "<code>Box</code> shouldn't be unique" off of <code>StableDeref</code> is iffy</p>



<a name="278445074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445074">(Apr 10 2022 at 03:14)</a>:</h4>
<p>Even the documentation for Unique, which is not even public, doesn't even suggest that Unique has the SB uniqueness property</p>



<a name="278445088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445088">(Apr 10 2022 at 03:15)</a>:</h4>
<p>I can cite other crates which assume it is stable if you want</p>



<a name="278445097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445097">(Apr 10 2022 at 03:16)</a>:</h4>
<p>string_cache, lru, owning_ref, tokio-utils off the top of my head</p>



<a name="278445157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445157">(Apr 10 2022 at 03:17)</a>:</h4>
<p>owning_ref is derived from stable_deref and has other soundness issues as well, IIRC tokio stores <code>*mut ()</code></p>



<a name="278445198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445198">(Apr 10 2022 at 03:18)</a>:</h4>
<p>Maybe I've mandella effected myself but I feel like <code>Box</code> has always been a "unique pointer"</p>



<a name="278445199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445199">(Apr 10 2022 at 03:18)</a>:</h4>
<p>tokio-utils does SB invalidation with a Box</p>



<a name="278445202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445202">(Apr 10 2022 at 03:18)</a>:</h4>
<p>I currently have a PR up to fix it</p>



<a name="278445218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445218">(Apr 10 2022 at 03:19)</a>:</h4>
<p>It certainly feels like there's a lot of Mandela effect here. Ralf has the same line about how <code>Unique</code> somehow gives SB permission to treat <code>Box</code> as it does <code>&amp;mut</code> and also <code>Vec</code>, because it also uses <code>Unique</code>. I really don't know where that's coming from. All I ever heard about aliasing properties in Rust before I got into this was that <code>&amp;mut</code> was special. I wouldn't be surprised if that is the impression that all these other authors have as well.</p>



<a name="278445260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445260">(Apr 10 2022 at 03:20)</a>:</h4>
<p>I think the docs at least <em>can</em> be read to justify the SB unique / <code>noalias</code> behavior:</p>
<blockquote>
<p>Unlike <code>*mut T</code>, <code>Unique&lt;T&gt;</code> behaves "as if" it were an instance of <code>T</code>.</p>
</blockquote>
<p>This would imply that <code>&amp;mut Unique&lt;T&gt;</code> behaves "as if" it were <code>&amp;mut T</code></p>



<a name="278445286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445286">(Apr 10 2022 at 03:21)</a>:</h4>
<p>Consider also</p>
<blockquote>
<p><strong>It also implies the kind of strong aliasing guarantees</strong> an instance of <code>T</code> can expect: the referent of the pointer should not be modified without a unique path to its owning Unique.</p>
</blockquote>



<a name="278445287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445287">(Apr 10 2022 at 03:21)</a>:</h4>
<p>Oh I must have blown right past that. That's interesting.<br>
Would be cool if this were publicly documented though.</p>



<a name="278445291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445291">(Apr 10 2022 at 03:21)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/559c01931b94d82b31d9180f5311244321530607/library/core/src/ptr/unique.rs#L11-L15">https://github.com/rust-lang/rust/blob/559c01931b94d82b31d9180f5311244321530607/library/core/src/ptr/unique.rs#L11-L15</a></p>



<a name="278445355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445355">(Apr 10 2022 at 03:23)</a>:</h4>
<p>Argh I can't follow the git-blame past the point where Ralf moved the stuff from file to file, when <code>rust-lang/rust</code> was temporarily a normal Rust crate</p>



<a name="278445466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445466">(Apr 10 2022 at 03:26)</a>:</h4>
<p>Blame this one: <a href="https://github.com/rust-lang/rust/blame/524580312039e4fa5ccf91e8f7093cd755bc1aad/src/libcore/ptr.rs#L2750-L2754">https://github.com/rust-lang/rust/blame/524580312039e4fa5ccf91e8f7093cd755bc1aad/src/libcore/ptr.rs#L2750-L2754</a></p>



<a name="278445538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445538">(Apr 10 2022 at 03:29)</a>:</h4>
<p>That's interesting. But it still doesn't support the kind of SB invalidation that you get from <code>Box</code>.</p>



<a name="278445606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445606">(Apr 10 2022 at 03:30)</a>:</h4>
<blockquote>
<p>the kind of strong aliasing guarantees an instance of <code>T</code> can expect:<br>
the referent of the pointer should not be modified without a unique path to<br>
its owning Unique.</p>
</blockquote>
<p>The problem I have is that we have UB according to SB even without mutation of the referent</p>



<a name="278445610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445610">(Apr 10 2022 at 03:31)</a>:</h4>
<p>Not surprising that <span class="user-mention" data-user-id="137587">@Gankra</span> is responsible for those doc lines <a href="https://github.com/rust-lang/rust/pull/41064">https://github.com/rust-lang/rust/pull/41064</a></p>



<a name="278445616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445616">(Apr 10 2022 at 03:31)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/commit/6e2efe3aa477bdc8d7ccdb904523ad18d612bbb6">https://github.com/rust-lang/rust/commit/6e2efe3aa477bdc8d7ccdb904523ad18d612bbb6</a></p>



<a name="278445656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445656">(Apr 10 2022 at 03:32)</a>:</h4>
<p>I believe the "as if" clause justifies the SB treatment</p>



<a name="278445658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445658">(Apr 10 2022 at 03:32)</a>:</h4>
<p>As in, <code>Unique&lt;T&gt;</code> is transparent to SB</p>



<a name="278445672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445672">(Apr 10 2022 at 03:33)</a>:</h4>
<p>If that is true, we should delete the rest of that paragraph because it is misleading.</p>



<a name="278445723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445723">(Apr 10 2022 at 03:34)</a>:</h4>
<p>But also, I think the UB we will unleash on the ecosystem by treating <code>Vec</code> as <code>Unique</code> is not worth the dubious-if-any optimization value that it will provide, so we should change the documentation to remove that phrasing.</p>



<a name="278445906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445906">(Apr 10 2022 at 03:40)</a>:</h4>
<p>We already do mark <code>Vec</code> as <code>noalias</code> since it uses <code>Unique</code></p>



<a name="278445915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445915">(Apr 10 2022 at 03:41)</a>:</h4>
<p>But in <code>Vec</code>'s case I also do recall discussions about whether <code>push</code> invalidates pointers saying "probably not if it doesn't reallocate"</p>



<a name="278445916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445916">(Apr 10 2022 at 03:41)</a>:</h4>
<p>so</p>



<a name="278445972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Talchas <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445972">(Apr 10 2022 at 03:43)</a>:</h4>
<p>Vec does not currently get <code>noalias</code> afaict; aiui Box gets it from its own flags, and Unique is pointless opt-wise</p>



<a name="278445979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278445979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278445979">(Apr 10 2022 at 03:43)</a>:</h4>
<p>huh ok</p>



<a name="278446021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278446021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278446021">(Apr 10 2022 at 03:44)</a>:</h4>
<p>I thought it was <code>Unique</code> specifically because of <code>raw_vec</code>'s <a href="https://github.com/rust-lang/rust/blob/559c01931b94d82b31d9180f5311244321530607/library/alloc/src/raw_vec.rs#L41">https://github.com/rust-lang/rust/blob/559c01931b94d82b31d9180f5311244321530607/library/alloc/src/raw_vec.rs#L41</a></p>
<blockquote>
<p>Contains a <code>ptr::Unique</code> and thus endows the user with all related benefits.</p>
</blockquote>



<a name="278446134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278446134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278446134">(Apr 10 2022 at 03:48)</a>:</h4>
<p>SB also does shallow retagging, so I do not believe it actually sees through</p>



<a name="278446149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278446149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278446149">(Apr 10 2022 at 03:49)</a>:</h4>
<p>And I'm honestly not sure if that makes it easier or harder, because I do have to explain to people why some code is UB only with a slice not a Vec, but also it makes less code UB.</p>



<a name="278476765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278476765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278476765">(Apr 10 2022 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior/near/278423944">said</a>:</p>
<blockquote>
<p>You can't round-trip a Box for example from <code>Box&lt;u64&gt;</code> -&gt; <code>Box&lt;()&gt;</code> -&gt; <code>Box&lt;u64&gt;</code>, because as a <code>Box&lt;()&gt;</code> it has provenance over fewer bytes. Can I complain about this in <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/258">https://github.com/rust-lang/unsafe-code-guidelines/issues/258</a> or should I create a new UCG issue?</p>
</blockquote>
<p>depends; do you think you should be allowed to do the same with a <code>&amp;mut</code>?</p>



<a name="278476996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278476996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278476996">(Apr 10 2022 at 16:32)</a>:</h4>
<p>and as for <code>Unique</code>, indeed my hope is to one day make <code>Unique</code> special rather than <code>Box</code>. not sure if that will make <span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> any less unhappy though. ;)<br>
it might help with this particular example since <code>Unique</code> necessarily has no clue what the extent of the aliasing guarantee is -- it cannot do any subobject provenance. (otherwise it wouldnt work for <code>Vec</code>.)</p>



<a name="278477110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278477110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278477110">(Apr 10 2022 at 16:34)</a>:</h4>
<p>in the end I totally leave the decision of where to put <code>Unique</code> up to others, but at least in the implementation the libs team has been quite clear about its intent here. I admit the docs might be not as clear about this as they should. nobody knows what to write about <code>Unique</code>...</p>
<p>for <code>Box</code> we actually exploit this with optimizations (<code>noalias</code>), so I wanted to be sure I got at least that covered in Miri.</p>



<a name="278481060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481060">(Apr 10 2022 at 17:52)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> How would making <code>Unique</code> special instead of <code>Box</code> help with this type-erasing <code>transmute</code>?</p>



<a name="278481077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481077">(Apr 10 2022 at 17:52)</a>:</h4>
<p>At least I think that's what you mean by "this particular example"</p>



<a name="278481086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481086">(Apr 10 2022 at 17:52)</a>:</h4>
<p><code>Unique</code> cannot do subobject provenance</p>



<a name="278481098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481098">(Apr 10 2022 at 17:53)</a>:</h4>
<p>ofc this all depends on what else happens in the code, but if literally all that happens is a transmute from <code>Box&lt;u64&gt;</code> to <code>Box&lt;()&gt;</code> and back, then I think this would work if we apply <code>Unique</code> semantics (and nothing on top)</p>



<a name="278481171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481171">(Apr 10 2022 at 17:54)</a>:</h4>
<p>So sinking the guarantee into <code>Unique</code> would prevent the provenance from shrinking?</p>



<a name="278481249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481249">(Apr 10 2022 at 17:56)</a>:</h4>
<p>yeah I think so</p>



<a name="278481253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278481253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278481253">(Apr 10 2022 at 17:56)</a>:</h4>
<p>this is all speculative of course since no concrete model for <code>Unique</code> exists yet ;)</p>



<a name="278497086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278497086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278497086">(Apr 11 2022 at 00:13)</a>:</h4>
<p>to clarify: Unique is unstable and 100% an implementation detail of std that I used to basically "mark" Box-like things to express intent/semantics. Whether it has any <em>real</em> language semantics at all is up to the discretion of lang/compiler people, and really has nothing to do with Unique itself, other than that it's clearly trying to indicate "whatever rules exist for Box should probably exist for these other types" (unless DerefMove or whatever is Truly Magic and Box and Vec are Truly Different).</p>



<a name="278497327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278497327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278497327">(Apr 11 2022 at 00:18)</a>:</h4>
<p>right but if the <code>Box</code>/<code>Vec</code> specs/docs don't mention anything about these types having special aliasing semantics, then we can't really expect users to uphold them...</p>



<a name="278498761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278498761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278498761">(Apr 11 2022 at 00:53)</a>:</h4>
<p>Ideally (to me, at least), they'd document that they do have special aliasing rules.<br>
I have no preference as an implementor that they'd have special provenance rules, but as a user I'd lean towards them not destroying provenance</p>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior/near/278497086">said</a>:</p>
<blockquote>
<p>to clarify: Unique is unstable and 100% an implementation detail of std that I used to basically "mark" Box-like things to express intent/semantics. Whether it has any <em>real</em> language semantics at all is up to the discretion of lang/compiler people, and really has nothing to do with Unique itself, other than that it's clearly trying to indicate "whatever rules exist for Box should probably exist for these other types" (unless DerefMove or whatever is Truly Magic and Box and Vec are Truly Different).</p>
</blockquote>
<p>Note: lccc's stdlib similarily has <code>Unique</code> in core::ptr, and <code>Unique</code> get's the xlang pointer attribute <code>unique</code> (which is rough equivalent of SB Unique, but on its own is allowed to point to nothing, and doesn't necessarily require nor grant write access).</p>



<a name="278499894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278499894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278499894">(Apr 11 2022 at 01:20)</a>:</h4>
<p>yeah basically: until they publically doc it / lang specs it or whatever, imo Stacked Borrows treating Box special is totally just miri messing around</p>



<a name="278499903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278499903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278499903">(Apr 11 2022 at 01:20)</a>:</h4>
<p>But I am willing to try to conform to that messing around</p>



<a name="278503215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278503215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278503215">(Apr 11 2022 at 02:41)</a>:</h4>
<p>well but technically if we start specing it now that's a breaking change, isnt it?</p>



<a name="278503230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278503230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278503230">(Apr 11 2022 at 02:41)</a>:</h4>
<p>so really we should have something suitably vague in the docs to ensure we can properly spec it later...</p>



<a name="278504189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278504189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278504189">(Apr 11 2022 at 03:02)</a>:</h4>
<p>Honestly I don't think we have reasonable cause to treat <code>Unique</code> as special under SB. There's no "it's a soundness fix" excuse like there is for <code>&amp;mut</code>, which was long promised to be special to the optimizer. Any promises about <code>Unique</code> were kept <em>completely</em> internal, so I don't know how you reason out of doing anything special with <code>Box</code> being a breaking change now.</p>



<a name="278504206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278504206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278504206">(Apr 11 2022 at 03:03)</a>:</h4>
<p>But I wouldn't mind commenting such on a PR as well</p>



<a name="278505354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505354">(Apr 11 2022 at 03:31)</a>:</h4>
<p>I ran across docs I'm pretty sure mean <code>Vec</code> at least can't be special for SB</p>
<blockquote>
<p>The caller must ensure that the vector outlives the pointer this function returns, or else it will end up pointing to garbage. Modifying the vector may cause its buffer to be reallocated, which would also make any pointers to it invalid. <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.as_mut_ptr">[<code>Vec::as_mut_ptr</code>]</a></p>
</blockquote>



<a name="278505370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505370">(Apr 11 2022 at 03:31)</a>:</h4>
<p>Specifically, as this says</p>
<blockquote>
<p>Modifying the vector may cause its buffer to be reallocated, which would also make any pointers to it invalid.</p>
</blockquote>
<p>That directly implies that if the buffer isn't reallocated, pointers aren't invalidated</p>



<a name="278505408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505408">(Apr 11 2022 at 03:32)</a>:</h4>
<p>It doesn't <em>say</em> it, but it very much implies it</p>



<a name="278505864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505864">(Apr 11 2022 at 03:44)</a>:</h4>
<p>No, what we need is for the addresses in these containers to unstable when the container is moved. That is the problem people run into with <code>Box</code>. They create a read-only pointer into the heap allocation, then move the <code>Box</code> itself. If <code>Box</code> is just an owning pointer, this is fine. But it isn't, if it's SB Unique.</p>



<a name="278505883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505883">(Apr 11 2022 at 03:45)</a>:</h4>
<p>Right, because retag is shallow</p>



<a name="278505898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505898">(Apr 11 2022 at 03:45)</a>:</h4>
<p>Is this what marking <code>Box</code> as <code>noalias</code> (theoretically) communicates to LLVM?</p>



<a name="278505947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505947">(Apr 11 2022 at 03:46)</a>:</h4>
<p>If we can justify <code>noalias</code> on <code>Box</code> without treating it specially as SB Unique, then I don't think there's any practical benefit to <code>Box</code> being SB Unique</p>



<a name="278505954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505954">(Apr 11 2022 at 03:46)</a>:</h4>
<p>If we can't justify <code>noalias</code> without it, then there is at least motivation for the restriction</p>



<a name="278505961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278505961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278505961">(Apr 11 2022 at 03:47)</a>:</h4>
<p>SB Unique is probably much more restrictive than noalias</p>



<a name="278506015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278506015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278506015">(Apr 11 2022 at 03:48)</a>:</h4>
<p>The definition of noalias is very hand-wavy, so it's not clear to me if this what noalias would have to be formalized as, or if it's much more restrictive.</p>



<a name="278506088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278506088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278506088">(Apr 11 2022 at 03:50)</a>:</h4>
<p>/shrug</p>



<a name="278506093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278506093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278506093">(Apr 11 2022 at 03:50)</a>:</h4>
<p>This is beyond the amount of thinking I have capacity for <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="278506094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278506094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Raekye <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278506094">(Apr 11 2022 at 03:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="132829">Christopher Durham (CAD97)</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior/near/278505370">said</a>:</p>
<blockquote>
<p>Specifically, as this says</p>
<blockquote>
<p>Modifying the vector may cause its buffer to be reallocated, which would also make any pointers to it invalid.</p>
</blockquote>
<p>That directly implies that if the buffer isn't reallocated, pointers aren't invalidated</p>
</blockquote>
<p>Just wanted to chip in a minor observation, as far as I'm aware, the only way to use vec fallibly (without panic or abort on allocation failure) is by calling <code>try_reserve(_exact)</code> and then <code>push</code> (some bounded number of times), which one then assumes won't allocate (and change the buffer). While it doesn't necessarily imply "if the buffer isn't reallocated, pointers aren't invalidated", this pattern seems to lean towards it IMO</p>
<p>(Of course, I hope we get better APIs to work with fallible containers one day... as it is, if you're trying to use vec without panicking or abort on failure, there's nothing preventing you from forgetting the <code>try_reserve</code> call, or calling <code>push</code> too many times)</p>



<a name="278506150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278506150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278506150">(Apr 11 2022 at 03:52)</a>:</h4>
<p>I think the resolution here is to remove <code>noalias</code> from <code>Box</code>. I am not aware of any realistic benchmarks which can support having it. I just tried setting <code>RUSTFLAGS_BOOTSTRAP=-Zmutable-noalias=no</code> and I couldn't find a perf regression at all in rustc-perf. Maybe that's just not the right way to benchmark this. Would love to hear that.</p>
<p>So if we haven't even warned people that this (Box invalidation pattern) isn't allowed and we can't detect any kind of benefit, I can't understand why suggesting adding UB to the standard library.</p>



<a name="278579238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278579238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278579238">(Apr 11 2022 at 16:25)</a>:</h4>
<p>I don't currently have the capacity to think a lot about Box and Vec. if someone wants to bring this up with the lib and lang teams that'd be great. I'd love to know if I have to worry about <code>Unique</code> in designing the next-gen aliasing model for Rust. ;)</p>



<a name="278580131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where%20do%20I%20complain%20about%20Box%20provenance%20behavior/near/278580131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Where.20do.20I.20complain.20about.20Box.20provenance.20behavior.html#278580131">(Apr 11 2022 at 16:31)</a>:</h4>
<p>I created <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/326">https://github.com/rust-lang/unsafe-code-guidelines/issues/326</a> so we can keep track of it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>