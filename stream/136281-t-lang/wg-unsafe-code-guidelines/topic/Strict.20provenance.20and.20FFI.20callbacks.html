<html>
<head><meta charset="utf-8"><title>Strict provenance and FFI callbacks · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html">Strict provenance and FFI callbacks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277406111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277406111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277406111">(Apr 01 2022 at 12:02)</a>:</h4>
<p>I'm still reading and absorbing information about all of these shenanigans, but how would transferring ownership across FFI look in this brave new world? Something I might write today:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">ffi</span>::<span class="n">c_void</span><span class="p">;</span><span class="w"></span>

<span class="k">type</span> <span class="nc">CallBack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">user</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">);</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_it_later</span><span class="p">(</span><span class="n">cb</span>: <span class="nc">CallBack</span><span class="p">,</span><span class="w"> </span><span class="n">user</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">f</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">shim</span><span class="p">(</span><span class="n">user</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">closure</span>: <span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">closure</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">f2</span>: <span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">f</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">do_it_later</span><span class="p">(</span><span class="n">shim</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277407753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277407753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277407753">(Apr 01 2022 at 12:17)</a>:</h4>
<p>your example contains two different <code>f</code>s <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="277408301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277408301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277408301">(Apr 01 2022 at 12:21)</a>:</h4>
<p>Name shadowing &gt;&gt;</p>



<a name="277408360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277408360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277408360">(Apr 01 2022 at 12:21)</a>:</h4>
<p>Can you rename it <span class="user-mention" data-user-id="116155">@Jake Goulding</span> ?</p>



<a name="277409008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277409008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277409008">(Apr 01 2022 at 12:26)</a>:</h4>
<p>I wouldn’t usually</p>



<a name="277409119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277409119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277409119">(Apr 01 2022 at 12:27)</a>:</h4>
<p>Especially considering that the original <code>f</code> is unusable as it’s been moved into the box.</p>



<a name="277409318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277409318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277409318">(Apr 01 2022 at 12:29)</a>:</h4>
<p>I mean to facilitate discussion</p>



<a name="277409331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277409331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277409331">(Apr 01 2022 at 12:29)</a>:</h4>
<p>So we can talk about both unambiguously</p>



<a name="277409346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277409346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277409346">(Apr 01 2022 at 12:29)</a>:</h4>
<p>And read the code more easily</p>



<a name="277409656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277409656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277409656">(Apr 01 2022 at 12:31)</a>:</h4>
<p>I’m interested to see how the non-pointer <code>f</code> ties into provenance.</p>



<a name="277420926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict%20provenance%20and%20FFI%20callbacks/near/277420926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Strict.20provenance.20and.20FFI.20callbacks.html#277420926">(Apr 01 2022 at 13:51)</a>:</h4>
<p>As far as I know, there is nothing in here that violates strict-provenance, because you aren't doing any ptr&lt;-&gt;int casts. The story on exactly how FFI works seems underdeveloped at best, but I believe you can reasonably assume that the pointer that comes back in the callback has the same provenance it had when you passed it out, so the <code>from_raw</code> works correctly</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>