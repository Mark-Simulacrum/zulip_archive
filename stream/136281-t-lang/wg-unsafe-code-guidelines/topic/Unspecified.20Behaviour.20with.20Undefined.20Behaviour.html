<html>
<head><meta charset="utf-8"><title>Unspecified Behaviour with Undefined Behaviour · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html">Unspecified Behaviour with Undefined Behaviour</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251314184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251314184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251314184">(Aug 31 2021 at 00:18)</a>:</h4>
<p>I thought it may be a good idea to clarify how unspecified behaviour interacts with undefined behaviour in the Rust AM.</p>
<p>In C++, <a href="https://eel.is/c++draft/intro.abstract#5.sentence-2">[intro.abstract] clause 5</a> provides that </p>
<blockquote>
<p>However, if any such execution contains an undefined operation, this document places no requirement on the implementation executing that program with that input (not even with regard to operations preceding the first undefined operation).</p>
</blockquote>
<p>This (compiled with clause 3 of the same, which defines that unspecified behaviour are non-deterministic aspects of the AM, and allow multiple executions of the same program with the same input on the same parameterized abstract AM) implies that if the a valid choice for some unspecified behaviour somewhere in the program causes the program to have undefined behaviour on a particular input, the implementation can treat it as though the program always has undefined behaviour. It can be demonstrated why, using this code</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlb&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">rand</span><span class="p">();</span><span class="w"> </span><span class="c1">//  This produces some value in a sequence. The C Standard is vague, but the requirements seem to imply that sequence is unspecified, though consistent with sequences produced immediate after calling `std::srand(1);`</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"%d"</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Cause undefied behaviour</span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The implementation can treat this as having undefined behaviour reguardless of what <code>std::rand()</code> returns, because that choice is entirely within the purview of the implementation, so it could choose to, say, return 0 always on the first call to <code>std::rand()</code> from the seed 1.  This is the case even if the printf statement prints 42, 1337, or 65537, since, if x is zero, the the program has undefined behaviour, and the compiler can do what it wants - print 0, 99, potato, segfault, or install windows on /dev/sda.</p>
<p>My question is, does this reasoning apply to rust? For example, would the following code be valid to treat as undefined behaviour, even if the layout of <code>Vec</code> happens to match:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">i32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">cap</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="p">{</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="p">(),</span><span class="kt">usize</span><span class="p">,</span><span class="kt">usize</span><span class="p">)};</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{}: {}"</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="n">cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>As a more interesting example, allowing this unspecified whether it's undefined to undefined promotion would allow the following code to be optimized as though <code>usize</code> carried provenance (even though it most likely strictly doesn't in rust):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">do_fun_things</span><span class="p">(){</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"> </span><span class="c1">// Can x be removed here?</span>
<span class="w">     </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:x}"</span><span class="p">,</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">do_other_fun_things</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">do_other_fun_things</span><span class="p">(){</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="o">&amp;</span><span class="n">v</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="o">+</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="c1">// guess the address of x - unspecified whether we succeed</span>
<span class="w">     </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:p},{}"</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="k">unsafe</span><span class="p">{</span><span class="o">&amp;*</span><span class="n">ptr</span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In some valid executions, the address 32 bytes offset from the address of v would be the address of x (8 bytes for the base pointer, 8 bytes for the return instruction pointer, 8 bytes for ptr, 4 for padding, and 4 for x). Of course, not ever execution would have this property. If the fact at least one execution exists that the &amp;*ptr has undefined behaviour, then would it be valid to delete the value of <code>x</code>, <em>even if</em> we subsequently print the value address in both cases (possibly because indeed we happen to be on such an execution)? (This assumes the compiler is able to ensure that <code>println!()</code> doesn't do anything sneaky with <code>ptr</code>).</p>



<a name="251347303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251347303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251347303">(Aug 31 2021 at 08:05)</a>:</h4>
<blockquote>
<p>The implementation can treat this as having undefined behaviour reguardless of what std::rand() returns,</p>
</blockquote>
<p>I don't think that's what your quote is saying. It specifies "execution", and the UB happens in the execution only if <code>x</code> is 0, so if <code>x</code> happens to not be <code>0</code> then the execution should be well defined.</p>



<a name="251362397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251362397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251362397">(Aug 31 2021 at 10:25)</a>:</h4>
<p>However, it isn't possible to observe whether the program is on an execution that doesn't have undefined behaviour, as the program could have actually returned <code>0</code> from <code>rand</code>, has undefined behaviour, and  done whatever it wants. <br>
It also says that "if any such execution contains an unefined operation..." which (combined with the rest of the clause) implies that the chosen execution need not be the one that contains the operation in question.</p>



<a name="251363390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251363390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251363390">(Aug 31 2021 at 10:34)</a>:</h4>
<blockquote>
<p>For example, would the following code be valid to treat as undefined behaviour, even if the layout of Vec happens to match:</p>
</blockquote>
<p>I don't think it is UB if the layout just so happens to match. For example <code>offset_of!()</code> would allow observing what the layout is. You could then match on a number of expected layouts and then use a hard coded offset. The fact that the fields of <code>Vec</code> are private does not change what is UB according to the compiler. It only changes what is UB according to the standard library, which the compiler can't take into account when optimizing. Future library versions can change things such that library UB turns into compiler UB, but library UB is not compiler UB in itself.</p>



<a name="251731741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251731741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251731741">(Sep 02 2021 at 15:14)</a>:</h4>
<p>I don't think unspecified behavior has anything to do with undefined behavior in Rust.</p>



<a name="251731794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251731794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251731794">(Sep 02 2021 at 15:15)</a>:</h4>
<p>Rust does not say what the layout of Rust structs is (its "unspecified"), but you can inspect the layout, and exploit it, without causing UB.</p>



<a name="251732000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251732000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251732000">(Sep 02 2021 at 15:16)</a>:</h4>
<p>You can also assume what the layout is, without checks, and without inspecting it, and if your assumption is correct, your program won't have UB.</p>



<a name="251732059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251732059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251732059">(Sep 02 2021 at 15:16)</a>:</h4>
<p>The issue with that is that the program might not be _portable_.</p>



<a name="251732114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/251732114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#251732114">(Sep 02 2021 at 15:17)</a>:</h4>
<p>But portability and undefined behavior are separate things.</p>



<a name="252033884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252033884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252033884">(Sep 04 2021 at 23:28)</a>:</h4>
<p>Rust doesn't really have "unspecified behavior" as a fixed term currently (AFAIK), but the way I think it should be used is by always <em>giving a list of options</em></p>



<a name="252033894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252033894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252033894">(Sep 04 2021 at 23:29)</a>:</h4>
<p>of one of the possibilities of "unspecified behavior" is UB, then we might as well just say it is UB</p>



<a name="252033910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252033910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252033910">(Sep 04 2021 at 23:29)</a>:</h4>
<p>so, I think I said the same thing as <span class="user-mention" data-user-id="409057">@hannahE2</span> just more generally :)</p>



<a name="252034666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252034666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252034666">(Sep 04 2021 at 23:45)</a>:</h4>
<p>Do we have a term for "intentionally defined as incorrect", by contrast with undefined?</p>



<a name="252034822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252034822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252034822">(Sep 04 2021 at 23:48)</a>:</h4>
<p>I don't think we do. E.g. Future::poll's doc currently says:</p>
<blockquote>
<p>Once a future has completed (returned Ready from poll), calling its poll method again may panic, block forever, or cause other kinds of problems; the Future trait places no requirements on the effects of such a call. However, as the poll method is not marked unsafe, Rust’s usual rules apply: calls must never cause undefined behavior (memory corruption, incorrect use of unsafe functions, or the like), regardless of the future’s state.</p>
</blockquote>



<a name="252034844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252034844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252034844">(Sep 04 2021 at 23:48)</a>:</h4>
<p>Basically it means that "Once a future has completed, calling its poll method again is &lt;term for intentionally defined as incorrect but not undefined&gt;."</p>



<a name="252034942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252034942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252034942">(Sep 04 2021 at 23:50)</a>:</h4>
<p>On the other hand, slice::sort_by just says:</p>
<blockquote>
<p>The comparator function must define a total ordering for the elements in the slice. If the ordering is not total, the order of the elements is unspecified.</p>
</blockquote>



<a name="252088430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088430">(Sep 05 2021 at 17:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour/near/252034666">said</a>:</p>
<blockquote>
<p>Do we have a term for "intentionally defined as incorrect", by contrast with undefined?</p>
</blockquote>
<p>what do you even mean by that?</p>



<a name="252088458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088458">(Sep 05 2021 at 17:01)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> ah now we are entering the territory of <em>library</em> UB/unspecified behavior, which is somewhat separate from those same concepts on the language level</p>



<a name="252088574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088574">(Sep 05 2021 at 17:03)</a>:</h4>
<p>Well I don't think we necessarily has to use different terms for library and language.</p>



<a name="252088597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088597">(Sep 05 2021 at 17:03)</a>:</h4>
<p>Future is tightly related to the language anyway</p>



<a name="252088690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088690">(Sep 05 2021 at 17:05)</a>:</h4>
<p>UB on the language level means "the Abstract Machine says this is an error". That <em>cannot</em> be the library definition, so we already have to define these separately.</p>



<a name="252088712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088712">(Sep 05 2021 at 17:05)</a>:</h4>
<p>and Future isnt really tied closely to the level of the language at which UB is defined, it all gets desugared away before the Abstract Machine ever sees it.</p>



<a name="252088734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088734">(Sep 05 2021 at 17:05)</a>:</h4>
<p>UB on the library level also involves things like how the library is allowed to change behavior in future versions</p>



<a name="252088787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252088787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252088787">(Sep 05 2021 at 17:06)</a>:</h4>
<p>so, I'd expect something similar with unspecified behavior on the language and library levels, respectively</p>



<a name="252089553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252089553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252089553">(Sep 05 2021 at 17:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour/near/252088430">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour/near/252034666">said</a>:</p>
<blockquote>
<p>Do we have a term for "intentionally defined as incorrect", by contrast with undefined?</p>
</blockquote>
<p>what do you even mean by that?</p>
</blockquote>
<p>I'm wondering if there's an established term, in compilers, for "this is semantically incorrect by the definition of the language, not just undefined".</p>
<p>As an example, consider something like arranging to have two <code>&amp;mut</code> references pointing to the same location (e.g. via transmute or via conversion from raw pointers). That's undefined behavior, but more than that, it's semantically incorrect, because part of the definition of Rust includes the exclusivity of <code>&amp;mut</code> references, and people can count on that semantic when writing their code.</p>



<a name="252089581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252089581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252089581">(Sep 05 2021 at 17:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour/near/252088690">said</a>:</p>
<blockquote>
<p>UB on the language level means "the Abstract Machine says this is an error". That <em>cannot</em> be the library definition, so we already have to define these separately.</p>
</blockquote>
<p>There are arguments that the definition of the AM includes the standard library (this is the case in C and C++), and thus you can have undefined behaviour in the library that are AM errors - an implementation would thus have exactly the same freedom with stdlib UB as it would with language UB.</p>



<a name="252089584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252089584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252089584">(Sep 05 2021 at 17:21)</a>:</h4>
<p>To phrase it another way: it seems like there's a spectrum from "defined as correct" to "not defined" to "defined as incorrect".</p>



<a name="252089688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252089688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252089688">(Sep 05 2021 at 17:23)</a>:</h4>
<p>I thought "undefined" is the worse than "defined as incorrect". IMO integer overflow is "defined as incorrect" but is not "undefined".</p>



<a name="252089692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252089692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252089692">(Sep 05 2021 at 17:23)</a>:</h4>
<p>I haven't seen that sort of term in other specs.<br>
C is the closest with Bounded UB (which cannot cause arbitrarily bad things to happen, like writing to another object, or be optimized away, but can result in a trap or abort or some other graceful error), but nothing I know of (except maybe sanitizers) implements that Annex.</p>



<a name="252089770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252089770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252089770">(Sep 05 2021 at 17:24)</a>:</h4>
<p>If I wrote a spec for the requirements of Futures, I would simply put</p>
<blockquote>
<p>The result of calling poll on a completed future is unspecified.</p>
</blockquote>



<a name="252097898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252097898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252097898">(Sep 05 2021 at 19:52)</a>:</h4>
<p>Integer overflow is certainly not defined as incorrect.</p>



<a name="252209497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252209497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252209497">(Sep 06 2021 at 18:29)</a>:</h4>
<blockquote>
<p>There are arguments that the definition of the AM includes the standard library (this is the case in C and C++), and thus you can have undefined behaviour in the library that are AM errors - an implementation would thus have exactly the same freedom with stdlib UB as it would with language UB.</p>
</blockquote>
<p>I don't think that's how it works in Rust.</p>



<a name="252209647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252209647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252209647">(Sep 06 2021 at 18:30)</a>:</h4>
<p>Safe APIs can't have UB, and unsafe ones have pre-conditions that the user is not allowed to violate.</p>
<p>Whether the API is a stdlib API or not doesn't really matter much.</p>



<a name="252209914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/252209914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#252209914">(Sep 06 2021 at 18:33)</a>:</h4>
<p>For the optimizations to happen, the compiler does not even need to treat any of these functions in a special way. Any unsafe API can have a <code>core::hint::assume</code> for each pre-condition in its implementation...</p>



<a name="253641866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253641866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253641866">(Sep 16 2021 at 20:00)</a>:</h4>
<blockquote>
<p>I'm wondering if there's an established term, in compilers, for "this is semantically incorrect by the definition of the language, not just undefined".</p>
</blockquote>
<p>"semantically incorrect by the definition of the language" is pretty much how I would define Undefined Behavior.<br>
UB does not mean "the spec doesnt say anything about this" (except if the spec uses UB as a default match arm, which IMO is a terrible choice... I am looking at you, C). UB means "the spec says it is an error to do this".</p>



<a name="253642099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642099">(Sep 16 2021 at 20:01)</a>:</h4>
<blockquote>
<p>There are arguments that the definition of the AM includes the standard library (this is the case in C and C++)</p>
</blockquote>
<p>I dont think this is the case in Rust... if I can help it.^^ And those part of the stdlib that are in the AM should IMO not be called "library" in careful technical discussion -- those are language primitives, aka intrinsics.</p>



<a name="253642164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642164">(Sep 16 2021 at 20:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour/near/252089584">said</a>:</p>
<blockquote>
<p>To phrase it another way: it seems like there's a spectrum from "defined as correct" to "not defined" to "defined as incorrect".</p>
</blockquote>
<p>"not defined" is always a spec bug, if you ask me. :)</p>



<a name="253642789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642789">(Sep 16 2021 at 20:07)</a>:</h4>
<p>there's also "unspecified" ~= "defined as correct, without dictating what it does"</p>



<a name="253642819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642819">(Sep 16 2021 at 20:07)</a>:</h4>
<p>for "unspecified" to be useful it needs to provide a list of possible options</p>



<a name="253642843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642843">(Sep 16 2021 at 20:07)</a>:</h4>
<p>that is what this discussion kind of started with, a few weeks ago ;)</p>



<a name="253642963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642963">(Sep 16 2021 at 20:08)</a>:</h4>
<p>I'm just amused that it has to be in the spec to be unspecified</p>



<a name="253642989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253642989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253642989">(Sep 16 2021 at 20:08)</a>:</h4>
<p>yeah these words havent aged well :/</p>



<a name="253643001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified%20Behaviour%20with%20Undefined%20Behaviour/near/253643001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Unspecified.20Behaviour.20with.20Undefined.20Behaviour.html#253643001">(Sep 16 2021 at 20:08)</a>:</h4>
<p>the spec also needs to carefully define what is undefined</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>