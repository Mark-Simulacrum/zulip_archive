<html>
<head><meta charset="utf-8"><title>transmute usize -&gt; fn pointer miscompilation? · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html">transmute usize -&gt; fn pointer miscompilation?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271893595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271893595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Richter <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271893595">(Feb 14 2022 at 21:44)</a>:</h4>
<p>I've read the nomicon, the transmute docs, and anything else I could google... I have no idea why this miscompiles:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3477a798_</span><span class="k">usize</span><span class="p">;</span><span class="w">                </span><span class="c1">// address I want to call</span>
<span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">PARAM1</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3cf53690_</span><span class="k">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="n">f</span><span class="p">(</span><span class="n">PARAM1</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>The fn call compiles as a call to <em>an address off by one</em>:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">mov</span><span class="w">    </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">esp</span><span class="p">],</span><span class="w"> </span><span class="mi">0x3cf53690</span><span class="w"></span>
<span class="nf">call</span><span class="w">   </span><span class="mi">0x3477a797</span><span class="w">                     </span><span class="c1">; &lt;------------ huh?</span>
</code></pre></div>
<p>Where have I messed up? How do I (without UB) convince the compiler that there really is a function (during runtime) at 0x3477a798 with calling convention <code>unsafe extern "C" fn(*mut u32)</code>?</p>



<a name="271894597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271894597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271894597">(Feb 14 2022 at 21:52)</a>:</h4>
<p>You can transmute pointer to function pointers (on POSIX platforms).</p>



<a name="271898089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271898089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Richter <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271898089">(Feb 14 2022 at 22:21)</a>:</h4>
<p>I'm using the i686-linux-unknown-musl target</p>



<a name="271900844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271900844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Richter <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271900844">(Feb 14 2022 at 22:48)</a>:</h4>
<p>and oddly enough, this works:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mh">0x3477a798</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">read_volatile</span><span class="p">();</span><span class="w">       </span><span class="c1">// z is unused!</span>

<span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">                                                       </span><span class="c1">//   ^^^ NOTE: I transmute x here, _not_ z!</span>
<span class="k">const</span><span class="w"> </span><span class="n">PARAM1</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3cf53690_</span><span class="k">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="n">f</span><span class="p">(</span><span class="n">PARAM1</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>which compiles in a less optimized but correct way:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">mov</span><span class="w">    </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">ebp-0x8</span><span class="p">],</span><span class="mi">0x3477a798</span><span class="w"></span>
<span class="nf">mov</span><span class="w">    </span><span class="no">eax</span><span class="p">,</span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">ebp-0x8</span><span class="p">]</span><span class="w"></span>
<span class="nf">mov</span><span class="w">    </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">esp</span><span class="p">],</span><span class="mi">0x3cf53690</span><span class="w"></span>
<span class="nf">call</span><span class="w">   </span><span class="no">eax</span><span class="w"></span>
</code></pre></div>
<p>This makes me think I am causing UB somehow, even though the transmute docs say that usize -&gt; fn ptr is one of the best use cases for transmute.</p>



<a name="271905658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271905658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271905658">(Feb 14 2022 at 23:41)</a>:</h4>
<p>It is weird; there is either some alignement of fn pointer assumption being made somewhere, or some genuine compilation bug. The former seems more plausible</p>



<a name="271910755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271910755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271910755">(Feb 15 2022 at 00:39)</a>:</h4>
<p>I can't replicate: is there something about your setup that differs from <a href="https://www.godbolt.org/z/oozW3Pe1r">https://www.godbolt.org/z/oozW3Pe1r</a> ? (This one isn't optimized but adding <code>-C opt-level=3</code> does not introduce the off by one error)</p>



<a name="271911180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271911180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271911180">(Feb 15 2022 at 00:45)</a>:</h4>
<p>This seems like a compilation bug to me. There is nothing in the (proto-) rust spec that would license this</p>



<a name="271911224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271911224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271911224">(Feb 15 2022 at 00:45)</a>:</h4>
<p>It is vaguely reminiscent of ARM thumb function calls, but this isn't an ARM</p>



<a name="271913499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271913499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Richter <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271913499">(Feb 15 2022 at 01:13)</a>:</h4>
<p>Ok I tracked it down... it's a bug in mold I think <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span> </p>
<p><a href="/user_uploads/4715/Sv7M3NkLJVX2-b33NZxbCm0v/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/Sv7M3NkLJVX2-b33NZxbCm0v/image.png" title="image.png"><img src="/user_uploads/4715/Sv7M3NkLJVX2-b33NZxbCm0v/image.png"></a></div>



<a name="271913792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute%20usize%20-%3E%20fn%20pointer%20miscompilation%3F/near/271913792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Evan Richter <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/transmute.20usize.20-.3E.20fn.20pointer.20miscompilation.3F.html#271913792">(Feb 15 2022 at 01:16)</a>:</h4>
<p>and of course the difference is still there when forced to be at the same base address:</p>
<p><a href="/user_uploads/4715/D7Oy6DCw5ulxsmkExkmh-zFg/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/D7Oy6DCw5ulxsmkExkmh-zFg/image.png" title="image.png"><img src="/user_uploads/4715/D7Oy6DCw5ulxsmkExkmh-zFg/image.png"></a></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>