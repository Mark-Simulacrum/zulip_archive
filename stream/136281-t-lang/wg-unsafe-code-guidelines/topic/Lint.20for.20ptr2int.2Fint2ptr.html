<html>
<head><meta charset="utf-8"><title>Lint for ptr2int/int2ptr · t-lang/wg-unsafe-code-guidelines · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/index.html">t-lang/wg-unsafe-code-guidelines</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html">Lint for ptr2int/int2ptr</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277529991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277529991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277529991">(Apr 02 2022 at 13:34)</a>:</h4>
<p>Is there a clippy lint for ptr2int or int2ptr casts?</p>



<a name="277530137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530137">(Apr 02 2022 at 13:37)</a>:</h4>
<p>not sure...</p>



<a name="277530193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530193">(Apr 02 2022 at 13:38)</a>:</h4>
<p>relatedly, is there a lint against <code>&amp;T</code> to <code>usize</code> transmutes? I thought clippy does lint against transmutes that could be casts, but when I just tried this transmute was not flagged</p>



<a name="277530215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530215">(Apr 02 2022 at 13:38)</a>:</h4>
<p>oh lol it does lint against raw ptr to usize transmute by default, but not reference to usize transmute</p>



<a name="277530330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530330">(Apr 02 2022 at 13:41)</a>:</h4>
<p>I've been wanting to fix the bytes crate's ptr2int2ptr casts for a long time, and just looked into it, but having a tool that lists them would be very useful.</p>



<a name="277530373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530373">(Apr 02 2022 at 13:42)</a>:</h4>
<p>You can list all casts, but that includes a lot of ptr2ptr casts.</p>



<a name="277530400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530400">(Apr 02 2022 at 13:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr/near/277530215">said</a>:</p>
<blockquote>
<p>oh lol it does lint against raw ptr to usize transmute by default, but not reference to usize transmute</p>
</blockquote>
<p>reported that: <a href="https://github.com/rust-lang/rust-clippy/issues/8622">https://github.com/rust-lang/rust-clippy/issues/8622</a><br>
should be an easy fix I think, if someone wants to pick it up :D</p>



<a name="277530423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277530423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277530423">(Apr 02 2022 at 13:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr/near/277530330">said</a>:</p>
<blockquote>
<p>I've been wanting to fix the bytes crate's ptr2int2ptr casts for a long time, and just looked into it, but having a tool that lists them would be very useful.</p>
</blockquote>
<p>yes, fully agreed -- an earlier version of <span class="user-mention" data-user-id="137587">@Gankra</span>'s PR contained such a lint as part of rustc itself, but it would probably be better suited for clippy for now</p>



<a name="277542707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277542707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277542707">(Apr 02 2022 at 17:58)</a>:</h4>
<p>Note that if anyone wants to uplift a "don't use <code>as</code> for ptr-to-int" lint to rustc, both T-lang and T-libs-api have wanted such a thing for months now (see the conversation in <a href="#narrow/stream/219381-t-libs/topic/Adding.20methods.20as.20more.20specific.20versions.20of.20.60as.60/near/238391074">https://rust-lang.zulipchat.com/#narrow/stream/219381-t-libs/topic/Adding.20methods.20as.20more.20specific.20versions.20of.20.60as.60/near/238391074</a> )</p>
<p>It of course can't be on-by-default in stable until <code>addr</code> is stable, but we could at least deny it in <code>core</code> and such, and people could use it on nightly.</p>



<a name="277568168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277568168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277568168">(Apr 03 2022 at 03:46)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> we could also land lints for non-<code>usize</code> casts, that should not have been present in 1.0 in the first place</p>



<a name="277568178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277568178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277568178">(Apr 03 2022 at 03:46)</a>:</h4>
<p>like <code>main as u8</code> is absurdist humor, not something that we want to meaningfully support</p>



<a name="277568190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277568190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277568190">(Apr 03 2022 at 03:47)</a>:</h4>
<p>(unless your function pointers <em>are</em> byte-sized but it should still be something else)</p>



<a name="277570415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277570415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277570415">(Apr 03 2022 at 04:24)</a>:</h4>
<p>Yeah.  The place the functions become essential is things like <code>isize::max as usize</code>, which <em>could</em> be what you want, it's just super-unlikely.</p>



<a name="277730902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint%20for%20ptr2int/int2ptr/near/277730902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/136281-t-lang/wg-unsafe-code-guidelines/topic/Lint.20for.20ptr2int.2Fint2ptr.html#277730902">(Apr 04 2022 at 13:31)</a>:</h4>
<p>^ this is <a href="https://github.com/rust-lang/rust/issues/81686">https://github.com/rust-lang/rust/issues/81686</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>