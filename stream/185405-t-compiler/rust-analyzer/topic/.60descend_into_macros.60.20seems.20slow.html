<html>
<head><meta charset="utf-8"><title>`descend_into_macros` seems slow · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html">`descend_into_macros` seems slow</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255087355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255087355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255087355">(Sep 27 2021 at 17:30)</a>:</h4>
<p>Continued from <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Steering.20meeting/near/255069770">https://rust-lang.zulipchat.com/#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Steering.20meeting/near/255069770</a></p>



<a name="255087421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255087421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255087421">(Sep 27 2021 at 17:31)</a>:</h4>
<p>I started another topic for this</p>



<a name="255219601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255219601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255219601">(Sep 28 2021 at 13:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133169">matklad</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Steering.20meeting/near/255073418">said</a>:</p>
<blockquote>
<p>curions!</p>
<p>here's what I see</p>
<p><div class="codehilite"><pre><span></span><code>   77ms - handle_inlay_hints
       77ms - inlay_hints
           56ms - descend_into_macros
               56ms - Semantics::analyze_impl
                   21ms - SourceBinder::to_module_def
                       21ms - crate_def_map:wait
                        0   - crate_def_map:wait (1 calls)
                        0   - relevant_crates (1 calls)
                   34ms - infer:wait @ ALL_COSTS
</code></pre></div><br>
</p>
</blockquote>
<p>Heh I just realized this one was for inlay hints, not syntax highlighting</p>



<a name="255219710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255219710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255219710">(Sep 28 2021 at 13:53)</a>:</h4>
<p>Interestingly enough for me the profiling times for highlighting of vary a lot, every few of them I get around 400-500ms but a lot of them are just 40-100ms</p>



<a name="255219936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255219936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255219936">(Sep 28 2021 at 13:54)</a>:</h4>
<p><code>highlight</code> stayed pretty consistently around 400 ms in my tests</p>



<a name="255220006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220006">(Sep 28 2021 at 13:54)</a>:</h4>
<p>(deleted)</p>



<a name="255220073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220073">(Sep 28 2021 at 13:55)</a>:</h4>
<p>Are you testing on RA? It's faster (unsurprisingly?) on an empty project</p>



<a name="255220116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220116">(Sep 28 2021 at 13:55)</a>:</h4>
<p>I am testing in the config file after the macro invocation as you did</p>



<a name="255220152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220152">(Sep 28 2021 at 13:55)</a>:</h4>
<p>Hmm, there's a macro invocation there?</p>



<a name="255220230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220230">(Sep 28 2021 at 13:56)</a>:</h4>
<p>Oh didn;t you mean after the <code>config_data!</code> invocation?</p>



<a name="255220258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220258">(Sep 28 2021 at 13:56)</a>:</h4>
<p>Am I testing in the wrong file? <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="255220309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220309">(Sep 28 2021 at 13:56)</a>:</h4>
<p>oh right i misremembered I guess</p>



<a name="255220316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220316">(Sep 28 2021 at 13:56)</a>:</h4>
<p>Oh, there's indeed a couple of them</p>



<a name="255220332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220332">(Sep 28 2021 at 13:56)</a>:</h4>
<p>ye just reread the issue</p>



<a name="255220345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220345">(Sep 28 2021 at 13:56)</a>:</h4>
<p>will try at the same spot this time</p>



<a name="255220409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220409">(Sep 28 2021 at 13:57)</a>:</h4>
<p>I was typing in <code>Config::update</code> and <code>Config::json_schema</code></p>



<a name="255220594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220594">(Sep 28 2021 at 13:58)</a>:</h4>
<p>typing <code>Config::json_schema</code> is very fast for me a lot of times</p>



<a name="255220595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220595">(Sep 28 2021 at 13:58)</a>:</h4>
<p><a href="https://gist.github.com/Veykril/d368039e9b1b4226f33bf0ef8a418400">https://gist.github.com/Veykril/d368039e9b1b4226f33bf0ef8a418400</a></p>



<a name="255220609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220609">(Sep 28 2021 at 13:58)</a>:</h4>
<p>but i do get 500ms occasionally</p>



<a name="255220699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220699">(Sep 28 2021 at 13:59)</a>:</h4>
<p>Oh those might be cancelled requests?</p>



<a name="255220730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220730">(Sep 28 2021 at 13:59)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> try forming the thread pool to use 1 thread, it should make the output esier to undrestand</p>



<a name="255220735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220735">(Sep 28 2021 at 13:59)</a>:</h4>
<p>typing a single char send like 5 calls</p>



<a name="255220754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220754">(Sep 28 2021 at 13:59)</a>:</h4>
<p>will do</p>



<a name="255220764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255220764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255220764">(Sep 28 2021 at 13:59)</a>:</h4>
<p>(force -- submit a PR to add a config value for this :) )</p>



<a name="255221077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255221077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255221077">(Sep 28 2021 at 14:01)</a>:</h4>
<p>Change <code>ConfigData::json_schema()</code> to <code>ConfigData::json_schema2()</code> in <code>json_schema</code> and see how long it takes for it to be colored as <code>unresolved</code></p>



<a name="255221269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255221269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255221269">(Sep 28 2021 at 14:02)</a>:</h4>
<div class="codehilite"><pre><span></span><code>   52ms - handle_semantic_tokens_full_delta
       51ms - highlight
           10ms - parse_query @ FileId(176)
            1ms - Semantics::analyze_impl (879 calls)
            0   - SourceBinder::to_module_def (293 calls)
            0   - classify_lifetime (34 calls)
            0   - classify_lifetime_ref (27 calls)
            1ms - classify_name (619 calls)
           12ms - classify_name_ref (1796 calls)
            0   - crate_def_map:wait (3186 calls)
           10ms - descend_into_macros_impl (588 calls)
            0   - infer:wait (1254 calls)
            0   - module_to_def (1 calls)
            0   - source_file_to_def (1 calls)
            1ms - trait_solve::wait (1364 calls)
           11ms - ???
        1ms - ???
  268ms - handle_semantic_tokens_full_delta
      267ms - highlight
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (13 calls)
                0   - crate_def_map:wait (4 calls)
                0   - parse_macro_expansion (3 calls)
                1ms - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (13 calls)
                0   - crate_def_map:wait (4 calls)
                0   - parse_macro_expansion (3 calls)
                0   - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (13 calls)
                0   - crate_def_map:wait (4 calls)
                0   - parse_macro_expansion (3 calls)
                1ms - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (13 calls)
                0   - crate_def_map:wait (4 calls)
                0   - parse_macro_expansion (3 calls)
                0   - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (19 calls)
                0   - crate_def_map:wait (55 calls)
                0   - parse_macro_expansion (12 calls)
                0   - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (19 calls)
                0   - crate_def_map:wait (55 calls)
                0   - parse_macro_expansion (12 calls)
                0   - ???
            1ms - Semantics::analyze_impl (463 calls)
            0   - SourceBinder::to_module_def (250 calls)
            0   - classify_lifetime (7 calls)
            0   - classify_lifetime_ref (7 calls)
            1ms - classify_name (370 calls)
           35ms - classify_name_ref (1157 calls)
            0   - crate_def_map:wait (1725 calls)
          211ms - descend_into_macros_impl (2132 calls)
            0   - infer:wait (410 calls)
            0   - module_to_def (10 calls)
            0   - parse_macro_expansion (1 calls)
            0   - source_file_to_def (1 calls)
            0   - trait_solve::wait (454 calls)
            9ms - ???
        0   - ???
</code></pre></div>



<a name="255221407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255221407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255221407">(Sep 28 2021 at 14:03)</a>:</h4>
<p><a href="/user_uploads/4715/0B1uBbjakMrMXiv73Z9KGeLp/slow.mp4">slow.mp4</a></p>



<a name="255221593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255221593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255221593">(Sep 28 2021 at 14:04)</a>:</h4>
<p>Oh, that came up awful</p>



<a name="255221797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255221797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255221797">(Sep 28 2021 at 14:05)</a>:</h4>
<p>Seems to consistently take ~250ms for me</p>



<a name="255222054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255222054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255222054">(Sep 28 2021 at 14:07)</a>:</h4>
<p>And judging from the hprof output it looks like thats due to the sheer amount of calls to <code>descend_into_macros</code></p>



<a name="255222317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255222317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255222317">(Sep 28 2021 at 14:08)</a>:</h4>
<p>Okay something seems odd though, I am getting around 2130 calls to that function in most files which doesnt really make sense since source files usually differ right? <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="255222673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255222673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255222673">(Sep 28 2021 at 14:10)</a>:</h4>
<p>Then again <code>handle_semantic_tokens_full_delta</code> is getting triggered around 5 times for a single char change which I don't quite understand why that's the case</p>



<a name="255224350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255224350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255224350">(Sep 28 2021 at 14:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/.60descend_into_macros.60.20seems.20slow/near/255222317">said</a>:</p>
<blockquote>
<p>Okay something seems odd though, I am getting around 2130 calls to that function in most files which doesnt really make sense since source files usually differ right? <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>
</blockquote>
<p>okay that seems to be a client bug, when typing in <a href="http://config.rs">config.rs</a> once, then typing in another filer it resends a highlight request for <a href="http://config.rs">config.rs</a> ...</p>



<a name="255224531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255224531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255224531">(Sep 28 2021 at 14:21)</a>:</h4>
<p>Actually, its probably not a bug, its just doing this for all files that it already has highlighting for so it updates the highlighting of all files(up to some maximum number probably) on each keystroke</p>



<a name="255224594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255224594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255224594">(Sep 28 2021 at 14:21)</a>:</h4>
<p><a href="/user_uploads/4715/GM6V7xYDeNlEyByib2wn1Ynk/slow2.mp4">slow2.mp4</a></p>



<a name="255224688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255224688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255224688">(Sep 28 2021 at 14:22)</a>:</h4>
<p><code>body_with_source_map_query</code> also seems to take a lot of time</p>



<a name="255225158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255225158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255225158">(Sep 28 2021 at 14:24)</a>:</h4>
<p>Funnily enough my highlighting feels slower than yours even though it only takes 270ms for me apparently</p>



<a name="255225272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255225272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255225272">(Sep 28 2021 at 14:25)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  280ms - handle_semantic_tokens_full_delta @ TextDocumentIdentifier { uri: Url { scheme: &quot;file&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: None, port: None, path: &quot;/c%3A/Workspace/Rust/rust-analyzer/crates/rust-analyzer/src/config.rs&quot;, query: None, fragment: None } } &quot;37&quot;
      279ms - highlight
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (13 calls)
                0   - crate_def_map:wait (4 calls)
                0   - parse_macro_expansion (3 calls)
                1ms - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (13 calls)
                0   - crate_def_map:wait (4 calls)
                0   - parse_macro_expansion (3 calls)
                1ms - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (8 calls)
                0   - crate_def_map:wait (3 calls)
                0   - parse_macro_expansion (2 calls)
                1ms - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (8 calls)
                0   - crate_def_map:wait (3 calls)
                1ms - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (19 calls)
                0   - crate_def_map:wait (55 calls)
                0   - parse_macro_expansion (12 calls)
                0   - ???
            1ms - descend_into_macros_impl
                0   - Semantics::analyze_impl (1 calls)
                0   - SourceBinder::to_module_def (19 calls)
                0   - crate_def_map:wait (55 calls)
                0   - parse_macro_expansion (12 calls)
                0   - ???
            2ms - trait_solve::wait
            1ms - Semantics::analyze_impl (463 calls)
            0   - SourceBinder::to_module_def (250 calls)
            0   - classify_lifetime (7 calls)
            0   - classify_lifetime_ref (7 calls)
            1ms - classify_name (370 calls)
           36ms - classify_name_ref (1157 calls)
            0   - crate_def_map:wait (1726 calls)
          220ms - descend_into_macros_impl (2132 calls)
            0   - infer:wait (410 calls)
            0   - module_to_def (10 calls)
            0   - source_file_to_def (1 calls)
            0   - trait_solve::wait (453 calls)
            8ms - ???
        0   - ???
</code></pre></div>
<p>This is all I see now though, no <code>body_with_source_map_query</code> anymore</p>



<a name="255225300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255225300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255225300">(Sep 28 2021 at 14:25)</a>:</h4>
<p>i cant get it above 300ms either anymore</p>



<a name="255225451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255225451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255225451">(Sep 28 2021 at 14:26)</a>:</h4>
<p>Maybe it's highlighting more on my tall screen :D</p>



<a name="255225572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255225572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255225572">(Sep 28 2021 at 14:27)</a>:</h4>
<p>We generate the entire files highlighting every time since this is a full request</p>



<a name="255225593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255225593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255225593">(Sep 28 2021 at 14:27)</a>:</h4>
<p>so i dont think that matters <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="255226532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255226532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255226532">(Sep 28 2021 at 14:32)</a>:</h4>
<p>So I guess we need to come up with some way to reduce the number of calls to <code>descend_into_macros_impl</code> as that function has a lot of overhead for calling from what I can tell here</p>



<a name="255226811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255226811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255226811">(Sep 28 2021 at 14:34)</a>:</h4>
<p>Could it also be the <code>SourceAnalyzer</code> we're making on every call?</p>



<a name="255228893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255228893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255228893">(Sep 28 2021 at 14:47)</a>:</h4>
<p>Doesn't seem so</p>



<a name="255228947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255228947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255228947">(Sep 28 2021 at 14:47)</a>:</h4>
<p>made a very simple cache for those calls and that shaved of ~10ms</p>



<a name="255232392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255232392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255232392">(Sep 28 2021 at 15:07)</a>:</h4>
<p>Actually I just realized by when looking up the range of a token_id in the expansion map we just linearly filter through all the tokens in the expansion</p>



<a name="255232416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255232416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255232416">(Sep 28 2021 at 15:07)</a>:</h4>
<p>Got a feeling that might be the problem here?</p>



<a name="255232761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255232761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255232761">(Sep 28 2021 at 15:09)</a>:</h4>
<p>yep</p>



<a name="255232768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255232768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255232768">(Sep 28 2021 at 15:09)</a>:</h4>
<p>that is the problem it seems</p>



<a name="255232913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255232913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255232913">(Sep 28 2021 at 15:10)</a>:</h4>
<p>Uh, can we avoid that?</p>



<a name="255232951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255232951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255232951">(Sep 28 2021 at 15:10)</a>:</h4>
<p>we would have to change how we store the token mapping</p>



<a name="255233000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233000">(Sep 28 2021 at 15:10)</a>:</h4>
<p>currently we store TokenId TextRange pairs in a vec</p>



<a name="255233010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233010">(Sep 28 2021 at 15:10)</a>:</h4>
<p>huh, are there large macro invocations in the test file?</p>



<a name="255233037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233037">(Sep 28 2021 at 15:10)</a>:</h4>
<p>yes</p>



<a name="255233052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233052">(Sep 28 2021 at 15:11)</a>:</h4>
<p>I didn't expect that particular O(n²) to become a practical issue so quickly</p>



<a name="255233064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233064">(Sep 28 2021 at 15:11)</a>:</h4>
<p>well it becomes one now</p>



<a name="255233069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233069">(Sep 28 2021 at 15:11)</a>:</h4>
<p>due to my changes</p>



<a name="255233090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233090">(Sep 28 2021 at 15:11)</a>:</h4>
<p>because now we map a token down to all its expansions</p>



<a name="255233111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233111">(Sep 28 2021 at 15:11)</a>:</h4>
<p>which means we <strong><em>always</em></strong> go through the entire vec</p>



<a name="255233112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233112">(Sep 28 2021 at 15:11)</a>:</h4>
<p>There's <code>config_data!</code> at some 200 LOC</p>



<a name="255233155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233155">(Sep 28 2021 at 15:11)</a>:</h4>
<p>instead of stopping at the first found mapping</p>



<a name="255233195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233195">(Sep 28 2021 at 15:11)</a>:</h4>
<p>ah, yeah that'll do it</p>



<a name="255233286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233286">(Sep 28 2021 at 15:12)</a>:</h4>
<p>Not that it's faster above it, but..</p>



<a name="255233343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233343">(Sep 28 2021 at 15:12)</a>:</h4>
<p>And are we really supposed to spend so much time in <code>body_with_source_map_query</code>?</p>



<a name="255233353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233353">(Sep 28 2021 at 15:12)</a>:</h4>
<p>unfortunately <code>TokenMap</code> is pretty space-sensitive, so just making it a bidirectional <code>HashMap</code> or something like that might use a lot more memory</p>



<a name="255233363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233363">(Sep 28 2021 at 15:12)</a>:</h4>
<p>Down to 100ms if I make it stop after the first find</p>



<a name="255233417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233417">(Sep 28 2021 at 15:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/.60descend_into_macros.60.20seems.20slow/near/255233353">said</a>:</p>
<blockquote>
<p>unfortunately <code>TokenMap</code> is pretty space-sensitive, so just making it a bidirectional <code>HashMap</code> or something like that might use a lot more memory</p>
</blockquote>
<p>Ye that's why I didn't change that either and I just thought it might be fine</p>



<a name="255233445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255233445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255233445">(Sep 28 2021 at 15:13)</a>:</h4>
<p>but I missed that we are blowing through the entire vec every time now</p>



<a name="255234593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255234593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255234593">(Sep 28 2021 at 15:19)</a>:</h4>
<p>I guess we can sort the vec and do a binary search for the token id for now?</p>



<a name="255234696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255234696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255234696">(Sep 28 2021 at 15:20)</a>:</h4>
<p>to get the range of the token id in the vec that is and the just iterate all the ones in that batch</p>



<a name="255240535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255240535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255240535">(Sep 28 2021 at 15:55)</a>:</h4>
<p>Interesting, this doesn't actually seem to be the problem, I just got better numbers because i only got one result instead of many it seems</p>



<a name="255261526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60descend_into_macros%60%20seems%20slow/near/255261526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/.60descend_into_macros.60.20seems.20slow.html#255261526">(Sep 28 2021 at 17:20)</a>:</h4>
<p>Well I'm out of ideas, spent 3 hours on this now, tried caching everything I can as well as replacing the token map iteration and nothing seems to affect the timing, except for just forcibly reducing the number of iterations of the loop in <code>descend_into_macros_impl</code>, I don't see what could possibly cause this to be so slow <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>