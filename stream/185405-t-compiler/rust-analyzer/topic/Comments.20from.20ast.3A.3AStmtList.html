<html>
<head><meta charset="utf-8"><title>Comments from ast::StmtList · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html">Comments from ast::StmtList</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268468265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268468265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeroen Vannevel <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268468265">(Jan 18 2022 at 22:58)</a>:</h4>
<p>I'm taking a look at <a href="https://github.com/rust-analyzer/rust-analyzer/issues/9011">https://github.com/rust-analyzer/rust-analyzer/issues/9011</a> and it appears to <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_assists/src/handlers/extract_function.rs#L479-L480">be caused</a> by <code>ast::StmtList.statements()</code> not including comments. Presumably a comment is not considered a statement? I've only seen references to it being a <code>Token</code> from my browsing. Does anyone have a suggestion on what the best way to approach this would be?</p>



<a name="268469442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268469442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeroen Vannevel <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268469442">(Jan 18 2022 at 23:08)</a>:</h4>
<p><code>ctx.covering_element()</code> returns a <code>ast::StmtList</code> which seems restricted to statements whereas I also need tokens. Is there a type that includes both?</p>



<a name="268470111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268470111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268470111">(Jan 18 2022 at 23:14)</a>:</h4>
<p>Nodes always include all tokens and child nodes, <code>ast::StmtList::statements</code> only iterates the statement nodes though. If you want all children nodes and tokens you have to use <a href="https://docs.rs/rowan/latest/rowan/api/struct.SyntaxNode.html#method.children_with_tokens"><code>SyntaxNode::children_with_tokens</code></a></p>



<a name="268470141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268470141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268470141">(Jan 18 2022 at 23:14)</a>:</h4>
<p>the syntax node of a typed  node you can retrieve with calling <code>.syntax()</code> on it</p>



<a name="268476074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268476074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeroen Vannevel <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268476074">(Jan 19 2022 at 00:23)</a>:</h4>
<p>Thanks, that got me further! How would I go in the other direction? <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_assists/src/handlers/extract_function.rs#L1483">Here</a> we create a new <code>BlockExpr</code> from a collection of statements -- how do I include the comment/whitespace tokens in there?</p>



<a name="268476835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268476835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268476835">(Jan 19 2022 at 00:32)</a>:</h4>
<p>uuh, ye that is a bit more tricky. Our <code>make</code> api wasn't really designed with comments(and attributes) in mind...</p>



<a name="268477469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268477469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeroen Vannevel <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268477469">(Jan 19 2022 at 00:40)</a>:</h4>
<p>I got something very rough working by adding a new <code>make</code> endpoint that accepts both statements &amp; tokens and only handling the comments:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">block_expr_full</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">stmts</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">IntoIterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">crate</span>::<span class="n">SyntaxElement</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tail_expr</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">ast</span>::<span class="n">Expr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ast</span>::<span class="n">BlockExpr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"{</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stmts</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">NodeOrToken</span>::<span class="n">Node</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">format_to</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"    {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">NodeOrToken</span>::<span class="n">Token</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SyntaxKind</span>::<span class="n">COMMENT</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">format_to</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"    {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">tail_expr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail_expr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">format_to</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">"    {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tail_expr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">"}"</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ast_from_text</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">"fn f() {}"</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Do you have any concerns with this approach?</p>



<a name="268479512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268479512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268479512">(Jan 19 2022 at 01:08)</a>:</h4>
<p>The problem here is that its not really a typed api anymore, you can technically create invalid nodes with this function now(which will might just panic in the <code>ast_from_text</code> call)</p>
<p>The ideal solution to the overall problem here would be to rewrite the assist to make use of our mutable syntax tree api(which by its own will then give problems with the indentation hacks that are already employed here, until we have our own formatter that is)</p>
<p>So I think adding the function you showed here in a <code>hacks</code> submodule or something in the <code>make</code> module would be fine for now, if given a FIXME comment since that function shouldn't exist, but is currently the best way to fix this</p>



<a name="268479534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268479534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268479534">(Jan 19 2022 at 01:08)</a>:</h4>
<p>At least I don't see a nicer approach to fixing the issue for the assist here currently</p>



<a name="268619840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268619840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeroen Vannevel <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268619840">(Jan 19 2022 at 23:34)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> I've put up a draft PR here which follows this approach and has all unit tests passing. I'd be interested to hear your thoughts <a href="https://github.com/rust-analyzer/rust-analyzer/pull/11322">https://github.com/rust-analyzer/rust-analyzer/pull/11322</a></p>



<a name="268958136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Comments%20from%20ast%3A%3AStmtList/near/268958136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeroen Vannevel <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Comments.20from.20ast.3A.3AStmtList.html#268958136">(Jan 22 2022 at 13:39)</a>:</h4>
<p>I have cleaned up the PR and it doesn't seem too shabby. I'd be keen to get people's take on the approach &amp; any thoughts on edge cases I haven't handled: <a href="https://github.com/rust-analyzer/rust-analyzer/pull/11322">https://github.com/rust-analyzer/rust-analyzer/pull/11322</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>