<html>
<head><meta charset="utf-8"><title>libraryfying match checking? · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html">libraryfying match checking?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="241081458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241081458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241081458">(Jun 01 2021 at 22:02)</a>:</h4>
<p><span class="user-mention" data-user-id="133169">@matklad</span> you <a href="https://github.com/rust-analyzer/rust-analyzer/pull/8717#issuecomment-851506836">pinged me</a> about the possibility of libraryfying match checking. I think this is quite feasible!</p>



<a name="241081515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241081515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241081515">(Jun 01 2021 at 22:03)</a>:</h4>
<p>exhaustiveness checking specifically is a very independent bit of code. It uses only Ty and a crate-local Pat enum</p>



<a name="241081547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241081547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241081547">(Jun 01 2021 at 22:03)</a>:</h4>
<p>AFAIK it also uses a single query, namely checking for type inhabitedness</p>



<a name="241081671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241081671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241081671">(Jun 01 2021 at 22:04)</a>:</h4>
<p>I know that there Ty is in the process of being librarified. Are there also plans to share the representation of patterns at all?</p>



<a name="241083948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241083948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241083948">(Jun 01 2021 at 22:31)</a>:</h4>
<p>What kind of knowledge does it require about <code>Ty</code>? Does it care about specific <code>TyKind</code>s at all?</p>



<a name="241087100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241087100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241087100">(Jun 01 2021 at 23:08)</a>:</h4>
<p>Yeah it pattern-matches on <code>TyKind</code>s a ton</p>



<a name="241087476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241087476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241087476">(Jun 01 2021 at 23:14)</a>:</h4>
<p>Ah I guess another tricky bit is constants. There's a pass that converts constants into the corresponding patterns and rust-analyzer might need that for completeness. But that taps into constant evaluation which sounds like a can of worms</p>



<a name="241121078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241121078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241121078">(Jun 02 2021 at 08:48)</a>:</h4>
<p>Seems like constant evaluation can be exctacted relatively easy, no? </p>
<p>Bascially, the match checking code can be parametrized over <code>eval</code> function</p>



<a name="241121168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241121168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241121168">(Jun 02 2021 at 08:49)</a>:</h4>
<p>They <code>TyKind</code> feels more worrisome to me. Can the pattern-matching be moved to the caller? Ie, if it already has an internal IR of patterns, can we reformulate the code such that it's the caller who lowers <code>Ty</code> to patterns?</p>



<a name="241124159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241124159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241124159">(Jun 02 2021 at 09:20)</a>:</h4>
<p>TyKinds don't get interpreted as patterns. They're pattern-matched throughout the code to make all sorts of decisions :/</p>



<a name="241124930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241124930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241124930">(Jun 02 2021 at 09:28)</a>:</h4>
<p>But pattern-matching TyKind should be fine once Ty is extracted to a shared library between rustc and chalk, right?</p>



<a name="241124947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241124947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241124947">(Jun 02 2021 at 09:28)</a>:</h4>
<p>Right!</p>



<a name="241124982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241124982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241124982">(Jun 02 2021 at 09:29)</a>:</h4>
<p>So I guess it's better to re-visit this topic once types are extracted...</p>



<a name="241125132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241125132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241125132">(Jun 02 2021 at 09:30)</a>:</h4>
<p>Cool, let's do that</p>



<a name="241125254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241125254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241125254">(Jun 02 2021 at 09:31)</a>:</h4>
<p><span class="user-mention" data-user-id="129457">@Florian Diebold</span> what's the way for me to educate myself about the shared types library? </p>
<p>I am curious about  bunch of things: do types carry identity? are they just values? how the memory management works? does "code changes over time" aspect of rust-analyzer affects the types?</p>



<a name="241125469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241125469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241125469">(Jun 02 2021 at 09:33)</a>:</h4>
<p>FWIW here's what chalk currently uses <a href="https://docs.rs/chalk-ir/0.68.0/chalk_ir/enum.TyKind.html">https://docs.rs/chalk-ir/0.68.0/chalk_ir/enum.TyKind.html</a> . Ty itself is parameterized over an interner</p>



<a name="241127558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241127558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241127558">(Jun 02 2021 at 09:54)</a>:</h4>
<p><span class="user-mention" data-user-id="133169">@matklad</span> I don't know many details either, there's a hackmd somewhere, but my understanding is that it's mostly supposed to look like chalk_ir</p>



<a name="241128318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241128318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241128318">(Jun 02 2021 at 10:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/wg-traits/issues/16">https://github.com/rust-lang/wg-traits/issues/16</a> is a good place to start I guess</p>



<a name="241379866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241379866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dawer <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241379866">(Jun 03 2021 at 11:55)</a>:</h4>
<p>We could also consider fallible implementation instead of bugging out with panic <a href="https://github.com/rust-analyzer/rust-analyzer/pull/9105#discussion_r644656085">https://github.com/rust-analyzer/rust-analyzer/pull/9105#discussion_r644656085</a></p>



<a name="241380760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/241380760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#241380760">(Jun 03 2021 at 12:04)</a>:</h4>
<p>we do want to bug out in debug builds, for actual bugs. For librarification we could maybe just control it with a cargo feature</p>



<a name="242418257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/242418257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#242418257">(Jun 12 2021 at 00:45)</a>:</h4>
<p>What's the scope of what rust-analyzer needs?</p>



<a name="242447334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/242447334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#242447334">(Jun 12 2021 at 12:15)</a>:</h4>
<p>Eventually, we need <em>everything</em>, so the question is rather "what's the most natural scope to create a boundary between the libraries"</p>



<a name="254611584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254611584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254611584">(Sep 23 2021 at 21:55)</a>:</h4>
<p><span class="user-mention" data-user-id="133169">@matklad</span> a natural scope will appear when <a href="https://github.com/rust-lang/rust/pull/88950">https://github.com/rust-lang/rust/pull/88950</a> gets merged: that PR makes exhaustiveness use its own pattern representation, and extracting type-dependent behavior shouldn't be too hard after that. That should be enough to get an independent crate that can tell you if a match is exhaustive.</p>



<a name="254611702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254611702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254611702">(Sep 23 2021 at 21:56)</a>:</h4>
<p>The fun part is to add more capabilities than just exhaustiveness. You mentioned exploding a <code>_</code> pattern, I imagine we also want to add missing match arms. What else could we do?</p>



<a name="254612858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254612858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254612858">(Sep 23 2021 at 22:05)</a>:</h4>
<p>Merging/Simplifying Or-patterns where possible maybe</p>



<a name="254613967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254613967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254613967">(Sep 23 2021 at 22:14)</a>:</h4>
<p>Splitting an <code>ident</code> pattern into the constructors it can match has been requested</p>



<a name="254614144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254614144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254614144">(Sep 23 2021 at 22:15)</a>:</h4>
<p>This one: <a href="https://github.com/rust-analyzer/rust-analyzer/issues/8365">https://github.com/rust-analyzer/rust-analyzer/issues/8365</a></p>



<a name="254614215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254614215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254614215">(Sep 23 2021 at 22:16)</a>:</h4>
<p>Also this is really cool to see, great work :)</p>



<a name="254615216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615216">(Sep 23 2021 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/libraryfying.20match.20checking.3F/near/254612858">said</a>:</p>
<blockquote>
<p>Merging/Simplifying Or-patterns where possible maybe</p>
</blockquote>
<p>What would that look like? <code>Some(1) | Some(2)</code> -&gt; <code>Some(1|2)</code> for example?</p>



<a name="254615288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615288">(Sep 23 2021 at 22:25)</a>:</h4>
<p>Ye that was my rough idea in the simplest case</p>



<a name="254615337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615337">(Sep 23 2021 at 22:25)</a>:</h4>
<p>Merging arms would also fall into that category, since that's practically the same thing if I'm not mistaken</p>



<a name="254615544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615544">(Sep 23 2021 at 22:27)</a>:</h4>
<p>what do you do with the code in each branch if you merge arms though?</p>



<a name="254615564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615564">(Sep 23 2021 at 22:27)</a>:</h4>
<p>I guess it only makes sense if the code is the same</p>



<a name="254615573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615573">(Sep 23 2021 at 22:27)</a>:</h4>
<p>splitting arms sounds potentially useful too</p>



<a name="254615708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615708">(Sep 23 2021 at 22:29)</a>:</h4>
<p>Ye that would only work if the bodies of the arms are the same, we already have such an assist but it works rather naively by just <code>|</code>-ing the patterns together I think <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_assists/src/handlers/merge_match_arms.rs">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_assists/src/handlers/merge_match_arms.rs</a></p>



<a name="254615788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615788">(Sep 23 2021 at 22:30)</a>:</h4>
<p>why is the naive thing not good enough?</p>



<a name="254615872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254615872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254615872">(Sep 23 2021 at 22:31)</a>:</h4>
<p>It is fine this way I think, just trying to come up with possible use cases here</p>



<a name="254662789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254662789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kirill Bulatov <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254662789">(Sep 24 2021 at 07:27)</a>:</h4>
<blockquote>
<p>You mentioned exploding a _ pattern, I imagine we also want to add missing match arms. What else could we do?</p>
</blockquote>
<p>Some user feedback/wishes for 2 extra small things on top:</p>
<ul>
<li>deal with <code>Self</code> substitution to evaporate <a href="https://github.com/rust-analyzer/rust-analyzer/issues/6404#issuecomment-813387608">https://github.com/rust-analyzer/rust-analyzer/issues/6404#issuecomment-813387608</a></li>
<li>allow to expand not only <code>_</code> pattern, but also things like <code>Some(_)</code> if possible, for instance, when there's an enum wrapped in option (every time I have to unwrap some <code>Result&lt;Option&lt;Foo&gt;&gt;</code> I want this feature)</li>
</ul>



<a name="254724791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254724791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254724791">(Sep 24 2021 at 15:42)</a>:</h4>
<p>Yeah, we definitely want <code>_</code> as a subpattern to be expandable too. That's where having access to the exhaustiveness algorithm is really useful actually.<br>
So far it seems the only thing we need for all those features is: given a <code>_</code> subpattern, tell me which values it catches. That's definitely doable, the algorithm already computes most of what we need</p>



<a name="254799441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/254799441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#254799441">(Sep 25 2021 at 02:19)</a>:</h4>
<p>Still, lots of work before we can get it as an independent crate</p>



<a name="255949329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/255949329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#255949329">(Oct 03 2021 at 12:48)</a>:</h4>
<p>Ooh, I found an assist I'd really like to have: "simplify match expression". E.g. on this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_none</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_0</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_1</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_wild</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>it would simplify the <code>Some</code> case and give:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_0</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_1</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">do_wild</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="255950046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/255950046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#255950046">(Oct 03 2021 at 13:00)</a>:</h4>
<p>For future reference: some issues that probably require access to the exhaustiveness algorithm:</p>
<ul>
<li><a href="https://github.com/rust-analyzer/rust-analyzer/issues/8690">https://github.com/rust-analyzer/rust-analyzer/issues/8690</a> Replacing if-let with match can lead to match expression with non-exhaustive patterns</li>
<li><a href="https://github.com/rust-analyzer/rust-analyzer/issues/4896">https://github.com/rust-analyzer/rust-analyzer/issues/4896</a> Incorrect "missing match arm" error</li>
<li><a href="https://github.com/rust-analyzer/rust-analyzer/issues/8365">https://github.com/rust-analyzer/rust-analyzer/issues/8365</a> Case splitting</li>
<li><a href="https://github.com/rust-analyzer/rust-analyzer/issues/8129">https://github.com/rust-analyzer/rust-analyzer/issues/8129</a> "Fill match arms" code action creates non-exhaustive match</li>
<li><a href="https://github.com/rust-analyzer/rust-analyzer/issues/9528">https://github.com/rust-analyzer/rust-analyzer/issues/9528</a> Add fuel to match checking</li>
</ul>



<a name="256641425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/256641425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dawer <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#256641425">(Oct 07 2021 at 20:06)</a>:</h4>
<p>I've just published experimental update for match checking, tho it is stale already <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10484">https://github.com/rust-analyzer/rust-analyzer/pull/10484</a></p>
<p>The <a href="https://github.com/rust-lang/rust/pull/89570">https://github.com/rust-lang/rust/pull/89570</a>  <code>[Experiment] Split exhaustiveness logic into its own crate #89570</code>  looks very promising!</p>



<a name="256757850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/256757850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#256757850">(Oct 08 2021 at 15:33)</a>:</h4>
<p>I'm hoping we can have a shared library in the coming weeks! (tho I do have some upcoming deadlines so might get distracted)</p>



<a name="258053970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258053970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dawer <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258053970">(Oct 18 2021 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> I've created a PR with some further improvements for your branch <a href="https://github.com/Nadrieril/rust/pull/1">https://github.com/Nadrieril/rust/pull/1</a>  Take a look when you get a spare time <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="258054307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258054307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258054307">(Oct 18 2021 at 16:11)</a>:</h4>
<p>oh thanks! but it's really not ready for that, a lot will change before I get it merged</p>



<a name="258054348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258054348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258054348">(Oct 18 2021 at 16:11)</a>:</h4>
<p>I'll look at your commits to see if I can keep anything once I'm done</p>



<a name="258054964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258054964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258054964">(Oct 18 2021 at 16:15)</a>:</h4>
<p>oh yeah that's good stuff</p>



<a name="258055007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258055007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258055007">(Oct 18 2021 at 16:15)</a>:</h4>
<p>I considered making allocation part of Context but I wasn't sure</p>



<a name="258055413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258055413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258055413">(Oct 18 2021 at 16:17)</a>:</h4>
<p>I like your solution, it avoids having the 'p lifetime on Context</p>



<a name="258055606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258055606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258055606">(Oct 18 2021 at 16:18)</a>:</h4>
<p>I was planning on just forcing everyone to use typed-arena ^^</p>



<a name="258056597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258056597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dawer <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258056597">(Oct 18 2021 at 16:23)</a>:</h4>
<p>Idk what way is better. I was just excited with <code>&amp;'p Self</code> trick to bound HRTB lifetime <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="258058463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258058463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dawer <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258058463">(Oct 18 2021 at 16:34)</a>:</h4>
<p>Ahh I just recall rustc does not have typed-arena in it's dependency tree so I wanted to give rustc the ability to use it's own arena</p>



<a name="258059776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/258059776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#258059776">(Oct 18 2021 at 16:42)</a>:</h4>
<p>yeah, that's a good reason</p>



<a name="259731695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/259731695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#259731695">(Oct 30 2021 at 13:42)</a>:</h4>
<p>I feel bad that I said I'd be done in a few weeks and then I haven't done it yet. Thanks for your patience, it will take some more time until I regain my energy but I'll do it eventually <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="259732315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/libraryfying%20match%20checking%3F/near/259732315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/libraryfying.20match.20checking.3F.html#259732315">(Oct 30 2021 at 13:58)</a>:</h4>
<p>No worries! In general, we don't have any expectations here around when things are getting done: <a href="https://internals.rust-lang.org/t/blog-post-rustacean-principles/15300/2">https://internals.rust-lang.org/t/blog-post-rustacean-principles/15300/2</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>