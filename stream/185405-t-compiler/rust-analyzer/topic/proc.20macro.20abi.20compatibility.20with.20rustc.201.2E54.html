<html>
<head><meta charset="utf-8"><title>proc macro abi compatibility with rustc 1.54 · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html">proc macro abi compatibility with rustc 1.54</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266751423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266751423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Frampton <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266751423">(Jan 03 2022 at 23:54)</a>:</h4>
<p>I am working with a project that is still using rust 1.54 (because of a performance issue that has not yet made it to stable) and there are problems with rust-analyzer not being able to handle proc_macros. I noticed that there were some changes here when the 1.58 ABI was introduced.</p>
<p>In particular, if I am reading the code correctly rustc 1.54 always used to use the <code>Abi_1_55</code> implementation until the fix in <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10799">https://github.com/rust-analyzer/rust-analyzer/pull/10799</a>.</p>
<p>Given we are seeing issues after that change, is it possible that Abi_1_55 should be used for 1.54. I think that was always the behavior until the recent change.</p>



<a name="266756321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266756321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Frampton <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266756321">(Jan 04 2022 at 00:50)</a>:</h4>
<p>I just confirmed locally that the example in <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10837">https://github.com/rust-analyzer/rust-analyzer/issues/10837</a> for <code>tokio::test</code> fails for me with a local rust-analyzer against rustc 1.54, but passes if I change <code>crates/proc_macro_srv/src/abis/mod.rs</code> to use the 1.55 abi for rustc 1.54.</p>
<p>I don't really know the proc macro ABI process; is there some other testing I can do or does it make sense to either rename the 1.55 abi or change 1.54 to use 1.55?</p>



<a name="266776922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266776922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266776922">(Jan 04 2022 at 07:23)</a>:</h4>
<p>Interesting, so the 1.55 ABI was probably misnamed? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="266776985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266776985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266776985">(Jan 04 2022 at 07:24)</a>:</h4>
<p>That would explain the proc-macro issues a bunch of people had after that change which didn't really make sense so changing 1.54 to make use of the "1.55" seems reasonable to me if it fixes things</p>



<a name="266777152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266777152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266777152">(Jan 04 2022 at 07:27)</a>:</h4>
<p>We should at least rename it</p>



<a name="266796115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266796115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266796115">(Jan 04 2022 at 11:16)</a>:</h4>
<p>I filed <a href="https://github.com/rust-analyzer/rust-analyzer/pull/11187">https://github.com/rust-analyzer/rust-analyzer/pull/11187</a>, but it's untested</p>



<a name="266865126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266865126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Frampton <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266865126">(Jan 04 2022 at 21:22)</a>:</h4>
<p>I have tested locally that this change fixes the repro test case I had with rustc 1.54.</p>
<p>Thanks for getting it fixed so quickly.</p>



<a name="266912439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266912439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266912439">(Jan 05 2022 at 09:13)</a>:</h4>
<p>Thanks for finding the issue, I didn't realize what was happening. There's also a nightly version on GitHub if you want</p>



<a name="266912635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20abi%20compatibility%20with%20rustc%201.54/near/266912635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20abi.20compatibility.20with.20rustc.201.2E54.html#266912635">(Jan 05 2022 at 09:16)</a>:</h4>
<p>In theory we only support the latest stable ABI, but I think many people will be quite unhappy if we drop some of the older ones.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>