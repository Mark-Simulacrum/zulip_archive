<html>
<head><meta charset="utf-8"><title>leftover tokens · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html">leftover tokens</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250628366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250628366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250628366">(Aug 25 2021 at 14:31)</a>:</h4>
<p>Is there any way I could realistically get a "leftover tokens" rust analyzer error from a proc macro? I don't have an example to present yet (still very much in the development phase), but I currently have a proc macro that works correctly on a cargo run, that certainly uses all of the input tokens (of which there is only one -- a string literal), but rust analyzer really isn't pleased about with that "leftover tokens" error message for some reason.</p>



<a name="250628897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250628897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250628897">(Aug 25 2021 at 14:35)</a>:</h4>
<p>Is the proc macro emitting macro calls?</p>



<a name="250629189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250629189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250629189">(Aug 25 2021 at 14:37)</a>:</h4>
<p>nope, no macro calls</p>



<a name="250631898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250631898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250631898">(Aug 25 2021 at 14:57)</a>:</h4>
<p>wait sorry -- it just occurred to me that cargo-expand won't actually answer that question for you, because it would expand the macros recursively, oops! currently trying to figure out if I can get cargo-expand to just expand 1 layer of macro calls...</p>



<a name="250632595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250632595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250632595">(Aug 25 2021 at 15:02)</a>:</h4>
<p>Does RA expand it when executing the <code>Expand macro recursively</code> command?</p>



<a name="250632641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250632641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250632641">(Aug 25 2021 at 15:02)</a>:</h4>
<p>If you are using VSCode you can run it by pressing <code>ctrl + shift + P</code> then typing the command there</p>



<a name="250632660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250632660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250632660">(Aug 25 2021 at 15:02)</a>:</h4>
<p>The command will expand whatever macro is below your cursor</p>



<a name="250633213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250633213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250633213">(Aug 25 2021 at 15:07)</a>:</h4>
<p>Wow, <code>Expand macro recursively</code> gets it completely wrong somehow...</p>



<a name="250633254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250633254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250633254">(Aug 25 2021 at 15:07)</a>:</h4>
<div class="codehilite"><pre><span></span><code>// Recursive expansion of instruction_set! macro
// ==============================================

::mipsy_lib::inst::InstSet::new($crate::vec::Vec::new(),$crate::vec::Vec::new())
</code></pre></div>



<a name="250633472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250633472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250633472">(Aug 25 2021 at 15:08)</a>:</h4>
<p>here's my test program:</p>
<div class="codehilite"><pre><span></span><code>use mipsy_codegen::instruction_set;

fn main() {
    let iset = instruction_set!(&quot;../mips.yaml&quot;);

    println!(&quot;native_len: {}, pseudo_len: {}&quot;, iset.native_set().len(), iset.pseudo_set().len());
}
</code></pre></div>
<p>and here's the output of cargo-expand for a good laugh: <a href="https://pastebin.com/r17ik2ES">https://pastebin.com/r17ik2ES</a></p>



<a name="250633528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250633528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250633528">(Aug 25 2021 at 15:09)</a>:</h4>
<p>and cargo run gives us <code>native_len: 54, pseudo_len: 77</code></p>



<a name="250633730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250633730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250633730">(Aug 25 2021 at 15:11)</a>:</h4>
<p>what does your macro do when the file can't be found? we might be running it in the wrong working directory</p>



<a name="250633881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250633881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250633881">(Aug 25 2021 at 15:12)</a>:</h4>
<p>It panics, and when I do <code>instruction_set!("hello")</code> for example, rust-analyzer gives a completely different error: </p>
<div class="codehilite"><pre><span></span><code>proc macro returned error: proc-macro panicked:
  Failed to open file: /home/zac/dev/mipsy/testing/hello: Os { code: 2, kind: NotFound, message: &quot;No such file or directory&quot; } rust-analyzer(macro-error)
</code></pre></div>



<a name="250634129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250634129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250634129">(Aug 25 2021 at 15:15)</a>:</h4>
<p>is your proc macro relying on any env vars?</p>



<a name="250634262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250634262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250634262">(Aug 25 2021 at 15:16)</a>:</h4>
<p>erm, it <em>is</em> indeed -- <code>CARGO_MANIFEST_DIR</code></p>



<a name="250634364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250634364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250634364">(Aug 25 2021 at 15:17)</a>:</h4>
<p>and to be clear, it uses that env-var when processing the tokens -- it doesn't output any env-var reliant tokens</p>



<a name="250634433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250634433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250634433">(Aug 25 2021 at 15:18)</a>:</h4>
<p>I just manually replaced <code>CARGO_MANIFEST_DIR</code> with a hardcoded path, and same result</p>



<a name="250634512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250634512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250634512">(Aug 25 2021 at 15:18)</a>:</h4>
<p>we do set <code>CARGO_MANIFEST_DIR</code> <a href="https://github.com/rust-analyzer/rust-analyzer/blob/2943d9aa51bf9c6576087cd7499e7bc27ac78b3b/crates/project_model/src/workspace.rs#L865">https://github.com/rust-analyzer/rust-analyzer/blob/2943d9aa51bf9c6576087cd7499e7bc27ac78b3b/crates/project_model/src/workspace.rs#L865</a></p>



<a name="250634734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250634734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250634734">(Aug 25 2021 at 15:20)</a>:</h4>
<p>cool -- no other environment variables than that</p>



<a name="250716743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250716743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250716743">(Aug 26 2021 at 03:55)</a>:</h4>
<p>any other thoughts on anything I can try? or do I just need to work on minimalisation?</p>



<a name="250758473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250758473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250758473">(Aug 26 2021 at 11:41)</a>:</h4>
<p>A minimal example would be great, yeah!</p>



<a name="250758904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250758904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250758904">(Aug 26 2021 at 11:45)</a>:</h4>
<p>finding out just what the proc macro expands to (non-recursively) in the mentioned case would probably also already help</p>



<a name="250758981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250758981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250758981">(Aug 26 2021 at 11:46)</a>:</h4>
<p>of course it would help <em>more</em> if the example is smaller ;)</p>



<a name="250759464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/250759464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#250759464">(Aug 26 2021 at 11:51)</a>:</h4>
<p>(it should be possible to simply make the proc macro print its output, I think?)</p>



<a name="251329350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/251329350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#251329350">(Aug 31 2021 at 04:11)</a>:</h4>
<p>the output is pretty gnarly unfortunately -- in any case, I did link the source code above and could -- wait, I never linked the source code? sorry I'm clearly an idiot: <a href="https://github.com/insou22/mipsy/blob/master/mipsy_codegen/src/lib.rs">https://github.com/insou22/mipsy/blob/master/mipsy_codegen/src/lib.rs</a></p>



<a name="251348825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/leftover%20tokens/near/251348825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zac Kologlu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/leftover.20tokens.html#251348825">(Aug 31 2021 at 08:21)</a>:</h4>
<p>huh... just came back to this today, and the error seems to have disappeared. wonder if my rust-analyser somehow got itself into a somewhat failed state...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>