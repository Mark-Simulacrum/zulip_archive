<html>
<head><meta charset="utf-8"><title>Completion performance · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html">Completion performance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256086987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256086987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256086987">(Oct 04 2021 at 16:23)</a>:</h4>
<p>I sometimes get a very slow completion due to documentation being loaded for an item for the first time causing a slow parse_query(137ms) causing an overly long loop turn message. There isn't really much we can do about those is there?</p>
<div class="codehilite"><pre><span></span><code>  202ms - handle_completion
      185ms - import_on_the_fly @ pu
          137ms - render_resolution
              137ms - render_fn
                  137ms - parse_query @ FileId(4212)
                    0   - crate_def_map:wait (1 calls)
           26ms - import_assets::search_for_imports (1 calls)
           21ms - render_resolution (2 calls)
        0   - Semantics::analyze_impl (3 calls)
       16ms - SourceBinder::to_module_def (3 calls)
        0   - crate_def_map:wait (1 calls)
        0   - descend_into_macros (1 calls)
        0   - item::Builder::build (3 calls)
</code></pre></div>



<a name="256087430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256087430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256087430">(Oct 04 2021 at 16:25)</a>:</h4>
<p>Which file is that? 137ms for parsing is quite a lot... But not unheared of - glorious old parser is 250ms on my (fast) machine</p>



<a name="256087485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256087485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256087485">(Oct 04 2021 at 16:25)</a>:</h4>
<p>Anyway for me to figure out what a file id maps to?</p>



<a name="256087491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256087491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256087491">(Oct 04 2021 at 16:25)</a>:</h4>
<p>might be the AVX512 files</p>



<a name="256087516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256087516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256087516">(Oct 04 2021 at 16:25)</a>:</h4>
<p>potentially</p>



<a name="256087631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256087631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256087631">(Oct 04 2021 at 16:26)</a>:</h4>
<p>I do think that we can make the parsing itself X times faster, I think rowan is jokingly slow. Not gonna be easy though</p>



<a name="256088327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256088327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256088327">(Oct 04 2021 at 16:29)</a>:</h4>
<p>But, ideally, completion shouldn't be hitting parsing at all -- doc comments should be in the item tree, as they are attributes. </p>
<p>Last time I've looked into this, the thing that caused parsing were function parameter names -- they are not stored in an item tree, as they don't have semantic meaning, but they are important for completion</p>



<a name="256088472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256088472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256088472">(Oct 04 2021 at 16:30)</a>:</h4>
<p>Oh okay, I assumed it would be docs since that would've made the most sense to me</p>



<a name="256088557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256088557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256088557">(Oct 04 2021 at 16:30)</a>:</h4>
<p>But ye, was a bit suprised to see parsing happening there at all in the first place as well</p>



<a name="256088640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256088640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256088640">(Oct 04 2021 at 16:31)</a>:</h4>
<p>Not sure what's the right solution here -- pessimistically indexing all parmeters of all functions under the sun doesn't feel right, but, at the same time, lazily loading stuff for completion is obviously non-great.</p>



<a name="256088804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256088804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256088804">(Oct 04 2021 at 16:32)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> </p>
<p>OK, if we had free ram, I'd definitely say "just index this". We are rather tight on ram though...</p>



<a name="256088906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256088906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256088906">(Oct 04 2021 at 16:32)</a>:</h4>
<p>we could try and see how much more RAM it uses</p>



<a name="256089075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089075">(Oct 04 2021 at 16:33)</a>:</h4>
<p>Yeah, let's do something stupid and store <code>params: String</code> which is an <code>$$</code> separated list of all <code>pat.to_string()</code> for functions in an item tree. If that's like an extra megabyte, than, sure, let's just do this</p>



<a name="256089297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089297">(Oct 04 2021 at 16:34)</a>:</h4>
<p>Another interesting place to stuff this into is import_index, on the grounds of being "for ides"s</p>



<a name="256089501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089501">(Oct 04 2021 at 16:35)</a>:</h4>
<p>theoretically, we know the range of the function in the source code and could just precisely parse its header again, couldn't we? probably hard to do within salsa though <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="256089733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089733">(Oct 04 2021 at 16:36)</a>:</h4>
<p><span class="user-mention" data-user-id="129457">@Florian Diebold</span> unless I misunderstood you, this is exactly what is happening today, and that is exactly the problem -- we re-parse file</p>



<a name="256089780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089780">(Oct 04 2021 at 16:37)</a>:</h4>
<p>I mean that we don't need to re-parse the whole file</p>



<a name="256089826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089826">(Oct 04 2021 at 16:37)</a>:</h4>
<p>we could just directly look at the <code>fn foo(...)</code></p>



<a name="256089831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089831">(Oct 04 2021 at 16:37)</a>:</h4>
<p>Interesting observation -- bigger files have more functions, so auto-import is more likely to hit heavy files</p>



<a name="256089861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089861">(Oct 04 2021 at 16:37)</a>:</h4>
<p>unless I'm missing something</p>



<a name="256089998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256089998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256089998">(Oct 04 2021 at 16:38)</a>:</h4>
<p>Oh, right, that's interesting. Well, today, to find out the range, I think we do have to re-parse the whole file (to map from ID to text range). But yeah, we presumably can store just a range</p>



<a name="256090549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256090549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256090549">(Oct 04 2021 at 16:41)</a>:</h4>
<p>Btw, this touches on something I've been thinking about recently: today we sort-of assume that file are small, and file for us is a unit of change. But files are not always small:</p>
<ul>
<li><a href="https://github.com/dotnet/runtime/blob/main/src/coreclr/gc/gc.cpp">https://github.com/dotnet/runtime/blob/main/src/coreclr/gc/gc.cpp</a></li>
<li><a href="https://github.com/microsoft/TypeScript/blob/main/src/compiler/checker.ts">https://github.com/microsoft/TypeScript/blob/main/src/compiler/checker.ts</a></li>
</ul>



<a name="256090791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256090791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256090791">(Oct 04 2021 at 16:43)</a>:</h4>
<p>isn't a <code>FileAstId</code> in the end a <code>SyntaxNodePtr</code> (or rather an index leading to that) which contains the range?</p>



<a name="256090805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256090805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256090805">(Oct 04 2021 at 16:43)</a>:</h4>
<p>I wonder if we should lift that assumption? I'd lean towards no -- files give us error isolation (unclosed <code>{</code> can't span multiple files), and, in Rust, it's fair to say that files should be small. </p>
<p>I wonder if the fix here is to split <code>AVX</code> intrinsics into several files maybe?</p>



<a name="256091037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256091037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256091037">(Oct 04 2021 at 16:44)</a>:</h4>
<p>I don't know, people heavily use generated code in Rust, might not be possible to convince them all to split up their files</p>



<a name="256091265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256091265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256091265">(Oct 04 2021 at 16:45)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> <span class="user-mention silent" data-user-id="129457">Florian Diebold</span> is right as usual -- we do have a text range in <code>AstIdMap</code>, and we could use that (although macro-based files make this non-trivial)</p>



<a name="256093217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256093217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256093217">(Oct 04 2021 at 16:58)</a>:</h4>
<p>Ye okay I am actually hitting this slow path quite a lot right now <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="256093232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256093232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256093232">(Oct 04 2021 at 16:58)</a>:</h4>
<p>Triggered it 3 times in a second just now</p>



<a name="256093300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256093300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256093300">(Oct 04 2021 at 16:59)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> that is stange -- in theory our LRU cache should handle that</p>



<a name="256093349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256093349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256093349">(Oct 04 2021 at 16:59)</a>:</h4>
<p>it is always the same file fwiw</p>



<a name="256094275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256094275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256094275">(Oct 04 2021 at 17:04)</a>:</h4>
<p>Might make sense to check why LRU is thrashed then!</p>
<p>One theory I have is that auto-import suggests functions from more than 128 files</p>



<a name="256094327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256094327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256094327">(Oct 04 2021 at 17:04)</a>:</h4>
<p>Ye I imagine so, I just bumped my lru cap gonna see if i hit it again</p>



<a name="256094736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/256094736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#256094736">(Oct 04 2021 at 17:07)</a>:</h4>
<p>Bumped it to 512 and I still get it</p>



<a name="260684183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/260684183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#260684183">(Nov 08 2021 at 16:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink  [he/him]</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Completion.20performance/near/256088906">said</a>:</p>
<blockquote>
<p>we could try and see how much more RAM it uses</p>
</blockquote>
<p>So I just tried this out by naively storing an <code>Interned&lt;str&gt;</code> per Function ItemTree entry with all its patterns joined together via<code>$</code> and that raised the memory usage of Item Collection(analysis-statis on ra's codebase) from <code>Item Collection:     14.14s, 446mb</code> to <code>Item Collection:     14.15s, 448mb</code></p>



<a name="260684321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/260684321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#260684321">(Nov 08 2021 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133169">matklad</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Completion.20performance/near/256089075">said</a>:</p>
<blockquote>
<p>Yeah, let's do something stupid and store <code>params: String</code> which is an <code>$$</code> separated list of all <code>pat.to_string()</code> for functions in an item tree. If that's like an extra megabyte, than, sure, let's just do this</p>
</blockquote>
<p>So I guess this is a viable option</p>



<a name="260687711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/260687711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#260687711">(Nov 08 2021 at 17:12)</a>:</h4>
<p>Hmm actually we have some custom snippet rendering logic here though which requires the pattern ast nodes so I guess we want to try out the AST ptr idea aftera ll...</p>



<a name="260697679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/260697679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#260697679">(Nov 08 2021 at 18:19)</a>:</h4>
<p>Also as a side note, the integrated completion benchmark is a bit difficult to read output from due all the parse queries it triggers taking up a big chunk of time(which you normally wouldn't run into when using r-a normally as everythings already cached, but kicking off a different completion at first doesn't seem to cause caching in the benchmark?)<br>
<span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> nvm it does have the things cached for the <code>doc completion</code>, odd</p>



<a name="261048000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/261048000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#261048000">(Nov 10 2021 at 20:13)</a>:</h4>
<p>So a very slow part of completions is a <code>trait_solve</code> query being triggered a lot(usually 50-60ms in r-a for me when its hit), is there anything we can do here?</p>



<a name="261144691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/261144691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kirill Bulatov <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#261144691">(Nov 11 2021 at 15:06)</a>:</h4>
<p>A lot in that part, from my limited perspective.<br>
Not sure, how close exactly we should get to <code>trait_solve</code> itself, but the approach to flyimport trait completions was "case-fuzzy search for any trait that has a method/constant/whatnot that contains given letter(s), do trait solving for all that were found, pick the ones that got solved for the given input"</p>
<p>That's not anyhow effective, I see a few low hanging fruits:</p>
<ul>
<li>trait resolution for types could be cached, now they are not at all</li>
<li>
<p>we can determine basic <code>impl Trait</code> cases for a certain struct already, I think we can split traits into categories by this characteristics and do trait solving for various blanket trait impls and such only, omitting "simple" traits from the solving process entirely</p>
</li>
<li>
<p>maybe few more details in <a href="https://github.com/rust-analyzer/rust-analyzer/issues/7542#issuecomment-772880309">https://github.com/rust-analyzer/rust-analyzer/issues/7542#issuecomment-772880309</a> and around</p>
</li>
</ul>



<a name="261145696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/261145696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#261145696">(Nov 11 2021 at 15:14)</a>:</h4>
<p>Right flyimport also triggers that, I wasn't specifically talking about flyimport in this case though as we already do a trait solve when creating the <code>CompletionContext</code> with trait_solve being very costly(the most expensive part usually).</p>
<div class="codehilite"><pre><span></span><code> 63ms - handle_completion
       57ms - CompletionContext::new
           57ms - descend_into_macros
               57ms - Semantics::analyze_impl
                   42ms - infer:wait @ index
                       40ms - infer_query
                           39ms - trait_solve::wait
                            0   - crate_def_map:wait (41 calls)
                            0   - deref (4 calls)
                            0   - resolve_obligations_as_possible (68 calls)
                            0   - trait_solve::wait (15 calls)
                   14ms - SourceBinder::to_module_def (1 calls)
                    0   - body_with_source_map_query (1 calls)
                    0   - crate_def_map:wait (2 calls)
                    0   - impl_data_query (1 calls)
            0   - Semantics::analyze_impl (3 calls)
            0   - SourceBinder::to_module_def (2 calls)
            0   - crate_def_map:wait (1 calls)
        1ms - complete_unqualified_path (1 calls)
        0   - crate_def_map:wait (19 calls)
        0   - deref (2 calls)
        0   - find_path_prefixed (1 calls)
        0   - import_on_the_fly (1 calls)
        0   - infer:wait (1 calls)
        0   - item::Builder::build (30 calls)
        2ms - iterate_method_candidates (1 calls)
</code></pre></div>



<a name="261145943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/261145943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#261145943">(Nov 11 2021 at 15:16)</a>:</h4>
<p>completions are basically only really slow now due to inference and def map creation which seems to almost always happen on every completion request</p>



<a name="265578380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/265578380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#265578380">(Dec 20 2021 at 15:34)</a>:</h4>
<p>one problem I think I've seen was actually just revalidation of the inference query. Some trait queries might have a lot of dependencies to revalidate. Not sure what can be done about that</p>



<a name="266608084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266608084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266608084">(Jan 02 2022 at 10:52)</a>:</h4>
<p>Wanted to look into this again but realized hprof is completely useless with chalk as almost all spans turn into <code>???</code>, does chalk spawn threads for its work internally? Also is there a way to see why chalk reruns a query?</p>



<a name="266634316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266634316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kirill Bulatov <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266634316">(Jan 02 2022 at 21:40)</a>:</h4>
<p>I've taken a stab here too, from the <code>import_on_the_fly</code> part of the issue, but experience something odd.</p>
<p>Looked at <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10187">https://github.com/rust-analyzer/rust-analyzer/issues/10187</a> : I could reproduce it more or less stable by opening a certain file from the issue in <code>tokio</code> repo and typing <code>printl</code> in quite reqular tempo of mine.<br>
I've also tweaked the completion bench to presumably do the same, but its traces were quite different for some reason, so all testing was done with custom local r-a binary and <code>"RA_PROFILE": "handle_completion&gt;16",</code></p>
<p>Here are the traces I see:</p>
<div class="codehilite"><pre><span></span><code>105ms - import_on_the_fly @ p
   105ms - import_assets::search_for_imports
      105ms - import_assets::search_for
         105ms - import_assets::path_applicable_imports
               105ms - items_with_name @ Name: p, crate: Exclude, assoc items: Some(&quot;tokio&quot;), limit: Some(40)
                  105ms - find_items
                     100ms - crate_symbols @ Query { query: &quot;p&quot;, lowercased: &quot;p&quot;, only_types: false, libs: false, exact: true, case_sensitive: false, limit: 40 }
                           99ms - crate_symbols|module_ids.par_iter
                                 0   - Snap::new (1 calls)
                              99ms - ???
                           0   - crate_symbols|module_ids_for_crate (1 calls)
                           1ms - crate_symbols|query.search (1 calls)
                        4ms - query_external_importables (1 calls)

--------

45ms - import_on_the_fly @ pri
   44ms - import_assets::search_for_imports
      44ms - import_assets::search_for
            44ms - import_assets::path_applicable_imports
               8ms - find_path_prefixed (61 calls)
               24ms - get_name_definition (40 calls)
               11ms - items_with_name (1 calls)
            0   - import_assets::scope_definitions (1 calls)

--------

70ms - import_on_the_fly @ prin
   70ms - import_assets::search_for_imports
       70ms - import_assets::search_for
           69ms - import_assets::path_applicable_imports
               15ms - find_path_prefixed (70 calls)
               45ms - get_name_definition (40 calls)
                9ms - items_with_name (1 calls)
            0   - import_assets::scope_definitions (1 calls)
    0   - DefMap::module_id (4 calls)
    0   - crate_def_map:wait (4 calls)
    0   - render_resolution (41 calls)
</code></pre></div>
<p>I see two odd things here:</p>
<ul>
<li>
<p><code>get_name_definition</code> is only used when searching crate's own items in <code>symbol_index</code>. Peculiar, that lookup over crate's dependencies does not show in the traces at all, but this method does. Also weird to notice that the very same place gets slower after another letter is added to completion.<br>
On the other hand, the <code>get_name_definition</code> call seems unavoidable with the way we build <code>symbol_index</code> now?</p>
</li>
<li>
<p>the <code>crate_symbols|module_ids.par_iter</code> call is caused by my changes, I've tried to chase the <code>???</code> thing and found nothing?</p>
</li>
</ul>
<p>Here's the diff:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/ide_db/src/apply_change.rs b/crates/ide_db/src/apply_change.rs</span>
<span class="gh">index 6c085ffc9..f7c70e107 100644</span>
<span class="gd">--- a/crates/ide_db/src/apply_change.rs</span>
<span class="gi">+++ b/crates/ide_db/src/apply_change.rs</span>
<span class="gu">@@ -137,7 +137,7 @@ impl RootDatabase {</span>
             hir::db::InternTypeParamIdQuery

             // SymbolsDatabase
<span class="gd">-            crate::symbol_index::ModuleSymbolsQuery</span>
<span class="gi">+            crate::symbol_index::ModuleSymbolsQueryQuery</span>
             crate::symbol_index::LibrarySymbolsQuery
             crate::symbol_index::LocalRootsQuery
             crate::symbol_index::LibraryRootsQuery
<span class="gh">diff --git a/crates/ide_db/src/symbol_index.rs b/crates/ide_db/src/symbol_index.rs</span>
<span class="gh">index 62f4a8191..a495a6527 100644</span>
<span class="gd">--- a/crates/ide_db/src/symbol_index.rs</span>
<span class="gi">+++ b/crates/ide_db/src/symbol_index.rs</span>
<span class="gu">@@ -96,8 +96,13 @@ impl Query {</span>
 pub trait SymbolsDatabase: HirDatabase + SourceDatabaseExt + Upcast&lt;dyn HirDatabase&gt; {
     /// The symbol index for a given module. These modules should only be in source roots that
     /// are inside local_roots.
<span class="gi">+    #[salsa::transparent]</span>
<span class="gi">+    #[salsa::invoke(module_symbols_wait)]</span>
     fn module_symbols(&amp;self, module_id: ModuleId) -&gt; Arc&lt;SymbolIndex&gt;;

<span class="gi">+    #[salsa::invoke(module_symbols)]</span>
<span class="gi">+    fn module_symbols_query(&amp;self, module_id: ModuleId) -&gt; Arc&lt;SymbolIndex&gt;;</span>
<span class="gi">+</span>
     /// The symbol index for a given source root within library_roots.
     fn library_symbols(&amp;self, source_root_id: SourceRootId) -&gt; Arc&lt;SymbolIndex&gt;;

<span class="gu">@@ -130,6 +135,10 @@ fn library_symbols(db: &amp;dyn SymbolsDatabase, source_root_id: SourceRootId) -&gt; Ar</span>
     Arc::new(SymbolIndex::new(symbols))
 }

<span class="gi">+fn module_symbols_wait(db: &amp;dyn SymbolsDatabase, module_id: ModuleId) -&gt; Arc&lt;SymbolIndex&gt; {</span>
<span class="gi">+    let _p = profile::span("module_symbols::wait");</span>
<span class="gi">+    db.module_symbols_query(module_id)</span>
<span class="gi">+}</span>
 fn module_symbols(db: &amp;dyn SymbolsDatabase, module_id: ModuleId) -&gt; Arc&lt;SymbolIndex&gt; {
     let _p = profile::span("module_symbols");
     let symbols = SymbolCollector::collect(db, module_id);
<span class="gu">@@ -140,6 +149,7 @@ fn module_symbols(db: &amp;dyn SymbolsDatabase, module_id: ModuleId) -&gt; Arc&lt;SymbolIn</span>
 struct Snap&lt;DB&gt;(DB);
 impl&lt;DB: ParallelDatabase&gt; Snap&lt;salsa::Snapshot&lt;DB&gt;&gt; {
     fn new(db: &amp;DB) -&gt; Self {
<span class="gi">+        let _p = profile::span("Snap::new");</span>
         Self(db.snapshot())
     }
 }
<span class="gu">@@ -213,15 +223,23 @@ pub fn crate_symbols(db: &amp;RootDatabase, krate: CrateId, query: Query) -&gt; Vec&lt;Fil</span>
     let _p = profile::span("crate_symbols").detail(|| format!("{:?}", query));

     let module_ids = module_ids_for_crate(db, krate);
<span class="gd">-    let indices: Vec&lt;_&gt; = module_ids</span>
<span class="gd">-        .par_iter()</span>
<span class="gd">-        .map_with(Snap::new(db), |snap, &amp;module_id| snap.module_symbols(module_id))</span>
<span class="gd">-        .collect();</span>
<span class="gi">+    let indices: Vec&lt;_&gt; = {</span>
<span class="gi">+        let _p = profile::span("crate_symbols|module_ids.par_iter");</span>
<span class="gi">+        module_ids</span>
<span class="gi">+            .par_iter()</span>
<span class="gi">+            .map_with(Snap::new(db), |snap, &amp;module_id| {</span>
<span class="gi">+                let _p = profile::span("crate_symbols|module_ids.map_with")</span>
<span class="gi">+                    .detail(|| format!("{:?}", module_id));</span>
<span class="gi">+                snap.module_symbols(module_id)</span>
<span class="gi">+            })</span>
<span class="gi">+            .collect()</span>
<span class="gi">+    };</span>

     query.search(&amp;indices)
 }

 fn module_ids_for_crate(db: &amp;dyn DefDatabase, krate: CrateId) -&gt; Vec&lt;ModuleId&gt; {
<span class="gi">+    let _p = profile::span("module_ids_for_crate");</span>
     let def_map = db.crate_def_map(krate);
     def_map.modules().map(|(id, _)| def_map.module_id(id)).collect()
 }
</code></pre></div>
<p>I've wrapped around presumably all code that could be in <code>???</code> yet got nothing. What am I missing? It it really <code>collect()</code> that's slow?</p>



<a name="266635988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266635988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266635988">(Jan 02 2022 at 22:22)</a>:</h4>
<p>You need to remove the <code>par_iter</code> for the spans to work I think, as spans are recorded in a thread local storage.</p>



<a name="266636267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266636267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266636267">(Jan 02 2022 at 22:28)</a>:</h4>
<p>The <code>crate_symbols</code> query should only happen on the first completion though so that taking 100ms there is fine</p>



<a name="266636423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266636423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266636423">(Jan 02 2022 at 22:32)</a>:</h4>
<blockquote>
<p>Peculiar, that lookup over crate's dependencies does not show in the traces at all, but this method does.</p>
</blockquote>
<p>Might as well be due to something running on a different thread? Though I don't see anything like that there so that seems odd</p>



<a name="266673164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266673164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266673164">(Jan 03 2022 at 10:52)</a>:</h4>
<p>Reminder that I've found it very helpful to restrict RA to a single thread to profile completion, but that we didn't add an option for that</p>



<a name="266674145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266674145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266674145">(Jan 03 2022 at 11:02)</a>:</h4>
<p>I already tried that but that didn't change anything for the spans inside <code>trait_solve</code> unfortunately</p>



<a name="266676344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266676344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266676344">(Jan 03 2022 at 11:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Completion.20performance/near/266608084">said</a>:</p>
<blockquote>
<p>Wanted to look into this again but realized hprof is completely useless with chalk as almost all spans turn into <code>???</code>, does chalk spawn threads for its work internally? Also is there a way to see why chalk reruns a query?</p>
</blockquote>
<p>Chalk doesn't spawn threads, no. Chalk also doesn't rerun queries, I guess you meant Salsa. You might actually be talking about the same thing I mentioned, in which case there actually <em>isn't</em> a query being rerun, it's just the Salsa revalidation of the trait solve query which takes so long. It could be related to Chalk checking far too many impls though, maybe because of some (sub)query like <code>?: Deref</code>.</p>



<a name="266676405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266676405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266676405">(Jan 03 2022 at 11:33)</a>:</h4>
<p>it could be nice to somehow get statistics about dependencies of our queries</p>



<a name="266676505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266676505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266676505">(Jan 03 2022 at 11:35)</a>:</h4>
<p>if you see <code>trait_solve::wait</code> but not <code>trait_solve_query</code>, it's either the query running in another thread or dependency revalidation</p>



<a name="266676539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266676539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266676539">(Jan 03 2022 at 11:35)</a>:</h4>
<p>Oh, now I see, that would make sense. Will check later again but I do think you only see <code>trait_solve::wait</code>but not <code>trait_solve_query</code></p>



<a name="266682647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266682647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266682647">(Jan 03 2022 at 12:55)</a>:</h4>
<p>if we used <code>tracing</code> for our profiling, we could probably get spans for salsa in there as well <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="266682714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266682714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266682714">(Jan 03 2022 at 12:56)</a>:</h4>
<p>... that would also obviate the need for <code>:wait</code> queries</p>



<a name="266683042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266683042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266683042">(Jan 03 2022 at 13:00)</a>:</h4>
<p>Would using tracing over our profiling infra give us any downsides in the general case? it shouldn't right? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="266683081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266683081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266683081">(Jan 03 2022 at 13:00)</a>:</h4>
<p>Turns out we also have an issue about this, albeit very small <a href="https://github.com/rust-analyzer/rust-analyzer/issues/3794">https://github.com/rust-analyzer/rust-analyzer/issues/3794</a></p>



<a name="266702023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266702023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266702023">(Jan 03 2022 at 15:57)</a>:</h4>
<p>I think there was some more discussion about it somewhere, maybe here?</p>



<a name="266702120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266702120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266702120">(Jan 03 2022 at 15:58)</a>:</h4>
<p>The only thing I remember is switching from <code>log</code> to <code>tracing</code>, but maybe there was more</p>



<a name="266722315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266722315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kirill Bulatov <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266722315">(Jan 03 2022 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Completion.20performance/near/266683042">said</a>:</p>
<blockquote>
<p>Would using tracing over our profiling infra give us any downsides in the general case? it shouldn't right? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>Just to note, current <code>tracing-subscriber</code> implementation always eager to call <code>Debug/Display</code> on every new span's variable, disregarding of whether the actual span gets any logging events or not later, so you at least loose a way to defer those details as we do now via <code>.detail(|| format!("{:?}", file_id));</code> .<br>
That might cause some performance issues (especially notable on log-less spans), but hard to say in general whether it would be notable or not.</p>



<a name="266791429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266791429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266791429">(Jan 04 2022 at 10:27)</a>:</h4>
<p>Looking at the span macros from tracing it seems to actually not be eager with formatting if the span is disabled</p>



<a name="266817442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266817442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266817442">(Jan 04 2022 at 14:58)</a>:</h4>
<p>On another note, we currently have a query limit employed for flyimport completions when searching dependencies, I assume we won't really be able to ever get rid of that but assuming we manage to improve the performance here we should be able to bump the limit up a bit right?<br>
Because currently we have flyimport completions that sometimes disappear(<code>std::iter::once</code> has this behaviour) when you type out more characters, which doesn't really make sense at first but which I assume is due to the use of a <code>FxHashSet</code> <a href="https://github.com/rust-analyzer/rust-analyzer/blob/7409880a07803c34590ad162d7854061145c6eae/crates/hir_def/src/import_map.rs#L415">here</a>. Replacing that with an <code>FxIndexSet</code> should fix that, but currently has the problem that <code>std::iter::once</code> won't get completed at all anymore, due to all the std simd functions matching prior to it, filling the current limit. <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10112">r-a#10112</a></p>
<p>Just wanted to throw that in here as it is somewhat relevant</p>



<a name="266822342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Completion%20performance/near/266822342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kirill Bulatov <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Completion.20performance.html#266822342">(Jan 04 2022 at 15:37)</a>:</h4>
<p>I don't think the limit goes away in the near/mid-future, but the situation is odd indeed.</p>
<p>I think, this particular issue could be solved by caching the previous search input and reusing it.<br>
I.e.: <code>pri</code> returned N results, on <code>prin</code> we could first filter out those old results and query more, if needed.</p>
<p>Alas, no proper idea how to invalidate that kind of cache and where to store that.<br>
(maybe just a plain LRU in Salsa?)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>