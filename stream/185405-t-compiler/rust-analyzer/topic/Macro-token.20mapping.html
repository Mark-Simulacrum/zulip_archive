<html>
<head><meta charset="utf-8"><title>Macro-token mapping · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html">Macro-token mapping</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250178403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250178403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250178403">(Aug 20 2021 at 22:09)</a>:</h4>
<p>Been reading through the token mapping source code a bit to tackle <a href="https://github.com/rust-analyzer/rust-analyzer/issues/9867">https://github.com/rust-analyzer/rust-analyzer/issues/9867</a> and I am a bit confused of some things.</p>
<p>Are <code>TokenId</code>s fully unique or only in respect to certain parts(like unique per (Macro)file)?</p>
<p><code>TokenExpander::map_id_down</code> basically shifts the tokenids by the number of tokens in the macro(-rules) definition, does this mean this is where the IDs of the tokens for the macro expanded file start?</p>
<p>I feel like there is more I'm not quite understanding about this but I'm unsure what it is and thus don't really know what to ask(it might really just be the token shifting that is rather confusing to me).<br>
So a general run-down on how this works would also be appreciated, assuming this isn't too tricky to explain.</p>



<a name="250178642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250178642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250178642">(Aug 20 2021 at 22:12)</a>:</h4>
<p>Though I suppose this might not matter too much now since we seem to want to replace how token mapping works currently</p>



<a name="250179325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250179325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250179325">(Aug 20 2021 at 22:20)</a>:</h4>
<p><code>TokenId</code>s might not be unique at all in the output, but they are unique when they get assigned to a syntax node by <code>syntax_node_to_token_tree</code> or <code>parse_to_token_tree</code></p>



<a name="250179351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250179351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250179351">(Aug 20 2021 at 22:21)</a>:</h4>
<p>For example, when a <code>macro_rules!</code> macro copies some input tokens to the output multiple times, they'll all have the same IDs</p>



<a name="250179377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250179377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250179377">(Aug 20 2021 at 22:21)</a>:</h4>
<p><code>TokenMap</code> currently doesn't account for that and always returns the first token</p>



<a name="250180090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180090">(Aug 20 2021 at 22:32)</a>:</h4>
<p>I see, so what does the shifting of the token ids give us? And why do we shift by the maximum token id of the macro definition?</p>



<a name="250180232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180232">(Aug 20 2021 at 22:34)</a>:</h4>
<p>Or rather why do we have to shift them to prevent collisions</p>



<a name="250180252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180252">(Aug 20 2021 at 22:35)</a>:</h4>
<p>In light of recent discussions, the current logic might be bogus.</p>
<p>The original idea was that for macro by example the expansion contains the mix of tokens form macro definition and macro call.</p>
<p>Tokens in def and in call have identities, but ids are local to the def/expansion</p>



<a name="250180267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180267">(Aug 20 2021 at 22:35)</a>:</h4>
<p>ie, both def and expansion has token with id 42, but they are different tokens</p>



<a name="250180335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180335">(Aug 20 2021 at 22:36)</a>:</h4>
<p>when expanding, we “shift” ids, such that all ids &lt; N are from def, and all ids &gt; N are from expansion (not sure which one exactly do we shift)</p>



<a name="250180384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180384">(Aug 20 2021 at 22:37)</a>:</h4>
<p>For MBE in particular, an invocation has 2 token trees as input: the macro def and the invocation arguments. Both individually get <code>TokenId</code>s assigned, so they can collide, and because the output can mix tokens from both sources, they need to get shifted to avoid the collisions.</p>



<a name="250180477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180477">(Aug 20 2021 at 22:38)</a>:</h4>
<p>I think this logic is largely correct even with a more correct token/span model, since we'd probably still record (relative) spans to a map and assign IDs</p>



<a name="250180606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180606">(Aug 20 2021 at 22:40)</a>:</h4>
<blockquote>
<p>For MBE in particular, an invocation has 2 token trees as input: the macro def and the invocation arguments. </p>
</blockquote>
<p>Oh I think this was the key piece I was missing</p>



<a name="250180671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250180671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250180671">(Aug 20 2021 at 22:41)</a>:</h4>
<p>Thank you two, this should've made things a lot clearer now(I hope) <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="250207581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250207581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250207581">(Aug 21 2021 at 09:24)</a>:</h4>
<p>So for attributes the problem then is that we aren't shifting the item input token ids by the max attribute input token ids if I get this right?</p>



<a name="250207594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250207594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250207594">(Aug 21 2021 at 09:24)</a>:</h4>
<p>Which would make the shifting dependent on in the input?</p>



<a name="250209637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250209637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250209637">(Aug 21 2021 at 10:13)</a>:</h4>
<p>Looks like it, managed to make it work <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> but I am certainly not satisfied with the way I did it <br>
(Note the <code>trait</code> keyword having the keyword color instead of the struct color)<br>
<a href="/user_uploads/4715/e9hTcBAIHG8fTvo6vo4jb52V/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/e9hTcBAIHG8fTvo6vo4jb52V/image.png" title="image.png"><img src="/user_uploads/4715/e9hTcBAIHG8fTvo6vo4jb52V/image.png"></a></div>



<a name="250211786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250211786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250211786">(Aug 21 2021 at 11:07)</a>:</h4>
<p>Mmh actually shifting like that wont work if there are less attribute tokens than item tokens</p>



<a name="250211792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250211792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250211792">(Aug 21 2021 at 11:07)</a>:</h4>
<p>since they will still overlap that way</p>



<a name="250211832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250211832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250211832">(Aug 21 2021 at 11:08)</a>:</h4>
<p>We also don't record the attribute input token ranges in the token map i just realized we probably want to do that as well somehow somewhere</p>



<a name="250212226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250212226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250212226">(Aug 21 2021 at 11:19)</a>:</h4>
<p>So, for attributes we strip the irrelevant attributes for expansion, since an attribute shouldn't see itself in its item input. That also causes us to not map the attribute's raw input in the TokenMap. I think if we were to just map the input in the token map properly that could just fix the IDs without any extra work for us if I'm not wrong?</p>



<a name="250217420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250217420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250217420">(Aug 21 2021 at 13:20)</a>:</h4>
<p><a href="/user_uploads/4715/kGMzsfkgHRRHd277mXug_aUr/BvEJtgWTct.gif">BvEJtgWTct.gif</a> <br>
Will be able to make a PR soon I think <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <br>
Then we'll see whether the approaches I've taken make sense or not</p>
<div class="message_inline_image"><a href="/user_uploads/4715/kGMzsfkgHRRHd277mXug_aUr/BvEJtgWTct.gif" title="BvEJtgWTct.gif"><img src="/user_uploads/4715/kGMzsfkgHRRHd277mXug_aUr/BvEJtgWTct.gif"></a></div>



<a name="250217876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Macro-token%20mapping/near/250217876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Macro-token.20mapping.html#250217876">(Aug 21 2021 at 13:31)</a>:</h4>
<p>Rough PR for now (that only implemented mapping down) as I have to do some other things now <a href="https://github.com/rust-analyzer/rust-analyzer/pull/9970">https://github.com/rust-analyzer/rust-analyzer/pull/9970</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>