<html>
<head><meta charset="utf-8"><title>Validate method call expr · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Validate.20method.20call.20expr.html">Validate method call expr</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274689780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Validate%20method%20call%20expr/near/274689780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Validate.20method.20call.20expr.html#274689780">(Mar 09 2022 at 13:50)</a>:</h4>
<p>I have trouble understanding what <code>validate_method_call_expr</code> in <code>convert_iter_for_each_to_for</code> does. From what I understood, the function makes sure that the considered method is for_each, and that the receiver implements the Iter trait. I especially have trouble with these lines :</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">name_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="n">name_ref</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">name_ref</span><span class="p">.</span><span class="n">syntax</span><span class="p">().</span><span class="n">text_range</span><span class="p">().</span><span class="n">contains_range</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">selection_trimmed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">cov_mark</span>::<span class="n">hit</span><span class="o">!</span><span class="p">(</span><span class="n">test_for_each_not_applicable_invalid_cursor_pos</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'm trying to understand this text because in my new assist code, I took this function as is to detect the context of a for_each, or method_call fails and makes my assist code not applicable on the following code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">iter</span>::<span class="n">repeat</span><span class="p">((</span><span class="mi">92</span><span class="p">,</span><span class="mi">42</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">it</span><span class="p">.</span><span class="n">for_each</span><span class="cp">$</span><span class="mi">0</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="k">mut</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Without that I could understand it. It seems that removing the following lines:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sema</span><span class="p">.</span><span class="n">type_of_expr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">receiver</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">adjusted</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sema</span><span class="p">.</span><span class="n">scope</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="n">syntax</span><span class="p">()).</span><span class="n">module</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">krate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">krate</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">iter_trait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FamousDefs</span><span class="p">(</span><span class="n">sema</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">krate</span><span class="p">)).</span><span class="n">core_iter_Iterator</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">it_type</span><span class="p">.</span><span class="n">impls_trait</span><span class="p">(</span><span class="n">sema</span><span class="p">.</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">iter_trait</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]).</span><span class="n">then</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">receiver</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>(ie skipping the check for the Iter implementation) removes the issue, but I can't figure out why. Strange, because these lines were not part of those I did not understand at first <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="274691517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Validate%20method%20call%20expr/near/274691517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Validate.20method.20call.20expr.html#274691517">(Mar 09 2022 at 14:03)</a>:</h4>
<p><span class="user-mention" data-user-id="474550">@AppCoder1234</span> search for <code>test_for_each_not_applicable_invalid_cursor_pos</code> -- this string will also occur in a test, and that test will show you why this conditiion is needed</p>



<a name="274693654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Validate%20method%20call%20expr/near/274693654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Validate.20method.20call.20expr.html#274693654">(Mar 09 2022 at 14:19)</a>:</h4>
<p>It seems that you cannot apply this assist code when you are in the body of a for_each (in the closure), only when the cursor is exactly on the for_each invocation. As there is only one test that mentions this, I'm not sure about what I'm deducing here, especially as I don't really see why the assist code should be prevented from being applied in this case (seems like an unnecessary precaution).</p>



<a name="274696583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Validate%20method%20call%20expr/near/274696583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Validate.20method.20call.20expr.html#274696583">(Mar 09 2022 at 14:40)</a>:</h4>
<p>That's intentional, yeah:</p>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/d70ea759b3e6945749ee75fed088dc0a34f1ed26/crates/ide_assists/src/lib.rs#L27-L31">https://github.com/rust-analyzer/rust-analyzer/blob/d70ea759b3e6945749ee75fed088dc0a34f1ed26/crates/ide_assists/src/lib.rs#L27-L31</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>