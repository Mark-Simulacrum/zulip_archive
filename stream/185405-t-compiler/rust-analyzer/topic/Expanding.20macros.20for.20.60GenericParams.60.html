<html>
<head><meta charset="utf-8"><title>Expanding macros for `GenericParams` · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html">Expanding macros for `GenericParams`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254036804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254036804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254036804">(Sep 20 2021 at 11:52)</a>:</h4>
<p>Trying to fix <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10286">rust-analyzer/rust-analyzer#10286</a> I stumbled upon a wall. AST -&gt; <code>ItemTree</code> lowering seems to assume that all generic parameters are known before macros are expanded (or at least I can't seem to find a way to expand macros at this stage). This is however false, macros can expand to <code>impl Trait</code> in argument position, which adds a new generic parameter. Fixing this however seems tricky to me. The only way I can think of is to change <code>GenericParams::generic_params_query</code> to either fixup or be the one that creates the <code>GenericParams</code> for <code>Function</code>, but both of them feel like a weird hack. Do you think this is the right way to go or do you have other/better ideas?</p>



<a name="254037865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254037865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254037865">(Sep 20 2021 at 12:00)</a>:</h4>
<p>this area probably needs a bigger refactoring. The most immediate way I see to solve this right now is probably to add a <code>TypeRef::walk_expanded</code> that expands macros. I think that should be possible</p>



<a name="254038261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254038261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254038261">(Sep 20 2021 at 12:04)</a>:</h4>
<p>I think long-term, maybe we need to remove impl trait handling from hir_def, do it purely in hir_ty, and move everything in hir_ty that accesses these the generics to instead work with Binders</p>



<a name="254038761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254038761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254038761">(Sep 20 2021 at 12:08)</a>:</h4>
<p>maybe we need to eagerly macroexpand all types in function signatures in hir_def though</p>



<a name="254038844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254038844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254038844">(Sep 20 2021 at 12:09)</a>:</h4>
<p>yeah, that seems reasonable</p>



<a name="254038952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254038952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254038952">(Sep 20 2021 at 12:10)</a>:</h4>
<p>that's actually maybe the simplest way, and would avoid doubling the work</p>



<a name="254040423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254040423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254040423">(Sep 20 2021 at 12:23)</a>:</h4>
<p>oh and <span class="user-mention" data-user-id="338379">@Giacomo Stevanato</span> by "it should be pretty straightforward to turn it into a test" I meant "to use that test for debugging", by the way</p>



<a name="254040874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254040874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254040874">(Sep 20 2021 at 12:27)</a>:</h4>
<p>I actually ended up writing the test (which also made the IDE crash) and running <code>cargo test</code> got me a backtrace. This wouldn't have been necessary if <code>RUST_BACKTRACE</code> worked from the start though.</p>



<a name="254040914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254040914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254040914">(Sep 20 2021 at 12:27)</a>:</h4>
<p>the test is still necessary anyway ;)</p>



<a name="254041012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254041012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254041012">(Sep 20 2021 at 12:28)</a>:</h4>
<p>not sure why RUST_BACKTRACE didn't work for you though</p>



<a name="254041265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254041265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254041265">(Sep 20 2021 at 12:30)</a>:</h4>
<p>The real pain wasn't writing the test, but fighting against VSCode wanting to open the "Output" tab everytime I moved the cursor</p>



<a name="254044464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254044464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254044464">(Sep 20 2021 at 12:55)</a>:</h4>
<p><code>RUST_BACKTRACE</code> doesn't work on windows for the downloaded binaries from github</p>



<a name="254177518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254177518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254177518">(Sep 21 2021 at 09:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="129457">Florian Diebold</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60/near/254038761">said</a>:</p>
<blockquote>
<p>maybe we need to eagerly macroexpand all types in function signatures in hir_def though</p>
</blockquote>
<p>Going back to this, I'm not quite sure how that would be implemented since macro expansion doesn't seem to be available when <code>ItemTree</code> is being created. Or do you mean to delay the creation of <code>GenericParams</code> until it is created? Looking at the uses of <code>Function::generic_params</code> it seems to be used only in <code>GenericParams::generic_params_query</code> (which seems to be able to do macro expansion) and in pretty printing for tests, so it wouldn't be that difficult to delay its creation.</p>



<a name="254180041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254180041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254180041">(Sep 21 2021 at 09:44)</a>:</h4>
<p>I mean during <code>fn_data_query</code></p>



<a name="254181315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Expanding%20macros%20for%20%60GenericParams%60/near/254181315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Expanding.20macros.20for.20.60GenericParams.60.html#254181315">(Sep 21 2021 at 09:55)</a>:</h4>
<p>Oh yeah, that makes sense</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>