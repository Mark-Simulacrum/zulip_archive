<html>
<head><meta charset="utf-8"><title>assist to replace aliases with concrete types · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html">assist to replace aliases with concrete types</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274004263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274004263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274004263">(Mar 03 2022 at 17:06)</a>:</h4>
<p>Hey, I've picked up <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10881">#10881</a>. This is my first time working with the RA code base, I think I'm heading in the right direction but just wanted to check that I'm not in over my head.</p>
<p>I've got the most basic case working where no generic types are involved in the alias or concrete type and where the alias isn't part of an expression:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="cp">$</span><span class="mi">0</span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="c1">// -&gt;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Now I'm about to add support for generics in the alias and concrete type, which seems to make up almost all of the effort of the feature. A more complex case is something like this where the lifetimes are omitted in the alias and it has the lifetimes in a different order:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">A</span><span class="o">&lt;'</span><span class="na">r</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">l</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">l</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;&amp;'</span><span class="na">r</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="cp">$</span><span class="mi">0</span><span class="n">A</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
<span class="c1">// -&gt;</span>
<span class="k">type</span> <span class="nc">A</span><span class="o">&lt;'</span><span class="na">r</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">l</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">l</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;&amp;'</span><span class="na">r</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>My plan is to initially create the replacement by:</p>
<ol>
<li>Creating a copy of the alias TypeAlias: <code>A&lt;'r, 'l, T&gt;</code></li>
<li>Substituting specified types into it from the let expression: <code>A&lt;'_, '_. _&gt;</code></li>
<li>Creating a copy of the concrete type: <code>&amp;'l std::collections::HashMap&lt;&amp;'r str, T&gt;</code></li>
<li>Substituting in the types in step 2: <code>&amp;'_ std::collections::HashMap&lt;&amp;'_ str, _&gt;</code></li>
<li>I think I can elide lifetimes based on whether they were specified for A, but I'll skip that for now</li>
</ol>
<p>I guess the step 2 copy won't be necessary once I understand things more. I'll have to learn the right level of abstration to do this at, for example the <code>GenericArgs</code> for the concrete type are <code>&amp;'r str</code> and <code>T</code> so I'd need to figure out how to split up <code>&amp;'r</code> and <code>str</code> for the reaplacements.</p>
<p>Does this sound reasonable, am I missing anything that would make this easier?</p>



<a name="274005781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274005781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274005781">(Mar 03 2022 at 17:16)</a>:</h4>
<p>I don't quite follow your thinking in regards to step 1 and 2. My mental model on how this would be done all is basically:</p>
<ol>
<li>Create a mapping between the generics by associating the inline site generics with the type alias declaration generics.</li>
<li>With the mapping created you can now copy the right hand side of the type alias and start substituting the things in it with your mapping.</li>
<li>Drop all '_ lifetimes as they aren't needed(this can also be done in the substitution step already).</li>
</ol>
<p>So I assume your main struggle is with figuring out how to actually do the substitution from what I see here. My immediate thought on a high level here would be to <code>clone_for_update</code> the right hand side node of the type alias, then iterate the descendants of that node, check whether there are hits for those in your mapping and record the substitutions in a vec(we don't wanna substitute while iterating as that can invalidate iteration). Then apply the substitutions and you have a substituted type node you can use for the actual replacement.</p>



<a name="274005940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274005940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274005940">(Mar 03 2022 at 17:17)</a>:</h4>
<p><del>Taking <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_assists/src/handlers/inline_call.rs"><code>inline_call</code></a> as a rough guideline should be helpful here as well, though that assist has a lot more complex handling than is required here.</del></p>



<a name="274006143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274006143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274006143">(Mar 03 2022 at 17:18)</a>:</h4>
<p>Ye actually that assist isnt helpful as a guideline here at all</p>



<a name="274006868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274006868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274006868">(Mar 03 2022 at 17:23)</a>:</h4>
<p>I haven't started trying to implement the substitution yet, but I could see it was going to be an easy thing to get wrong or duplicate effort. I'll see how I get on with your advice, thanks :).</p>



<a name="274007004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274007004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274007004">(Mar 03 2022 at 17:24)</a>:</h4>
<p>Ye for now figure out how to create a mapping I suppose :) Feel free to ask questions as they come up, I'll try to reply when I can (it's also fine to ping me for that).</p>



<a name="274183107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274183107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274183107">(Mar 04 2022 at 20:15)</a>:</h4>
<p>I got stuck on a silly mistake, both <code>let a: $0A&lt;u32&gt; = f();</code> and <code>fn main() { let a: $0A&lt;u32&gt; = f();</code> return a <code>PathType</code> via <code>ctx.find_node_at_offset::&lt;ast::PathType&gt;()?</code>, but only the one within a function has generics available.</p>
<p><code>collect_used_generics</code> in <code>extract_type_alias.rs</code> seems very useful. It looks like I need to duplicate most of it as I'll be substituting in to <code>GenericArgs</code> rather than <code>GenericParams</code>, and as part of that I'll be walking a <code>PathType</code> rather than a <code>Type</code> so I guess I need to implement <code>walk_path_type</code>. Does that sound right?</p>



<a name="274184263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274184263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274184263">(Mar 04 2022 at 20:26)</a>:</h4>
<p>You can wrap the <code>ast::PathType</code> in <code>ast::Type::PathType</code> and then walk that directly</p>



<a name="274184364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274184364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274184364">(Mar 04 2022 at 20:27)</a>:</h4>
<blockquote>
<p>I got stuck on a silly mistake, both let a: $0A&lt;u32&gt; = f(); and fn main() { let a: $0A&lt;u32&gt; = f(); return a PathType via ctx.find_node_at_offset::&lt;ast::PathType&gt;()?, but only the one within a function has generics available.</p>
</blockquote>
<p>What do you mean only the one within a function? You need to write your test fixtures as valid rust, if you mean that the first one is a standalone let in a source file then that won't work.</p>



<a name="274184413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274184413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274184413">(Mar 04 2022 at 20:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types/near/274184263">말함</a>:</p>
<blockquote>
<p>You can wrap the <code>ast::PathType</code> in <code>ast::Type::PathType</code> and then walk that directly</p>
</blockquote>
<p>Though I don't think you need to walk the type since you only need to collect the generics in the generic param list</p>



<a name="274260631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274260631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274260631">(Mar 05 2022 at 19:27)</a>:</h4>
<p>I am in the middle of refactoring a crate and in doing so, managed to get rust-analyzer into a state of hysteria. I've tried both Preview &amp; Non Preview variants of the VSCode plugin and both are causing the issue.</p>
<p>In VS Code, files can not be saved <br>
<a href="/user_uploads/4715/-WduMo9o5fGV_1LWzDZ-rxuo/Screen-Shot-2022-03-05-at-2.23.17-PM.png">Screen-Shot-2022-03-05-at-2.23.17-PM.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/-WduMo9o5fGV_1LWzDZ-rxuo/Screen-Shot-2022-03-05-at-2.23.17-PM.png" title="Screen-Shot-2022-03-05-at-2.23.17-PM.png"><img src="/user_uploads/4715/-WduMo9o5fGV_1LWzDZ-rxuo/Screen-Shot-2022-03-05-at-2.23.17-PM.png"></a></div><p>while the rust-analyzer process is maxing out cpu:<br>
<a href="/user_uploads/4715/_Ko6IVYUWn7tfsLwlWO62drJ/Screen-Shot-2022-03-05-at-2.24.30-PM.png">Screen-Shot-2022-03-05-at-2.24.30-PM.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/_Ko6IVYUWn7tfsLwlWO62drJ/Screen-Shot-2022-03-05-at-2.24.30-PM.png" title="Screen-Shot-2022-03-05-at-2.24.30-PM.png"><img src="/user_uploads/4715/_Ko6IVYUWn7tfsLwlWO62drJ/Screen-Shot-2022-03-05-at-2.24.30-PM.png"></a></div><p>the source causing the issue is here: <a href="https://github.com/chanced/catalyze/tree/rust-analyzer-issue">https://github.com/chanced/catalyze/tree/rust-analyzer-issue</a></p>



<a name="274260696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274260696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274260696">(Mar 05 2022 at 19:29)</a>:</h4>
<p>Your types are too complex for RA's little mind</p>



<a name="274260889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274260889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274260889">(Mar 05 2022 at 19:32)</a>:</h4>
<p>I'm assuming its because I am switching it from structs to traits and partially through with that conversion. I don't know which change caused it.</p>



<a name="274260984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274260984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274260984">(Mar 05 2022 at 19:35)</a>:</h4>
<p>Actually I can't reproduce it. What happens sometimes is that trait-heavy code makes <code>chalk</code> loop indefinitely.  But it doesn't seem to be the case here.</p>



<a name="274261054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261054">(Mar 05 2022 at 19:36)</a>:</h4>
<p>ah, okay. <a href="https://github.com/chanced/catalyze/blob/rust-analyzer-issue/src/proto/uninterpreted_option.rs">https://github.com/chanced/catalyze/blob/rust-analyzer-issue/src/proto/uninterpreted_option.rs</a> was the file I had been working on if that matters.</p>
<p>I'll finish up the conversion sans RA and see if it'll play ball without the error-filled code.</p>



<a name="274261065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261065">(Mar 05 2022 at 19:37)</a>:</h4>
<p>See <a href="https://github.com/rust-analyzer/rust-analyzer/issues/7796">https://github.com/rust-analyzer/rust-analyzer/issues/7796</a> for an example. The workaround there was to put an explicit type on the variable.</p>



<a name="274261070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261070">(Mar 05 2022 at 19:37)</a>:</h4>
<p>thank you for looking into it for me. I just dropped it here incase anyone wanted to analyze. I wasn't looking for a solution but appreciate the effort!</p>



<a name="274261136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261136">(Mar 05 2022 at 19:38)</a>:</h4>
<p>Yeah, unfortunately it doesn't reproduce (easily?), maybe you changed the code a little before noticing it.</p>



<a name="274261150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261150">(Mar 05 2022 at 19:38)</a>:</h4>
<p>Next time you can try running <code>rust-analyzer -v analysis-stats .</code> and see if it hangs on some function.</p>



<a name="274261188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261188">(Mar 05 2022 at 19:39)</a>:</h4>
<p>okay, will do. I wonder if the change which is causing it is caught up in vscode cache or something as I wasn't able to save.</p>
<p>thank you again for your time!</p>



<a name="274261239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261239">(Mar 05 2022 at 19:40)</a>:</h4>
<p>That happens when rust-analyzer is stuck and it can't do the format-on-save thingy. At that point you still have the old version on disk.</p>



<a name="274261394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261394">(Mar 05 2022 at 19:44)</a>:</h4>
<p>you should be able to just <code>killall rust-analyzer</code> in that case. if the current state of the code doesn't cause the problem, it should work again then; if it does cause the problem, you have a reproduction</p>



<a name="274261410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274261410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274261410">(Mar 05 2022 at 19:45)</a>:</h4>
<p>And use the "Save file without formatting" command to actually save it.</p>



<a name="274262644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274262644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274262644">(Mar 05 2022 at 20:12)</a>:</h4>
<p>what's the best way to install rust-analyzer so that I can run <code>rust-analyzer -v analysis-stats .</code>? I tried <code>rustup +nightly component add rust-analyzer-preview</code></p>



<a name="274262982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274262982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274262982">(Mar 05 2022 at 20:20)</a>:</h4>
<p>You can find it in <code>~/.vscode/extensions/matklad.rust-analyzer-0.4.0-dev/server/rust-analyzer</code> (but with a different version number, 0.2.something)</p>



<a name="274263066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274263066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274263066">(Mar 05 2022 at 20:22)</a>:</h4>
<p>that's able to run fine</p>
<div class="codehilite"><pre><span></span><code>❯ ~/.vscode/extensions/matklad.rust-analyzer-0.3.961/server/rust-analyzer  -v analysis-stats .
Database loaded:     1.15s (metadata 884.16ms; build 213.44ms)
  crates: 4, mods: 45, decls: 1138, fns: 876
Item Collection:     2.69s
/Users/chance/dev/catalyze/src/file.rs 73:39-73:41: Expected dyn MessageDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn MessageDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/file.rs 83:34-83:36: Expected dyn EnumDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn EnumDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/file.rs 90:39-90:41: Expected dyn ServiceDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn ServiceDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/file.rs 107:29-109:70: Expected (), got Option&lt;()&gt;
/Users/chance/dev/catalyze/src/proto/uninterpreted_option.rs 52:28-52:30: Expected &amp;str, got ()
/Users/chance/dev/catalyze/src/proto/uninterpreted_option.rs 66:8-66:20: Expected Result&lt;(), Error&gt;, got &amp;T
/Users/chance/dev/catalyze/src/proto/uninterpreted_option.rs 65:73-67:5: Expected Result&lt;(), Error&gt;, got &amp;T
/Users/chance/dev/catalyze/src/enum.rs 58:43-58:44: Expected dyn EnumValueDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn EnumValueDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/message.rs 96:39-96:41: Expected dyn MessageDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn MessageDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/message.rs 103:34-103:36: Expected dyn EnumDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn EnumDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/message.rs 110:35-110:37: Expected dyn OneofDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn OneofDescriptor&gt; as IntoIterator&gt;::Item
/Users/chance/dev/catalyze/src/message.rs 117:41-117:43: Expected dyn FieldDescriptor, got &lt;dyn ExactSizeIterator&lt;Item = dyn FieldDescriptor&gt; as IntoIterator&gt;::Item
  exprs: 7225, ??ty: 149 (2%), ?ty: 71 (0%), !ty: 12
Inference:           1.92s
Total:               4.61s
</code></pre></div>



<a name="274263077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274263077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chance <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274263077">(Mar 05 2022 at 20:22)</a>:</h4>
<p>yea, going back to the plan of fixing the problems and then trying again with rust-analyzer.</p>



<a name="274617993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274617993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274617993">(Mar 08 2022 at 22:37)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="300586">@Lukas Wirth</span>  I'm trying to allow the alias instance to omit whatever is inferred or has defaults available in the declaraion.</p>
<p>I have a problem though, <code>ConstParam::default_val</code> is returning <code>None</code> for this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">A</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">u32</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<p>The <code>ConstParam</code> debug output shows its syntax is for 7..25 (<code>A&lt;const N: usize = 1&gt;</code>).</p>
<p>Is there something obvious it could be? <a href="https://github.com/steven-joruk/rust-analyzer/commit/ff88687a17d8a4b8321eee0bfeaf950a4f0032ba">This is my branch</a> if it helps</p>



<a name="274618146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618146">(Mar 08 2022 at 22:39)</a>:</h4>
<p>Looking at the syntax tree that looks like a bug in the parser</p>



<a name="274618161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618161">(Mar 08 2022 at 22:39)</a>:</h4>
<p>the expression is wrapped in a <code>ConstArg</code> while it should merely be an expression</p>



<a name="274618200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618200">(Mar 08 2022 at 22:39)</a>:</h4>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>TYPE_ALIAS@596..634
  TYPE_KW@596..600 "type"
  WHITESPACE@600..601 " "
  NAME@601..602
    IDENT@601..602 "A"
  GENERIC_PARAM_LIST@602..622
    L_ANGLE@602..603 "&lt;"
    CONST_PARAM@603..621
      CONST_KW@603..608 "const"
      WHITESPACE@608..609 " "
      NAME@609..610
        IDENT@609..610 "N"
      COLON@610..611 ":"
      WHITESPACE@611..612 " "
      PATH_TYPE@612..617
        PATH@612..617
          PATH_SEGMENT@612..617
            NAME_REF@612..617
              IDENT@612..617 "usize"
      WHITESPACE@617..618 " "
      EQ@618..619 "="
      WHITESPACE@619..620 " "
      CONST_ARG@620..621
        LITERAL@620..621
          INT_NUMBER@620..621 "1"
    R_ANGLE@621..622 "&gt;"
  WHITESPACE@622..623 " "
  EQ@623..624 "="
  WHITESPACE@624..625 " "
  ARRAY_TYPE@625..633
    L_BRACK@625..626 "["
    PATH_TYPE@626..629
      PATH@626..629
        PATH_SEGMENT@626..629
          NAME_REF@626..629
            IDENT@626..629 "u32"
    SEMICOLON@629..630 ";"
    WHITESPACE@630..631 " "
    PATH_EXPR@631..632
      PATH@631..632
        PATH_SEGMENT@631..632
          NAME_REF@631..632
            IDENT@631..632 "N"
    R_BRACK@632..633 "]"
  SEMICOLON@633..634 ";"
</code></pre></div>
<p>is the syntax tree for your snippet</p>



<a name="274618263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618263">(Mar 08 2022 at 22:40)</a>:</h4>
<p>Note the</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>      CONST_ARG@620..621
        LITERAL@620..621
          INT_NUMBER@620..621 "1"
</code></pre></div>



<a name="274618305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618305">(Mar 08 2022 at 22:41)</a>:</h4>
<p>Oh :). There's another assist that uses default_val in <a href="http://extract_function.rs">extract_function.rs</a>, I guess it doesn't have at test that exercises it. The syntax tree output is so useful, I just presumed it would have been right in this case though.</p>



<a name="274618329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618329">(Mar 08 2022 at 22:41)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/parser/src/grammar/generic_params.rs#L85">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/parser/src/grammar/generic_params.rs#L85</a></p>



<a name="274618335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618335">(Mar 08 2022 at 22:41)</a>:</h4>
<p>this here is wrong I am pretty sure</p>



<a name="274618421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618421">(Mar 08 2022 at 22:42)</a>:</h4>
<p>Not sure if there are any specific restrictions but that should be just an expression being parsed there</p>



<a name="274618423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618423">(Mar 08 2022 at 22:42)</a>:</h4>
<p>not a constarg</p>



<a name="274618450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618450">(Mar 08 2022 at 22:42)</a>:</h4>
<p>I can try to fix it tomorrow if you like. Yeah it should be an expression</p>



<a name="274618556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274618556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274618556">(Mar 08 2022 at 22:43)</a>:</h4>
<p>Feel free to :)</p>



<a name="274912265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274912265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Joruk <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274912265">(Mar 10 2022 at 23:45)</a>:</h4>
<p>The first assist is <a href="https://github.com/steven-joruk/rust-analyzer/commit/9fb608acaf801e703723222ed147e03d81d25ff4">close to done</a>. I'm trying to figure out what to edit to fix the generated <a href="http://nodes.rs">nodes.rs</a> though, I've just manually edited it for now.</p>



<a name="274913145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274913145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274913145">(Mar 10 2022 at 23:56)</a>:</h4>
<p>That file is generated from our <a href="https://github.com/rust-analyzer/ungrammar/blob/master/rust.ungram">ungrammar definition</a></p>



<a name="274913171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/assist%20to%20replace%20aliases%20with%20concrete%20types/near/274913171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/assist.20to.20replace.20aliases.20with.20concrete.20types.html#274913171">(Mar 10 2022 at 23:56)</a>:</h4>
<p>You don't to be editing that file though since you shouldn't be touching the grammar, <del>instead create that impl in the <code>node_ext.rs</code> file thats in the syntax crate somewhere</del> Nvm you are already doing that</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>